#include <vcl.h>
// ---------------------------------------------------------------------------
#include "pch.h"

#pragma hdrstop

#include "ClassIteradorCostos.h"
#include "ClassServidorReportes.h"
#include "ClassServidorVioleta.h"
#include "ClassBufferRespuestas.h"
#include "violetaS.h"
#include "FormServidorVioleta.h"
#include <DateUtils.hpp>
#include "ClassArregloDetalle.h"
#include "comunes.h"
#include <EncdDecd.hpp>

#include "IdComponent.hpp"
#include "IdIntercept.hpp"
#include "IdLogFile.hpp"
#include "IdMessage.hpp"
#include "IdSMTP.hpp"
#include <IdText.hpp>
#include <IdAttachmentMemory.hpp>
#include <IdSSLOpenSSL.hpp>
#include <System.Generics.Collections.hpp>
// ---------------------------------------------------------------------------

#pragma package(smart_init)

// ---------------------------------------------------------------------------
// ID_EJE_REPVENTAS_X_FACTURA

void ServidorReportes::EjecutaRepVentasXFactura(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, tipofactura, ticket;
	AnsiString usuario, terminospago, especiales, terminal, canceladas,
		tipo_canceladas;
	AnsiString condicion_acredito = " ", condicion_tipofactura = " ";
	AnsiString condicion_ticket = " ", condicion_usuario = " ";
	AnsiString condicion_terminospago = " ", condicion_terminal = " ",
		condicion_canceladas = " ";
	AnsiString fechas_canceladas = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", campos_base;
	AnsiString cliente, condicion_cliente = " ";
	AnsiString vendedor, condicion_vendedor = " ";
	AnsiString sector, condicion_sector = " ";
	AnsiString localidad, condicion_localidad = " ";
	AnsiString tipo_nombre, condicion_tipo_nombre = " ", venta,
		condicion_venta = " ";
	AnsiString reporte_grafico;
	AnsiString empresa, sucursal, condicion_empresa = " " ,condicion_sucursal = " ", contabilizadas,
		condicion_contabilizadas = " ";
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString tipo_impuestos, impuesto_particular, condicion_tipo_imp = " ",
		condicion_imp = " ";
	AnsiString condicion_hora = " ", hora_inicial = " ", hora_final = " ";
	AnsiString condicion_clientes_partesrel = " ", clientes_partesrel = " ";
	AnsiString canal, gironegocio;
	AnsiString condicion_gironegocio = " ", condicion_canal = " ";
	AnsiString join_clientes = " ";

	AnsiString ordenEcommerce;
	AnsiString inner_ordenEcommerce = " ";

	AnsiString origenVentas;
	AnsiString condicion_origenVentas = " ";
	AnsiString formasDePago, fpago_porcentaje = " ", fpago_porcentaje2 = " ";
	AnsiString inner_join_formasDePago = " ", condicion_formasDePago = " ";

	AnsiString solokits, join_solokits = " ";
	AnsiString corte_alta, corte_cancel, condicion_corte = " ";
	AnsiString archivo_temp1 = "";
	AnsiString archivos_temporales[4];

	AnsiString medio_facturacion, join_cfdiweb = " ", condicion_cfdiweb = " ";
	AnsiString ref_venta, condicion_ref_venta = " ";

	AnsiString incluir_xml, campos_xml = " ", left_join_cfdxml = " ";

	condicion_hora = mFg.ExtraeStringDeBuffer(&parametros);
	hora_inicial = mFg.ExtraeStringDeBuffer(&parametros);
	hora_final = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	acredito = mFg.ExtraeStringDeBuffer(&parametros);
	tipofactura = mFg.ExtraeStringDeBuffer(&parametros);
	ticket = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	terminospago = mFg.ExtraeStringDeBuffer(&parametros);
	especiales = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	canceladas = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
	incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_limite_devoluciones =	mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	sector = mFg.ExtraeStringDeBuffer(&parametros);
	localidad = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
	reporte_grafico = mFg.ExtraeStringDeBuffer(&parametros);
	venta = mFg.ExtraeStringDeBuffer(&parametros);
	contabilizadas = mFg.ExtraeStringDeBuffer(&parametros);
	clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
	clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
	clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
	impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
	clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
	gironegocio = mFg.ExtraeStringDeBuffer(&parametros);
	canal = mFg.ExtraeStringDeBuffer(&parametros);
	ordenEcommerce = mFg.ExtraeStringDeBuffer(&parametros);
	origenVentas = mFg.ExtraeStringDeBuffer(&parametros);
	formasDePago = mFg.ExtraeStringDeBuffer(&parametros);
	solokits = mFg.ExtraeStringDeBuffer(&parametros);
	corte_alta = mFg.ExtraeStringDeBuffer(&parametros);
	corte_cancel = mFg.ExtraeStringDeBuffer(&parametros);
	medio_facturacion = mFg.ExtraeStringDeBuffer(&parametros);
	ref_venta = mFg.ExtraeStringDeBuffer(&parametros);
	incluir_xml = mFg.ExtraeStringDeBuffer(&parametros);

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";

	try {
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if (empresa != " ") {
			condicion_empresa.sprintf(" suc.idempresa = %s and ", empresa);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" suc.sucursal='%s' and ", sucursal);
		}
		if (venta != " ") {
			condicion_venta.sprintf("v.referencia='%s' and ", venta);
		}
		// define la forma como se mostraran los nombres de los clientes
		if (tipo_nombre == "1") {
			condicion_tipo_nombre =
				"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
		}
		else {
			condicion_tipo_nombre = "cli.rsocial";
		}
		if (sector != " ") {
			condicion_sector.sprintf("col.sector='%s' and ", sector);
		}
		if (localidad != " ") {
			condicion_localidad.sprintf("col.localidad='%s' and ", localidad);
		}
		if (vendedor != " ") {
			condicion_vendedor.sprintf("v.vendedor='%s' and ", vendedor);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("v.acredito=%s and ", acredito);
		}
		if (ticket != " ") {
			condicion_ticket.sprintf("v.ticket=%s and ", ticket);
		}
		if (usuario != " ") {
			condicion_usuario.sprintf("v.usualta='%s' and ", usuario);
		}
		if (terminospago != " ") {
			condicion_terminospago.sprintf
				(" AND df.formapag IN(SELECT formapag FROM formasdepago where termino = '%s') ",
				terminospago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
			fpago_porcentaje = "*df.porcentaje";
		}
		if (especiales == " ") {
			if (tipofactura != " ") {
				condicion_tipofactura.sprintf("v.tipofac='%s' and ",
				tipofactura);
			}
		}
		if (especiales == "1") {
			condicion_tipofactura.sprintf("v.tipofac='ESPECIAL' and ");
		}
		if (especiales == "0") {
			if (tipofactura == " ")
				condicion_tipofactura.sprintf("v.tipofac<>'ESPECIAL' and ");
			else
				condicion_tipofactura.sprintf("v.tipofac='%s' and ",
				tipofactura);
		}

		if (terminal != " ") {
			condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("v.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (contabilizadas == "1") {
					condicion_contabilizadas = " c.cancvtacontab=1 and ";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						" (c.cancvtacontab=0 or c.cancvtacontab IS NULL) and ";
				}
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("v.fechamodi>='%s' and v.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("v.fechavta>='%s' and v.fechavta<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				if (contabilizadas == "1") {
					condicion_contabilizadas = " c.vtacontab=1 and ";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						" (c.vtacontab=0 OR c.vtacontab IS NULL) and ";
				}
				fechas_canceladas.sprintf
					("v.fechavta>='%s' and v.fechavta<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			if (contabilizadas == "1") {
				condicion_contabilizadas = " c.vtacontab=1 and ";
			}
			if (contabilizadas == "0") {
				condicion_contabilizadas =
					" (c.vtacontab=0 OR c.vtacontab IS NULL) and ";
			}
			fechas_canceladas.sprintf
				("v.fechavta>='%s' and v.fechavta<='%s' and ", fecha_inicial,
				fecha_final);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		else {
			if (clasif2 != " ") {
				condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			}
			else {
				if (clasif1 != " ") {
					condicion_clasif1.sprintf("prod.clasif1='%s' and ",
					clasif1);
				}
			}
		}

		if (tipo_impuestos != " ") {
			condicion_tipo_imp.sprintf
				("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
		}
		if (impuesto_particular != " ") {
			condicion_imp.sprintf
				("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
		}
		if (condicion_hora == "1") {
			condicion_hora.sprintf(" v.horavta>='%s' AND v.horavta<='%s'  AND ",
				hora_inicial, hora_final);
		}
		else {
			condicion_hora = " ";
		}

		if (clientes_partesrel != " ") {
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s AND ",
				clientes_partesrel);
		}

		// condicion giro negocio
		if (gironegocio != " ") {
			condicion_gironegocio.sprintf("cli.giro='%s' and ", gironegocio);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		// condicion canales
		if (canal != " ") {
			condicion_canal.sprintf("cli.canal='%s' and ", canal);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		if (ordenEcommerce == "1") {
			inner_ordenEcommerce.sprintf
				(" INNER JOIN ecommerceorden eo ON eo.referencia = v.referencia "
				);
		}

		if (origenVentas != " ") {
			condicion_origenVentas.sprintf(" v.tipoorigen IN (%s) AND ",
				origenVentas);
		}

		if (formasDePago != " ") {
			condicion_formasDePago.sprintf(" df.formapag IN(%s) AND ",
				formasDePago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
			fpago_porcentaje = "*df.porcentaje";
			fpago_porcentaje2 = fpago_porcentaje;
		}

		// Mostrar solo ventas de kits
		if (solokits == "1") {
			join_solokits =
				" RIGHT JOIN dventaskits dvk ON dvk.venta=dv.referencia AND dvk.articulo=dv.articulo ";
		}

		if (medio_facturacion != " ") {
			if (medio_facturacion == "0") {
				join_cfdiweb =
					" LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia ";
				condicion_cfdiweb = "  w.factgenerada IS NULL AND ";
			}
			else if (medio_facturacion == "1") {
				join_cfdiweb =
					" INNER JOIN cfdiweb w ON w.factgenerada=v.referencia ";
			}
		}

		if (corte_alta != " " || corte_cancel != " ") {
			if (corte_alta != " " && corte_cancel != " ") {
				condicion_corte.sprintf
					(" (v.cortecancel='%s' OR v.corte='%s') AND ", corte_cancel,
					corte_alta);
			}
			else if (corte_alta != " ") {
				condicion_corte.sprintf(" v.corte='%s' AND ", corte_alta);
			}
			else if (corte_cancel != " ") {
				condicion_corte.sprintf(" v.cortecancel='%s' AND ",
				corte_cancel);
			}
		}

		if (ref_venta != " ") {
			condicion_ref_venta.sprintf("v.referencia = '%s' and", ref_venta);
		}

		if(incluir_xml == "1"){
			campos_xml = " cfdxml.xmlgenerado as xml64, c.serie, c.folio, cfdxml.cadenaoriginal, c.version, ";
			left_join_cfdxml = " left join cfdxml on cfdxml.compfiscal=c.compfiscal ";

		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			archivos_temporales[i - 1] =
				mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			instruccion.sprintf(" select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s' "
				, archivos_temporales[i - 1]);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auximpuestos%d (orden, impuesto, tipoimpu, porcentaje, nombre) ",
				archivos_temporales[i - 1], i);
			instrucciones[num_instrucciones++] = instruccion;

		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones == "1") {
			instruccion.sprintf("create temporary table dnotascredcliaux ( \
			venta char(11), \
			articulo varchar(9), \
			cantidad decimal(12,3), \
			precio decimal(16,6), \
			precioimp decimal(16,6), \
			nomUsuario varchar(255), \
			primary key  (venta, articulo) \
			) ENGINE=InnoDB ");
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion.sprintf(" select v.referencia as venta, d.articulo, sum(if(n.tipo='0',d.cantidad,0) %s) as cantidad, \
				sum(if(n.tipo<>'0',d.precio,0) %s) as precio, \
				sum(if(n.tipo<>'0',d.precioimp,0) %s) as precioimp, \
				COALESCE(CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat), 'Sin registro') AS nomUsuario    \
				from notascredcli n inner join  dnotascredcli d inner join  ventas v inner join  articulos \
					inner join productos prod inner join  clientes cli inner join  colonias col \
					inner join terminales ter on ter.terminal=v.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal = sec.sucursal \
					INNER JOIN usuarios usr ON usr.empleado=v.usualta \
					INNER JOIN empleados emp ON emp.empleado=usr.empleado \
					%s \
                    %s \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
                %s \
				n.venta=v.referencia and n.cancelado=0 and v.cancelado=0 and \
				v.cliente=cli.cliente and cli.colonia=col.colonia and \
				n.referencia=d.referencia and n.fechanot<='%s' and \
				d.articulo=articulos.articulo and articulos.producto=prod.producto \
				group by v.referencia, d.articulo INTO OUTFILE '%s' ",
                fpago_porcentaje2,fpago_porcentaje2,fpago_porcentaje2,
				inner_join_formasDePago, join_cfdiweb,
				condicion_acredito, condicion_empresa, condicion_sucursal,
				condicion_tipofactura,
				condicion_ticket, condicion_usuario, condicion_clasif1,
				condicion_clasif2, condicion_clasif3,
				// condicion_terminospago,
				condicion_terminal, condicion_cliente, condicion_vendedor,
				condicion_imp, condicion_tipo_imp, condicion_venta,
				condicion_sector, condicion_localidad, condicion_hora,
				condicion_clientes_partesrel, condicion_gironegocio,
				condicion_canal, condicion_origenVentas, condicion_formasDePago,
				condicion_cfdiweb, fecha_limite_devoluciones, archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE dnotascredcliaux (venta, articulo, cantidad, precio, precioimp, nomUsuario) ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredcliaux dn on \
				dn.articulo=dv.articulo and dn.venta=v.referencia ");

			campos_base.sprintf("sum(@unidades:=(dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor %s) as unidades, \
				sum(@suma:=((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))%s) as suma, \
				sum(@descuento:=(((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(dv.porcdesc/100))%s) as descuento, \
				sum(@subtotal:=(((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(1-dv.porcdesc/100))%s) as subtotal, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
				sum(if(i1.tipoimpu='IVA', (((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(i1.porcentaje/100)%s), 0) + \
					if(i2.tipoimpu='IVA', (((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(1+i1.porcentaje/100)*(i2.porcentaje/100)%s), 0))\
					 as totaliva, \
				sum(if( i1.tipoimpu='IESPS', (((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(i1.porcentaje/100)%s), \
					 0)) as totaliesps, ", fpago_porcentaje2, fpago_porcentaje,
				fpago_porcentaje, fpago_porcentaje, fpago_porcentaje,
				fpago_porcentaje, fpago_porcentaje);
		}
		else {
			campos_base.sprintf("sum(@unidades:=dv.cantidad*articulos.factor %s) as unidades, \
				sum(@suma:=(dv.precio*dv.cantidad)%s) as suma, \
				sum(@descuento:=((dv.precio*dv.cantidad)*(dv.porcdesc/100)%s)) as descuento, \
				sum(@subtotal:=((dv.precio*dv.cantidad)*(1-dv.porcdesc/100)%s)) as subtotal, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
				sum(if(i1.tipoimpu='IVA', ((dv.precio*dv.cantidad)*(i1.porcentaje/100)%s), 0) + \
					if(i2.tipoimpu='IVA', ((dv.precio*dv.cantidad)*(1+i1.porcentaje/100)*(i2.porcentaje/100)%s), 0))\
					 as totaliva, \
				sum(if( i1.tipoimpu='IESPS', ((dv.precio*dv.cantidad)*(i1.porcentaje/100)%s), \
					 0)) as totaliesps, ", fpago_porcentaje2, fpago_porcentaje,
				fpago_porcentaje, fpago_porcentaje, fpago_porcentaje,
				fpago_porcentaje, fpago_porcentaje);
		}

		if (reporte_grafico == "0") {
			consulta.sprintf("select v.referencia, v.folioticket, v.foliofisic as factura, c.seriefolio AS foliocfd, c.muuid, v.fechavta as fecha, \
				v.horavta as hora, cli.cliente, %s as nomcliente, cli.rfc, c.seriefolio, c.fechaalta, \
				v.cancelado, v.ticket, v.acredito, \
				COALESCE(CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat), 'Sin registro') AS nomUsuario, \
				%s %s \
				%s \
				from ventas v  inner join  dventas dv  inner join  articulos  inner join  clientes cli  inner join  colonias col \
				inner join productos prod on articulos.producto=prod.producto \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal=sec.sucursal \
				INNER JOIN usuarios usr ON usr.empleado=v.usualta \
				INNER JOIN empleados emp ON emp.empleado=usr.empleado \
				%s \
				%s \
				left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 \
				LEFT JOIN cfd c ON v.referencia=c.referencia AND c.tipocomprobante='VENT' \
                %s \
				%s \
				%s \
				%s \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s  %s  %s %s %s %s %s %s %s %s \
				%s %s\
				v.referencia=dv.referencia and \
				cli.colonia=col.colonia and \
				dv.articulo=articulos.articulo and v.cliente=cli.cliente \
				group by v.referencia \
				order by suc.numid, v.referenciA", condicion_tipo_nombre,
				campos_base, campos_xml, campos_val_impuestos, inner_ordenEcommerce,
				inner_join_formasDePago, left_join_cfdxml, join_devoluciones, join_solokits,
				join_cfdiweb, condicion_empresa,
				condicion_sucursal, condicion_acredito, condicion_tipofactura,
				condicion_ticket, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_usuario,
				// condicion_terminospago,
				condicion_terminal, condicion_cliente, condicion_venta,
				condicion_imp, condicion_tipo_imp, condicion_canceladas,
				condicion_contabilizadas, fechas_canceladas, condicion_vendedor,
				condicion_sector, condicion_hora, condicion_localidad,
				condicion_clientes_partesrel, condicion_gironegocio,
				condicion_canal, condicion_origenVentas, condicion_formasDePago,
				condicion_corte, condicion_cfdiweb, condicion_ref_venta);
		}
		else {
			instrucciones[num_instrucciones++] = "SET @hace_2_anios = DATE_SUB(DATE_FORMAT(CURDATE(), '%Y-01-01'), INTERVAL 2 YEAR)";

			consulta.sprintf("SELECT \
				YEAR(v.fechavta) AS anio, \
				MONTH(v.fechavta) AS mes, \
				SUM(pv.subtotal) AS totmes, \
				COALESCE(CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat), 'Sin registro') AS nomUsuario \
				FROM ventas v FORCE INDEX(vendedor) \
				INNER JOIN precalculoventas pv ON v.referencia=pv.referencia \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
				INNER JOIN usuarios usr ON usr.empleado=v.usualta \
				INNER JOIN empleados emp ON emp.empleado=usr.empleado \
				WHERE %s v.fechavta >= @hace_2_anios AND %s %s %s v.cancelado=0 \
				GROUP BY anio, mes", condicion_vendedor, condicion_empresa, condicion_sucursal, condicion_origenVentas);
		}

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		if (DaysBetween(mFg.MySqlDateToTDate(fecha_inicial.c_str()),
			mFg.MySqlDateToTDate(fecha_final.c_str())) <=
			31 || vendedor != " " || cliente != " ") {
			// Si no se requiere tanta memoria asignamos buffer grande
			// (si es menor de un mes, se seleccionó vendedor o se seleccionó cliente)
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*3L);
		}
		else {
			// de lo contrario es posible requerir memoria extra así que asignamos cuatro veces el buffer grande
			if (DaysBetween(mFg.MySqlDateToTDate(fecha_inicial.c_str()),
				mFg.MySqlDateToTDate(fecha_final.c_str())) <= 63) {
				// para menos de dos meses
				mServidorVioleta->MuestraMensaje
					("-- Buffer:" + mFg.IntToAnsiString
					(TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L));
				mServidorVioleta->InicializaBuffer(Respuesta,
					TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L);
			}
			else {
				// para más de dos meses
				mServidorVioleta->MuestraMensaje
					("-- Buffer:" + mFg.IntToAnsiString
					(TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*5L));
				mServidorVioleta->InicializaBuffer(Respuesta,
					TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*5L);
			}
		}
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

		for (int j = 0; j < 4; j++) {
			if (archivos_temporales[j] != "")
				mServidorVioleta->BorraArchivoTemp(archivos_temporales[j]);
		}

		if (archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPVENTAS_X_FACTURA_REDONDEADA
void ServidorReportes::EjecutaRepVentasXFacturaRedondeada
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion, consulta;
	int reg, i;
	AnsiString fecha_inicial, fecha_final, acredito, tipofactura, ticket;
	AnsiString usuario, terminospago, especiales, terminal, canceladas,
		tipo_canceladas;
	AnsiString condicion_acredito = " ", condicion_tipofactura = " ";
	AnsiString condicion_ticket = " ", condicion_usuario = " ";
	AnsiString condicion_terminal = " ", condicion_canceladas = " ";
	AnsiString fechas_canceladas = " ";
	char *resultado;
	BufferRespuestas* resp_lista_ventas = NULL, *resp_detalle = NULL;
	double totalng, totalg, subtotalg, subtotalgiva, total;
	bool agregado_total_iva, agregado_total_iesps;
	ArregloDetalle ArregloVenta;
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", campos_base, cliente, condicion_cliente = " ";
	AnsiString referencia;
	AnsiString tipo_nombre, condicion_tipo_nombre = " ";
	AnsiString empresa, sucursal, condicion_empresa = " ", condicion_sucursal = " ", contabilizadas,
		condicion_contabilizadas = " ";
	AnsiString condicion_hora = " ", hora_inicial = " ", hora_final = " ";
	AnsiString archivo_temp1;
	AnsiString condicion_clientes_partesrel = " ", clientes_partesrel = " ";
	AnsiString canal, gironegocio;
	AnsiString condicion_gironegocio = " ", condicion_canal = " ";
	AnsiString join_clientes = " ";

	AnsiString ordenEcommerce;
	AnsiString condicion_ordenEcommerce = " ";
	AnsiString origenVentas;
	AnsiString condicion_origenVentas = " ";
	AnsiString formasDePago;
	AnsiString inner_join_formasDePago = " ";
	AnsiString agrupar_formasDePago = " ";
	AnsiString condicion_terminospago = " ", condicion_formasDePago = " ";
	AnsiString solokits, join_solokits_ventas = " ",
		join_solokits_detalles = " ";
	AnsiString corte_alta, corte_cancel, condicion_corte = " ";

	AnsiString medio_facturacion, join_cfdiweb = " ", condicion_cfdiweb = " ";

	try {
		condicion_hora = mFg.ExtraeStringDeBuffer(&parametros);
		hora_inicial = mFg.ExtraeStringDeBuffer(&parametros);
		hora_final = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		tipofactura = mFg.ExtraeStringDeBuffer(&parametros);
		ticket = mFg.ExtraeStringDeBuffer(&parametros);
		usuario = mFg.ExtraeStringDeBuffer(&parametros);
		terminospago = mFg.ExtraeStringDeBuffer(&parametros);
		especiales = mFg.ExtraeStringDeBuffer(&parametros);
		terminal = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
		contabilizadas = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		gironegocio = mFg.ExtraeStringDeBuffer(&parametros);
		canal = mFg.ExtraeStringDeBuffer(&parametros);
		ordenEcommerce = mFg.ExtraeStringDeBuffer(&parametros);
		origenVentas = mFg.ExtraeStringDeBuffer(&parametros);
		formasDePago = mFg.ExtraeStringDeBuffer(&parametros);
		solokits = mFg.ExtraeStringDeBuffer(&parametros);
		corte_alta = mFg.ExtraeStringDeBuffer(&parametros);
		corte_cancel = mFg.ExtraeStringDeBuffer(&parametros);

		medio_facturacion = mFg.ExtraeStringDeBuffer(&parametros);
		// Medio de facturación -web

		if(empresa != " "){
			condicion_empresa.sprintf(" suc.idempresa = %s and ", empresa);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" suc.sucursal='%s' and ", sucursal);
		}
		// define la forma como se mostraran los nombres de los clientes
		if (tipo_nombre == "1") {
			condicion_tipo_nombre =
				"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
		}
		else {
			condicion_tipo_nombre = "cli.rsocial";
		}

		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("v.acredito=%s and ", acredito);
		}
		if (ticket != " ") {
			condicion_ticket.sprintf("v.ticket=%s and ", ticket);
		}
		if (usuario != " ") {
			condicion_usuario.sprintf("v.usualta='%s' and ", usuario);
		}
		if (terminospago != " ") {
			condicion_terminospago.sprintf
				(" AND df.formapag IN(SELECT formapag FROM formasdepago where termino = '%s') ",
				terminospago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
		}
		if (especiales == " ") {
			if (tipofactura != " ") {
				condicion_tipofactura.sprintf("v.tipofac='%s' and ",
				tipofactura);
			}
		}
		if (especiales == "1") {
			condicion_tipofactura.sprintf("v.tipofac='ESPECIAL' and ");
		}
		if (especiales == "0") {
			if (tipofactura != " ") {
				condicion_tipofactura.sprintf("v.tipofac='%s' and ",
				tipofactura);
			}
			else
				condicion_tipofactura.sprintf("v.tipofac<>'ESPECIAL' and ");
		}

		if (terminal != " ") {
			condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("v.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "where c.cancvtacontab=1";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"where c.cancvtacontab=0 or c.cancvtacontab IS NULL";
				}
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("v.fechamodi>='%s' and v.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("v.fechavta>='%s' and v.fechavta<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "where c.vtacontab=1";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"where c.vtacontab=0 or c.vtacontab IS NULL";
				}
				fechas_canceladas.sprintf
					("v.fechavta>='%s' and v.fechavta<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			if (contabilizadas == "1") {
				condicion_contabilizadas = "where c.vtacontab=1";
			}
			if (contabilizadas == "0") {
				condicion_contabilizadas =
					"where c.vtacontab=0 or c.vtacontab IS NULL";
			}
			fechas_canceladas.sprintf
				("v.fechavta>='%s' and v.fechavta<='%s' and ", fecha_inicial,
				fecha_final);
		}

		if (condicion_hora == "1") {
			condicion_hora.sprintf(" v.horavta>='%s' AND v.horavta<='%s'  AND ",
				hora_inicial, hora_final);
		}
		else {
			condicion_hora = " ";
		}

		if (clientes_partesrel != " ") {
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s AND ",
				clientes_partesrel);
		}

		// condicion giro negocio
		if (gironegocio != " ") {
			condicion_gironegocio.sprintf("cli.giro='%s' and ", gironegocio);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		// condicion canales
		if (canal != " ") {
			condicion_canal.sprintf("cli.canal='%s' and ", canal);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		if (ordenEcommerce != "0") {
			condicion_ordenEcommerce.sprintf
				(" INNER JOIN ecommerceorden eo ON eo.referencia = v.referencia  "
				);
		}

		if (origenVentas != " ") {
			condicion_origenVentas.sprintf(" v.tipoorigen IN (%s) AND ",
				origenVentas);
		}

		if (formasDePago != " ") {
			condicion_formasDePago.sprintf(" df.formapag IN(%s) AND ",
				formasDePago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
			agrupar_formasDePago = " GROUP BY v.referencia ";
		}

		// Muestra solo kits
		if (solokits == "1") {
			join_solokits_ventas =
				" RIGHT JOIN ventaskits vk ON vk.venta=v.referencia ";
			join_solokits_detalles =
				" RIGHT JOIN dventaskits dvk ON dvk.venta=d.referencia AND dvk.articulo=d.articulo ";
		}

		if (corte_alta != " " || corte_cancel != " ") {
			if (corte_alta != " " && corte_cancel != " ") {
				condicion_corte.sprintf
					(" (v.cortecancel='%s' OR v.corte='%s') AND ", corte_cancel,
					corte_alta);
			}
			else if (corte_alta != " ") {
				condicion_corte.sprintf(" v.corte='%s' AND ", corte_alta);
			}
			else if (corte_cancel != " ") {
				condicion_corte.sprintf(" v.cortecancel='%s' AND ",
				corte_cancel);
			}
		}

		if (medio_facturacion != " ") {
			if (medio_facturacion == "0") {
				join_cfdiweb =
					" LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia ";
				condicion_cfdiweb = "  AND w.factgenerada IS NULL  ";
			}
			else if (medio_facturacion == "1") {
				join_cfdiweb =
					" INNER JOIN cfdiweb w ON w.factgenerada=v.referencia ";
			}
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		instruccion = "SET SESSION sql_log_bin = 0";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "create temporary table ventasaux (referencia char(11), folioticket char(21), foliofisic char(11), \
			fecha date, hora time, cliente char(11), rsocial varchar(255), totalng decimal(16,2), \
			subtotal decimal(16,2), totalg decimal(16,2), subtotalg decimal(16,2), \
			subtotalgiva decimal(16,2), total decimal(16,2), \
			subtotaliva0 decimal(16,2), subtotaliva0ieps decimal(16,2), \
			subtotaliva16 decimal(16,2), subtotaliva16ieps decimal(16,2), \
			impiva decimal(16,2), impiesps decimal(16,2), \
			redondeoantiguo tinyint(1), nomUsuario varchar(255), \
			PRIMARY KEY (referencia)) Engine = InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		// se dividira el proceso, se creara un archivo temporal y luego se leera
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1, Respuesta->Id);
		/**** ASI ES COMO ESTABA** */
		// Consulta todos los folios que cumplen con las referencias dadas.
		/* instruccion.sprintf("insert into ventasaux (referencia, folioticket, \
		 foliofisic, fecha, hora, cliente, rsocial, redondeoantiguo ) \
		 select v.referencia, v.folioticket, v.foliofisic, v.fechavta as fecha,  \
		 v.horavta as hora, cli.cliente, %s as nomcliente, v.redondeoantiguo \
		 from ventas v force index(fechavta) inner join clientes cli \
		 inner join terminales ter on ter.terminal=v.terminal \
		 inner join secciones sec on ter.seccion=sec.seccion \
		 where %s %s %s %s %s %s %s %s %s %s %s \
		 v.cliente=cli.cliente ",
		 condicion_tipo_nombre,
		 condicion_sucursal,
		 condicion_acredito, condicion_tipofactura, condicion_ticket,
		 condicion_usuario, condicion_terminospago, condicion_terminal,
		 condicion_canceladas,fechas_canceladas, condicion_cliente,condicion_hora);
		 if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta,  MySQL, instruccion.c_str()))
		 throw (Exception("Error en query EjecutaSelectSqlNulo")); */
		/*** ASI QUEDO **** */

		instruccion.sprintf(" \
			select v.referencia, v.folioticket, v.foliofisic, v.fechavta as fecha,  \
			v.horavta as hora, cli.cliente, %s as nomcliente, v.redondeoantiguo, \
			COALESCE(CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat), 'Sin registro') AS nomUsuario \
			from ventas v force index(fechavta) inner join clientes cli \
			%s \
			inner join terminales ter on ter.terminal=v.terminal \
			inner join secciones sec on ter.seccion=sec.seccion \
			inner join sucursales suc on suc.sucursal = sec.sucursal \
			INNER JOIN usuarios usr ON usr.empleado=v.usualta \
			INNER JOIN empleados emp ON emp.empleado=usr.empleado \
			%s \
			%s \
			%s \
			where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			v.cliente=cli.cliente \
			%s %s \
			INTO OUTFILE '%s' ", condicion_tipo_nombre,
			condicion_ordenEcommerce, inner_join_formasDePago,
			join_solokits_ventas,
			join_cfdiweb,
			condicion_empresa, condicion_sucursal, condicion_acredito,
			condicion_tipofactura, condicion_ticket, condicion_usuario,
			condicion_terminal, condicion_canceladas, fechas_canceladas,
			condicion_cliente, condicion_hora, condicion_clientes_partesrel,
			condicion_gironegocio, condicion_canal, condicion_origenVentas,
			condicion_formasDePago, condicion_corte,
			condicion_cfdiweb,
			agrupar_formasDePago, archivo_temp1);

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf("LOAD DATA INFILE '%s' \
				INTO TABLE ventasaux (referencia, folioticket, foliofisic, fecha, hora, cliente, rsocial, redondeoantiguo, nomUsuario ) "
			, archivo_temp1);

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/*** FIN DE NUEVA ESTRUCTURA** */
		instruccion = "create temporary table totimpuestosaux (referencia varchar(11), tipoimpu varchar(10), \
			porcentaje decimal(5,2), totalimpu decimal(16,2), \
			baseimpu decimal(16,6), numimpu integer(2) \
			) Engine = InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion =
			"create temporary table totimpuestoscombaux ( \
			referencia varchar(11), \
			porciva decimal(5,2), totaliva decimal(16,6), baseiva decimal(16,6),\
			porcieps decimal(5,2), totalieps decimal(16,6), baseieps decimal(16,6) ) Engine = InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf
			("select referencia, redondeoantiguo from ventasaux order by referencia"
			);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_lista_ventas);

		if (incluir_devoluciones == "1") {

			join_devoluciones.sprintf
				(" left join dnotascredcliaux dn on dn.articulo=d.articulo ");

			instruccion =
				"sum(d.cantidad-ifnull(dn.cantidad,0)) as cantidad, d.costobase, ";
			instruccion +=
				"d.porcdesc, d.tipoprec, sum(d.precio-ifnull(dn.precio,0)) as precio, ";
			instruccion +=
				"sum(d.precioimp-ifnull(dn.precioimp,0)) as precioimp, pp.precio as preciopub, ";
			campos_base = instruccion;
		}
		else {

			instruccion = "d.cantidad as cantidad, d.costobase, ";
			instruccion += "d.porcdesc, d.tipoprec, d.precio as precio, ";
			instruccion += "d.precioimp as precioimp, pp.precio as preciopub, ";
			// instruccion+="cast(d.precioimp as decimal(16,6)) as precioimp, cast(pp.precio/a.factor as decimal(16,6)) as preciopub, ";
			campos_base = instruccion;
		}

		for (reg = 0; reg < resp_lista_ventas->ObtieneNumRegistros(); reg++) {
			resp_lista_ventas->IrAlRegistroNumero(reg);

			referencia = resp_lista_ventas->ObtieneDato("referencia");

			if (incluir_devoluciones == "1") {

				instruccion.sprintf
					("drop temporary table if exists dnotascredcliaux");
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));

				// Suma las notas de crédito y deja el resultado en una tabla temporal,
				// para luego hacerle un left join con las ventas.
				instruccion.sprintf("create temporary table dnotascredcliaux \
					select d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
					sum(if(n.tipo<>'0',d.precio,0)) as precio, \
					sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp \
					from notascredcli n, dnotascredcli d \
					where n.venta='%s' and n.cancelado=0 and \
					n.referencia=d.referencia and n.fechanot<='%s' \
					group by d.articulo",
					resp_lista_ventas->ObtieneDato("referencia"),
					fecha_limite_devoluciones);
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));
			}

			try {
				// Obtiene los datos de la venta completa
				instruccion = "select d.referencia, d.articulo, ";
				instruccion += campos_base;
				instruccion +=
					"a.present, p.producto, p.nombre as nombre, a.multiplo, ";
				instruccion += "d.almacen, a.factor, a.volumen, a.peso, ";
				instruccion +=
					"concat(left(a.multiplo,3),'-',a.factor) as multfactor, ";
				instruccion +=
					"d.claveimp1, i1.tipoimpu as tipoimpuesto1, i1.porcentaje as porcentajeimp1, t1.nombre as nomtipoimp1, ";
				instruccion +=
					"d.claveimp2, i2.tipoimpu as tipoimpuesto2, i2.porcentaje as porcentajeimp2, t2.nombre as nomtipoimp2, ";
				instruccion +=
					"d.claveimp3, i3.tipoimpu as tipoimpuesto3, i3.porcentaje as porcentajeimp3, t3.nombre as nomtipoimp3, ";
				instruccion +=
					"d.claveimp4, i4.tipoimpu as tipoimpuesto4, i4.porcentaje as porcentajeimp4, t4.nombre as nomtipoimp4, ";
				instruccion += "d.almacen, ";
				instruccion +=
					"COALESCE(CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat), 'Sin registro') AS nomUsuario ";
				instruccion +=
					"from dventas d  inner join  articulos a  inner join  productos p ";
                instruccion +=
					"inner join ventas v on v.referencia=d.referencia ";
				instruccion +=
					"INNER JOIN usuarios usr ON usr.empleado=v.usualta ";
				instruccion +=
					"INNER JOIN empleados emp ON emp.empleado=usr.empleado ";
				instruccion +=
					"left join impuestos i1 on i1.impuesto=d.claveimp1 ";
				instruccion +=
					"left join impuestos i2 on i2.impuesto=d.claveimp2 ";
				instruccion +=
					"left join impuestos i3 on i3.impuesto=d.claveimp3 ";
				instruccion +=
					"left join impuestos i4 on i4.impuesto=d.claveimp4 ";
				instruccion +=
					"left join tiposdeimpuestos t1 on t1.tipoimpu=i1.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t2 on t2.tipoimpu=i2.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t3 on t3.tipoimpu=i3.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t4 on t4.tipoimpu=i4.tipoimpu ";
				instruccion +=
					"left join precios pp on pp.tipoprec=@cvepreciopublico and pp.articulo=d.articulo ";
				instruccion +=
					"left join tiposdeprecios tp on tp.tipoprec=pp.tipoprec and tp.idempresa="+FormServidor->ObtieneClaveEmpresa()+ " ";

				instruccion += join_devoluciones;
				instruccion += join_solokits_detalles;
				instruccion += "where d.referencia='";
				instruccion += referencia;
				instruccion +=
					"' and d.articulo=a.articulo and a.producto=p.producto ";
				instruccion += "group by d.articulo ";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_detalle);

				// *********************************************************
				// Calcula totales fiscales.
				ArregloVenta.UsoDelArreglo = FACT_VENTA;
				ArregloVenta.PosicionArreglo = SIN_POSICION;
				ArregloVenta.CargaBufferEnArregloDetalleVentas(resp_detalle);
				ArregloVenta.AsignaModoAjusteRedondeo
					(StrToInt(resp_lista_ventas->ObtieneDato
					("redondeoantiguo")));
				ArregloVenta.RecalculaTotalesVenta();

				double subtotalIVA0_2014, subtotalIVA0_IEPS_2014,
					subtotalIVA16_2014, subtotalIVA16_IEPS_2014;
				subtotalIVA0_2014 = ArregloVenta.CalculaSubtotalIVA0_2014();
				subtotalIVA0_IEPS_2014 =
					ArregloVenta.CalculaSubtotalIVA0_IEPS_2014();
				subtotalIVA16_2014 = ArregloVenta.CalculaSubtotalIVA16_2014();
				subtotalIVA16_IEPS_2014 =
					ArregloVenta.CalculaSubtotalIVA16_IEPS_2014();

				// Total no grabado
				totalng = subtotalIVA0_2014 + subtotalIVA0_IEPS_2014;
				// totalng=mFg.CadenaAFlotante(ArregloVenta.ArregloContenedorTotales[1][4]);
				// Total grabado  -> SIN RFC
				totalg =
					mFg.CadenaAFlotante
					(ArregloVenta.ArregloContenedorTotales[1][5]);
				for (i = 6; i <= ArregloVenta.IndiceArregloTotales; i++)
					totalg +=
						mFg.CadenaAFlotante
						(ArregloVenta.ArregloContenedorTotales[1][i]);
				// Subtotal grabado (con todos los impuestos desglosados) -> CON RFC (IESPS)
				subtotalg = subtotalIVA16_2014 + subtotalIVA16_IEPS_2014;
				// subtotalg=mFg.CadenaAFlotante(ArregloVenta.ArregloContenedorTotales[1][5]);
				// SubTotal grabado (con iva desglosado) -> CON RFC
				subtotalgiva = 0;
				for (i = 5; i <= ArregloVenta.IndiceArregloTotales; i++) {
					if (ArregloVenta.ArregloContenedorTotales[2][i] != "IVA")
						subtotalgiva +=
							mFg.CadenaAFlotante
							(ArregloVenta.ArregloContenedorTotales[1][i]);
				}
				// Total
				total = 0;
				for (i = 4; i <= ArregloVenta.IndiceArregloTotales; i++)
					total +=
						mFg.CadenaAFlotante
						(ArregloVenta.ArregloContenedorTotales[1][i]);

				// Totales de la venta
				instruccion = "update ventasaux set totalng=";
				instruccion += mFg.FormateaCantidad(totalng, 2, false);
				instruccion += ",  subtotal= ";
				instruccion +=
					mFg.FormateaCantidad
					(ArregloVenta.ArregloContenedorTotales[1][1], 2, false);
				instruccion += ",  totalg= ";
				instruccion += mFg.FormateaCantidad(totalg, 2, false);
				instruccion += ", subtotalg= ";
				instruccion += mFg.FormateaCantidad(subtotalg, 2, false);
				instruccion += ", subtotalgiva= ";
				instruccion += mFg.FormateaCantidad(subtotalgiva, 2, false);
				instruccion += ", total= ";
				instruccion += mFg.FormateaCantidad(total, 2, false);

				instruccion += ", subtotaliva0= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA0_2014, 2,
					false);
				instruccion += ", subtotaliva0ieps= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA0_IEPS_2014,
					2, false);
				instruccion += ", subtotaliva16= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA16_2014,
					2, false);
				instruccion += ", subtotaliva16ieps= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA16_IEPS_2014,
					2, false);

				agregado_total_iva = false;
				agregado_total_iesps = false;
				for (i = 6; i <= ArregloVenta.IndiceArregloTotales; i++) {
					if (ArregloVenta.ArregloContenedorTotales[2][i].LowerCase()
						== "iva" || ArregloVenta.ArregloContenedorTotales[2][i]
						.LowerCase() == "iesps") {
						instruccion += ", imp";
						instruccion +=
							ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase();
						instruccion += "= ";
						instruccion +=
							mFg.FormateaCantidad
							(ArregloVenta.ArregloContenedorTotales[1][i],
							2, false);

						if (ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase() == "iva")
							agregado_total_iva = true;
						if (ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase() == "iesps")
							agregado_total_iesps = true;
					}
				}
				// Si no se agregó un total de iva y de iesps, lo agrega con valor=0
				if (!agregado_total_iva)
					instruccion += ", impiva=0.00 ";
				if (!agregado_total_iesps)
					instruccion += ", impiesps=0.00 ";
				instruccion += " where referencia='";
				instruccion += resp_lista_ventas->ObtieneDato("referencia");
				instruccion += "'";
				// Ejecuta la instrucción
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));

				// Agrega a la tabla de impuestos desglosados
				int num_impuestos_desg = ArregloVenta.ObtieneNumImpuestosDesg();
				double porc_impuesto_desg, total_impuesto_desg,
					base_impuesto_desg;
				AnsiString tipo_impuesto_desg;
				for (i = 0; i < num_impuestos_desg; i++) {
					tipo_impuesto_desg =
						ArregloVenta.ObtieneTiposDeImpuestosDesg(i);
					porc_impuesto_desg =
						ArregloVenta.ObtienePorcImpuestosDesg(i);
					total_impuesto_desg =
						ArregloVenta.ObtieneTotalImpuestosDesg(i);
					base_impuesto_desg =
						ArregloVenta.ObtieneBaseImpuestosDesg(i);

					// Consulta todos los folios que cumplen con las referencias dadas.
					instruccion.sprintf("insert into totimpuestosaux (referencia, tipoimpu, porcentaje, totalimpu, baseimpu, numimpu) values \
						('%s','%s',%s,%s,%s,%d) ", referencia,
						tipo_impuesto_desg,
						mFg.FormateaCantidad(porc_impuesto_desg, 2, false),
						mFg.FormateaCantidad(total_impuesto_desg, 2, false),
						mFg.FormateaCantidad(base_impuesto_desg, 6, false), i);
					if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta,
						MySQL, instruccion.c_str()))
						throw(Exception("Error en query EjecutaSelectSqlNulo"));
				}

				// Agrega a la tabla de impuestos combinados (para CFDI 3.3)
				for (i = 0; i < ArregloVenta.IndiceImpCombinados; i++) {
					// Inserta a impuestos combinados.
					instruccion.sprintf("insert into totimpuestoscombaux (referencia, porciva, totaliva, baseiva, porcieps, totalieps, baseieps) values \
							('%s',%s,%s,%s,%s,%s,%s) ", referencia,
						mFg.FormateaCantidad
						(ArregloVenta.PorcIvaImpCombinados[i], 2, false),
						mFg.FormateaCantidad(ArregloVenta.IvaImpCombinados[i],
						6, false),
						mFg.FormateaCantidad
						(ArregloVenta.BaseIvaImpCombinados[i], 6, false),
						mFg.FormateaCantidad
						(ArregloVenta.PorcIepsImpCombinados[i], 2, false),
						mFg.FormateaCantidad(ArregloVenta.IepsImpCombinados[i],
						6, false),
						mFg.FormateaCantidad
						(ArregloVenta.BaseIepsImpCombinados[i], 6, false));
					if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta,
						MySQL, instruccion.c_str()))
						throw(Exception("Error en query EjecutaSelectSqlNulo"));
				}


				}
			__finally {
				if (resp_detalle != NULL)
					delete resp_detalle;
			}
		}
		if (ticket == "1") {
			// Cuando solo se piden tickets no es necesario agregar folio de CFD, ya que no tiene y así se hace más rápido
			instruccion.sprintf
				("select v.*, '' AS foliocfd, '' AS muuid from ventasaux v ");
		}
		else {
			instruccion.sprintf("select v.*, c.seriefolio AS foliocfd, c.muuid from ventasaux v \
				LEFT JOIN cfd c ON v.referencia=c.referencia AND c.tipocomprobante='VENT' \
				%s", condicion_contabilizadas);
		}
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		instruccion.sprintf
			("select tipoimpu, porcentaje, sum(totalimpu) as total from totimpuestosaux group by tipoimpu, porcentaje"
			);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		instruccion.sprintf("select porcieps, porciva,  \
				sum(totalieps) as totalieps, sum(totaliva) as totaliva, \
				sum(baseieps) as baseieps, sum(baseiva) as baseiva \
			from totimpuestoscombaux \
			group by porciva, porcieps \
			order by porciva, porcieps");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Para nueva forma de llenado de factura global cada concepto es un ticket y debe desglosar los impuestos (según GuiaAnexo20Global)
		// instruccion.sprintf("select referencia, tipoimpu, porcentaje, sum(totalimpu) as total from totimpuestosaux group by referencia, tipoimpu, porcentaje");
		instruccion.sprintf("select referencia, porcieps, porciva, \
				sum(totalieps) as totalieps, sum(totaliva) as totaliva, \
				sum(baseieps) as baseieps, sum(baseiva) as baseiva \
			from totimpuestoscombaux \
			group by referencia, porciva, porcieps \
			order by referencia, porciva, porcieps");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		instruccion = "SET SESSION sql_log_bin = 1";
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));

	}
	__finally {
		if (resp_lista_ventas != NULL)
			delete resp_lista_ventas;

		if (archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOMPRAS_X_FACTURA
void ServidorReportes::EjecutaRepComprasXFactura(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, proveedor, almacen,
		canceladas, fechas_canceladas, tipo_canceladas;
	AnsiString condicion_acredito = " ", condicion_proveedor = " ",
		condicion_almacen = " ", condicion_canceladas = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", campos_base;
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6;
	AnsiString comprador, condicion_comprador = " ";
	AnsiString supervisado, empleadosupervisor, campo_supervisado = " ";
	AnsiString condicion_supervisado = " ";
	AnsiString join_supervisado = " ";
	AnsiString com_referencia, consulta_com_referencia = " ";
	AnsiString relacionada, consulta_relacionada = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		comprador = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);
		com_referencia = mFg.ExtraeStringDeBuffer(&parametros);
		relacionada = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto5 when i5.orden=%s then @impuesto5 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("suc.sucursal='%s' and ", sucursal);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("c.acredito=%s and ", acredito);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("c.almacen='%s' and ", almacen);
		}
		if (canceladas != " ") {
			condicion_canceladas.sprintf("c.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("c.fechamodi>='%s' and c.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("c.fechacom>='%s' and c.fechacom<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("c.fechacom>='%s' and c.fechacom<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("c.fechacom>='%s' and c.fechacom<='%s' and ", fecha_inicial,
				fecha_final);
		}

		if (comprador != " ") {
			condicion_comprador.sprintf("c.comprador='%s' AND ", comprador);
		}

		join_supervisado =
			" LEFT JOIN articulossupervisados arts ON arts.producto = articulos.producto AND arts.present = articulos.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado"
			);

		if (empleadosupervisor != " ") {
			condicion_supervisado.sprintf(" arts.usuario='%s' AND ",
				empleadosupervisor);
		}
		else {
			condicion_supervisado = " ";
		}

		if (com_referencia == " ") {
			consulta_com_referencia.sprintf(" ");
		}
		else {
			consulta_com_referencia.sprintf(" c.referencia = '%s' and",
				com_referencia);
		}

		if (relacionada == " ") {
			consulta_relacionada.sprintf(" ");
		}
		else {
			consulta_relacionada.sprintf(" pro.esparterelac = '%s' and ",
				relacionada);
		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		//////////////////////      auximpuestos1       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos1 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos1 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos2       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos2 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos2 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos3       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos3 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos3 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos4       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos4 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos4 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		//////////////////////      auximpuestos5       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos5 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos5 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////////////////////////////////////////////////////

		if (incluir_devoluciones == "1") {
			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion = "CREATE TEMPORARY TABLE  dnotascredprovaux (         \
						  compra varchar(11) ,                               \
						  articulo varchar(9) ,                              \
						  cantidad decimal(34,3) ,                           \
						  costo decimal(38,6) ,                              \
						  INDEX(compra),INDEX(articulo)) ENGINE=InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("select c.referencia as compra, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
				sum(if(n.tipo<>'0',d.costo,0)) as costo \
				from notascredprov n inner join dnotascredprov d inner join compras c \
				inner join terminales ter on ter.terminal=c.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal = sec.sucursal \
				where %s %s %s %s %s %s %s  %s \
				n.compra=c.referencia and n.cancelado=0 and c.cancelado=0 and \
				n.referencia=d.referencia and n.fechanot<='%s' \
				group by c.referencia, d.articulo INTO OUTFILE '%s' ", condicion_empresa,
				condicion_sucursal, condicion_acredito, condicion_proveedor,
				condicion_almacen, condicion_canceladas, fechas_canceladas,
				condicion_comprador, fecha_limite_devoluciones, archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE dnotascredprovaux (compra,articulo,cantidad,costo) ",
				archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredprovaux dn on \
				dn.articulo=dc.articulo and dn.compra=c.referencia ");

			campos_base =
				"sum(@unidades:=(dc.cantidad-ifnull(dn.cantidad,0))*articulos.factor) as unidades, \
				sum(@suma:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) as suma, \
				sum(@descuento:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(c.descuento/100)) as descuento, \
				sum(@subtotal:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)) as subtotal, \
				sum(@iepscuota:=(dc.cantidad-ifnull(dn.cantidad,0))*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";

		}
		else {

			campos_base =
				"sum(@unidades:=dc.cantidad*articulos.factor) as unidades, \
				sum(@suma:=dc.costo*dc.cantidad) as suma, \
				sum(@descuento:=dc.costo*dc.cantidad*(c.descuento/100)) as descuento, \
				sum(@subtotal:=dc.costo*dc.cantidad*(1-c.descuento/100)) AS subtotal, \
				sum(@iepscuota:=dc.cantidad*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5. porcentaje),0, (@subtotal*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}

		consulta.sprintf("select COALESCE (prc_unico.pedido, pedxrec.pedido, ped.referencia, '') as preferencia, \
			c.referencia,sec.sucursal, c.folioprov as factura, c.muuid, c.fechacom as fecha,  \
			pro.proveedor, pro.razonsocial, c.almacen, pro.rfc, cfdi.fechatimbrado, \
			%s \
			%s \
			from compras c  inner join  dcompras dc  inner join  articulos  inner join  proveedores pro \
				inner join terminales ter on ter.terminal=c.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal=sec.sucursal \
				left join auximpuestos1 i1 on i1.impuesto=dc.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dc.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dc.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dc.claveimp4 \
				LEFT JOIN auximpuestos5 i5 ON i5.impuesto=c.impuestoret \
				LEFT JOIN cfdicompras cfdi ON cfdi.referencia = c.referencia \
				LEFT JOIN ( \
					SELECT cpp.recepcion, c.referencia AS compra, \
					GROUP_CONCAT(DISTINCT cpp.pedido ORDER BY cpp.pedido SEPARATOR ',') AS pedido \
					FROM compras c \
					INNER JOIN compraspedidosprov cpp ON cpp.compra = c.referencia \
					WHERE c.fechacom BETWEEN '%s' AND '%s' \
					GROUP BY cpp.compra \
				) prc_unico ON prc_unico.compra = c.referencia \
				LEFT JOIN ( \
					SELECT r.recepcion, cr.compra, \
					GROUP_CONCAT(DISTINCT pr.pedido ORDER BY pr.pedido SEPARATOR ',') AS pedido \
					FROM compras c \
					INNER JOIN comprecepcion cr ON cr.compra = c.referencia \
					INNER JOIN recepciones r ON r.recepcion = cr.recepcion \
					INNER JOIN pedrecepcion pr ON pr.recepcion = r.recepcion \
					WHERE c.fechacom BETWEEN '%s' AND '%s' \
					GROUP BY c.referencia	 \
				) pedxrec ON pedxrec.compra = c.referencia \
				LEFT JOIN pedidos ped ON c.referencia=ped.compra \
			%s \
			where %s %s %s %s %s %s %s %s %s %s\
			c.referencia=dc.referencia and \
			dc.articulo=articulos.articulo and c.proveedor=pro.proveedor \
			group by c.referencia \
			order by suc.numid, c.referencia",campos_base, campos_val_impuestos,
			fecha_inicial, fecha_final, fecha_inicial, fecha_final,
			join_devoluciones, condicion_empresa,
			condicion_sucursal, condicion_acredito, condicion_proveedor,
			condicion_almacen, condicion_canceladas, fechas_canceladas,
			condicion_comprador, consulta_com_referencia,
			consulta_relacionada);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		instruccion = "SET SESSION sql_log_bin = 0";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "SET SESSION sql_log_bin = 1";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			if (incluir_devoluciones == "1")
				mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCARCLI_X_NOTA
void ServidorReportes::EjecutaRepNotcarcliXNota(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion, condicion_canceladas = " ", condicion_tipo_cargo =
		" ", fechas_canceladas = " ";
	AnsiString condicion_cliente = " ";
	AnsiString condicion_tipo_nombre = " ";
	AnsiString condicion_empresa = " ", condicion_sucursal = " ", condicion_terminal = " ",
		contabilizadas = " ";
	AnsiString fecha_inicial, fecha_final, empresa, sucursal, terminal, porapellido;
	AnsiString cliente, canceladas, tipocanceladas, tiponcar;

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa =  mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	porapellido = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	canceladas = mFg.ExtraeStringDeBuffer(&parametros);
	tipocanceladas = mFg.ExtraeStringDeBuffer(&parametros);
	tiponcar = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (terminal != " ") {
		condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
	}

	if (empresa != " "){
        condicion_empresa.sprintf(" suc.idempresa = %s and ", empresa);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
	}

	// define la forma como se mostraran los nombres de los clientes
	if (porapellido == "1") {
		condicion_tipo_nombre =
			"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
	}
	else {
		condicion_tipo_nombre = "cli.rsocial";
	}

	if (cliente != " ")
		condicion_cliente.sprintf(" and v.cliente='%s' ", cliente);

	if (canceladas == "0") {
		if (contabilizadas == "1") {
			condicion_canceladas = " and nc.cancelado=0 and c.vtacontab=1 ";
		}
		if (contabilizadas == "0") {
			condicion_canceladas =
				" and nc.cancelado=0 and (c.vtacontab=0 or c.vtacontab IS NULL) ";
		}
		if (contabilizadas == " ") {
			condicion_canceladas = " and nc.cancelado=0 ";
		}
		fechas_canceladas.sprintf
			("and nc.fechanot>='%s' and nc.fechanot<='%s' ",
			fecha_inicial.c_str(), fecha_final.c_str());
	}
	else {
		if (contabilizadas == "1") {
			condicion_canceladas = " and nc.cancelado=1 and c.cancvtacontab=1 ";
		}
		if (contabilizadas == "0") {
			condicion_canceladas =
				" and nc.cancelado=1 and (c.cancvtacontab=0 or c.cancvtacontab IS NULL) ";
		}
		if (contabilizadas == " ") {
			condicion_canceladas = " and nc.cancelado=1 ";
		}
		if (tipocanceladas == "0") {
			fechas_canceladas.sprintf
				("and nc.fechamodi>='%s' and nc.fechamodi<='%s' ",
				fecha_inicial.c_str(), fecha_final.c_str());
		}
		else {
			fechas_canceladas.sprintf
				("and nc.fechanot>='%s' and nc.fechanot<='%s' ",
				fecha_inicial.c_str(), fecha_final.c_str());
		}
	}

	if (tiponcar == " ")
		condicion_tipo_cargo = " and txc.tipo<>'CHDE' ";
	if (tiponcar == "0")
		condicion_tipo_cargo = " and txc.tipo='NCAR' ";
	if (tiponcar == "1")
		condicion_tipo_cargo = " and txc.tipo='INTE' ";
	if (tiponcar == "2")
		condicion_tipo_cargo = " and txc.tipo='RETR' ";

	Instruccion.sprintf("select txc.notacar as referencia, \
				 c.muuid, txc.tipo, \
				 if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as factura, \
				 c.foliocfd, txc.fechaalta as fecha, txc.horaalta as hora, %s as nomcliente, \
				 txc.valor as total, \
				 if(imp.porcentaje=15.00, (txc.valor/(1+(imp.porcentaje/100))),0) as sub15, \
				 if(imp.porcentaje=16.00, (txc.valor/(1+(imp.porcentaje/100))),0) as sub16, \
				 0 as sub0, \
				 if(imp.porcentaje=15.00, (txc.valor-(txc.valor/(1+(imp.porcentaje/100)))),0) as iva15, \
				 if(imp.porcentaje=16.00, (txc.valor-(txc.valor/(1+(imp.porcentaje/100)))),0) as iva16 \
				 from transxcob txc inner join notascarcli nc inner join ventas v inner join clientes cli inner join impuestos imp \
						inner join terminales ter on ter.terminal=v.terminal \
						inner join secciones sec on ter.seccion=sec.seccion \
						inner join sucursales suc on suc.sucursal=sec.sucursal \
						left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
						left join (SELECT referencia, seriefolio as foliocfd, muuid, vtacontab, cancvtacontab FROM cfd where cfd.tipocomprobante='NCAR') c on c.referencia=txc.notacar \
				 where %s %s %s v.referencia=txc.referencia and txc.notacar=nc.referencia \
				 and nc.cliente=cli.cliente and imp.impuesto=nc.cveimp \
				 %s %s %s %s order by suc.numid, nc.referencia, factura ",
		condicion_tipo_nombre, condicion_empresa ,condicion_sucursal, condicion_terminal,
		fechas_canceladas, condicion_canceladas, condicion_tipo_cargo,
		condicion_cliente);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCARPROV_X_NOTA
void ServidorReportes::EjecutaRepNotcarprovXNota(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDCLI_X_NOTA_REDONDEADA
void ServidorReportes::EjecutaRepNotcredcliXNotaRedondeada
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion, consulta;
	int reg, i;
	char *resultado;
	BufferRespuestas* resp_lista_notas = NULL, *resp_detalle = NULL,
		*resp_sum_notas = NULL;
	double totalng, totalg, subtotalg, subtotalgiva, total;
	bool agregado_total_iva, agregado_total_iesps;
	ArregloDetalle ArregloVenta;
	AnsiString fecha_inicial, fecha_final, tipo, canceladas, tipo_canceladas,
		fechas_canceladas, fecha_inicial_ventas, fecha_final_ventas;
	AnsiString condicion_tipo = " ", condicion_canceladas = " ";
	AnsiString nota, venta, cliente, condicion_cliente = " ";
	int tiponota;
	double suma_notas, valor;
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString terminal, condicion_terminal = " ", contabilizadas,
		condicion_contabilizadas = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		terminal = mFg.ExtraeStringDeBuffer(&parametros);
		contabilizadas = mFg.ExtraeStringDeBuffer(&parametros);

		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa=%s and ", empresa);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf("cli.cliente='%s' and ", cliente);
		}
		if (tipo != " ") {
			condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
		}

		if (terminal != " ") {
			condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "where c.cancvtacontab=1";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"where c.cancvtacontab=0 or c.cancvtacontab IS NULL";
				}
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("n.fechanot>='%s' and n.fechanot<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "where c.vtacontab=1";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"where c.vtacontab=0 or c.vtacontab IS NULL";
				}
				fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			if (contabilizadas == "1") {
				condicion_contabilizadas = "where c.vtacontab=1";
			}
			if (contabilizadas == "0") {
				condicion_contabilizadas =
					"where c.vtacontab=0 or c.vtacontab IS NULL";
			}
			fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		instruccion = "create temporary table notasaux (referencia char(11), nota char(11), valor decimal(16,2), \
			venta char(11), factura char(11), tipo char(1), \
			fecha date, hora time,fechavta date, tipodescrito char(60), cliente char(11), rsocial varchar(255), totalng decimal(16,2), \
			subtotal decimal(16,2), totalg decimal(16,2), subtotalg decimal(16,2), \
			subtotalgiva decimal(16,2), total decimal(16,2), \
			subtotaliva0 decimal(16,2), subtotaliva0ieps decimal(16,2), \
			subtotaliva16 decimal(16,2), subtotaliva16ieps decimal(16,2), \
			impiva decimal(16,2), impiesps decimal(16,2), \
			redondeoantiguo tinyint(1), \
			PRIMARY KEY (referencia)) Engine = InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las ventas.
		instruccion =
			"create temporary table dnotascredcliaux (articulo varchar(9), cantidad decimal(12,3), precio decimal(16,6), precioimp decimal(16,6), PRIMARY KEY (articulo)) Engine = InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		// Consulta todos los folios que cumplen con las referencias dadas.
		instruccion.sprintf("insert into notasaux (referencia, nota, valor, venta, fechavta, factura,  tipo, fecha, hora, tipodescrito, cliente, rsocial, redondeoantiguo) \
			select n.referencia, n.foliofisic as nota, n.valor, n.venta, v.fechavta,\
			if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as factura, \
			n.tipo, n.fechanot as fecha, n.horaalta as hora,  \
			if(n.tipo=0, 'DEVOLUCION', if(n.tipo=1, 'BONIFICACION', 'DESCUENTO')) as tipodescrito, \
			cli.cliente, cli.rsocial, v.redondeoantiguo \
			from notascredcli n inner join  ventas v inner join  clientes cli \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
                INNER JOIN sucursales suc on sec.sucursal = suc.sucursal\
				left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
			where %s %s %s %s %s %s %s\
			v.fechavta>='%s' and v.fechavta<='%s' and \
			n.venta=v.referencia and v.cliente=cli.cliente ", condicion_empresa,
			condicion_sucursal, condicion_canceladas, condicion_tipo,
			fechas_canceladas, condicion_cliente, condicion_terminal,
			fecha_inicial_ventas, fecha_final_ventas);

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf
			("select referencia, tipo, valor, venta, redondeoantiguo from notasaux"
			);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_lista_notas);

		for (reg = 0; reg < resp_lista_notas->ObtieneNumRegistros(); reg++) {
			resp_lista_notas->IrAlRegistroNumero(reg);

			try {
				nota = resp_lista_notas->ObtieneDato("referencia");
				tiponota = StrToInt(resp_lista_notas->ObtieneDato("tipo"));
				venta = resp_lista_notas->ObtieneDato("venta");
				valor = StrToFloat(resp_lista_notas->ObtieneDato("valor"));

				// Obtiene todo el detalle de la nota con algunos datos extras que necesita el cliente
				instruccion =
					"select dn.referencia, dn.articulo, dn.cantidad, dn.precio, dn.precioimp, ";
				instruccion +=
					"a.present, p.producto, p.nombre as nombre, a.multiplo, ";
				instruccion += "dv.almacen, a.factor, a.volumen, a.peso, v.fechavta, ";
				instruccion +=
					"concat(left(a.multiplo,3),'-',a.factor) as multfactor, ";
				instruccion +=
					"dv.claveimp1, i1.tipoimpu as tipoimpuesto1, i1.porcentaje as porcentajeimp1, t1.nombre as nomtipoimp1, ";
				instruccion +=
					"dv.claveimp2, i2.tipoimpu as tipoimpuesto2, i2.porcentaje as porcentajeimp2, t2.nombre as nomtipoimp2, ";
				instruccion +=
					"dv.claveimp3, i3.tipoimpu as tipoimpuesto3, i3.porcentaje as porcentajeimp3, t3.nombre as nomtipoimp3, ";
				instruccion +=
					"dv.claveimp4, i4.tipoimpu as tipoimpuesto4, i4.porcentaje as porcentajeimp4, t4.nombre as nomtipoimp4, ";
				instruccion += "(dn.precioimp*dn.cantidad) as importe, ";
				instruccion += "(dn.precio*dn.cantidad) as importedesg, ";
				instruccion +=
					"@porciva:=(if(i1.tipoimpu='IVA',i1.porcentaje,0)+if(i2.tipoimpu='IVA',i2.porcentaje, 0)+if(i3.tipoimpu='IVA',i3.porcentaje, 0)+if(i4.tipoimpu='IVA',i4.porcentaje, 0)) as porciva, ";
				instruccion +=
					"@porciesps:=(if(i1.tipoimpu='IESPS',i1.porcentaje,0)+if(i2.tipoimpu='IESPS',i2.porcentaje, 0)+if(i3.tipoimpu='IESPS',i3.porcentaje, 0)+if(i4.tipoimpu='IESPS',i4.porcentaje, 0)) as porciesps, ";
				instruccion +=
					"((dn.precioimp*dn.cantidad)/(1+@porciva/100)) as importeivadesg, ";
				instruccion +=
					"((dn.precioimp)/(1+@porciva/100)) as precioivadesg ";
				instruccion +=
					"from notascredcli nc  inner join  dnotascredcli dn  inner join  dventas dv  inner join  articulos a  inner join  productos p ";
                instruccion +=
					"inner join ventas v ";
				instruccion +=
					"left join impuestos i1 on i1.impuesto=dv.claveimp1 ";
				instruccion +=
					"left join impuestos i2 on i2.impuesto=dv.claveimp2 ";
				instruccion +=
					"left join impuestos i3 on i3.impuesto=dv.claveimp3 ";
				instruccion +=
					"left join impuestos i4 on i4.impuesto=dv.claveimp4 ";
				instruccion +=
					"left join tiposdeimpuestos t1 on t1.tipoimpu=i1.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t2 on t2.tipoimpu=i2.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t3 on t3.tipoimpu=i3.tipoimpu ";
				instruccion +=
					"left join tiposdeimpuestos t4 on t4.tipoimpu=i4.tipoimpu ";
				instruccion += "where nc.referencia='";
				instruccion += nota;
				instruccion +=
					"' and nc.venta=dv.referencia and nc.referencia=dn.referencia ";
				instruccion +=
					" and dv.articulo=dn.articulo and dn.articulo=a.articulo ";
				instruccion +=
					" and a.producto=p.producto and a.producto=p.producto";
				instruccion +=
					" and dv.referencia=v.referencia";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_detalle);

				// Limpia la tabla auxiliar
				instruccion = "delete from dnotascredcliaux";
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));

				instruccion =
					"insert into dnotascredcliaux (articulo, cantidad, precio, precioimp) ";
				instruccion +=
					"select d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, ";
				instruccion += "sum(if(n.tipo<>'0',d.precio,0)) as precio, ";
				instruccion +=
					"sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp ";
				instruccion += "from notascredcli n, dnotascredcli d ";
				instruccion += "where n.venta='";
				instruccion += venta;
				instruccion +=
					"' and n.cancelado=0 and n.referencia=d.referencia ";
				instruccion += "group by d.articulo";
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));

				// Sumatoria de todas las notas de crédito.
				instruccion.sprintf
					("select ifnull(sum(valor),0) as sumnotas from notascredcli where cancelado=0 and venta=@folioventa"
					);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_sum_notas);
				suma_notas =
					StrToFloat(resp_sum_notas->ObtieneDato("sumnotas"));

				// *********************************************************
				// Calcula totales fiscales.
				// 0=Devolución
				// 1=Bonificación de un solo artículo
				// 2=Descuento a toda la factura
				ArregloVenta.PorcentajeDescuento = 0;
				switch (tiponota) {
				case 0:
					ArregloVenta.UsoDelArreglo = NCRE_DEVO_VENTA;
					break;
				case 1:
					ArregloVenta.UsoDelArreglo = NCRE_DESP_VENTA;
					break;
				case 2:
					ArregloVenta.UsoDelArreglo = NCRE_DESG_VENTA;
				}
				ArregloVenta.PosicionArreglo = ABAJO;
				ArregloVenta.CargaBufferEnArregloDetalleVentas(resp_detalle);
				ArregloVenta.SumatoriaNCredito = suma_notas;
				ArregloVenta.ValorOriginal = valor;
				ArregloVenta.AsignaModoAjusteRedondeo
					(StrToInt(resp_lista_notas->ObtieneDato
					("redondeoantiguo")));
				ArregloVenta.RecalculaTotalesVenta();

				double subtotalIVA0_2014, subtotalIVA0_IEPS_2014,
					subtotalIVA16_2014, subtotalIVA16_IEPS_2014;
				subtotalIVA0_2014 = ArregloVenta.CalculaSubtotalIVA0_2014();
				subtotalIVA0_IEPS_2014 =
					ArregloVenta.CalculaSubtotalIVA0_IEPS_2014();
				subtotalIVA16_2014 = ArregloVenta.CalculaSubtotalIVA16_2014();
				subtotalIVA16_IEPS_2014 =
					ArregloVenta.CalculaSubtotalIVA16_IEPS_2014();

				// Total no grabado
				totalng = subtotalIVA0_2014 + subtotalIVA0_IEPS_2014;
				// totalng=mFg.CadenaAFlotante(ArregloVenta.ArregloContenedorTotales[1][4]);
				// Total grabado  -> SIN RFC
				totalg =
					mFg.CadenaAFlotante
					(ArregloVenta.ArregloContenedorTotales[1][5]);
				for (i = 6; i <= ArregloVenta.IndiceArregloTotales; i++)
					totalg +=
						mFg.CadenaAFlotante
						(ArregloVenta.ArregloContenedorTotales[1][i]);
				// Subtotal grabado (con todos los impuestos desglosados) -> CON RFC (IESPS)
				subtotalg = subtotalIVA16_2014 + subtotalIVA16_IEPS_2014;
				// subtotalg=mFg.CadenaAFlotante(ArregloVenta.ArregloContenedorTotales[1][5]);
				// SubTotal grabado (con iva desglosado) -> CON RFC
				subtotalgiva = 0;
				for (i = 5; i <= ArregloVenta.IndiceArregloTotales; i++) {
					if (ArregloVenta.ArregloContenedorTotales[2][i] != "IVA")
						subtotalgiva +=
							mFg.CadenaAFlotante
							(ArregloVenta.ArregloContenedorTotales[1][i]);
				}
				// Total
				total = 0;
				for (i = 4; i <= ArregloVenta.IndiceArregloTotales; i++)
					total +=
						mFg.CadenaAFlotante
						(ArregloVenta.ArregloContenedorTotales[1][i]);

				// Totales de la venta
				instruccion = "update notasaux set totalng=";
				instruccion += mFg.FormateaCantidad(totalng, 2, false);
				instruccion += ",  subtotal= ";
				instruccion +=
					mFg.FormateaCantidad
					(ArregloVenta.ArregloContenedorTotales[1][1], 2, false);
				instruccion += ",  totalg= ";
				instruccion += mFg.FormateaCantidad(totalg, 2, false);
				instruccion += ", subtotalg= ";
				instruccion += mFg.FormateaCantidad(subtotalg, 2, false);
				instruccion += ", subtotalgiva= ";
				instruccion += mFg.FormateaCantidad(subtotalgiva, 2, false);
				instruccion += ", total= ";
				instruccion += mFg.FormateaCantidad(total, 2, false);

				instruccion += ", subtotaliva0= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA0_2014, 2,
					false);
				instruccion += ", subtotaliva0ieps= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA0_IEPS_2014,
					2, false);
				instruccion += ", subtotaliva16= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA16_2014,
					2, false);
				instruccion += ", subtotaliva16ieps= ";
				instruccion += mFg.FormateaCantidad(subtotalIVA16_IEPS_2014,
					2, false);

				agregado_total_iva = false;
				agregado_total_iesps = false;
				for (i = 6; i <= ArregloVenta.IndiceArregloTotales; i++) {
					if (ArregloVenta.ArregloContenedorTotales[2][i].LowerCase()
						== "iva" || ArregloVenta.ArregloContenedorTotales[2][i]
						.LowerCase() == "iesps") {
						instruccion += ", imp";
						instruccion +=
							ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase();
						instruccion += "= ";
						instruccion +=
							mFg.FormateaCantidad
							(ArregloVenta.ArregloContenedorTotales[1][i],
							2, false);

						if (ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase() == "iva")
							agregado_total_iva = true;
						if (ArregloVenta.ArregloContenedorTotales[2][i]
							.LowerCase() == "iesps")
							agregado_total_iesps = true;
					}
				}
				// Si no se agregó un total de iva y de iesps, lo agrega con valor=0
				if (!agregado_total_iva)
					instruccion += ", impiva=0.00 ";
				if (!agregado_total_iesps)
					instruccion += ", impiesps=0.00 ";
				instruccion += " where referencia='";
				instruccion += nota;
				instruccion += "'";

				// Ejecuta la instrucción
				if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
					instruccion.c_str()))
					throw(Exception("Error en query EjecutaSelectSqlNulo"));
			}
			__finally {
				if (resp_sum_notas != NULL)
					delete resp_sum_notas;
				if (resp_detalle != NULL)
					delete resp_detalle;
			}
		}

		instruccion.sprintf("select n.*, c.foliocfd, c.muuid from notasaux n \
			left join (SELECT referencia, seriefolio as foliocfd, muuid, vtacontab, cancvtacontab FROM cfd  where tipocomprobante='NCRE') c on c.referencia=n.referencia %s"
			, condicion_contabilizadas);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		if (resp_lista_notas != NULL)
			delete resp_lista_notas;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDCLI_X_NOTA
void ServidorReportes::EjecutaRepNotcredcliXNota(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, tipo, canceladas, tipo_canceladas,
		fechas_canceladas, fecha_inicial_ventas, fecha_final_ventas;
	AnsiString condicion_tipo = " ", condicion_canceladas = " ";
	AnsiString cliente, condicion_cliente = " ";
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString terminal, condicion_terminal = " ", contabilizadas,
		condicion_contabilizadas = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		terminal = mFg.ExtraeStringDeBuffer(&parametros);
		contabilizadas = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		}else if(empresa != " ") {
           condicion_empresa.sprintf("suc.idempresa = %s AND ", empresa);
		}

		if (cliente != " ") {
			condicion_cliente.sprintf("cli.cliente='%s' and ", cliente);
		}
		if (tipo != " ") {
			condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
		}

		if (terminal != " ") {
			condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "cfd.cancvtacontab=1 and ";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"(cfd.cancvtacontab=0 or cfd.cancvtacontab IS NULL) and ";
				}
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("n.fechanot>='%s' and n.fechanot<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				if (contabilizadas == "1") {
					condicion_contabilizadas = "cfd.vtacontab=1 and ";
				}
				if (contabilizadas == "0") {
					condicion_contabilizadas =
						"(cfd.vtacontab=0 or cfd.vtacontab IS NULL) and ";
				}
				fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			if (contabilizadas == "1") {
				condicion_contabilizadas = "cfd.vtacontab=1 and ";
			}
			if (contabilizadas == "0") {
				condicion_contabilizadas =
					"(cfd.vtacontab=0 or cfd.vtacontab IS NULL) and ";
			}
			fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechainicialventas='%s'",
			fecha_inicial_ventas);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinalventas='%s'", fecha_final_ventas);
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("select n.referencia, n.foliofisic as nota, n.tipo as tipo, \
			if(n.tipo=0, 'DEVOL', if(n.tipo=1, 'BONIF', 'DESCU')) as tipodescrito, \
			v.referencia as venta, \
			if(ifnull(v.foliofisic,'')='',concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as factura, \
			cfd.foliocfd, cfd.muuid, cfd.fechaalta, \
			n.fechanot as fecha, n.horaalta as hora, \
			cli.cliente, cli.rsocial, cli.rfc , v.fechavta, \
			sum(@unidades:=dn.cantidad*articulos.factor) as unidades, \
			sum(@suma:=dn.precio*dn.cantidad) as suma, \
			sum(@subtotal:=dn.precio*dn.cantidad) as subtotal, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
			%s \
			from notascredcli n  \
				inner join  dnotascredcli dn \
				inner join  dventas dv \
				inner join  articulos \
				inner join  clientes cli \
				inner join  ventas v \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal=sec.sucursal \
				left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 \
				left join cfd cfdv on v.referencia=cfdv.referencia and cfdv.tipocomprobante='VENT' \
				left join (SELECT referencia, seriefolio as foliocfd, muuid, vtacontab, cancvtacontab, fechaalta FROM cfd where tipocomprobante='NCRE') cfd on cfd.referencia=n.referencia \
			where %s %s %s %s %s %s %s %s \
			v.fechavta>=@fechainicialventas and v.fechavta<=@fechafinalventas and \
			n.referencia=dn.referencia and v.referencia=n.venta and \
			dn.articulo=dv.articulo and v.referencia=dv.referencia and \
			dn.articulo=articulos.articulo and v.cliente=cli.cliente \
			group by n.referencia \
			order by suc.numid, n.referencia", campos_val_impuestos, condicion_empresa, condicion_sucursal,
			condicion_tipo, condicion_canceladas, fechas_canceladas,
			condicion_cliente, condicion_terminal, condicion_contabilizadas);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDPROV_X_NOTA
void ServidorReportes::EjecutaRepNotcredprovXNota(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, tipo, canceladas, fechas_canceladas,
		tipo_canceladas, fecha_inicial_ventas, fecha_final_ventas;
	AnsiString condicion_tipo = " ", condicion_canceladas = " ";
	AnsiString proveedor, condicion_proveedor = " ";
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 when i5.orden=%s then @impuesto5 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if(empresa != " "){
			condicion_empresa.sprintf("suc.idempresa = %s AND ", empresa);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}

		if (tipo != " ") {
			condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
		}
		// condiciones cancelaciones
		if (canceladas != " ") {
			condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("n.fechanot>='%s' and n.fechanot<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 5; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechainicialventas='%s'",
			fecha_inicial_ventas);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinalventas='%s'", fecha_final_ventas);
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("select n.referencia, n.folioprov as nota, c.muuid AS uuidcom, n.muuid, n.tipo as tipo, \
			if(n.tipo=0, 'DEVOL', if(n.tipo=1, 'BONIF', 'DESCU')) as tipodescrito, \
			c.referencia as compra, c.folioprov as factura, \
			n.fechanot as fecha, n.horaalta as hora,  \
			DATE_FORMAT(cfdi.fechatimbrado, '%%d/%%m/%%Y') AS fecha_emision, \
			pro.proveedor, pro.razonsocial, pro.rfc, \
			sum(@unidades:=dn.cantidad*articulos.factor) as unidades, \
			sum(@suma:=dn.costo*dn.cantidad) as suma, \
			sum(@subtotal:=dn.costo*dn.cantidad) as subtotal, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*i5.porcentaje/100)) ) AS imp5, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
			sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
			sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
			sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
			%s \
			from notascredprov n  inner join  dnotascredprov dn  inner join  dcompras dc  inner join  articulos  inner join  proveedores pro  inner join  compras c \
				inner join terminales ter on ter.terminal=c.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join terminales tern on tern.terminal=n.terminal \
				inner join secciones secn on tern.seccion=secn.seccion \
				inner join sucursales suc on suc.sucursal=secn.sucursal \
				left join cfdincreprov cfdi on cfdi.referencia = n.referencia  \
				left join auximpuestos1 i1 on i1.impuesto=dc.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dc.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dc.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dc.claveimp4 \
				left join auximpuestos5 i5 on i5.impuesto=c.impuestoret \
			where %s %s %s %s %s %s \
			c.fechacom>=@fechainicialventas and c.fechacom<=@fechafinalventas and \
			n.referencia=dn.referencia and c.referencia=n.compra and \
			dn.articulo=dc.articulo and c.referencia=dc.referencia and \
			dn.articulo=articulos.articulo and c.proveedor=pro.proveedor \
			group by n.referencia \
			order by suc.numid, n.referencia", campos_val_impuestos, condicion_empresa, condicion_sucursal,
			condicion_tipo, condicion_canceladas, fechas_canceladas, condicion_proveedor);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPVENTAS_X_ARTICULO
void ServidorReportes::EjecutaRepVentasXArticulo(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, almacen, producto, marca;
	AnsiString clasif1, clasif2, clasif3, clasifcont1, clasifcont2;
	AnsiString condicion_acredito = " ", condicion_almacen = " ",
		condicion_producto = " ", condicion_marca = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_clasifcont1 = " ", condicion_clasifcont2 = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_clasificaciones = " ", join_devoluciones = " ";
	AnsiString campos_base = " ", campos_base_aux = " ";
	AnsiString condicion_canceladas = " ", canceladas, tipo_canceladas,
		fechas_canceladas = " ";
	AnsiString tipo_impuestos, impuesto_particular, negar_impuestos,
		condicion_tipo_imp = " ", condicion_imp = " ";
	AnsiString tipo_impuestos2, impuesto_particular2, negar_impuestos2,
		condicion_tipo_imp2 = " ", condicion_imp2 = " ";
	AnsiString tipofacturacion, cliente, condicion_tipofac = " ",
		condicion_cliente = " ";
	AnsiString presentacion, condicion_articulo = " ", agrupamiento;
	AnsiString tipo_nombre, condicion_tipo_nombre = " ";
    AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";
	AnsiString empleado, condicion_empleado = " ";
	AnsiString fabricante, condicion_fabricante = " ";
	AnsiString segmento, condicion_segmento = " ";

	AnsiString join_presentacion1 = " ";

	AnsiString terminospago;
	AnsiString ticket, condicion_ticket = " ";

	AnsiString join_clientes = " ";

	AnsiString vendedor, condicion_vendedor = " ", join_vendedor = " ";
	AnsiString ClaveUnidad, ProdServ, condicionclaveunidad = " ",
		condicionprodserv = " ";
	AnsiString joinclaveunidad = " ", joinprodserv = " ";

	AnsiString cuentabancaria, join_cuentabancaria = " ",
		ponderacion_bancos = " ";
	AnsiString gironegocio, condicion_gironegocio = " ";

	AnsiString canales, condicion_canal = " ", join_canal = " ";
	AnsiString tipoprecio, condicion_tipoprecio = " ", join_tipoprecio = " ";
	AnsiString agrupadopor, condicion_agrupadopor = " ", join_agrupadopor = " ";
	AnsiString campos_peso_volumen = " ", peso_y_volumen;
	AnsiString leftjoin_empleado = " ";
	AnsiString listaTags, join_art_tags = " ", condicion_art_tags = " ";

	AnsiString ordenEcommerce;
	AnsiString inner_ordenEcommerce = " ";

	AnsiString origenVenta;
	AnsiString condicion_origenVenta = " ";
	AnsiString formasDePago, fpago_porcentaje = " ", fpago_porcentaje2 = " ";
	AnsiString inner_join_formasDePago = " ";

	AnsiString empleadosupervisor = " ";
	AnsiString condicion_empleadosupervisor = " ", inner_empleadosupervisor =
		" ", campo_supervisado = " ", inner_join_terminoPago = " ";
	AnsiString condicion_formasDePago = " ", condicion_terminospago = " ";
	AnsiString soloKits = "0", join_solokits = " ";

	AnsiString refVnta;
	AnsiString condicion_refVnta = " ";

	AnsiString forzar_indice_vta = " ";
	TDate date_fecha_inicio, date_fecha_fin;

	AnsiString multiplo, condicion_multiplo = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		terminospago = mFg.ExtraeStringDeBuffer(&parametros);
		ticket = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		empleado = mFg.ExtraeStringDeBuffer(&parametros);

		presentacion = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);

		ClaveUnidad = mFg.ExtraeStringDeBuffer(&parametros);
		ProdServ = mFg.ExtraeStringDeBuffer(&parametros);

		cuentabancaria = mFg.ExtraeStringDeBuffer(&parametros);
		gironegocio = mFg.ExtraeStringDeBuffer(&parametros);

		canales = mFg.ExtraeStringDeBuffer(&parametros);
		tipoprecio = mFg.ExtraeStringDeBuffer(&parametros);
		agrupadopor = mFg.ExtraeStringDeBuffer(&parametros);
		peso_y_volumen = mFg.ExtraeStringDeBuffer(&parametros);

		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);

		listaTags = mFg.ExtraeStringDeBuffer(&parametros);
		ordenEcommerce = mFg.ExtraeStringDeBuffer(&parametros);

		origenVenta = mFg.ExtraeStringDeBuffer(&parametros);
		formasDePago = mFg.ExtraeStringDeBuffer(&parametros);

		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);

		soloKits = mFg.ExtraeStringDeBuffer(&parametros);
		refVnta = mFg.ExtraeStringDeBuffer(&parametros);

		multiplo = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		// Optimización:
		// Si el rango de fechas es pequeño, arbitrariamente elejimos menor de 3 meses, se
		// forza el indice fechavta, pues reduce el tamañó de la muestra.
		date_fecha_inicio = mFg.MySqlDateToTDate(fecha_inicial.c_str());
		date_fecha_fin = mFg.MySqlDateToTDate(fecha_final.c_str());
		if (abs(double(date_fecha_fin - date_fecha_inicio)) <= 183) {
			forzar_indice_vta = " force index(fechavta) ";
		}

		if (clientes_partesrel != " ") {
			join_clientes =
				" inner join clientes cli on cli.cliente=v.cliente ";
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s and ",
				clientes_partesrel);
		}
		// condicion giro negocio
		if (gironegocio != " ") {
			condicion_gironegocio.sprintf("cli.giro='%s' and ", gironegocio);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		// condicion canales
		if (canales != " ") {
			condicion_canal.sprintf("cli.canal='%s' and ", canales);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		// condicion canales
		if(tipoprecio != " " && tipoprecio != "TODOS"){
			condicion_tipoprecio.sprintf("dv.tipoprec IN(%s) and ",
			tipoprecio);
			if (join_clientes == " "){
				join_clientes.sprintf(
					" inner join clientes cli on cli.cliente=v.cliente \
					  left join clientesemp ce on ce.cliente=cli.cliente AND ce.idempresa = suc.idempresa " );
			}
		}

		if(empresa != " "){
			condicion_empresa.sprintf(" suc.idempresa = %s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("suc.sucursal='%s' and ", sucursal);
		}
		if (tipo_nombre == "1") {
			condicion_tipo_nombre =
				" if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente, ";
		}
		else {
			condicion_tipo_nombre = " cli.rsocial as nomcliente, ";
		}

		// cuando se elija ordenar por giro, los demas datos no cambian
		// campos, inners, condiciones
		// solo se cambiara el GROUP y ORDER y se usaran los campos necesarios para este orden

		if (agrupadopor.Trim().IsEmpty()) {
			if (presentacion != " ") {
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
				campos_base.sprintf(" %s v.referencia, \
										if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as foliofisic, \
										v.fechavta, ", condicion_tipo_nombre);
				condicion_articulo.sprintf("articulos.present='%s' and ",
					presentacion);
				agrupamiento =
					"group by v.referencia, prod.nombre, articulos.present, articulos.multiplo \
								order by v.referencia, prod.nombre, articulos.present, articulos.multiplo";
			}
			else {
				agrupamiento = "group by pre.producto, pre.present \
									order by prod.nombre, pre.present ";
			}
		}
		else if (agrupadopor == "GI") {

			campos_base.sprintf
				(" gn.giro as clavegi, gn.nombre as nomgiro, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes = " inner join clientes cli on cli.cliente=v.cliente \
								left join gironegocio gn on cli.giro= gn.giro";

			agrupamiento = "group by cli.giro \
							  ORDER BY gn.nombre ASC ";
		}
		else if (agrupadopor == "SE") {

			campos_base.sprintf
				(" sxx.sector as clavese, sxx.nombre AS nomsector, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								INNER JOIN colonias  col ON cli.colonia=col.colonia \
								INNER JOIN sectores sxx ON col.sector=sxx.sector ";

			agrupamiento = "GROUP BY sxx.sector \
							  ORDER BY sxx.nombre ASC ";

		}
		else if (agrupadopor == "CO") {
			campos_base.sprintf
				(" col.colonia as claveco,col.nombre AS nomcolonia, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								INNER JOIN colonias  col ON cli.colonia=col.colonia \
								INNER JOIN sectores sxx ON col.sector=sxx.sector ";

			agrupamiento = "GROUP BY col.colonia \
							  ORDER BY col.nombre ASC";

		}
		else if (agrupadopor == "LO") {
			campos_base.sprintf
				(" lok.localidad as clavelo,lok.nombre AS nomlocalidad,if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								INNER JOIN colonias  col ON cli.colonia=col.colonia \
								INNER JOIN sectores sxx ON col.sector=sxx.sector \
								INNER JOIN localidades lok ON col.localidad=lok.localidad";

			agrupamiento = "GROUP BY lok.localidad \
							  ORDER BY lok.nombre ASC";

		}
		else if (agrupadopor == "MU") {
			campos_base.sprintf
				(" moon.municipio as clavemu,moon.nombre AS nommunicipio, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								LEFT JOIN colonias  col ON cli.colonia=col.colonia \
								LEFT JOIN sectores sxx ON col.sector=sxx.sector \
								LEFT JOIN localidades lok ON col.localidad=lok.localidad \
								LEFT JOIN municipios moon ON lok.municipio=moon.municipio";

			agrupamiento = "GROUP BY moon.municipio \
							  ORDER BY moon.nombre ASC";
		}
		else if (agrupadopor == "CA") {
			campos_base.sprintf
				(" clc.canal as claveca,clc.descripcion AS nomcanal, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								LEFT JOIN canalesclientes  clc ON cli.canal=clc.canal";

			agrupamiento = "GROUP BY clc.canal \
							  ORDER BY clc.descripcion ASC";

		}
		else if (agrupadopor == "VE") {
			campos_base.sprintf
				(" ve.empleado as claveve,CONCAT( e.nombre,' ',e.appat ,' ',  e.apmat) AS nomvendedor, IF(cli.tipoempre=0, CONCAT(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) AS nomcliente,"
				);

			join_clientes.sprintf(
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
				LEFT JOIN clientesemp cemp ON cli.cliente = cemp.cliente and cemp.idempresa=suc.idempresa \
				LEFT JOIN vendedores ve ON cemp.vendedor=ve.empleado " );

			leftjoin_empleado =
				"LEFT JOIN empleados e ON ve.empleado=e.empleado";

			agrupamiento =
				"GROUP BY e.nombre ASC , e.appat ASC ,  e.apmat  ASC  \
							  ORDER BY e.nombre ASC , e.appat ASC ,  e.apmat  ASC ";

		}
		else if (agrupadopor == "MA") {
			campos_base.sprintf
				(" mxx.marca as clavema,mxx.nombre AS nommarca, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes = " INNER JOIN clientes cli ON cli.cliente=v.cliente\
								LEFT JOIN marcas mxx ON prod.marca=mxx.marca ";

			agrupamiento = "GROUP BY mxx.marca  \
							  ORDER BY mxx.nombre ASC";

		}
		else if (agrupadopor == "CM") {
			campos_base.sprintf
				("c1.clasif1 as clavec1, c1.nombre AS nomcmaestra, IF(cli.tipoempre=0, CONCAT(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) AS nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								LEFT JOIN clasificacion1 c1 ON prod.clasif1=c1.clasif1";

			agrupamiento = "GROUP BY prod.clasif1  \
							  ORDER BY c1.nombre ASC";

		}
		else if (agrupadopor == "CG") {
			campos_base.sprintf
				(" c2.clasif2 as clavec2,c2.nombre AS nomcgeneral, IF(cli.tipoempre=0, CONCAT(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) AS nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								LEFT JOIN clasificacion2 c2 ON prod.clasif2=c2.clasif2";

			agrupamiento = "GROUP BY prod.clasif2  \
							  ORDER BY c2.nombre  ASC";

		}
		else if (agrupadopor == "CE") {
			campos_base.sprintf
				(" c3.clasif3 as clavec3,c3.nombre AS nomcespecifica, IF(cli.tipoempre=0, CONCAT(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) AS nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								LEFT JOIN clasificacion3 c3 ON prod.clasif3=c3.clasif3";

			agrupamiento = "GROUP BY prod.clasif3  \
							  ORDER BY c3.nombre ASC";

		}
		else if (agrupadopor == "CF") {
			join_clientes =
				" inner join clientes cli on cli.cliente=v.cliente ";
			agrupamiento =
				"group by prod.nombre, articulos.present, articulos.multiplo, cli.rsocial, v.referencia \
								order by prod.nombre, articulos.present, articulos.multiplo, cli.rsocial, v.referencia ";
			campos_base.sprintf(" %s v.referencia, \
							 if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as foliofisic, \
							 articulos.factor, cli.cliente,  \
							 MAX(IF(articulos.factor>1,articulos.articulo,if(articulos.factor=1,NULL,articulos.articulo ))) AS clavemax, \
							 MIN(IF(articulos.factor=1,articulos.articulo,if(articulos.factor>1,NULL,NULL ))) AS clavemin, "
				, condicion_tipo_nombre);
		}
		else if (agrupadopor == "IE") {
			join_clientes =
				" inner join clientes cli on cli.cliente=v.cliente ";
			// Desglosar para informativas (Cliente, clasif3, producto, presentacion
			join_clasificaciones.sprintf(" inner join clasificacion3 c3 on \
					prod.clasif3=c3.clasif3 ");

			agrupamiento =
				"group by cli.rsocial, c3.clasif3, prod.nombre, articulos.present  \
								order by cli.rsocial, c3.nombre, prod.nombre, articulos.present ";

			campos_base.sprintf(" %s c3.nombre as clasif3nombre, ",
				condicion_tipo_nombre);
		}
		else if (agrupadopor == "HR") {

			campos_base.sprintf
				(" hour(v.horaalta) as hora, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes = " INNER JOIN clientes cli ON cli.cliente=v.cliente";

			agrupamiento = "GROUP BY hour(v.horaalta)  \
							  ORDER BY hour(v.horaalta) ASC";

		}
		else if (agrupadopor == "DS") {

			campos_base.sprintf
				(" fds.nombre as nombredia, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente \
								left join fechasdiassemana fds on DAYOFWEEK(v.fechaalta)=fds.dia";

			agrupamiento = "GROUP BY DAYNAME(v.fechaalta)  \
							  ORDER BY fds.dia ";

		}
		else if (agrupadopor == "DM") {
			campos_base.sprintf
				(" DAYOFMONTH(v.fechaalta) AS diames, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";

			agrupamiento = "GROUP BY DAYOFMONTH(v.fechaalta)  \
							  ORDER BY DAYOFMONTH(v.fechaalta) ";

		}
		else if (agrupadopor == "FH") {
			campos_base.sprintf
				(" v.fechavta AS fechavta, if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) as nomcliente,"
				);

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";

			agrupamiento = "GROUP BY v.fechavta  \
							  ORDER BY v.fechavta ASC ";

		}
		else if (agrupadopor == "DP") {
			campos_base.sprintf(" DAYOFMONTH(v.fechaalta) AS diames,");

			join_clientes =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";

			agrupamiento =
				"GROUP BY DAYOFMONTH(v.fechaalta), pre.producto, pre.present\
							  ORDER BY DAYOFMONTH(v.fechaalta), pre.producto, pre.present ";

		}
		else if (agrupadopor == "KT") {
			campos_base.sprintf(" k.nombre as Kit,");

			join_clientes = " INNER JOIN clientes cli ON cli.cliente=v.cliente \
				INNER JOIN dventaskits dvk ON dvk.venta=dv.referencia AND dvk.articulo=dv.articulo \
				INNER JOIN kits k	ON dvk.kit=k.kit ";

			agrupamiento = "GROUP BY k.nombre ASC \
								ORDER BY k.nombre ASC ";

		}
		else if (agrupadopor == "OV") {
			campos_base.sprintf(" v.tipoorigen, tov.descripcion AS origennombre,");

			join_clientes = " INNER JOIN clientes cli ON cli.cliente=v.cliente \
				LEFT JOIN tiposorigenventas tov ON tov.tipoorigen = v.tipoorigen ";

			agrupamiento = "GROUP BY v.tipoorigen \
								ORDER BY tov.descripcion ASC ";

		}
		else if (agrupadopor == "TP") {
			campos_base.sprintf(" dv.tipoprec, tp.descripcion AS precionombre,");

			join_clientes = " INNER JOIN clientes cli ON cli.cliente=v.cliente \
				INNER JOIN tiposdeprecios tp ON tp.tipoprec = dv.tipoprec ";

			agrupamiento = "GROUP BY dv.tipoprec \
								ORDER BY dv.tipoprec ASC  ";

		}

		if (tipofacturacion != " ") {
			if (tipofacturacion.SubString(0, 1) == "'") {
				condicion_tipofac.sprintf("v.tipofac in (%s) and ",
					tipofacturacion);
			}
			else
				condicion_tipofac.sprintf("v.tipofac='%s' and ",
			tipofacturacion);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (empleado != " ") {
			condicion_empleado.sprintf("e.empleado='%s' and ", empleado);
		}

		if (tipo_impuestos != " ") {
			if (negar_impuestos == "0")
				condicion_tipo_imp.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
			else
				condicion_tipo_imp.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
		}
		if (impuesto_particular != " ") {
			if (negar_impuestos == "0")
				condicion_imp.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
			else
				condicion_imp.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
		}
		if (tipo_impuestos2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_tipo_imp2.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);
			else
				condicion_tipo_imp2.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') and ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);
		}
		if (impuesto_particular2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_imp2.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);
			else
				condicion_imp2.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s) and ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("v.acredito=%s and ", acredito);
		}
		if (terminospago != " ") {
			condicion_terminospago.sprintf
				(" AND df.formapag IN(SELECT formapag FROM formasdepago where termino = '%s') ",
				terminospago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
		}
		if (ticket != " ") {
			condicion_ticket.sprintf("v.ticket=%s and ", ticket);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("dv.almacen='%s' and ", almacen);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		else {
			if (clasif2 != " ") {
				condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			}
			else {
				if (clasif1 != " ") {
					condicion_clasif1.sprintf("prod.clasif1='%s' and ",
					clasif1);
				}
			}
		}

		if (clasifcont1 != " ") {
			condicion_clasifcont1.sprintf("prod.clasifcont='%s' and ",
				clasifcont1);
		}
		if (clasifcont2 != " ") {
			condicion_clasifcont2.sprintf("prod.clasifcont2='%s' and ",
				clasifcont2);
		}

		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("v.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("v.fechamodi>='%s' and v.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("v.fechavta>=@fechainicial and v.fechavta<=@fechafinal and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("v.fechavta>=@fechainicial and v.fechavta<=@fechafinal and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("v.fechavta>=@fechainicial and v.fechavta<=@fechafinal and ", fecha_inicial,
				fecha_final);
		}
		// parametro de vendedor
		if (vendedor != " ") {
			condicion_vendedor.sprintf("v.vendedor='%s' and ", vendedor);
		}
		// condicion de vendedor, pues con la nueva oagrupacion, ufe necesario meter esta condicion, cambia solo en un caso
		if (leftjoin_empleado.Trim().IsEmpty()) {
			leftjoin_empleado = "LEFT JOIN empleados e ON v.usualta=e.empleado";
		}
		// parametro de cfdi
		if (ClaveUnidad != " ") {
			condicionclaveunidad.sprintf
				(" articulos.idclaveunidadcfdi = '%s' AND ", ClaveUnidad);
			joinclaveunidad =
				" INNER JOIN cclaveunidad ccu ON ccu.idclaveunidad = articulos.idclaveunidadcfdi ";
		}

		if (ProdServ != " ") {
			condicionprodserv.sprintf(" ccp.cveprodserv = '%s' AND ", ProdServ);
			joinprodserv =
				" INNER JOIN cclaveprodserv ccp ON ccp.idclaveprodserv = prod.idclaveprodservcfdi ";
		}

		// Cuenta bancaria donde entra en bancos.
		if (cuentabancaria != " ") {
			join_cuentabancaria.sprintf(" INNER JOIN bancosdventas bdv ON bdv.venta=v.referencia \
			  INNER JOIN bancosventasdef bdef ON bdv.idbancosventas=bdef.idbancosventas AND bdef.cancelado=0 \
			  INNER JOIN bancosmov bm ON bm.idmovbanco=bdv.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1 AND bm.idnumcuenta=%s "
				, cuentabancaria);

			ponderacion_bancos = "(bdv.valorconsiderado/v.valor)";

		}
		else {

			ponderacion_bancos = "(1)";

		}
		// el lunes revisar xque a pesar de que esta en 1 salta la asignacion de la consulta de los campos
		// de peso y volumen
		if (!peso_y_volumen.Trim().IsEmpty()) {
			campos_peso_volumen.sprintf
				(",SUM(articulos.peso*dv.cantidad) AS peso, SUM(articulos.volumen*dv.cantidad) AS volumen "
				);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
		}

		// Usaremos el segmento de presentacion
		if (segmento != " ") {
			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);

			join_presentacion1.sprintf(" INNER JOIN presentaciones pre ON articulos.producto=pre.producto \
				AND articulos.present = pre.present \
				INNER JOIN presentacionescb pcb ON pcb.producto=pre.producto AND pcb.present = pre.present AND pcb.idemprea = suc.idempresa " );
			// 1 y 4 y 5
		}

		if (listaTags != " ") {
			// join_art_tags.sprintf(" INNER JOIN articulostagsasignados artt ON artt.producto=articulos.producto AND artt.present=articulos.present ");
			// condicion_art_tags.sprintf("  artt.idarticulotag in (%s) AND ",listaTags);
			/* condicion_art_tags.sprintf(" ('%s')  IN  (SELECT artt.idarticulotag  \
			 FROM articulostagsasignados artt WHERE artt.producto = articulos.producto  \
			 AND artt.present= articulos.present ) AND ",listaTags);
			 */
			condicion_art_tags.sprintf(" (SELECT  COUNT(*)  \
										FROM articulostagsasignados artt WHERE artt.producto = articulos.producto  \
										AND artt.present= articulos.present AND artt.idarticulotag IN (%s)) > 0  AND "
				, listaTags);

		}

		if (ordenEcommerce == "1") {
			inner_ordenEcommerce.sprintf
				(" INNER JOIN ecommerceorden eo ON eo.referencia = v.referencia"
				);
		}

		if (origenVenta != " ") {
			condicion_origenVenta.sprintf(" v.tipoorigen IN (%s) AND ",
				origenVenta);
		}

		if (formasDePago != " ") {
			condicion_formasDePago.sprintf(" df.formapag IN(%s) AND ",
				formasDePago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia %s ",
				condicion_terminospago);
			fpago_porcentaje = "*df.porcentaje ";
			fpago_porcentaje2 = fpago_porcentaje;
		}

		inner_empleadosupervisor.sprintf(" LEFT JOIN articulossupervisados ars ON ars.producto=prod.producto and ars.present=pre.present  \
									   LEFT JOIN empleados emp on emp.empleado=ars.usuario "
			);
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado "
			);

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf("  ars.usuario='%s' and  ",
				empleadosupervisor);
		}
		else {
			// inner_empleadosupervisor = "  ";
			// campo_supervisado = ", ''  AS supervisado ";
			condicion_empleadosupervisor = " ";
		}

		if (soloKits == "1") {
			join_solokits =
				" RIGHT JOIN dventaskits dvk ON dvk.venta=dv.referencia AND dvk.articulo=dv.articulo ";
		}

		if (refVnta != " ") {
			condicion_refVnta.sprintf(" v.referencia = '%s' AND ", refVnta);
		}

		if (multiplo != " ") {
			condicion_multiplo.sprintf
				(" a2.multiplo = CASE WHEN '%s' = 'MAXIMO' THEN pmm.maxmult ELSE 'UNIDAD' END AND ",
				multiplo);
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones == "1") {
			instruccion.sprintf("create temporary table dnotascredcliaux ( \
			venta char(11), \
			articulo varchar(9), \
			cantidad decimal(12,3), \
			precio decimal(16,6), \
			precioimp decimal(16,6), \
			primary key  (venta, articulo) \
			) ENGINE=InnoDB ");
			instrucciones[num_instrucciones++] = instruccion;

			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion.sprintf("insert into dnotascredcliaux \
				(venta, articulo, cantidad, precio, precioimp) \
				select v.referencia as venta, d.articulo, sum(if(n.tipo='0',d.cantidad,0) %s) as cantidad, \
				sum(if(n.tipo<>'0',d.precio,0) %s) as precio, \
				sum(if(n.tipo<>'0',d.precioimp,0) %s) as precioimp \
				from notascredcli n inner join dnotascredcli d inner join  ventas v\
					inner join  dventas dv   \
					inner join  articulos   \
					inner join  productos prod \
					inner join terminales ter on ter.terminal=v.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal = sec.sucursal \
					%s \
					%s \
					%s \
					%s \
					inner join empleados e on e.empleado=v.usualta \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				n.venta=v.referencia and n.cancelado=0 and \
				n.referencia=d.referencia and n.fechanot<='%s' and \
				dv.referencia=v.referencia and dv.articulo=d.articulo and \
				d.articulo=articulos.articulo and articulos.producto=prod.producto \
				group by v.referencia, d.articulo",fpago_porcentaje2,fpago_porcentaje2,fpago_porcentaje2,
				join_presentacion1, join_clientes,
				inner_join_formasDePago, inner_join_terminoPago,
				condicion_acredito, condicion_ticket, condicion_empresa, condicion_sucursal,
				condicion_almacen, condicion_producto, condicion_marca,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_clasifcont1, condicion_clasifcont2,
				condicion_canceladas, fechas_canceladas, condicion_articulo,
				condicion_tipofac, condicion_clientes_partesrel,
				condicion_cliente, condicion_empleado, condicion_vendedor,
				condicion_fabricante, condicion_segmento, condicion_origenVenta,
				condicion_formasDePago, fecha_limite_devoluciones);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredcliaux dn on \
				dn.articulo=dv.articulo and dn.venta=v.referencia ");

			// cantmayor,cantunidad,multmayor,multunidad
			campos_base += "sum(((dv.cantidad-ifnull(dn.cantidad,0)))" +
				fpago_porcentaje + ") as cantxart, a2.articulo, \
				articulos.multiplo, prod.nombre as nomproducto, articulos.producto,articulos.present, v.fechavta, \
				a2.ean13 AS codbarMay, a1.ean13 AS codbarMin, \
				truncate(sum((dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor"
				+ fpago_porcentaje + ")/pmm.maxfactor,0) as cantmayor,  \
				mod(sum((dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor" +
				fpago_porcentaje2 + " ), pmm.maxfactor) as cantunidad, \
				sum((dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor " +
				fpago_porcentaje2 + ") as unidades,  \
				pmm.maxmult, pmm.minmult, pmm.maxfactor, \
				sum(@suma:=((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))"
				+ fpago_porcentaje + ") as suma, \
				sum(@descuento:=(((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(dv.porcdesc/100)"
				+ fpago_porcentaje + ")) as descuento, \
				sum(@subtotal:=(((dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)))*(1-dv.porcdesc/100))"
				+ fpago_porcentaje +
				") as subtotal, \
				max((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100)) as costunit, \
				max((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100)) as costunitimp, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}
		else {
			if (cuentabancaria != " ") {
				campos_base_aux.sprintf("sum(dv.cantidad%s) as cantxart, a2.articulo, \
					articulos.multiplo, prod.nombre as nomproducto, articulos.producto, articulos.present, v.fechavta,\
					a2.ean13 AS codbarMay, a1.ean13 AS codbarMin, \
					truncate(sum(dv.cantidad*articulos.factor%s)/pmm.maxfactor,0) as cantmayor, \
					mod(sum(dv.cantidad*articulos.factor%s), pmm.maxfactor) as cantunidad, \
					sum(dv.cantidad*articulos.factor %s) as unidades,  \
					pmm.maxmult, pmm.minmult, pmm.maxfactor, \
					sum(@suma:=((dv.precio*%s)*dv.cantidad)%s) as suma, \
					sum(@descuento:=((dv.precio*%s)*dv.cantidad*(dv.porcdesc/100))%s) as descuento, \
					sum(@subtotal:=((dv.precio*%s)*dv.cantidad*(1-dv.porcdesc/100))%s) as subtotal, \
					max((dv.precio*%s)*(1-dv.porcdesc/100)) as costunit, \
					max((dv.precio*%s)*(1-dv.porcdesc/100)) as costunitimp, \
					sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
					  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
					sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
					  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
					sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
					  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
					sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
					  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
					sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
					sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
					sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
					sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, "
					, fpago_porcentaje, fpago_porcentaje, fpago_porcentaje2,
					fpago_porcentaje2, ponderacion_bancos, fpago_porcentaje,
					ponderacion_bancos, fpago_porcentaje, ponderacion_bancos,
					fpago_porcentaje, ponderacion_bancos, ponderacion_bancos);

			}
			else {
				campos_base_aux.sprintf("sum(dv.cantidad%s) as cantxart, a2.articulo, \
					articulos.multiplo, prod.nombre as nomproducto, articulos.producto, articulos.present, v.fechavta,\
					a2.ean13 AS codbarMay, a1.ean13 AS codbarMin, \
					truncate(sum(dv.cantidad*articulos.factor%s)/pmm.maxfactor,0) as cantmayor, \
					mod(sum(dv.cantidad*articulos.factor%s), pmm.maxfactor) as cantunidad, \
					sum(dv.cantidad*articulos.factor %s) as unidades, \
					pmm.maxmult, pmm.minmult, pmm.maxfactor, \
					sum(@suma:=(dv.precio*dv.cantidad)%s) as suma, \
					sum(@descuento:=(dv.precio*dv.cantidad*(dv.porcdesc/100))%s) as descuento, \
					sum(@subtotal:=(dv.precio*dv.cantidad*(1-dv.porcdesc/100))%s) as subtotal, \
					max(dv.precio*(1-dv.porcdesc/100)) as costunit, \
					max(dv.precio*(1-dv.porcdesc/100)) as costunitimp, \
					sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
					  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
					sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
					  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
					sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
					  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
					sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
					  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
					sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
					sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
					sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
					sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, "
					, fpago_porcentaje, fpago_porcentaje, fpago_porcentaje2,
					fpago_porcentaje2, fpago_porcentaje, fpago_porcentaje,
					fpago_porcentaje);
			}

			campos_base += campos_base_aux;
		}

		AnsiString onEmpresa = " ";
		if(empresa != " ")
			onEmpresa.sprintf(" AND pcb.idempresa=%s ", empresa);

		consulta.sprintf("select \
			%s \
			%s \
			%s \
			%s \
			,COUNT(v.referencia) as apariciones \
			from ventas v %s \
			inner join dventas dv \
			inner join articulos ON dv.articulo=articulos.articulo \
			inner join productos prod ON articulos.producto=prod.producto \
			INNER JOIN presentaciones pre ON articulos.producto=pre.producto AND articulos.present = pre.present \
			INNER JOIN presentacionescb pcb ON pcb.producto=pre.producto AND pcb.present = pre.present %s \
			INNER JOIN presentacionesminmax pmm ON pre.producto=pmm.producto AND pre.present = pmm.present \
			%s %s %s  \
			inner join terminales ter on ter.terminal=v.terminal \
			inner join secciones sec on ter.seccion=sec.seccion \
			inner join sucursales suc on suc.sucursal = sec.sucursal AND suc.idempresa = pcb.idempresa \
			%s \
			%s \
			%s \
			%s \
			%s \
			left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
			left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
			left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
			left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
			left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 \
			left join articulos a1 on a1.producto=prod.producto and a1.present=pre.present \
			AND  a1.multiplo=pmm.minmult \
			left join articulos a2 on a2.producto=prod.producto and a2.present=pre.present \
			AND a2.multiplo=pmm.maxmult \
			%s \
			%s \
			%s \
			%s \
			%s \
			where  %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			v.referencia=dv.referencia \
			%s ", campos_base, campos_val_impuestos, campos_peso_volumen,
			campo_supervisado, forzar_indice_vta, onEmpresa, joinclaveunidad, joinprodserv,  inner_ordenEcommerce, join_clientes,
			join_clasificaciones, inner_join_formasDePago, leftjoin_empleado, inner_join_terminoPago, join_devoluciones, join_cuentabancaria, join_art_tags,
			inner_empleadosupervisor, join_solokits, condicion_empresa, condicion_sucursal, condicion_acredito, condicion_ticket,
			condicion_almacen, condicion_producto, condicion_marca,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_clasifcont1, condicion_clasifcont2, condicion_canceladas,
			fechas_canceladas, condicion_imp, condicion_tipo_imp,
			condicion_imp2, condicion_tipo_imp2, condicion_tipofac,
			condicion_clientes_partesrel, condicion_cliente, condicion_empleado,
			condicion_articulo, condicion_vendedor, condicionclaveunidad,
			condicionprodserv, condicion_gironegocio, condicion_canal,
			condicion_tipoprecio, condicion_fabricante, condicion_segmento,
			condicion_art_tags, condicion_empleadosupervisor,
			condicion_origenVenta, condicion_formasDePago, condicion_refVnta,
			condicion_multiplo, agrupamiento);

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPVENTAS_X_CLIENTE,
void ServidorReportes::EjecutaRepVentasXCliente(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, almacen, producto;
	AnsiString clasif1, clasif2, clasif3, clasifcont, clasifcont2;
	AnsiString condicion_acredito = " ", condicion_almacen = " ",
		condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_clasifcont = " ", condicion_clasifcont2 = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", campos_base = " ";
	AnsiString desglosar_clientes;
	AnsiString condicion_canceladas = " ", canceladas, tipo_canceladas,
		fechas_canceladas = " ";
	AnsiString tipo_impuestos, impuesto_particular, condicion_tipo_imp = " ",
		condicion_imp = " ";
	AnsiString tipofacturacion, cliente, condicion_tipofac = " ",
		condicion_cliente = " ";
	AnsiString agrupamiento, tipo_nombre, condicion_tipo_nombre = " ";
	AnsiString limite_ventas = " ";
    AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString cad_suma_impuesto2 = "", campos_suma_impuestos2 = "";
	AnsiString giro, canal;
	AnsiString condicion_gironegocio = " ", condicion_canal = " ";
	AnsiString join_clientes = " ";
	AnsiString vendedor, condicion_vendedor = " ", join_vendedor = " ";
	AnsiString fpago_porcentaje2 = " ";

	AnsiString origenVenta;
	AnsiString condicion_origenVenta = " ";
	AnsiString formasDePago, fpago_porcentaje = " ";
	AnsiString inner_join_formasDePago = " ", condicion_formasDePago = " ";

	AnsiString soloKits = "0", join_solokits = " ";
	AnsiString marca, fabricante, condicion_fabricante = " ",
		condicion_marca = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		limite_ventas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
		giro = mFg.ExtraeStringDeBuffer(&parametros);
		canal = mFg.ExtraeStringDeBuffer(&parametros);
		origenVenta = mFg.ExtraeStringDeBuffer(&parametros);
		formasDePago = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		soloKits = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			cad_suma_impuesto2.sprintf("impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			campos_suma_impuestos2 += cad_suma_impuesto2;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
			{ // A todos menos al ultimo impuesto le signo +.
				campos_suma_impuestos += "+";
				campos_suma_impuestos2 += "+";
			}
		}

		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("suc.sucursal='%s' and ", sucursal);
		}
		if (tipo_nombre == "1") {
			condicion_tipo_nombre =
				"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
		}
		else {
			condicion_tipo_nombre = "cli.rsocial";
		}

		if (limite_ventas == "0.00") {
			agrupamiento = "group by cli.cliente \
						order by nomcliente ";
		}
		else {
			agrupamiento.sprintf("group by cli.cliente having \
					(subgrabado+subnograbado+%s)>=%s \
					order by nomcliente ", campos_suma_impuestos2,
			limite_ventas);
		}

		campos_base.sprintf(" %s as nomcliente, cli.rfc, cli.calle, v.referencia, \
					  v.foliofisic, articulos.factor, col.nombre as nomcolonia, \
					  cli.curp, loc.nombre as nomloc, mun.nombre as nommunicipio, \
					  est.nombre as nomestado, cli.cp, ",
			condicion_tipo_nombre);

		if (tipofacturacion != " ") {
			condicion_tipofac.sprintf("v.tipofac='%s' and ", tipofacturacion);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (tipo_impuestos != " ") {
			condicion_tipo_imp.sprintf
				("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
		}
		if (impuesto_particular != " ") {
			condicion_imp.sprintf
				("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("v.acredito=%s and ", acredito);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("dv.almacen='%s' and ", almacen);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		else {
			if (clasif2 != " ") {
				condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			}
			else {
				if (clasif1 != " ") {
					condicion_clasif1.sprintf("prod.clasif1='%s' and ",
					clasif1);
				}
			}
		}

		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}
		if (clasifcont != " ") {
			condicion_clasifcont.sprintf("prod.clasifcont='%s' and ",
			clasifcont);
		}
		if (clasifcont2 != " ") {
			condicion_clasifcont2.sprintf("prod.clasifcont2='%s' and ",
				clasifcont2);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("v.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("v.fechamodi>='%s' and v.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("v.fechavta>='%s' and v.fechavta<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("v.fechavta>='%s' and v.fechavta<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("v.fechavta>='%s' and v.fechavta<='%s' and ", fecha_inicial,
				fecha_final);
		}
		// condicion giro negocio
		if (giro != " ") {
			condicion_gironegocio.sprintf("cli.giro='%s' and ", giro);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}

		// condicion canales
		if (canal != " ") {
			condicion_canal.sprintf("cli.canal='%s' and ", canal);
			if (join_clientes == " ")
				join_clientes =
					" inner join clientes cli on cli.cliente=v.cliente ";
		}
		// condicion vendedor
		if (vendedor != " ") {
			condicion_vendedor.sprintf("v.vendedor='%s' and ", vendedor);
			join_vendedor.sprintf("INNER JOIN 	vendedores ");
		}

		if (origenVenta != " ") {
			condicion_origenVenta.sprintf(" v.tipoorigen IN(%s) AND ",
				origenVenta);
		}

		if (formasDePago != " ") {
			condicion_formasDePago.sprintf(" df.formapag IN(%s) AND ",
				formasDePago);
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago df ON df.referencia = v.referencia "
				);
			fpago_porcentaje = "*df.porcentaje";
			fpago_porcentaje2 = fpago_porcentaje;
		}

		// condicion kits de venta
		if (soloKits == "1") {
			join_solokits =
				" RIGHT JOIN dventaskits dvtk ON dvtk.venta=dv.referencia AND dvtk.articulo=dv.articulo ";
		}

		// marca
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}
		// fabricante
		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones == "1") {
			instruccion.sprintf("create temporary table dnotascredcliaux ( \
			venta char(11), \
			articulo varchar(9), \
			cantidad decimal(12,3), \
			precio decimal(16,6), \
			precioimp decimal(16,6), \
			primary key  (venta, articulo) \
			) ENGINE=InnoDB ");
			instrucciones[num_instrucciones++] = instruccion;

			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion.sprintf("insert into dnotascredcliaux \
				(venta, articulo, cantidad, precio, precioimp) \
				select v.referencia as venta, d.articulo, sum(if(n.tipo='0',d.cantidad,0) %s) as cantidad, \
				sum(if(n.tipo<>'0',d.precio,0) %s) as precio, \
				sum(if(n.tipo<>'0',d.precioimp,0) %s) as precioimp \
				from notascredcli n inner join dnotascredcli d inner join ventas v force index(fechavta) \
					inner join dventas dv inner join articulos inner join productos prod \
					inner join terminales ter on ter.terminal=v.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal = sec.sucursal \
					%s %s\
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				n.venta=v.referencia and n.cancelado=0 and \
				n.referencia=d.referencia and n.fechanot<='%s' and \
				dv.referencia=v.referencia and dv.articulo=d.articulo and \
				d.articulo=articulos.articulo and articulos.producto=prod.producto \
				group by v.referencia, d.articulo",
                fpago_porcentaje2, fpago_porcentaje2, fpago_porcentaje2,
				join_clientes, inner_join_formasDePago, condicion_empresa,
				condicion_sucursal, condicion_acredito, condicion_almacen,
				condicion_producto, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_clasifcont, condicion_clasifcont2,
				condicion_canceladas, fechas_canceladas, condicion_tipofac,
				condicion_cliente, condicion_gironegocio, condicion_canal,
				condicion_origenVenta, condicion_vendedor,
				fecha_limite_devoluciones);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredcliaux dn on \
				dn.articulo=dv.articulo and dn.venta=v.referencia ");

			campos_base +=
				"sum(((dv.cantidad-ifnull(dn.cantidad,0)))" +
				fpago_porcentaje + ") as cantxart, articulos.articulo, \
				articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
				sum((@unidades:=(dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor)" +
				fpago_porcentaje + ") as unidades, \
				sum(@suma:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))" +
				fpago_porcentaje + ") as suma, \
				sum((@descuento:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(dv.porcdesc/100))" +
				fpago_porcentaje + ") as descuento, \
				sum((@subtotal:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1-dv.porcdesc/100))" +
				fpago_porcentaje + ") as subtotal, \
				max(((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100)" +
				fpago_porcentaje + ")) as costunit, \
				max(((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100))" +
				fpago_porcentaje + ") as costunitimp, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}
		else {
			campos_base +=
				"sum(dv.cantidad" +
				fpago_porcentaje + ") as cantxart, articulos.articulo, \
				articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
				sum((@unidades:=dv.cantidad*articulos.factor)) as unidades, \
				sum(@suma:=(dv.precio*dv.cantidad" + fpago_porcentaje + ")) as suma, \
				sum(@descuento:=(dv.precio*dv.cantidad*(dv.porcdesc/100)" + fpago_porcentaje + ")) as descuento, \
				sum(@subtotal:=(dv.precio*dv.cantidad*(1-dv.porcdesc/100)" + fpago_porcentaje + ")) as subtotal, \
				max(dv.precio*(1-dv.porcdesc/100)) as costunit, \
				max(dv.precio*(1-dv.porcdesc/100)) as costunitimp, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}

		consulta.sprintf("select \
			%s \
			%s \
			,SUM(articulos.peso*dv.cantidad ) as peso, SUM(articulos.volumen*dv.cantidad) as volumen, cli.cliente \
			from ventas v force index(fechavta)  inner join  dventas dv  inner join  articulos  inner join  productos prod  inner join  \
				clientes cli  inner join  colonias col  inner join  localidades loc  inner join  municipios mun  inner join  estados est \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal = sec.sucursal \
                %s \
				left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 \
			%s \
			%s \
			where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s\
            %s %s\
			v.referencia=dv.referencia and \
			v.cliente=cli.cliente and \
			cli.colonia=col.colonia and \
			col.localidad=loc.localidad and \
			loc.municipio=mun.municipio and \
			mun.estado=est.estado and \
			dv.articulo=articulos.articulo and \
			articulos.producto=prod.producto \
			%s ", campos_base, campos_val_impuestos, inner_join_formasDePago,
			join_devoluciones, join_solokits, condicion_empresa, condicion_sucursal,
			condicion_acredito, condicion_almacen, condicion_producto,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_clasifcont, condicion_clasifcont2, condicion_canceladas,
			fechas_canceladas, condicion_imp, condicion_tipo_imp,
			condicion_tipofac, condicion_cliente, condicion_gironegocio,
			condicion_canal, condicion_origenVenta, condicion_vendedor,
			condicion_formasDePago, condicion_marca, condicion_fabricante,
			agrupamiento);

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOMPRAS_X_ARTICULO
void ServidorReportes::EjecutaRepComprasXArticulo(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, proveedor, almacen,
		producto, marca;
	AnsiString clasif1, clasif2, clasif3, clasifcont1, clasifcont2;
	AnsiString desglosar_modo, ConsultaFechaAlta;
	AnsiString condicion_acredito = " ", condicion_proveedor = " ",
		condicion_almacen = " ", condicion_producto = " ",
		condicion_marca = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_clasifcont1 = " ", condicion_clasifcont2 = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", join_clasificaciones = " ", campos_base = " ";
	AnsiString tipo_impuestos, condicion_tipo_imp = " ", impuesto_particular,
		condicion_imp = " ";
	AnsiString articulo, agrupamiento, fechas_delimitadas;
	AnsiString condicion_articulo_compras = " ", condicion_articulo_dev = " ";
	AnsiString sucursal, condicion_sucursal = " ", empresa, condicion_empresa = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString prov_partesrel, condicion_prov_partesrel = " ";
	AnsiString almacen_configarticulo, join_almacen_configarticulo = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6;
	AnsiString fabricante, condicion_fabricante = " ";
	AnsiString segmento, condicion_segmento = " ";

	AnsiString join_presentacion1 = " ";

	AnsiString comprador, condicion_comprador = " ";
	AnsiString supervisado, empleadosupervisor, campo_supervisado = " ";
	AnsiString condicion_supervisado = " ";
	AnsiString join_supervisado = " ";
    AnsiString com_referencia, consulta_com_referencia = " ";
	AnsiString tipo_impuestos2, impuesto_particular2, negar_impuestos2,
		condicion_tipo_imp2 = " ", condicion_imp2 = " ", negar_impuestos;

	try {
		fecha_inicial =	mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		articulo = mFg.ExtraeStringDeBuffer(&parametros);
		desglosar_modo = mFg.ExtraeStringDeBuffer(&parametros);
		prov_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		almacen_configarticulo = mFg.ExtraeStringDeBuffer(&parametros);
		ConsultaFechaAlta = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		comprador = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);
		com_referencia = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 when i5.orden=%s then @impuesto5 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}

		if (sucursal != " " && sucursal != "' '") {
			condicion_sucursal.sprintf("suc.sucursal IN (%s) and ", sucursal);
		}

		if (desglosar_modo == "1") {
			// Desglozar por proveedor y factura
			agrupamiento =
				"group by prod.nombre, articulos.present, articulos.multiplo, prov.razonsocial, c.referencia \
							order by prod.nombre, articulos.present, articulos.multiplo, prov.razonsocial, c.referencia ";
			campos_base +=
				"prov.razonsocial as nomproveedor, c.referencia, c.fechacom, c.folioprov, articulos.factor, ";
		}
		if (desglosar_modo == "0") {
			// Desglosar por articulo
			agrupamiento =
				"group by prod.nombre, articulos.present, articulos.multiplo \
							order by prod.nombre, articulos.present, articulos.multiplo ";
			if (articulo != " ") {
				campos_base +=
					"prov.razonsocial as nomproveedor, c.referencia, c.folioprov, c.fechacom, ";
				condicion_articulo_compras.sprintf("dc.articulo='%s' and ",
					articulo);
				condicion_articulo_dev.sprintf("d.articulo='%s' and ",
					articulo);
				agrupamiento =
					"group by c.referencia, prod.nombre, articulos.present, articulos.multiplo \
							order by c.referencia, prod.nombre, articulos.present, articulos.multiplo";
			}
		}
		if (desglosar_modo == "2") {

			// Desglosar para informativas (Proveedor, clasif3, producto, presentacion
			join_clasificaciones.sprintf(" inner join clasificacion3 c3 on \
				prod.clasif3=c3.clasif3 ");

			agrupamiento =
				"group by prov.razonsocial, c3.clasif3, prod.nombre, articulos.present  \
							order by prov.razonsocial, c3.nombre, prod.nombre, articulos.present ";

			campos_base +=
				"prov.razonsocial as nomproveedor, c3.nombre as clasif3nombre, ";
		}

		if (tipo_impuestos != " ") {
			if (negar_impuestos == "0") {
				condicion_tipo_imp.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s' or i5.tipoimpu='%s') and ",
					tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
			} else {
                condicion_tipo_imp.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s' and IFNULL(i5.tipoimpu,'')<>'%s') and ",
					tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
            }
		}
		if (impuesto_particular != " ") {
			if (negar_impuestos == "0") {
                condicion_imp.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s or i5.impuesto=%s) and ",
					impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular);
			} else {
                condicion_imp.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and  IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s and IFNULL(i5.impuesto,'')<>%s) and ",
					impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular);
            }
		}

		if (tipo_impuestos2 != " ") {
			if (negar_impuestos2 == "0") {
				condicion_tipo_imp2.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s' or i5.tipoimpu='%s') and ",
					tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2);
			} else {
				condicion_tipo_imp2.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s' and IFNULL(i5.tipoimpu,'')<>'%s') and ",
					tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2);
            }
		}
		if (impuesto_particular2 != " ") {
			if (negar_impuestos2 == "0") {
				condicion_imp2.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s or i5.impuesto=%s) and ",
					impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2);
			} else {
                condicion_imp2.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and  IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s and IFNULL(i5.impuesto,'')<>%s) and ",
					impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2);
            }
		}

		if (acredito != " ") {
			condicion_acredito.sprintf("c.acredito=%s and ", acredito);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("c.almacen='%s' and ", almacen);
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}

		if (clasifcont1 != " ") {
			condicion_clasifcont1.sprintf("prod.clasifcont='%s' and ",
				clasifcont1);
		}
		if (clasifcont2 != " ") {
			condicion_clasifcont2.sprintf("prod.clasifcont2='%s' and ",
				clasifcont2);
		}

		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}

		if (prov_partesrel != " ") {
			condicion_prov_partesrel.sprintf("prov.esparterelac=%s and ",
				prov_partesrel);
		}

		if (almacen_configarticulo != " ") {
			join_almacen_configarticulo.sprintf
				("INNER JOIN articuloxseccion axs ON axs.articulo=dc.articulo AND sec.seccion=axs.seccion AND axs.almacen='%s'",
				almacen_configarticulo);
		}

		if (ConsultaFechaAlta == "1") {
			fechas_delimitadas.sprintf
				("c.fechaalta>='%s' and c.fechaalta<='%s' and ", fecha_inicial,
				fecha_final);
		}
		else {
			fechas_delimitadas.sprintf
				("c.fechacom>='%s' and c.fechacom<='%s' and ", fecha_inicial,
				fecha_final);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
		}

		// Usaremos el segmento de presentacion
		if (segmento != " ") {
			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);
			join_presentacion1 =
				"  INNER JOIN presentaciones pre ON articulos.producto=pre.producto AND articulos.present = pre.present \
				   INNER JOIN presentacionescb pcb ON pcb.producto=pre.producto AND pcb.present = pre.present AND pcb.idempresa=suc.idempresa";
			// 1 y 4 y 5

		}

		if (comprador != " ") {
			condicion_comprador.sprintf("c.comprador='%s' AND ", comprador);
		}

		join_supervisado =
			" LEFT JOIN articulossupervisados arts ON arts.producto = articulos.producto AND arts.present = articulos.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado =
			", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado ";

		if (empleadosupervisor != " ") {
			condicion_supervisado.sprintf(" arts.usuario='%s' AND ",
				empleadosupervisor);
		}
		else {
			// campo_supervisado = " , ' ' AS supervisado";
			condicion_supervisado = " ";
			// join_supervisado = " ";
		}

		if (com_referencia == " ") {
			consulta_com_referencia.sprintf(" ");
		}
		else {
			consulta_com_referencia.sprintf(" c.referencia = '%s' and",
				com_referencia);
		}

		instruccion =
			"SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		///////////////////////     auximpuestos1  ///////////////////////////////////
		instruccion.sprintf("create temporary table auximpuestos1 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
			t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'"
			, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos1 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		///////////////////////     auximpuestos2  ///////////////////////////////////
		instruccion.sprintf("create temporary table auximpuestos2 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
			t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'"
			, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos2 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		///////////////////////     auximpuestos3  ///////////////////////////////////
		instruccion.sprintf("create temporary table auximpuestos3 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
			t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'"
			, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos3 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		///////////////////////     auximpuestos4  ///////////////////////////////////
		instruccion.sprintf("create temporary table auximpuestos4 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
			t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'"
			, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos4 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

		///////////////////////     auximpuestos5  ///////////////////////////////////
		instruccion.sprintf("create temporary table auximpuestos5 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
			t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'"
			, archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos5 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones == "1") {
			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion.sprintf("CREATE TEMPORARY TABLE dnotascredprovaux (compra varchar(11), articulo varchar(9) ,    \
																		   cantidad decimal(16,3), costo decimal(20,6), \
																		   costoimp decimal(20,6) ,index(compra), 		\
																		   index(articulo) ) ENGINE=InnoDB  "
				);
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("select c.referencia as compra, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
				sum(if(n.tipo<>'0',d.costo,0)) as costo, \
				sum(if(n.tipo<>'0',d.costoimp,0)) as costoimp \
				from notascredprov n inner join  dnotascredprov d inner join  compras c inner join  articulos inner join  productos prod \
					inner join terminales ter on ter.terminal=c.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal = sec.sucursal \
					inner join proveedores prov on prov.proveedor=c.proveedor \
					%s %s \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				n.compra=c.referencia and n.cancelado=0 and c.cancelado=0 and \
				n.referencia=d.referencia and n.fechanot<='%s' and \
				d.articulo=articulos.articulo and articulos.producto=prod.producto \
				group by c.referencia, d.articulo INTO OUTFILE '%s' ",
				join_presentacion1, join_almacen_configarticulo, condicion_acredito,
				condicion_empresa, condicion_sucursal, condicion_articulo_dev, condicion_proveedor,
				condicion_prov_partesrel, condicion_almacen, condicion_producto,
				condicion_marca, fechas_delimitadas, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_clasifcont1,
				condicion_clasifcont2, condicion_fabricante, condicion_segmento,
				condicion_comprador, fecha_limite_devoluciones, archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE dnotascredprovaux (compra, articulo, cantidad, costo, costoimp) ",
				archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredprovaux dn on \
				dn.articulo=dc.articulo and dn.compra=c.referencia ");

			campos_base +=
				"sum((dc.cantidad-ifnull(dn.cantidad,0))) as cantxart, articulos.articulo, \
				articulos.multiplo, articulos.factor, prod.nombre as nomproducto, articulos.present, \
				articulos.ean13  AS codbarMay, prod.producto as producto, \
				sum(@unidades:=(dc.cantidad-ifnull(dn.cantidad,0))*articulos.factor) as unidades, \
				sum(@suma:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) as suma, \
				sum(@descuento:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(c.descuento/100)) as descuento, \
				sum(@subtotal:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)) as subtotal, \
				max((dc.costo-ifnull(dn.costo,0))*(1-c.descuento/100)) as costunit, \
				max((dc.costoimp-ifnull(dn.costoimp,0))*(1-c.descuento/100)) as costunitimp, \
				sum(@iepscuota:=(dc.cantidad-ifnull(dn.cantidad,0))*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*(1-c.descuento/100)*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}
		else {

			campos_base +=
				"sum(dc.cantidad) as cantxart, articulos.articulo, \
				articulos.multiplo, articulos.factor, prod.nombre as nomproducto, articulos.present, \
				articulos.ean13  AS codbarMay, prod.producto as producto, \
				sum(@unidades:=dc.cantidad*articulos.factor) as unidades, \
				sum(@suma:=dc.costo*dc.cantidad) as suma, \
				sum(@descuento:=dc.costo*dc.cantidad*(c.descuento/100)) as descuento, \
				sum(@subtotal:=dc.costo*dc.cantidad*(1-c.descuento/100)) as subtotal, \
				max(dc.costo*(1-c.descuento/100)) as costunit, \
				max(dc.costoimp*(1-c.descuento/100)) as costunitimp, \
				sum(@iepscuota:=dc.cantidad*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";

		}

		consulta.sprintf("select \
			%s \
			%s \
			%s \
			from compras c  inner join  dcompras dc  inner join  articulos  inner join  productos prod   inner join  proveedores prov \
				inner join terminales ter on ter.terminal=c.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
                inner join sucursales suc on suc.sucursal = sec.sucursal \
				%s %s \
				%s \
				left join auximpuestos1 i1 on i1.impuesto=dc.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dc.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dc.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dc.claveimp4 \
				left join auximpuestos5 i5 on i5.impuesto=c.impuestoret \
				%s \
				%s \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			c.referencia=dc.referencia and c.cancelado=0 and \
			c.proveedor=prov.proveedor and \
			dc.articulo=articulos.articulo and \
			articulos.producto=prod.producto \
			%s ", campos_base, campos_val_impuestos, campo_supervisado,
			join_presentacion1, join_clasificaciones, join_devoluciones,
			join_almacen_configarticulo, join_supervisado, condicion_empresa, condicion_sucursal,
			condicion_acredito, condicion_proveedor, condicion_prov_partesrel,
			condicion_almacen, condicion_producto, condicion_marca,
			fechas_delimitadas, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_clasifcont1, condicion_clasifcont2,
			condicion_tipo_imp, condicion_imp, condicion_tipo_imp2, condicion_imp2,
			condicion_articulo_compras, condicion_fabricante, condicion_segmento,
			condicion_comprador, condicion_supervisado, consulta_com_referencia,
			agrupamiento);   //24, 25

		instruccion =
			"SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		if (desglosar_modo == "1") {
			// Desglozar por proveedor y factura ocupa más memoria.
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_COSTOS);
		}
		else {
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
		}
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			if (incluir_devoluciones == "1")
				mServidorVioleta->BorraArchivoTemp(archivo_temp5);

			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "drop temporary table if exists auximpuestos";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "drop temporary table if exists auximpuestos1";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "drop temporary table if exists auximpuestos2";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "drop temporary table if exists auximpuestos3";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "drop temporary table if exists auximpuestos4";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			instruccion = "drop temporary table if exists auximpuestos5";
			mServidorVioleta->EjecutaAccionSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOMPRAS_X_PROVEEDOR
void ServidorReportes::EjecutaRepComprasXProveedor(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, proveedor, almacen,
		producto;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString desglosar_proveedores;
	AnsiString condicion_acredito = " ", condicion_proveedor = " ",
		condicion_almacen = " ", condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString incluir_devoluciones, fecha_limite_devoluciones,
		join_devoluciones = " ", campos_base = " ";
	AnsiString tipo_impuestos, condicion_tipo_imp = " ", impuesto_particular,
		condicion_imp = " ";
	AnsiString articulo, condicion_articulo = " ", agrupamiento,
		fechas_delimitadas;
	AnsiString limite_compras = " ";
    AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString cad_suma_impuesto2 = "", campos_suma_impuestos2 = "";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6;
	AnsiString clasicont1, clasicont2;
	AnsiString condicion_clasicont1 = " ", condicion_clasicont2 = " ";
	AnsiString comprador, condicion_comprador = " ";
	AnsiString supervisado, empleadosupervisor, campo_supervisado = " ";
	AnsiString condicion_supervisado = " ";
	AnsiString join_supervisado = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		limite_compras = mFg.ExtraeStringDeBuffer(&parametros);
		clasicont1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasicont2 = mFg.ExtraeStringDeBuffer(&parametros);
		comprador = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 when i5.orden=%s then @impuesto5 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			cad_suma_impuesto2.sprintf("impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			campos_suma_impuestos2 += cad_suma_impuesto2;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
			{ // A todos menos al ultimo impuesto le signo +.
				campos_suma_impuestos += "+";
				campos_suma_impuestos2 += "+";
			}
		}

		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("suc.sucursal='%s' and ", sucursal);
		}
		if (limite_compras == "0.00") {
			agrupamiento = "group by prov.proveedor \
						order by prov.razonsocial ";
		}
		else {
			agrupamiento.sprintf("group by prov.proveedor having \
						(subgrabado+subnograbado+%s)>=%s \
						order by prov.razonsocial ", campos_suma_impuestos2,
				limite_compras);
		}

		campos_base += "prov.proveedor, prov.razonsocial as nomproveedor, prov.rfc, prov.curp, prov.calle, \
					  prov.colonia as nomcolonia, prov.localidad as nommunicipio, prov.estado as nomestado, \
					  prov.pais, prov.cp, telprov.tel, ";

		if (tipo_impuestos != " ") {
			condicion_tipo_imp.sprintf
				("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s' or i5.tipoimpu='%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos,
				tipo_impuestos);
		}
		if (impuesto_particular != " ") {
			condicion_imp.sprintf
				("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s or i5.impuesto=%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular, impuesto_particular);
		}
		if (acredito != " ") {
			condicion_acredito.sprintf("c.acredito=%s and ", acredito);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("c.almacen='%s' and ", almacen);
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}

		fechas_delimitadas.sprintf("c.fechacom>='%s' and c.fechacom<='%s' and ",
			fecha_inicial, fecha_final);

		if (clasicont1 != " ") {
			condicion_clasicont1.sprintf("prod.clasifcont='%s' and ",
			clasicont1);
		}
		if (clasicont2 != " ") {
			condicion_clasicont2.sprintf("prod.clasifcont2='%s' and ",
				clasicont2);
		}

		if (comprador != " ") {
			condicion_comprador.sprintf("c.comprador='%s' AND ", comprador);
		}

		join_supervisado =
			" LEFT JOIN articulossupervisados arts ON arts.producto = articulos.producto AND arts.present = articulos.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado"
			);

		if (empleadosupervisor != " ") {
			condicion_supervisado.sprintf("   arts.usuario='%s' AND",
				empleadosupervisor);
		}
		else {
			condicion_supervisado = " ";
		}

		instruccion =
			"SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		//////////////////////      auximpuestos1       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos1 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos1 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos2       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos2 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos2 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos3       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos3 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos3 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos4       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos4 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos4 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////      auximpuestos5       //////////////////////
		instruccion.sprintf("create temporary table auximpuestos5 ( \
			orden int(2), impuesto int(2), tipoimpu char(10), \
			porcentaje decimal(5,2), nombre varchar(40), \
			primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
			);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden, i.impuesto as impuesto, \
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, t.nombre as nombre \
			from impuestos i, tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto INTO OUTFILE '%s'  "
			, archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auximpuestos5 (orden, impuesto, tipoimpu, porcentaje, nombre) ",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;
		//////////////////////////////////////////////////////////////////////

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones == "1") {
			// Suma las notas de crédito y deja el resultado en una tabla temporal,
			// para luego hacerle un left join con las compras.
			instruccion = "CREATE TEMPORARY TABLE  dnotascredprovaux (         \
						  compra varchar(11) ,                               \
						  articulo varchar(9) ,                              \
						  cantidad decimal(34,3) ,                           \
						  costo decimal(38,6) ,                              \
						  costoimp decimal(38,6) ,                           \
						  INDEX(compra),INDEX(articulo)) ENGINE=InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("Select c.referencia as compra, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
				sum(if(n.tipo<>'0',d.costo,0)) as costo, \
				sum(if(n.tipo<>'0',d.costoimp,0)) as costoimp \
				from notascredprov n inner join  dnotascredprov d inner join  compras c inner join  articulos inner join  productos prod \
					inner join terminales ter on ter.terminal=c.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
                    inner join sucursales suc on suc.sucursal = sec.sucursal \
				where %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				n.compra=c.referencia and n.cancelado=0 and c.cancelado=0 and \
				n.referencia=d.referencia and n.fechanot<='%s' and \
				d.articulo=articulos.articulo and articulos.producto=prod.producto \
				group by c.referencia, d.articulo INTO OUTFILE '%s'  ", condicion_empresa,
				condicion_sucursal, condicion_acredito, condicion_articulo,
				condicion_proveedor, condicion_almacen, condicion_producto,
				fechas_delimitadas, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_clasicont1, condicion_clasicont2,
				condicion_comprador, fecha_limite_devoluciones, archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE dnotascredprovaux (compra,articulo,cantidad,costo,costoimp) ",
				archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			join_devoluciones.sprintf(" left join dnotascredprovaux dn on \
				dn.articulo=dc.articulo and dn.compra=c.referencia ");

			campos_base +=
				"sum((dc.cantidad-ifnull(dn.cantidad,0))) as cantxart, articulos.articulo, \
				articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
				sum(@unidades:=(dc.cantidad-ifnull(dn.cantidad,0))*articulos.factor) as unidades, \
				sum(@suma:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) as suma, \
				sum(@descuento:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(c.descuento/100)) as descuento, \
				sum(@subtotal:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)) as subtotal, \
				max((dc.costo-ifnull(dn.costo,0))*(1-c.descuento/100)) as costunit, \
				max((dc.costoimp-ifnull(dn.costoimp,0))*(1-c.descuento/100)) as costunitimp, \
				sum(@iepscuota:=(dc.cantidad-ifnull(dn.cantidad,0))*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*(1-c.descuento/100)*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";
		}
		else {

			campos_base +=
				"sum(dc.cantidad) as cantxart, prov.proveedor, \
				articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
				sum(@unidades:=dc.cantidad*articulos.factor) as unidades, \
				sum(@suma:=dc.costo*dc.cantidad) as suma, \
				sum(@descuento:=dc.costo*dc.cantidad*(c.descuento/100)) as descuento, \
				sum(@subtotal:=dc.costo*dc.cantidad*(1-c.descuento/100)) as subtotal, \
				max(dc.costo*(1-c.descuento/100)) as costunit, \
				max(dc.costoimp*(1-c.descuento/100)) as costunitimp, \
				sum(@iepscuota:=dc.cantidad*dc.iepscuota) as iepscuota, \
				sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
				  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
				sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
				  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
				sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
				sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
				  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
				sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*i5.porcentaje/100))) AS imp5, \
				sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";

		}

		consulta.sprintf("select \
			%s \
			%s \
			from compras c  inner join  dcompras dc  inner join  articulos  \
				inner join  productos prod  inner join  proveedores prov \
				inner join terminales ter on ter.terminal=c.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				inner join sucursales suc on suc.sucursal = sec.sucursal \
				left join auximpuestos1 i1 on i1.impuesto=dc.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dc.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dc.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dc.claveimp4 \
				LEFT JOIN auximpuestos5 i5 ON i5.impuesto=c.impuestoret \
				left join (select (count(prov.proveedor)) as numtels, concat(tel.lada,' ',tel.telefono) as tel, prov.proveedor from proveedores prov, telefonosproveedores tel \
							where prov.proveedor=tel.proveedor group by prov.proveedor ) telprov on telprov.proveedor=prov.proveedor \
			%s %s \
			where %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			c.referencia=dc.referencia and c.cancelado=0 and \
			c.proveedor=prov.proveedor and \
			dc.articulo=articulos.articulo and \
			articulos.producto=prod.producto \
			%s ", campos_base, campos_val_impuestos,
			join_devoluciones, join_supervisado, condicion_empresa , condicion_sucursal,
			condicion_acredito, condicion_proveedor, condicion_almacen,
			condicion_producto, fechas_delimitadas, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_tipo_imp,
			condicion_imp, condicion_articulo, condicion_clasicont1,
			condicion_clasicont2, condicion_comprador, condicion_supervisado,
			agrupamiento);

        instruccion =
			"SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			if (incluir_devoluciones == "1")
				mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		}

	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPLISTAPRECIOS
void ServidorReportes::EjecutaRepListaPrecios(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo;
	TDate fecha = Today();
	AnsiString producto, minmax, obtener_existencias,
		obtener_articulos_inactivos, marca, codigo_precio;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_almacen = " ", condicion_producto = " ",
		condicion_minmax = " ", condicion_articulos_inactivos = " ",
		condicion_marca = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString campos_existencias = " ", join_existencias = " ";
	AnsiString mandar_lista_completa_articulos_autoservicio = " ",
		condicion_mandar_lista_completa = " ";
	AnsiString forzar_indice_vta = " force index(fechavta) ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString almacen, cad_conjunto_almacenes = " ";
	AnsiString lista_autoservicio, solo_cambio_precio, fecha_corte_precios,
		solo_con_existencias, solo_autoservicio;
	AnsiString condicion_solo_cambio_precio = " ",
		condicion_solo_con_existencias = " ", condicion_solo_autoservicio = " ";
	BufferRespuestas* resp_almacenes = NULL;
	AnsiString condicion_articulos_inactivos_auxfactor = " ";
	AnsiString archivo_temp1 = "", archivo_temp2 = "", archivo_temp3 = "",
		archivo_temp4 = "";

	AnsiString listaPrecios;
	AnsiString join_precios = " ";
	AnsiString campos_precios = " ", campoF = "a.factor, ";
    AnsiString activosxsuc = " ", join_activosxsuc = " ";

	try {
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		minmax = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		lista_autoservicio = mFg.ExtraeStringDeBuffer(&parametros);
		solo_cambio_precio = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_corte_precios = mFg.ExtraeStringDeBuffer(&parametros);
		solo_con_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		solo_autoservicio = mFg.ExtraeStringDeBuffer(&parametros);
		codigo_precio = mFg.ExtraeStringDeBuffer(&parametros);
		listaPrecios = mFg.ExtraeStringDeBuffer(&parametros);
		activosxsuc = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los almacenes que corresponden a una sucursal
		if (sucursal != " ") {
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
				INNER JOIN secciones s ON a.seccion=s.seccion \
				WHERE s.sucursal='%s'", sucursal);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_almacenes);
			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
				resp_almacenes->IrAlRegistroNumero(i);
				almacen = resp_almacenes->ObtieneDato("almacen");

				cad_conjunto_almacenes += "'";
				cad_conjunto_almacenes += almacen;
				cad_conjunto_almacenes += "'";
				if (i < resp_almacenes->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						cad_conjunto_almacenes += ",";
			}
		}

		if (listaPrecios != "") {
			TStringDynArray precios(SplitString(listaPrecios, ","));
			int countPrec = precios.Length;
			for (int i = 0; i < countPrec; i++) {
				campos_precios += "prec" + IntToStr(i) + ".precio AS prec" +
					precios[i] + " \ ";
				join_precios += "left join precios prec" + IntToStr(i) +
					" on prec" + IntToStr(i) + ".tipoprec='" + precios[i] +
					"' and prec" + IntToStr(i) + ".articulo=a.articulo  ";

				//se agrega restriccion por empresa
				join_precios +=" left join tiposdeprecios tp" + IntToStr(i) + " on tp"
				+ IntToStr(i) + ".tipoprec=prec" + IntToStr(i) + ".tipoprec and tp"+ IntToStr(i) +".idempresa="+
				FormServidor->ObtieneClaveEmpresa()+" \ ";
				if (i != countPrec - 1)
					campos_precios = campos_precios + ",";
			}
		}
		else {
			campoF = "a.factor ";
		}

		if (minmax == "0")
			condicion_minmax = "min";
		else
			condicion_minmax = "max";

		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" and prod.clasif1='%s' ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" and prod.clasif2='%s' ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" and prod.clasif3='%s' ", clasif3);
			forzar_indice_vta = " ";
		}
		if (producto != " ") {
			condicion_producto.sprintf(" and prod.producto='%s' ", producto);
			forzar_indice_vta = " ";
		}

		if (marca != " ") {
			condicion_marca.sprintf(" and prod.marca='%s' ", marca);
		}

		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
			condicion_articulos_inactivos_auxfactor = " where a.activo=1 ";
		}

		// Obtiene las existencias solo si se requieren
		if (obtener_existencias == "1" ||
			(lista_autoservicio == "1" && solo_con_existencias == "1")) {

			// Obtiene fecha del corte más próximo previo a la fecha dada
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'",
				mFg.DateToMySqlDate(fecha));
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
			instruccion = "create temporary table existenciasaux ( \
				producto varchar(8), present varchar(255), \
				tipo char(2), cantidad decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias finales
			instruccion = "create temporary table auxexistsumadas ( \
				producto varchar(8), present varchar(255), \
				cantidad decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias finales
			instruccion = "create temporary table auxexistfinales ( \
				producto varchar(8), present varchar(255), \
				cantidad decimal(12,3), \
				maxfactor decimal(10,3), multmax char(34), cantmax decimal(12,3), \
				minfactor decimal(10,3), multmin char(32), cantmin decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;

			if (cad_conjunto_almacenes != " ")
				condicion_almacen.sprintf(" and ex.almacen IN (%s) ",
				cad_conjunto_almacenes);
			else
				condicion_almacen = " ";

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("SELECT ex.producto, ex.present, SUM(ex.cantidad) AS cantidad \
				FROM existenciasactuales ex \
				INNER JOIN productos prod ON prod.producto = ex.producto \
				WHERE 1 %s %s %s %s %s \
				GROUP BY ex.producto, ex.present INTO OUTFILE '%s' ",
				condicion_almacen, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_producto, archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, cantidad) ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			if (obtener_existencias == "1") {
				// Suma los movimientos para obtener las existencias
				instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
						select e.producto, e.present, sum(e.cantidad) as cantidad \
						from existenciasaux e \
						group by e.producto, e.present");
				instrucciones[num_instrucciones++] = instruccion;

				archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				// Obtiene los factores minimo y máximo
				instruccion.sprintf(" select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
					from auxexistsumadas e, articulos a \
					where e.producto=a.producto and e.present=a.present %s \
					group by e.producto, e.present INTO OUTFILE '%s' ",
					condicion_articulos_inactivos, archivo_temp2);
				instrucciones[num_instrucciones++] = instruccion;

				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE auxexistfinales (producto, present, cantidad, maxfactor, minfactor) ",
					archivo_temp2);
				instrucciones[num_instrucciones++] = instruccion;

				// Obtiene los múltiplos maximos
				instruccion.sprintf("update auxexistfinales e, articulos a \
					set e.multmax=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
					e.present=a.present and e.maxfactor=a.factor %s ",
					condicion_articulos_inactivos);
				instrucciones[num_instrucciones++] = instruccion;

				// Obtiene los múltiplos minimos
				instruccion.sprintf("update auxexistfinales e, articulos a \
					set e.multmin=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
					e.present=a.present and e.minfactor=a.factor %s ",
					condicion_articulos_inactivos);
				instrucciones[num_instrucciones++] = instruccion;

				// Resultado final
				instruccion =
					"create temporary table auxexisttotales ( \
				producto VARCHAR(8), present VARCHAR(255), cantmax INT(12), resto INT(12), \
				multmax CHAR(34), cantmin DECIMAL(12, 3), multmin CHAR(32), INDEX(producto, present)) Engine = InnoDB ";
				instrucciones[num_instrucciones++] = instruccion;

				archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);

				instruccion.sprintf(" SELECT e.producto, e.present, @maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:= mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, 	truncate(@resto/e.minfactor,3) as cantmin, e.multmin \
				FROM auxexistfinales e INTO OUTFILE '%s' ", archivo_temp3);
				instrucciones[num_instrucciones++] = instruccion;

				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE auxexisttotales(producto, present, cantmax, resto, multmax, cantmin, multmin) ",
					archivo_temp3);
				instrucciones[num_instrucciones++] = instruccion;

				campos_existencias =
					", ex.multmax, ex.cantmax, ex.multmin, ex.cantmin ";
				join_existencias =
					" left join auxexisttotales ex on ex.producto=a.producto and ex.present=a.present ";

			}
			else {
				// Suma los movimientos para obtener las existencias (SOLO LOS QUE TENGAN cantida>0)
				instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
						select e.producto, e.present, sum(e.cantidad) as cantidad \
						from existenciasaux e \
						group by e.producto, e.present \
						having cantidad>0");
				instrucciones[num_instrucciones++] = instruccion;

				campos_existencias = ", ex.cantidad ";
				join_existencias =
					" inner join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
			}

		}

		if(activosxsuc == "1"){
			join_activosxsuc.sprintf("INNER JOIN articulosxsuc axs\
			ON a.producto = axs.producto AND a.present = axs.present AND axs.sucursal = '%s'", sucursal);
		}

		instruccion =
			"create temporary table auxfactor (articulo VARCHAR(9), producto VARCHAR(8), \
		 present VARCHAR(255), factor DECIMAL(10,3), INDEX(producto, present)) Engine = InnoDB ";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf(" select a.articulo, a.producto, a.present, %s(a.`factor`) as `factor` \
		 from articulos a %s %s group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_minmax, join_activosxsuc,
			condicion_articulos_inactivos_auxfactor, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxfactor (articulo, producto, present, factor) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf(" SELECT @precautosu:=  '%s' ", codigo_precio);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			//////////////
			// Respuesta//
			//////////////
			if (lista_autoservicio == "0") {
				// En caso de NO ser lista para imprimir precios que se han modificado
				instruccion.sprintf("select prod.producto, prod.nombre, pre.present, a.articulo, a.multiplo, a.ean13 as codigobarras, %s \
					 %s %s	 \
					from articulos a  inner join  productos prod  inner join  presentaciones pre  inner join  auxfactor aux \
					%s \
					%s \
					where 1 %s %s %s %s %s \
					 and a.producto=prod.producto and a.producto=pre.producto and a.present=pre.present \
					and a.factor=aux.factor and aux.producto=a.producto and aux.present=a.present %s \
					group by prod.producto, pre.present \
					order by prod.nombre, pre.present", campoF, campos_precios,
					campos_existencias, join_precios, join_existencias,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_producto, condicion_marca,
					condicion_articulos_inactivos);
			}
			else {

				if (solo_cambio_precio == "1") {
					condicion_solo_cambio_precio.sprintf
						(" and prec1.fechamodi >= '%s' ", fecha_corte_precios);
				}
				if (solo_autoservicio == "1") {
					condicion_solo_autoservicio.sprintf(" and a.asigautosu=1 ");
				}

				// En caso de ser lista para imprimir precios que se han modificado
				instruccion.sprintf("select prod.producto, prod.nombre, pre.present, a.articulo, a.multiplo, a.factor, \
					ROUND(IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.precio), prec1.precio, pl.precio),IFNULL(@digredondeo,6)) as autoservicio, \
					IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.precio), '0', '1') as espreciolocal, \
					a.ean13 as codigobarras %s \
					from articulos a  inner join  productos prod  inner join  presentaciones pre  \
					  inner join precios prec1 \
					  inner join tiposdeprecios tp \
					  %s \
					  LEFT JOIN preciolocal pl \
						ON pl.articulo = a.articulo \
						AND pl.tipoprec = @precautosu \
						AND pl.sucursal='%s' \
					  LEFT JOIN autorizarprecios aut \
						ON aut.sucursal='%s' \
						AND aut.producto=a.producto AND aut.present=a.present \
						AND aut.fechavigencia>='%s' \
					where 1 %s %s %s %s %s \
					and prec1.tipoprec=@precautosu and prec1.articulo=a.articulo and a.activo=1 and \
					prec1.tipoprec=tp.tipoprec and tp.idempresa=%s \
					AND a.producto=prod.producto and a.producto=pre.producto and a.present=pre.present %s %s \
					group by prod.producto, pre.present, a.multiplo \
					order by prod.nombre, pre.present", campos_existencias,
					join_existencias, sucursal, sucursal,
					mFg.DateToMySqlDate(fecha), condicion_clasif1,
					condicion_clasif2, condicion_clasif3, condicion_producto,
					condicion_marca, FormServidor->ObtieneClaveEmpresa(), condicion_solo_cambio_precio,
					condicion_solo_autoservicio);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

		if (archivo_temp1 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		if (archivo_temp2 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		if (archivo_temp3 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		if (archivo_temp4 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPETIQUETASANAQUELES
void ServidorReportes::EjecutaRepEtiquetasAnaqueles
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo;
	AnsiString producto, minmax, obtener_existencias,
		obtener_articulos_inactivos, etiquetas_grandes;
	AnsiString clasif1, clasif2, clasif3, marca;
	AnsiString condicion_almacen = " ", condicion_producto = " ",
		condicion_articulos_inactivos = " ", condicion_marca = " ",
		condicion_etiquetas_grandes = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString campos_existencias = " ", join_existencias = " ";
	AnsiString mandar_lista_completa_articulos_autoservicio = " ",
		condicion_mandar_lista_completa = " ";
	AnsiString forzar_indice_vta = " force index(fechavta) ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString almacen, cad_conjunto_almacenes = " ";
	AnsiString solo_cambio_precio, fecha_ini, fecha_fin, solo_con_existencias,
		solo_autoservicio, solo_articulos_oferta;
	AnsiString condicion_solo_cambio_precio = " ",
		condicion_solo_con_existencias = " ", condicion_solo_autoservicio = " ";
	BufferRespuestas* resp_almacenes = NULL;
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5;
	AnsiString excluir_fabricante, incluir_fabricante;
	AnsiString condicion_excluir_fabricante = " ",
		condicion_incluir_fabricante = " ";
	AnsiString modo_calcular_existencias;
	TDate fecha = Today(), fecha_inicial, fecha_final;
	AnsiString campo_existencias;
	AnsiString campos_ofertas = " ";
	AnsiString inners_ofertas = " ";
	AnsiString condicion_ofertas = " ";

	try {
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		minmax = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		solo_cambio_precio = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_ini = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_fin = mFg.ExtraeStringDeBuffer(&parametros);
		solo_con_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		solo_autoservicio = mFg.ExtraeStringDeBuffer(&parametros);
		excluir_fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		modo_calcular_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		solo_articulos_oferta = mFg.ExtraeStringDeBuffer(&parametros);

		fecha_inicial = StrToDate(fecha_ini);
		fecha_final = StrToDate(fecha_fin);

		// Si se quiere usar modo de existencias actuales solo se permite si la fecha de las existencias es hoy
		// de lo contrario se usa el modo normal.
		if (solo_cambio_precio == "1") {
			if (modo_calcular_existencias == "MODEA" &&
				(fecha_inicial != fecha || fecha_final != fecha)) {
				modo_calcular_existencias = "MODN";
			}
		}

		// Obtiene los almacenes que corresponden a una sucursal
		if (sucursal != " ") {
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
				INNER JOIN secciones s ON a.seccion=s.seccion \
				WHERE s.sucursal='%s'", sucursal);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_almacenes);
			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
				resp_almacenes->IrAlRegistroNumero(i);
				almacen = resp_almacenes->ObtieneDato("almacen");

				cad_conjunto_almacenes += "'";
				cad_conjunto_almacenes += almacen;
				cad_conjunto_almacenes += "'";
				if (i < resp_almacenes->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						cad_conjunto_almacenes += ",";
			}
		}
		else
			throw Exception
				("Error en ID_EJE_REPETIQUETASANAQUELES, se debe elegir una sucursal"
				);

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			forzar_indice_vta = " ";
		}
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			forzar_indice_vta = " ";
		}

		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (excluir_fabricante != " ") {
			condicion_excluir_fabricante.sprintf
				(" AND prod.fabricante != '%s' ", excluir_fabricante);
		}
		if (incluir_fabricante != " ") {
			condicion_incluir_fabricante.sprintf(" AND prod.fabricante = '%s' ",
				incluir_fabricante);
		}
		if(solo_articulos_oferta.Trim() != ""){
			condicion_ofertas = " AND CURDATE() BETWEEN ao.fecha_vigencia_inicio AND ao.fecha_vigencia_fin AND ao.aplica_relacionados = 0 \
				AND ao.idempresa="+FormServidor->ObtieneClaveEmpresa()+" ";
			campos_ofertas = " , ao.precio_oferta, ao.fecha_vigencia_inicio, ao.fecha_vigencia_fin, \
			ao.cantidad_minima, ao.cantidad_maxima, IF(ABS(ao.cantidad_maxima-ao.cantidad_minima)>100, 0,1) AS aplica_condicion";
			inners_ofertas = " INNER JOIN articulos_oferta ao ON ao.articulo = aux1.articulo ";
		}else{
			campos_ofertas = ", 0 as precio_oferta, ' ' as fecha_vigencia_inicio, ' ' as fecha_vigencia_fin, \
			0 as cantidad_minima, 0 as cantidad_maxima, 0 as aplica_condicion ";
		}

		// Obtiene el número de digitos de redondeo para que así se impriman y calculen los precios
		instruccion.sprintf
			("select @digredondeo:=valor from  parametrosemp where parametro='DIGREDOND'"
			);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene las existencias solo si se requieren
		if (obtener_existencias == "1" || solo_con_existencias == "1") {
			if (modo_calcular_existencias == "MODEA") {

				// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
				instruccion = "create temporary table existenciasaux ( \
					producto varchar(8), present varchar(255), \
					tipo char(2), cantidad decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				// Crea una tabla donde se pondrán las existencias finales
				instruccion = "create temporary table auxexistsumadas ( \
					producto varchar(8), present varchar(255), \
					cantidad decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				// Crea una tabla donde se pondrán las existencias finales
				instruccion = "create temporary table auxexistfinales ( \
					producto varchar(8), present varchar(255), \
					cantidad decimal(12,3), \
					maxfactor decimal(10,3), multmax char(32), cantmax decimal(12,3), \
					minfactor decimal(10,3), multmin char(32), cantmin decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" ex.almacen IN (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("SELECT \
					ex.producto, \
					ex.present, \
					SUM(ex.cantidad) AS cantidad \
				FROM existenciasactuales ex, productos prod \
				WHERE %s %s %s %s %s \
				prod.producto = ex.producto \
				%s %s \
				GROUP BY ex.producto, ex.present INTO OUTFILE '%s'",
					condicion_almacen, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp1);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, cantidad) ",
					archivo_temp1);
				instrucciones[num_instrucciones++] = instruccion;

				if (obtener_existencias == "1") {
					// Suma los movimientos para obtener las existencias
					instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
							select e.producto, e.present, sum(e.cantidad) as cantidad \
							from existenciasaux e \
							group by e.producto, e.present");
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los factores minimo y máximo
					instruccion.sprintf("insert into auxexistfinales (producto, present, cantidad, maxfactor, minfactor) \
						select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
						from auxexistsumadas e, articulos a \
						where e.producto=a.producto and e.present=a.present %s \
						group by e.producto, e.present",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los múltiplos maximos
					instruccion.sprintf("update auxexistfinales e, articulos a \
						set e.multmax=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
						e.present=a.present and e.maxfactor=a.factor %s ",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los múltiplos minimos
					instruccion.sprintf("update auxexistfinales e, articulos a \
						set e.multmin=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
						e.present=a.present and e.minfactor=a.factor %s ",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Resultado final
					instruccion.sprintf("create temporary table auxexisttotales \
						select e.producto, e.present, \
						@maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
						@resto:=mod(e.cantidad, e.maxfactor) as resto, \
						e.multmax, \
						(@resto/e.minfactor) as cantmin, \
						e.multmin \
						from auxexistfinales e");
					instrucciones[num_instrucciones++] = instruccion;

					campos_existencias =
						", ex.multmax, ex.cantmax, ex.multmin, ex.cantmin ";
					join_existencias =
						" left join auxexisttotales ex on ex.producto=a.producto and ex.present=a.present ";

				}
				else {
					// Suma los movimientos para obtener las existencias (SOLO LOS QUE TENGAN cantida>0)
					instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
							select e.producto, e.present, sum(e.cantidad) as cantidad \
							from existenciasaux e \
							group by e.producto, e.present \
							having cantidad>0");
					instrucciones[num_instrucciones++] = instruccion;

					campos_existencias = ", ex.cantidad ";
					join_existencias =
						" inner join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
				}

			}
			else {

				// Obtiene fecha del corte más próximo previo a la fecha dada
				instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
					 from puntoscorte p where p.fecha<='%s'",
					mFg.DateToMySqlDate(fecha));
				instrucciones[num_instrucciones++] = instruccion;

				// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
				instruccion = "create temporary table existenciasaux ( \
					producto varchar(8), present varchar(255), \
					tipo char(2), cantidad decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				// Crea una tabla donde se pondrán las existencias finales
				instruccion = "create temporary table auxexistsumadas ( \
					producto varchar(8), present varchar(255), \
					cantidad decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				// Crea una tabla donde se pondrán las existencias finales
				instruccion = "create temporary table auxexistfinales ( \
					producto varchar(8), present varchar(255), \
					cantidad decimal(12,3), \
					maxfactor decimal(10,3), multmax char(16), cantmax decimal(12,3), \
					minfactor decimal(10,3), multmin char(16), cantmin decimal(12,3), \
					INDEX(producto, present)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula la existencia al momento del corte previo.
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" pce.almacen in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("select pce.producto, pce.present, 'IN' as tipo, \
					sum(pce.cantidad) as cantidad \
					from puntoscorteexistencias pce, productos prod \
					where %s %s %s %s %s \
					pce.fecha=@fechacorte and pce.producto=prod.producto \
					%s %s \
					group by pce.producto, pce.present INTO OUTFILE '%s'",
					condicion_almacen, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp1);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
					archivo_temp1);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las compras
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" c.almacen in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("select a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad \
					from compras c, dcompras d, articulos a, productos prod \
					where %s %s %s %s %s \
					c.fechacom>@fechacorte and c.referencia=d.referencia \
					and c.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
					%s %s \
					group by a.producto, a.present INTO OUTFILE '%s'",
					condicion_almacen, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp2);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
					archivo_temp2);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las devoluciones a las compras
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" c.almacen in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
					select a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
					from notascredprov n, compras c, dnotascredprov d, articulos a, productos prod \
					where  %s %s %s %s %s \
					n.fechanot>@fechacorte and n.tipo='0' \
					and n.referencia=d.referencia and n.compra=c.referencia and \
					n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
					%s %s \
					group by a.producto, a.present", condicion_almacen,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_producto, condicion_excluir_fabricante,
					condicion_incluir_fabricante);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las ventas.
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" d.almacen in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("select a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
					from ventas v %s  inner join  dventas d  inner join  articulos a \
					left join productos prod on a.producto=prod.producto \
					where %s %s %s %s %s \
					v.fechavta>@fechacorte and v.referencia=d.referencia \
					and v.cancelado=0 and d.articulo=a.articulo \
					%s %s \
					group by a.producto, a.present INTO OUTFILE '%s'",
					forzar_indice_vta, condicion_almacen, condicion_clasif1,
					condicion_clasif2, condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp3);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
					archivo_temp3);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las devoluciones a las ventas
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" dv.almacen in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
					select a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad \
					from notascredcli n, dnotascredcli dn, ventas v, dventas dv, articulos a, productos prod \
					where %s %s %s %s %s \
					n.fechanot>@fechacorte and n.tipo='0' \
					and n.referencia=dn.referencia and n.venta=v.referencia \
					and v.referencia=dv.referencia and \
					n.cancelado=0 and dn.articulo=a.articulo and dv.articulo=dn.articulo and a.producto=prod.producto \
					%s %s \
					group by a.producto, a.present", condicion_almacen,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_producto, condicion_excluir_fabricante,
					condicion_incluir_fabricante);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las entradas de almacén
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" m.almaent in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("select a.producto, a.present, 'EN' as tipo, sum(d.cantidad*a.factor) as cantidad \
					from movalma m, dmovalma d, articulos a, productos prod \
					where %s %s %s %s %s \
					m.fechamov>@fechacorte and m.movimiento=d.movimiento \
					and m.tipo<>'S' \
					AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
					%s %s \
					group by a.producto, a.present INTO OUTFILE '%s'",
					condicion_almacen, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp4);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
					archivo_temp4);
				instrucciones[num_instrucciones++] = instruccion;

				// Calcula las salidas de almacén
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" m.almasal in (%s) and ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("select a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
					from movalma m, dmovalma d, articulos a, productos prod \
					where %s %s %s %s %s \
					m.fechamov>@fechacorte and m.movimiento=d.movimiento \
					and m.tipo<>'E' \
					AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
					%s %s \
					group by a.producto, a.present  INTO OUTFILE '%s'",
					condicion_almacen, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto,
					condicion_excluir_fabricante, condicion_incluir_fabricante,
					archivo_temp5);
				instrucciones[num_instrucciones++] = instruccion;
				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
					archivo_temp5);
				instrucciones[num_instrucciones++] = instruccion;

				if (obtener_existencias == "1") {
					// Suma los movimientos para obtener las existencias
					instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
							select e.producto, e.present, sum(e.cantidad) as cantidad \
							from existenciasaux e \
							group by e.producto, e.present");
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los factores minimo y máximo
					instruccion.sprintf("insert into auxexistfinales (producto, present, cantidad, maxfactor, minfactor) \
						select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
						from auxexistsumadas e, articulos a \
						where e.producto=a.producto and e.present=a.present %s \
						group by e.producto, e.present",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los múltiplos maximos
					instruccion.sprintf("update auxexistfinales e, articulos a \
						set e.multmax=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
						e.present=a.present and e.maxfactor=a.factor %s ",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Obtiene los múltiplos minimos
					instruccion.sprintf("update auxexistfinales e, articulos a \
						set e.multmin=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
						e.present=a.present and e.minfactor=a.factor %s ",
						condicion_articulos_inactivos);
					instrucciones[num_instrucciones++] = instruccion;

					// Resultado final
					instruccion.sprintf("create temporary table auxexisttotales \
						select e.producto, e.present, \
						@maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
						@resto:=mod(e.cantidad, e.maxfactor) as resto, \
						e.multmax, \
						(@resto/e.minfactor) as cantmin, \
						e.multmin \
						from auxexistfinales e");
					instrucciones[num_instrucciones++] = instruccion;

					campos_existencias =
						", ex.multmax, ex.cantmax, ex.multmin, ex.cantmin ";
					join_existencias =
						" left join auxexisttotales ex on ex.producto=a.producto and ex.present=a.present ";

				}
				else {
					// Suma los movimientos para obtener las existencias (SOLO LOS QUE TENGAN cantida>0)
					instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
							select e.producto, e.present, sum(e.cantidad) as cantidad \
							from existenciasaux e \
							group by e.producto, e.present \
							having cantidad>0");
					instrucciones[num_instrucciones++] = instruccion;

					campos_existencias = ", ex.cantidad ";
					join_existencias =
						" inner join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
				}
			}
			campo_existencias = "aux1.cantidad";

		}
		else {
			campo_existencias = "0 AS cantidad";
		}

		// se obtiene el precio de autoservicio
		instruccion.sprintf("select @precautosu:= ce.tipoprec \
			from parametrosemp para, clientes cli, clientesemp ce \
			where para.parametro='AUTOSUCLI' and para.valor=cli.cliente AND para.sucursal = '%s' \
			 and ce.cliente=cli.cliente and ce.idempresa=%s  ",
			FormServidor->ObtieneClaveSucursal(), FormServidor->ObtieneClaveEmpresa() );
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			//////////////
			// Respuesta//
			//////////////

			AnsiString condicion_factor_multiplos = " ";
			AnsiString condicion_factor_unidad = " ";
			if (minmax == "0") {
				// Factor mínimo
				condicion_factor_multiplos = " ";
				condicion_factor_unidad = " a.factor=1 and ";
			}
			else {
				// Todos los factores
				condicion_factor_multiplos = ",a.multiplo ";
				condicion_factor_unidad = " ";
			}

			if (solo_cambio_precio == "1") {
				condicion_solo_cambio_precio.sprintf
					(" and prec1.fechamodi BETWEEN '%s' AND '%s' ",
					mFg.StrToMySqlDate(fecha_ini),
				mFg.StrToMySqlDate(fecha_fin));
			}
			if (solo_autoservicio == "1") {
				condicion_solo_autoservicio.sprintf(" and a.asigautosu=1 ");
			}

			instruccion.sprintf("SELECT aux1.articulo, aux1.producto, aux1.nombre, aux1.present, aux1.multiplo, \
				aux1.factor, aux1.autoservicio, aux1.codigobarras, aux1.espreciolocal,aux1.etiquetasgr, \
				aux2.concepto, aux2.precio, aux2.descripconcepto, aux2.cantmin, aux2.cantmin_chec, aux2.cantmax_chec, \
				aux1.fechamodi, \
				%s %s \
				FROM ( \
						select a.articulo, prod.producto, prod.nombre, pre.present, a.multiplo, a.factor,  prod.etiquetasgr, \
						ROUND(IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.precio), prec1.precio, pl.precio),IFNULL(@digredondeo,6)) as autoservicio, \
						IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.precio), '0', '1') as espreciolocal, \
						a.ean13 as codigobarras, prec1.fechamodi %s \
						from articulos a  inner join  productos prod  inner join  presentaciones pre  \
						inner join precios prec1 ON prec1.tipoprec=@precautosu and prec1.articulo=a.articulo \
						inner join tiposdeprecios tp ON tp.tipoprec=prec1.tipoprec and tp.idempresa=%s \
							  LEFT JOIN preciolocal pl \
								ON pl.articulo = a.articulo \
								AND pl.tipoprec = @precautosu \
								AND pl.sucursal='%s' \
							  LEFT JOIN autorizarprecios aut \
								ON aut.sucursal='%s' \
								AND aut.producto=a.producto AND aut.present=a.present \
								AND aut.fechavigencia>='%s' \
						%s \
						where %s %s %s %s %s %s \
						a.activo=1 and \
						a.producto=prod.producto and a.producto=pre.producto and a.present=pre.present %s %s %s %s \
						group by prod.producto, pre.present %s \
				) AS aux1 INNER JOIN ( \
					SELECT a.articulo, dcv.clave, cv.concepto, \
					 ROUND(IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.precio), p.precio, pl.precio),IFNULL(@digredondeo,6)) as precio, \
					 IF(dcv.cantmin<=1, 'Precio', CONCAT(CEIL(dcv.cantmin/a.factor), ' o más')) AS descripconcepto, CEIL(dcv.cantmin/a.factor) as cantmin, \
                     	dcv.cantmin as cantmin_chec,dcv.cantmax as cantmax_chec, p.fechamodi \
					 FROM dconceptosventa dcv \
					INNER JOIN articulos a ON a.producto=dcv.producto AND a.present=dcv.present and a.activo=1 \
					INNER JOIN productos prod ON a.producto = prod.producto \
					LEFT JOIN conceptosventa cv ON cv.clave=dcv.clave and cv.idempresa=%s \
					LEFT JOIN precios p ON p.tipoprec=cv.tipoprec AND a.articulo=p.articulo \
					LEFT JOIN tiposdeprecios tp ON tp.tipoprec=p.tipoprec and tp.idempresa=%s \
						  LEFT JOIN preciolocal pl \
							ON pl.articulo = a.articulo \
							AND pl.tipoprec = cv.tipoprec \
							AND pl.sucursal='%s' \
						  LEFT JOIN autorizarprecios aut \
							ON aut.sucursal='%s' \
							AND aut.producto=a.producto AND aut.present=a.present \
							AND aut.fechavigencia>='%s' \
					WHERE cv.imprimir=1 %s %s \
				) AS aux2 ON aux1.articulo=aux2.articulo %s \
				WHERE 1 %s \
				ORDER BY aux1.nombre, aux1.present, aux1.factor, aux2.cantmin",
				campo_existencias, campos_ofertas, campos_existencias,
				FormServidor->ObtieneClaveEmpresa(), sucursal, sucursal,
				mFg.DateToMySqlDate(fecha), join_existencias, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_marca,
				condicion_producto, condicion_factor_unidad,
				condicion_solo_cambio_precio, condicion_solo_autoservicio,
				condicion_excluir_fabricante, condicion_incluir_fabricante,
				condicion_factor_multiplos, FormServidor->ObtieneClaveEmpresa(),
				 FormServidor->ObtieneClaveEmpresa(), sucursal, sucursal,
				mFg.DateToMySqlDate(fecha), condicion_excluir_fabricante,
				condicion_incluir_fabricante,
				inners_ofertas, condicion_ofertas);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			if (obtener_existencias == "1" || solo_con_existencias == "1") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp1);
				mServidorVioleta->BorraArchivoTemp(archivo_temp2);
				mServidorVioleta->BorraArchivoTemp(archivo_temp3);
				mServidorVioleta->BorraArchivoTemp(archivo_temp4);
				mServidorVioleta->BorraArchivoTemp(archivo_temp5);
			}
		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;

	}
}

// ---------------------------------------------------------------------------

// ID_EJE_REPSEG_MOVS_ART
void ServidorReportes::EjecutaRepSeguimientoMovsArticulo
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	throw Exception("La función ID_EJE_REPSEG_MOVS_ART está descontinuada");
}

// ---------------------------------------------------------------------------
// ID_EJE_REPEXISTENCIAS_SIMPLE
void ServidorReportes::EjecutaRepExistenciasSimple(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo, considerar_cortes;
	AnsiString fecha;
	AnsiString almacen, stock, marca, producto;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos;
	AnsiString condicion_almacen = " ", condicion_stock = " ", condicion_marca =
		" ", condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ";
	AnsiString join_productos = " ";
	AnsiString calculo_promedio_ventas;
	TDate fecha_inicial_promedio;
	int dias, tipopromedio;
	AnsiString forzar_indice_vta = " ";
	AnsiString sucursal;
	AnsiString cad_conjunto_almacenes = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6, archivo_temp7;
	AnsiString archivo_temp8, archivo_temp9, archivo_temp10, archivo_temp11,
		archivo_temp12, archivo_temp13, archivo_temp14;
	AnsiString archivo_temp15;
	double divisor;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursales = NULL;
	int costoscompra;
	int exixtenciascero = 0;
	AnsiString camposcostoscompra = " ", leftcostoscompra = " ";
	AnsiString condicion_sucursal, condicion_sucursal_stock,
		condicion_producto_ventasmes = " ";
	AnsiString condicion_clasif1_ventasmes = " ", condicion_clasif2_ventasmes =
		" ", condicion_clasif3_ventasmes = " ";
	AnsiString condicion_devventas = " ";
	TDate fecha_hoy = Today();
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes actual
	int mes_ant = (mes_actual + 24) - 1; // Mes anterior
	int mes_penant = (mes_actual + 24) - 2; // Mes penultimo anterior
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_mes_ant = mFg.IntToAnsiString(mes_ant);
	AnsiString cad_mes_penant = mFg.IntToAnsiString(mes_penant);
	AnsiString marca_excluir, condicion_marca_excluir = " ",
		presentaciones_cotizables = " ", presentaciones_sup_gerencia = " ";
	AnsiString prov_historico, meses;
	AnsiString inner_provcompras = " ", condicion_meses = " ";
	AnsiString fabricante, condicion_fabricante = " ", join_fabricante = " ",
		condicion_fabricante_vtaxmes = " ";
	AnsiString segmento, condicion_segmento = " ", join_segmento = " ",
		condicion_segmento_vtaxmes = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " "; ;

	AnsiString condicion_descontinuado = " ";
	AnsiString artactxsuc;
	AnsiString inner_artactxsuc = " ";
	AnsiString listaTags, join_art_tags = " ", condicion_art_tags = " ";
	// AnsiString inner_artactxsuc=" ";
	TStringList* mListaTags = new TStringList();
	AnsiString soloDescontinuados = "", condicion_soloDescontinuados = "";
	// Opción solo descontinuados

	// SalidasDeAllmacen
	AnsiString inner_join_salida = " ", campo_salida = "0", campo_salida2 = "0",
		condicion_suc = " ", condicion_suc2 = " ", condicion_producto_pmm = " ";
	AnsiString consider_salidas_ventas; // Opción considerar salidas

	BufferRespuestas* resp_conceptosmovvent = NULL;
	// Conceptos de salida considerados ventas
	AnsiString concepto;
	AnsiString cad_conjunto_conceptos = " ";
	AnsiString calculo_promedio_salidas;
	AnsiString condicion_concepto = " ";

	AnsiString empleadosupervisor = " ";
	AnsiString condicion_empleadosupervisor = " ", inner_empleadosupervisor =
		" ", campo_supervisado = " ";

	AnsiString archivo_temp16;
	// archivo temporal de salidas consideradas ventas
	AnsiString archivo_temp17;
	// archivo temporal de salidas consideradas ventas de mes actual
	AnsiString archivo_temp18;
	// archivo temporal de salidas consideradas ventas de mes anterior
	AnsiString archivo_temp19;
	// archivo temporal de salidas consideradas ventas de mes preanterior
	AnsiString consultaSalxVentasxFechaAct = " ", consultaSalxVentasxFechaAnt =
		" ", consultaSalxVentasxFechaPreAnt = " ", conSalxVenxFechaActIni = " ",
		conSalxVenxFechaActFin = " ";
	AnsiString conSalxVenxFechaAntIni = " ", conSalxVenxFechaAntFin = " ",
		conSalxVenxFechaPreAntIni = " ", conSalxVenxFechaPreAntFin = " ";
	AnsiString fechaInicioSalxVent = " ", fechaFinSalxVent = " ";
	AnsiString condicion_producto_ventasxsalidasmes = " ";
	AnsiString condicion_salidasVentasxMes = " ";
	AnsiString campo_svxmact = " ", campo_svxmant = " ", campo_svxmpant = " ";
	AnsiString condicion_almacen_sv = " ",condicion_almacen_vta3=" ";
	AnsiString campocostoprom = " ", leftcostoprom = " ";
	AnsiString condicionDescNw = " ", condicionHav = "";
    AnsiString idEmpresa = " ",empresa,cadena_sucursal_empresa = " ";

	AnsiString fechaResF, fechaResFglon;
    bool bandExist = false;
	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		//// 0_-10-2023 agr
		if(fecha!=" "){
			BufferRespuestas* resp_n = NULL;
			BufferRespuestas* resp_n2 = NULL;
			AnsiString fech, resultEstGlob, resultPuntCort;
			try {
				//instruccion = "select max(p.fecha) as fcorte from puntoscorte p where p.fecha<= '"+fecha+"'";
				instruccion.sprintf("SELECT IFNULL(MAX(p.fecha),'1900-01-01') AS fcorte \
				FROM puntoscorte p \
				WHERE p.fecha<='%s'", fecha);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n);

				if (resp_n->ObtieneNumRegistros() > 0) {
					resultPuntCort = resp_n->ObtieneDato("fcorte");
				}	
				
				if(resultPuntCort == " ")
					resultPuntCort="1900-01-01";

				//instruccion = "SELECT valor FROM estadosistemaglob WHERE estado ='FCORTEINI'";
				instruccion.sprintf("SELECT IFNULL(valor, '2000-01-01') AS val \
				FROM estadosistemaglob \
				WHERE estado = 'FCORTEINI'");
				
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n2);
					
				resultEstGlob = resp_n2->ObtieneDato("val");
				fechaResFglon = resp_n2->ObtieneDato("val");
				
				if(resultEstGlob == "")
					resultEstGlob = "1900-01-01";

				 TDateTime resultDFech, resultDPc, resultDEg;
				 int difpc, difeg;
				 int a, m ,d;
				 
				 if(sscanf(fecha.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDFech= EncodeDate(a,m,d);
				 
				 if(sscanf(resultPuntCort.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDPc= EncodeDate(a,m,d);
					
				 if(sscanf(resultEstGlob.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDEg= EncodeDate(a,m,d);
					
				 difpc = DaysBetween(resultDFech,resultDPc);
				 difeg = DaysBetween(resultDFech,resultDEg);
				 
                 if(difpc == difeg){
                    fechaResF = resultEstGlob;
					bandExist=true; //eglob
				 }
				 else if(difpc < difeg){
					//fecha = difpc;
					bandExist=false; //pc
					fechaResF = resultPuntCort;
				 } else {
					//fecha = difeg;
					fechaResF = resultEstGlob;
					bandExist=true; //eglob
				 }
			}
			__finally {
				if (resp_n != NULL)
					delete resp_n;
				if (resp_n2 != NULL)
					delete resp_n2;
			}
		}
		///// fin agr prb modf 04-10-2023
		empresa  = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		stock = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		dias = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		tipopromedio = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
        idEmpresa = FormServidor->ObtieneClaveEmpresa();

		if (tipopromedio == 0) {
			divisor = dias / 30.5;
		}
		if (tipopromedio == 1) {
			divisor = dias / 15;
		}
		if (tipopromedio == 2) {
			divisor = dias / 7;
		}
		if (tipopromedio == 3) {
			divisor = dias / 1;
		}
		costoscompra = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		if (costoscompra == 1) {
			camposcostoscompra = " , acc.costocompra ";
			leftcostoscompra =
				" left join auxcostoscompra acc ON acc.producto=s.producto and acc.present=s.present ";
			campocostoprom =
				" , (costprom.costounit * pmm.maxfactor) AS costoprom ";
			leftcostoprom.sprintf(
				" LEFT JOIN precalculocostospromedio%s costprom ON costprom.producto = pmm.producto and costprom.present=pmm.present",
				FormServidor->ObtieneClaveEmpresa());
		}
		marca_excluir = mFg.ExtraeStringDeBuffer(&parametros);
		presentaciones_cotizables = mFg.ExtraeStringDeBuffer(&parametros);
		presentaciones_sup_gerencia = mFg.ExtraeStringDeBuffer(&parametros);

		prov_historico = mFg.ExtraeStringDeBuffer(&parametros);
		meses = mFg.ExtraeStringDeBuffer(&parametros);

		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		artactxsuc = mFg.ExtraeStringDeBuffer(&parametros);

		listaTags = mFg.ExtraeStringDeBuffer(&parametros);

		// Guarda variable descontinuados
		soloDescontinuados = mFg.ExtraeStringDeBuffer(&parametros);

		// Guarda variable "Contar salidas por traspasos para prom. de ventas
		consider_salidas_ventas = mFg.ExtraeStringDeBuffer(&parametros);

		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);

		if (presentaciones_cotizables == "1")
			presentaciones_cotizables = " AND present.cotizable=1 ";
		else
			presentaciones_cotizables = " ";

		if (presentaciones_sup_gerencia == "1")
			presentaciones_sup_gerencia = " AND present.sgerencia=1 ";
		else
			presentaciones_sup_gerencia = " ";

		// fecha_inicial_promedio=IncMonth(mFg.MySqlDateToTDate(fecha.c_str()), meses*-1);
		fecha_inicial_promedio = mFg.MySqlDateToTDate(fecha.c_str()) - dias;

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" WHERE s.sucursal='%s' ", sucursal);
			condicion_sucursal_stock.sprintf(" WHERE sucursal='%s' ", sucursal);
            condicion_suc.sprintf(" AND pre.sucursal = '%s' ", sucursal);
			condicion_suc2.sprintf(" AND pre.sucursal = '%s' ", sucursal);
            cadena_sucursal_empresa="'"+sucursal+"'";
		}
		else {
			AnsiString cadena_sucursal = "";
			instruccion.sprintf("SELECT sucursal FROM sucursales where idempresa = %s",empresa);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_sucursales);
			for (i = 0; i < resp_sucursales->ObtieneNumRegistros(); i++) {

				resp_sucursales->IrAlRegistroNumero(i);

				if (i != resp_sucursales->ObtieneNumRegistros() - 1)
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "',";
				else
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "'";

			}

			condicion_sucursal.sprintf(" WHERE s.sucursal IN(%s) ",
				cadena_sucursal);
			condicion_sucursal_stock.sprintf(" WHERE sucursal IN(%s) ",
				cadena_sucursal);
			condicion_suc.sprintf(" WHERE sucursal IN(%s) ", cadena_sucursal);
			condicion_suc2.sprintf(" AND pre.sucursal IN(%s) ",
				cadena_sucursal);
			cadena_sucursal_empresa=cadena_sucursal;
		}

		if (stock != " ") {
			if (stock == "0") {
				condicion_stock.sprintf("having e.cantidad<0 ");
			}
			if (stock == "1") {
				condicion_stock.sprintf("having e.cantidad>0 ");
			}
			if (stock == "2") {
				condicion_stock.sprintf("having e.cantidad= %d ",
					exixtenciascero);
			}
			if (stock == "3") {
				condicion_stock.sprintf("having e.cantidad<minimotot ");
			}
			if (stock == "4") {
				condicion_stock.sprintf("having e.cantidad<reordentot ");
			}
			if (stock == "5") {
				condicion_stock.sprintf("having e.cantidad>maximotot ");
			}
			if (stock == "6") {
				condicion_stock.sprintf
					("having e.cantidad!=0 AND amin.activo=0 ");
			}
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif1_ventasmes.sprintf(" AND prod.clasif1='%s' ",
				clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif2_ventasmes.sprintf(" AND prod.clasif2='%s' ",
				clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif3_ventasmes.sprintf(" AND prod.clasif3='%s' ",
				clasif3);
		}
		if (marca != " ") {
			condicion_marca.sprintf(" AND prod.marca='%s'  ", marca);
		}
		if (marca_excluir == "1") {
			// Se obtienen todas las marcas para excluirlas
			BufferRespuestas* resp_n = NULL;
			AnsiString marcasExcluir;
			int cantMarcas = 0;
			try {
				instruccion = "SELECT marca FROM marcasexistsim ";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n);

				cantMarcas = resp_n->ObtieneNumRegistros();
				for (i = 0; i < resp_n->ObtieneNumRegistros(); i++) {
					if (i == resp_n->ObtieneNumRegistros() - 1)
						marcasExcluir +=
							"'" + resp_n->ObtieneDato("marca") + "'";
					else
						marcasExcluir +=
							"'" + resp_n->ObtieneDato("marca") + "',";

					resp_n->IrAlSiguienteRegistro();
				}

			}
			__finally {
				if (resp_n != NULL)
					delete resp_n;
			}

			if (cantMarcas > 0)
				condicion_marca_excluir.sprintf(" AND prod.marca NOT IN(%s)",
				marcasExcluir);
			else
				condicion_marca_excluir.sprintf(" ");
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_producto_ventasmes.sprintf(" AND prod.producto='%s' ",
				producto);
			condicion_producto_ventasxsalidasmes.sprintf(" a.producto='%s' AND",
				producto);
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (prov_historico == " ") {
			inner_provcompras = " ";
		}
		else {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha, meses, fecha);
			}
			else {
				condicion_meses = " ";
			}
			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present",
				AnsiString(prov_historico).c_str(), condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			inner_provcompras.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pppca.producto=a.producto AND pppca.present=a.present "
				);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
			join_productos.sprintf
				(" inner join productos prod on a.producto=prod.producto ");
			condicion_fabricante_vtaxmes.sprintf(" AND prod.fabricante='%s' ",
				fabricante);
		}

		// Usaremos el segmento de presentacion
		if (segmento != " ") {

			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);

			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=a.producto AND present.present=a.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;
			join_presentacion2 =
				" INNER JOIN presentaciones present ON present.producto=pce.producto  AND present.present=pce.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;
			join_presentacion3 =
				" INNER JOIN presentaciones present ON  vm.producto=present.producto AND vm.present=present.present \
	              INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;

		}

		if (artactxsuc != "0") {
			inner_artactxsuc.sprintf
				("INNER JOIN articulosxsuc axs ON axs.producto = a.producto AND axs.present = a.present AND axs.sucursal IN ('%s')",
				sucursal);
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		if (considerar_cortes == "1") {
			forzar_indice_vta = " force index(fechavta) ";
			if(fechaResF!=""){
				instruccion.sprintf("set @fechacorte='%s'", fechaResF);
				//bandExist = true;
			}else{
				instruccion.sprintf("set @fechacorte='1900-01-01'");
				//bandExist = false;
			}
		}
		else {
			if( fechaResFglon == "2000-01-01"){
				instruccion.sprintf("set @fechacorte='1900-01-01'");
				bandExist = false;
			}
			else{
				instruccion.sprintf("set @fechacorte='%s'", fechaResF);
				bandExist=true;
			}
		}
		instrucciones[num_instrucciones++] = instruccion;

		if (listaTags != " ") {

			join_art_tags.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags.sprintf(" AND artt.idarticulotag in (%s) ",
				listaTags);
		}

		// Sección de optimización
		if (producto != " " || clasif3 != " " || clasif2 != " ") {
			// Si probablemente pueda servirnos más los indices de productos,
			// entonces evitamos forzar el indice de ventas, y dejamos que mysql decida.
			forzar_indice_vta = " ";
		}

		// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
		instruccion = "create temporary table existenciasaux ( \
			producto varchar(8), present varchar(255), \
			tipo varchar(2), cantidad decimal(12,3), cantvpprom decimal(12,3),  \
			cantsalprom decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias sumadas
		instruccion = "create temporary table auxexistsumadas ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), cantvpprom decimal(12,3), \
			cantsalprom decimal(12,3),\
			cantvtotprom decimal(12,3),\
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistfinales ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), cantvpprom decimal(12,3), \
			maxfactor decimal(10,3), multmax varchar(10), \
			minfactor decimal(10,3), multmin varchar(10), \
			cantvtotprom decimal(12,3), \
			cantsalprom decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrá el stock de los almacenes relacionados al reporte
		instruccion = "create temporary table auxstockagrup (producto varchar(8), present varchar(255), \
			minimo int(9), \
			maximo int(9), \
			reorden int(9), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			// Crea una tabla donde se pondrán los costos de compra
			instruccion =
				"create temporary table auxcostoscompra (producto varchar(8), present varchar(255), \
				costocompra decimal(12,3), INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;
		}

		// Calcula el stock.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" where almacen in (%s) ",
				cad_conjunto_almacenes);
			condicion_almacen_sv.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);
			condicion_almacen_vta3.sprintf(" and alm.almacen in (%s) ",cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select producto, present,        \
									sum(minimo) as minimo,    \
									sum(maximo) as maximo,    \
									sum(reorden) as reorden   \
							 from stock 	%s 			      \
									group by producto, present INTO OUTFILE '%s' "
			, condicion_sucursal_stock, archivo_temp6);

		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxstockagrup ",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula base (0) de los artículos en cuestión.
		// La utilidad de esto es simplemente para tomar en cuenta todos los articulos aunque no
		// tengan ningun movimiento
		condicion_almacen = " ";

		archivo_temp7 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'BA' as tipo,0 as cantidad  \
								from articulos a %s, productos prod \
								where %s %s %s %s %s %s %s \
								a.producto=prod.producto \
								group by a.producto, a.present INTO OUTFILE '%s' "
			, join_presentacion1, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento, archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula la existencia al momento del corte previo.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" pce.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp8 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		if(bandExist == true){
			instruccion.sprintf("select pce.producto, pce.present, 'IN' as tipo, \
			sum(pce.cantidad) as cantidad  \
			from existenciasiniciales pce %s, productos prod, \
			almacenes alm, secciones sec, sucursales suc\
			where %s %s %s %s %s %s %s \
			pce.producto=prod.producto \
            AND alm.almacen=pce.almacen\
			AND alm.seccion=sec.seccion\
			AND suc.sucursal=sec.sucursal AND suc.idempresa = %s\
			group by pce.producto, pce.present INTO OUTFILE '%s'",
			join_presentacion2, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento,empresa,
			archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;
		} else{
			instruccion.sprintf("select pce.producto, pce.present, 'IN' as tipo, \
			sum(pce.cantidad) as cantidad  \
			from puntoscorteexistencias pce %s, productos prod, \
			almacenes alm, secciones sec, sucursales suc\
			where %s %s %s %s %s %s %s \
			pce.fecha=@fechacorte and pce.producto=prod.producto \
            AND alm.almacen=pce.almacen\
			AND alm.seccion=sec.seccion\
			AND suc.sucursal=sec.sucursal AND suc.idempresa = %s\
			group by pce.producto, pce.present INTO OUTFILE '%s'",
			join_presentacion2, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento,empresa, archivo_temp8);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad  \
			from compras c \
			inner join dcompras d on c.referencia=d.referencia \
			inner join articulos a on d.articulo=a.articulo \
			INNER JOIN almacenes alm ON c.almacen=alm.almacen\
			INNER JOIN secciones sec ON sec.seccion=alm.seccion\
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal AND suc.idempresa = %s\
			%s %s \
			where %s %s %s %s %s %s %s \
			c.fechacom>@fechacorte and c.fechacom<=@fechafinal and c.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'", empresa,
			join_productos, join_presentacion1, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp9 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad  \
			from notascredprov n, compras c, dnotascredprov d, articulos a %s, productos prod, \
			almacenes alm,secciones sec,sucursales suc\
			where  %s %s %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' \
			and n.referencia=d.referencia and n.compra=c.referencia and \
			n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			AND alm.almacen=c.almacen AND sec.seccion=alm.seccion\
			AND suc.sucursal=sec.sucursal AND suc.idempresa = %s\
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento,empresa, archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las ventas.
		AnsiString cadena_join_ventasxmes = " ";
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" d.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_ventas.sprintf
				(" sum(if(v.fechavta>='%s', d.cantidad*a.factor,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			// calculo_promedio_ventas="0.000";

			if (cad_conjunto_almacenes != " ") {
				instruccion =
					"CREATE TEMPORARY TABLE ventasxmesaux ( producto VARCHAR(8), present VARCHAR(255), \
							   cantidad DECIMAL(12,3), INDEX(producto, present)) ENGINE = INNODB";
				instrucciones[num_instrucciones++] = instruccion;

				archivo_temp10 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("SELECT producto, present, SUM(ventas%d) FROM ventasxmes \
							   WHERE almacen IN (%s) GROUP BY producto,present INTO OUTFILE '%s'"
					, dias, cad_conjunto_almacenes, archivo_temp10);
				instrucciones[num_instrucciones++] = instruccion;

				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE ventasxmesaux ",
					archivo_temp10);
				instrucciones[num_instrucciones++] = instruccion;

				calculo_promedio_ventas = " vxm.cantidad ";
				cadena_join_ventasxmes =
					"inner join ventasxmesaux vxm ON a.producto = vxm.producto AND a.present = vxm.present ";
			}
			else {
				/* calculo_promedio_ventas.sprintf(" ventas%d ",dias);
				 cadena_join_ventasxmes = "inner join ventasxmes vxm ON a.producto = vxm.producto AND \
				 a.present = vxm.present"; */
				calculo_promedio_ventas.sprintf(" (SELECT SUM(ventas%d) FROM ventasxmes WHERE producto= a.producto \
								AND present = a.present GROUP BY producto, present) "
					, dias);
				cadena_join_ventasxmes = " ";
			}
		}
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad, \
			%s as cantvpprom \
			from ventas v %s \
			inner join dventas d  on v.referencia=d.referencia \
			INNER JOIN terminales ter ON ter.terminal=v.terminal\
			INNER JOIN secciones sec ON sec.seccion=ter.seccion \
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal AND suc.idempresa = %s \
			inner join articulos a on d.articulo=a.articulo \
			%s %s %s\
			where %s %s %s %s %s %s %s \
			v.fechavta>@fechacorte and v.fechavta<=@fechafinal and v.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'",
			calculo_promedio_ventas, forzar_indice_vta,empresa, join_presentacion1,
			join_productos, cadena_join_ventasxmes, condicion_almacen,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_fabricante, condicion_segmento,
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux(producto, present, tipo, cantidad, cantvpprom)",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las ventas
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" dv.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		if (considerar_cortes == "0") {
			condicion_devventas.sprintf
				(" ,SUM(IF(n.fechanot>='%s', dn.cantidad*a.factor*-1,0))  AS cantvpprom ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			condicion_devventas = " ,0 AS cantvpprom ";
		}

		instruccion.sprintf(" \
			select a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad \
			%s \
			from notascredcli n \
			inner join dnotascredcli dn on n.referencia=dn.referencia \
			inner join ventas v on n.venta=v.referencia \
			inner join dventas dv on v.referencia=dv.referencia and dv.articulo=dn.articulo \
			inner join articulos a on dn.articulo=a.articulo \
			%s %s \
			where %s %s %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' and n.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'",
			condicion_devventas, join_presentacion1, join_productos,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux(producto, present, tipo, cantidad, cantvpprom) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las entradas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almaent in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'EN' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod, \
			terminales ter,secciones sec, sucursales suc \
			where %s %s %s %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'S' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			AND ter.terminal=m.terminal AND sec.seccion=ter.seccion \
  			AND suc.sucursal=sec.sucursal AND suc.idempresa = %s \
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento,empresa, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los conceptos de movalma que se interpretan como venta para
		// propósito de rotacion de mercancía (ej: calculo de cuanto pedir)
		instruccion.sprintf("SELECT concepto FROM conceptosmovvent");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_conceptosmovvent);
		for (i = 0; i < resp_conceptosmovvent->ObtieneNumRegistros(); i++) {
			resp_conceptosmovvent->IrAlRegistroNumero(i);
			concepto = resp_conceptosmovvent->ObtieneDato("concepto");

			cad_conjunto_conceptos += "'";
			cad_conjunto_conceptos += concepto;
			cad_conjunto_conceptos += "'";
			if (i < resp_conceptosmovvent->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo le signo +.
					cad_conjunto_conceptos += ",";
		}
		condicion_concepto.sprintf(" m.concepto in (%s) and ",
			cad_conjunto_conceptos);

		// Calcula las salidas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod \
			where %s %s %s %s %s %s %s\
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'E' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_fabricante, condicion_segmento, archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {
			archivo_temp16 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				'SV' as tipo,\
				0 as cantidad, \
				(sum(d.cantidad*a.factor)) as cantsalprom \
				from movalma m, dmovalma d, articulos a %s, productos prod \
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>@fechacorte\
				and m.fechamov<=@fechafinal\
				and m.movimiento=d.movimiento \
				AND m.fechamov >= DATE_SUB(@fechafinal, INTERVAL %d DAY)\
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				and a.producto=prod.producto \
				group by a.producto, a.present INTO OUTFILE '%s'",
				join_presentacion1, condicion_almacen, condicion_concepto,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_producto, condicion_fabricante, condicion_segmento,
				dias, archivo_temp16);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad,cantsalprom) ",
				archivo_temp16);
			instrucciones[num_instrucciones++] = instruccion;

			campo_salida.sprintf
				("IFNULL(SUM(IF(e.tipo='SV',e.cantsalprom,0)),0)/%f", divisor);
			campo_salida2 = "IFNULL(SUM(IF(e.tipo='SV',e.cantsalprom,0)),0)";

		}

		// Suma los movimientos para obtener las existencias
		archivo_temp11 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select e.producto, e.present, sum(e.cantidad) as cantidad,  \
				(sum(if(e.tipo='VE' OR e.tipo='DV',e.cantvpprom,0))/%f) as cantvpprom, \
				\
				%s AS cantsalprom,\
				((IFNULL(SUM(if(e.tipo='VE' OR e.tipo='DV',e.cantvpprom,0)),0)+%s)/%f) AS cantvtotprom\
				\
				from existenciasaux e \
				group by e.producto, e.present INTO OUTFILE '%s'", divisor,
			campo_salida, campo_salida2, divisor, archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxexistsumadas ",
			archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los factores minimo y máximo
		archivo_temp12 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, e.cantidad, e.cantvpprom, max(a.factor) as maxfactor, min(a.factor) as minfactor, \
			e.cantvtotprom,\
			e.cantsalprom\
			from auxexistsumadas e, articulos a %s \
			where e.producto=a.producto and e.present=a.present %s \
			group by e.producto, e.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_articulos_inactivos, archivo_temp12);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxexistfinales (producto, present, cantidad, cantvpprom, maxfactor, minfactor,cantvtotprom,cantsalprom)",
			archivo_temp12);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmax=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmin=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			// Obtiene los costos de compra
			archivo_temp13 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT aa.producto, aa.present, MAX(dcc.costoimp)- SUM(ifnull(dnc.costoimp,0)) AS costocompra \
				FROM compras cc INNER JOIN dcompras dcc ON cc.`referencia` = dcc.`referencia` \
				INNER JOIN articulos aa ON dcc.`articulo`=aa.`articulo` \
				INNER JOIN ( \
					SELECT a.producto, a.present, MAX(c.`fechacom`) AS ultimafechacom \
					FROM compras c INNER JOIN dcompras dc ON c.`referencia`=dc.`referencia` \
					INNER JOIN articulos a ON dc.`articulo`=a.`articulo` WHERE c.cancelado=0 %s GROUP BY a.`producto`, a.`present` \
					) ultcompras ON ultcompras.ultimafechacom = cc.`fechacom` \
				AND ultcompras.producto=aa.`producto` AND ultcompras.present=aa.`present` \
				LEFT OUTER JOIN notascredprov nc on nc.compra=cc.referencia and nc.cancelado=0 and nc.tipo<>'0' \
				LEFT OUTER JOIN dnotascredprov as dnc on dnc.referencia=nc.referencia and dnc.articulo=aa.articulo \
				WHERE cc.cancelado=0 GROUP BY aa.`producto`, aa.`present` INTO OUTFILE '%s'"
				, condicion_articulos_inactivos, archivo_temp13);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxcostoscompra ",
				archivo_temp13);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion = " CREATE TEMPORARY TABLE ventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), \
		cantidadmespreant DECIMAL(12,3),cantidadmesant DECIMAL(12,3),cantidadmesact DECIMAL(12,3),   \
		INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp14 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT vm.producto, vm.present,  \
		SUM(vm.cant%s),SUM(vm.cant%s), SUM(vm.cant%s) \
		FROM ventasxmes vm INNER JOIN productos prod ON vm.producto = prod.producto  \
		INNER JOIN almacenes al ON vm.almacen = al.almacen INNER JOIN secciones s ON al.seccion = s.seccion  \
		%s %s %s %s %s %s %s %s %s %s GROUP BY  vm.producto,vm.present INTO OUTFILE '%s'"
			, cad_mes_penant, cad_mes_ant, cad_mes_corresp, join_presentacion3,
			condicion_sucursal, condicion_producto_ventasmes,
			condicion_clasif1_ventasmes, condicion_clasif2_ventasmes,
			condicion_clasif3_ventasmes, condicion_marca,
			condicion_marca_excluir, condicion_fabricante_vtaxmes,
			condicion_segmento_vtaxmes, archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE ventasmesesantaux ",
			archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		// tabla temporal calcula las salidas consideradas ventas e los mese anteriores.
		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {
			conSalxVenxFechaActIni =
				"DATE_SUB(@fechafinal,INTERVAL DAY(@fechafinal)-1 DAY)";
			conSalxVenxFechaActFin = "LAST_DAY(@fechafinal)";
			conSalxVenxFechaAntIni =
				"DATE_SUB(DATE_SUB(@fechafinal,INTERVAL '1' MONTH),INTERVAL DAY(@fechafinal)-1 DAY)";
			conSalxVenxFechaAntFin =
				"LAST_DAY(DATE_SUB(@fechafinal,INTERVAL '1' MONTH))";
			conSalxVenxFechaPreAntIni =
				"DATE_SUB(DATE_SUB(@fechafinal,INTERVAL '2' MONTH),INTERVAL DAY(@fechafinal)-1 DAY)",
				conSalxVenxFechaPreAntFin =
				"LAST_DAY(DATE_SUB(@fechafinal,INTERVAL '2' MONTH))";

			// MesAcual
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesesactaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmesact DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp17 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s\
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaActIni,
				conSalxVenxFechaActFin, archivo_temp17);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesesactaux ",
				archivo_temp17);
			instrucciones[num_instrucciones++] = instruccion;

			// MesAnterior
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmesant DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp18 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s\
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaAntIni,
				conSalxVenxFechaAntFin, archivo_temp18);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesesantaux ",
				archivo_temp18);
			instrucciones[num_instrucciones++] = instruccion;

			// MesPreAnterior
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesespreantaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmespreant DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp19 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s\
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaPreAntIni,
				conSalxVenxFechaPreAntFin, archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesespreantaux "
				, archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;

			condicion_salidasVentasxMes.sprintf("LEFT JOIN salidasventasmesesactaux svmact ON svmact.producto=prod.producto AND svmact.present=present.present\
			LEFT JOIN salidasventasmesesantaux svmant ON svmant.producto=prod.producto AND svmant.present=present.present\
			LEFT JOIN salidasventasmesespreantaux svmpant ON svmpant.producto=prod.producto AND svmpant.present=present.present"
				);

			campo_svxmact = "+IFNULL(svmact.cantidadmesact,0)";
			campo_svxmant = "+IFNULL(svmant.cantidadmesant,0)";
			campo_svxmpant = "+IFNULL(svmpant.cantidadmespreant,0)";
		}

		// condición mostrar solo DESCONTINUADOS
        bool banderaHvg = false;
		bool banderaHvgEmp = false;
		// condición mostrar solo DESCONTINUADOS
		if(empresa != " " && sucursal != " " && soloDescontinuados == "1"){ //empresa + sucursal + solo descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) =1";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}else if(empresa != " " && sucursal != " " && soloDescontinuados == "0" ){ // empresa + sucursal + excluir descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) =0";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}else if(soloDescontinuados == "-1" && empresa != " " && sucursal == " "){ //empresa
			condicion_soloDescontinuados = " ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1 AND suc.idempresa = %s) AS descontinuado, ", empresa);
		}else if(soloDescontinuados == "1" && empresa != " " && sucursal == " "){ // empresa + solo descontinuados
			condicion_soloDescontinuados = " AND ap.descontinuado = 1 ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1 AND suc.idempresa = %s) AS descontinuado,", empresa);
				banderaHvgEmp = true;
		}else if(soloDescontinuados == "0" && empresa != " " && sucursal == " "){ // empresa + excluir descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) = 0";
			banderaHvg = true;
			condicionDescNw =
			"(SELECT COUNT(*) FROM articulosped ap WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1) AS descontinuado,";
		}else{ // empresa + sucursal
			condicion_soloDescontinuados = " ";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}

		if(banderaHvgEmp == true && stock == " "){
			condicionHav = " HAVING descontinuado <> 0 ";
		}else if(banderaHvgEmp == true && stock != " "){
			condicionHav = " AND descontinuado <> 0 ";
		}
		else if (banderaHvg == true) {
			if(condicion_stock == " "){
				condicionHav = " HAVING descontinuado =0 ";
			}else{
				condicionHav = " and descontinuado =0 ";
			}
		}
		else {
			condicionHav = " ";
		}

		// verificar si la sucursal esta vacia o no
		if (sucursal != " ") {
			condicion_descontinuado.sprintf
				("LEFT JOIN articulosped ap ON ap.producto=prod.producto AND ap.present=present.present and ap.sucursal='%s' ",
				sucursal);
			// condicion_sucursal
		}
		if (sucursal == " ") { // agrd sust. cod abaj
			condicion_descontinuado.sprintf
				("LEFT JOIN articulosped ap ON ap.producto=prod.producto AND ap.present=present.present"
				);
		}
		/* else {
		 instruccion = " CREATE TEMPORARY TABLE artdescontinuadosaux ( producto VARCHAR(8), present VARCHAR(255), \
		 descontinuado TINYINT(4),   \
		 INDEX(producto, present)) ENGINE = INNODB";
		 instrucciones[num_instrucciones++] = instruccion;

		 archivo_temp15 = mServidorVioleta->ObtieneArchivoTemp
		 (num_instrucciones, Respuesta->Id);
		 instruccion.sprintf("SELECT producto, present, descontinuado from articulosped GROUP BY producto, present \
		 INTO OUTFILE '%s'", archivo_temp15);
		 instrucciones[num_instrucciones++] = instruccion;

		 instruccion.sprintf
		 ("LOAD DATA INFILE '%s' INTO TABLE artdescontinuadosaux ",
		 archivo_temp15);
		 instrucciones[num_instrucciones++] = instruccion;

		 condicion_descontinuado.sprintf
		 ("LEFT JOIN artdescontinuadosaux ap ON ap.producto=prod.producto AND ap.present=present.present "
		 );
		 } */

		inner_empleadosupervisor.sprintf(" LEFT JOIN articulossupervisados ars ON ars.producto=prod.producto and ars.present=present.present \
									   LEFT JOIN empleados emp on emp.empleado=ars.usuario "
			);
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado "
			);

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf(" and ars.usuario='%s' ",
				empleadosupervisor);
		}
		else {
			// inner_empleadosupervisor = "  ";
			// campo_supervisado = "  ";
			condicion_empleadosupervisor = " ";
		}

		instruccion = "CREATE or replace TEMPORARY TABLE ubicacionarticulosaux (\
					SELECT\
					aubi.producto,\
					aubi.present,\
					MIN(CONCAT_WS('-', acl.almacen, acl.nombrecalle, afr.numfrente, apos.nivel, apos.fondo)) AS ubicacionart\
					FROM almacenposarticulos aubi\
					INNER JOIN almacenposiciones apos ON aubi.idalmposicion = apos.idalmposicion\
					INNER JOIN almacenfrentes afr ON apos.idalmfrente = afr.idalmfrente\
					INNER JOIN almacencalles acl ON afr.idalmcalle = acl.idalmcalle\
					GROUP BY aubi.producto, aubi.present\
					)";
        instrucciones[num_instrucciones++] = instruccion;
		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			mServidorVioleta->BorraArchivoTemp(archivo_temp7);
			mServidorVioleta->BorraArchivoTemp(archivo_temp8);
			mServidorVioleta->BorraArchivoTemp(archivo_temp9);
			mServidorVioleta->BorraArchivoTemp(archivo_temp10);
			mServidorVioleta->BorraArchivoTemp(archivo_temp11);
			mServidorVioleta->BorraArchivoTemp(archivo_temp12);
			if (costoscompra == 1)
				mServidorVioleta->BorraArchivoTemp(archivo_temp13);
			mServidorVioleta->BorraArchivoTemp(archivo_temp14);
			if (sucursal == " ")
				mServidorVioleta->BorraArchivoTemp(archivo_temp15);
			if (consider_salidas_ventas == "1")
				mServidorVioleta->BorraArchivoTemp(archivo_temp16);
			// Salidas consideradas ventas
			mServidorVioleta->BorraArchivoTemp(archivo_temp17);
			// Salidas consideradas ventas del mes actual
			mServidorVioleta->BorraArchivoTemp(archivo_temp18);
			// Salidas consideradas ventas del mes anterior
			mServidorVioleta->BorraArchivoTemp(archivo_temp19);
			// Salidas consideradas ventas del mes preanterior

			// Resultado final
			instruccion.sprintf("select IF(amin.activo=1,prod.nombre,CONCAT(prod.nombre ,' (inactivo)') ) as nomproducto , e.producto, e.present, \
				truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, \
				(@resto/e.minfactor) as cantmin, \
				e.multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				truncate(ifnull(s.minimo,0)/e.maxfactor,0) as minimomax, truncate(ifnull(s.maximo,0)/e.maxfactor,0) as maximomax, truncate(ifnull(s.reorden,0)/e.maxfactor,0) as reordenmax, \
				ifnull(s.minimo,0) as minimotot, ifnull(s.maximo,0) as maximotot, ifnull(s.reorden,0) as reordentot, \
				mod(ifnull(s.minimo,0), e.maxfactor) as minimounid, mod(ifnull(s.maximo,0), e.maxfactor) as maximounid, mod(ifnull(s.reorden,0), e.maxfactor) as reordenunid, \
				((pcb.costobase*e.cantidad)/(e.cantidad/e.maxfactor)) as costo, \
				truncate(e.cantvpprom/e.maxfactor,0) as cantmaxvp, \
				@restovp:=mod(e.cantvpprom, e.maxfactor) as restovp, \
				(@restovp/e.minfactor) as cantminvp, \
				e.cantvpprom, \
				a.articulo as articulo, \
				pcb.costobase as costounitario, \
				(pcb.costobase*e.maxfactor) as costobasexmultmay, \
				amin.activo, \
				TRUNCATE((vma.cantidadmespreant%s) / e.maxfactor, 0) AS cantmaxmespreant, MOD((vma.cantidadmespreant%s), e.maxfactor) AS restomespreant,  \
				TRUNCATE((vma.cantidadmesant%s) / e.maxfactor, 0) AS cantmaxmesant, MOD((vma.cantidadmesant%s), e.maxfactor) AS restomesant,      \
				TRUNCATE((vma.cantidadmesact%s) / e.maxfactor, 0) AS cantmaxmesact, MOD((vma.cantidadmesact%s), e.maxfactor) AS restomesact   \
				%s \
				,a2.ean13  AS codbarMay, a1.ean13 AS codbarMin, %s \
				\
				truncate(e.cantvtotprom/e.maxfactor,7) as cantmaxvtotp, \
				@restovtotprom:=mod(e.cantvtotprom, e.maxfactor) as restovtotp, \
				(@restovtotprom/e.minfactor) as cantminvtotp, \
				\
				\
				truncate(e.cantsalprom/e.maxfactor,0) as cantmaxsalp, \
				@restosal:=mod(e.cantsalprom, e.maxfactor) as restosalp, \
				(@restosal/e.minfactor) as cantminsalp \
				\
				%s \
				%s \
				, uart.ubicacionart \
				from auxexistfinales e  inner join  productos prod  inner join  presentaciones present \
				inner join presentacionescb pcb \
				left join auxstockagrup s ON e.producto=s.producto and e.present=s.present \
				left join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo  \
				left join articulos amin on e.producto=amin.producto and e.present=amin.present and e.multmin=amin.multiplo  \
				LEFT JOIN ventasmesesantaux vma ON vma.producto = e.producto AND vma.present = e.present \
				%s \
				INNER JOIN presentacionesminmax pmm ON present.producto=pmm.producto AND present.present = pmm.present \
				%s \
				%s \
				left join articulos a1 on a1.producto=prod.producto and a1.present=present.present \
				AND a1.multiplo=pmm.minmult \
				left join articulos a2 on a2.producto=prod.producto and a2.present=present.present \
				AND a2.multiplo=pmm.maxmult \
				%s \
				%s \
				%s \
				%s \
				%s \
				LEFT JOIN ubicacionarticulosaux uart ON a.producto = uart.producto AND a.present = uart.present\
				LEFT JOIN presentacionesactivemp pemp ON pemp.producto=pcb.producto AND pemp.present=pcb.present AND pemp.idempresa = %s\
				where \
				 prod.producto=e.producto and e.producto=present.producto and \
				 e.present=present.present and \
				 pcb.producto=present.producto and pcb.present=present.present and \
				 pcb.idempresa=%s %s %s %s %s %s %s %s \
				 AND (e.cantidad > 0 OR pemp.activo=1 OR pemp.activo IS NULL)\
				GROUP BY e.producto, e.present \
				 %s \
                 %s\
				order by nomproducto, e.present ", campo_svxmpant,
				campo_svxmpant, campo_svxmant, campo_svxmant, campo_svxmact,
				campo_svxmact, camposcostoscompra, condicionDescNw,
				campo_supervisado, campocostoprom, leftcostoscompra,
				inner_artactxsuc, inner_provcompras, leftcostoprom,
				condicion_descontinuado, condicion_salidasVentasxMes,
				join_art_tags, inner_empleadosupervisor,empresa,
				FormServidor->ObtieneClaveEmpresa(), condicion_marca,
				condicion_marca_excluir, presentaciones_cotizables,
				presentaciones_sup_gerencia, condicion_art_tags,
				condicion_soloDescontinuados, condicion_empleadosupervisor,
				condicion_stock, condicionHav);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_sucursales != NULL)
			delete resp_sucursales;
		if (resp_conceptosmovvent != NULL)
			delete resp_conceptosmovvent;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPEXISTENCIAS_SIMPLE_OPT
void ServidorReportes::EjecutaRepExistenciasSimpleOpt
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo, considerar_cortes;
	AnsiString fecha;
	AnsiString almacen, stock, marca, producto, almacenMultMax;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos;
	AnsiString condicion_almacen = " ", condicion_stock = " ", condicion_marca =
		" ", condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ";
	AnsiString join_productos = " ";
	AnsiString calculo_promedio_ventas;
	TDate fecha_inicial_promedio;
	int dias, tipopromedio;
	AnsiString forzar_indice_vta = " ";
	AnsiString sucursal;
	AnsiString cad_conjunto_almacenes = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6, archivo_temp7;
	AnsiString archivo_temp8, archivo_temp9, archivo_temp10, archivo_temp11,
		archivo_temp12, archivo_temp13, archivo_temp14;
	AnsiString archivo_temp15;
	AnsiString archivo_temp16;
	double divisor;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursales = NULL;
	int costoscompra;
	int exixtenciascero = 0;
	AnsiString camposcostoscompra = " ", leftcostoscompra = " ";
	AnsiString condicion_sucursal, condicion_sucursal_stock,
		condicion_producto_ventasmes = " ";
	AnsiString condicion_clasif1_ventasmes = " ", condicion_clasif2_ventasmes =
		" ", condicion_clasif3_ventasmes = " ";
	AnsiString condicion_devventas = " ";
	TDate fecha_hoy = Today();
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes actual
	int mes_ant = (mes_actual + 24) - 1; // Mes anterior
	int mes_penant = (mes_actual + 24) - 2; // Mes penultimo anterior
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_mes_ant = mFg.IntToAnsiString(mes_ant);
	AnsiString cad_mes_penant = mFg.IntToAnsiString(mes_penant);
	AnsiString marca_excluir, condicion_marca_excluir = " ",
		presentaciones_cotizables = " ", presentaciones_sup_gerencia = " ";
	AnsiString prov_historico, meses;
	AnsiString inner_provcompras = " ", condicion_meses = " ";
	AnsiString fabricante, condicion_fabricante = " ", join_fabricante = " ",
		condicion_fabricante_vtaxmes = " ";
	AnsiString segmento, condicion_segmento = " ", join_segmento = " ",
		condicion_segmento_vtaxmes = " ";
	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString condicion_descontinuado = " ";

	AnsiString condicion_almacen_vta2 = " ", condicion_almacen_vta = " ",
		condicion_almacen_dv = " ", condicion_almacen_sv = " ",
		calculo_promedio_devventas,condicion_almacen_vta3=" ";
	AnsiString condicion_producto2 = " ";
	AnsiString inner_join_salida = " ", campo_salida = "0", campo_salida2 = "0",
		condicion_suc = " ", condicion_suc2 = " ", condicion_producto_pmm = " ";
	AnsiString join_productos2 = " ";
	AnsiString artactxsuc;
	AnsiString inner_artactxsuc = " ";
	AnsiString listaTags, join_art_tags = " ", condicion_art_tags = " ";

	AnsiString soloDescontinuados = "", condicion_soloDescontinuados = "";
	// Opción solo descontinuados
	AnsiString consider_salidas_ventas; // Opción considerar salidas

	TStringList* mListaTags = new TStringList();

	BufferRespuestas* resp_conceptosmovvent = NULL;
	// Conceptos de salida considerados ventas
	AnsiString concepto;
	AnsiString cad_conjunto_conceptos = " ";
	AnsiString calculo_promedio_salidas;
	AnsiString condicion_concepto = " ";

	AnsiString archivo_temp17;
	// archivo temporal de salidas consideradas ventas de mes actual
	AnsiString archivo_temp18;
	// archivo temporal de salidas consideradas ventas de mes anterior
	AnsiString archivo_temp19;
    AnsiString archivo_temp20, archivo_temp21;
	// archivo temporal de salidas consideradas ventas de mes preanterior
	AnsiString consultaSalxVentasxFechaAct = " ", consultaSalxVentasxFechaAnt =
		" ", consultaSalxVentasxFechaPreAnt = " ", conSalxVenxFechaActIni = " ",
		conSalxVenxFechaActFin = " ";
	AnsiString conSalxVenxFechaAntIni = " ", conSalxVenxFechaAntFin = " ",
		conSalxVenxFechaPreAntIni = " ", conSalxVenxFechaPreAntFin = " ";
	AnsiString fechaInicioSalxVent = " ", fechaFinSalxVent = " ";
	AnsiString condicion_producto_ventasxsalidasmes = " ";
	AnsiString condicion_salidasVentasxMes = " ";
	AnsiString campo_svxmact = " ", campo_svxmant = " ", campo_svxmpant = " ";

	AnsiString supervisado = "", empleadosupervisor = " ";
	AnsiString condicion_empleadosupervisor = " ", inner_empleadosupervisor =
		" ", campo_supervisado = " ";

	AnsiString condicion_clasif1_pmm = " ", condicion_clasif2_pmm = " ",
		condicion_clasif3_pmm = " ", condicion_fabricante_pmm = " ",
		condicion_segmento_pmm = " ";
	AnsiString campocostoprom = " ", leftcostoprom = " ";
	AnsiString condicionDescNw = " ", condicionHav = "";
	AnsiString condicion_almacen_mulmax = " ";
	bool bandExist = false;
	AnsiString fechaResF, fechaResFglon;

	AnsiString idEmpresa = " ", empresa = " ", cadena_sucursal_empresa = " ", join_presentacionesactivemp = " ";
	AnsiString join_terminales_auxventasdev = " ", join_secciones_auxventasdev = " ";
    AnsiString subqry_join_almacenes_auxventasdev = " ", subqry_join_secciones_auxventasdev = " ";

	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		stock = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		dias = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		tipopromedio = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		idEmpresa = FormServidor->ObtieneClaveEmpresa();

		//// 2023 agr
		if(considerar_cortes == "0"){
			BufferRespuestas* resp_n = NULL;
			BufferRespuestas* resp_n2 = NULL;
			AnsiString fech, resultEstGlob, resultPuntCort;
			try {
				//instruccion = "select max(p.fecha) as fcorte from puntoscorte p where p.fecha<= '"+fecha+"'";
				instruccion.sprintf("SELECT IFNULL(MAX(p.fecha),'1900-01-01') AS fcorte \
				FROM puntoscorte p \
				WHERE p.fecha<='%s' \
				UNION \
				SELECT IFNULL(MAX(p.fecha),'1900-01-01') AS fcorte \
				FROM puntoscorte p \
				WHERE p.fecha>= '%s'",fecha, fecha);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n);
				int numeroReg = resp_n->ObtieneNumRegistros();
				resultPuntCort = resp_n->ObtieneDato("fcorte");
				AnsiString datU, datD;
				for (int i = 0; i < numeroReg; i++) {
					if(i==0)
						datU = resp_n->ObtieneDato("fcorte");
					if(i!=0)
						datD = resp_n->ObtieneDato("fcorte");
                    resp_n->IrAlSiguienteRegistro();
				}
				if(resultPuntCort == " ")
					resultPuntCort="1900-01-01";

				//instruccion = "SELECT valor FROM estadosistemaglob WHERE estado ='FCORTEINI'";
				instruccion.sprintf("SELECT IFNULL(valor, '2000-01-01') AS val \
				FROM estadosistemaglob \
				WHERE estado = 'FCORTEINI'");
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n2);
				resultEstGlob = resp_n2->ObtieneDato("val");
				fechaResFglon = resp_n2->ObtieneDato("val");
				if(resultEstGlob == "")
					resultEstGlob = "1900-01-01";

				 TDateTime resultDFech, resultDPc, resultDEg, resultU, resultD;
				 int difpc, difeg, difU, difD;
				 int a, m ,d;
				 if(sscanf(fecha.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDFech= EncodeDate(a,m,d);
				 ///
                 if(sscanf(datU.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultU= EncodeDate(a,m,d);
				 if(sscanf(datD.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultD= EncodeDate(a,m,d);
				 difU = DaysBetween(resultDFech,resultU);
				 difD = DaysBetween(resultDFech,resultD);
				 if(difU < difD)
					resultPuntCort=datU;//difU;
				 else
					resultPuntCort=datD;//difD;
				 ///
				 if(sscanf(resultPuntCort.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDPc= EncodeDate(a,m,d);
				 if(sscanf(resultEstGlob.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3)
					resultDEg= EncodeDate(a,m,d);
				 difpc = DaysBetween(resultDFech,resultDPc);
				 difeg = DaysBetween(resultDFech,resultDEg);
				 if(difpc < difeg){
					//fecha = difpc;
					bandExist=false; //pc
					fechaResF = resultPuntCort;
				 } else{
					//fecha = difeg;
					fechaResF = resultEstGlob;
					bandExist=true; //eglob
				 }
			}
			__finally {
				if (resp_n != NULL)
					delete resp_n;
				if (resp_n2 != NULL)
					delete resp_n2;
			}
		}
		///// fin agr prb 2023

		if (tipopromedio == 0) {
			divisor = dias / 30.5;
		}
		if (tipopromedio == 1) {
			divisor = dias / 15;
		}
		if (tipopromedio == 2) {
			divisor = dias / 7;
		}
		if (tipopromedio == 3) {
			divisor = dias / 1;
		}
		costoscompra = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		if (costoscompra == 1) {
			camposcostoscompra = " , acc.costocompra ";
			leftcostoscompra =
				" left join auxcostoscompra acc ON acc.producto=s.producto and acc.present=s.present ";
			campocostoprom =
				" , (costprom.costounit * pmm.maxfactor) AS costoprom ";
			leftcostoprom.sprintf(
				" LEFT JOIN precalculocostospromedio%s costprom ON costprom.producto = pmm.producto and costprom.present=pmm.present",
				FormServidor->ObtieneClaveEmpresa());
		}
		marca_excluir = mFg.ExtraeStringDeBuffer(&parametros);
		presentaciones_cotizables = mFg.ExtraeStringDeBuffer(&parametros);
		presentaciones_sup_gerencia = mFg.ExtraeStringDeBuffer(&parametros);

		prov_historico = mFg.ExtraeStringDeBuffer(&parametros);
		meses = mFg.ExtraeStringDeBuffer(&parametros);

		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);

		artactxsuc = mFg.ExtraeStringDeBuffer(&parametros);

		listaTags = mFg.ExtraeStringDeBuffer(&parametros);

		// Guarda variable "Solo  descontinuados"
		soloDescontinuados = mFg.ExtraeStringDeBuffer(&parametros);

		// Guarda variable "Contar salidas por traspasos para prom. de ventas
		consider_salidas_ventas = mFg.ExtraeStringDeBuffer(&parametros);

		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);

        //Almacen asignado para multiplo mayor
		almacenMultMax = mFg.ExtraeStringDeBuffer(&parametros);

		if (presentaciones_cotizables == "1")
			presentaciones_cotizables = " AND present.cotizable=1 ";
		else
			presentaciones_cotizables = " ";

		if (presentaciones_sup_gerencia == "1")
			presentaciones_sup_gerencia = " AND present.sgerencia=1 ";
		else
			presentaciones_sup_gerencia = " ";

		// fecha_inicial_promedio=IncMonth(mFg.MySqlDateToTDate(fecha.c_str()), meses*-1);
		fecha_inicial_promedio = mFg.MySqlDateToTDate(fecha.c_str()) - dias;

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" WHERE s.sucursal='%s' ", sucursal);
			condicion_sucursal_stock.sprintf(" WHERE sucursal='%s' ", sucursal);
			condicion_suc.sprintf(" AND pre.sucursal = '%s' ", sucursal);
			condicion_suc2.sprintf(" AND pre.sucursal = '%s' ", sucursal);
            cadena_sucursal_empresa="'"+sucursal+"'";
		}
		else {
			AnsiString cadena_sucursal = "";
			if(empresa == " "){
				instruccion.sprintf("SELECT sucursal FROM sucursales");
			} else {
				instruccion.sprintf("SELECT sucursal FROM sucursales where idempresa = %s",empresa);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_sucursales);
			for (i = 0; i < resp_sucursales->ObtieneNumRegistros(); i++) {

				resp_sucursales->IrAlRegistroNumero(i);

				if (i != resp_sucursales->ObtieneNumRegistros() - 1)
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "',";
				else
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "'";

			}

			condicion_sucursal.sprintf(" WHERE s.sucursal IN(%s) ",
				cadena_sucursal);
			condicion_sucursal_stock.sprintf(" WHERE sucursal IN(%s) ",
				cadena_sucursal);
			condicion_suc.sprintf(" WHERE sucursal IN(%s) ", cadena_sucursal);
			condicion_suc2.sprintf(" AND pre.sucursal IN(%s) ",
				cadena_sucursal);
			cadena_sucursal_empresa=cadena_sucursal;
		}

		if (stock != " ") {
			if (stock == "0") {
				condicion_stock.sprintf("having e.cantidad<0 ");
			}
			if (stock == "1") {
				condicion_stock.sprintf("having e.cantidad>0 ");
			}
			if (stock == "2") {
				condicion_stock.sprintf("having e.cantidad= %d ",
					exixtenciascero);
			}
			if (stock == "3") {
				condicion_stock.sprintf("having e.cantidad<minimotot ");
			}
			if (stock == "4") {
				condicion_stock.sprintf("having e.cantidad<reordentot ");
			}
			if (stock == "5") {
				condicion_stock.sprintf("having e.cantidad>maximotot ");
			}
			if (stock == "6") {
				condicion_stock.sprintf
					("having e.cantidad!=0 AND amin.activo=0 ");
			}
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
			condicion_clasif1_pmm.sprintf(" AND prod.clasif1='%s' ", clasif1);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif1_ventasmes.sprintf(" AND prod.clasif1='%s' ",
				clasif1);
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			condicion_clasif2_pmm.sprintf(" AND prod.clasif2='%s' ", clasif2);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif2_ventasmes.sprintf(" AND prod.clasif2='%s' ",
				clasif2);
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			condicion_clasif3_pmm.sprintf(" AND prod.clasif3='%s' ", clasif3);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif3_ventasmes.sprintf(" AND prod.clasif3='%s' ",
				clasif3);
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";
		}
		if (marca != " ") {
			condicion_marca.sprintf(" AND prod.marca='%s'  ", marca);
		}
		if (marca_excluir == "1") {
			// Se obtienen todas las marcas para excluirlas
			BufferRespuestas* resp_n = NULL;
			AnsiString marcasExcluir;
			int cantMarcas = 0;
			try {
				instruccion = "SELECT marca FROM marcasexistsim ";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n);

				cantMarcas = resp_n->ObtieneNumRegistros();
				for (i = 0; i < resp_n->ObtieneNumRegistros(); i++) {
					if (i == resp_n->ObtieneNumRegistros() - 1)
						marcasExcluir +=
							"'" + resp_n->ObtieneDato("marca") + "'";
					else
						marcasExcluir +=
							"'" + resp_n->ObtieneDato("marca") + "',";

					resp_n->IrAlSiguienteRegistro();
				}

			}
			__finally {
				if (resp_n != NULL)
					delete resp_n;
			}

			if (cantMarcas > 0)
				condicion_marca_excluir.sprintf(" AND prod.marca NOT IN(%s)",
				marcasExcluir);
			else
				condicion_marca_excluir.sprintf(" ");
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_producto_ventasmes.sprintf(" AND prod.producto='%s' ",
				producto);
			condicion_producto2.sprintf(" AND producto='%s' ", producto);
			condicion_producto_pmm.sprintf(" AND pmm.producto = '%s' ",
				producto);
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";
			condicion_producto_ventasxsalidasmes.sprintf(" a.producto='%s' AND",
				producto);
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (prov_historico == " ") {
			inner_provcompras = " ";
		}
		else {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha, meses, fecha);
			}
			else {
				condicion_meses = " ";
			}
			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present",
				AnsiString(prov_historico).c_str(), condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			inner_provcompras.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pppca.producto=a.producto AND pppca.present=a.present "
				);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
			condicion_fabricante_pmm.sprintf(" AND prod.fabricante='%s' ",
				fabricante);
			join_productos.sprintf
				(" inner join productos prod on a.producto=prod.producto ");
			condicion_fabricante_vtaxmes.sprintf(" AND prod.fabricante='%s' ",
				fabricante);
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";
		}


		// Usaremos el segmento de presentacion
		if (segmento != " ") {

			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);
			condicion_segmento_pmm.sprintf(" AND pcb.segmento='%s' ",
				segmento);
			condicion_segmento_vtaxmes.sprintf(" AND pcb.segmento='%s' ",
				segmento);

			join_productos.sprintf
				(" inner join productos prod on a.producto=prod.producto ");
			join_productos2 =
				" inner join productos prod on pmm.producto=prod.producto ";

			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=a.producto AND present.present=a.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;
			// 1 y 4 y 5
			join_presentacion2 =
				" INNER JOIN presentaciones present ON present.producto=pmm.producto  AND present.present=pmm.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;
			// 2
			join_presentacion3 =
				" INNER JOIN presentaciones present ON  vm.producto=present.producto AND vm.present=present.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+empresa;
			// 3

			join_productos =
				" inner join productos prod on a.producto=prod.producto ";

		}

		if (artactxsuc != "0") {
			inner_artactxsuc.sprintf
				("INNER JOIN articulosxsuc axsuc ON a.producto = axsuc.producto AND a.present = axsuc.present AND axsuc.sucursal IN ('%s')",
				sucursal);
		}

		if (listaTags != " ") {

			// mListaTags->Delimiter = '|';
			// mListaTags->DelimitedText = listaTags;
			join_art_tags.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags.sprintf(" AND artt.idarticulotag in (%s) ",
				listaTags);
		}

		inner_empleadosupervisor.sprintf(" LEFT JOIN articulossupervisados ars ON ars.producto=prod.producto and ars.present=present.present \
										   LEFT JOIN empleados emp on emp.empleado=ars.usuario "
			);
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado "
			);

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf(" AND ars.usuario='%s' ",
				empleadosupervisor);
		}
		else {
			// inner_empleadosupervisor = "  ";
			// campo_supervisado = "  ";
			condicion_empleadosupervisor = " ";
		}

		if (almacenMultMax != " ") {
			condicion_almacen_mulmax.sprintf(" INNER JOIN articuloxseccion axs ON axs.articulo = a2.articulo AND axs.almacen = '%s'",
				almacenMultMax);
		} else {
            condicion_almacen_mulmax = " ";
        }

		if (empresa == " ") {
			  join_presentacionesactivemp.sprintf("LEFT JOIN presentacionesactivemp pemp\
												  ON pemp.producto=pcb.producto AND pemp.present=pcb.present");
		} else {
			  join_presentacionesactivemp.sprintf("LEFT JOIN presentacionesactivemp pemp\
												  ON pemp.producto=pcb.producto AND pemp.present=pcb.present\
												  AND pemp.idempresa = %s", empresa);
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		if (considerar_cortes == "1") {
			forzar_indice_vta = " force index(fechavta)";
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'", fecha);
		}
		else { //cuando se ignoren los cortes -> no se debe ignorar existencias iniciales
			if( fechaResFglon == "2000-01-01"){
				instruccion.sprintf("set @fechacorte='1900-01-01'");
				bandExist=false;//true;
			}else{
				instruccion.sprintf("set @fechacorte='%s'", fechaResF);
				bandExist=true;
			}//agr prb
		}
		instrucciones[num_instrucciones++] = instruccion;

		// Sección de optimización
		if (producto != " " || clasif3 != " " || clasif2 != " ") {
			// Si probablemente pueda servirnos más los indices de productos,
			// entonces evitamos forzar el indice de ventas, y dejamos que mysql decida.
			forzar_indice_vta = " ";
		}

		// Crea una tabla donde se pondrá el stock de los almacenes relacionados al reporte
		instruccion = "create temporary table auxstockagrup (producto varchar(8), present varchar(255), \
			minimo int(9), \
			maximo int(9), \
			reorden int(9), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			// Crea una tabla donde se pondrán los costos de compra
			instruccion =
				"create temporary table auxcostoscompra (producto varchar(8), present varchar(255), \
				costocompra decimal(12,3), INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;
		}

		// Calcula el stock.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" where almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select producto, present,        \
									sum(minimo) as minimo,    \
									sum(maximo) as maximo,    \
									sum(reorden) as reorden   \
							 from stock 	%s 			      \
									group by producto, present INTO OUTFILE '%s' "
			, condicion_sucursal_stock, archivo_temp6);

		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxstockagrup ",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		if (cad_conjunto_almacenes != " ") {

			condicion_almacen_vta2.sprintf(" AND almacen in (%s) ",
				cad_conjunto_almacenes);
			condicion_almacen_vta.sprintf(" d.almacen in (%s) and ",
				cad_conjunto_almacenes);

			condicion_almacen_dv.sprintf(" dv.almacen in (%s) and ",
				cad_conjunto_almacenes);

			condicion_almacen_sv.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);

			condicion_almacen_vta3.sprintf(" and alm.almacen in (%s) ",cad_conjunto_almacenes);
		}

		if (considerar_cortes == "0") {
			calculo_promedio_devventas.sprintf
				("SUM(IF(n.fechanot>='%s', dn.cantidad*a.factor*-1,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			calculo_promedio_devventas = "0.000";
		}

		instruccion = " CREATE TEMPORARY TABLE auxventasdev (producto VARCHAR(8), present VARCHAR(255), cantvpprom DOUBLE, \
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_ventas.sprintf
				(" sum(if(v.fechavta>='%s', d.cantidad*a.factor,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
			if (empresa != " " && sucursal == " " && almacen == " ") {
				join_terminales_auxventasdev.sprintf("INNER JOIN terminales ter ON v.terminal = ter.terminal");
				join_secciones_auxventasdev.sprintf("INNER JOIN secciones sec ON ter.seccion = sec.seccion AND sec.sucursal IN(%s)", cadena_sucursal_empresa);
				subqry_join_almacenes_auxventasdev.sprintf("INNER JOIN almacenes alm ON alm.almacen=v.almacen");
				subqry_join_secciones_auxventasdev.sprintf("INNER JOIN secciones sec ON sec.seccion=alm.seccion AND sec.sucursal IN(%s)", cadena_sucursal_empresa);
			}

			instruccion.sprintf("                                                                    \
					SELECT                                                                                   \
						t.producto,                                                                          \
						t.present,                                                                           \
						SUM(t.cantvpprom)                                                                    \
					FROM (                                                                                   \
						   (                                                                                 \
							SELECT                                                                			 \
								  a.producto,                                                                \
								  a.present,                                                                 \
								  %s AS cantvpprom                                                 			 \
							FROM ventas v %s                                                                 \
							INNER JOIN dventas d ON v.referencia=d.referencia                                \
							INNER JOIN articulos a ON d.articulo=a.articulo                                  \
							%s %s                                                                               \
							LEFT JOIN (                                                                      \
										SELECT SUM(ventas%d) AS cantidad, producto, present 				 \
										FROM ventasxmes v \
                                        %s %s \
										WHERE 1 %s 											 \
										GROUP BY producto, present                                           \
							) vxm ON a.producto = vxm.producto AND a.present = vxm.present                   \
                            %s %s\
							WHERE                                                                            \
									%s                                                                       \
									%s	                                                                     \
									%s                                                                       \
									%s                                                                       \
									%s                                                                       \
									%s                                                                       \
									%s                                                                       \
									v.fechavta>@fechacorte                                                   \
									AND v.fechavta<=@fechafinal                                              \
									AND v.cancelado=0                                                        \
							GROUP BY a.producto, a.present                                                   \
							)                                                                                \
							UNION ALL                                                                        \
							(                                                                                \
							 SELECT                                                     					 \
								a.producto,                                                                  \
								a.present,                                                                   \
								%s AS cantvpprom                                                             \
							 FROM notascredcli n                                                             \
							 INNER JOIN dnotascredcli dn ON n.referencia=dn.referencia                       \
							 INNER JOIN ventas v ON n.venta=v.referencia                                     \
							 INNER JOIN dventas dv ON v.referencia=dv.referencia AND dv.articulo=dn.articulo \
							 INNER JOIN articulos a ON dn.articulo=a.articulo                                \
							 %s %s %s %s                                                                             \
							 WHERE                                                                           \
								%s                                                                           \
								%s                                                                           \
								%s                                                                           \
								%s                                                                           \
								%s                                                                           \
								%s                                                                           \
								%s                                                                           \
								n.fechanot>@fechacorte                                                       \
								AND n.fechanot<=@fechafinal                                                  \
								AND n.tipo='0'                                                               \
								AND n.cancelado=0                                                            \
							 GROUP BY a.producto, a.present                                                  \
							)                                                                                \
						 ) t                                                                              	 \
						 GROUP BY t.producto, t.present INTO OUTFILE '%s'",
				calculo_promedio_ventas, forzar_indice_vta, join_presentacion1,
				join_productos, dias, subqry_join_almacenes_auxventasdev,
				subqry_join_secciones_auxventasdev, condicion_almacen_vta2,
				join_terminales_auxventasdev, join_secciones_auxventasdev,
				condicion_producto, condicion_almacen_vta, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento,

				calculo_promedio_devventas, join_presentacion1, join_productos,
                subqry_join_almacenes_auxventasdev, subqry_join_secciones_auxventasdev,
				condicion_producto, condicion_almacen_dv, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;
		}
		else {
			calculo_promedio_ventas = " vxm.cantidad ";
			if ((empresa != " " && sucursal != " ") || (empresa == " " && sucursal != " ") || (empresa != " " && sucursal == " " && almacen != " " )) {
				instruccion.sprintf("SELECT producto, present, SUM(ventas%d) FROM ventasxmes\
				%s GROUP BY producto,present INTO OUTFILE '%s'", dias, condicion_almacen, archivo_temp1);
			} else if (empresa != " " && sucursal == " "){
				instruccion.sprintf("SELECT producto, present, SUM(ventas%d) FROM ventasxmes vxm\
				INNER JOIN almacenes alm ON alm.almacen=vxm.almacen\
				INNER JOIN secciones sec ON sec.seccion=alm.seccion AND sec.sucursal IN (%s)\
				GROUP BY producto,present INTO OUTFILE '%s'", dias, cadena_sucursal_empresa, archivo_temp1);
			} else {
				instruccion.sprintf("SELECT producto, present, SUM(ventas%d) FROM ventasxmes_norel\
				GROUP BY producto,present INTO OUTFILE '%s'", dias, archivo_temp1);
            }
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventasdev ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = " CREATE TEMPORARY TABLE auxventasxmes (producto VARCHAR(8), present VARCHAR(255), cantidad DECIMAL(16,3), \
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);


		if(bandExist == true){
            instruccion.sprintf("SELECT                     \
			producto,                                   \
			present,                                    \
			SUM(cantidad) AS cantidad                   \
			FROM existenciasiniciales ex\
			INNER JOIN almacenes alm ON alm.almacen=ex.almacen \
			INNER JOIN secciones sec ON sec.seccion=alm.seccion \
			WHERE 1 %s %s 			\
			GROUP BY producto, present INTO OUTFILE '%s'", condicion_producto2,
			condicion_almacen_vta3, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		} else {
			/*instruccion.sprintf("SELECT                     \
			producto,                                   \
			present,                                    \
			SUM(cantidad) AS cantidad                   \
			FROM existenciasactuales WHERE 1 %s %s 			\
			GROUP BY producto, present INTO OUTFILE '%s'", condicion_producto2,
			condicion_almacen_vta2, archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;*/

			instruccion.sprintf("SELECT producto, present, SUM(cantidad)\
				FROM existenciasactuales ex\
				INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
				INNER JOIN secciones sec ON sec.seccion=alm.seccion\
				AND sec.sucursal IN (%s)\
				WHERE 1 %s %s\
				GROUP BY producto, present INTO OUTFILE '%s'",
				cadena_sucursal_empresa,condicion_producto2,condicion_almacen_vta3, archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventasxmes ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los conceptos de movalma que se interpretan como venta para
		// propósito de rotacion de mercancía (ej: calculo de cuanto pedir)
		instruccion.sprintf("SELECT concepto FROM conceptosmovvent");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_conceptosmovvent);
		for (i = 0; i < resp_conceptosmovvent->ObtieneNumRegistros(); i++) {
			resp_conceptosmovvent->IrAlRegistroNumero(i);
			concepto = resp_conceptosmovvent->ObtieneDato("concepto");

			cad_conjunto_conceptos += "'";
			cad_conjunto_conceptos += concepto;
			cad_conjunto_conceptos += "'";
			if (i < resp_conceptosmovvent->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo le signo +.
					cad_conjunto_conceptos += ",";
		}
		condicion_concepto.sprintf(" m.concepto in (%s) and ",
			cad_conjunto_conceptos);

		if (cad_conjunto_conceptos != " " && dias >	0 && consider_salidas_ventas == "1") {

			instruccion = " CREATE TEMPORARY TABLE auxsalidasvent (producto VARCHAR(8), present VARCHAR(255), cantsalprom DECIMAL(16,3), \
			PRIMARY KEY(producto, present)) ENGINE = INNODB";

			instrucciones[num_instrucciones++] = instruccion;
			archivo_temp16 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("SELECT                                                     \
				a.producto,                                                                 \
				a.present,                                                                  \
				SUM(d.cantidad*a.factor) AS cantsalprom                                     \
			FROM movalma m, dmovalma d, articulos a %s, productos prod                         \
			WHERE                                                                           \
				%s                                                                          \
				m.fechamov>='%s' AND                                                        \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				m.fechamov>@fechacorte                                                      \
				AND m.fechamov<=@fechafinal                                                 \
				AND m.movimiento=d.movimiento                                               \
				AND m.tipo<>'E'                                                             \
				AND m.aplica=1                                                              \
				AND m.cancelado=0                                                           \
				AND d.articulo=a.articulo                                                   \
				AND a.producto=prod.producto                                                \
			GROUP BY a.producto, a.present INTO OUTFILE '%s'",
				join_presentacion1, condicion_producto,
				mFg.DateToMySqlDate(fecha_inicial_promedio),
				condicion_almacen_sv, condicion_concepto, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, archivo_temp16);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxsalidasvent ",
				archivo_temp16);
			instrucciones[num_instrucciones++] = instruccion;

			inner_join_salida =
				" LEFT JOIN auxsalidasvent auxsal ON pmm.producto = auxsal.producto AND pmm.present = auxsal.present ";
			campo_salida.sprintf("IFNULL(auxsal.cantsalprom,0)/%f", divisor);
			campo_salida2 = "IFNULL(auxsal.cantsalprom,0)";

		}

		instruccion =
			" CREATE TEMPORARY TABLE auxventastot (sucursal VARCHAR(2), producto VARCHAR(8), present VARCHAR(255), maxfactor decimal(10,3), \
		multmax varchar(10), minfactor decimal(10,3), multmin varchar(10), cantidad DECIMAL(16,3), cantvpprom DECIMAL(16,3),  \
		cantsalprom DECIMAL(16,3), cantvtotprom DECIMAL(16,3), PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp11 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT\
			pre.sucursal,\
			pmm.producto,\
			pmm.present,\
			pmm.maxfactor,\
			pmm.maxmult,\
			1 AS minfactor,\
			pmm.minmult,\
			IFNULL(e.cantidad,0),\
			(IFNULL(auxvtadev.cantvpprom,0)/%f) AS cantvpprom,\
			%s AS cantsalprom,\
			((IFNULL(auxvtadev.cantvpprom,0)+%s)/%f) AS cantvtotprom\
		FROM presentacionesminmax pmm\
		LEFT JOIN precalculohistoriaconexist%s pre ON pmm.producto = pre.producto AND pmm.present = pre.present %s\
		LEFT JOIN auxventasdev auxvtadev ON pmm.producto = auxvtadev.producto AND pmm.present = auxvtadev.present\
		%s %s\
		%s\
		LEFT JOIN auxventasxmes e ON pmm.producto = e.producto AND pmm.present = e.present\
		WHERE 1 %s %s %s %s %s %s\
		GROUP BY pmm.producto, pmm.present INTO OUTFILE '%s'", divisor,
			campo_salida, campo_salida2, divisor, idEmpresa, condicion_suc2,
			join_presentacion2, inner_join_salida, join_productos2,
			condicion_clasif1_pmm, condicion_clasif2_pmm, condicion_clasif3_pmm,
			condicion_fabricante_pmm, condicion_segmento_pmm,
			condicion_producto_pmm, archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventastot ",
			archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			// Obtiene los costos de compra
			archivo_temp13 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT aa.producto, aa.present, MAX(dcc.costoimp)- SUM(ifnull(dnc.costoimp,0)) AS costocompra \
				FROM compras cc INNER JOIN dcompras dcc ON cc.`referencia` = dcc.`referencia` \
				INNER JOIN articulos aa ON dcc.`articulo`=aa.`articulo` \
				INNER JOIN ( \
					SELECT a.producto, a.present, MAX(TIMESTAMP(c.fechacom,c.horaalta)) AS ultimafechacom \
					FROM compras c INNER JOIN dcompras dc ON c.`referencia`=dc.`referencia` \
					INNER JOIN articulos a ON dc.`articulo`=a.`articulo` \
					INNER JOIN terminales t ON t.terminal = c.terminal \
					INNER JOIN secciones sec ON sec.seccion = t.seccion \
					INNER JOIN sucursales suc ON sec.sucursal = suc.sucursal \
					WHERE c.cancelado=0 AND suc.idempresa = %s %s \
					GROUP BY a.`producto`, a.`present` \
				) ultcompras ON ultcompras.ultimafechacom = timestamp(cc.fechacom,cc.horaalta) \
					AND ultcompras.producto=aa.`producto` AND ultcompras.present=aa.`present` \
				LEFT OUTER JOIN notascredprov nc on nc.compra=cc.referencia and nc.cancelado=0 and nc.tipo<>'0' \
				LEFT OUTER JOIN dnotascredprov as dnc on dnc.referencia=nc.referencia and dnc.articulo=aa.articulo \
				WHERE cc.cancelado=0 \
				GROUP BY aa.`producto`, aa.`present` INTO OUTFILE '%s'",
				idEmpresa, condicion_articulos_inactivos, archivo_temp13);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxcostoscompra ",
				archivo_temp13);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion = " CREATE TEMPORARY TABLE ventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), \
		cantidadmespreant DECIMAL(12,3),cantidadmesant DECIMAL(12,3),cantidadmesact DECIMAL(12,3),   \
		INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp14 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT vm.producto, vm.present,  \
		SUM(vm.cant%s),SUM(vm.cant%s), SUM(vm.cant%s) \
		FROM ventasxmes vm INNER JOIN productos prod ON vm.producto = prod.producto  \
		INNER JOIN almacenes al ON vm.almacen = al.almacen INNER JOIN secciones s ON al.seccion = s.seccion  \
		%s %s %s %s %s %s %s %s %s %s GROUP BY  vm.producto,vm.present INTO OUTFILE '%s'"
			, cad_mes_penant, cad_mes_ant, cad_mes_corresp, join_presentacion3,
			condicion_sucursal, condicion_producto_ventasmes,
			condicion_clasif1_ventasmes, condicion_clasif2_ventasmes,
			condicion_clasif3_ventasmes, condicion_marca,
			condicion_marca_excluir, condicion_fabricante_vtaxmes,
			condicion_segmento_vtaxmes, archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE ventasmesesantaux ",
			archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		// tabla temporal calcula las salidas consideradas ventas e los mese anteriores.
		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {
			conSalxVenxFechaActIni =
				"DATE_SUB(@fechafinal,INTERVAL DAY(@fechafinal)-1 DAY)";
			conSalxVenxFechaActFin = "LAST_DAY(@fechafinal)";
			conSalxVenxFechaAntIni =
				"DATE_SUB(DATE_SUB(@fechafinal,INTERVAL '1' MONTH),INTERVAL DAY(@fechafinal)-1 DAY)";
			conSalxVenxFechaAntFin =
				"LAST_DAY(DATE_SUB(@fechafinal,INTERVAL '1' MONTH))";
			conSalxVenxFechaPreAntIni =
				"DATE_SUB(DATE_SUB(@fechafinal,INTERVAL '2' MONTH),INTERVAL DAY(@fechafinal)-1 DAY)",
				conSalxVenxFechaPreAntFin =
				"LAST_DAY(DATE_SUB(@fechafinal,INTERVAL '2' MONTH))";

			// MesAcual
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesesactaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmesact DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp17 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s \
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaActIni,
				conSalxVenxFechaActFin, archivo_temp17);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesesactaux ",
				archivo_temp17);
			instrucciones[num_instrucciones++] = instruccion;

			// MesAnterior
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmesant DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp18 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s \
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaAntIni,
				conSalxVenxFechaAntFin, archivo_temp18);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesesantaux ",
				archivo_temp18);
			instrucciones[num_instrucciones++] = instruccion;

			// MesPreAnterior
			instruccion = " CREATE TEMPORARY TABLE salidasventasmesespreantaux ( producto VARCHAR(8), present VARCHAR(255), \
			cantidadmespreant DECIMAL(12,3),   \
			INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp19 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select\
				a.producto,\
				a.present, \
				(sum(d.cantidad*a.factor)) as cantsalxvent \
				from movalma m, dmovalma d, articulos a %s %s \
				where \
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				%s\
				m.fechamov>=%s\
				and m.fechamov<=%s\
				and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 \
				and m.cancelado=0\
				and d.articulo=a.articulo\
				group by a.articulo INTO OUTFILE '%s'", join_presentacion1,
				join_productos, condicion_almacen_sv, condicion_concepto,
				condicion_producto_ventasxsalidasmes, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, conSalxVenxFechaPreAntIni,
				conSalxVenxFechaPreAntFin, archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE salidasventasmesespreantaux "
				, archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;

			condicion_salidasVentasxMes.sprintf("LEFT JOIN salidasventasmesesactaux svmact ON svmact.producto=prod.producto AND svmact.present=present.present\
			LEFT JOIN salidasventasmesesantaux svmant ON svmant.producto=prod.producto AND svmant.present=present.present\
			LEFT JOIN salidasventasmesespreantaux svmpant ON svmpant.producto=prod.producto AND svmpant.present=present.present"
				);

			campo_svxmact = "+IFNULL(svmact.cantidadmesact,0)";
			campo_svxmant = "+IFNULL(svmant.cantidadmesant,0)";
			campo_svxmpant = "+IFNULL(svmpant.cantidadmespreant,0)";
		}
		bool banderaHvg = false;
		bool banderaHvgEmp = false;
		// condición mostrar solo DESCONTINUADOS
		if(empresa != " " && sucursal != " " && soloDescontinuados == "1"){ //empresa + sucursal + solo descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) =1";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}else if(empresa != " " && sucursal != " " && soloDescontinuados == "0" ){ // empresa + sucursal + excluir descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) =0";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}else if(soloDescontinuados == "-1" && empresa != " " && sucursal == " "){ //empresa
			condicion_soloDescontinuados = " ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1 AND suc.idempresa = %s) AS descontinuado, ", empresa);
		}else if(soloDescontinuados == "1" && empresa != " " && sucursal == " "){ // empresa + solo descontinuados
			condicion_soloDescontinuados = " AND ap.descontinuado = 1 ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1 AND suc.idempresa = %s) AS descontinuado,", empresa);
				banderaHvgEmp = true;
		}else if(soloDescontinuados == "0" && empresa != " " && sucursal == " "){ // empresa + excluir descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) = 0";
			banderaHvg = true;
			condicionDescNw =
			"(SELECT COUNT(*) FROM articulosped ap WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1) AS descontinuado,";
		}else if(soloDescontinuados == "1" && empresa == " " && sucursal == " "){ // empresas + solo descontinuados
			condicion_soloDescontinuados = " AND ap.descontinuado = 1 ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1) AS descontinuado,");
				banderaHvgEmp = true;
		}else if(soloDescontinuados == "0" && empresa == " " && sucursal == " "){ // empresas + excluir descontinuados
			condicion_soloDescontinuados = " AND ifnull(descontinuado,0) = 0";
			banderaHvg = true;
			condicionDescNw.sprintf("(SELECT COUNT(*) FROM articulosped ap \
			WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1) AS descontinuado,");
		}else if(soloDescontinuados == "-1" && empresa == " " && sucursal == " "){ // globlal
			condicion_soloDescontinuados = " ";
			condicionDescNw.sprintf("(SELECT COUNT(*) \
				FROM articulosped ap \
				INNER JOIN sucursales suc ON ap.sucursal = suc.sucursal \
				WHERE ap.producto = prod.producto AND ap.present = present.present AND ap.descontinuado = 1 ) AS descontinuado, ");
		}else{ // empresa + sucursal
			condicion_soloDescontinuados = " ";
			condicionDescNw = "IFNULL(ap.descontinuado,0) AS descontinuado,";
		}

		if(banderaHvgEmp == true && stock == " "){
			condicionHav = " HAVING descontinuado <> 0 ";
		}else if(banderaHvgEmp == true && stock != " "){
			condicionHav = " AND descontinuado <> 0 ";
		}else if (banderaHvg == true) {
			if(condicion_stock == " "){
				condicionHav = " HAVING descontinuado =0 ";
			}else{
				condicionHav = " and descontinuado =0 ";
			}
		}
		else {
			condicionHav = " ";
		}

		// verificar si la sucursal esta vacia o no
		if (sucursal != " ") {
			condicion_descontinuado.sprintf
				("LEFT JOIN articulosped ap ON ap.producto=prod.producto AND ap.present=present.present and ap.sucursal='%s'",
				sucursal);
			// condicion_sucursal
		}
		if (sucursal == " ") { // sust cod de abajo
			condicion_descontinuado.sprintf
				("LEFT JOIN articulosped ap ON ap.producto=prod.producto AND ap.present=present.present"
				);
		}
		/* else {
		 instruccion = " CREATE TEMPORARY TABLE artdescontinuadosaux ( producto VARCHAR(8), present VARCHAR(255), \
		 descontinuado TINYINT(4),   \
		 INDEX(producto, present)) ENGINE = INNODB";
		 instrucciones[num_instrucciones++] = instruccion;

		 archivo_temp15 = mServidorVioleta->ObtieneArchivoTemp
		 (num_instrucciones, Respuesta->Id);
		 instruccion.sprintf("SELECT producto, present, descontinuado from articulosped GROUP BY producto, present \
		 INTO OUTFILE '%s'", archivo_temp15);
		 instrucciones[num_instrucciones++] = instruccion;

		 instruccion.sprintf
		 ("LOAD DATA INFILE '%s' INTO TABLE artdescontinuadosaux ",
		 archivo_temp15);
		 instrucciones[num_instrucciones++] = instruccion;

		 condicion_descontinuado.sprintf
		 ("LEFT JOIN artdescontinuadosaux ap ON ap.producto=prod.producto AND ap.present=present.present "
		 );

		 } */

		instruccion = "CREATE OR REPLACE TEMPORARY TABLE ubicacionarticulosaux\
		(sucursal VARCHAR(2) NOT NULL,\
		producto VARCHAR(8) NOT NULL,\
		present VARCHAR(255) NOT NULL,\
		ubicacionart VARCHAR(15) NOT NULL,\
		PRIMARY KEY (sucursal, producto, present))";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT IGNORE INTO ubicacionarticulosaux\
		(SELECT sec.sucursal, aubi.producto, aubi.present,\
		MIN(CONCAT_WS('-', acl.almacen, acl.nombrecalle, afr.numfrente, apos.nivel, apos.fondo)) AS ubicacionart\
		FROM almacenposarticulos aubi\
		INNER JOIN almacenposiciones apos ON aubi.idalmposicion = apos.idalmposicion\
		INNER JOIN almacenfrentes afr ON apos.idalmfrente = afr.idalmfrente\
		INNER JOIN almacencalles acl ON afr.idalmcalle = acl.idalmcalle\
		INNER JOIN almacenes alm ON acl.almacen = alm.almacen\
		INNER JOIN secciones sec ON alm.seccion = sec.seccion\
		GROUP BY sec.sucursal, aubi.producto, aubi.present)";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			mServidorVioleta->BorraArchivoTemp(archivo_temp7);
			mServidorVioleta->BorraArchivoTemp(archivo_temp8);
			mServidorVioleta->BorraArchivoTemp(archivo_temp9);
			mServidorVioleta->BorraArchivoTemp(archivo_temp10);
			mServidorVioleta->BorraArchivoTemp(archivo_temp11);
			mServidorVioleta->BorraArchivoTemp(archivo_temp12);
			if (costoscompra == 1)
				mServidorVioleta->BorraArchivoTemp(archivo_temp13);
			mServidorVioleta->BorraArchivoTemp(archivo_temp14);
			if (sucursal == " ")
				mServidorVioleta->BorraArchivoTemp(archivo_temp15);
			if (consider_salidas_ventas == "1") // salidas consideradas ventas
					mServidorVioleta->BorraArchivoTemp(archivo_temp16);
			mServidorVioleta->BorraArchivoTemp(archivo_temp17);
			// Salidas consideradas ventas del mes actual
			mServidorVioleta->BorraArchivoTemp(archivo_temp18);
			// Salidas consideradas ventas del mes anterior
			mServidorVioleta->BorraArchivoTemp(archivo_temp19);
			// Salidas consideradas ventas del mes preanterior

			if (empresa == " ") {
                empresa = FormServidor->ObtieneClaveEmpresa();
			}
			// Resultado final
			instruccion.sprintf("select IF(amin.activo=1,prod.nombre,CONCAT(prod.nombre ,' (inactivo)') ) as nomproducto , e.producto, e.present, \
				truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, \
				(@resto/e.minfactor) as cantmin, \
				e.multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				truncate(ifnull(s.minimo,0)/e.maxfactor,0) as minimomax, truncate(ifnull(s.maximo,0)/e.maxfactor,0) as maximomax, truncate(ifnull(s.reorden,0)/e.maxfactor,0) as reordenmax, \
				ifnull(s.minimo,0) as minimotot, ifnull(s.maximo,0) as maximotot, ifnull(s.reorden,0) as reordentot, \
				mod(ifnull(s.minimo,0), e.maxfactor) as minimounid, mod(ifnull(s.maximo,0), e.maxfactor) as maximounid, mod(ifnull(s.reorden,0), e.maxfactor) as reordenunid, \
				((pcb.costobase*e.cantidad)/(e.cantidad/e.maxfactor)) as costo, \
				truncate(e.cantvpprom/e.maxfactor,0) as cantmaxvp, \
				@restovp:=mod(e.cantvpprom, e.maxfactor) as restovp, \
				(@restovp/e.minfactor) as cantminvp, \
				e.cantvpprom, \
				a.articulo as articulo, \
				pcb.costobase as costounitario, \
				(pcb.costobase*e.maxfactor) as costobasexmultmay, \
				amin.activo, \
				TRUNCATE((vma.cantidadmespreant%s) / e.maxfactor, 0) AS cantmaxmespreant, MOD((vma.cantidadmespreant%s), e.maxfactor) AS restomespreant,  \
				TRUNCATE((vma.cantidadmesant%s) / e.maxfactor, 0) AS cantmaxmesant, MOD((vma.cantidadmesant%s), e.maxfactor) AS restomesant,      \
				TRUNCATE((vma.cantidadmesact%s) / e.maxfactor, 0) AS cantmaxmesact, MOD((vma.cantidadmesact%s), e.maxfactor) AS restomesact   \
				%s \
				,a2.ean13  AS codbarMay, a1.ean13 AS codbarMin, %s\
				\
				truncate(e.cantvtotprom/e.maxfactor,7) as cantmaxvtotp, \
				@restovtotprom:=mod(e.cantvtotprom, e.maxfactor) as restovtotp, \
				(@restovtotprom/e.minfactor) as cantminvtotp, \
				truncate(e.cantsalprom/e.maxfactor,0) as cantmaxsalp, \
				@restosal:=mod(e.cantsalprom, e.maxfactor) as restosalp, \
				(@restosal/e.minfactor) as cantminsalp \
				%s \
				%s\
				, COALESCE(uart.ubicacionart, 'SIN UBICACION') AS ubicacionart\
				from auxventastot e  inner join  productos prod  inner join  presentaciones present \
				inner join presentacionescb pcb \
				left join auxstockagrup s ON e.producto=s.producto and e.present=s.present \
				left join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo  \
				left join articulos amin on e.producto=amin.producto and e.present=amin.present and e.multmin=amin.multiplo  \
				LEFT JOIN ventasmesesantaux vma ON vma.producto = e.producto AND vma.present = e.present \
				%s \
				%s\
				INNER JOIN presentacionesminmax pmm ON present.producto=pmm.producto AND present.present = pmm.present \
				%s                                                                                                     \
				left join articulos a1 on a1.producto=prod.producto and a1.present=present.present \
				AND a1.multiplo=pmm.minmult \
				left join articulos a2 on a2.producto=prod.producto and a2.present=present.present \
				AND a2.multiplo=pmm.maxmult \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				LEFT JOIN ubicacionarticulosaux uart ON a.producto = uart.producto AND a.present = uart.present AND e.sucursal = uart.sucursal\
				%s\
				where \
				prod.producto=e.producto and e.producto=present.producto and e.present=present.present and \
				pcb.producto=present.producto and pcb.present=present.present and \
				 pcb.idempresa=%s %s %s %s %s %s %s %s %s \
                 AND (e.cantidad<>0 OR pemp.activo = 1)\
				GROUP BY e.producto, e.present \
				 %s \
				 %s\
				order by nomproducto, e.present ", campo_svxmpant,
				campo_svxmpant, campo_svxmant, campo_svxmant, campo_svxmact,
				campo_svxmact, camposcostoscompra, condicionDescNw,
				campo_supervisado, campocostoprom, leftcostoscompra,
				inner_artactxsuc, leftcostoprom, inner_provcompras,
				join_art_tags, inner_empleadosupervisor,
				condicion_descontinuado, condicion_salidasVentasxMes,
				condicion_almacen_mulmax,join_presentacionesactivemp, empresa,
				condicion_marca, condicion_marca_excluir,
				presentaciones_cotizables, presentaciones_sup_gerencia,
				condicion_art_tags, condicion_empleadosupervisor,
				condicion_soloDescontinuados, condicion_articulos_inactivos,
				condicion_stock, condicionHav);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_sucursales != NULL)
			delete resp_sucursales;
		if (resp_conceptosmovvent != NULL)
			delete resp_conceptosmovvent;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPAGOSCLI
void ServidorReportes::EjecutaRepPagosClientes(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial_pagos, fecha_final_pagos, fecha_inicial_ventas,
		fecha_final_ventas;
	AnsiString cobrador, forma_pago, tipo_facturacion, cliente;
	AnsiString condicion_cobrador = " ", condicion_forma_pago = " ";
	AnsiString condicion_tipo_facturacion = " ", condicion_cliente = " ";
	AnsiString condicion_pago = " ", pago;
	AnsiString condicion_estatus_aplicada = " ", estatus_aplicada;

	AnsiString afectadosxnotascargo, tipo_nombre;
	AnsiString fecha_inicial_notas, fecha_final_notas;
	AnsiString condicion_tipo_nombre = " ";
    AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString terminal, condicion_terminal = " ";

	AnsiString condicion_clasifcont = " ", condicion_clasifcont_and = " ";
	AnsiString clasifcont;
	AnsiString clasifcont2;
	AnsiString join_clasifcont = " ", campo_total_clasifcont = " ";
	AnsiString tiporfc, condicion_tiporfc;
	AnsiString agruparFormaPago;
	AnsiString venta, condicion_venta = " "; // 1503
	AnsiString incluir_xml, campo_xml64 = " ", cond_left_join_cfdxml = " ";

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	BufferRespuestas* resp_clientes = NULL;
	AnsiString cad_totimpuestos_create = "", campos_totimpuestos_create = "";
	AnsiString cad_porcimpuestos_create = "", campos_porcimpuestos_create = "";
	AnsiString impuesto_aux = "", tipo_impuesto_aux = "", cad_totimpuestos_col =
		"", campos_totimpuestos_col = "";
	AnsiString cad_totimpuestos = "", campos_totimpuestos = "",
		cad_porcimpuestos = "", campos_porcimpuestos = "";
	AnsiString cad_porcimpuestosVA = "", campos_porcimpuestosVA = "",
		cad_porcimpuestosVA_def = "", campos_porcimpuestosVA_def = "",
		cad_propor_impuestos = "", campos_propor_impuestos = "";
	AnsiString cad_propor_impuestos_sum = "", campos_propor_impuestos_sum = "";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";

	AnsiString cad_base_impuestos = "", campos_base_impuestos = "";

	AnsiString tipo_impuestos, impuesto_particular, negar_impuestos,
		condicion_tipo_imp = " ", condicion_imp = " ";
	AnsiString tipo_impuestos2, impuesto_particular2, negar_impuestos2,
		condicion_tipo_imp2 = " ", condicion_imp2 = " ";
	AnsiString condicion_general_impuestos = " ";
	AnsiString archivo_temp1, archivo_temp2;
	AnsiString cuentabancaria, join_cuentabancaria = " ",
		campo_valor_pago = " ";
	AnsiString InclurRFCIgual, origenVenta, condicion_origen_ventas = " ";

	try {
		fecha_inicial_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		cobrador = mFg.ExtraeStringDeBuffer(&parametros);
		forma_pago = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_facturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);

		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);

		pago = mFg.ExtraeStringDeBuffer(&parametros);

		clasifcont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);

		estatus_aplicada = mFg.ExtraeStringDeBuffer(&parametros);
		tiporfc = mFg.ExtraeStringDeBuffer(&parametros);
		agruparFormaPago = mFg.ExtraeStringDeBuffer(&parametros);
		cuentabancaria = mFg.ExtraeStringDeBuffer(&parametros);

		// Incluir los clientes con el rfc igual
		InclurRFCIgual = mFg.ExtraeStringDeBuffer(&parametros);

		// Los origenes ventas
		origenVenta = mFg.ExtraeStringDeBuffer(&parametros);

		// en caso de solicitar pagos relacionados a notas de cargo
		afectadosxnotascargo = mFg.ExtraeStringDeBuffer(&parametros);
		// en caso de solicitar pagos relacionados con cargos, se leen los
		// demas parametros
		if (afectadosxnotascargo != " ") {
			tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
			fecha_inicial_notas =
				mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
			fecha_final_notas =
				mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

			// define la forma como se mostraran los nombres de los clientes
			if (tipo_nombre == "1") {
				condicion_tipo_nombre =
					"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
			}
			else {
				condicion_tipo_nombre = "cli.rsocial";
			}

			// Terminal
			terminal = mFg.ExtraeStringDeBuffer(&parametros);
		}

		venta = mFg.ExtraeStringDeBuffer(&parametros); // 1503

		incluir_xml = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto, LCASE(i.tipoimpu) as tipoimpu FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);

		if (estatus_aplicada != " ") {
			condicion_estatus_aplicada.sprintf(" t.aplicada=%s and ",
				estatus_aplicada);
		}

		if (pago != " ") {
			condicion_pago.sprintf("pag.pago='%s' and ", pago);
		}

		if (cobrador != " ") {
			condicion_cobrador.sprintf("pag.cobrador='%s' and ", cobrador);
		}

		if (forma_pago != " ") {
			if (forma_pago.SubString(0, 1) == "'") {
				condicion_forma_pago.sprintf("pag.formapag in (%s) and ",
					forma_pago);
			}
			else
				condicion_forma_pago.sprintf("pag.formapag='%s' and ",
				forma_pago);
		}

		if (tipo_facturacion != " ") {
			condicion_tipo_facturacion.sprintf("v.tipofac='%s' and ",
				tipo_facturacion);
		}

		if (cliente != " ") {
			if (InclurRFCIgual == "0")
				condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
			else {
				AnsiString cadena_clientes = "";
				instruccion.sprintf("SELECT cliente FROM clientes WHERE rfc = (SELECT rfc FROM clientes \
											   WHERE cliente = '%s')", cliente);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_clientes);

				for (i = 0; i < resp_clientes->ObtieneNumRegistros(); i++) {
					resp_clientes->IrAlRegistroNumero(i);
					if (i != resp_clientes->ObtieneNumRegistros() - 1)
						cadena_clientes =
							cadena_clientes + "'" + resp_clientes->ObtieneDato
							("cliente") + "',";
					else
						cadena_clientes =
							cadena_clientes + "'" + resp_clientes->ObtieneDato
							("cliente") + "'";
				}

				condicion_cliente.sprintf("v.cliente IN (%s) and ",
					cadena_clientes);
			}
		}
		if (venta != " ") {
			condicion_venta.sprintf("v.referencia = '%s' and ", venta);
		}
		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("suc.sucursal='%s' and ", sucursal);
		}

		if (terminal != " ") {
			condicion_terminal.sprintf("v.terminal='%s' and ", terminal);
		}

		if (incluir_xml == "1") {
			campo_xml64 = " cxml.xmlgenerado AS xml64, ";
			cond_left_join_cfdxml =
				" left join cfdxml cxml ON cxml.compfiscal = cfdp.compfiscal ";
		}

		// Impuestos
		if (tipo_impuestos != " ") {
			if (negar_impuestos == "0")
				condicion_tipo_imp.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
			else
				condicion_tipo_imp.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);

			if (condicion_general_impuestos != " ")
				// Si ya hay algo en la condicion_general_impuestos pone un "and"
					condicion_general_impuestos = condicion_general_impuestos +
					" and ";

			condicion_general_impuestos = condicion_general_impuestos +
				condicion_tipo_imp;
		}
		if (impuesto_particular != " ") {
			if (negar_impuestos == "0")
				condicion_imp.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
			else
				condicion_imp.sprintf
					("(IFNULL(i1.impuesto,0)<>%s and IFNULL(i2.impuesto,0)<>%s and IFNULL(i3.impuesto,0)<>%s and IFNULL(i4.impuesto,0)<>%s) ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);

			if (condicion_general_impuestos != " ")
				// Si ya hay algo en la condicion_general_impuestos pone un "and"
					condicion_general_impuestos = condicion_general_impuestos +
					" and ";

			condicion_general_impuestos = condicion_general_impuestos +
				condicion_imp;
		}
		if (tipo_impuestos2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_tipo_imp2.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);
			else
				condicion_tipo_imp2.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);

			if (condicion_general_impuestos != " ")
				// Si ya hay algo en la condicion_general_impuestos pone un "and"
					condicion_general_impuestos = condicion_general_impuestos +
					" and ";

			condicion_general_impuestos = condicion_general_impuestos +
				condicion_tipo_imp2;
		}
		if (impuesto_particular2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_imp2.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);
			else
				condicion_imp2.sprintf
					("(IFNULL(i1.impuesto,0)<>%s and IFNULL(i2.impuesto,0)<>%s and IFNULL(i3.impuesto,0)<>%s and IFNULL(i4.impuesto,0)<>%s) ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);

			if (condicion_general_impuestos != " ")
				// Si ya hay algo en la condicion_general_impuestos pone un "and"
					condicion_general_impuestos = condicion_general_impuestos +
					" and ";

			condicion_general_impuestos = condicion_general_impuestos +
				condicion_imp2;
		}

		// clasifcont
		if (clasifcont != " " || clasifcont2 != " " ||
			condicion_general_impuestos != " ") {

			if (clasifcont != " " && clasifcont2 != " ") {
				condicion_clasifcont.sprintf
					("prod.clasifcont='%s' and prod.clasifcont2='%s'",
					clasifcont, clasifcont2);
			}
			else {
				if (clasifcont != " ") {
					condicion_clasifcont.sprintf("prod.clasifcont='%s'",
						clasifcont);
				}
				else {
					if (clasifcont2 != " ")
						condicion_clasifcont.sprintf("prod.clasifcont2='%s'",
						clasifcont2);
				}
			}

			if (condicion_clasifcont != " ") {
				join_clasifcont =
					" inner join articulos a on dv.articulo=a.articulo \
						  inner join productos prod on prod.producto=a.producto ";
			}

			if (condicion_general_impuestos != " ") {
				if (condicion_clasifcont != " ")
					condicion_clasifcont = condicion_general_impuestos +
						" and " + condicion_clasifcont;
				else
					condicion_clasifcont = condicion_general_impuestos;
			}

			condicion_clasifcont_and = condicion_clasifcont + " and ";

			campo_total_clasifcont.sprintf(" sum(if( %s, \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as totclasifcont, ", condicion_clasifcont);

		}
		else {
			campo_total_clasifcont.sprintf(" 0 as totclasifcont, ");

		}

		// Es partes relacionadas
		if (clientes_partesrel != " ") {
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s and ",
				clientes_partesrel);
		}

		// Tipo de rfc a buscar
		if (tiporfc == "CRFC")
			condicion_tiporfc = " ";
		if (tiporfc == "RFCG")
			condicion_tiporfc = " AND cfd.rfcreceptor = 'XAXX010101000' ";
		if (tiporfc == "RFCNG")
			condicion_tiporfc =
				" AND (cfd.rfcreceptor <> 'XAXX010101000' OR cfd.rfcreceptor IS NULL) ";

		// Cuenta bancaria donde entra en bancos.
		if (cuentabancaria != " ") {

			join_cuentabancaria.sprintf(" INNER JOIN bancosxcob bxc ON bxc.tracredito=t.tracredito \
			  INNER JOIN bancostransacc bt ON bt.transacc=bxc.transacc \
			  INNER JOIN bancosmov bm ON bm.idmovbanco=bt.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1 AND bm.idnumcuenta=%s "
				, cuentabancaria);
			campo_valor_pago = "(bxc.valorconsiderado*-1.0)";

		}
		else {
			campo_valor_pago = "t.valor";
		}

		if (origenVenta != " ") {
			condicion_origen_ventas.sprintf("  v.tipoorigen IN (%s) and ",
				origenVenta);

		}

		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto_aux = resp_impuestos->ObtieneDato("impuesto");
			tipo_impuesto_aux = resp_impuestos->ObtieneDato("tipoimpu");

			cad_totimpuestos_create.sprintf(" total%s%s decimal(16,4), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_totimpuestos_create += cad_totimpuestos_create;

			cad_porcimpuestos_create.sprintf(" porcentaje%s%s decimal(16,10),",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestos_create += cad_porcimpuestos_create;

			cad_totimpuestos_col.sprintf(" total%s%s, ", tipo_impuesto_aux,
				impuesto_aux);
			campos_totimpuestos_col += cad_totimpuestos_col;

			cad_totimpuestos.sprintf(" sum(if(%s i1.impuesto=%s, (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0) + \
				if(%s i2.impuesto=%s, (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) as total%s%s, "
				, condicion_clasifcont_and, impuesto_aux,
				condicion_clasifcont_and, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_totimpuestos += cad_totimpuestos;

			cad_porcimpuestos.sprintf("porcentaje%s%s=total%s%s/(totaltodo), ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_porcimpuestos += cad_porcimpuestos;

			cad_porcimpuestosVA.sprintf("va.porcentaje%s%s, ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestosVA += cad_porcimpuestosVA;

			cad_porcimpuestosVA_def.sprintf("porcentaje%s%s decimal(16,10), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestosVA_def += cad_porcimpuestosVA_def;

			cad_propor_impuestos.sprintf
				("(@pago*t.porcentaje%s%s) as proporcion%s%s, ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_propor_impuestos += cad_propor_impuestos;

			cad_propor_impuestos_sum.sprintf
				("SUM((@pago*t.porcentaje%s%s)) as proporcion%s%s, ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_propor_impuestos_sum += cad_propor_impuestos_sum;
		}

		// Crea una tabla para tener las ventas en cuestión
		instruccion.sprintf("create temporary table ventasaux (referencia char(11), \
			totaloriginal decimal(16,4), \
			totaltodo decimal(16,4), \
			total0 decimal(16,4), total15 decimal(16,4), total16 decimal(16,4), \
			subnograbado decimal(16,4), subtotal15 decimal(16,4), subtotal16 decimal(16,4), subgrabado decimal(16,4), subtotal decimal(16,4), \
			totclasifcont decimal(16,4), \
			%s \
			totaliva decimal(16,4), \
			totaliesps decimal(16,4), \
			valor decimal(16,4), \
			porcentaje0 decimal(16,10), \
			porcentaje15 decimal(16,10), \
			porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			porcclasifcont decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
			PRIMARY KEY (referencia)) Engine = InnoDB",
			campos_totimpuestos_create, campos_porcimpuestos_create);
		instrucciones[num_instrucciones++] = instruccion;

		// En caso de solicitar pagos relacionados con notas de cargo
		if (afectadosxnotascargo != " ") {
			// Crea una tabla con los cargos relacionados a los pagos
			instruccion.sprintf("create temporary table cargosaux \
						 select nc.pago, txc.tracredito as reftxcnc, \
						 txc.notacar as referencia, txc2.tracredito as reftxcpg, \
						 nc.foliofisic as nota, txc.tipo, \
						 if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as factura, \
						 txc.fechaalta as fecha, txc.horaalta as hora, %s as nomcliente, \
						 v.referencia as rfciavta \
						 from transxcob txc inner join notascarcli nc inner join ventas v \
						 inner join clientes cli inner join impuestos imp \
						 left join transxcob txc2 on txc2.pago=nc.pago and txc2.referencia=v.referencia \
						 left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
						 where v.referencia=txc.referencia and txc.notacar=nc.referencia \
						 and txc.tipo='CHDE'\
						 and nc.fechanot>='%s' and nc.fechanot<='%s' and nc.cancelado=0 \
						 and nc.cliente=cli.cliente and %s imp.impuesto=nc.cveimp \
						 order by nc.referencia, factura ",
				condicion_tipo_nombre, fecha_inicial_notas, fecha_final_notas,
				condicion_cliente);
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla con todas las ventas que tienen al menos un pago que a su vez
			// tiene un cargo entre las fechas dadas
			instruccion = "create temporary table referenciasaux (referencia char(11), \
				PRIMARY KEY (referencia)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf(" \
				select distinct v.referencia \
				from ventas v, cargosaux caux \
				where caux.rfciavta=v.referencia  INTO OUTFILE '%s' ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE referenciasaux ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

		}
		else {
			// Crea una tabla con todas las ventas que tienen al menos un pago entre las fechas dadas
			instruccion = "create temporary table referenciasaux (referencia char(11), \
				PRIMARY KEY (referencia)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf(" \
				select v.referencia \
				from ventas v, transxcob t \
				where %s %s %s \
				t.fechaapl>='%s' and t.fechaapl<='%s' and \
				t.cancelada=0 and t.tipo='PAGO' \
				and v.cancelado=0 and v.fechavta>='%s' and v.fechavta<='%s' and \
				t.referencia=v.referencia \
				group by v.referencia INTO OUTFILE '%s' ",
				condicion_tipo_facturacion, condicion_cliente,
				condicion_estatus_aplicada, fecha_inicial_pagos,
				fecha_final_pagos, fecha_inicial_ventas, fecha_final_ventas,
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE referenciasaux ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion =
			"CREATE TEMPORARY TABLE dnotascredcliaux (venta CHAR(11), articulo VARCHAR(9), cantidad DECIMAL(12,3), precio DECIMAL(16,6), precioimp DECIMAL(16,6), PRIMARY KEY (venta, articulo)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las ventas.
		instruccion.sprintf("insert into dnotascredcliaux \
			select v.referencia as venta, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.precio,0)) as precio, \
			sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp \
			from notascredcli n, dnotascredcli d, ventas v, referenciasaux ra \
			where n.venta=v.referencia and n.cancelado=0 and v.cancelado=0 and \
			ra.referencia=v.referencia and \
			n.referencia=d.referencia \
			group by v.referencia, d.articulo");
		instrucciones[num_instrucciones++] = instruccion;

		/* "insert into ventasaux \
		 (referencia, totaltodo, total0, total15, total16, \
		 subnograbado,subtotal15,subtotal16,subgrabado,subtotal, \
		 totclasifcont, %s totaliva, totaliesps) \ */

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select v.referencia, \
			sum((dv.precioimp)*(dv.cantidad) ) as totaloriginal, \
			sum((dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)) ) as totaltodo, \
			sum(if(%s \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0)), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as total0, \
			sum(if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total15, \
			sum(if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total16, \
				\
			sum(@subnograbado:=if(%s \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as subnograbado, \
			sum(@subtotal15:=if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal15, \
			sum(@subtotal16:=if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal16, \
			sum(@subgrabado:=@subtotal15+@subtotal16) as subgrabado, \
			sum(@subtotal:=@subtotal15+@subtotal16+@subnograbado) as subtotal, \
			%s \
			%s \
			sum(if(%s i1.tipoimpu='IVA', (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0) + \
			if(%s i2.tipoimpu='IVA', (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) as totaliva, \
			sum(if(%s i1.tipoimpu='IESPS', \
			(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), \
			 0)) as totaliesps \
			from \
				referenciasaux ra \
				INNER JOIN ventas v ON v.referencia = ra.referencia  \
				INNER JOIN dventas dv ON v.referencia = dv.referencia \
			%s \
			left join dnotascredcliaux dn on dn.articulo=dv.articulo and dn.venta=v.referencia \
			left join impuestos i1 on i1.impuesto=dv.claveimp1 \
			left join impuestos i2 on i2.impuesto=dv.claveimp2 \
			left join impuestos i3 on i3.impuesto=dv.claveimp3 \
			left join impuestos i4 on i4.impuesto=dv.claveimp4 \
			group by v.referencia \
			order by v.referencia \
			 INTO OUTFILE '%s' ", condicion_clasifcont_and,
			condicion_clasifcont_and, condicion_clasifcont_and,
			condicion_clasifcont_and, condicion_clasifcont_and,
			condicion_clasifcont_and, campo_total_clasifcont,
			campos_totimpuestos, condicion_clasifcont_and,
			condicion_clasifcont_and, condicion_clasifcont_and, join_clasifcont,
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE ventasaux \
			(referencia, totaloriginal, totaltodo, total0, total15, total16, \
			subnograbado,subtotal15,subtotal16,subgrabado,subtotal, \
			totclasifcont, %s totaliva, totaliesps)	", archivo_temp2,
			campos_totimpuestos_col);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("update ventasaux set valor=totaltodo, \
			porcentaje0=total0/(totaltodo), \
			porcentaje15=total15/(totaltodo), \
			porcentaje16=total16/(totaltodo), \
			porcentajesub0=subnograbado/(totaltodo), \
			porcentajesub15=subtotal15/(totaltodo), \
			porcentajesub16=subtotal16/(totaltodo), \
			porcentajesubgrabado=subgrabado/(totaltodo), \
			porcentajesubtotal=subtotal/(totaltodo), \
			porcclasifcont=totclasifcont/(totaltodo), \
			%s \
			porcentajeiva=totaliva/(totaltodo), \
			porcentajeiesps=totaliesps/(totaltodo)", campos_porcimpuestos);

		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla con las transacciones de pagos o cargos (excepto cargo inicial por la venta y abono por las devoluciones)

		instruccion.sprintf("create temporary table auxtransac ( \
			tracredito varchar(11) , \
			concepto varchar(1), \
			destino varchar(1), \
			referencia varchar(11), \
			tipo varchar(4), \
			pago varchar(11), \
			valor decimal(16,2), \
			valorvta decimal(16,4), \
			fechaapl date, \
			horamodi time, \
			porcentaje0 decimal(16,10), \
			porcentaje15 decimal(16,10), \
			porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			porcclasifcont decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
			notacar varchar(11), \
			KEY (referencia), KEY (tracredito)) Engine = InnoDB",
			campos_porcimpuestosVA_def);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into auxtransac \
			select t.tracredito, t.concepto, t.destino, t.referencia , t.tipo, t.pago, \
			t.valor, va.totaloriginal as valorvta, t.fechaapl, t.horamodi, \
			va.porcentaje0, va.porcentaje15, va.porcentaje16, \
			va.porcentajesub0, va.porcentajesub15, va.porcentajesub16, va.porcentajesubgrabado, va.porcentajesubtotal, \
			va.porcclasifcont, %s  va.porcentajeiva, va.porcentajeiesps, t.notacar \
			from ventasaux va, transxcob t \
			where %s \
			t.cancelada=0 and t.referencia=va.referencia \
			and t.tipo<>'VENT' \
			order by t.referencia, t.fechaapl, t.horamodi ",
			campos_porcimpuestosVA, condicion_estatus_aplicada);
		instrucciones[num_instrucciones++] = instruccion;

		// Una tabla igual que lo anterior (para usarla dos veces en el mismo query más abajo)
		instruccion.sprintf
			("create temporary table auxtransacb like auxtransac");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("insert into auxtransacb select * from auxtransac");
		instrucciones[num_instrucciones++] = instruccion;

		// Notas de cargo
		instruccion.sprintf("create temporary table auxtransaccargo \
			SELECT DISTINCT incar.porcentaje, t.referencia \
				FROM ventasaux va \
				INNER JOIN transxcob t ON t.referencia=va.referencia \
				INNER JOIN notascarcli n ON n.referencia=t.notacar \
				INNER JOIN impuestos incar ON incar.impuesto=n.cveimp \
				WHERE t.aplicada=1 AND t.cancelada=0 AND t.referencia=va.referencia "
			);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla similar a auxtransac, pero con 2 campos:
		// pagado.- Contiene lo pagado hasta antes de la aplicación de la transacción
		// pagadosc.- Contiene lo pagado sin incluir cargos hasta antes de la aplicación de la transacción

		instruccion.sprintf("create temporary table auxtransac2 ( \
			tracredito varchar(11) , \
			concepto varchar(1), \
			destino varchar(1), \
			referencia varchar(11), \
			tipo varchar(4), \
			pago varchar(11), \
			valor decimal(16,2), \
			valorvta decimal(16,4), \
			fechaapl date, \
			horamodi time, \
			porcentaje0 decimal(16,10), \
			porcentaje15 decimal(16,10), \
			porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			porcclasifcont decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
			notacar varchar(11), \
			pagado decimal(16,4), \
			pagadosc decimal(16,4), \
			KEY (referencia), KEY (tracredito)) Engine = InnoDB",
			campos_porcimpuestosVA_def);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into auxtransac2 \
			select t.*, \
			sum(if( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito),    t2.valor,0    )) as pagado, \
			sum(if(( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito)) and (t2.tipo='PAGO' or t2.tipo='CHDE'),    t2.valor,0    )) as pagadosc \
			from auxtransac t, auxtransacb t2 \
			where t.referencia=t2.referencia \
			group by t.referencia,t.tracredito ");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla con la transacción de crédito con folio menor de cada pago (la primera aplicada)
		// pasa solo a esta aplicarle el ajuste y evitar el error que habia de aplicar el ajuste en todas las transacciones.
		instruccion.sprintf("CREATE TEMPORARY TABLE auxtransacAjuste ( \
			tracredito VARCHAR(11), \
			pago VARCHAR(11), \
			PRIMARY KEY (pago), KEY (tracredito)) ENGINE = INNODB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("INSERT INTO auxtransacAjuste \
			SELECT MIN(t.tracredito) AS tracredito1, t.pago FROM \
			  auxtransac2 t WHERE t.pago IS NOT NULL GROUP BY t.pago");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			if (afectadosxnotascargo != " ") {
				instruccion.sprintf("select \
					caux.pago, caux.reftxcnc, \
					caux.referencia, \
					caux.nota, caux.tipo, \
					caux.factura, cfd.foliocfd, cfd.muuid, caux.fecha, caux.hora, caux.nomcliente, \
					@saldoantes:=(t.valorvta+t.pagado) as saldoantes, \
					@saldodespues:=(t.valorvta+t.pagado+t.valor) as saldodespues, \
					@cargos:=if((t.valorvta+t.pagadosc+t.valor)<0, \
					if((t.valorvta+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorvta+t.pagadosc+t.valor)),  0) as cargos, \
					@subcargos:=@cargos/(1+(ifnull(n.porcentaje, 0)/100)) as subcargos, \
					@ivacargos:=@cargos-@subcargos as ivacargos, \
					@pago:=(t.valor-@cargos) as totpago, \
					(@pago*t.porcentaje0) as proporcion0, \
					(@pago*t.porcentaje15) as proporcion15, \
					(@pago*t.porcentaje16) as proporcion16, \
					(@pago*t.porcentajesub0) as proporcionsub0, \
					(@pago*t.porcentajesub15) as proporcionsub15, \
					(@pago*t.porcentajesub16) as proporcionsub16, \
					(@pago*t.porcentajesubgrabado) as proporcionsubgrabado, \
					(@pago*t.porcentajesubtotal) as proporcionsubtotal, \
					t.porcclasifcont, \
					 %s \
					(@pago*t.porcentajeiva) as proporcioniva, \
					(@pago*t.porcentajeiesps) as proporcioniesps \
					from auxtransac2 t  inner join  ventas v  inner join  clientes cli inner join  cargosaux caux \
					inner join pagoscli pag on pag.pago=t.pago \
					inner join terminales ter on ter.terminal=v.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal=sec.sucursal \
					left join auxtransaccargo n ON v.referencia=n.referencia \
					left join cheqxcob chxc on chxc.pago=pag.pago \
					left join chequesclientes ch on ch.chequecli=chxc.chequecli \
					left join \
						(SELECT \
						  referencia, tipocomprobante, \
						  seriefolio as foliocfd, muuid \
						FROM \
						  cfd where cfd.tipocomprobante='NCAR') cfd \
						ON cfd.referencia = caux.referencia \
					where %s %s %s %s %s %s %s %s %s %s \
					t.tipo='PAGO' and t.referencia=v.referencia and t.tracredito=caux.reftxcpg and \
					v.cliente=cli.cliente and t.fechaapl>='%s' and t.fechaapl<='%s' and \
					v.fechavta>='%s' and v.fechavta<='%s' \
					order by suc.numid, pag.pago, t.horamodi, t.tracredito ",
					campos_propor_impuestos, condicion_empresa, condicion_sucursal,
					condicion_terminal, condicion_cobrador,
					condicion_forma_pago, condicion_tipo_facturacion,
					condicion_cliente, condicion_clientes_partesrel,
					condicion_pago, condicion_origen_ventas,
					fecha_inicial_pagos, fecha_final_pagos,
					fecha_inicial_ventas, fecha_final_ventas);

			}
			else {

				// Condicion si se va a agrupar o no por forma de pago
				if (agruparFormaPago == "NO") {
					instruccion.sprintf("select pag.pago as foliopago, cfdv.rfcreceptor , \
						if(ifnull(v.foliofisic,'')='',concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as factura,cfdv.muuid,  \
						v.referencia, %s \
						v.fechavta,ifnull(ch.fechacob,pag.fecha) as fechapag, ch.folio as numch,IF(pag.formapag='E','Efectivo',IF(pag.formapag='C','Cheque',IF(pag.formapag='T','Transferencia bancaria','Depósito'))) AS formapago, v.cliente, cli.rsocial, \
						IF(ta.tracredito=t.tracredito,pag.ajuste,0) AS ajuste, \
						@valorpago:=%s as valorpago, \
						@saldoantes:=(t.valorvta+t.pagado) as saldoantes, \
						@saldodespues:=(t.valorvta+t.pagado+@valorpago) as saldodespues, \
						@cargos:=if((t.valorvta+t.pagadosc+@valorpago)<0, \
						if((t.valorvta+t.pagadosc+@valorpago)<@valorpago,(@valorpago), (t.valorvta+t.pagadosc+@valorpago)),  0) as cargos, \
						@subcargos:=@cargos/(1+(ifnull(n.porcentaje, 0)/100)) as subcargos, \
						@ivacargos:=@cargos-@subcargos as ivacargos, \
						@pago:=(@valorpago-@cargos) as totpago, \
						(@pago*t.porcentaje0) as proporcion0, \
						(@pago*t.porcentaje15) as proporcion15, \
						(@pago*t.porcentaje16) as proporcion16, \
						(@pago*t.porcentajesub0) as proporcionsub0, \
						(@pago*t.porcentajesub15) as proporcionsub15, \
						(@pago*t.porcentajesub16) as proporcionsub16, \
						(@pago*t.porcentajesubgrabado) as proporcionsubgrabado, \
						(@pago*t.porcentajesubtotal) as proporcionsubtotal, \
						t.porcclasifcont, \
						 %s \
						(@pago*t.porcentajeiva) as proporcioniva, \
						(@pago*t.porcentajeiesps) as proporcioniesps, \
						concat(ifnull(cfdp.serie,''),ifnull(cfdp.folio,'')) as seriefoliopag, cfdp.muuid as muuidpag \
						from auxtransac2 t  inner join  ventas v \
						inner join  clientes cli \
						inner join pagoscli pag on pag.pago=t.pago \
						inner join terminales ter on ter.terminal=v.terminal \
						inner join secciones sec on ter.seccion=sec.seccion \
						inner join sucursales suc on suc.sucursal=sec.sucursal \
						INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago \
						left join auxtransaccargo n ON v.referencia=n.referencia \
						left join cheqxcob chxc on chxc.pago=pag.pago \
						left join chequesclientes ch on ch.chequecli=chxc.chequecli \
						left join cfd cfdv on v.referencia=cfdv.referencia and cfdv.tipocomprobante='VENT' \
						left join cfd cfdp on pag.pago=cfdp.referencia and cfdp.tipocomprobante='PAGO' and cfdv.metodopago33='PPD'  \
						%s %s \
						where %s %s %s %s %s %s %s %s %s \
                        %s \
						t.tipo='PAGO' and t.referencia=v.referencia and \
						v.cliente=cli.cliente and t.fechaapl>='%s' and t.fechaapl<='%s' and \
						v.fechavta>='%s' and v.fechavta<='%s' %s \
						order by suc.numid, pag.pago, t.horamodi, t.tracredito ",
						campo_xml64, campo_valor_pago, campos_propor_impuestos,
						cond_left_join_cfdxml, join_cuentabancaria, condicion_empresa, condicion_sucursal,
						condicion_cobrador, condicion_forma_pago,
						condicion_tipo_facturacion, condicion_cliente,
						condicion_clientes_partesrel, condicion_pago,
						condicion_origen_ventas, condicion_venta,
						fecha_inicial_pagos, fecha_final_pagos,
						fecha_inicial_ventas, fecha_final_ventas,
						condicion_tiporfc);
				}
				else {

					instruccion.sprintf("select \
					IF(pag.formapag = 'D','Depósito',IF(pag.formapag = 'E','Efectivo',IF(pag.formapag = 'T','Trans. bancaria','Cheque'))) AS formapag, \
					sum(@valorpago:=%s) as valorpago, \
					SUM(IF(ta.tracredito=t.tracredito,pag.ajuste,0)) as ajuste, \
					SUM(@saldoantes:=(t.valorvta+t.pagado)) as saldoantes, \
					SUM(@saldodespues:=(t.valorvta+t.pagado+@valorpago)) as saldodespues, \
					SUM(@cargos:=if((t.valorvta+t.pagadosc+@valorpago)<0, \
						if((t.valorvta+t.pagadosc+@valorpago)<@valorpago,(@valorpago), (t.valorvta+t.pagadosc+@valorpago)),  0)) as cargos, \
					SUM(@subcargos:=@cargos/(1+(ifnull(n.porcentaje, 0)/100))) as subcargos, \
					SUM(@ivacargos:=@cargos-@subcargos) as ivacargos, \
					SUM(@pago:=(@valorpago-@cargos)) as totpago, \
					SUM((@pago*t.porcentaje0)) as proporcion0, \
					SUM((@pago*t.porcentaje15)) as proporcion15, \
					SUM((@pago*t.porcentaje16)) as proporcion16, \
					SUM((@pago*t.porcentajesub0)) as proporcionsub0, \
					SUM((@pago*t.porcentajesub15)) as proporcionsub15, \
					SUM((@pago*t.porcentajesub16)) as proporcionsub16, \
					SUM((@pago*t.porcentajesubgrabado)) as proporcionsubgrabado, \
					SUM((@pago*t.porcentajesubtotal)) as proporcionsubtotal, \
					SUM(t.porcclasifcont) as porcclasifcont, \
					 %s \
					SUM((@pago*t.porcentajeiva)) as proporcioniva, \
					SUM((@pago*t.porcentajeiesps)) as proporcioniesps \
					from auxtransac2 t  inner join  ventas v  inner join  clientes cli \
					inner join pagoscli pag on pag.pago=t.pago \
					inner join terminales ter on ter.terminal=v.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal=sec.sucursal \
					INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago \
					left join auxtransaccargo n ON v.referencia=n.referencia \
					left join cheqxcob chxc on chxc.pago=pag.pago \
					left join chequesclientes ch on ch.chequecli=chxc.chequecli \
					left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
					%s \
					where %s %s %s %s %s %s %s %s %s \
					%s \
					t.tipo='PAGO' and t.referencia=v.referencia and \
					v.cliente=cli.cliente and t.fechaapl>='%s' and t.fechaapl<='%s' and \
					v.fechavta>='%s' and v.fechavta<='%s' %s \
					GROUP BY pag.formapag \
					order by suc.numid, pag.pago, t.horamodi, t.tracredito ",
						campo_valor_pago, campos_propor_impuestos_sum,
						join_cuentabancaria, condicion_empresa, condicion_sucursal,
						condicion_cobrador, condicion_forma_pago,
						condicion_tipo_facturacion, condicion_cliente,
						condicion_clientes_partesrel, condicion_pago,
						condicion_origen_ventas, condicion_venta,
						fecha_inicial_pagos, fecha_final_pagos,
						fecha_inicial_ventas, fecha_final_ventas,
						condicion_tiporfc);
				}
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		if (resp_clientes != NULL)
			delete resp_clientes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPAGOSPROV
void ServidorReportes::EjecutaRepPagosProveedores(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i, agrupaxcliente;
	AnsiString fecha_inicial_pagos, fecha_final_pagos, fecha_inicial_compras,
		fecha_final_compras;
	AnsiString forma_pago, proveedor, pago;
	AnsiString condicion_forma_pago = " ";
	AnsiString condicion_proveedor = " ";
	AnsiString condicion_pago = " ";

	AnsiString condicion_clasifcont = " ", condicion_clasifcont_and = " ";
	AnsiString clasifcont;
	AnsiString clasifcont2;
	AnsiString join_clasifcont = " ", campo_total_clasifcont = " ";

	// Impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString cad_totimpuestos_create = "", campos_totimpuestos_create = "",
		cad_totimpuestos_select = "", campos_totimpuestos_select = "";
	AnsiString cad_porcimpuestos_create = "", campos_porcimpuestos_create = "",
		cad_porcimpuestos_select = "", campos_porcimpuestos_select = "";
	AnsiString impuesto_aux = "", tipo_impuesto_aux = "", cad_totimpuestos_col =
		"", campos_totimpuestos_col = "", cad_totimpuestos = "",
		campos_totimpuestos = "", cad_porcimpuestos = "",
		campos_porcimpuestos = "";
	AnsiString cad_porcimpuestosCA = "", campos_porcimpuestosCA = "",
		cad_propor_impuestos = "", campos_propor_impuestos = "";

    AnsiString empresa, condicion_empresa=" ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString proveedores_partesrel, condicion_proveedores_partesrel = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6, archivo_temp7;

	try {
		fecha_inicial_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_compras =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_compras =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		forma_pago = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		pago = mFg.ExtraeStringDeBuffer(&parametros);
		proveedores_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxcliente = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

		clasifcont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);

		instruccion.sprintf("SET SESSION sql_log_bin = 0 ");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SET SESSION tx_isolation='READ-COMMITTED' ");
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los impuestos del tipo IESPS existentes
		instruccion.sprintf("SELECT i.impuesto, LCASE(i.tipoimpu) as tipoimpu FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		} else if(empresa != " "){
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}

		if (forma_pago != " ") {
			condicion_forma_pago.sprintf("pag.formapag='%s' and ", forma_pago);
		}

		if (proveedor != " ") {
			condicion_proveedor.sprintf(" c.proveedor='%s' and ", proveedor);
		}
		if (pago != " ") {
			condicion_pago.sprintf(" t.pago='%s' and ", pago);
		}

		// Es partes relacionadas
		if (proveedores_partesrel != " ") {
			condicion_proveedores_partesrel.sprintf("p.esparterelac=%s and ",
				proveedores_partesrel);
		}

		// clasifcont
		if (clasifcont != " " || clasifcont2 != " ") {
			if (clasifcont != " " && clasifcont2 != " ") {
				condicion_clasifcont.sprintf
					("prod.clasifcont='%s' and prod.clasifcont2='%s'",
					clasifcont, clasifcont2);
			}
			else {
				if (clasifcont != " ") {
					condicion_clasifcont.sprintf("prod.clasifcont='%s'",
						clasifcont);
				}
				else {
					condicion_clasifcont.sprintf("prod.clasifcont2='%s'",
						clasifcont2);
				}
			}

			condicion_clasifcont_and = condicion_clasifcont + " and ";

			join_clasifcont =
				" inner join articulos a on dc.articulo=a.articulo \
							  inner join productos prod on prod.producto=a.producto ";

			campo_total_clasifcont.sprintf(" sum(if( %s, \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as totclasifcont, ", condicion_clasifcont);

		}
		else {
			campo_total_clasifcont.sprintf
				(" sum((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)) ) as totclasifcont, "
				);
		}

		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto_aux = resp_impuestos->ObtieneDato("impuesto");
			tipo_impuesto_aux = resp_impuestos->ObtieneDato("tipoimpu");

			cad_totimpuestos_create.sprintf(" total%s%s decimal(16,4), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_totimpuestos_create += cad_totimpuestos_create;

			cad_totimpuestos_select.sprintf(", 0 as total%s%s ",
				tipo_impuesto_aux, impuesto_aux);
			campos_totimpuestos_select += cad_totimpuestos_select;

			cad_porcimpuestos_create.sprintf(" porcentaje%s%s decimal(16,10), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestos_create += cad_porcimpuestos_create;

			cad_porcimpuestos_select.sprintf(", 0 as porcentaje%s%s ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestos_select += cad_porcimpuestos_select;

			cad_totimpuestos_col.sprintf(" total%s%s, ", tipo_impuesto_aux,
				impuesto_aux);
			campos_totimpuestos_col += cad_totimpuestos_col;

			cad_totimpuestos.sprintf(" sum(if(%s i1.impuesto=%s, \
				(dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0)+ \
				if(%s i2.impuesto=%s, ( ((dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) + ((dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100))) * (i2.porcentaje/100), 0)) as total%s%s, "
				, condicion_clasifcont_and, impuesto_aux,
				condicion_clasifcont_and, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_totimpuestos += cad_totimpuestos;

			cad_porcimpuestos.sprintf
				("porcentaje%s%s=total%s%s/(totaltodo-totalisr), ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_porcimpuestos += cad_porcimpuestos;

			cad_porcimpuestosCA.sprintf("ca.porcentaje%s%s, ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestosCA += cad_porcimpuestosCA;

			if (agrupaxcliente)
				cad_propor_impuestos.sprintf
					("sum(@pago*t.porcentaje%s%s) as proporcion%s%s, ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			else
				cad_propor_impuestos.sprintf
					("(@pago*t.porcentaje%s%s) as proporcion%s%s, ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_propor_impuestos += cad_propor_impuestos;
		}

		instruccion.sprintf("create temporary table referenciasaux (referencia VARCHAR(11), \
			INDEX (referencia)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		// Consulta todas las compras que tienen al menos un pago entre las fechas dadas
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select c.referencia \
			from compras c, transxpag t \
			where %s %s \
			t.fechaapl>='%s' and t.fechaapl<='%s' and \
			t.cancelada=0 and t.aplicada=1 and t.tipo='PAGO' \
			and c.cancelado=0 and c.fechacom>='%s' and c.fechacom<='%s' and \
			t.referencia=c.referencia \
			group by c.referencia INTO OUTFILE '%s'", condicion_proveedor,
			condicion_pago, fecha_inicial_pagos, fecha_final_pagos,
			fecha_inicial_compras, fecha_final_compras, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE referenciasaux ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,

		instruccion.sprintf("create temporary table dnotascredprovaux (compra VARCHAR(11), \
			articulo VARCHAR(9), \
			cantidad DECIMAL(12,3), \
			costo DECIMAL(16,6), \
			costoimp DECIMAL(16,6), \
			INDEX(compra)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		// para luego hacerle un left join con las compras.
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" select c.referencia as compra, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.costo,0)) as costo, \
			sum(if(n.tipo<>'0',d.costoimp,0)) as costoimp \
			from notascredprov n, dnotascredprov d, compras c, referenciasaux ra \
			where n.compra=c.referencia and n.cancelado=0 and c.cancelado=0 and \
			ra.referencia=c.referencia and \
			n.referencia=d.referencia \
			group by c.referencia, d.articulo  INTO OUTFILE '%s'",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE dnotascredprovaux ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla para tener las compras en cuestión
		instruccion.sprintf("create temporary table comprasaux (referencia char(11), \
			totaltodo decimal(16,4), \
			total0 decimal(16,4), total15 decimal(16,4), total16 decimal(16,4), \
			subnograbado decimal(16,4), subtotal15 decimal(16,4), subtotal16 decimal(16,4), subgrabado decimal(16,4), subtotal decimal(16,4), \
			totclasifcont decimal(16,4), \
			%s \
			totaliva decimal(16,4), \
			totaliesps decimal(16,4), totalisr decimal(16,4), valor decimal(16,4), \
			porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			porcclasifcont decimal(16,10), \
			porcclasifcont_sin_isr decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
            porcentajeisr decimal(16,10), \
			INDEX (referencia)) Engine = InnoDB", campos_totimpuestos_create,
			campos_porcimpuestos_create);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		// Crea una tabla para tener las compras en cuestión

		instruccion.sprintf("select '%s' as campos_totimpuestos_col",
			campos_totimpuestos_col);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf(" select c.referencia, \
			sum((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0))) as totaltodo, \
			sum(if(%s \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0) ), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)) , \
				 0)) as total0, \
			sum(if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total15, \
			sum(if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total16, \
				\
			sum(@subnograbado:=if(%s \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as subnograbado, \
			sum(@subtotal15:=if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal15, \
			sum(@subtotal16:=if(%s \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal16, \
			sum(@subgrabado:=@subtotal15+@subtotal16) as subgrabado, \
			sum(@subtotal:=@subtotal15+@subtotal16+@subnograbado) as subtotal, \
			\
			%s \
			%s \
			sum(if(%s i1.tipoimpu='IVA', (dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0) + \
			if(%s i2.tipoimpu='IVA', ( ((dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) + ((dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100))) * (i2.porcentaje/100), 0)) as totaliva, \
			sum(if(%s i1.tipoimpu='IESPS', (dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0)) as totaliesps, \
			sum(if(i5.tipoimpu='ISR', (dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i5.porcentaje/100), 0)) AS totalisr \
			, 0 as valor \
			, 0 as porcentaje0  \
			, 0 as porcentaje15  \
			, 0 as porcentaje16  \
			, 0 as porcentajesub0  \
			, 0 as porcentajesub15  \
			, 0 as porcentajesub16  \
			, 0 as porcentajesubgrabado  \
			, 0 as porcentajesubtotal  \
			, 0 as porcclasifcont  \
			, 0 as porcclasifcont_sin_isr \
			%s \
			, 0 as porcentajeiva  \
			, 0 as porcentajeiesps \
			, if(i5.tipoimpu='ISR', (i5.porcentaje/100), 0) AS porcentajeisr \
			from compras c  inner join  dcompras dc  inner join  referenciasaux ra \
			%s \
			left join dnotascredprovaux dn on dn.articulo=dc.articulo and dn.compra=c.referencia \
			left join impuestos i1 on i1.impuesto=dc.claveimp1 \
			left join impuestos i2 on i2.impuesto=dc.claveimp2 \
			left join impuestos i3 on i3.impuesto=dc.claveimp3 \
			left join impuestos i4 on i4.impuesto=dc.claveimp4 \
			LEFT JOIN impuestos i5 ON i5.impuesto=c.impuestoret \
			where c.referencia=dc.referencia and c.referencia=ra.referencia \
			group by c.referencia \
			order by c.referencia  INTO OUTFILE '%s' ",
			condicion_clasifcont_and, condicion_clasifcont_and,
			condicion_clasifcont_and, condicion_clasifcont_and,
			condicion_clasifcont_and, condicion_clasifcont_and,
			campo_total_clasifcont, campos_totimpuestos,
			condicion_clasifcont_and, condicion_clasifcont_and,
			condicion_clasifcont_and, campos_porcimpuestos_select,
			join_clasifcont, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE comprasaux ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("update comprasaux set valor=totaltodo-totalisr, \
			porcentaje0=total0/(totaltodo-totalisr), \
			porcentaje15=total15/(totaltodo-totalisr), \
			porcentaje16=total16/(totaltodo-totalisr), \
			porcentajesub0=subnograbado/(totaltodo-totalisr), \
			porcentajesub15=subtotal15/(totaltodo-totalisr), \
			porcentajesub16=subtotal16/(totaltodo-totalisr), \
			porcentajesubgrabado=subgrabado/(totaltodo-totalisr), \
			porcentajesubtotal=subtotal/(totaltodo-totalisr), \
			porcclasifcont=totclasifcont/(totaltodo-totalisr), \
			porcclasifcont_sin_isr=(totclasifcont-totalisr)/(totaltodo-totalisr), \
			%s \
			porcentajeiva=totaliva/(totaltodo-totalisr), \
			porcentajeiesps=totaliesps/(totaltodo-totalisr)",
			campos_porcimpuestos);
		instrucciones[num_instrucciones++] = instruccion;

		/* separar tablas en 3 partes */
		instruccion.sprintf("CREATE TEMPORARY TABLE auxtransac( \
						tracredito VARCHAR(11), concepto VARCHAR(11), destino VARCHAR(11), referencia VARCHAR(11), tipo VARCHAR(11), pago VARCHAR(11), \
						valor decimal(16,2), valorcompra decimal(16,4), fechaapl date, horamodi time, totclasifcont decimal(16,4), \
						totaltodo decimal(16,4), porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
						porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10), \
						porcentajesubgrabado decimal(16,10), porcentajesubtotal decimal(16,10), \
						porcclasifcont decimal(16,10), porcclasifcont_sin_isr decimal(16,10), \
						%s \
						porcentajeiva decimal(16,10), porcentajeiesps decimal(16,10), \
						porcentajeisr decimal(16,10), \
						INDEX (referencia), INDEX (tracredito)) ENGINE = INNODB"
			, campos_porcimpuestos_create);
		instrucciones[num_instrucciones++] = instruccion;
		/* ARCHIVO TEMPORAL No.5 */

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select t.tracredito, t.concepto, t.destino, t.referencia , t.tipo, t.pago, \
			t.valor, ca.valor as valorcompra, t.fechaapl, t.horamodi, \
			ca.totclasifcont, ca.totaltodo, \
			ca.porcentaje0, ca.porcentaje15, ca.porcentaje16, \
			ca.porcentajesub0, ca.porcentajesub15, ca.porcentajesub16, ca.porcentajesubgrabado, ca.porcentajesubtotal, \
			ca.porcclasifcont, ca.porcclasifcont_sin_isr, %s  ca.porcentajeiva, ca.porcentajeiesps, ca.porcentajeisr \
			from comprasaux ca, transxpag t \
			where t.cancelada=0 and t.aplicada=1 and t.referencia=ca.referencia \
			and t.tipo<>'DEVO' and t.tipo<>'COMP' \
			order by t.referencia, t.fechaapl, t.horamodi INTO OUTFILE '%s' ",
			campos_porcimpuestosCA, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf(" LOAD DATA INFILE '%s' INTO TABLE  auxtransac",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		/*
		 instruccion.sprintf("create temporary table auxtransac \
		 select t.tracredito, t.concepto, t.destino, t.referencia , t.tipo, t.pago, \
		 t.valor, ca.valor as valorcompra, t.fechaapl, t.horamodi, \
		 ca.totclasifcont, ca.totaltodo, \
		 ca.porcentaje0, ca.porcentaje15, ca.porcentaje16, \
		 ca.porcentajesub0, ca.porcentajesub15, ca.porcentajesub16, ca.porcentajesubgrabado, ca.porcentajesubtotal, \
		 ca.porcclasifcont, %s  ca.porcentajeiva, ca.porcentajeiesps \
		 from comprasaux ca, transxpag t \
		 where t.cancelada=0 and t.aplicada=1 and t.referencia=ca.referencia \
		 and t.tipo<>'DEVO' and t.tipo<>'COMP' \
		 order by t.referencia, t.fechaapl, t.horamodi ", campos_porcimpuestosCA);
		 instrucciones[num_instrucciones++]=instruccion;

		 */

		/* FIN ARCHIVO TEMPORAL No.6 */

		instruccion.sprintf("CREATE TEMPORARY TABLE auxtransacb( \
					tracredito VARCHAR(11), concepto VARCHAR(11), destino VARCHAR(11), referencia VARCHAR(11), tipo VARCHAR(11), pago VARCHAR(11), \
					valor decimal(16,4), valorcompra decimal(16,4), fechaapl date, horamodi TIME, \
					totclasifcont decimal(16,4), totaltodo decimal(16,4), porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
					porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10), porcentajesubgrabado decimal(16,10), \
					porcentajesubtotal decimal(16,10), porcclasifcont decimal(16,10), porcclasifcont_sin_isr decimal(16,10), \
					%s \
					porcentajeiva decimal(16,10), porcentajeiesps decimal(16,10), porcentajeisr decimal(16,10), \
					INDEX (referencia), INDEX (tracredito)) ENGINE = INNODB",
			campos_porcimpuestos_create);
		instrucciones[num_instrucciones++] = instruccion;
		/* ARCHIVO TEMPORAL No.6 */

		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" select t.tracredito, t.concepto, t.destino, t.referencia , t.tipo, t.pago, \
			t.valor, ca.valor as valorcompra, t.fechaapl, t.horamodi, \
			ca.totclasifcont, ca.totaltodo, \
			ca.porcentaje0, ca.porcentaje15, ca.porcentaje16, \
			ca.porcentajesub0, ca.porcentajesub15, ca.porcentajesub16, ca.porcentajesubgrabado, ca.porcentajesubtotal, \
			ca.porcclasifcont, ca.porcclasifcont_sin_isr, %s ca.porcentajeiva, ca.porcentajeiesps, ca.porcentajeisr \
			from comprasaux ca, transxpag t \
			where t.cancelada=0 and t.aplicada=1 and t.referencia=ca.referencia \
			and t.tipo<>'DEVO' and t.tipo<>'COMP' \
			order by t.referencia, t.fechaapl, t.horamodi INTO OUTFILE '%s' ",
			campos_porcimpuestosCA, archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf(" LOAD DATA INFILE '%s' INTO TABLE  auxtransacb",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		/* instruccion.sprintf("create temporary table auxtransacb \
		 select t.tracredito, t.concepto, t.destino, t.referencia , t.tipo, t.pago, \
		 t.valor, ca.valor as valorcompra, t.fechaapl, t.horamodi, \
		 ca.totclasifcont, ca.totaltodo, \
		 ca.porcentaje0, ca.porcentaje15, ca.porcentaje16, \
		 ca.porcentajesub0, ca.porcentajesub15, ca.porcentajesub16, ca.porcentajesubgrabado, ca.porcentajesubtotal, \
		 ca.porcclasifcont, %s ca.porcentajeiva, ca.porcentajeiesps \
		 from comprasaux ca, transxpag t \
		 where t.cancelada=0 and t.aplicada=1 and t.referencia=ca.referencia \
		 and t.tipo<>'DEVO' and t.tipo<>'COMP' \
		 order by t.referencia, t.fechaapl, t.horamodi ", campos_porcimpuestosCA);
		 instrucciones[num_instrucciones++]=instruccion; */

		/* ARCHIVO TEMPORAL No.7 */

		/* instruccion.sprintf("CREATE TEMPORARY TABLE auxtransac2( \
		 tracredito VARCHAR(11), concepto VARCHAR(11), destino VARCHAR(11), referencia VARCHAR(11), tipo VARCHAR(11), pago VARCHAR(11), \
		 valor decimal(16,4), valorcompra decimal(16,4), fechaapl date, horamodi time, totclasifcont decimal(16,4), \
		 totaltodo decimal(16,4), porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
		 porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10), \
		 porcentajesubgrabado decimal(16,10), porcentajesubtotal decimal(16,10), \
		 porcclasifcont decimal(16,10), porcentajeiva2 decimal(16,10), porcentajeiva8 decimal(16,10),  \
		 porcentajeiesps12 decimal(16,10), porcentajeiesps13 decimal(16,10), porcentajeiesps11 decimal(16,10), \
		 porcentajeiesps3 decimal(16,10), porcentajeiesps4 decimal(16,10), porcentajeiesps9 decimal(16,10), \
		 porcentajeiesps5 decimal(16,10), porcentajeiesps6 decimal(16,10), porcentajeiesps10 decimal(16,10),  \
		 porcentajeiva decimal(16,10), porcentajeiesps decimal(16,10), \
		 porcentajeisr decimal(16,10), pagado decimal(16,4), pagadosc decimal(16,4), \
		 INDEX (referencia), INDEX (tracredito)) ENGINE = INNODB	");

		 */

		instruccion.sprintf("CREATE TEMPORARY TABLE auxtransac2( \
					tracredito VARCHAR(11), concepto VARCHAR(11), destino VARCHAR(11), referencia VARCHAR(11), tipo VARCHAR(11), pago VARCHAR(11), \
					valor decimal(16,4), valorcompra decimal(16,4), fechaapl date, horamodi time, totclasifcont decimal(16,4), \
					totaltodo decimal(16,4), porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
					porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10), \
					porcentajesubgrabado decimal(16,10), porcentajesubtotal decimal(16,10), \
					porcclasifcont decimal(16,10), porcclasifcont_sin_isr decimal(16,10), %s \
					porcentajeiva decimal(16,10), porcentajeiesps decimal(16,10), \
					porcentajeisr decimal(16,10), pagado decimal(16,4), pagadosc decimal(16,4), \
					INDEX (referencia), INDEX (tracredito)) ENGINE = INNODB	",
			campos_porcimpuestos_create);

		instrucciones[num_instrucciones++] = instruccion;
		/* ARCHIVO TEMPORAL No.7 */

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("  select t.*, \
			sum(if( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito),    t2.valor,0    )) as pagado, \
			sum(if(( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito)) and (t2.tipo='PAGO' or t2.tipo='CHDE'),    t2.valor,0    )) as pagadosc \
			from auxtransac t, auxtransacb t2 \
			where t.referencia=t2.referencia \
			group by t.referencia,t.tracredito \
			order by t.referencia, t.fechaapl, t.horamodi, t.tracredito INTO OUTFILE '%s' "
			, archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf(" LOAD DATA INFILE '%s' INTO TABLE  auxtransac2",
			archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		/* FIN ARCHIVO No. 7 */

		/* instruccion.sprintf("create temporary table auxtransac2 \
		 select t.*, \
		 sum(if( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito),    t2.valor,0    )) as pagado, \
		 sum(if(( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)  and t2.tracredito<t.tracredito)) and (t2.tipo='PAGO' or t2.tipo='CHDE'),    t2.valor,0    )) as pagadosc \
		 from auxtransac t, auxtransacb t2 \
		 where t.referencia=t2.referencia \
		 group by t.referencia,t.tracredito \
		 order by t.referencia, t.fechaapl, t.horamodi, t.tracredito ");
		 instrucciones[num_instrucciones++]=instruccion; */

		// Crea una tabla con la transacción de crédito con folio menor de cada pago (la primera aplicada)
		// pasa solo a esta aplicarle el ajuste y evitar el error que habia de aplicar el ajuste en todas las transacciones.
		instruccion.sprintf("CREATE TEMPORARY TABLE auxtransacAjuste ( \
			tracredito VARCHAR(11), \
			pago VARCHAR(11), \
			INDEX (pago), INDEX (tracredito)) ENGINE = INNODB");
		instrucciones[num_instrucciones++] = instruccion;
		/* ARCHIVO TEMPORAL No.8 */

		archivo_temp7 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT MIN(t.tracredito) AS tracredito1, t.pago FROM \
			  auxtransac2 t WHERE t.pago IS NOT NULL GROUP BY t.pago INTO OUTFILE '%s' "
			, archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			(" LOAD DATA INFILE '%s' INTO TABLE  auxtransacAjuste",
			archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;
		/* FIN ARCHIVO TEMPORAL No.8 */

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// borrar archivos temporales
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			mServidorVioleta->BorraArchivoTemp(archivo_temp7);

			if (agrupaxcliente)
				instruccion.sprintf("select pag.pago as foliopago, c.folioprov as factura, c.muuid, p.rfc , IF(cfdi.emitecpago=1, 'Si', IF(cfdi.emitecpago=0, 'No', '')) AS emitecpago, \
					c.fechacom, ifnull(ch.fechacob,pag.fecha) as fechapag, ch.folio as numch, c.proveedor, p.razonsocial as rsocial, \
					SUM(IF(ta.tracredito=t.tracredito,pag.ajuste,0)) as ajuste, IF(ta.tracredito=t.tracredito,pag.ajuste_bancario,0) AS ajuste_bancario, \
					sum(@saldodespues:=(t.valorcompra+t.pagado+t.valor)*t.porcclasifcont_sin_isr) as saldodespues, \
					sum(@cargos:=if((t.valorcompra+t.pagadosc+t.valor)<0, \
						if((t.valorcompra+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorcompra+t.pagadosc+t.valor)),  0)) as cargosgeneral, \
					sum(if((t.valorcompra+t.pagadosc+t.valor)<0, \
						if((t.valorcompra+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorcompra+t.pagadosc+t.valor)),  0)*t.porcclasifcont) as cargos, \
					SUM(@propisrpago:=((((((t.valor-@cargos))*t.porcentajesub0)) + (((t.valor-@cargos))*t.porcentajesub15) + \
					((((t.valor-@cargos))*t.porcentajesub16)))*t.porcentajeisr)) AS propisrpago, \
					sum(@pago:=(t.valor-@cargos)) as totpagogeneral, \
					sum(((t.valor-@cargos)*t.porcclasifcont) - @propisrpago) as totpago, \
					sum(@pago*t.porcentaje0) as proporcion0, \
					sum(@pago*t.porcentaje15) as proporcion15, \
					sum(@pago*t.porcentaje16) as proporcion16, \
					sum(@proporcionsub0:=(@pago*t.porcentajesub0)) as proporcionsub0, \
					sum(@proporcionsub15:=(@pago*t.porcentajesub15)) as proporcionsub15, \
					sum(@proporcionsub16:=(@pago*t.porcentajesub16)) as proporcionsub16, \
					sum(@pago*t.porcentajesubgrabado) as proporcionsubgrabado, \
					sum(@pago*t.porcentajesubtotal) as proporcionsubtotal, \
					sum(t.totclasifcont)/sum(t.totaltodo) as porcclasifcont, \
					 %s \
					sum(@pago*t.porcentajeiva) as proporcioniva, \
					sum(@pago*t.porcentajeiesps) as proporcioniesps, \
					SUM((@proporcionsub0+@proporcionsub15+@proporcionsub16)*t.porcentajeisr) as proporcionisr, \
					IFNULL(pag.muuid,'') as uuidpago, IFNULL(pag.ident,'') as seriefoliopago \
					from auxtransac2 t  inner join  compras c  inner join  proveedores p \
					inner join pagosprov pag on pag.pago=t.pago \
					inner join terminales ter on ter.terminal=c.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal=sec.sucursal \
					INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago \
					left join cheqxpag chxp on chxp.pago=pag.pago \
					left join chequesproveedores ch on ch.chequeprov=chxp.chequeprov \
					left join cfdicompras cfdi ON cfdi.referencia = c.referencia \
					where %s %s %s %s %s %s \
					t.tipo='PAGO' and t.referencia=c.referencia and \
					c.proveedor=p.proveedor and t.fechaapl>='%s' and t.fechaapl<='%s' and \
					c.fechacom>='%s' and c.fechacom<='%s' \
					group by c.proveedor \
					order by pag.pago, t.fechaapl, t.horamodi, suc.numid, p.razonsocial ", campos_propor_impuestos,
                    condicion_empresa, condicion_sucursal, condicion_proveedores_partesrel,
				condicion_forma_pago, condicion_proveedor, condicion_pago,
				fecha_inicial_pagos, fecha_final_pagos, fecha_inicial_compras,
				fecha_final_compras);
			else
				instruccion.sprintf("select pag.pago as foliopago, c.folioprov as factura, c.muuid, p.rfc , IF(cfdi.emitecpago=1, 'Si', IF(cfdi.emitecpago=0, 'No', '')) AS emitecpago, \
					c.fechacom, ifnull(ch.fechacob,pag.fecha) as fechapag, sec.sucursal, c.proveedor, p.razonsocial as rsocial, \
					IF(ta.tracredito=t.tracredito,pag.ajuste,0) AS ajuste, IF(ta.tracredito=t.tracredito,pag.ajuste_bancario,0) AS ajuste_bancario, \
					@saldodespues:=(t.valorcompra+t.pagado+t.valor)*t.porcclasifcont_sin_isr as saldodespues, \
					@cargos:=if((t.valorcompra+t.pagadosc+t.valor)<0, \
						if((t.valorcompra+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorcompra+t.pagadosc+t.valor)),  0) as cargosgeneral, \
					if((t.valorcompra+t.pagadosc+t.valor)<0, \
						if((t.valorcompra+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorcompra+t.pagadosc+t.valor)),  0)*t.porcclasifcont as cargos, \
					(((t.valor-@cargos)*t.porcclasifcont) - \
					((((((t.valor-@cargos))*t.porcentajesub0))+ \
					(((t.valor-@cargos))*t.porcentajesub15)+ \
					((((t.valor-@cargos))*t.porcentajesub16)))*t.porcentajeisr)) as totpago, \
					@pago:=(t.valor-@cargos) as totpagogeneral, \
					(@pago*t.porcentaje0) as proporcion0, \
					(@pago*t.porcentaje15) as proporcion15, \
					(@pago*t.porcentaje16) as proporcion16, \
					@proporcionsub0:=(@pago*t.porcentajesub0) as proporcionsub0, \
					@proporcionsub15:=(@pago*t.porcentajesub15) as proporcionsub15, \
					@proporcionsub16:=(@pago*t.porcentajesub16) as proporcionsub16, \
					(@pago*t.porcentajesubgrabado) as proporcionsubgrabado, \
					(@pago*t.porcentajesubtotal) as proporcionsubtotal, \
					((@proporcionsub0+@proporcionsub15+@proporcionsub16)*t.porcentajeisr) as proporcionisr, \
					t.porcclasifcont, \
					 %s \
					(@pago*t.porcentajeiva) as proporcioniva, \
					(@pago*t.porcentajeiesps) as proporcioniesps, \
					IFNULL(pag.muuid,'') as uuidpago, IFNULL(pag.ident,'') as seriefoliopago \
					from auxtransac2 t  inner join  compras c  inner join  proveedores p \
					inner join pagosprov pag on pag.pago=t.pago \
					inner join terminales ter on ter.terminal=c.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
					inner join sucursales suc on suc.sucursal=sec.sucursal \
					INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago \
					left join cheqxpag chxp on chxp.pago=pag.pago \
					left join chequesproveedores ch on ch.chequeprov=chxp.chequeprov \
					left join cfdicompras cfdi ON cfdi.referencia = c.referencia \
					where %s %s %s %s %s %s\
					t.tipo='PAGO' and t.referencia=c.referencia and \
					c.proveedor=p.proveedor and t.fechaapl>='%s' and t.fechaapl<='%s' and \
					c.fechacom>='%s' and c.fechacom<='%s' \
					order by pag.pago, t.fechaapl, t.horamodi, suc.numid, t.tracredito ",
				campos_propor_impuestos, condicion_empresa, condicion_sucursal,
				condicion_proveedores_partesrel, condicion_forma_pago,
				condicion_proveedor, condicion_pago, fecha_inicial_pagos,
				fecha_final_pagos, fecha_inicial_compras, fecha_final_compras);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
		if (resp_impuestos != NULL)
			delete resp_impuestos;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPMOVALMA_X_MOV
void ServidorReportes::EjecutaRepMovAlmaXMov(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString almacen, articulo;
	AnsiString fecha_inicial, fecha_final;
	AnsiString tipo, aplica, estado, concepto, almaent, almasal, chofer, folio,
		proveedor, condicion_proveedor = " ";
	AnsiString condicion_tipo = " ", condicion_concepto = " ",
		condicion_almaent = " ";
	AnsiString condicion_almasal = " ", condicion_chofer = " ",
		condicion_folio = " ", condicion_aplica = " ", condicion_estado = " ";
	AnsiString usuario, condicion_fechamod = " ";
	AnsiString condicion_conceptosmovalma = " AND c.protegido=0 ",
		condicion_auditado = " ";
	AnsiString incluir_fechamod, fecha_modini, fecha_modfin, auditado;
	BufferRespuestas *resp_usuario = NULL;

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	usuario = mFg.ExtraeStringDeBuffer(&parametros); // Usuario que busca
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	aplica = mFg.ExtraeStringDeBuffer(&parametros);
	estado = mFg.ExtraeStringDeBuffer(&parametros);
	concepto = mFg.ExtraeStringDeBuffer(&parametros);
	almaent = mFg.ExtraeStringDeBuffer(&parametros);
	almasal = mFg.ExtraeStringDeBuffer(&parametros);
	chofer = mFg.ExtraeStringDeBuffer(&parametros);
	folio = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	incluir_fechamod = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_modini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_modfin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	auditado = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	// Obtiene si el usuario tiene o no el privilegio para ver movimientos protegidos
	try {
		instruccion.sprintf("SELECT * FROM(( SELECT u.empleado, ar.objeto, ar.privilegio \
		FROM usuarios u INNER JOIN usuariorol ur ON ur.usuario = u.empleado \
		INNER JOIN asignacionprivrol ar ON ur.rol=ar.rol) UNION ( \
		SELECT a.usuario AS empleado, a.objeto, a.privilegio \
		FROM asignacionprivilegios a) UNION ( SELECT u.empleado, ar.objeto, ar.privilegio \
		FROM usuarios u INNER JOIN empleados e ON e.empleado = u.empleado \
		INNER JOIN puestos p ON p.puesto = e.puesto \
		INNER JOIN rolesxpuesto rxp ON rxp.puesto = p.puesto \
		INNER JOIN asignacionprivrol ar ON rxp.rol=ar.rol)) AS asigprivtotal \
		WHERE asigprivtotal.empleado='%s' AND asigprivtotal.objeto='PROTEGALM' AND asigprivtotal.privilegio='CON'"
			, usuario);

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_usuario);
		// Si el usuario tiene el privilegio entonces quita la condicion de solo los protegidos.
		if (resp_usuario->ObtieneNumRegistros() > 0)
			condicion_conceptosmovalma = " ";
	}
	__finally {
		if (resp_usuario != NULL)
			delete resp_usuario;
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf("m.proveedor='%s' and ", proveedor);
	}

	if (tipo != " ") {
		condicion_tipo.sprintf("m.tipo='%s' and ", tipo);
	}

	if (aplica != " ") {
		condicion_aplica.sprintf("m.aplica='%s' and ", aplica);
	}

	if (estado != " ") {
		condicion_estado.sprintf("m.cancelado='%s' and ", estado);
	}

	if (concepto != " ") {
		condicion_concepto.sprintf("m.concepto='%s' and ", concepto);
	}

	if (almaent != " ") {
		condicion_almaent.sprintf("m.almaent='%s' and ", almaent);
	}

	if (almasal != " ") {
		condicion_almasal.sprintf("m.almasal='%s' and ", almasal);
	}

	if (chofer != " ") {
		condicion_chofer.sprintf("m.chofer='%s' and ", chofer);
	}

	if (folio != " ") {
		condicion_folio.sprintf("m.folioenvio='%s' and ", folio);
	}

	if (incluir_fechamod == "SI") {
		condicion_fechamod.sprintf
			(" AND m.fechamodi>='%s' AND m.fechamodi<='%s' ", fecha_modini,
			fecha_modfin);
	}

	if (auditado != " ") {
		condicion_auditado.sprintf(" AND m.auditado = %d", StrToInt(auditado));
	}

	// Movimientos que cumplen con los parámetros
	instruccion.sprintf("select m.*, \
		SUM(if(m.tipo='T',0,if(m.tipo='E', IFNULL(d.costo,0)*IFNULL(d.cantidad,0), IFNULL(d.costo,0)*IFNULL(d.cantidad,0)*-1))) AS costo, \
		concat(e.nombre, ' ', e.appat, ' ', e.apmat)  as nomchofer, \
		c.descripcion as nomconcepto, \
		prov.razonsocial as nombreprov, \
		m.auditadopor,               \
		concat(em.nombre, ' ', em.appat, ' ', em.apmat) as nomusu \
		from movalma m \
		inner join conceptosmovalma c on c.concepto=m.concepto \
		LEFT JOIN dmovalma d ON m.movimiento=d.movimiento \
		left join empleados e on e.empleado=m.chofer \
		left join proveedores prov on prov.proveedor=m.proveedor \
		left join empleados em on em.empleado=m.auditadopor \
		where %s %s %s %s %s %s %s %s %s \
		m.fechamov>='%s' and m.fechamov<='%s' %s  %s %s \
		GROUP BY m.movimiento ", condicion_tipo, condicion_concepto,
		condicion_almaent, condicion_almasal, condicion_chofer, condicion_folio,
		condicion_proveedor, condicion_aplica, condicion_estado, fecha_inicial,
		fecha_final, condicion_conceptosmovalma, condicion_fechamod,
		condicion_auditado);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPMOVALMA_X_ARTICULO
void ServidorReportes::EjecutaRepMovAlmaXArticulo(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString almacen, articulo;
	AnsiString fecha_inicial, fecha_final;
	AnsiString tipo, aplica, estado, concepto, almaent, almasal, chofer, folio,
		proveedor, condicion_proveedor = " ";
	AnsiString condicion_tipo = " ", condicion_concepto = " ",
		condicion_almaent = " ";
	AnsiString condicion_almasal = " ", condicion_chofer = " ",
		condicion_folio = " ", condicion_aplica = " ", condicion_estado = " ";
	AnsiString producto, condicion_producto = " ";

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	aplica = mFg.ExtraeStringDeBuffer(&parametros);
	estado = mFg.ExtraeStringDeBuffer(&parametros);
	concepto = mFg.ExtraeStringDeBuffer(&parametros);
	almaent = mFg.ExtraeStringDeBuffer(&parametros);
	almasal = mFg.ExtraeStringDeBuffer(&parametros);
	chofer = mFg.ExtraeStringDeBuffer(&parametros);
	folio = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (proveedor != " ") {
		condicion_proveedor.sprintf("m.proveedor='%s' and ", proveedor);
	}

	if (tipo != " ") {
		condicion_tipo.sprintf("m.tipo='%s' and ", tipo);
	}

	if (aplica != " ") {
		condicion_aplica.sprintf("m.aplica='%s' and ", aplica);
	}

	if (estado != " ") {
		condicion_estado.sprintf("m.cancelado='%s' and ", estado);
	}

	if (concepto != " ") {
		condicion_concepto.sprintf("m.concepto='%s' and ", concepto);
	}

	if (almaent != " ") {
		condicion_almaent.sprintf("m.almaent='%s' and ", almaent);
	}

	if (almasal != " ") {
		condicion_almasal.sprintf("m.almasal='%s' and ", almasal);
	}

	if (chofer != " ") {
		condicion_chofer.sprintf("m.chofer='%s' and ", chofer);
	}

	if (folio != " ") {
		condicion_folio.sprintf("m.folioenvio='%s' and ", folio);
	}

	if (producto != " ") {
		condicion_producto.sprintf("a.producto='%s' and ", producto);
	}

	// m.fechamov>='%s' and m.fechamov<='%s' AND m.aplica=1 and m.cancelado=0

	// Artículos
	instruccion.sprintf("select m.movimiento,m.folioenvio, m.tipo, m.almaent, m.almasal, m.fechamov,m.transfor, \
		if(m.tipo='T',0,if(m.tipo='E', IFNULL(dm.costo,0)*IFNULL(dm.cantidad,0), IFNULL(dm.costo,0)*IFNULL(dm.cantidad,0)*-1)) AS costo, \
		cm.descripcion as nomconcepto, dm.cantidad, a.multiplo, pr.nombre, a.present, a.articulo \
		from movalma m  inner join  dmovalma dm  inner join  articulos a  inner join  productos pr \
		left join empleados e on e.empleado=m.chofer \
		left join conceptosmovalma cm on cm.concepto=m.concepto \
		where a.articulo=dm.articulo and m.movimiento=dm.movimiento \
		and a.producto=pr.producto \
		and %s %s %s %s %s %s %s %s %s %s \
		m.fechamov>='%s' and m.fechamov<='%s' \
		ORDER BY pr.nombre, a.present, a.factor, m.fechamov ", condicion_tipo,
		condicion_concepto, condicion_almaent, condicion_almasal,
		condicion_chofer, condicion_folio, condicion_proveedor,
		condicion_producto, condicion_aplica, condicion_estado, fecha_inicial,
		fecha_final);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDCLI_X_ARTICULO
void ServidorReportes::EjecutaRepNotcredcliXArticulo
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, fecha_inicial_ventas,
		fecha_final_ventas, tipo, almacen, producto;
	AnsiString clasif1, clasif2, clasif3, clasifcont1, clasifcont2;
	AnsiString condicion_tipo = " ", condicion_almacen = " ",
		condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_clasifcont1 = " ", condicion_clasifcont2 = " ";
	AnsiString campos_base = " ";
	AnsiString condicion_canceladas = " ", canceladas, tipo_canceladas,
		fechas_canceladas = " ";
	AnsiString tipofacturacion, cliente, condicion_tipofac = " ",
		condicion_cliente = " ";
	AnsiString articulo, condicion_articulo = " ", agrupamiento;
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString condicion_terminospago = " ", terminospago;
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString tipo_impuestos, impuesto_particular, negar_impuestos,
		condicion_tipo_imp = " ", condicion_imp = " ";
	AnsiString tipo_impuestos2, impuesto_particular2, negar_impuestos2,
		condicion_tipo_imp2 = " ", condicion_imp2 = " ";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";
	AnsiString vendedor, condicion_vendedor = " ", condicion_formaspago = " ";
	AnsiString supervisor, condicionSupervisado = " ", join_supervisor = " ";
	AnsiString venta, condicion_venta = " ", nota, condicion_nota = " ",
		termino_venta, condicion_ter_venta = " ";
	AnsiString agrupar_por_referencia, criterio_referencia = " ";
	AnsiString detalles_devolucion, joins_detalles_devolucion = " ", campos_detalles_devolucion = " ";
	AnsiString empleado, puesto, motivo, condicion_empleado = " ", condicion_puesto = " ", condicion_motivo = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		articulo = mFg.ExtraeStringDeBuffer(&parametros);
		terminospago = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		supervisor = mFg.ExtraeStringDeBuffer(&parametros);
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		nota = mFg.ExtraeStringDeBuffer(&parametros);
		termino_venta = mFg.ExtraeStringDeBuffer(&parametros);
		agrupar_por_referencia = mFg.ExtraeStringDeBuffer(&parametros);
		detalles_devolucion = mFg.ExtraeStringDeBuffer(&parametros);
		empleado = mFg.ExtraeStringDeBuffer(&parametros);
		puesto = mFg.ExtraeStringDeBuffer(&parametros);
		motivo = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if(empresa != " "){
			condicion_empresa.sprintf("suc.idempresa = %s AND ", empresa);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		}

		if(agrupar_por_referencia == "1")
			criterio_referencia = " n.referencia,";

		agrupamiento.sprintf("group by %s prod.nombre, articulos.present, articulos.multiplo \
		order by %s prod.nombre, articulos.present, articulos.multiplo",
		criterio_referencia, criterio_referencia);

		if (articulo != " ") {
			campos_base +=
				"cli.rsocial as nomcliente, v.referencia, n.fechanot, ";
			condicion_articulo.sprintf("dv.articulo='%s' and ", articulo);
			agrupamiento =
				"group by n.referencia, prod.nombre, articulos.present, articulos.multiplo \
						order by n.referencia, prod.nombre, articulos.present, articulos.multiplo";
		}
		if (tipofacturacion != " ") {
			condicion_tipofac.sprintf("v.tipofac='%s' and ", tipofacturacion);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (venta != " ") {
			condicion_venta.sprintf("v.referencia='%s' and", venta);
		}
		if (termino_venta != " ") {
			condicion_ter_venta.sprintf(" v.acredito='%s' and ", termino_venta);
		}
		if (nota != " ") {
			condicion_nota.sprintf("n.referencia='%s' and", nota);
		}

		if (tipo_impuestos != " ") {
			if (negar_impuestos == "0")
				condicion_tipo_imp.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
			else
				condicion_tipo_imp.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') and ",
				tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
		}
		if (impuesto_particular != " ") {
			if (negar_impuestos == "0")
				condicion_imp.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
			else
				condicion_imp.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s) and ",
				impuesto_particular, impuesto_particular, impuesto_particular,
				impuesto_particular);
		}
		if (tipo_impuestos2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_tipo_imp2.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s') and ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);
			else
				condicion_tipo_imp2.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s') and ",
				tipo_impuestos2, tipo_impuestos2, tipo_impuestos2,
				tipo_impuestos2);
		}
		if (impuesto_particular2 != " ") {
			if (negar_impuestos2 == "0")
				condicion_imp2.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s) and ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);
			else
				condicion_imp2.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s) and ",
				impuesto_particular2, impuesto_particular2,
				impuesto_particular2, impuesto_particular2);
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("dv.almacen='%s' and ", almacen);
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}

		if (clasifcont1 != " ") {
			condicion_clasifcont1.sprintf("prod.clasifcont='%s' and ",
				clasifcont1);
		}
		if (clasifcont2 != " ") {
			condicion_clasifcont2.sprintf("prod.clasifcont2='%s' and ",
				clasifcont2);
		}

		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}

		if (tipo != " ") {
			condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("n.fechanot>='%s' and n.fechanot<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}
		if (terminospago != " ") {
			condicion_formaspago.sprintf
				(" INNER JOIN dventasfpago dvfp ON dvfp.referencia=v.referencia "
				);
			condicion_terminospago.sprintf
				(" INNER JOIN formasdepago fp ON dvfp.formapag = fp.formapag AND fp.termino='%s' ",
				terminospago);
		}
		if (clientes_partesrel != " ") {
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s and ",
				clientes_partesrel);
		}
		if (vendedor != " ") {
			condicion_vendedor.sprintf("v.vendedor = '%s' and ", vendedor);
		}
		if (supervisor != " ") {
			join_supervisor =
				"LEFT JOIN articulossupervisados arsu ON arsu.present=articulos.present AND arsu.producto = articulos.producto";
			condicionSupervisado.sprintf(" arsu.usuario='%s' and ", supervisor);
		}
		if(detalles_devolucion == "1"){
			joins_detalles_devolucion = " LEFT JOIN empleados em ON em.empleado = dn.empleado_responsable \
				LEFT JOIN puestos pu ON pu.puesto = em.puesto \
				LEFT JOIN catalogo_motivos_devolucion cm ON cm.clave_motivo = dn.clave_motivo ";

			campos_detalles_devolucion = " cm.descripcion as descripcion_motivo, \
			CONCAT(em.nombre, ' ', em.appat, ' ', em.apmat) AS nombre_empleado, pu.nombre AS nombre_puesto, ";
		}

		if(empleado != " "){
			condicion_empleado.sprintf(" AND dn.empleado_responsable = '%s' ", empleado);
		}

		if(puesto != " "){
			condicion_puesto.sprintf(" AND pu.puesto = '%s' ", puesto);
		}

		if(motivo != " "){
			if(motivo == "NULL"){
				condicion_motivo.sprintf(" AND cm.clave_motivo IS NULL ");
			}else{
				condicion_motivo.sprintf(" AND cm.clave_motivo =  '%s' ", motivo);
			}
		}

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicialventas='%s'",
			fecha_inicial_ventas);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinalventas='%s'", fecha_final_ventas);
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("select %s n.referencia as nota, \
			sum(if(n.tipo='0',dn.cantidad,0)) as cantxart, articulos.articulo, \
			articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
			n.referencia, n.foliofisic as nota, n.tipo as tipo, \
			if(n.tipo=0, 'DEVOLUCION', if(n.tipo=1, 'BONIFICACION', 'DESCUENTO')) as tipodescrito, \
			v.referencia as venta, v.foliofisic as factura, v.fechavta, \
			if(ifnull(v.foliofisic,'')='',concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as facturavta, \
			cfd.foliocfd, n.fechanot as fecha, cli.cliente, cli.rsocial, \
			IFNULL(dn.clave_motivo, 'SIN MOTIVO') as clave_motivo, IFNULL(dn.empleado_responsable, 'SIN EMPLEADO') as empleado_responsable, \
			sum(@unidades:=dn.cantidad*articulos.factor) as unidades, \
			sum(@suma:=dn.precio*dn.cantidad) as suma, \
			sum(@subtotal:=dn.precio*dn.cantidad) as subtotal, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
			sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
			sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
			sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
			(@unidades / pmm.cajalogisticafactor) AS CantCajaLog, \
			pmm.cajalogisticafactor, \
			%s %s \
			from notascredcli n  inner join  dnotascredcli dn  inner join  dventas dv  inner join  articulos  inner join  productos prod  inner join  clientes cli  inner join  ventas v \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
				INNER JOIN sucursales suc on suc.sucursal = sec.sucursal %s \
				LEFT JOIN presentacionesminmax pmm ON pmm.producto = articulos.producto AND pmm.present = articulos.present \
				left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
				left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
				left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
				left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 %s \
				left join cfd cfdv on v.referencia=cfdv.referencia and cfdv.tipocomprobante='VENT' \
				left join (SELECT referencia, seriefolio as foliocfd, muuid, vtacontab, cancvtacontab, fechaalta \
				FROM cfd where tipocomprobante='NCRE') cfd on cfd.referencia=n.referencia \
			where %s %s %s \
			%s %s %s %s \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s\
			v.fechavta>=@fechainicialventas and v.fechavta<=@fechafinalventas and \
			n.referencia=dn.referencia and v.referencia=n.venta and \
			dn.articulo=dv.articulo and v.referencia=dv.referencia and \
			dn.articulo=articulos.articulo and v.cliente=cli.cliente and \
			articulos.producto=prod.producto \
			%s %s %s \
			%s ", campos_base, campos_detalles_devolucion, campos_val_impuestos,
			joins_detalles_devolucion, join_supervisor,
			// condicion_formaspago,
			// condicion_terminospago,
			condicion_venta, condicion_ter_venta , condicion_nota, condicion_empresa,
			condicion_sucursal, condicion_tipo, condicion_canceladas,
			fechas_canceladas, condicion_almacen, condicion_producto,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_clasifcont1, condicion_clasifcont2, condicion_imp,
			condicion_tipo_imp, condicion_imp2, condicion_tipo_imp2,
			condicion_tipofac, condicion_cliente, condicion_clientes_partesrel,
			condicion_articulo, condicion_vendedor, condicionSupervisado,
            condicion_empleado, condicion_puesto, condicion_motivo,
			agrupamiento);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDPROV_X_ARTICULO
void ServidorReportes::EjecutaRepNotcredprovXArticulo
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, fecha_inicial_compras,
		fecha_final_compras, tipo, almacen, producto;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_tipo = " ", condicion_almacen = " ",
		condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString campos_base = " ";
	AnsiString condicion_canceladas = " ", canceladas, tipo_canceladas,
		fechas_canceladas = " ";
	AnsiString tipo_impuestos, impuesto_particular, condicion_tipo_imp = " ",
		condicion_imp = " ";
	AnsiString proveedor, condicion_tipofac = " ", condicion_proveedor = " ";
	AnsiString articulo, condicion_articulo = " ", agrupamiento;
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";
	AnsiString prov_partesrel, condicion_prov_partesrel = " ";
	AnsiString clasicont1, clasicont2;
	AnsiString condicion_clasicont1 = " ", condicion_clasicont2 = " ";
	AnsiString supervisor, condicionSupervisado = " ", join_supervisor = " ";
	AnsiString negar_impuestos, tipo_impuestos2, impuesto_particular2, negar_impuestos2,
        condicion_tipo_imp2 = " ", condicion_imp2 = " ";
	try {
		fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa= mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial_compras = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_compras = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		articulo = mFg.ExtraeStringDeBuffer(&parametros);
		prov_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		clasicont1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasicont2 = mFg.ExtraeStringDeBuffer(&parametros);
		supervisor = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);
		impuesto_particular2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_impuestos2 = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 when i5.orden=%s then @impuesto5 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal IN (%s) and ", sucursal);
		} else if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa=%s and ", empresa);
		}

		agrupamiento =
			"group by prod.nombre, articulos.present, articulos.multiplo \
						order by prod.nombre, articulos.present, articulos.multiplo";
		if (articulo != " ") {
			campos_base +=
				"prov.razonsocial as nomproveedor, n.referencia, n.folioprov as foliofisic, n.fechanot, ";
			condicion_articulo.sprintf("dc.articulo='%s' and ", articulo);
			agrupamiento =
				"group by n.referencia, prod.nombre, articulos.present, articulos.multiplo \
						order by n.referencia, prod.nombre, articulos.present, articulos.multiplo";
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}
		if (tipo_impuestos != " ") {
			if (negar_impuestos == "0") {
                condicion_tipo_imp.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s' or i5.tipoimpu='%s') and ",
					tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
			} else {
                condicion_tipo_imp.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s' and IFNULL(i5.tipoimpu,'')<>'%s') and ",
					tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos, tipo_impuestos);
            }

		}
		if (impuesto_particular != " ") {
			if (negar_impuestos == "0") {
                condicion_imp.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s or i5.impuesto=%s) and ",
					impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular);
			} else {
                condicion_imp.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and  IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s and IFNULL(i5.impuesto,'')<>%s) and ",
					impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular, impuesto_particular);
            }

		}
        if (tipo_impuestos2 != " ") {
			if (negar_impuestos2 == "0") {
				condicion_tipo_imp2.sprintf
					("(i1.tipoimpu='%s' or i2.tipoimpu='%s' or i3.tipoimpu='%s' or i4.tipoimpu='%s' or i5.tipoimpu='%s') and ",
					tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2);
			} else {
				condicion_tipo_imp2.sprintf
					("(IFNULL(i1.tipoimpu,'')<>'%s' and  IFNULL(i2.tipoimpu,'')<>'%s' and IFNULL(i3.tipoimpu,'')<>'%s' and IFNULL(i4.tipoimpu,'')<>'%s' and IFNULL(i5.tipoimpu,'')<>'%s') and ",
					tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2, tipo_impuestos2);
            }
		}
		if (impuesto_particular2 != " ") {
			if (negar_impuestos2 == "0") {
				condicion_imp2.sprintf
					("(i1.impuesto=%s or i2.impuesto=%s or i3.impuesto=%s or i4.impuesto=%s or i5.impuesto=%s) and ",
					impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2);
			} else {
                condicion_imp2.sprintf
					("(IFNULL(i1.impuesto,'')<>%s and  IFNULL(i2.impuesto,'')<>%s and IFNULL(i3.impuesto,'')<>%s and IFNULL(i4.impuesto,'')<>%s and IFNULL(i5.impuesto,'')<>%s) and ",
					impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2, impuesto_particular2);
            }
		}
		if (almacen != " ") {
			condicion_almacen.sprintf("c.almacen='%s' and ", almacen);
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("articulos.producto='%s' and ",
			producto);
		}

		if (tipo != " ") {
			condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
		}

		if (supervisor != " ") {
			join_supervisor =
				"LEFT JOIN articulossupervisados arsu ON arsu.present=articulos.present AND arsu.producto = articulos.producto";
			condicionSupervisado.sprintf("  arsu.usuario='%s'  and ",
				supervisor);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf
						("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
						fecha_inicial, fecha_final);
				}
				else {
					fechas_canceladas.sprintf
						("n.fechanot>='%s' and n.fechanot<='%s' and ",
						fecha_inicial, fecha_final);
				}
			}
			else {
				fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}

		if (prov_partesrel != " ") {
			condicion_prov_partesrel.sprintf("prov.esparterelac=%s and ",
				prov_partesrel);
		}

		if (clasicont1 != " ") {
			condicion_clasicont1.sprintf("prod.clasifcont='%s' and ",
			clasicont1);
		}
		if (clasicont2 != " ") {
			condicion_clasicont2.sprintf("prod.clasifcont2='%s' and ",
				clasicont2);
		}

		instruccion =
			"create temporary table auximpuestosa (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestosa (impuesto) select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 5; i <= 9; i++) {
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestosa aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("set @fechainicialcompras='%s'",
			fecha_inicial_compras);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinalcompras='%s'", fecha_final_compras);
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("select %s \
			sum(if(n.tipo='0',dn.cantidad,0)) as cantxart, articulos.articulo, \
			articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
			n.referencia, n.folioprov as nota, n.tipo as tipo, \
			if(n.tipo=0, 'DEVOLUCION', if(n.tipo=1, 'BONIFICACION', 'DESCUENTO')) as tipodescrito, \
			c.referencia as compra, c.folioprov as factura, \
			n.fechanot as fecha, \
			sum(@unidades:=dn.cantidad*articulos.factor) as unidades, \
			sum(@suma:=dn.costo*dn.cantidad) as suma, \
			sum(@subtotal:=dn.costo*dn.cantidad) as subtotal, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@impuesto5:=IF (ISNULL(i5.porcentaje),0, (@subtotal*i5.porcentaje/100))) as imp5, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
				sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
				sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
				sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, \
			%s \
			from notascredprov n  \
			inner join  dnotascredprov dn  \
			inner join  dcompras dc  \
			inner join  articulos  \
			inner join  productos prod  \
			inner join  proveedores prov  \
			inner join  compras c \
			inner join terminales ter on ter.terminal=c.terminal \
			inner join secciones sec on ter.seccion=sec.seccion \
			INNER JOIN sucursales suc on sec.sucursal = suc.sucursal\
			left join auximpuestos5 i1 on i1.impuesto=dc.claveimp1 \
			left join auximpuestos6 i2 on i2.impuesto=dc.claveimp2 \
			left join auximpuestos7 i3 on i3.impuesto=dc.claveimp3 \
			left join auximpuestos8 i4 on i4.impuesto=dc.claveimp4 \
			left join auximpuestos9 i5 on i5.impuesto=c.impuestoret %s \
			where %s %s %s %s \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			c.fechacom>=@fechainicialcompras and c.fechacom<=@fechafinalcompras and \
			n.referencia=dn.referencia and c.referencia=n.compra and \
			dn.articulo=dc.articulo and c.referencia=dc.referencia and \
			dn.articulo=articulos.articulo and c.proveedor=prov.proveedor and \
			articulos.producto=prod.producto \
			%s ", campos_base, campos_val_impuestos, join_supervisor, condicion_empresa, condicion_sucursal,
			condicion_tipo, condicion_canceladas, fechas_canceladas,
			condicion_almacen, condicion_producto, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_canceladas,
			fechas_canceladas, condicion_imp, condicion_tipo_imp, condicion_imp2, condicion_tipo_imp2,
			condicion_proveedor, condicion_prov_partesrel, condicion_articulo,
			condicion_clasicont1, condicion_clasicont2, condicionSupervisado,agrupamiento);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPSALDOSCLI
void ServidorReportes::EjecutaRepSaldosClientes(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i, agrupaxcliente, solosaldos;
	AnsiString fecha_saldos, fecha_inicial_ventas, fecha_final_ventas;
	AnsiString cobrador, tipo_facturacion, cliente;
	AnsiString condicion_cobrador = " ";
	AnsiString condicion_tipo_facturacion = " ", condicion_cliente = " ";
	AnsiString venta, condicion_venta = " ", condicion_solosaldos = " ";
	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString archivo_temp1 = "";

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString cad_totimpuestos_create = "", campos_totimpuestos_create = "";
	AnsiString cad_porcimpuestos_create = "", campos_porcimpuestos_create = "";
	AnsiString impuesto_aux = "", tipo_impuesto_aux = "", cad_totimpuestos_col =
		"", campos_totimpuestos_col = "", cad_totimpuestos = "",
		campos_totimpuestos = "", cad_porcimpuestos = "",
		campos_porcimpuestos = "";
	AnsiString cad_porcimpuestosVA = "", campos_porcimpuestosVA = "",
		cad_propor_impuestos = "", campos_propor_impuestos = "";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";
	AnsiString origenes_venta, condicion_origenes_venta = " ";

	try {
		fecha_saldos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_ventas =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		cobrador = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_facturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxcliente = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		solosaldos = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		origenes_venta = mFg.ExtraeStringDeBuffer(&parametros);

		if (venta != " ") {
			condicion_venta.sprintf(" v.referencia='%s' and ", venta);
		}
		if (solosaldos) {
			condicion_solosaldos = " having saldo>=0.01 ";
		}
		if (cobrador != " ") {
			condicion_cobrador.sprintf("v.cobrador='%s' and ", cobrador);
		}
		if (tipo_facturacion != " ") {
			condicion_tipo_facturacion.sprintf("v.tipofac='%s' and ",
				tipo_facturacion);
		}

		if (cliente != " ") {
			condicion_cliente.sprintf("v.cliente='%s' and ", cliente);
		}
		if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa=%s and ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		}
		if (clientes_partesrel != " ") {
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s and ",
				clientes_partesrel);
		}
		if (origenes_venta != " ") {
			condicion_origenes_venta.sprintf(" v.tipoorigen IN (%s) and ",
				origenes_venta);
		}

		// Obtiene los impuestos del tipo IESPS existentes
		instruccion.sprintf("SELECT i.impuesto, LCASE(i.tipoimpu) as tipoimpu FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);

		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto_aux = resp_impuestos->ObtieneDato("impuesto");
			tipo_impuesto_aux = resp_impuestos->ObtieneDato("tipoimpu");

			cad_totimpuestos_create.sprintf(" total%s%s decimal(16,4), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_totimpuestos_create += cad_totimpuestos_create;

			cad_porcimpuestos_create.sprintf(" porcentaje%s%s decimal(16,10), ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestos_create += cad_porcimpuestos_create;

			cad_totimpuestos_col.sprintf(" total%s%s, ", tipo_impuesto_aux,
				impuesto_aux);
			campos_totimpuestos_col += cad_totimpuestos_col;

			cad_totimpuestos.sprintf(" sum(if(i1.impuesto=%s, \
			(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), \
			 0)+ if(i2.impuesto=%s, (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) as total%s%s, "
				, impuesto_aux, impuesto_aux, tipo_impuesto_aux, impuesto_aux);
			campos_totimpuestos += cad_totimpuestos;

			cad_porcimpuestos.sprintf("porcentaje%s%s=total%s%s/(totaltodo), ",
				tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
				impuesto_aux);
			campos_porcimpuestos += cad_porcimpuestos;

			cad_porcimpuestosVA.sprintf("va.porcentaje%s%s, ",
				tipo_impuesto_aux, impuesto_aux);
			campos_porcimpuestosVA += cad_porcimpuestosVA;

			if (agrupaxcliente) {
				cad_propor_impuestos.sprintf
					("sum((va.saldo-va.saldodecargos)*va.porcentaje%s%s) as proporcion%s%s, ",
					tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
					impuesto_aux);
			}
			else {
				cad_propor_impuestos.sprintf
					("((va.saldo-va.saldodecargos)*va.porcentaje%s%s) as proporcion%s%s, ",
					tipo_impuesto_aux, impuesto_aux, tipo_impuesto_aux,
					impuesto_aux);
			}
			campos_propor_impuestos += cad_propor_impuestos;
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		// Crea una tabla para tener las ventas en cuestión
		instruccion.sprintf("create temporary table ventasaux (referencia char(11), \
			saldo decimal(16,4), cargos decimal(16,4), saldodecargos decimal(16,4), \
			totaltodo decimal(16,4), \
			total0 decimal(16,4), total15 decimal(16,4), total16 decimal(16,4), \
			subnograbado decimal(16,4), subtotal15 decimal(16,4), subtotal16 decimal(16,4), subgrabado decimal(16,4), subtotal decimal(16,4), \
			%s \
			totaliva decimal(16,4), \
			totaliesps decimal(16,4), valor decimal(16,4), \
			porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
			PRIMARY KEY (referencia)) Engine = InnoDB",
			campos_totimpuestos_create, campos_porcimpuestos_create);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla para tener las referencias en cuestión
		instruccion = "create temporary table referenciasaux (venta char(11), \
			saldo decimal(16,4), cargos decimal(16,4), \
			PRIMARY KEY (venta)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table dnotascredcliaux (venta char(11), \
			saldo decimal(16,4), cargos decimal(16,4), \
			articulo varchar(9), cantidad decimal(12,3), precio decimal(16,6), precioimp decimal(16,6), \
			INDEX (venta), INDEX(articulo)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla con todas las ventas que cumplen las condiciones y
		// que tengan saldo.

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf(" select v.referencia as venta, sum(t.valor) as saldo, \
			sum(if(t.concepto='C' and t.destino='C' and t.tipo<>'CHDE' and t.tipo<>'VENT', t.valor, 0)) as cargos \
			from ventas v inner join transxcob t \
				inner join terminales ter on ter.terminal=v.terminal \
				inner join secciones sec on ter.seccion=sec.seccion \
                inner join sucursales suc on suc.sucursal = sec.sucursal \
				inner join clientes cli on cli.cliente=v.cliente \
			where %s %s %s %s %s %s %s %s \
			t.referencia=v.referencia and t.cancelada=0 and v.cancelado=0 and v.acredito=1 \
			and t.fechaapl<='%s' and t.aplicada=1 and v.fechavta>='%s' and v.fechavta<='%s' \
			group by v.referencia %s INTO OUTFILE '%s' ", condicion_empresa, condicion_sucursal, condicion_cobrador,
			condicion_tipo_facturacion, condicion_cliente,
			condicion_clientes_partesrel, condicion_origenes_venta, condicion_venta, fecha_saldos,
			fecha_inicial_ventas, fecha_final_ventas, condicion_solosaldos, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE referenciasaux (venta, saldo, cargos) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las compras.
		instruccion.sprintf("insert into dnotascredcliaux \
			(venta, saldo, cargos, articulo, cantidad, precio, precioimp) \
			select v.referencia as venta, \
			ra.saldo, ra.cargos, \
			d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.precio,0)) as precio, \
			sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp \
			from notascredcli n, dnotascredcli d, ventas v, referenciasaux ra \
			where n.venta=v.referencia and n.fechanot<='%s' and \
			n.cancelado=0 and v.cancelado=0 and \
			ra.venta=v.referencia and \
			n.referencia=d.referencia \
			group by v.referencia, d.articulo", fecha_saldos);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into ventasaux \
			(referencia, saldo, cargos, saldodecargos, totaltodo, total0, total15, total16, \
			subnograbado,subtotal15,subtotal16,subgrabado,subtotal, \
			 %s totaliva, totaliesps) \
			select v.referencia, ra.saldo, ra.cargos, \
			if (ra.saldo<ra.cargos, ra.saldo, ra.cargos) as saldodecargos, \
			sum((dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)) ) as totaltodo, \
			sum(if(\
				not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as total0, \
			sum(if( \
				(i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total15, \
			sum(if( \
				(i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00), \
				(dv.precioimp-ifnull(dn.precioimp,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total16, \
			sum(@subnograbado:=if( \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as subnograbado, \
			sum(@subtotal15:=if( \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal15, \
			sum(@subtotal16:=if( \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal16, \
			sum(@subgrabado:=@subtotal15+@subtotal16) as subgrabado, \
			sum(@subtotal:=@subtotal15+@subtotal16+@subnograbado) as subtotal, \
			%s \
			sum(if(i1.tipoimpu='IVA', (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0) + \
				if(i2.tipoimpu='IVA', (dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) as totaliva, \
			sum(if( i1.tipoimpu='IESPS', \
				(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), \
				 0)) as totaliesps \
			from ventas v  inner join  dventas dv  inner join  referenciasaux ra \
			left join dnotascredcliaux dn on dn.articulo=dv.articulo and dn.venta=v.referencia \
			left join impuestos i1 on i1.impuesto=dv.claveimp1 \
			left join impuestos i2 on i2.impuesto=dv.claveimp2 \
			left join impuestos i3 on i3.impuesto=dv.claveimp3 \
			left join impuestos i4 on i4.impuesto=dv.claveimp4 \
			where v.referencia=dv.referencia and v.referencia=ra.venta \
			group by v.referencia \
			order by v.referencia", campos_totimpuestos_col,
			campos_totimpuestos);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("update ventasaux set valor=totaltodo, \
			porcentaje0=total0/(totaltodo), \
			porcentaje16=total16/(totaltodo), \
			porcentaje15=total15/(totaltodo), \
			porcentajesub0=subnograbado/(totaltodo), \
			porcentajesub15=subtotal15/(totaltodo), \
			porcentajesub16=subtotal16/(totaltodo), \
			porcentajesubgrabado=subgrabado/(totaltodo), \
			porcentajesubtotal=subtotal/(totaltodo), \
			%s \
			porcentajeiva=totaliva/(totaltodo), \
			porcentajeiesps=totaliesps/(totaltodo)", campos_porcimpuestos);
		instrucciones[num_instrucciones++] = instruccion;

		// Notas de cargo
		instruccion.sprintf("create temporary table auxtransaccargo \
			SELECT DISTINCT incar.porcentaje, t.referencia \
				FROM ventasaux va \
				INNER JOIN transxcob t ON t.referencia=va.referencia \
				INNER JOIN notascarcli n ON n.referencia=t.notacar \
				INNER JOIN impuestos incar ON incar.impuesto=n.cveimp \
				WHERE t.aplicada=1 AND t.cancelada=0 AND t.referencia=va.referencia "
			);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			if (agrupaxcliente) {
				instruccion.sprintf("select v.referencia, \
					v.foliofisic as factura, \
					v.fechavta,e.empleado,CONCAT(e.nombre,'  ',e.appat,'  ',e.apmat) cobr, v.cliente, c.rsocial, \
					sum(va.saldo) as saldo, \
					sum(va.saldodecargos) as saldodecargos, \
					sum(va.saldodecargos/(1+(ifnull(n.porcentaje, 0)/100)) ) as subsaldodecargos, \
					sum(va.saldodecargos-(va.saldodecargos/(1+(ifnull(n.porcentaje, 0)/100))) ) as ivasaldodecargos, \
					sum((va.saldo-va.saldodecargos)*va.porcentaje0) as proporcion0, \
					sum((va.saldo-va.saldodecargos)*va.porcentaje15) as proporcion15, \
					sum((va.saldo-va.saldodecargos)*va.porcentaje16) as proporcion16, \
					sum((va.saldo-va.saldodecargos)*va.porcentajesub0) as proporcionsub0, \
					sum((va.saldo-va.saldodecargos)*va.porcentajesub15) as proporcionsub15, \
					sum((va.saldo-va.saldodecargos)*va.porcentajesub16) as proporcionsub16, \
					sum((va.saldo-va.saldodecargos)*va.porcentajesubgrabado) as proporcionsubgrabado, \
					sum((va.saldo-va.saldodecargos)*va.porcentajesubtotal) as proporcionsubtotal, \
					%s \
					sum((va.saldo-va.saldodecargos)*va.porcentajeiva) as proporcioniva, \
					sum((va.saldo-va.saldodecargos)*va.porcentajeiesps) as proporcioniesps \
					from ventasaux va inner join ventas v inner join clientes c \
					INNER JOIN  empleados e ON e.empleado=v.cobrador            \
					INNER JOIN terminales ter ON ter.terminal = v.terminal \
					INNER JOIN secciones sec ON sec.seccion = ter.seccion \
					INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					left join auxtransaccargo n ON v.referencia=n.referencia \
					where va.referencia=v.referencia and \
					v.cliente=c.cliente \
					group by v.cliente order by suc.numid, c.rsocial ",
					campos_propor_impuestos);
			}
			else {
				instruccion.sprintf("select v.referencia, \
					if(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) as factura, \
					v.fechavta,e.empleado,CONCAT(e.nombre,'  ',e.appat,'  ',e.apmat) cobr, v.cliente, c.rsocial, \
					va.saldo, va.cargos, \
					va.saldodecargos, \
					va.saldodecargos/(1+(ifnull(n.porcentaje, 0)/100)) as subsaldodecargos, \
					va.saldodecargos-(va.saldodecargos/(1+(ifnull(n.porcentaje, 0)/100))) as ivasaldodecargos, \
					((va.saldo-va.saldodecargos)*va.porcentaje0) as proporcion0, \
					((va.saldo-va.saldodecargos)*va.porcentaje15) as proporcion15, \
					((va.saldo-va.saldodecargos)*va.porcentaje16) as proporcion16, \
					((va.saldo-va.saldodecargos)*va.porcentajesub0) as proporcionsub0, \
					((va.saldo-va.saldodecargos)*va.porcentajesub15) as proporcionsub15, \
					((va.saldo-va.saldodecargos)*va.porcentajesub16) as proporcionsub16, \
					((va.saldo-va.saldodecargos)*va.porcentajesubgrabado) as proporcionsubgrabado, \
					((va.saldo-va.saldodecargos)*va.porcentajesubtotal) as proporcionsubtotal, \
					 %s \
					 ((va.saldo-va.saldodecargos)*va.porcentajeiva) as proporcioniva, \
					 ((va.saldo-va.saldodecargos)*va.porcentajeiesps) as proporcioniesps \
					from ventasaux va inner join ventas v inner join clientes c \
                    INNER JOIN  empleados e ON e.empleado=v.cobrador            \
					INNER JOIN terminales ter ON ter.terminal = v.terminal \
					INNER JOIN secciones sec ON sec.seccion = ter.seccion \
					INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					left join auxtransaccargo n ON v.referencia=n.referencia \
					left join cfd on v.referencia=cfd.referencia and cfd.tipocomprobante='VENT' \
					where va.referencia=v.referencia and \
					v.cliente=c.cliente \
					order by suc.numid, v.referencia ",
				campos_propor_impuestos);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
		if (archivo_temp1 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPSALDOSPROV
void ServidorReportes::EjecutaRepSaldosProveedores(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i, agrupaxcliente;
	AnsiString fecha_saldos, fecha_inicial_compras, fecha_final_compras;
	AnsiString proveedor;
	AnsiString condicion_proveedor = " ";

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString cad_totiesps_create = "", campos_totiesps_create = "";
	AnsiString cad_porciesps_create = "", campos_porciesps_create = "";
	AnsiString impuesto = "", cad_totiesps_col = "", campos_totiesps_col = "",
		cad_totiesps = "", campos_totiesps = "", cad_porciesps = "",
		campos_porciesps = "";
	AnsiString cad_porciespsVA = "", campos_porciespsVA = "", cad_propor_iesps =
		"", campos_propor_iesps = "";

	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString proveedores_partesrel, condicion_proveedores_partesrel = " ";
	AnsiString campo_uuid = " ", condicion_uuid = " ", camp_uuid = " ";

	try {
		fecha_saldos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_compras =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_compras =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		proveedores_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxcliente = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

		//Modifique esto
		if (sucursal != " ") {
			condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
		} else if (empresa != " "){
			condicion_empresa.sprintf(" suc.idempresa = %s and ", empresa);
        }

		if (proveedor != " ") {
			condicion_proveedor.sprintf("c.proveedor='%s' and ", proveedor);
		}

		// Es partes relacionadas
		if (proveedores_partesrel != " ") {
			condicion_proveedores_partesrel.sprintf("p.esparterelac=%s and ",
				proveedores_partesrel);
		}

		// Obtiene los impuestos del tipo IESPS existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			WHERE i.tipoimpu='IESPS' \
			ORDER BY i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);

		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_totiesps_create.sprintf(" totaliesps%s decimal(16,4), ",
				impuesto);
			campos_totiesps_create += cad_totiesps_create;

			cad_porciesps_create.sprintf(" porcentajeiesps%s decimal(16,10), ",
				impuesto);
			campos_porciesps_create += cad_porciesps_create;

			cad_totiesps_col.sprintf(" totaliesps%s, ", impuesto);
			campos_totiesps_col += cad_totiesps_col;

			cad_totiesps.sprintf(" sum(if(i1.impuesto=%s, \
			(dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), \
			 0)) as totaliesps%s, ", impuesto, impuesto);
			campos_totiesps += cad_totiesps;

			cad_porciesps.sprintf
				("porcentajeiesps%s=totaliesps%s/(totaltodo), ", impuesto,
				impuesto);
			campos_porciesps += cad_porciesps;

			cad_porciespsVA.sprintf("ca.porcentajeiesps%s, ", impuesto,
				impuesto);
			campos_porciespsVA += cad_porciespsVA;

			if (agrupaxcliente) {
				cad_propor_iesps.sprintf
					("sum((ca.saldo-ca.saldodecargos)*ca.porcentajeiesps%s) as proporcioniesps%s, ",
					impuesto, impuesto);
			}
			else {
				cad_propor_iesps.sprintf
					("((ca.saldo-ca.saldodecargos)*ca.porcentajeiesps%s) as proporcioniesps%s, ",
					impuesto, impuesto);
				campo_uuid.sprintf(" muuid VARCHAR(36), ");
				camp_uuid.sprintf(", muuid");
				condicion_uuid.sprintf(" ,ifnull(c.muuid,'') as muuid");
			}
			campos_propor_iesps += cad_propor_iesps;
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		// Crea una tabla para tener las compras en cuestión
		instruccion.sprintf("create temporary table comprasaux (referencia char(11), \
			saldo decimal(16,4), cargos decimal(16,4), saldodecargos decimal(16,4), \
			totaltodo decimal(16,4), \
			total0 decimal(16,4), total15 decimal(16,4), total16 decimal(16,4), \
			subnograbado decimal(16,4), subtotal15 decimal(16,4), subtotal16 decimal(16,4), subgrabado decimal(16,4), subtotal decimal(16,4), \
			%s \
			totaliva decimal(16,4), \
			totaliesps decimal(16,4), totalisr decimal(16,4), valor decimal(16,4), \
			porcentaje0 decimal(16,10), porcentaje15 decimal(16,10), porcentaje16 decimal(16,10), \
			porcentajesub0 decimal(16,10), \
			porcentajesub15 decimal(16,10), \
			porcentajesub16 decimal(16,10), \
			porcentajesubgrabado decimal(16,10), \
			porcentajesubtotal decimal(16,10), \
			%s \
			porcentajeiva decimal(16,10), \
			porcentajeiesps decimal(16,10), \
            porcentajeisr decimal(16,10), \
			%s  \
			PRIMARY KEY (referencia)) Engine = InnoDB", campos_totiesps_create,
			campos_porciesps_create, campo_uuid);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla para tener las referencias en cuestión
		instruccion = "create temporary table referenciasaux (compra char(11), \
			saldo decimal(16,4), cargos decimal(16,4), \
			PRIMARY KEY (compra)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table dnotascredprovaux (compra char(11), \
			saldo decimal(16,4), cargos decimal(16,4), \
			articulo varchar(9), cantidad decimal(12,3), costo decimal(16,6), costoimp decimal(16,6), \
			INDEX (compra), INDEX(articulo)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla con todas las compras que cumplen las condiciones y
		// que tengan saldo.
		instruccion.sprintf("insert into referenciasaux \
			(compra, saldo, cargos) \
			select c.referencia as compra, sum(t.valor) as saldo, \
			sum(if(t.concepto='C' and t.destino='C' and t.tipo<>'CHDE' and t.tipo<>'COMP', t.valor, 0)) as cargos \
			from compras c \
			  inner join  proveedores p on p.proveedor=c.proveedor \
			  inner join terminales ter on ter.terminal=c.terminal \
			  inner join secciones sec on ter.seccion=sec.seccion \
              INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
			  inner join transxpag t on t.referencia=c.referencia \
			where  %s %s %s %s \
			t.cancelada=0 and c.cancelado=0 and c.acredito=1 \
			and t.fechaapl<='%s' and t.aplicada=1 and c.fechacom>='%s' and c.fechacom<='%s' \
			group by c.referencia having saldo>=0.01", condicion_empresa, condicion_sucursal,
			condicion_proveedores_partesrel, condicion_proveedor, fecha_saldos,
			fecha_inicial_compras, fecha_final_compras);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las compras.
		instruccion.sprintf("insert into dnotascredprovaux \
			(compra, saldo, cargos, articulo, cantidad, costo, costoimp) \
			select c.referencia as compra, \
			ra.saldo, ra.cargos, \
			d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.costo,0)) as costo, \
			sum(if(n.tipo<>'0',d.costoimp,0)) as costoimp \
			from notascredprov n, dnotascredprov d, compras c, referenciasaux ra \
			where n.compra=c.referencia and n.fechanot<='%s' and \
			n.cancelado=0 and c.cancelado=0 and \
			ra.compra=c.referencia and \
			n.referencia=d.referencia \
			group by c.referencia, d.articulo", fecha_saldos);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into comprasaux \
			(referencia, saldo, cargos, saldodecargos, totaltodo, total0, total15, total16, \
			subnograbado,subtotal15,subtotal16,subgrabado,subtotal, \
			%s totaliva, totaliesps, totalisr %s) \
			select c.referencia, ra.saldo, ra.cargos, \
			if (ra.saldo<ra.cargos, ra.saldo, ra.cargos) as saldodecargos, \
			sum((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)) ) as totaltodo, \
			sum(if(\
				not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				 0)) as total0, \
			sum(if( \
				(i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total15, \
			sum(if( \
				(i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00), \
				(dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as total16, \
				\
			sum(@subnograbado:=if( \
				(not (ifnull(i1.tipoimpu,'')='IVA' AND ifnull(i1.porcentaje,0)>0) AND \
				not (ifnull(i2.tipoimpu,'')='IVA' AND ifnull(i2.porcentaje,0)>0) AND \
				not (ifnull(i3.tipoimpu,'')='IVA' AND ifnull(i3.porcentaje,0)>0) AND  \
				not (ifnull(i4.tipoimpu,'')='IVA' AND ifnull(i4.porcentaje,0)>0)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)),\
				 0)) as subnograbado, \
			sum(@subtotal15:=if( \
				((i1.tipoimpu='IVA' and i1.porcentaje=15.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=15.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=15.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=15.00)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal15, \
			sum(@subtotal16:=if( \
				((i1.tipoimpu='IVA' and i1.porcentaje=16.00) OR \
				(i2.tipoimpu='IVA' and i2.porcentaje=16.00) OR \
				(i3.tipoimpu='IVA' and i3.porcentaje=16.00) OR \
				(i4.tipoimpu='IVA' and i4.porcentaje=16.00)), \
				(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0)), \
				0)) as subtotal16, \
			sum(@subgrabado:=@subtotal15+@subtotal16) as subgrabado, \
			sum(@subtotal:=@subtotal15+@subtotal16+@subnograbado) as subtotal, \
			\
			%s \
			sum(if(i1.tipoimpu='IVA', (dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0) + \
			if(i2.tipoimpu='IVA', ( ((dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) + ((dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100))) * (i2.porcentaje/100), 0)) as totaliva, \
			sum(if(i1.tipoimpu='IESPS', (dc.costo-dc.iepscuota-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i1.porcentaje/100), 0)) as totaliesps, \
			sum(IF(i5.tipoimpu='ISR', (dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(i5.porcentaje/100), 0)) AS totalisr \
			%s \
			from compras c  inner join  dcompras dc  inner join  referenciasaux ra \
			left join dnotascredprovaux dn on dn.articulo=dc.articulo and dn.compra=c.referencia \
			left join impuestos i1 on i1.impuesto=dc.claveimp1 \
			left join impuestos i2 on i2.impuesto=dc.claveimp2 \
			left join impuestos i3 on i3.impuesto=dc.claveimp3 \
			left join impuestos i4 on i4.impuesto=dc.claveimp4 \
			left join impuestos i5 ON i5.impuesto=c.impuestoret \
			where c.referencia=dc.referencia and c.referencia=ra.compra \
			group by c.referencia \
			order by c.referencia", campos_totiesps_col, camp_uuid,
			campos_totiesps, condicion_uuid);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("update comprasaux set totaltodo = IF(totaltodo > 0, (totaltodo - totalisr), totaltodo), \
			total0 = IF(total0 > 0, (total0-totalisr), total0), \
			total15 = IF(total15 > 0, (total15-totalisr), total15), \
			total16 = IF(total16 > 0, (total16-totalisr), total16), \
			valor=totaltodo, \
			porcentaje0=total0/(totaltodo), \
			porcentaje15=total15/(totaltodo), \
			porcentaje16=total16/(totaltodo), \
			porcentajesub0=subnograbado/(totaltodo), \
			porcentajesub15=subtotal15/(totaltodo), \
			porcentajesub16=subtotal16/(totaltodo), \
			porcentajesubgrabado=subgrabado/(totaltodo), \
			porcentajesubtotal=subtotal/(totaltodo), \
			%s \
			porcentajeiva=totaliva/(totaltodo), \
			porcentajeiesps=totaliesps/(totaltodo), \
			porcentajeisr=totalisr/(totaltodo)", campos_porciesps);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			if (agrupaxcliente) {
				instruccion.sprintf("select c.referencia, c.folioprov as factura, \
					c.fechacom, p.proveedor, p.razonsocial as rsocial, \
					IF(cfdi.emitecpago=1, 'Si', IF(cfdi.emitecpago=0, 'No', '')) AS emitecpago, \
					sum(ca.saldo) as saldo, \
					sum(ca.saldodecargos) as saldodecargos, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentaje0) as proporcion0, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentaje15) as proporcion15, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentaje16) as proporcion16, \
					\
					@proporcionsub0:=sum(((ca.saldo-ca.saldodecargos)*ca.porcentajesub0) ) as proporcionsub0, \
					@proporcionsub15:=sum(((ca.saldo-ca.saldodecargos)*ca.porcentajesub15) + ((ca.saldo-ca.saldodecargos)*ca.porcentajesub15)*ca.porcentajesub15) as proporcionsub15, \
					@proporcionsub16:=sum(((ca.saldo-ca.saldodecargos)*ca.porcentajesub16) + ((ca.saldo-ca.saldodecargos)*ca.porcentajesub16)*ca.porcentajesub15)as proporcionsub16, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentajesubgrabado) as proporcionsubgrabado, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentajesubtotal) as proporcionsubtotal, \
					\
					%s \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentajeiva) as proporcioniva, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentajeiesps) as proporcioniesps, \
					sum((ca.saldo-ca.saldodecargos)*ca.porcentajeisr) AS proporcionisr \
					from comprasaux ca \
					inner join compras c on ca.referencia=c.referencia \
					inner join proveedores p on c.proveedor=p.proveedor \
					INNER JOIN terminales ter on ter.terminal = c.terminal \
					INNER JOIN secciones sec on sec.seccion = ter.seccion \
					INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
					left join cfdicompras cfdi on cfdi.referencia=c.referencia \
					group by c.proveedor \
					order by p.razonsocial ",
					campos_propor_iesps);
			}
			else {
				instruccion.sprintf("select c.referencia, c.folioprov as factura, \
					c.fechacom, p.proveedor, p.razonsocial as rsocial, \
					IF(cfdi.emitecpago=1, 'Si', IF(cfdi.emitecpago=0, 'No', '')) AS emitecpago, \
					ca.saldo, ca.cargos, \
					ca.saldodecargos, \
					((ca.saldo-ca.saldodecargos)*ca.porcentaje0) as proporcion0, \
					((ca.saldo-ca.saldodecargos)*ca.porcentaje15) as proporcion15, \
					((ca.saldo-ca.saldodecargos)*ca.porcentaje16) as proporcion16, \
					\
					@proporcionsub0:=((ca.saldo-ca.saldodecargos)*ca.porcentajesub0)  as proporcionsub0, \
					@proporcionsub15:=((ca.saldo-ca.saldodecargos)*ca.porcentajesub15) + (((ca.saldo-ca.saldodecargos)*ca.porcentajesub15)*ca.porcentajesub15) as proporcionsub15, \
					@proporcionsub16:=((ca.saldo-ca.saldodecargos)*ca.porcentajesub16) + (((ca.saldo-ca.saldodecargos)*ca.porcentajesub16)*ca.porcentajesub15) as proporcionsub16, \
					((ca.saldo-ca.saldodecargos)*ca.porcentajesubgrabado) as proporcionsubgrabado, \
					((ca.saldo-ca.saldodecargos)*ca.porcentajesubtotal) as proporcionsubtotal, \
					\
					%s \
					((ca.saldo-ca.saldodecargos)*ca.porcentajeiva) as proporcioniva, \
					((ca.saldo-ca.saldodecargos)*ca.porcentajeiesps) as proporcioniesps, \
					((ca.saldo-ca.saldodecargos)*ca.porcentajeisr) as proporcionisr \
					%s \
					from comprasaux ca \
                    inner join compras c on ca.referencia=c.referencia \
					inner join proveedores p on c.proveedor=p.proveedor \
					INNER JOIN terminales ter on ter.terminal = c.terminal \
					INNER JOIN secciones sec on sec.seccion = ter.seccion \
					INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
					left join cfdicompras cfdi on cfdi.referencia=c.referencia \
					order by suc.numid, c.referencia ", campos_propor_iesps,
					condicion_uuid);
			}

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
// ID_EJE_REPCLIENTES_GENERAL,
void ServidorReportes::EjecutaRepGeneralClientes(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	AnsiString instruccion, consulta;
	int reg, i;
	AnsiString fecha_inicial, fecha_final, tipo_persona, acredito,
		mes_nacimiento, tipo_precio;
	AnsiString status_cliente, cobrador, vendedor, sector, localidad, colonia,
		fecha_ultima_venta;
	AnsiString tipo_nombre, clientes_partesrel, clientes_envioCFD, ultima_venta,
		fecha_inicio_uv, fecha_fin_uv;
	AnsiString ultimo_embarque, fecha_inicio_embarque, fecha_fin_embarque,
		filtro_ubicacion;
	AnsiString fecha_fija, gironegocio, canal;
	AnsiString credito_limit;
	AnsiString preciomin, estatus;

	AnsiString condicion_tipopersona = " ";
	AnsiString condicion_acredito = " ";
	AnsiString condicion_mesnacimiento = " ";
	AnsiString condicion_tipoprecio = " ";
	AnsiString condicion_statuscliente = " ";
	AnsiString condicion_ubicacioncliente = " ";
	AnsiString condicion_ubicacionentregacliente = " ";
	AnsiString condicion_cobrador = " ";
	AnsiString condicion_vendedor = " ";
	AnsiString condicion_sector = " ";
	AnsiString condicion_localidad = " ";
	AnsiString condicion_colonia = " ";
	AnsiString condicion_tipo_nombre = " ";
	AnsiString condicion_clientes_partesrel = " ";
	AnsiString condicion_clientes_envioCFD = " ";
	AnsiString condicion_gironegocio = " ";
	AnsiString inner_ultima_venta = " ", campo_ultima_venta = " ";
	AnsiString condicion_canal = " ";
	AnsiString inner_ultimo_embarque = " ", campo_ultimo_embarque = " ";
	AnsiString condicion_limite_credito = " ";
	AnsiString condicion_preciomin = " ";
	AnsiString condicion_estatus = " ";

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	tipo_persona = mFg.ExtraeStringDeBuffer(&parametros);
	acredito = mFg.ExtraeStringDeBuffer(&parametros);
	mes_nacimiento = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_precio = mFg.ExtraeStringDeBuffer(&parametros);
	status_cliente = mFg.ExtraeStringDeBuffer(&parametros);
	filtro_ubicacion = mFg.ExtraeStringDeBuffer(&parametros);
	// para filtrar (con ubicación) (sin ubicación) (todos) de los clientes
	cobrador = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	sector = mFg.ExtraeStringDeBuffer(&parametros);
	localidad = mFg.ExtraeStringDeBuffer(&parametros);
	colonia = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
	clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
	clientes_envioCFD = mFg.ExtraeStringDeBuffer(&parametros);
	ultima_venta = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_inicio_uv = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_fin_uv = mFg.ExtraeStringDeBuffer(&parametros);
	gironegocio = mFg.ExtraeStringDeBuffer(&parametros);
	canal = mFg.ExtraeStringDeBuffer(&parametros);
	ultimo_embarque = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_inicio_embarque = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_fin_embarque = mFg.ExtraeStringDeBuffer(&parametros);
	credito_limit = mFg.ExtraeStringDeBuffer(&parametros);
	preciomin = mFg.ExtraeStringDeBuffer(&parametros);
	estatus = mFg.ExtraeStringDeBuffer(&parametros);

	// define la forma como se mostraran los nombres de los clientes
	if (tipo_nombre == "1") {
		condicion_tipo_nombre =
			"if(c.tipoempre=0,concat(c.appat,' ',c.apmat,' ',c.nombre),c.rsocial)";
	}
	else {
		condicion_tipo_nombre = "c.rsocial";
	}

	if (tipo_persona != " ") {
		condicion_tipopersona.sprintf("and c.tipoempre='%s' ", tipo_persona);
	}

	if (acredito != " ") {
		condicion_acredito.sprintf("and c.credito='%s' ", acredito);
	}

	if (mes_nacimiento != " ") {
		condicion_mesnacimiento.sprintf("and month(c.fnaccli)='%s' ",
			mes_nacimiento);
	}

	if (tipo_precio != " ") {
		condicion_tipoprecio.sprintf("and ce.tipoprec='%s' ", tipo_precio);
	}

	if (status_cliente != " ") {
		condicion_statuscliente.sprintf("and c.bloqueo='%s' ", status_cliente);
	}

	if (preciomin != " ") {
		condicion_preciomin.sprintf("and ce.tipoprecmin='%s' ", preciomin);
	}

	/*
	 if (filtro_ubicacion!=" ") {
	 //(1)=Solo Clientes CON Ubicación ó (2)=Solo Clientes SIN Ubicación
	 if (filtro_ubicacion=="1") {
	 condicion_ubicacioncliente=" AND not c.ubicaciongis is null  and concat(IFNULL(X(c.ubicaciongis),'') ,IFNULL(Y(c.ubicaciongis),'') )<>''";
	 condicion_ubicacionentregacliente=" AND not dc.ubicaciongis is null  and concat(IFNULL(X(dc.ubicaciongis),'') ,IFNULL(Y(dc.ubicaciongis),'') )<>''";
	 }else{
	 condicion_ubicacioncliente=" AND (c.ubicaciongis is null  or concat(IFNULL(X(c.ubicaciongis),'') ,IFNULL(Y(c.ubicaciongis),'') )='') ";
	 condicion_ubicacionentregacliente=" AND (dc.ubicaciongis is null  or concat(IFNULL(X(dc.ubicaciongis),'') ,IFNULL(Y(dc.ubicaciongis),'') )='') ";
	 }
	 }
	 */

	switch (atoi(filtro_ubicacion.c_str())) {
	case -1: // Todos
		condicion_ubicacioncliente = " ";
		condicion_ubicacionentregacliente = " ";
		break;

	case 0: // Con ubicación
		condicion_ubicacioncliente =
			" AND ( FORMAT(X(c.ubicaciongis),6)<>0 AND FORMAT(Y(c.ubicaciongis),6)<>0 ) ";
		condicion_ubicacionentregacliente =
			" AND ( FORMAT(X(dc.ubicaciongis),6)<>0 AND FORMAT(Y(dc.ubicaciongis),6)<>0 ) ";
		break;

	case 1: // Sin ubicación
		condicion_ubicacioncliente =
			" AND ( FORMAT(X(c.ubicaciongis),6)=0 AND FORMAT(Y(c.ubicaciongis),6)=0 ) ";
		condicion_ubicacionentregacliente =
			" AND ( FORMAT(X(dc.ubicaciongis),6)=0 AND FORMAT(Y(dc.ubicaciongis),6)=0 ) ";
		break;
	}

	if (cobrador != " ") {
		condicion_cobrador.sprintf("and ce.cobrador='%s' ", cobrador);
	}

	if (vendedor != " ") {
		condicion_vendedor.sprintf("and ce.vendedor='%s' ", vendedor);
	}

	if (sector != " ") {
		condicion_sector.sprintf("and col.sector='%s' ", sector);
	}

	if (localidad != " ") {
		condicion_localidad.sprintf("and col.localidad='%s' ", localidad);
	}

	if (colonia != " ") {
		condicion_colonia.sprintf("and c.colonia='%s' ", colonia);
	}

	// Es partes relacionadas
	if (clientes_partesrel != " ") {
		condicion_clientes_partesrel.sprintf("and c.esparterelac=%s ",
			clientes_partesrel);
	}
	// Es partes relacionadas
	if (clientes_envioCFD != " ") {
		condicion_clientes_envioCFD.sprintf("AND c.enviarcfd=1 ");
	}

	if (gironegocio != " ") {
		condicion_gironegocio.sprintf("and c.giro='%s' ", gironegocio);
	}

	if (canal != " ") {
		condicion_canal.sprintf("and c.canal='%s' ", canal);
	}

	if (credito_limit == "1") {
		condicion_limite_credito.sprintf("and c.excederlc='%s' ",
		credito_limit);
	}

	if (ultima_venta == "1") {
		campo_ultima_venta.sprintf(" ,auxventas.ultimaventa");
		fecha_fija.sprintf("2000-01-01");
		/* inner_ultima_venta.sprintf("INNER JOIN (SELECT cliente, MAX(fechavta) AS ultimaventa FROM ventas \
		 WHERE fechavta>='%s' AND fechavta<='%s' \
		 GROUP BY cliente) AS auxventas ON auxventas.cliente=c.cliente", fecha_inicio_uv,fecha_fin_uv); */

		inner_ultima_venta.sprintf("INNER JOIN(SELECT cancelado, referencia, cliente, MAX(fechavta) AS ultimaventa, \
		 MAX(IF(fechavta>='%s' AND fechavta<='%s', fechavta, '%s')) AS ultimaventarango  FROM ventas \
		 WHERE fechavta>='%s'  AND cancelado ='0' \
		 GROUP BY cliente  \
		 HAVING ultimaventa<=ultimaventarango) AS auxventas ON auxventas.cliente=c.cliente"
			, fecha_inicio_uv, fecha_fin_uv, fecha_fija, fecha_inicio_uv);
	}

	if (ultimo_embarque == "1") {
		campo_ultimo_embarque.sprintf(" ,auxembarques.ultimaventa");
		fecha_fija.sprintf("2000-01-01");

		inner_ultimo_embarque.sprintf("INNER JOIN(SELECT cancelado, referencia, cliente, MAX(fechavta) AS ultimaventa, \
		 MAX(IF(fechavta>='%s' AND fechavta<='%s', fechavta, '%s')) AS ultimaventarango  FROM ventas \
		 WHERE fechavta between '%s' AND '%s'  AND cancelado ='0' and rtrim(embarque)<>'' \
		 GROUP BY cliente  \
		 ) AS auxembarques ON auxembarques.cliente=c.cliente",
			fecha_inicio_embarque, fecha_fin_embarque, fecha_fija,
			fecha_inicio_embarque, fecha_fin_embarque);
	}

	if (estatus != " ") {
		condicion_estatus.sprintf(" AND c.activo = '%s' ", estatus);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	// Obtiene todos los datos del cliente excepto los teléfonos.
	instruccion.sprintf("select c.cliente, %s as rsocial, c.calle, col.nombre as ncolonia, c.cp as cpostal, c.rfc, \
		c.plazo, c.limcred, c.numpedidos, concat(tp.tipoprec, ' - ', tp.descripcion) as precioasig, concat(tp.tipoprec, ' - ', tp.descripcion) as preciomin, \
		concat(tb.tipo, ' - ', tb.descripcion) as bloqueo, c.fnaccli as fechanac, \
		mun.nombre as nommunicipio, est.nombre as nomestado, \
		CONCAT(IF(c.numext<>'',CONCAT('Ext:',c.numext),''),'  ' ,IF(c.numint<>'',CONCAT('Int:',c.numint),'') ) AS numcasa, \
		col.localidad,col.sector %s %s ,ifnull(X(c.ubicaciongis),'') as latitud, ifnull(Y(c.ubicaciongis),'') as longitud, 0 as iddireccion \
		, clcan.descripcion ccc , clgir.nombre ggg, ifnull(c.email,'') as email, ifnull(c.email2,'') as email2 \
		,CONCAT(ifnull(ven.nombre,''), ' ', ifnull(ven.appat,''), ' ',ven.apmat) as vendedor, c.regimenfiscal, reg.descripcion as regnombre, c.sociedadmercantil \
		from clientes c  \
			INNER JOIN canalesclientes   clcan ON c.canal=clcan.canal \
			INNER JOIN gironegocio		 clgir ON c.giro=clgir.giro  \
			inner join clientesemp ce ON ce.cliente=c.cliente AND ce.idempresa=%s \
			inner join tiposdeprecios tp ON ce.tipoprec=tp.tipoprec  \
			inner join tiposdebloqueos tb ON c.bloqueo=tb.tipo \
			inner join colonias col ON c.colonia=col.colonia \
			inner join localidades loc ON col.localidad=loc.localidad \
			inner join municipios mun ON  loc.municipio=mun.municipio \
			inner join estados est ON mun.estado=est.estado \
			%s %s \
			LEFT JOIN cregimenfiscal AS reg on reg.regimenfiscal=c.regimenfiscal \
			LEFT OUTER JOIN empleados AS ven on ven.empleado=ce.vendedor \
		where \
			c.fechaalta>='%s' and c.fechaalta<='%s' \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
		union all \
		select c.cliente, %s as rsocial, dc.calle, col.nombre as ncolonia, dc.cp as cpostal, c.rfc, \
		c.plazo, c.limcred, c.numpedidos, concat(tp.tipoprec, ' - ', tp.descripcion) as precioasig, concat(tp.tipoprec, ' - ', tp.descripcion) as preciomin, \
		concat(tb.tipo, ' - ', tb.descripcion) as bloqueo, c.fnaccli as fechanac, \
		mun.nombre as nommunicipio, est.nombre as nomestado, \
		CONCAT(IF(dc.numext<>'',CONCAT('Ext:',dc.numext),''),'  ' ,IF(dc.numint<>'',CONCAT('Int:',dc.numint),'') ) AS numcasa, \
		col.localidad,col.sector %s %s ,ifnull(X(dc.ubicaciongis),'') as latitud, ifnull(Y(dc.ubicaciongis),'') as longitud, dc.iddireccion \
		, clcan.descripcion ccc, clgir.nombre ggg, ifnull(c.email,'') as email, ifnull(c.email2,'') as email2  \
		,CONCAT(ifnull(ven.nombre,''), ' ', ifnull(ven.appat,''), ' ',ven.apmat) as vendedor, c.regimenfiscal, reg.descripcion as regnombre, c.sociedadmercantil \
		from clientes c  \
			INNER JOIN canalesclientes   clcan ON c.canal=clcan.canal \
			INNER JOIN gironegocio		 clgir ON c.giro=clgir.giro  \
			inner join clientesemp ce ON ce.cliente=c.cliente AND ce.idempresa=%s \
			inner join tiposdeprecios tp ON ce.tipoprec=tp.tipoprec \
			inner join tiposdebloqueos tb ON c.bloqueo=tb.tipo \
			inner join direccionesentregaclientes as dc on dc.cliente=c.cliente \
			inner join colonias col ON dc.colonia=col.colonia \
			inner join localidades loc ON col.localidad=loc.localidad \
			inner join municipios mun ON  loc.municipio=mun.municipio \
			inner join estados est ON mun.estado=est.estado \
			%s %s \
			LEFT JOIN cregimenfiscal AS reg on reg.regimenfiscal=c.regimenfiscal \
			LEFT OUTER JOIN empleados AS ven on ven.empleado=ce.vendedor \
		where \
			c.fechaalta>='%s' and c.fechaalta<='%s' \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			ORDER BY rsocial, iddireccion", condicion_tipo_nombre,
		campo_ultima_venta, campo_ultimo_embarque, FormServidor->ObtieneClaveEmpresa(),
		inner_ultima_venta,
		inner_ultimo_embarque, fecha_inicial, fecha_final,

		condicion_tipopersona, condicion_acredito, condicion_mesnacimiento,
		condicion_tipoprecio, condicion_statuscliente,
		condicion_ubicacioncliente, condicion_cobrador, condicion_vendedor,
		condicion_sector, condicion_localidad, condicion_colonia,
		condicion_clientes_partesrel, condicion_clientes_envioCFD,
		condicion_gironegocio, condicion_canal,
		// para UNION con las direcciones de entrega del cliente
		condicion_limite_credito, condicion_preciomin, condicion_estatus,

		condicion_tipo_nombre, campo_ultima_venta, campo_ultimo_embarque,
		FormServidor->ObtieneClaveEmpresa(),
		inner_ultima_venta, inner_ultimo_embarque, fecha_inicial, fecha_final,

		condicion_tipopersona, condicion_acredito, condicion_mesnacimiento,
		condicion_tipoprecio, condicion_statuscliente,
		condicion_ubicacionentregacliente, condicion_cobrador,
		condicion_vendedor, condicion_sector, condicion_localidad,
		condicion_colonia, condicion_clientes_partesrel,
		condicion_clientes_envioCFD, condicion_gironegocio, condicion_canal,
		condicion_limite_credito, condicion_preciomin, condicion_estatus);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	// Obtiene todos los teléfonos del cliente
	instruccion.sprintf("select c.cliente, t.tipo, t.lada, t.telefono \
		%s \
		from clientes c \
			inner join clientesemp ce ON ce.cliente=c.cliente AND ce.idempresa=%s \
			inner join tiposdeprecios tp ON tp.tipoprec=ce.tipoprec \
			inner join tiposdebloqueos tb ON c.bloqueo=tb.tipo \
			inner join colonias col ON c.colonia=col.colonia \
			inner join localidades loc ON col.localidad=loc.localidad \
			inner join municipios mun ON  loc.municipio=mun.municipio \
			inner join estados est ON mun.estado=est.estado \
			inner join telefonosclientes t ON c.cliente=t.cliente \
			%s \
		where \
			c.fechaalta>='%s' and c.fechaalta<='%s' \
			%s %s %s %s %s %s %s %s %s %s %s %s %s \
			order by rsocial ",
		campo_ultima_venta, FormServidor->ObtieneClaveEmpresa(),
		inner_ultima_venta,
		fecha_inicial, fecha_final, condicion_tipopersona, condicion_acredito,
		condicion_mesnacimiento, condicion_tipoprecio, condicion_statuscliente,
		condicion_cobrador, condicion_vendedor, condicion_sector,
		condicion_localidad, condicion_colonia, condicion_clientes_partesrel,
		condicion_clientes_envioCFD, condicion_gironegocio);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

}

// ---------------------------------------------------------------------------
// ID_EJE_REPPROVEEDORES_GENERAL,
void ServidorReportes::EjecutaRepGeneralProveedores
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fecha_inicial, fecha_final, tipo_persona, acredito, tipo_precio,
		comprador, sin_comprador;
	AnsiString clientes_partesrel;
	AnsiString activo, capturista, sin_capturista;

	AnsiString condicion_tipopersona = " ";
	AnsiString condicion_acredito = " ";
	AnsiString condicion_clientes_partesrel = " ";
	AnsiString condicion_activo = " ";
	AnsiString condicion_comprador = " ", condicion_capturista = " ";
	AnsiString condicion_sin_comprador = " ", condicion_sin_capturista = " ";

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	tipo_persona = mFg.ExtraeStringDeBuffer(&parametros);
	acredito = mFg.ExtraeStringDeBuffer(&parametros);
	clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
	activo = mFg.ExtraeStringDeBuffer(&parametros);
	comprador = mFg.ExtraeStringDeBuffer(&parametros);
	sin_comprador = mFg.ExtraeStringDeBuffer(&parametros);
	capturista = mFg.ExtraeStringDeBuffer(&parametros);
	sin_capturista = mFg.ExtraeStringDeBuffer(&parametros);

	if (tipo_persona != " ") {
		condicion_tipopersona.sprintf("and prov.tipoempre='%s' ", tipo_persona);
	}
	if (acredito != " ") {
		condicion_acredito.sprintf("and prov.credito='%s' ", acredito);
	}
	// Es partes relacionadas
	if (clientes_partesrel != " ") {
		condicion_clientes_partesrel.sprintf("and prov.esparterelac=%s ",
			clientes_partesrel);
	}
	if (activo != " ") {
		condicion_activo.sprintf("and prov.activo=%s ", activo);
	}
	if (comprador != " ") {
		condicion_comprador.sprintf("AND prov.comprador='%s' ", comprador);
	}
	if (sin_comprador != " ") {
		condicion_sin_comprador.sprintf(" AND prov.comprador IS NULL ");
	}

	if (capturista != " ") {
		condicion_capturista.sprintf(" AND prov.capturista = '%s' ", capturista);
	}

	if (sin_capturista != " ") {
		condicion_sin_capturista = " AND prov.capturista IS NULL ";
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	// Obtiene todos los datos de los proveedores
	instruccion.sprintf("select prov.proveedor, \
		prov.razonsocial as nomproveedor, prov.rfc, prov.curp, prov.calle, \
		COALESCE(col.nombre,prov.colonia) as nomcolonia, prov.localidad as nommunicipio, estados.nombre AS nomestado, \
		prov.pais, prov.cp, telprov.tel ,prov.plazo, concat(emp.nombre, ' ', emp.appat, ' ', emp.apmat) AS comprador, \
		prov.email, prov.emailcto, prov.contacto, GROUP_CONCAT(ccprov.representante) as representante, GROUP_CONCAT(ccprov.condicion_comer) AS condicioncom, \
		CONCAT(COALESCE(ban1.nombre,''),' ', COALESCE(ban2.nombre,''), ' ',COALESCE(ban3.nombre,'')) AS bancos, \
		CONCAT(prov.cuentab1, ' ',prov.cuentab2, ' ',prov.cuentab3) As cuentabancos, \
		prov.fechauap, prov.apoyos, prov.descppp AS descuento, \
		prov.fechaalta, prov.usualta, CONCAT(emp2.nombre, ' ',emp2.appat, ' ', emp2.apmat) AS nomusualta,  prov.fechamodi, prov.usumodi, \
		CONCAT(emp3.nombre, ' ',emp3.appat, ' ', emp3.apmat) AS nomusumodi, prov.capturista,\
		CONCAT(emp4.nombre, ' ', emp4.appat, ' ', emp4.apmat) AS nombre_capturista\
		from proveedores prov \
		INNER JOIN estados ON prov.estado=estados.estado \
		left join (select concat(tel.lada,' ',tel.telefono) as tel, prov.proveedor \
		from proveedores prov, telefonosproveedores tel \
		where prov.proveedor=tel.proveedor group by prov.proveedor ) telprov on telprov.proveedor=prov.proveedor \
		LEFT JOIN empleados AS emp ON emp.empleado=prov.comprador \
		LEFT JOIN empleados AS emp2 ON emp2.empleado=prov.usualta \
		LEFT JOIN empleados AS emp3 ON emp3.empleado=prov.usumodi \
        LEFT JOIN empleados emp4 ON emp4.empleado = prov.capturista \
		LEFT JOIN colonias col ON col.colonia = prov.cvecolonia \
		LEFT JOIN condicionescomerprov ccprov ON ccprov.proveedor = prov.proveedor \
		LEFT JOIN bancos ban1 ON ban1.banco = prov.bancoc1 \
		LEFT JOIN bancos ban2 ON ban2.banco = prov.bancoc2 \
		LEFT JOIN bancos ban3 ON ban3.banco = prov.bancoc3 \
		where \
		prov.fechaalta>='%s' and prov.fechaalta<='%s' \
		%s %s %s %s %s %s %s %s\
		GROUP BY prov.proveedor \
		order by razonsocial ", fecha_inicial, fecha_final,
		condicion_tipopersona, condicion_acredito, condicion_clientes_partesrel,
		condicion_activo, condicion_comprador, condicion_sin_comprador,
		condicion_capturista, condicion_sin_capturista);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPINV_CAPTURADO
void ServidorReportes::EjecutaRepInventarioCapturado
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString producto;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos;
	AnsiString condicion_producto = " ", condicion_inventario = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ";
	AnsiString inventarios;

	try {
		inventarios = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("a.producto='%s' and ", producto);
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}
		condicion_inventario.sprintf(" inv.inventario in (%s) and ",
			inventarios);

		// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
		instruccion = "create temporary table existenciasaux ( \
			producto varchar(8), present varchar(255), \
			tipo char(2), cantidad decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias sumadas
		instruccion = "create temporary table auxexistsumadas ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistfinales ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			maxfactor decimal(10,3), multmax varchar(10), cantmax decimal(12,3), \
			minfactor decimal(10,3), multmin varchar(10), cantmin decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula el inventario capturado
		instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
			select a.producto, a.present, 'IN' as tipo, sum(dinv.cantidad*a.factor) as cantidad \
			from inventarios inv, dinventarios dinv, articulos a, productos prod \
			where %s %s %s %s %s\
			inv.inventario=dinv.inventario \
			and dinv.articulo=a.articulo and a.producto=prod.producto \
			group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_inventario,
			condicion_producto);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma los movimientos para obtener las existencias
		instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
				select e.producto, e.present, sum(e.cantidad) as cantidad \
				from existenciasaux e \
				group by e.producto, e.present");
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los factores minimo y máximo
		instruccion.sprintf("insert into auxexistfinales (producto, present, cantidad, maxfactor, minfactor) \
			select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
			from auxexistsumadas e, articulos a \
			where e.producto=a.producto and e.present=a.present %s \
			group by e.producto, e.present", condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmax=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmin=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			// Resultado final
			instruccion.sprintf("select prod.nombre as nomproducto, e.producto, e.present, \
				@maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, \
				(@resto/e.minfactor) as cantmin, \
				e.multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				a.articulo as articulo \
				from auxexistfinales e  inner join  productos prod  inner join  presentaciones present \
				left join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo \
				where \
				prod.producto=e.producto and e.producto=present.producto and \
				e.present=present.present");
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REP_COMP_INV_CAPTURADO
void ServidorReportes::EjecutaRepCompInventarioCapturado
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	BufferRespuestas* resp_almacenes = NULL;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString fecha;
	AnsiString producto;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos,sucursal;
    int soloMuestra, inclFamilia;
	AnsiString condicion_producto = " ", condicion_inventario = " ",
		condicion_almacen = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ";
	AnsiString almacenes, inventarios,almacen,cad_conjunto_almacenes;
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5;

	AnsiString inner_articulos=" ";
    AnsiString condicion_referencia_inventario=" ";
    AnsiString condicion_familia=" ";

	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		inventarios = mFg.ExtraeStringDeBuffer(&parametros);
		almacenes = mFg.ExtraeStringDeBuffer(&parametros);
        sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		soloMuestra = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		inclFamilia = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

		if(almacenes == 0){
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion \
						WHERE s.sucursal='%s'", sucursal);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);

			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
						resp_almacenes->IrAlRegistroNumero(i);
						almacen = resp_almacenes->ObtieneDato("almacen");

						cad_conjunto_almacenes += "'";
						cad_conjunto_almacenes += almacen;
						cad_conjunto_almacenes += "'";
						if (i < resp_almacenes->ObtieneNumRegistros() - 1)
							// A todos menos al ultimo impuesto le signo +.
								cad_conjunto_almacenes += ",";
			}
		}else{
			instruccion.sprintf("SELECT DISTINCT(i.almacen) \
				FROM inventarios i WHERE i.inventario IN (%s)", inventarios);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);

			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
						resp_almacenes->IrAlRegistroNumero(i);
						almacen = resp_almacenes->ObtieneDato("almacen");

						cad_conjunto_almacenes += "'";
						cad_conjunto_almacenes += almacen;
						cad_conjunto_almacenes += "'";
						if (i < resp_almacenes->ObtieneNumRegistros() - 1)
							// A todos menos al ultimo impuesto le signo +.
								cad_conjunto_almacenes += ",";
			}
        }

        almacenes = cad_conjunto_almacenes;

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("a.producto='%s' and ", producto);
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}
		condicion_inventario.sprintf(" i.inventario in (%s) and ", inventarios);
		condicion_almacen.sprintf(" in (%s) ", almacenes);

		if(soloMuestra==1){
			if(inclFamilia==1){
				inner_articulos = " INNER JOIN productos prod \
				INNER JOIN presentaciones present \
				INNER JOIN articulos a ON e.producto=a.producto AND e.present=a.present AND e.multmax=a.multiplo \
				LEFT JOIN auxinventagrupado i ON e.producto=i.producto AND i.present=e.present ";

				condicion_referencia_inventario.sprintf(" i.inventario IN (%s) ", inventarios);

				condicion_familia = "AND prod.clasif3 IN (SELECT clasif3 FROM auxfamiliaincluida)";
			} else {
				inner_articulos = " INNER JOIN productos prod \
				INNER JOIN presentaciones present \
				INNER JOIN articulos a ON e.producto=a.producto AND e.present=a.present AND e.multmax=a.multiplo \
				INNER JOIN auxinventagrupado i ON e.producto=i.producto AND i.present=e.present ";
			}
		} else {
			inner_articulos = " INNER JOIN productos prod \
			INNER JOIN presentaciones present \
			LEFT JOIN articulos a ON e.producto=a.producto AND e.present=a.present AND e.multmax=a.multiplo \
			LEFT JOIN auxinventagrupado i ON e.producto=i.producto AND i.present=e.present ";
		}

		// Crea una tabla donde se pondrá el inventario capturado agrupado por producto-presentacion
		instruccion = "create temporary table auxinventagrupado ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		if(soloMuestra==1){
			if(inclFamilia==1){
				instruccion = "CREATE TEMPORARY TABLE auxfamiliaincluida (clasif3 VARCHAR(10), INDEX(clasif3)) Engine = InnoDB";
				instrucciones[num_instrucciones++] = instruccion;

				instruccion.sprintf("INSERT INTO auxfamiliaincluida (clasif3) \
				SELECT prod.clasif3 \
				FROM inventarios i \
				INNER JOIN dinventarios di ON i.inventario=di.inventario \
				INNER JOIN articulos a ON di.articulo=a.articulo \
				INNER JOIN productos prod ON a.producto=prod.producto \
				WHERE %s \
				GROUP BY prod.clasif3", condicion_referencia_inventario);
				instrucciones[num_instrucciones++] = instruccion;
			}
		}

		// Inserta en la tabla se pondrán los inventarios agrupados por producto-presentacion
		instruccion.sprintf("insert into auxinventagrupado (producto, present, cantidad) \
			select a.producto, a.present, sum(di.cantidad*a.factor) as cantidad \
			from inventarios i, dinventarios di, articulos a, productos prod \
			where %s %s %s %s %s \
			i.inventario=di.inventario \
			and di.articulo=a.articulo and  \
			a.producto=prod.producto \
			group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_inventario);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		// instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte  from puntoscorte p where p.fecha<'%s'", fecha);
		instruccion.sprintf("set @fechacorte='1900-01-01'");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
		instruccion = "create temporary table existenciasaux ( \
			producto varchar(8), present varchar(255), \
			tipo char(2), cantidad decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistsumadas ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistfinales ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			maxfactor decimal(10,3), multmax varchar(10), cantmax decimal(12,3), \
			minfactor decimal(10,3), multmin varchar(10), cantmin decimal(12,3), \
			artmultmax varchar(9), artmultmin varchar(9), \
			INDEX(producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula base (0) de los artículos en cuestión la existencia al momento del corte previo.
		// La utilidad de esto es simplemente para tomar en cuenta todos los articulos aunque no
		// tengan ningun movimiento
		instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
			select a.producto, a.present, 'BA' as tipo, \
			0 as cantidad \
			from articulos a, productos prod \
			where %s %s %s %s \
			a.producto=prod.producto \
			group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las compras
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from compras c, dcompras d, articulos a, productos prod \
			where %s %s %s %s \
			c.fechacom>@fechacorte and c.fechacom<=@fechafinal and c.referencia=d.referencia \
			and c.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			and c.almacen%s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_almacen, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las compras
		instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
			select a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from notascredprov n, compras c, dnotascredprov d, articulos a, productos prod \
			where  %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' \
			and n.referencia=d.referencia and n.compra=c.referencia and \
			n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			and c.almacen%s \
			group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_almacen);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las ventas.
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from ventas v force index(fechavta), dventas d, articulos a, productos prod \
			where %s %s %s %s \
			v.fechavta>@fechacorte and v.fechavta<=@fechafinal and v.referencia=d.referencia \
			and v.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			and d.almacen%s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_almacen, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las ventas
		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad \
			from notascredcli n, dnotascredcli dn, ventas v, dventas dv, articulos a, productos prod \
			where %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' \
			and n.referencia=dn.referencia and n.venta=v.referencia \
			and v.referencia=dv.referencia and \
			n.cancelado=0 and dn.articulo=a.articulo and dv.articulo=dn.articulo and a.producto=prod.producto \
			and dv.almacen%s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_almacen, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las entradas de almacén
		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'EN' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from movalma m, dmovalma d, articulos a, productos prod \
			where %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'S' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			and m.almaent%s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_almacen, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las salidas de almacén
		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from movalma m, dmovalma d, articulos a, productos prod \
			where %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'E' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
			and m.almasal%s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_almacen, archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma los movimientos para obtener las existencias
		instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
				select e.producto, e.present, sum(e.cantidad) as cantidad \
				from existenciasaux e \
				group by e.producto, e.present");
		instrucciones[num_instrucciones++] = instruccion;

		// Inserta en las existencias sumadas los productos-presentaciones que no
		// tenian movimientos (cantidad=0) y por lo tanto no estaban en auxexistsumadas
		// esto con el proposito que en auxexistsumadas esten TODOS los articulos
		// que cumplan las condiciones dadas por el usuario
			instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
			select a.producto, a.present, 0 as cantidad \
			from presentaciones a, productos prod \
			where %s %s %s %s \
			a.producto=prod.producto and \
			(a.producto, a.present) not in (select producto, present from existenciasaux) \
				group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto);
			instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los factores minimo y máximo
		instruccion.sprintf("insert into auxexistfinales (producto, present, cantidad, maxfactor, minfactor) \
			select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
			from auxexistsumadas e, articulos a \
			where e.producto=a.producto and e.present=a.present %s \
			group by e.producto, e.present", condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmax=a.multiplo, e.artmultmax=a.articulo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmin=a.multiplo, e.artmultmin=a.articulo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);

			// Resultado final
			instruccion.sprintf("select prod.nombre as nomproducto, @auxproducto:=e.producto as producto, @auxpresent:=e.present as present, \
				@maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				(@resto/e.minfactor) as cantmin, \
				@maxcantidadinv:=truncate(ifnull(i.cantidad,0)/e.maxfactor,0) as cantmaxinv, \
				@restoinv:=mod(ifnull(i.cantidad,0), e.maxfactor) as restoinv, \
				(@restoinv/e.minfactor) as cantmininv, \
				@maxcantidaddif:=((truncate((ifnull(i.cantidad,0)-e.cantidad)/e.maxfactor,0))*-1) as cantmaxdif, \
				@restodif:=mod(ifnull(i.cantidad,0)-e.cantidad, e.maxfactor) as restodif, \
				((@restodif/e.minfactor)*-1) as cantmindif, \
				@auxmultmax:=e.multmax as multmax, \
				@auxmultmin:=e.multmin as multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				a.articulo as articulo, \
				e.artmultmax as articulomax, \
				e.artmultmin as articulomin \
				from auxexistfinales e  \
				%s \
				where \
				prod.producto=e.producto and e.producto=present.producto and \
				e.present=present.present %s",
				inner_articulos, condicion_familia);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOVENTAS
void ServidorReportes::EjecutaRepCostoVentas(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, almacen, producto,
		presentacion, marca, proveedor;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_acredito = " ", condicion_almacen = " ",
		condicion_producto = " ", condicion_presentacion = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_clasif1_diferencia = " ",
		condicion_clasif2_diferencia = " ", condicion_clasif3_diferencia = " ";
	AnsiString condicion_marca = " ", condicion_proveedor = " ",
		condicion_marca_diferencia = " ";
	AnsiString incluir_devoluciones, desglosado, join_devoluciones = " ";
	AnsiString tipofacturacion, cliente, condicion_tipofac = " ",
		condicion_tipofac_diferencia = " ", condicion_cliente = " ",
		condicion_cliente_diferencia = " ";
	AnsiString sector, condicion_sector = " ", condicion_sector_diferencia =
		" ", inner_sectolocalidad_diferencia = " ";
	AnsiString localidad, condicion_localidad = " ",
		condicion_localidad_diferencia = " ";
	AnsiString vendedor, condicion_vendedor = " ",
		condicion_vendedor_diferencia = " ";
	AnsiString venta, condicion_venta = " ", condicion_venta_diferencia = " ",
		condicion_acredito_diferencia = " ";
	AnsiString campos_detalle = " ";
	AnsiString cantvta, cantdev;
	bool es_desglosado = false;
	IteradorCostos *iterador;
	bool hay_pendientes, aplicar_costo;
	int estado_iteracion;
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ", cad_conjunto_sucursal = " ",
		inners_diferencias = " ", campos_detalle_diferencias = " ";
	AnsiString prov_predeterminado, condicion_prov = " ", inner_prov = " ",
		inner_marca = " ", inner_prov_diferencia = " ";
	AnsiString inner_prodpresentaux_pc = " ", inner_prodpresentaux_dif = " ",
		inner_prodpresentnotaux_dif = " ", inner_prodpresentnot2aux_dif = " ",
		condicion_prov_diferencia = " ";
	AnsiString condicion_vacio_almasec = " ", condicion_almacen_dos = " ";

	AnsiString inner_productos_dif = " ";
	AnsiString condicion_producto_dif = " ", condicion_presentacion_dif = " ";
	AnsiString archivo_temp1;

	BufferRespuestas *resp_bloques = NULL;
	AnsiString minimo, minimo2, maximo2;
	int x;
	AnsiString condicion_rango_productos;

	AnsiString prov_compras, inner_provcompras = " ",
		condiccion_provcompras = " ";
	AnsiString where_provcompras = " ", inner_marcprovcom = " ";

	BufferRespuestas *resp_mov = NULL, *resp_prod = NULL;
	double costotot;
	char *aux, *respuesta;
	int *tam_respuesta, *num_filas;
	AnsiString nombre_producto, producto_anterior, present_anterior;
	double acum_cantidad, acum_cantvta;
	double acum_costo, acum_costovta, costoprom;
	AnsiString producto_actual, present_actual, tipo_actual, diferencias,
		inner_aux;
	char clasif_actual, clasif_actual_str[2];
	double cantidad_actual, cantvta_actual;
	double costounit_actual, costotot_actual, totalventas, preciosimp;
	int num_registros;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursal = NULL;
	BufferRespuestas* resp_present_en_venta = NULL;
	BufferRespuestas* resp_hay_ventas = NULL;
	TStringList *lista_productos = new TStringList;
	AnsiString fecha_actual, aux_fecha_actual;
	int acum_fechas;
	double acum_costo_fechas;
	AnsiString forzar_indice = "FORCE INDEX(PRIMARY)";
	AnsiString meses, condicion_meses;

	AnsiString condicion_dev_venta = " ";
	BufferRespuestas *resp_dev_de_venta = NULL;

	bool registra_costovta;
	AnsiString archivo_temp_vtas;
	TFileStream *FStream1 = NULL;
	AnsiString referencia_actual = "", cadena;

	AnsiString clientes_partesrel;
	AnsiString join_clientes = " ", sub_join_clientes = " ";
	AnsiString condicion_clientes_partesrel = " ";

	AnsiString segmento, fabricante;
	AnsiString inner_seg_fab = " ", condicion_fabricante = " ",
		condicion_segmento = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString idEmpresa = " ";

	char *buffer_resp_mov = NULL;
	try {
		buffer_resp_mov = new char[TAM_MAX_BUFFER_COSTOS];

		fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		prov_predeterminado = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		presentacion = mFg.ExtraeStringDeBuffer(&parametros);
		desglosado = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_devoluciones = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		sector = mFg.ExtraeStringDeBuffer(&parametros);
		localidad = mFg.ExtraeStringDeBuffer(&parametros);
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		diferencias = mFg.ExtraeStringDeBuffer(&parametros);
		prov_compras = mFg.ExtraeStringDeBuffer(&parametros);
		registra_costovta = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		meses = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);

		int indice_producto, indice_present, indice_clasif, indice_cantvta,
			indice_cantidad, indice_costounit;
		int indice_tipo, indice_fecha, indice_referencia;
		int indice_subtotventa, indice_suma;

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " " && sucursal != "' '") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal IN (%s)", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
			else {
				cad_conjunto_almacenes = " ";
			}
		}
		// cuando se dejen los campos vacios de almacen y sucursal no debe incluir la condicion de dv.alamcen
		// de lo contrario debe incluirla
		if (almacen == " " || sucursal == " " || sucursal == "' '") {
			if (almacen == " ") {
				condicion_vacio_almasec = cad_conjunto_almacenes;
			}
			else if (sucursal == " " || sucursal == "' '") {
				condicion_vacio_almasec = "dv.almacen=" + cad_conjunto_almacenes + "and";
			}

		}
		else {
			condicion_vacio_almasec.sprintf(" dv.almacen IN (%s) AND ",
				cad_conjunto_almacenes);
		}

		if (sector != " ") {
			condicion_sector.sprintf(" and pc.sector='%s' ", sector);
			condicion_sector_diferencia.sprintf(" and col.sector='%s' ",
				sector);
		}
		if (localidad != " ") {
			condicion_localidad.sprintf(" and pc.localidad='%s' ", localidad);
			condicion_localidad_diferencia.sprintf(" and col.localidad='%s' ",
				localidad);
		}
		if (vendedor != " ") {
			condicion_vendedor.sprintf(" and pc.vendedor='%s' ", vendedor);
			condicion_vendedor_diferencia.sprintf(" and v.vendedor='%s' ",
				vendedor);
		}
		if (tipofacturacion != " ") {
			condicion_tipofac.sprintf(" and pc.tipofac='%s' ", tipofacturacion);
			condicion_tipofac_diferencia.sprintf(" and v.tipofac='%s' ",
				tipofacturacion);
		}
		if (cliente != " ") {
			condicion_cliente.sprintf(" and pc.cliente='%s' ", cliente);
			condicion_cliente_diferencia.sprintf(" and v.cliente='%s' ",
				cliente);
		}
		if (venta != " ") {
			condicion_venta.sprintf(" and pc.referencia='%s' ", venta);
			condicion_venta_diferencia.sprintf(" and v.referencia='%s' ",
				venta);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (acredito != " ") {
			condicion_acredito.sprintf(" and pc.acredito=%s ", acredito);
			condicion_acredito_diferencia.sprintf(" and v.acredito=%s ",
				acredito);
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" pc.clasif1='%s' and ", clasif1);
			condicion_clasif1_diferencia.sprintf("and p.clasif1='%s'  ",
				clasif1);
			inner_productos_dif.sprintf
				(" INNER JOIN productos p ON p.producto=a.producto ");
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" pc.clasif2='%s' and ", clasif2);
			condicion_clasif2_diferencia.sprintf(" and p.clasif2='%s' ",
				clasif2);
			inner_productos_dif.sprintf
				(" INNER JOIN productos p ON p.producto=a.producto ");
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" pc.clasif3='%s' and ", clasif3);
			condicion_clasif3_diferencia.sprintf(" and p.clasif3='%s' ",
				clasif3);
			inner_productos_dif.sprintf
				(" INNER JOIN productos p ON p.producto=a.producto ");
		}

		if (producto != " ") {
			condicion_producto.sprintf("pc.producto='%s' and ", producto);
			condicion_producto_dif.sprintf("a.producto='%s' and ", producto);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (presentacion != " ") {
			condicion_presentacion.sprintf("pc.present='%s' and ",
			presentacion);
			condicion_presentacion_dif.sprintf("a.present='%s' and ",
				presentacion);
		}
		if (desglosado == "1" && registra_costovta)
			throw Exception
				("desglosado y registra_costovta no pueden estar ambos activos."
				);

		if (desglosado == "1") {
			es_desglosado = true;
			campos_detalle = ", pc.tipo, pc.referencia ";
		}
		if (registra_costovta) {
			campos_detalle = ", pc.tipo, pc.referencia ";
		}
		if (venta != " ") {
			// Crea condición para restringirse a los productos y presentaciones de la venta,
			// para evitar calcular de más.
			AnsiString producto_en_venta, present_en_venta,
			condicion_presentacion_venta;
			AnsiString cad_conjunto_present = "";

			instruccion.sprintf("SELECT a.producto, a.present FROM dventas dv \
				INNER JOIN articulos a ON dv.articulo=a.articulo \
				WHERE dv.referencia='%s' \
				GROUP BY a.producto, a.present", venta);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_present_en_venta);
			if (resp_present_en_venta->ObtieneNumRegistros() > 0) {
				for (i = 0;
				i < resp_present_en_venta->ObtieneNumRegistros(); i++) {
					resp_present_en_venta->IrAlRegistroNumero(i);
					producto_en_venta =
						resp_present_en_venta->ObtieneDato("producto");
					present_en_venta =
						resp_present_en_venta->ObtieneDato("present");

					if (i == 0)
						cad_conjunto_present += "(";

					cad_conjunto_present += "('";
					cad_conjunto_present += producto_en_venta;
					cad_conjunto_present += "','";
					cad_conjunto_present += present_en_venta;
					cad_conjunto_present += "')";

					if (i < resp_present_en_venta->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_present += ",";
					else
						cad_conjunto_present += ")";
				}
				condicion_presentacion_venta.sprintf
					(" (pc.producto, pc.present) in %s and ",
					cad_conjunto_present);
				// Concatena la condición resultante a la condición de la presentación.
				condicion_presentacion += condicion_presentacion_venta;
			}
			else
				throw(Exception("No se encontró la venta dada como parámetro"));

			// Crea condición para obtener las notas de devolución de la venta dada como parámetro.
			AnsiString cad_conjunto_dev = "", dev_de_venta;
			instruccion.sprintf
				("select n.referencia from notascredcli n where n.venta='%s' and n.cancelado=0 and n.tipo=0",
				venta);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_dev_de_venta);
			if (resp_dev_de_venta->ObtieneNumRegistros() > 0) {
				for (i = 0; i < resp_dev_de_venta->ObtieneNumRegistros(); i++) {
					resp_dev_de_venta->IrAlRegistroNumero(i);
					dev_de_venta = resp_dev_de_venta->ObtieneDato("referencia");

					if (i == 0)
						cad_conjunto_dev += "(";

					cad_conjunto_dev += "'" + dev_de_venta + "'";

					if (i < resp_dev_de_venta->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo le agregamos coma.
							cad_conjunto_dev += ",";
					else
						cad_conjunto_dev += ")";
				}
				condicion_dev_venta.sprintf(" and (pc.referencia) in %s ",
					cad_conjunto_dev); // todas las notas de la venta dada
			}
			else
				condicion_dev_venta.sprintf(" and pc.referencia='' ");
			// Si no hay notas para la venta dada nos aseguramos que la no se incluya ninguna (nunca se cumplirá esta condición).
		}

		// marca
		if (marca != " ") {
			condicion_marca.sprintf(" pro.marca='%s' ", marca);
			inner_prodpresentaux_pc.sprintf
				(" INNER JOIN prodpresentaux ppa ON ppa.producto=pc.producto AND ppa.present=pc.present "
				);
			inner_prodpresentaux_dif.sprintf
				(" INNER JOIN prodpresentaux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);
			inner_prodpresentnotaux_dif.sprintf
				(" INNER JOIN prodpresentnotaux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);
			inner_prodpresentnot2aux_dif.sprintf
				(" INNER JOIN prodpresentnot2aux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);

			inner_productos_dif.sprintf
				(" INNER JOIN productos p ON p.producto=a.producto ");
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}

		// proveedor
		if (prov_predeterminado != " ") {

			inner_prodpresentaux_pc.sprintf
				(" INNER JOIN prodpresentaux ppa ON ppa.producto=pc.producto AND ppa.present=pc.present "
				);
			inner_prodpresentaux_dif.sprintf
				(" INNER JOIN prodpresentaux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);
			inner_prodpresentnotaux_dif.sprintf
				(" INNER JOIN prodpresentnotaux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);
			inner_prodpresentnot2aux_dif.sprintf
				(" INNER JOIN prodpresentnot2aux ppa ON ppa.producto=a.producto AND ppa.present=a.present "
				);

			condicion_prov = " ap.proveedor='" + prov_predeterminado + "' ";
			condicion_prov_diferencia =
				" ap.proveedor='" + prov_predeterminado + "' and ";
			inner_prov.sprintf
				("INNER JOIN articulosped ap ON ap.producto=pre.producto AND ap.present=pre.present "
				);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}

		if (clientes_partesrel != " " &&
			(condicion_localidad_diferencia == " " &&
			condicion_sector_diferencia == " ")) {
			sub_join_clientes =
				" inner join clientes cli on cli.cliente=v.cliente ";
			join_clientes =
				" inner join clientes cli on cli.cliente=v.cliente ";
			condicion_clientes_partesrel.sprintf("cli.esparterelac=%s and ",
				clientes_partesrel);
		}

		if (segmento != " " || fabricante != " ") {
			inner_seg_fab.sprintf
				(" INNER JOIN productos p ON p.producto = pc.producto ");
		}

		// Usaremos el segmento de presentacion
		if (segmento != " ") {
			condicion_segmento.sprintf(" pcb.segmento='%s' and ", segmento);
			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=pc.producto AND present.present=pc.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+
				  FormServidor->ObtieneClaveEmpresa();
			// 1 y 4 y 5

		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" p.fabricante = '%s' and ",
			fabricante);
		}

		// Si se está mandando proveedor o marca
		if (prov_predeterminado != " " || marca != " ") {

			instruccion =
				"CREATE TEMPORARY TABLE prodpresentaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			AnsiString and_necesario = " ";
			if (prov_predeterminado != " " && marca != " ")
				and_necesario = " AND ";

			instruccion.sprintf("INSERT INTO prodpresentaux (producto,present) \
			  SELECT DISTINCT pre.producto, pre.present \
			  FROM productos pro \
			  INNER JOIN presentaciones pre ON pro.producto=pre.producto \
			  %s \
			  WHERE %s %s %s", inner_prov, condicion_prov, and_necesario,
				condicion_marca);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentnotaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion = "INSERT INTO prodpresentnotaux (producto,present) \
				select producto, present from prodpresentaux ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			// Se creat una tabla igualita a prodpresentnotaux para evitar error al hacer un UNION (can't reopen table)
			// Al parecer en la versión 10.3 de mariadb ya no será necesario esto.
			instruccion =
				"create temporary table prodpresentnot2aux like prodpresentnotaux";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));
			instruccion =
				"insert into prodpresentnot2aux select * from prodpresentnotaux;";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));
		}

		if (diferencias == "1") {
			// inners_diferencias=" LEFT JOIN articulos a ON a.producto=pc.producto AND a.present=pc.present LEFT JOIN dventas dv ON dv.referencia=pc.referencia AND a.articulo=dv.articulo ";
			/* (producto!=" ") {
			 inner_aux.sprintf(" a.producto='%s' AND ",producto);
			 } else {
			 inner_aux=" ";
			 } */
			// este iner solo cuando este sector o localidad y este activado las diferencias
			if (condicion_localidad_diferencia != " " ||
				condicion_sector_diferencia != " ") {
				inner_sectolocalidad_diferencia.sprintf("inner join  clientes cli on v.cliente=cli.cliente \
						inner join  colonias col on cli.colonia=col.colonia");
				if (clientes_partesrel != " ") {
					sub_join_clientes =
						" inner join clientes cli on cli.cliente=v.cliente ";
					condicion_clientes_partesrel.sprintf
						("cli.esparterelac=%s and ", clientes_partesrel);
				}
			}

			instruccion.sprintf("create temporary table auxventasdif ( \
				producto varchar(8), present varchar(255), \
				suma decimal(16,4), subtotventa decimal(16,4), \
				primary key(producto, present)) Engine = InnoDB");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1,
				Respuesta->Id);
			AnsiString subquery1_ventas, subquery2_ventas;
			// Es subquery 1 contrandrá ventas en el pediodo descontandole sus notas de dicho periodo.
			subquery1_ventas.sprintf(" \
				SELECT a.producto, a.present,\
				SUM((dv.precioimp- IFNULL(auxnota.precioimp,0))*(dv.cantidad- IFNULL(auxnota.cantidad,0))) AS suma,  \
				SUM((dv.precio- IFNULL(auxnota.precio,0))*(dv.cantidad- IFNULL(auxnota.cantidad,0))) AS subtotventa \
				FROM ventas v force index(fechavta) \
				INNER JOIN dventas dv ON dv.referencia=v.referencia   \
				INNER JOIN articulos a ON a.articulo=dv.articulo \
				%s \
				%s \
				LEFT JOIN (SELECT v.referencia AS venta, d.articulo,  \
					SUM(IF(n.tipo='0',d.cantidad,0)) AS cantidad,  \
					SUM(IF(n.tipo<>'0',d.precio,0)) AS precio,  \
					SUM(IF(n.tipo<>'0',d.precioimp,0)) AS precioimp   \
					FROM notascredcli n                               \
					INNER JOIN dnotascredcli d ON n.referencia=d.referencia   \
					INNER JOIN ventas v ON n.venta=v.referencia     \
					INNER JOIN articulos a ON d.articulo=a.articulo \
					%s \
					%s \
					WHERE %s %s %s n.cancelado=0 AND v.cancelado=0  \
					AND n.fechanot <= '%s' \
					%s %s %s %s %s \
					GROUP BY v.referencia, d.articulo) AS auxnota ON  \
					auxnota.articulo=dv.articulo AND  auxnota.venta=v.referencia \
				%s %s \
				WHERE %s %s %s %s v.fechavta>='%s' \
				AND v.fechavta<='%s' AND v.cancelado=0 \
				%s %s %s %s %s %s %s %s %s %s \
				GROUP BY a.producto,a.present", inner_productos_dif,
				join_clientes, inner_prodpresentnotaux_dif, sub_join_clientes,
				condicion_clientes_partesrel, condicion_producto_dif,
				condicion_presentacion_dif, fecha_final,
				condicion_cliente_diferencia, condicion_venta_diferencia,
				condicion_vendedor_diferencia, condicion_tipofac_diferencia,
				condicion_acredito_diferencia, inner_sectolocalidad_diferencia,
				inner_prodpresentaux_dif, condicion_clientes_partesrel,
				condicion_producto_dif, condicion_presentacion_dif,
				condicion_vacio_almasec.c_str(), fecha_inicial, fecha_final,
				condicion_vendedor_diferencia, condicion_sector_diferencia,
				condicion_localidad_diferencia, condicion_tipofac_diferencia,
				condicion_cliente_diferencia, condicion_venta_diferencia,
				condicion_acredito_diferencia, condicion_clasif1_diferencia,
				condicion_clasif2_diferencia, condicion_clasif3_diferencia);

			// el subquery 2 contiene las notas hechas en el periodo pero que corresponden a ventas anteriores al periodo.
			subquery2_ventas.sprintf(" \
				SELECT \
					a.producto, a.present, \
					sum(d.precioimp*d.cantidad*-1) AS suma, \
					sum(d.precio*d.cantidad*-1) AS subtotventa \
				FROM notascredcli n \
				INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
				INNER JOIN dventas dv ON dv.referencia=n.venta AND dv.articulo=d.articulo \
				INNER JOIN ventas v ON n.venta=v.referencia AND v.fechavta<'%s' \
				INNER JOIN articulos a ON d.articulo=a.articulo \
					%s \
					%s \
					%s \
					%s \
				WHERE %s %s %s %s n.cancelado=0 AND v.cancelado=0 AND \
					n.fechanot between '%s' AND '%s' \
					%s %s %s %s %s \
					%s %s %s %s %s %s \
				GROUP BY a.producto,a.present ", fecha_inicial,
				inner_productos_dif, join_clientes,
				inner_prodpresentnot2aux_dif, inner_sectolocalidad_diferencia,
				condicion_clientes_partesrel, condicion_producto_dif,
				condicion_presentacion_dif, condicion_vacio_almasec.c_str(),
				fecha_inicial, fecha_final, condicion_cliente_diferencia,
				condicion_venta_diferencia, condicion_vendedor_diferencia,
				condicion_tipofac_diferencia, condicion_acredito_diferencia,
				condicion_sector_diferencia, condicion_localidad_diferencia,
				condicion_tipofac_diferencia, condicion_clasif1_diferencia,
				condicion_clasif2_diferencia, condicion_clasif3_diferencia);

			// Se hace la union de ambos subquerys agrupando por producto-presentacion
			instruccion.sprintf(" \
				SELECT t.producto, t.present, sum(t.suma), sum(t.subtotventa) from \
				( \
					( \
					  %s \
					) \
					UNION ALL \
					( \
					 %s \
					) \
				) t \
				GROUP BY t.producto,t.present \
				INTO OUTFILE '%s' ", subquery1_ventas, subquery2_ventas,
				archivo_temp1);

			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxventasdif (producto, present, suma, subtotventa) ",
				archivo_temp1);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			// Si no hay ventas entonces aborta.
			instruccion.sprintf
				("SELECT producto, present FROM auxventasdif limit 1", venta);
			if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_hay_ventas)) {
				if (resp_hay_ventas->ObtieneNumRegistros() == 0) {
					throw(Exception("No hay ventas con los parámetros dados"));
				}
			}
			else
				throw(Exception("Error en query EjecutaSelectSql"));

			inners_diferencias.sprintf
				(" LEFT JOIN auxventasdif aux ON aux.producto=pc.producto and aux.present=pc.present "
				);

			campos_detalle_diferencias = " ,aux.suma,aux.subtotventa ";
		}

		if (prov_compras == " ") {

			inner_provcompras = " ";
			condiccion_provcompras = " ";
			inner_marcprovcom = " ";
			where_provcompras = " ";
		}
		else {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha_final, meses, fecha_final);
			}
			else {
				condicion_meses = " ";
			}
			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present",
				AnsiString(prov_compras).c_str(), condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			inner_provcompras.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pppca.producto=pc.producto AND pppca.present=pc.present"
				);
		}

		if (registra_costovta) {
			archivo_temp_vtas = mServidorVioleta->ObtieneArchivoTemp(99,
				Respuesta->Id);
			FStream1 = new TFileStream(archivo_temp_vtas,
				fmCreate | fmShareDenyNone);
		}

		if (es_desglosado) {
			// Si es desglosado se ocupa más por productos con demaciados movimientos
			mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
				mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*4) + "] bytes",
				Respuesta->Id);
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP*4);
		}
		else {
			mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
				mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*2) + "] bytes",
				Respuesta->Id);
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP*2);
		}

		int rr_tam_respuesta;
		char *rr_aux_resultado = Respuesta->BufferResultado;
		int *rr_aux_tam = (int *)rr_aux_resultado;
		rr_aux_resultado += sizeof(int);
		// Nos saltamos la parte del tamaño del resultado.
		rr_aux_resultado = mFg.AgregaPCharABuffer("0", rr_aux_resultado);
		// No hubo error
		rr_tam_respuesta = rr_aux_resultado - Respuesta->BufferResultado;
		*rr_aux_tam = rr_tam_respuesta -sizeof(int);
		Respuesta->TamBufferResultado = rr_tam_respuesta;

		respuesta = Respuesta->BufferResultado +
			Respuesta->TamBufferResultado; // Allì vamos a poner el resultado
		aux = respuesta;
		tam_respuesta = (int *)aux;
		// Obtenemos la direccion donde se va a poner el tamaño del resultado
		aux += sizeof(int);
		num_filas = (int *)aux;
		// Obtenemos la direccion donde se va a poner el número de registros
		(*num_filas) = 0;
		aux += sizeof(int);

		// Obtiene la lista de nombres de productos
		lista_productos->Sorted = true;
		instruccion = "select producto, nombre from productos";
		if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_prod, TAM_MAX_BUFFER_RESPUESTA_MIN)) {
			for (i = 0; i < resp_prod->ObtieneNumRegistros(); i++) {
				resp_prod->IrAlRegistroNumero(i);
				lista_productos->AddObject(resp_prod->ObtieneDato("producto"),
					(TObject *)(resp_prod->ObtienePunteroDato("nombre")));
			}
		}

		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" and pc.almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		if (incluir_devoluciones == "1") {
			cantdev.sprintf(" \
				if(pc.tipo='DV' and pc.fecha>='%s' and pc.fecha<='%s' %s %s %s %s %s %s %s %s , pc.cantidad, 0) "
				, fecha_inicial, fecha_final, condicion_almacen,
				condicion_acredito, condicion_tipofac, condicion_cliente,
				condicion_vendedor, condicion_sector, condicion_localidad,
				condicion_dev_venta);
		}
		else
			cantdev = "0";
		// Volví a activar esta condición para evitar el nulo en el campo cantvta, que sea cero cuando no aplican devoluciones.

		cantvta.sprintf(" \
			if(pc.tipo='VE' and pc.fecha>='%s' and pc.fecha<='%s' %s %s %s %s %s %s %s %s, pc.cantidad, %s) "
			, fecha_inicial, fecha_final, condicion_almacen, condicion_acredito,
			condicion_tipofac, condicion_cliente, condicion_vendedor,
			condicion_sector, condicion_localidad, condicion_venta, cantdev);

		// **********************************************************************************************



		instruccion.sprintf("select pmm.producto, pmm.present, pmm.minimo, pmm.maximo \
			from precalculominmaxfin%s pmm \
			order by pmm.minimo", idEmpresa);
		if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_bloques))
			throw Exception
				("Error en select precalculominmax de ID_CALC_PRECALCULOCOSTOS_MENSUAL"
				);

		for (x = 0; x < resp_bloques->ObtieneNumRegistros() - 1; x++) {
			resp_mov = NULL;
			iterador = NULL;

			resp_bloques->IrAlRegistroNumero(x);
			minimo = resp_bloques->ObtieneDato("minimo");

			resp_bloques->IrAlRegistroNumero(x + 1);
			minimo2 = resp_bloques->ObtieneDato("minimo");
			maximo2 = resp_bloques->ObtieneDato("maximo");

			if (x < resp_bloques->ObtieneNumRegistros() - 2) {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<%s ",
					minimo, minimo2);
			}
			else {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<=%s ",
					minimo, maximo2);
			}

			try {
				// Manda el resultado a un buffer
				instruccion.sprintf("select pc.producto, pc.present, pc.fecha, \
					pc.clasif, pc.cantidad, pc.costounit, pc.tipo, \
					%s as cantvta \
					%s \
					%s \
					from precalculocostos%s pc %s %s %s %s \
					%s %s\
					where %s and %s %s %s %s %s %s %s \
					pc.fecha<='%s' \
					order by pc.id", cantvta, campos_detalle,
					campos_detalle_diferencias, idEmpresa, forzar_indice,
					join_presentacion1, inner_prodpresentaux_pc,
					inners_diferencias, inner_provcompras, inner_seg_fab,
					condicion_rango_productos, condicion_presentacion,
					// Condiciones del where
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_producto, condicion_segmento,
					condicion_fabricante, fecha_final);

				if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_mov, buffer_resp_mov)) {
					mServidorVioleta->MuestraMensaje
						("-- Finalizó mandar resultados a buffer [" +
						mFg.IntToAnsiString(resp_mov->ObtieneTamRespuesta()) +
						"] bytes", Respuesta->Id);

					// Crea objeto iterador
					iterador = new IteradorCostos(resp_mov);

					mServidorVioleta->MuestraMensaje
						("-- Finalizó creación de iterador", Respuesta->Id);

					indice_producto = resp_mov->ObtieneIndiceCampo("producto");
					indice_present = resp_mov->ObtieneIndiceCampo("present");

					indice_clasif = resp_mov->ObtieneIndiceCampo("clasif");
					indice_cantvta = resp_mov->ObtieneIndiceCampo("cantvta");
					indice_cantidad = resp_mov->ObtieneIndiceCampo("cantidad");
					indice_costounit =
						resp_mov->ObtieneIndiceCampo("costounit");
					indice_fecha = resp_mov->ObtieneIndiceCampo("fecha");
					indice_tipo = resp_mov->ObtieneIndiceCampo("tipo");
					if (es_desglosado || registra_costovta) {

						indice_referencia =
							resp_mov->ObtieneIndiceCampo("referencia");
					}
					if (diferencias == "1") {
						indice_suma = resp_mov->ObtieneIndiceCampo("suma");
						indice_subtotventa =
							resp_mov->ObtieneIndiceCampo("subtotventa");
					}

					// producto_anterior se usa para que en cada registro saber que
					// producto era el registro anterior
					producto_anterior = "";

					// present_anterior se usa para en cada registro saber que
					// presentación era el registro anterior
					present_anterior = "";

					// acum_cantidad se usa para en cada registro saber
					// la sumatoria de la cantidad del último producto-presentación
					// en global (todos los almacenes)
					acum_cantidad = 0;

					// acum_costo se usa para en cada registro saber
					// la sumatoria del costo acumulado del último producto-presentación
					// en global (todos los almacenes)
					acum_costo = 0;

					// acum_cantvta se usa para en cada registro saber
					// la sumatoria de la cantidad de ventas del último producto-presentación
					acum_cantvta = 0;

					// acum_costovta se usa para en cada registro saber
					// la sumatorio del costo acumulado de ventas del último producto-presentación
					acum_costovta = 0;

					// Costo promedio hasta el último producto-presentacion
					costoprom = 0;

					// Total de ventas
					totalventas = 0;

					// precio sin impuestos
					preciosimp = 0;

					fecha_actual = "";
					aux_fecha_actual = "";
					acum_fechas = 0;
					acum_costo_fechas = 0;

					// Ciclo para calcular los costos.
					i = 0;
					do {
						hay_pendientes = iterador->IrRegistroPendiente();
						estado_iteracion = iterador->ObtieneEstadoIteracion();

						// Si i está dentro del rango válido nos posicionamos en el registro(i)
						// y obtenemos el producto y presentación de dicho registro
						if (hay_pendientes) {
							producto_actual =
								resp_mov->ObtienePunteroDatoEnIndice
								(indice_producto);
							present_actual =
								resp_mov->ObtienePunteroDatoEnIndice
								(indice_present);
							aux_fecha_actual =
								mFg.StrToMySqlDate
								(resp_mov->ObtienePunteroDatoEnIndice
								(indice_fecha));
						}

						// Si ya pasamos el ultimo registro o el producto-presentacion es diferente
						// entonces manda los datos acumulados al cliente.
						if ((!hay_pendientes) ||
							(producto_actual != producto_anterior ||
							present_actual != present_anterior)) {
							// Si no es el primer registro
							if (i > 0 && !es_desglosado) {
								if (!registra_costovta) {
									// Entonces manda los datos al cliente
									nombre_producto =
										(char *)lista_productos->Objects
										[lista_productos->IndexOf
										(producto_anterior)];
									aux = mFg.AgregaStringABuffer
										(nombre_producto, aux);
									aux = mFg.AgregaStringABuffer
										(present_anterior, aux);
									aux = mFg.AgregaStringABuffer
										(producto_anterior, aux);

									aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_cantvta*-1), aux);
									aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_costovta*-1), aux);

									if (!mFg.EsCero(acum_fechas))
										aux = mFg.AgregaStringABuffer
										(FloatToStr
										(acum_costo_fechas / acum_fechas), aux);
									else
										aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_costo), aux);
									aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_costo), aux);
									aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_cantidad), aux);

									if (diferencias == "1") {
										aux = mFg.AgregaStringABuffer
										(FloatToStr(totalventas), aux);
										aux = mFg.AgregaStringABuffer
										(FloatToStr(preciosimp), aux);
									}
								}

								fecha_actual = "";
								aux_fecha_actual = "";
								acum_fechas = 0;
								acum_costo_fechas = 0;

								(*num_filas)++;
							}
						}

						if (hay_pendientes) {
							if (es_desglosado || registra_costovta) {

								referencia_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_referencia);
							}

							tipo_actual = resp_mov->ObtienePunteroDatoEnIndice(indice_tipo);
							clasif_actual =
								*(resp_mov->ObtienePunteroDatoEnIndice
								(indice_clasif));
							// Solo se ocupa el primer caracter de la clasificación (siempre es solo un caracter)
							cantvta_actual =
								strtod(resp_mov->ObtienePunteroDatoEnIndice
								(indice_cantvta), NULL);
							if (diferencias == "1") {
								totalventas =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_suma), NULL);
								preciosimp =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_subtotventa), NULL);
							}
							if (clasif_actual == 'A') {
								cantidad_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL);
								costounit_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_costounit), NULL);
								costotot_actual =
									cantidad_actual * costounit_actual;
							}
							if (clasif_actual == 'B') {
								cantidad_actual = 0;
								costounit_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_costounit), NULL);
								costotot_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL) * costounit_actual;
							}
							if (clasif_actual == 'C') {
								cantidad_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL);
								costounit_actual = costoprom;
								costotot_actual =
									cantidad_actual * costounit_actual;
							}

							// Si es un producto-presentacion DIFERENTE al anterior
							if ((producto_actual != producto_anterior ||
								present_actual != present_anterior)) {

								// Asigna los datos del registro actual a las variables
								// usadas para registro anterior, esto en preparación
								// para el siguiente ciclo.
								producto_anterior = producto_actual;
								present_anterior = present_actual;

								if(tipo_actual == "BA")
									costoprom = costounit_actual;
								 else
									costoprom = 0;

								acum_cantidad = 0;
								acum_costo = 0;
								acum_cantvta = 0;
								acum_costovta = 0;

								iterador->IniciaOtroProductoPresentacion();
							}

							// si alguno de los acumulados podría dar negativo entonces
							// se ignora el registro actual, pero se acumula para posterior
							// aplicación cuando haya el positivo suficiente
							if ((acum_cantidad + cantidad_actual) <
								0 || (acum_costo + costotot_actual) < 0) {
								// Si se generó un negativo

								// Si se no terminaron los registros y no esta en modo
								// de  forzar pendientes entonces se marca como no aplicado
								// para que se almacene en los pendientes.
								if (iterador->
									ObtieneEstaTerminadaIteracionNormal()
									== false &&
									iterador->ObtieneForzarPendientes()
									== false) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								}
								else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}
							else {
								// No se generó un negativo

								// Si es iteracion normal y además
								// mov actual disminuye costo o existencias y
								// además hay pendientes de aplicar ENTONCES se les da prioridad
								// a los pendientes y el mov actual se pone como no
								// aplicado hasta el final de las lista de pendientes.
								if (estado_iteracion == 0 && (cantidad_actual <
									0 || costotot_actual < 0)
									&& iterador->ObtieneNumRealNoAplicados
									() > 0) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								}
								else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}

							// Totaliza tomando en cuenta el registro actual
							if (aplicar_costo) {
								acum_cantidad = acum_cantidad + cantidad_actual;
								acum_costo = acum_costo + costotot_actual;
								acum_cantvta = acum_cantvta + cantvta_actual;
								acum_costovta =
									acum_costovta +
									(cantvta_actual * costoprom);
								if (!mFg.EsCero(acum_cantidad))
									costoprom = acum_costo / acum_cantidad;
								// else costoprom=0;

								if (mFg.MySqlDateToTDate(fecha_inicial.c_str())
									<= mFg.MySqlDateToTDate
									(aux_fecha_actual.c_str())
									&& mFg.MySqlDateToTDate(fecha_final.c_str())
									>= mFg.MySqlDateToTDate
									(aux_fecha_actual.c_str())) {
									acum_fechas++;
									acum_costo_fechas += acum_costo;
								}

								if (registra_costovta) {
									// Guardar en archivo temporal
									if (!mFg.EsCero(cantvta_actual)) {
										cadena =
										referencia_actual + "\t" + tipo_actual +
										"\t" + producto_actual + "\t" +
										present_actual + "\t" +
										AnsiString(cantvta_actual) + "\t" +
										mFg.FormateaCantidad
										((cantvta_actual * costoprom), 6,
										false) + "\n";
										FStream1->Write(cadena.c_str(),
										cadena.Length());
									}
								}

							}

							// Se mandan datos desglosados al cliente cuando asi se determine
							if (es_desglosado) {
								aux = mFg.AgregaStringABuffer
									(mFg.IntToAnsiString(aplicar_costo), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.IntToAnsiString
									(estado_iteracion), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.IntToAnsiString
									(iterador->ObtieneNumRegistroActivo()
									), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.IntToAnsiString
									(iterador->ObtieneNumRealNoAplicados
									()), aux);
								aux = mFg.AgregaStringABuffer
									(resp_mov->ObtienePunteroDatoEnIndice
									(indice_fecha), aux);
								aux = mFg.AgregaStringABuffer
									(resp_mov->ObtienePunteroDatoEnIndice
									(indice_referencia), aux);
								aux = mFg.AgregaStringABuffer(tipo_actual, aux);
								clasif_actual_str[0] = clasif_actual;
								clasif_actual_str[1] = 0;
								// Convierte la clasificación a una cadena con terminador nulo
								aux = mFg.AgregaStringABuffer
									(clasif_actual_str, aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(cantidad_actual, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(cantidad_actual, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(costotot_actual, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(costounit_actual, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_cantidad, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_costo, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(costoprom, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_cantidad, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_costo, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_cantvta*-1, 3,
									false), aux);
								aux = mFg.AgregaStringABuffer
									(mFg.FormateaCantidad(acum_costovta*-1, 3,
									false), aux);

								(*num_filas)++;
							}
						}

						i++;
					}
					while (hay_pendientes);

				}
				else
					throw Exception
						("Error en select precalculocostos%s de ID_EJE_REPCOSTOVENTAS");
			}
			__finally {
				if (iterador != NULL) {
					delete iterador;
					iterador = NULL;
				}
				if (resp_mov != NULL) {
					delete resp_mov;
					resp_mov = NULL;
				}
			}
		}

		if (registra_costovta) {

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE precalculocostosventadet (referencia, tipo, producto, present, cantidad, costovta) ",
				archivo_temp_vtas);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));
		}

		// **********************************************************************************************

		// Establece el tamaño de la respuesta.
		*tam_respuesta = (aux - respuesta);
		Respuesta->TamBufferResultado = Respuesta->TamBufferResultado +
			*tam_respuesta; // Calcula tamaño total de buffer
		Respuesta->PosBufferResultado = 0;
		// Los resultados al cliente serán a partir del inicio del buffer.
	}
	__finally {
		if (FStream1 != NULL) {
			delete FStream1;
			mServidorVioleta->BorraArchivoTemp(archivo_temp_vtas);
		}

		if (archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}

		if (resp_present_en_venta != NULL)
			delete resp_present_en_venta;
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_sucursal != NULL)
			delete resp_sucursal;
		if (resp_mov != NULL)
			delete resp_mov;
		if (resp_prod != NULL)
			delete resp_prod;
		if (resp_bloques != NULL)
			delete resp_bloques;
		if (resp_hay_ventas != NULL)
			delete resp_hay_ventas;
		if (resp_dev_de_venta != NULL)
			delete resp_dev_de_venta;
		if (buffer_resp_mov != NULL)
			delete buffer_resp_mov;
		delete lista_productos;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOVENTAS_EXT
void ServidorReportes::EjecutaRepCostoVentasExt(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, acredito, sucursal, almacen, clasif1,
		clasif2, clasif3;
	AnsiString marca, prov_predeterminado, producto, presentacion, desglosado,
		incluir_devoluciones;
	AnsiString tipofacturacion, cliente, vendedor, sector, localidad, venta,
		diferencias, prov_compras;
	AnsiString registra_costovta, meses, porcentaje, tipos_precio;

	AnsiString condicion_producto_ventas, condicion_producto_costos;
	AnsiString condicion_tipofactura_ventas, condicion_tipofactura_costos;
	AnsiString condicion_credito_ventas, condicion_credito_costos;
	AnsiString condicion_sucursal;
	AnsiString condicion_clasif1;
	AnsiString condicion_clasif2;
	AnsiString condicion_clasif3;
	AnsiString condicion_marca;
	AnsiString condicion_proveedor_ventas, condicion_proveedor_costos;
	AnsiString condicion_cliente_ventas, condicion_cliente_costos;
	AnsiString condicion_vendedor_ventas, condicion_vendedor_costos;
	AnsiString condicion_sector_ventas, condicion_sector_costos;
	AnsiString condicion_localidad_ventas, condicion_localidad_costos;
	AnsiString condicion_venta_ventas, condicion_venta_costos;
	AnsiString archivo_temp1 = "", archivo_temp2 = "";

	AnsiString condicion_ventas;

	AnsiString condicion_prov_historico_ventas, condicion_prov_historico_costos;
	AnsiString condicion_prov_historico_ventas2,
		condicion_prov_historico_costos2;
	AnsiString condicion_meses;
	AnsiString condicion_porcentaje;

	AnsiString segmento, fabricante;
	AnsiString condicion_segmento = " ", condicion_fabricante = " ";
	AnsiString join_presentacion1 = " ";

	AnsiString parteRelacionada;
	AnsiString condicion_parteRelacionada = " ";
	AnsiString inner_clientes_parteRelacionada_ventas = " ",
		inner_clientes_parteRelacionada_costos = " ",
		inner_clientes_parteRelacionada_ventas2 = " ";

	AnsiString supervisado, campo_supervisado = " ",
		condicion_empleadosupervisor = " ";
	AnsiString condicion_supervisado = " ", condicion_supervisado2 = " ",
		condicion_supervisado3 = " ";
	AnsiString join_supervisado = " ", join_supervisado2 = " ",
		join_supervisado3 = " ", join_supervisado4 = " ";
    AnsiString join_tipos_precio = " ";

	AnsiString origenVta;
	AnsiString condicion_origenVta = " ", condicion_origenVta_costos = " ";
	AnsiString condicion_tipos_precio= " ";
	AnsiString idempresa;

	AnsiString inner_ventas_nc = " ";
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[20];
	AnsiString fecha_limite_devoluciones, incluir_devoluciones_cart,
		condicion_notas_dev = " ", joinventas_ncredito = " ",
		condicion_notas_dev2 = " ";

	AnsiString select_auxventascostonc = " ", join_pror_tp = " ", select_auxventascostonc_2 = " ", condicion_producto = " ";

	try {
		fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		prov_predeterminado = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		sector = mFg.ExtraeStringDeBuffer(&parametros);
		localidad = mFg.ExtraeStringDeBuffer(&parametros);
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		prov_compras = mFg.ExtraeStringDeBuffer(&parametros);
		meses = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		porcentaje = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		parteRelacionada = mFg.ExtraeStringDeBuffer(&parametros);
		supervisado = mFg.ExtraeStringDeBuffer(&parametros);
		origenVta = mFg.ExtraeStringDeBuffer(&parametros);

		incluir_devoluciones_cart = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_limite_devoluciones = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipos_precio = mFg.ExtraeStringDeBuffer(&parametros);

		idempresa = FormServidor->ObtieneClaveEmpresa();


		instruccion.sprintf("SET SESSION tx_isolation='READ-COMMITTED' ");
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta,  MySQL, instruccion.c_str()))
			throw (Exception("Error en query EjecutaSelectSqlNulo"));

		/////Inicializamos la variable fecha inicial
		instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final de notas de crédito
		if (incluir_devoluciones_cart == "1") {
			instruccion.sprintf("SET @fechanotasdev = '%s'",
				fecha_limite_devoluciones);
			instrucciones[num_instrucciones++] = instruccion;
		}

		if (acredito != " ") {
			condicion_credito_ventas.sprintf(" AND v.acredito = %s ", acredito);
			condicion_credito_costos.sprintf(" AND nc.tipo = %s ", acredito);
		}
		else {
			condicion_credito_ventas = " ";
			condicion_credito_costos = " ";
		}

		if (sucursal != " " && sucursal != "' '") {
			condicion_sucursal.sprintf(" AND suc.sucursal IN (%s) ", sucursal);
		}
		else {
			condicion_sucursal = " ";
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" AND prod.clasif1 = '%s' ", clasif1);
		}
		else {
			condicion_clasif1 = " ";
		}

		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" AND prod.clasif2 = '%s' ", clasif2);
		}
		else {
			condicion_clasif2 = " ";
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" AND prod.clasif3 = '%s' ", clasif3);
		}
		else {
			condicion_clasif3 = " ";
		}

		if (marca != " ") {
			condicion_marca.sprintf(" AND prod.marca = '%s' ", marca);
		}
		else {
			condicion_marca = " ";
		}

		if (prov_predeterminado != " ") {
			AnsiString condicion_prov_principal, condicion_producto = " ";

			condicion_prov_principal.sprintf(" AND ap.proveedor = '%s' ",
				prov_predeterminado);

			if (producto != " ")
				condicion_producto.sprintf(" AND ap.producto = '%s' ",
				producto);

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1,
				Respuesta->Id);

			// guarda productos, presentacion de un correspondiente proveedor princial, sucursal, etc
			instruccion = "CREATE TEMPORARY TABLE artprovprinaux (producto VARCHAR(8), present VARCHAR(255),\
				 INDEX(producto, present)) ENGINE = INNODB;";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf(" \
				SELECT ap.producto, ap.present \
				FROM articulosped ap \
				WHERE 1 %s %s  \
				GROUP BY ap.producto, ap.present \
				INTO OUTFILE '%s' ", condicion_prov_principal,
				condicion_producto, archivo_temp1);

			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE artprovprinaux (producto, present) ",
				archivo_temp1);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			condicion_proveedor_ventas =
				" INNER JOIN artprovprinaux ap ON a.producto = ap.producto AND a.present = ap.present ";

			condicion_proveedor_costos =
				" INNER JOIN artprovprinaux ap ON pccd.producto = ap.producto AND pccd.present = ap.present ";

		}
		else {
			condicion_proveedor_ventas = " ";
			condicion_proveedor_costos = " ";
		}

		if (producto != " ") {
			condicion_producto_ventas.sprintf(" a.producto='%s' AND ",
			producto);
			condicion_producto_costos.sprintf(" AND pccd.producto='%s' ",
				producto);
			condicion_producto.sprintf(" AND a.producto='%s' ",producto);
		}
		else {
			condicion_producto_ventas = " ";
			condicion_producto_costos = " ";
			condicion_producto = " ";
		}

		if (tipofacturacion != " ") {
			condicion_tipofactura_ventas.sprintf(" AND v.tipofac='%s' ",
				tipofacturacion);
			inner_ventas_nc =
				" INNER JOIN ventas v ON nc.venta = v.referencia ";
			condicion_tipofactura_costos.sprintf(" AND v.tipofac='%s' ",
				tipofacturacion);
		}
		else {
			condicion_tipofactura_ventas = " ";
			condicion_tipofactura_costos = " ";
		}

		if (cliente != " ") {
			condicion_cliente_ventas.sprintf(" AND v.cliente='%s' ", cliente);
			inner_ventas_nc =
				" INNER JOIN ventas v ON nc.venta = v.referencia ";
			condicion_cliente_costos.sprintf(" AND v.cliente = '%s' ", cliente);
		}
		else {
			condicion_cliente_ventas = " ";
			condicion_cliente_costos = " ";
		}

		if (vendedor != " ") {
			condicion_vendedor_ventas.sprintf(" AND v.vendedor='%s' ",
			vendedor);
			inner_ventas_nc =
				" INNER JOIN ventas v ON nc.venta = v.referencia ";
			condicion_vendedor_costos.sprintf(" AND v.vendedor = '%s' ",
				vendedor);
		}
		else {
			condicion_vendedor_ventas = " ";
			condicion_vendedor_costos = " ";
		}

		if (sector != " ") {
			condicion_sector_ventas.sprintf(" INNER JOIN clientes cli ON v.cliente = cli.cliente			\
											  INNER JOIN colonias col ON cli.colonia = col.colonia AND col.sector='%s' "
				, sector);
			inner_ventas_nc =
				" INNER JOIN ventas v ON nc.venta = v.referencia ";
			condicion_sector_costos.sprintf(" INNER JOIN clientes cli ON v.cliente = cli.cliente			\
											  INNER JOIN colonias col ON cli.colonia = col.colonia AND col.sector='%s' "
				, sector);
		}
		else {
			condicion_sector_ventas = " ";
			condicion_sector_costos = " ";
		}

		if (localidad != " ") {
			condicion_localidad_ventas.sprintf(" AND col.localidad='%s' ",
				localidad);
			condicion_localidad_costos.sprintf(" AND col.localidad='%s' ",
				localidad);
		}
		else {
			condicion_localidad_ventas = " ";
			condicion_localidad_costos = " ";
		}

		if (venta != " ") {
			condicion_venta_ventas.sprintf(" AND v.referencia='%s' ", venta);
			condicion_venta_costos.sprintf(" AND nc.venta='%s' ", venta);
		}
		else {
			condicion_venta_ventas = " ";
			condicion_venta_costos = " ";
		}
		AnsiString inner_ventas = " ";
		if (parteRelacionada != " ") {
			if (sector == " ") {
				inner_clientes_parteRelacionada_ventas.sprintf
					(" INNER JOIN clientes cli ON v.cliente = cli.cliente ");
				inner_ventas_nc =
					" INNER JOIN ventas v ON nc.venta = v.referencia ";
				inner_clientes_parteRelacionada_costos.sprintf
					(" INNER JOIN clientes cli ON v.cliente = cli.cliente ");
			}
			condicion_parteRelacionada.sprintf(" AND cli.esparterelac = %s ",
				parteRelacionada);
		}

		if (prov_compras != " ") {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha_final, meses, fecha_final);
			}
			else {
				condicion_meses = " ";
			}
			/////TABLA TEMPORL PARA EL PROVEEDOR HISTORICO
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present", prov_compras,
				condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			// Crea una copia de la tabla prodpresentprovcompraaux para evitar errores por usar dos veces en el mismo query una tabla temporal (MariaDB 10.1 o menor)
			instruccion =
				"create temporary table prodpresentprovcompra2aux like prodpresentprovcompraaux ";
			mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
			instruccion =
				"insert into prodpresentprovcompra2aux select * from prodpresentprovcompraaux ";
			mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			condicion_prov_historico_ventas.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON a.producto=pppca.producto AND a.present=pppca.present"
				);
			condicion_prov_historico_ventas2.sprintf
				("INNER JOIN prodpresentprovcompra2aux pppca ON a.producto=pppca.producto AND a.present=pppca.present"
				);
			condicion_prov_historico_costos.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pccd.producto=pppca.producto AND pccd.present=pppca.present"
				);
			condicion_prov_historico_costos2.sprintf
				("INNER JOIN prodpresentprovcompra2aux pppca ON pccd.producto=pppca.producto AND pccd.present=pppca.present"
				);

		}
		else {
			condicion_prov_historico_ventas = " ";
			condicion_prov_historico_costos = " ";

			condicion_prov_historico_ventas2 = " ";
			condicion_prov_historico_costos2 = " ";
		}

		if (porcentaje != " ") {
			condicion_porcentaje.sprintf
				(" AND IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0) <= %s ",
				porcentaje);
		}
		else {
			condicion_porcentaje = " ";
		}

		// Usaremos el segmento de presentacion
		if (segmento != " ") {

			condicion_segmento.sprintf(" AND pcb.segmento = '%s' ",
			segmento);
			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=amax.producto AND present.present=amax.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+
				  idempresa;
			// 1 y 4 y 5
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND prod.fabricante = '%s' ",
				fabricante);
		}

		join_supervisado =
			" LEFT JOIN articulossupervisados arts ON arts.producto = auxv.producto AND arts.present = auxv.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado =
			", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado ";

		if (supervisado != " ") {
			condicion_empleadosupervisor.sprintf("  and arts.usuario='%s'   ",
				supervisado);
		}
		else {
			// campo_supervisado = " , ' ' AS supervisado";
			// join_supervisado = " ";
			condicion_empleadosupervisor = " ";
		}

		if (origenVta != " ") {
			condicion_origenVta.sprintf(" AND v.tipoorigen IN (%s) ",
			origenVta);
			inner_ventas_nc =
				" INNER JOIN ventas v ON nc.venta = v.referencia ";
			condicion_origenVta_costos.sprintf(" AND v.tipoorigen IN (%s) ",
				origenVta);
		}

		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "create temporary table auxventasnc \
		(producto varchar(8), present varchar(255), subtotventa decimal(16,4), \
		primary key(producto, present)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		if (incluir_devoluciones_cart == "1") {
			condicion_notas_dev =
				" v.fechavta BETWEEN @fechaini AND @fechafin AND n.fechanot <= @fechanotasdev ";
		}
		else {
			condicion_notas_dev =
				" v.fechavta BETWEEN @fechaini AND @fechafin ";
		}

		if(tipos_precio != " "){

			condicion_tipos_precio.sprintf("AND dv.tipoprec IN (%s)", tipos_precio);

			instruccion = "CREATE TEMPORARY TABLE auxventastotales \
				(referencia VARCHAR(15), producto VARCHAR(8), present VARCHAR(255), subtotal DECIMAL(16,4), \
				PRIMARY KEY(referencia, producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion = "CREATE TEMPORARY TABLE auxventastipo \
				(referencia VARCHAR(15), producto VARCHAR(8), present VARCHAR(13), subtotaltp DECIMAL(16,4), \
				PRIMARY KEY(referencia, producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO auxventastotales (referencia, producto, present, subtotal) \
				SELECT t.referencia, t.producto, t.present, SUM(t.subtotal) \
				FROM( \
				(SELECT v.referencia, a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotal \
				FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN dventas dv ON dv.referencia=v.referencia \
				INNER JOIN articulos a ON a.articulo=dv.articulo \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
				%s \
				%s \
				%s \
				%s \
				%s \
				WHERE v.fechavta>=@fechaini AND v.fechavta<=@fechafin \
				%s AND v.cancelado=0 AND suc.idempresa = %s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				GROUP BY v.referencia, a.producto, a.present) \
				UNION ALL \
				(SELECT n.venta AS referencia, a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotal \
				FROM notascredcli n \
				INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
				INNER JOIN dventas dv ON dv.referencia =n.venta AND dv.articulo=d.articulo \
				INNER JOIN articulos a ON d.articulo=a.articulo  \
				INNER JOIN ventas v ON n.venta = v.referencia  \
				INNER JOIN terminales t ON v.terminal=t.terminal  \
				INNER JOIN secciones sec ON t.seccion=sec.seccion  \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
				%s \
				%s \
				%s \
				%s \
				%s \
				WHERE n.cancelado=0  \
				%s \
				AND v.fechavta BETWEEN @fechaini AND @fechafin AND n.fechanot <= @fechanotasdev  \
				AND suc.idempresa = %s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				GROUP BY n.venta, a.producto, a.present) \
				) t  \
				GROUP BY t.referencia, t.producto, t.present",
				condicion_proveedor_ventas, condicion_sector_ventas, condicion_localidad_ventas,
				condicion_prov_historico_ventas, inner_clientes_parteRelacionada_ventas,

				condicion_sucursal, idempresa,

				condicion_producto, condicion_credito_ventas, condicion_cliente_ventas, condicion_vendedor_ventas,
				condicion_venta_ventas, condicion_tipofactura_ventas, condicion_parteRelacionada, condicion_origenVta,

                condicion_proveedor_ventas, condicion_sector_ventas, condicion_localidad_ventas,
				condicion_prov_historico_ventas, inner_clientes_parteRelacionada_ventas,

				condicion_sucursal, idempresa,

				condicion_producto, condicion_credito_ventas, condicion_cliente_ventas, condicion_vendedor_ventas,
				condicion_venta_ventas, condicion_tipofactura_ventas, condicion_parteRelacionada, condicion_origenVta);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO auxventastipo (referencia, producto, present, subtotaltp) \
				SELECT t.referencia, t.producto, t.present, SUM(t.subtotaltp) \
				FROM (  \
				(SELECT v.referencia, a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotaltp  \
				FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN dventas dv ON dv.referencia=v.referencia  \
				INNER JOIN articulos a ON a.articulo=dv.articulo  \
				INNER JOIN terminales t ON v.terminal=t.terminal  \
				INNER JOIN secciones sec ON t.seccion=sec.seccion  \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
				%s \
				%s \
				%s \
				%s \
				%s \
				WHERE v.fechavta>=@fechaini AND v.fechavta<=@fechafin AND v.cancelado=0  \
				%s AND suc.idempresa = %s %s  \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				GROUP BY v.referencia, a.producto, a.present ) \
				UNION ALL  \
				(SELECT n.venta AS referencia, a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotaltp  \
				FROM notascredcli n  \
				INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
				INNER JOIN dventas dv ON dv.referencia =n.venta AND dv.articulo=d.articulo \
				INNER JOIN articulos a ON d.articulo=a.articulo \
				INNER JOIN ventas v ON n.venta = v.referencia \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
				%s \
				%s \
				%s \
				%s \
				%s \
				WHERE n.cancelado=0 AND v.fechavta BETWEEN @fechaini AND @fechafin AND n.fechanot <= @fechanotasdev \
				%s AND suc.idempresa = %s %s  \
                %s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s \
				GROUP BY n.venta, a.producto, a.present) \
				) t \
				GROUP BY t.referencia, t.producto, t.present",
				condicion_proveedor_ventas, condicion_sector_ventas, condicion_localidad_ventas,
				condicion_prov_historico_ventas, inner_clientes_parteRelacionada_ventas,

				condicion_sucursal, idempresa, condicion_tipos_precio,

				condicion_producto, condicion_credito_ventas, condicion_cliente_ventas, condicion_vendedor_ventas,
				condicion_venta_ventas, condicion_tipofactura_ventas, condicion_parteRelacionada, condicion_origenVta,

                condicion_proveedor_ventas, condicion_sector_ventas, condicion_localidad_ventas,
				condicion_prov_historico_ventas, inner_clientes_parteRelacionada_ventas,

				condicion_sucursal, idempresa, condicion_tipos_precio,

                condicion_producto, condicion_credito_ventas, condicion_cliente_ventas, condicion_vendedor_ventas,
				condicion_venta_ventas, condicion_tipofactura_ventas, condicion_parteRelacionada, condicion_origenVta);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO auxventasnc (producto, present, subtotventa) \
				SELECT producto, present, SUM(subtotaltp) \
				FROM auxventastipo \
				GROUP BY producto, present");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion = "CREATE TEMPORARY TABLE auxcantidadestipopr (producto VARCHAR(8), present VARCHAR(13), multmin DECIMAL(16,4), \
				PRIMARY KEY(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO auxcantidadestipopr (producto, present, multmin) \
				SELECT t.producto, t.present, SUM(t.multmin) \
				FROM ( \
				(SELECT a.producto, a.present, SUM(dv.cantidad) AS multmin \
				FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN dventas dv ON dv.referencia=v.referencia \
				INNER JOIN articulos a ON a.articulo=dv.articulo \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
				WHERE v.fechavta>=@fechaini AND v.fechavta<=@fechafin \
				AND v.cancelado=0 \
				%s AND suc.idempresa = %s %s  \
				GROUP BY a.producto, a.present) \
				UNION ALL  \
				(SELECT a.producto, a.present, SUM(d.cantidad*-1) AS multmin  \
				FROM notascredcli n \
				INNER JOIN dnotascredcli d ON n.referencia=d.referencia  \
				INNER JOIN dventas dv ON dv.referencia =n.venta AND dv.articulo=d.articulo  \
				INNER JOIN articulos a ON d.articulo=a.articulo \
				INNER JOIN ventas v ON n.venta = v.referencia \
				INNER JOIN terminales t ON v.terminal=t.terminal  \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
				WHERE n.cancelado=0 AND v.fechavta BETWEEN @fechaini AND @fechafin AND n.fechanot <= @fechanotasdev \
				%s \
				AND suc.idempresa = %s \
				%s \
				GROUP BY a.producto, a.present ) \
				) t \
				GROUP BY t.producto, t.present", condicion_sucursal, idempresa, condicion_tipos_precio,
				condicion_sucursal, idempresa, condicion_tipos_precio);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion = "CREATE TEMPORARY TABLE auxfactorprorrateo (referencia VARCHAR(15), producto VARCHAR(8), present VARCHAR(13), factor_prorrateo DECIMAL(10,6), \
				PRIMARY KEY(referencia, producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO auxfactorprorrateo (referencia, producto, present, factor_prorrateo) \
				SELECT avt.referencia, avt.producto, avt.present, \
				CASE WHEN IFNULL(avt.subtotal,0) = 0 THEN 0 ELSE IFNULL(avtp.subtotaltp,0) / avt.subtotal END AS factor_prorrateo  \
				FROM auxventastotales avt  \
				LEFT JOIN auxventastipo avtp ON avt.referencia = avtp.referencia AND avt.producto = avtp.producto AND avt.present = avtp.present");
			instrucciones[num_instrucciones++] = instruccion;

			select_auxventascostonc.sprintf("SELECT pccd.producto, pccd.present, IFNULL(ctp.multmin, 0) AS multmin, \
				SUM(pccd.costovta * IFNULL(afp.factor_prorrateo, 0) * -1) AS costo");
			select_auxventascostonc_2.sprintf("SELECT pccd.producto, pccd.present, IFNULL(ctp.multmin, 0) AS multmin, \
				SUM(pccd.costovta * IFNULL(afp.factor_prorrateo, 0) * -1) AS costo");

			join_pror_tp.sprintf("LEFT JOIN auxfactorprorrateo afp ON pccd.referencia = afp.referencia \
					AND pccd.producto = afp.producto AND pccd.present = afp.present  \
				LEFT JOIN auxcantidadestipopr ctp ON afp.producto = ctp.producto AND afp.present = ctp.present \
					AND pccd.producto = ctp.producto AND pccd.present = ctp.present");


		} else{
			select_auxventascostonc.sprintf("SELECT pccd.producto, pccd.present, SUM(pccd.cantidad*-1) AS multmin, \
				SUM(pccd.costovta*-1) AS costo ");

			select_auxventascostonc_2.sprintf("SELECT pccd.producto, pccd.present, SUM(pccd.cantidad*-1) AS multmin, \
				SUM(pccd.costovta*-1) AS costo ");


            instruccion.sprintf("INSERT INTO auxventasnc (producto, present, subtotventa) \
			SELECT \
				t.producto, t.present, SUM(t.subtotventa) \
			FROM \
				( \
					( \
						SELECT \
							a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotventa \
						FROM \
							ventas v FORCE INDEX(fechavta) \
							INNER JOIN dventas dv ON dv.referencia=v.referencia \
							INNER JOIN articulos a ON a.articulo=dv.articulo \
							INNER JOIN terminales t ON v.terminal=t.terminal \
							INNER JOIN secciones sec ON t.seccion=sec.seccion \
							INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
							%s \
							%s \
							%s \
							%s \
							%s \
						WHERE \
							%s \
							v.fechavta>=@fechaini \
							AND v.fechavta<=@fechafin \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							AND v.cancelado=0 \
							AND suc.idempresa = %s \
						GROUP BY \
							a.producto, a.present \
					) \
				UNION ALL \
					( \
						SELECT \
							a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotventa \
						FROM \
							notascredcli n INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
							INNER JOIN dventas dv ON dv.referencia  =n.venta AND dv.articulo=d.articulo \
							INNER JOIN articulos a ON d.articulo=a.articulo \
							INNER JOIN ventas v ON n.venta = v.referencia \
							INNER JOIN terminales t ON v.terminal=t.terminal \
							INNER JOIN secciones sec ON t.seccion=sec.seccion \
							INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
							%s \
							%s \
							%s \
							%s \
							%s \
						WHERE \
							%s \
							n.cancelado=0 \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							%s \
							AND %s \
							AND suc.idempresa = %s \
						GROUP BY \
							a.producto, a.present \
					) \
				) t GROUP BY t.producto, t.present", condicion_proveedor_ventas,
				condicion_sector_ventas, condicion_localidad_ventas,
				condicion_prov_historico_ventas,
				inner_clientes_parteRelacionada_ventas,

				condicion_producto_ventas, condicion_credito_ventas,
				condicion_sucursal, condicion_cliente_ventas,
				condicion_vendedor_ventas, condicion_venta_ventas,
				condicion_tipofactura_ventas, condicion_parteRelacionada,
				condicion_origenVta, idempresa,

				condicion_proveedor_ventas, condicion_sector_ventas,
				condicion_localidad_ventas, condicion_prov_historico_ventas2,
				inner_clientes_parteRelacionada_ventas,

				condicion_producto_ventas, condicion_credito_ventas,
				condicion_sucursal, condicion_cliente_ventas,
				condicion_vendedor_ventas, condicion_venta_ventas,
				condicion_tipofactura_ventas, condicion_parteRelacionada,
				condicion_origenVta, condicion_notas_dev, idempresa);
			instrucciones[num_instrucciones++] = instruccion;
		}

		/////Tabla temporal, la cual contendrá los valores de los costos
		instruccion = "create temporary table auxventascostonc \
		( producto VARCHAR(8), present varchar(255), multmin DECIMAL(16,4), costo decimal(16,4), \
		primary key(producto, present)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		joinventas_ncredito = " INNER JOIN ventas v ON nc.venta=v.referencia ";
		if (incluir_devoluciones_cart == "1") {
			condicion_notas_dev2 = "  \
				 v.fechavta>=@fechaini AND v.fechavta<=@fechafin AND \
				nc.fechanot <= @fechanotasdev ";
		} else {
			condicion_notas_dev2 =
				" v.fechavta BETWEEN @fechaini AND @fechafin ";
		}
		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO  auxventascostonc (producto, present, multmin, costo) \
		SELECT \
			t.producto, t.present, SUM(t.multmin), SUM(t.costo) AS costo \
		FROM \
			( \
				( \
					%s \
					FROM ventas v \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia AND pccd.tipo = 'VE' \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					WHERE \
					v.fechavta BETWEEN @fechaini AND @fechafin \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					AND v.cancelado = 0 \
					AND suc.idempresa = %s \
					GROUP BY pccd.producto, pccd.present \
				) \																															\
				UNION ALL \
				( \
					%s \
					FROM notascredcli nc %s \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = nc.referencia AND pccd.tipo = 'DV' \
					INNER JOIN terminales t ON nc.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
					%s %s %s \
					%s \
					%s \
                    %s \
					WHERE \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					%s \
					AND nc.cancelado = 0 \
					AND suc.idempresa = %s \
					GROUP BY pccd.producto, pccd.present \
				) \
			) t GROUP BY t.producto, t.present",
			select_auxventascostonc,

			condicion_proveedor_costos,
			condicion_sector_ventas, condicion_localidad_ventas,
			condicion_prov_historico_costos,
			inner_clientes_parteRelacionada_ventas,

			join_pror_tp,

			condicion_producto_costos, condicion_credito_ventas,
			condicion_sucursal, condicion_cliente_ventas,
			condicion_vendedor_ventas, condicion_venta_ventas,
			condicion_tipofactura_ventas, condicion_parteRelacionada,
			condicion_origenVta, idempresa,

			select_auxventascostonc_2,

			joinventas_ncredito, condicion_proveedor_costos,
			condicion_sector_costos, inner_clientes_parteRelacionada_costos,
			condicion_prov_historico_costos2,

			join_pror_tp,

			condicion_localidad_costos,
			condicion_notas_dev2, condicion_producto_costos,
			condicion_credito_costos, condicion_sucursal,
			condicion_venta_costos, condicion_parteRelacionada,
			condicion_tipofactura_costos, condicion_cliente_costos,
			condicion_vendedor_costos, condicion_origenVta_costos, idempresa);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// Resultado final
			instruccion.sprintf("SELECT                                                                                                 \
			auxvnc.multmin AS multmen,		                                                                                  			\
			TRUNCATE(IFNULL(auxvnc.multmin/pmm.maxfactor,0),0) AS cantmayor,                                                            \
			IFNULL(MOD(auxvnc.multmin,pmm.maxfactor),0) AS cantunidad,                                                                  \
			pmm.maxfactor,                                                                                                  			\
			pmm.maxmult AS maxmult,                                                                                         			\
			pmm.minmult AS unidad,                                                                                          			\
			amax.articulo AS clavemax,                                                                                      			\                                                                                                  			\
			auxv.producto,                                                                                                              \
			prod.nombre,                                                                                                    			\
			auxv.present,                                                                                                   			\
			IFNULL(auxvnc.costo,0) AS costo,                                                                                			\
			auxv.subtotventa AS vsimp,                                             							   							\
			(auxv.subtotventa-IFNULL(auxvnc.costo,0)) AS utilidad,                                                          			\
			if(abs(IFNULL(auxvnc.costo,0))<0.01, 9999.99, IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0)) AS porcutilidad   \
			%s \
			FROM auxventasnc auxv                                                                                           			\
			INNER JOIN productos prod ON auxv.producto = prod.producto                                                    				\
			INNER JOIN presentacionesminmax pmm ON auxv.producto = pmm.producto AND auxv.present = pmm.present          				\
			INNER JOIN articulos amax ON pmm.producto = amax.producto AND pmm.maxmult = amax.multiplo AND pmm.present = amax.present	\
			LEFT JOIN auxventascostonc auxvnc ON auxv.producto = auxvnc.producto AND auxv.present = auxvnc.present                      \
			%s %s \
			WHERE 1 %s %s %s %s %s %s %s %s ", campo_supervisado,
				join_presentacion1, join_supervisado, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_marca,
				condicion_porcentaje, condicion_segmento, condicion_fabricante,
				condicion_empleadosupervisor);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion.sprintf("SET SESSION tx_isolation='REPEATABLE-READ' ");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta,  MySQL, instruccion.c_str()))
				throw (Exception("Error en query EjecutaSelectSqlNulo"));
		}
	}
	__finally {
		if (prov_predeterminado != " " && archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCP_X_SUC
void ServidorReportes::EjecutaRepCodPosXSuc(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString sucursal;
	AnsiString condicion_sucursal = " ";

	sucursal = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND e.sucursal = '%s' ", sucursal);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	// Resultado final
	instruccion.sprintf("SELECT e.sucursal, s.nombre, e.cubrecodigop  \
	FROM ecommercesuccp e                                 \
	INNER JOIN sucursales s ON e.sucursal = s.sucursal    \
	WHERE 1 %s ", condicion_sucursal);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPROVCOMPR
void ServidorReportes::EjecutaRepProvCompras(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, sucursal, meses, prov_compras,
		comprador, prorrateo;
	AnsiString condicion_sucursal, condicion_prov_com, condicion_comprador,
		condicion_prov_compras;
	AnsiString condicion_prov_compras2 = " ", condicion_comprador2 = " ";
	AnsiString achivo_temp1, achivo_temp2, achivo_temp3, achivo_temp4,
		achivo_temp5;
	AnsiString campo_total = " ";
	AnsiString cliente_partesrel;
	AnsiString innerjoin_parterel1 = " ", innerjoin_parterel2 = " ",
		innerjoin_parterel3 = " ", innerjoin_parterel4 = " ";

	AnsiString origenVenta;
	AnsiString condicion_origenVenta = " ";
	AnsiString formasDePago;
	AnsiString inner_join_formasDePago = " ";
	AnsiString inner_join_ventas = " ";

	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[25];

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		meses = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		prov_compras = mFg.ExtraeStringDeBuffer(&parametros);
		comprador = mFg.ExtraeStringDeBuffer(&parametros);
		prorrateo = mFg.ExtraeStringDeBuffer(&parametros);
		cliente_partesrel = mFg.ExtraeStringDeBuffer(&parametros);
		origenVenta = mFg.ExtraeStringDeBuffer(&parametros);
		formasDePago = mFg.ExtraeStringDeBuffer(&parametros);

		/////Inicializamos la variable fecha inicial
		instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @meses = '%s'", meses);
		instrucciones[num_instrucciones++] = instruccion;

		if (sucursal != " ")
			condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
		else
			condicion_sucursal.sprintf(" AND suc.idempresa = %s ", FormServidor->ObtieneClaveEmpresa()) ;


		if (prov_compras != " ") {
			condicion_prov_com.sprintf(" com.proveedor='%s' AND ",
			prov_compras);

			condicion_prov_compras.sprintf(" AND t.claveprov = '%s' ",
				prov_compras);
			condicion_prov_compras2.sprintf(" AND p.proveedor = '%s' ",
				prov_compras);
		}
		else {
			condicion_prov_com = " ";
			condicion_prov_compras = " ";
		}

		if (comprador != " ") {
			condicion_comprador.sprintf(" AND t.comprador = '%s' ", comprador);
			condicion_comprador2.sprintf(" AND e.empleado = '%s' ", comprador);
		}
		else {
			condicion_comprador = " ";
		}

		if (cliente_partesrel != " ") {
			inner_join_ventas = "INNER JOIN ventas v ON v.referencia = n.venta";
			innerjoin_parterel1.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_partesrel);
			innerjoin_parterel2.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_partesrel);
			innerjoin_parterel3.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_partesrel);
			innerjoin_parterel4.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_partesrel);
		}

		if (origenVenta != " ") {
			inner_join_ventas =
				" INNER JOIN ventas v on v.referencia = n.venta ";
			condicion_origenVenta.sprintf(" AND v.tipoorigen IN(%s) ",
				origenVenta);
		}

		if (formasDePago != " ") {
			inner_join_formasDePago.sprintf
				(" INNER JOIN dventasfpago vf ON vf.referencia = v.referencia AND vf.formapag IN (%s) ",
				formasDePago);
		}

		/////TABLA TEMPORL PARA EL PROVEEDOR HISTORICO
		instruccion = "CREATE TEMPORARY TABLE provcompraaux (producto VARCHAR(8), \
		present VARCHAR(255), total DOUBLE, proveedor VARCHAR(11),		\
		PRIMARY KEY (producto, present, proveedor)) 							\
		ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		if (prorrateo != "0") {
			/////TABLA TEMPORL PARA EL LOS TOTALES X PRODUCTO PRESENTACION
			instruccion = "CREATE TEMPORARY TABLE auxprodpresenttot (producto VARCHAR(8), present VARCHAR(255), \
			prodtot DOUBLE, PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			instrucciones[num_instrucciones++] = instruccion;

			achivo_temp3 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT                                          \
			a.producto,                                                          \
			a.present,                                                           \
			SUM(d.cantidad*a.factor) AS prodtot                          	 	 \
			FROM compras com                                                     \
			INNER JOIN dcompras d ON com.referencia=d.referencia                 \
			INNER JOIN articulos a ON d.articulo=a.articulo                      \
			INNER JOIN terminales t ON com.terminal=t.terminal                   \
			INNER JOIN secciones sec ON t.seccion=sec.seccion                    \
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal               \
			WHERE com.cancelado=0 AND com.fechacom                            	 \
			BETWEEN DATE_ADD(@fechafin, INTERVAL - @meses MONTH) AND @fechafin   \
			%s                                                                   \
			GROUP BY a.producto, a.present INTO OUTFILE '%s' ",
				condicion_sucursal, achivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxprodpresenttot (producto,present,prodtot)  ",
				achivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			/////TABLA TEMPORL PARA EL LOS TOTALES DEL PROVEEDOR HISTORICO
			instruccion = "CREATE TEMPORARY TABLE auxcanttot (producto VARCHAR(8),present VARCHAR(255), \
			unitot DOUBLE, proveedor VARCHAR(11), PRIMARY KEY (producto,present,proveedor))   \
			ENGINE = INNODB ";
			instrucciones[num_instrucciones++] = instruccion;

			achivo_temp4 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT                                          \
			a.producto,                                                          \
			a.present,                                                           \
			SUM(d.cantidad*a.factor) AS unitot,                           	 	 \
			com.proveedor                                                        \
			FROM compras com                                                     \
			INNER JOIN dcompras d ON com.referencia=d.referencia                 \
			INNER JOIN articulos a ON d.articulo=a.articulo                      \
			INNER JOIN terminales t ON com.terminal=t.terminal                   \
			INNER JOIN secciones sec ON t.seccion=sec.seccion                    \
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal               \
			WHERE com.cancelado=0 AND com.fechacom                            	 \
			BETWEEN DATE_ADD(@fechafin, INTERVAL - @meses MONTH) AND @fechafin   \
			%s                                                                   \
			GROUP BY a.producto, a.present, com.proveedor INTO OUTFILE '%s' ",
				condicion_sucursal, achivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxcanttot (producto,present,unitot, proveedor)  ",
				achivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;

			achivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT                                                        \
			pt.producto,                                                                       \
			pt.present,                                                                        \
			(ct.unitot/pt.prodtot) AS total,                                                   \
			ct.proveedor                                                                       \
			FROM auxprodpresenttot pt                                                          \
			INNER JOIN auxcanttot ct ON pt.producto = ct.producto AND pt.present = ct.present  \
			GROUP BY pt.producto, pt.present,ct.proveedor INTO OUTFILE '%s' ",
				achivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			campo_total.sprintf(" *pa.total ");

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE provcompraaux (producto,present,total,proveedor)  ",
				achivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

		}
		else {

			achivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT                                          \
			a.producto, a.present, com.proveedor              		 			 \
			FROM compras com                        							 \
			INNER JOIN dcompras dc ON com.referencia=dc.referencia 				 \
			INNER JOIN articulos a ON dc.articulo=a.articulo       				 \
			WHERE %s com.cancelado=0 AND com.fechacom                            \
			BETWEEN DATE_ADD(@fechafin, INTERVAL - @meses MONTH) AND @fechafin   \
			GROUP BY a.producto, a.present, com.proveedor INTO OUTFILE '%s' ",
				condicion_prov_com, achivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE provcompraaux (producto,present,proveedor)  ",
				achivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;
		}

		/////Tabla temporal, la cual contendrá los costos de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventasnc (producto VARCHAR(8), present VARCHAR(255), subtotventa DOUBLE, \
		PRIMARY KEY(producto, present)) Engine = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		/////Se guardan las ventas dentro de la tabla temporal
		instruccion.sprintf("SELECT                                                                             \
			t.producto, t.present, SUM(t.subtotventa)                                   						\
		FROM                                                                                    				\
			(                                                                                   				\
				(                                                                               				\
					SELECT                                                                      				\
						a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotventa                    \
					FROM                                                                        				\
						ventas v FORCE INDEX(fechavta)                                                          \
						INNER JOIN dventas dv ON dv.referencia=v.referencia                                     \
						INNER JOIN articulos a ON a.articulo=dv.articulo                                        \
						INNER JOIN terminales t ON v.terminal=t.terminal                                        \
						INNER JOIN secciones sec ON t.seccion=sec.seccion                       				\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
					WHERE                                                                       				\
						v.fechavta>=@fechaini                                                                   \
						AND v.fechavta<=@fechafin                                                               \
						AND v.cancelado=0                                                                       \
						%s                                                                          			\
						%s                                                                          			\
					GROUP BY                                                                    				\
						a.producto, a.present                                          							\
				)                                                                               				\
			UNION ALL                                                                           				\
				(                                                                               				\
					SELECT                                                                      				\
						a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotventa     					\
					FROM                                                                        				\
						notascredcli n INNER JOIN dnotascredcli d ON n.referencia=d.referencia                  \
						INNER JOIN dventas dv ON dv.referencia  =n.venta AND dv.articulo=d.articulo             \
						INNER JOIN articulos a ON d.articulo=a.articulo                                         \
						INNER JOIN terminales t ON n.terminal=t.terminal                                        \
						INNER JOIN secciones sec ON t.seccion=sec.seccion                     					\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
						%s                                                                                      \
					WHERE                                                                           			\
						n.cancelado=0                                                                           \
						AND n.fechanot BETWEEN @fechaini AND @fechafin                                          \
						%s                                                                          			\
						%s                                                                          			\
					GROUP BY                                                                        			\
						a.producto, a.present                                          							\
				)                                                                                   			\
			) t GROUP BY t.producto, t.present INTO OUTFILE '%s' ",
			innerjoin_parterel1, condicion_sucursal, condicion_origenVenta,

			inner_join_ventas, innerjoin_parterel2, condicion_sucursal,
			condicion_origenVenta, achivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxventasnc (producto, present, subtotventa) ",
			achivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los costos de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventascostonc (producto VARCHAR(8), present VARCHAR(255), costo DOUBLE, \
		PRIMARY KEY(producto, present)) Engine = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		/////Se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("SELECT                                                                             \
			t.producto, t.present, SUM(t.costo)                                   								\
		FROM                                                                                    				\
			(                                                                                   				\
				(                                                                               				\
					SELECT                                                                      				\
						pccd.producto, pccd.present, SUM(pccd.costovta*-1) AS costo    							\
					FROM                                                                        				\
						ventas v FORCE INDEX(fechavta)                                          				\
						INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia 				\
						AND pccd.tipo = 'VE'  																	\
						INNER JOIN terminales t ON v.terminal=t.terminal                        				\
						INNER JOIN secciones sec ON t.seccion=sec.seccion                       				\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
					WHERE                                                                       				\
						v.fechavta>=@fechaini                                               					\
						AND v.fechavta<=@fechafin                                               				\
						%s                                                                          			\
						%s                                                                          			\
						AND v.cancelado=0                                                       				\
					GROUP BY                                                                    				\
						pccd.producto, pccd.present                                          					\
				)                                                                               				\
			UNION ALL                                                                           				\
				(                                                                               				\
					SELECT                                                                      				\
						pccd.producto, pccd.present, SUM(pccd.costovta*-1) AS costo     						\
					FROM                                                                        				\
						notascredcli nc                                                                         \
						INNER JOIN precalculocostosventadet pccd ON pccd.referencia = nc.referencia 			\
						AND pccd.tipo = 'DV'  																	\
						INNER JOIN terminales t ON nc.terminal=t.terminal                            			\
						INNER JOIN secciones sec ON t.seccion=sec.seccion                           			\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						INNER JOIN ventas v ON nc.venta = v.referencia                          				\
						%s                                                                                      \
					WHERE                                                                           			\
						nc.cancelado=0                                                           				\
						%s                                                                          			\
						%s                                                                          			\
						AND nc.fechanot BETWEEN @fechaini AND @fechafin                              			\
					GROUP BY                                                                        			\
						pccd.producto, pccd.present                                          					\
				)                                                                                   			\
			) t GROUP BY t.producto, t.present INTO OUTFILE '%s' ",
			innerjoin_parterel3, condicion_sucursal, condicion_origenVenta,

			innerjoin_parterel4, condicion_sucursal, condicion_origenVenta,
			achivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxventascostonc (producto, present, costo) ",
			achivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auxventas2nc LIKE auxventasnc ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"CREATE TEMPORARY TABLE provcompra2aux LIKE provcompraaux ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"CREATE TEMPORARY TABLE auxventascosto2nc LIKE auxventascostonc ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auxventas2nc SELECT * FROM auxventasnc ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO provcompra2aux SELECT * FROM provcompraaux ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"INSERT INTO auxventascosto2nc SELECT * FROM auxventascostonc ";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			if (prorrateo != "0") {
				// Resultado final
				instruccion.sprintf("SELECT t.claveprov,                                                     \
				t.razonsocial,                                                                               \
				t.replegal,                                                                                  \
				t.costo,                                                                                     \
				t.subtotventa,                                                                               \
				t.util,                                                                                      \
				t.utilporc,                                                                                  \
				t.comprador,                                                                                 \
				t.nombre                                                                                     \
				FROM (                                                                                       \
						(                                                                                    \
						SELECT                                    			          	 					 \
						p.proveedor AS claveprov,		                               			          	 \
						p.razonsocial,                                                                   	 \
						p.replegal,                                                                      	 \
						(SUM(IFNULL(c.costo,0)%s)) AS costo,                                          		 \
						(SUM(v.subtotventa%s)) AS subtotventa,                                        		 \
						SUM((v.subtotventa%s-IFNULL(c.costo,0)%s)) AS util,                    				 \
						((((SUM(v.subtotventa%s-IFNULL(c.costo,0)%s)*100)/SUM(IFNULL(c.costo,0)%s)))) AS utilporc, \
						IFNULL(e.empleado,'') AS comprador,                                           	  	 \
						IFNULL(CONCAT(e.nombre,' ',e.appat,' ',e.apmat),'') AS nombre                 	  	 \
						FROM auxventasnc v                                            			   	  	 	 \
						INNER JOIN provcompraaux pa ON v.producto = pa.producto AND v.present = pa.present   \
						LEFT JOIN auxventascostonc c ON c.producto = v.producto AND c.present = v.present    \
						LEFT JOIN proveedores p ON pa.proveedor = p.proveedor                                \
						LEFT JOIN empleados e ON p.comprador = e.empleado                                    \
						GROUP BY pa.proveedor                                                                \
						)                                                                                    \
						UNION ALL                                                                            \
						(                                                                                    \
						SELECT                                                                               \
						'INDEFINIDO' AS claveprov,                                                           \
						'INDEFINIDO' AS razonsocial,                                                         \
						'INDEFINIDO' AS replegal,                                                            \
						SUM(IFNULL(c.costo,0)) AS costo,                                                     \
						SUM(v.subtotventa) AS subtotventa,                                                   \
						SUM(v.subtotventa-IFNULL(c.costo,0)) AS util,                                        \
						((SUM(v.subtotventa-IFNULL(c.costo,0))*100)/SUM(IFNULL(c.costo,0))) AS utilporc,     \
						'' AS comprador,                                                                     \
						'' AS nombre                                                                         \
						FROM auxventas2nc v                                                                  \
						LEFT JOIN provcompra2aux pa ON v.producto = pa.producto AND v.present = pa.present   \
						LEFT JOIN auxventascosto2nc c ON c.producto = v.producto AND c.present = v.present   \
						GROUP BY pa.proveedor                                                                \
						)                                                                                    \
					) t                                                                                      \
				WHERE 1 %s %s                                                                                \
				GROUP BY t.claveprov", campo_total, campo_total, campo_total,
					campo_total, campo_total, campo_total, campo_total,
					condicion_prov_compras, condicion_comprador);
			}
			else {
				// Resultado final
				instruccion.sprintf("SELECT                                    			          	 \
				p.proveedor AS claveprov,		                               			          	 \
				p.razonsocial,                                                                   	 \
				p.replegal,                                                                      	 \
				(SUM(IFNULL(c.costo,0))) AS costo,                                          		 \
				(SUM(v.subtotventa)) AS subtotventa,                                        		 \
				SUM((v.subtotventa-IFNULL(c.costo,0))) AS util,                    				 	 \
				((((SUM(v.subtotventa-IFNULL(c.costo,0))*100)/SUM(IFNULL(c.costo,0))))) AS utilporc, \
				IFNULL(e.empleado,'') AS comprador,                                           	  	 \
				IFNULL(CONCAT(e.nombre,' ',e.appat,' ',e.apmat),'') AS nombre                 	  	 \
				FROM auxventasnc v                                            			   	  	 	 \
				INNER JOIN provcompraaux pa ON v.producto = pa.producto AND v.present = pa.present   \
				LEFT JOIN auxventascostonc c ON c.producto = v.producto AND c.present = v.present    \
				LEFT JOIN proveedores p ON pa.proveedor = p.proveedor                                \
				LEFT JOIN empleados e ON p.comprador = e.empleado                                    \
                LEFT JOIN clientes cli ON cli.cliente = p.proveedor                                  \
				%s %s                                                                                \
				GROUP BY pa.proveedor", condicion_prov_compras2,
					condicion_comprador2);
			}

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;

		mServidorVioleta->BorraArchivoTemp(achivo_temp1);
		mServidorVioleta->BorraArchivoTemp(achivo_temp2);
		mServidorVioleta->BorraArchivoTemp(achivo_temp5);
		if (prorrateo != "0") {
			mServidorVioleta->BorraArchivoTemp(achivo_temp4);
			mServidorVioleta->BorraArchivoTemp(achivo_temp3);
		}
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPROVCOMPR_DET
void ServidorReportes::EjecutaRepDetProvCompras(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, sucursal, meses, prov_compras,
		prorrateo, proveedor, cliente_parterel;
	AnsiString condicion_sucursal, condicion_prorrateo;

	AnsiString achivo_temp1, achivo_temp2, achivo_temp3, achivo_temp4,
		achivo_temp5;
	AnsiString campo_total = " ";
	AnsiString innerjoin_parterel1 = " ", innerjoin_parterel2 = " ",
		innerjoin_parterel3 = " ", innerjoin_parterel4 = " ";

	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[25];

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		meses = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		prov_compras = mFg.ExtraeStringDeBuffer(&parametros);
		prorrateo = mFg.ExtraeStringDeBuffer(&parametros);
		cliente_parterel = mFg.ExtraeStringDeBuffer(&parametros);

		/////Inicializamos la variable fecha inicial
		instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @meses = '%s'", meses);
		instrucciones[num_instrucciones++] = instruccion;

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
		}
		else {
			condicion_sucursal.sprintf(" AND suc.idempresa = %s ", FormServidor->ObtieneClaveEmpresa());
		}

		if (prorrateo == "0") {
			condicion_prorrateo.sprintf(" AND com.proveedor = '%s' ",
				prov_compras);
		}
		else {
			condicion_prorrateo = " ";
		}

		if (cliente_parterel != " ") {
			innerjoin_parterel1.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_parterel);
			innerjoin_parterel2.sprintf(" INNER JOIN ventas v ON v.referencia = dv.referencia \
			INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s "
				, cliente_parterel);
			innerjoin_parterel3.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_parterel);
			innerjoin_parterel4.sprintf
				(" INNER JOIN clientes cli ON cli.cliente = v.cliente AND cli.esparterelac=%s ",
				cliente_parterel);
		}

		/////TABLA TEMPORL PARA EL LOS TOTALES X PRODUCTO PRESENTACION
		instruccion = "CREATE TEMPORARY TABLE auxprodpresenttot (producto VARCHAR(8), present VARCHAR(255), \
		prodtot DOUBLE, PRIMARY KEY (producto, present)) ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT                                          \
		a.producto,                                                          \
		a.present,                                                           \
		SUM(d.cantidad*a.factor) AS prodtot                          	 	 \
		FROM compras com                                                     \
		INNER JOIN dcompras d ON com.referencia=d.referencia                 \
		INNER JOIN articulos a ON d.articulo=a.articulo                      \
		INNER JOIN terminales t ON com.terminal=t.terminal                   \
		INNER JOIN secciones sec ON t.seccion=sec.seccion                    \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal               \
		WHERE com.cancelado=0 AND com.fechacom                            	 \
		BETWEEN DATE_ADD(@fechafin, INTERVAL - @meses MONTH) AND @fechafin   \
		%s                                                                   \
		%s                                                                   \
		GROUP BY a.producto, a.present INTO OUTFILE '%s' ", condicion_sucursal,
			condicion_prorrateo, achivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxprodpresenttot (producto,present,prodtot)  ",
			achivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		/////TABLA TEMPORL PARA EL LOS TOTALES DEL PROVEEDOR HISTORICO
		instruccion = "CREATE TEMPORARY TABLE auxcanttot (producto VARCHAR(8),present VARCHAR(255), \
		unitot DOUBLE, proveedor VARCHAR(11), PRIMARY KEY (producto,present,proveedor))   \
		ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT                                          \
		a.producto,                                                          \
		a.present,                                                           \
		SUM(d.cantidad*a.factor) AS unitot,                           	 	 \
		com.proveedor                                                        \
		FROM compras com                                                     \
		INNER JOIN dcompras d ON com.referencia=d.referencia                 \
		INNER JOIN articulos a ON d.articulo=a.articulo                      \
		INNER JOIN terminales t ON com.terminal=t.terminal                   \
		INNER JOIN secciones sec ON t.seccion=sec.seccion                    \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal               \
		WHERE com.cancelado=0 AND com.fechacom                            	 \
		BETWEEN DATE_ADD(@fechafin, INTERVAL - @meses MONTH) AND @fechafin   \
		%s                                                                   \
		%s                                                                   \
		GROUP BY a.producto, a.present, com.proveedor INTO OUTFILE '%s' ",
			condicion_sucursal, condicion_prorrateo, achivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxcanttot (producto,present,unitot, proveedor)  ",
			achivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		/////TABLA TEMPORL PARA EL PROVEEDOR HISTORICO
		instruccion = "CREATE TEMPORARY TABLE provcompraaux (producto VARCHAR(8), \
		present VARCHAR(255), prodtot DOUBLE, unitot DOUBLE, 					\
		total DOUBLE, proveedor VARCHAR(11),									\
		PRIMARY KEY (producto, present, proveedor)) 							\
		ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT                                                        \
		pt.producto,                                                                       \
		pt.present,                                                                        \
		pt.prodtot,                                                                        \
		ct.unitot,                                                                         \
		(ct.unitot/pt.prodtot) AS total,                                                   \
		ct.proveedor                                                                       \
		FROM auxprodpresenttot pt                                                          \
		INNER JOIN auxcanttot ct ON pt.producto = ct.producto AND pt.present = ct.present  \
		GROUP BY pt.producto, pt.present,ct.proveedor INTO OUTFILE '%s' ",
			achivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		campo_total.sprintf(" *pa.total ");

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE provcompraaux (producto,present,prodtot,unitot,total,proveedor)  ",
			achivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los costos de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventasnc (producto VARCHAR(8), present VARCHAR(255), subtotventa DOUBLE, \
		PRIMARY KEY(producto, present)) Engine = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		/////Se guardan las ventas dentro de la tabla temporal
		instruccion.sprintf("SELECT                                                                             \
			t.producto, t.present, SUM(t.subtotventa)                                   						\
		FROM                                                                                    				\
			(                                                                                   				\
				(                                                                               				\
					SELECT                                                                      				\
						a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotventa                    \
					FROM                                                                        				\
						ventas v FORCE INDEX(fechavta)                                                          \
						INNER JOIN dventas dv ON dv.referencia=v.referencia                                     \
						INNER JOIN articulos a ON a.articulo=dv.articulo                                        \
						INNER JOIN terminales t ON v.terminal=t.terminal                                        \
						INNER JOIN secciones sec ON t.seccion=sec.seccion                       				\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
					WHERE                                                                       				\
						v.fechavta>=@fechaini                                                                   \
						AND v.fechavta<=@fechafin                                                               \
						AND v.cancelado=0                                                                       \
						%s                                                                          			\
					GROUP BY                                                                    				\
						a.producto, a.present                                          							\
				)                                                                               				\
			UNION ALL                                                                           				\
				(                                                                               				\
					SELECT                                                                      				\
						a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotventa     					\
					FROM                                                                        				\
						notascredcli n INNER JOIN dnotascredcli d ON n.referencia=d.referencia                  \
						INNER JOIN dventas dv ON dv.referencia  =n.venta AND dv.articulo=d.articulo             \
						INNER JOIN articulos a ON d.articulo=a.articulo                                         \
						INNER JOIN terminales t ON n.terminal=t.terminal                                        \
						INNER JOIN secciones sec ON t.seccion=sec.seccion                     					\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
					WHERE                                                                           			\
						n.cancelado=0                                                                           \
						AND n.fechanot BETWEEN @fechaini AND @fechafin                                          \
						%s                                                                          			\
					GROUP BY                                                                        			\
						a.producto, a.present                                          							\
				)                                                                                   			\
			) t GROUP BY t.producto, t.present INTO OUTFILE '%s' ",
			innerjoin_parterel1, condicion_sucursal,

			innerjoin_parterel2, condicion_sucursal, achivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxventasnc (producto, present, subtotventa) ",
			achivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los costos de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventascostonc (producto VARCHAR(8), present VARCHAR(255), costo DOUBLE, \
		PRIMARY KEY(producto, present)) Engine = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		achivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		/////Se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("SELECT                                                                             \
			t.producto, t.present, SUM(t.costo)                                   								\
		FROM                                                                                    				\
			(                                                                                   				\
				(                                                                               				\
					SELECT                                                                      				\
						pccd.producto, pccd.present, SUM(pccd.costovta*-1) AS costo    							\
					FROM                                                                        				\
						ventas v FORCE INDEX(fechavta)                                          				\
						INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia 				\
						AND pccd.tipo = 'VE'  																	\
						INNER JOIN terminales t ON v.terminal=t.terminal                        				\
						INNER JOIN secciones sec ON t.seccion=sec.seccion                       				\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						%s                                                                                      \
					WHERE                                                                       				\
						v.fechavta>=@fechaini                                               					\
						AND v.fechavta<=@fechafin                                               				\
						%s                                                                          			\
						AND v.cancelado=0                                                       				\
					GROUP BY                                                                    				\
						pccd.producto, pccd.present                                          					\
				)                                                                               				\
			UNION ALL                                                                           				\
				(                                                                               				\
					SELECT                                                                      				\
						pccd.producto, pccd.present, SUM(pccd.costovta*-1) AS costo     						\
					FROM                                                                        				\
						notascredcli nc                                                                         \
						INNER JOIN precalculocostosventadet pccd ON pccd.referencia = nc.referencia 			\
						AND pccd.tipo = 'DV'  																	\
						INNER JOIN terminales t ON nc.terminal=t.terminal                            			\
						INNER JOIN secciones sec ON t.seccion=sec.seccion                           			\
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal                                  \
						INNER JOIN ventas v ON nc.venta = v.referencia                          				\
						%s                                                                                      \                     			\
					WHERE                                                                           			\
						nc.cancelado=0                                                           				\
						%s                                                                          			\
						AND nc.fechanot BETWEEN @fechaini AND @fechafin                              			\
					GROUP BY                                                                        			\
						pccd.producto, pccd.present                                          					\
				)                                                                                   			\
			) t GROUP BY t.producto, t.present INTO OUTFILE '%s' ",
			innerjoin_parterel3, condicion_sucursal,

			innerjoin_parterel4, condicion_sucursal, achivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxventascostonc (producto, present, costo) ",
			achivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			if (prov_compras == "INDEFINIDO") {
				proveedor.sprintf(" pa.proveedor IS NULL ");
			}
			else {
				proveedor.sprintf(" pa.proveedor = '%s' ", prov_compras);
			}
			// Resultado final
			instruccion.sprintf("SELECT t.producto,                                              \
				   prod.nombre,                                                                  \
				   t.present,                                                                    \
				   t.prodtot,                                                                	 \
				   t.unitot,                                                               		 \
				   t.total,                                                                      \
				   t.costo,                                                                      \
				   t.subtotventa,                                                                \
				   t.util,                                                                       \
				   t.utilporc                                                                    \
			FROM (                                                                               \
					(SELECT pa.proveedor AS claveprov,                                           \
							v.producto,                                                          \
							v.present,                                                           \
							pa.prodtot,                                                      	 \
							pa.unitot,                                                     		 \
							pa.total,                                                            \
							(SUM(IFNULL(c.costo,0) *pa.total)) AS costo,                         \
							(SUM(v.subtotventa *pa.total)) AS subtotventa,                       \
							SUM((v.subtotventa *pa.total -IFNULL(c.costo,0) *pa.total)) AS util, \
							((((SUM(v.subtotventa *pa.total -IFNULL(c.costo,0) *pa.total)*100)/SUM(IFNULL(c.costo,0) *pa.total)))) AS utilporc                     \
					 FROM auxventasnc v                                                          \
					 INNER JOIN provcompraaux pa ON v.producto = pa.producto                     \
					 AND v.present = pa.present                                                  \
					 LEFT JOIN auxventascostonc c ON c.producto = v.producto                     \
					 AND c.present = v.present                                                   \
					 WHERE %s                                                   				 \
					 GROUP BY v.producto, v.present)                                           	 \
				  UNION ALL                                                                      \
					(SELECT 'INDEFINIDO' AS claveprov,                                           \
							v.producto,                                                          \
							v.present,                                                           \
							pa.prodtot,                                                      	 \
							pa.unitot,                                                    	 	 \
							pa.total,                                                            \
							SUM(IFNULL(c.costo,0)) AS costo,                                     \
							SUM(v.subtotventa) AS subtotventa,                                   \
							SUM(v.subtotventa-IFNULL(c.costo,0)) AS util,                        \
							((SUM(v.subtotventa-IFNULL(c.costo,0))*100)/SUM(IFNULL(c.costo,0))) AS utilporc                                 \
					 FROM auxventasnc v                                                          \
					 LEFT JOIN provcompraaux pa ON v.producto = pa.producto                      \
					 AND v.present = pa.present                                                  \
					 LEFT JOIN auxventascostonc c ON c.producto = v.producto                     \
					 AND c.present = v.present                                                   \
					 WHERE %s                                                   				 \
					 GROUP BY v.producto, v.present)) t                                          \
			INNER JOIN productos prod ON t.producto = prod.producto                              \
			WHERE t.claveprov = '%s'                                                             \
			GROUP BY t.producto, t.present", proveedor, proveedor,
			prov_compras);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;

		mServidorVioleta->BorraArchivoTemp(achivo_temp1);
		mServidorVioleta->BorraArchivoTemp(achivo_temp2);

		mServidorVioleta->BorraArchivoTemp(achivo_temp3);
		mServidorVioleta->BorraArchivoTemp(achivo_temp4);

		mServidorVioleta->BorraArchivoTemp(achivo_temp5);
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTODET_EXT
void ServidorReportes::EjecutaRepCostoDetExt(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, empresa, sucursal, producto, presenta, fecha_notas_credito;

	AnsiString tipoFac, termiPago, clasif1, clasif2, clasif3;
	AnsiString marca, provPrin, provHist, meses, vendedor;
	AnsiString sector, localidad, cliente, venta;
	AnsiString segmento, fabricante, parteRelacionada;
	AnsiString condicion_tipoFac = " ", condicion_termiPago = " ",
		condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_marca = " ", condicion_provPrin = " ",
		condicion_suc_provPrin = " ", condicion_vendedor = " ";
	AnsiString condicion_provHist = " ", condicion_meses = " ";
	AnsiString inner_prod = " ", inner_productos = " ", inner_proveedor_ventas =
		" ", inner_proveedor_costos = " ";
	AnsiString inner_prov_hist_ventas = " ", inner_prov_hist_ventas2 = " ",
		inner_prov_hist_costos = " ", inner_prov_hist_costos2 = " ";
	AnsiString inner_sector_ventas = " ", inner_sector_costos = " ",
		inner_sector_ventas2 = " ", inner_sector_costos2 = " ";
	AnsiString condicion_sector = " ", condicion_localidad = " ",
		condicion_cliente = " ", condicion_venta = " ", condicion_suc = " ";
	AnsiString condicion_segmento = " ", condicion_fabricante = " ",
		condicion_parteRelacionada = " ", inner_clientes = " ";
	AnsiString inner_sucursales = " ";
    AnsiString whereFechaNotaCredito = " ";

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[15];
    empresa = FormServidor->ObtieneClaveEmpresa();

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		presenta = mFg.ExtraeStringDeBuffer(&parametros);
		tipoFac = mFg.ExtraeStringDeBuffer(&parametros);
		termiPago = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		provPrin = mFg.ExtraeStringDeBuffer(&parametros);
		provHist = mFg.ExtraeStringDeBuffer(&parametros);
		meses = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		sector = mFg.ExtraeStringDeBuffer(&parametros);
		localidad = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		parteRelacionada = mFg.ExtraeStringDeBuffer(&parametros);
        fecha_notas_credito = mFg.ExtraeStringDeBuffer(&parametros);

		if (sucursal != " ") {
			condicion_suc.sprintf(" AND sec.sucursal = '%s' ", sucursal);
		}

		if (tipoFac != " ") {
			condicion_tipoFac.sprintf(" AND v.tipofac = '%s'", tipoFac);
		}

		if (termiPago != " ") {
			condicion_termiPago.sprintf(" AND v.acredito = '%s'", termiPago);
		}

		if (clasif1 != " " || clasif2 != " " || clasif3 != " " ||
			marca != " " || segmento != " " || fabricante != " ") {
			inner_prod.sprintf
				("INNER JOIN productos p ON a.producto = p.producto");
			inner_productos.sprintf
				("INNER JOIN productos p ON pccd.producto = p.producto");
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" AND p.clasif1 = '%s'", clasif1);
		}

		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" AND p.clasif2 = '%s'", clasif2);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" AND p.clasif3 = '%s'", clasif3);
		}

		if (marca != " ") {
			condicion_marca.sprintf(" AND p.marca = '%s'", marca);
		}

		if (provPrin != " ") {
			if (sucursal != " ") {
				condicion_suc_provPrin.sprintf(" AND ap.sucursal = '%s' ",
					sucursal);
			}
			inner_proveedor_ventas.sprintf
				(" INNER JOIN articulosped ap ON a.producto = ap.producto AND a.present = ap.present AND ap.proveedor = '%s' %s ",
				provPrin, condicion_suc_provPrin);
			inner_proveedor_costos.sprintf
				(" INNER JOIN articulosped ap ON pccd.producto = ap.producto AND pccd.present = ap.present AND ap.proveedor = '%s' %s ",
				provPrin, condicion_suc_provPrin);
		}

		if (provHist != " ") {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND com.fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha_final, meses, fecha_final);
			}
			else {
				condicion_meses = " ";
			}
			/////TABLA TEMPORL PARA EL PROVEEDOR HISTORICO
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present", provHist,
				condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			// Crea una copia de la tabla prodpresentprovcompraaux para evitar errores por usar dos veces en el mismo query una tabla temporal (MariaDB 10.1 o menor)
			instruccion =
				"create temporary table prodpresentprovcompra2aux like prodpresentprovcompraaux ";
			mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
			instruccion =
				"insert into prodpresentprovcompra2aux select * from prodpresentprovcompraaux ";
			mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			inner_prov_hist_ventas.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON a.producto=pppca.producto AND a.present=pppca.present"
				);
			inner_prov_hist_ventas2.sprintf
				("INNER JOIN prodpresentprovcompra2aux pppca ON a.producto=pppca.producto AND a.present=pppca.present"
				);
			inner_prov_hist_costos.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pccd.producto=pppca.producto AND pccd.present=pppca.present"
				);
			inner_prov_hist_costos2.sprintf
				("INNER JOIN prodpresentprovcompra2aux pppca ON pccd.producto=pppca.producto AND pccd.present=pppca.present"
				);
		}

		if (vendedor != " ") {
			condicion_vendedor.sprintf(" AND v.vendedor = '%s'", vendedor);
		}

		if (sector != " " || localidad != " ") {
			inner_sector_ventas.sprintf("                         \
			INNER JOIN clientes cli ON v.cliente = cli.cliente    \
			INNER JOIN colonias col ON cli.colonia = col.colonia ");
			inner_sector_ventas2.sprintf("                         \
			INNER JOIN clientes cli ON v.cliente = cli.cliente    \
			INNER JOIN colonias col ON cli.colonia = col.colonia ");
			inner_sector_costos.sprintf("                         \
			INNER JOIN clientes cli ON v.cliente = cli.cliente	  \
			INNER JOIN colonias col ON cli.colonia = col.colonia ");
			inner_sector_costos2.sprintf("                         \
			INNER JOIN clientes cli ON v.cliente = cli.cliente	  \
			INNER JOIN colonias col ON cli.colonia = col.colonia ");
		}

		if (sector != " ") {
			condicion_sector.sprintf(" AND col.sector='%s' ", sector);
		}

		if (localidad != " ") {
			condicion_localidad.sprintf(" AND col.localidad='%s' ", localidad);
		}

		if (cliente != " ") {
			condicion_cliente.sprintf(" AND v.cliente='%s' ", cliente);
		}

		if (venta != " ") {
			condicion_venta.sprintf(" AND v.referencia='%s' ", venta);
		}

		if (segmento != " ") {
			condicion_segmento.sprintf(" AND pcb.segmento = '%s' ", segmento);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND p.fabricante = '%s' ",
			fabricante);
		}

		if (parteRelacionada != " ") {
			if (sector == " ") {
				inner_clientes.sprintf
					(" INNER JOIN clientes cli ON v.cliente = cli.cliente ");
			}
			condicion_parteRelacionada.sprintf(" AND cli.esparterelac='%s' ",
				parteRelacionada);
		}

		if (sucursal == " ") {
            inner_sucursales.sprintf("INNER JOIN sucursales suc ON sec.sucursal = suc.sucursal AND suc.idempresa = %s", empresa);
		}

		if(fecha_notas_credito != " "){
			whereFechaNotaCredito.sprintf(" AND n.fechanot <= '%s' ", fecha_notas_credito);
		}

		/////Inicializamos la variable fecha inicial
		instruccion.sprintf("SET @producto = '%s' ", producto);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @present  = '%s'", presenta);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;

		/////Inicializamos la variable fecha final
		instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "create temporary table auxventasncdet (fechavta DATE, horavta TIME, referencia VARCHAR(11),	 \
		subtotventa decimal(16,4)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		/////Se guardan las ventas dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO auxventasncdet (fechavta, horavta, referencia, subtotventa)      \
		SELECT                                                                                            \
			t.fechavta, t.horavta, t.referencia, t.subtotventa                                            \
		FROM                                                                                              \
			(                                                                                             \
				(                                                                                         \
					SELECT                                                                                \
					v.fechavta, v.horavta, v.referencia, SUM((dv.precio)*(dv.cantidad)) AS subtotventa    \
					FROM                                                                                  \
					ventas v FORCE INDEX(fechavta)                                                        \
					INNER JOIN dventas dv ON dv.referencia=v.referencia                                   \
					INNER JOIN articulos a ON a.articulo=dv.articulo                                      \
					INNER JOIN terminales t ON v.terminal=t.terminal                                      \
					INNER JOIN secciones sec ON t.seccion=sec.seccion                                     \
					INNER JOIN presentaciones ps ON ps.producto = a.producto AND ps.present = a.present   \
					INNER JOIN presentacionescb pcb ON pcb.producto = ps.producto                         \
					AND pcb.present = ps.present AND pcb.idempresa=%s                                     \
                    %s \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					WHERE                                                                                 \
					a.producto=@producto AND a.present = @present                                         \
					AND v.fechavta>=@fechaini                                                             \
					AND v.fechavta<=@fechafin                                                             \
					AND v.cancelado=0                                                                     \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s                                          \
					GROUP BY v.referencia                                                                 \
				)                                                                                         \
				UNION ALL                                                                                 \
				(                                                                                         \
					SELECT                                                                                \
					n.fechanot, 0 AS horavta, n.venta, SUM(d.precio*d.cantidad*-1) AS subtotventa         \
					FROM notascredcli n \
					INNER JOIN dnotascredcli d ON n.referencia=d.referencia                \
					INNER JOIN dventas dv ON dv.referencia  =n.venta AND dv.articulo=d.articulo           \
					INNER JOIN articulos a ON d.articulo=a.articulo                                       \
					INNER JOIN ventas v ON n.venta = v.referencia                                         \
					INNER JOIN terminales t ON v.terminal=t.terminal                                      \
					INNER JOIN secciones sec ON t.seccion=sec.seccion                                     \
					INNER JOIN presentaciones ps ON ps.producto = a.producto AND ps.present = a.present   \
					INNER JOIN presentacionescb pcb ON pcb.producto = ps.producto                         \
					AND pcb.present = ps.present AND pcb.idempresa=%s                                     \
                    %s \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					%s                                                                                    \
					WHERE                                                                                 \
					a.producto=@producto AND a.present = @present                                         \
					AND n.cancelado=0                                                                     \
					AND v.fechavta BETWEEN @fechaini AND @fechafin                                        \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s                                          \
					GROUP BY v.referencia                                                                 \
				)                                                                                         \
			) t", empresa, inner_sucursales, inner_prod, inner_proveedor_ventas, inner_prov_hist_ventas,
			inner_sector_ventas, inner_clientes,

			condicion_suc, condicion_tipoFac, condicion_termiPago,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_marca, condicion_vendedor, condicion_sector,
			condicion_localidad, condicion_cliente, condicion_venta,
			condicion_segmento, condicion_fabricante,
			condicion_parteRelacionada,

			empresa, inner_sucursales,
			inner_prod, inner_proveedor_ventas, inner_prov_hist_ventas2,
			inner_sector_ventas2, inner_clientes,

			condicion_suc, condicion_tipoFac, condicion_termiPago,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_marca, condicion_vendedor, condicion_sector,
			condicion_localidad, condicion_cliente, condicion_venta,
			condicion_segmento, condicion_fabricante,
			condicion_parteRelacionada, whereFechaNotaCredito);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los valores de los costos
		instruccion =
			"create temporary table auxventascostoncdet (fechavta DATE, horavta TIME,  \
		referencia VARCHAR(11), multmin DECIMAL(16,4), costo decimal(16,4), tipo VARCHAR(5), venta VARCHAR(11)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO  auxventascostoncdet (fechavta, horavta, referencia, multmin, costo, tipo, venta) \
		SELECT                                                                                                      \
			t.fechavta, t.horavta, t.referencia, t.multmin, t.costo, t.tipo, t.venta \
		FROM                                                                                                        \
			(                                                                                                       \
				(                                                                                                   \
					SELECT                                                                                          \
					v.fechavta,                                                                                     \
					v.horavta,                                                                                      \
					v.referencia,                                                                                   \
					SUM(pccd.cantidad*-1) AS multmin,                                                               \
					SUM(pccd.costovta*-1) AS costo,                                                                 \
					pccd.tipo, \
                    v.referencia AS venta \
					FROM ventas v                                                                                   \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia AND pccd.tipo = 'VE' \
					INNER JOIN terminales t ON v.terminal=t.terminal                                                \
					INNER JOIN secciones sec ON t.seccion=sec.seccion                                               \
					INNER JOIN presentaciones ps ON ps.producto = pccd.producto AND ps.present = pccd.present       \
					INNER JOIN presentacionescb pcb ON pcb.producto = ps.producto                                   \
					AND pcb.present = ps.present AND pcb.idempresa=%s                                               \
                    %s \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                    			\
					WHERE                                                                                           \
					pccd.producto=@producto AND pccd.present = @present                                             \
					AND v.fechavta BETWEEN @fechaini AND @fechafin                                                  \
					AND v.cancelado = 0                                                                             \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s                                                    \
					GROUP BY v.referencia                                                                           \
				)                                                                                                   \
				UNION ALL                                                                                           \
				(                                                                                                   \
					SELECT                                                                                          \
					n.fechanot AS fechavta,                                                                         \
					0 AS horavta,                                                                                   \
					pccd.referencia,                                                                                \
					SUM(pccd.cantidad*-1) AS multmin,                                                               \
					SUM(pccd.costovta*-1) AS costo,                                                                 \
					pccd.tipo, \
					v.referencia AS venta \
					FROM notascredcli n                                                                             \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = n.referencia AND pccd.tipo = 'DV' \
					INNER JOIN terminales t ON n.terminal=t.terminal                                                \
					INNER JOIN secciones sec ON t.seccion=sec.seccion                                               \
					INNER JOIN ventas v ON n.venta = v.referencia                                                   \
					INNER JOIN presentaciones ps ON ps.producto = pccd.producto AND ps.present = pccd.present       \
                    INNER JOIN presentacionescb pcb ON pcb.producto = ps.producto                                   \
					AND pcb.present = ps.present AND pcb.idempresa=%s                                               \
                    %s \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                              \
					%s                                                                                    			\
					WHERE                                                                                           \
					pccd.producto=@producto AND pccd.present = @present                                             \
					AND v.fechavta BETWEEN @fechaini AND @fechafin                                                  \
					AND n.cancelado = 0                                                                             \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s                                                    \
					GROUP BY pccd.referencia                                                                        \
				)                                                                                                   \
			) t", empresa, inner_sucursales, inner_productos, inner_proveedor_costos,
			inner_prov_hist_costos, inner_sector_costos, inner_clientes,

			condicion_suc, condicion_tipoFac, condicion_termiPago,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_marca, condicion_vendedor, condicion_sector,
			condicion_localidad, condicion_cliente, condicion_venta,
			condicion_segmento, condicion_fabricante,
			condicion_parteRelacionada,

            empresa, inner_sucursales,
			inner_productos, inner_proveedor_costos, inner_prov_hist_costos2,
			inner_sector_costos2, inner_clientes,

			condicion_suc, condicion_tipoFac, condicion_termiPago,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_marca, condicion_vendedor, condicion_sector,
			condicion_localidad, condicion_cliente, condicion_venta,
			condicion_segmento, condicion_fabricante,
			condicion_parteRelacionada, whereFechaNotaCredito);
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los valores totales de costos y subtotal
		instruccion =
			"create temporary table auxventacostotot (fechavta DATE, horavta TIME, referencia VARCHAR(11),  \
		subtotventa decimal(16,4), multmin DECIMAL(16,4), costo decimal(16,4), tipo VARCHAR(5), venta VARCHAR(11)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO auxventacostotot (fechavta, horavta, referencia, subtotventa, multmin, costo, tipo, venta) \
		SELECT                                                                                                               \
				t.fechavta,                                                                                                  \
				t.horavta,                                                                                                   \
				t.referencia,                                                                                                \
				SUM(t.subtotventa) AS subtotventa,                                                                           \
				t.multmin,                                                                                                   \
				SUM(t.costo) AS costo,                                                                                       \
				t.tipo, \
                t.venta \
		FROM (                                                                                                               \
				(SELECT                                                                                                      \
						auxv.fechavta,                                                                                       \
						auxv.horavta,                                                                                        \
						auxv.referencia,                                                                                     \
						auxv.subtotventa,                                                                                    \
						0 AS multmin,                                                                                        \
						0 AS costo,                                                                                          \
						'VE' AS tipo, \
                        auxv.referencia AS venta \
				 FROM auxventasncdet auxv)                                                                                   \
			  UNION ALL                                                                                                      \
				(SELECT                                                                                                      \
						auxvnc.fechavta,                                                                                     \
						auxvnc.horavta,                                                                                      \
						auxvnc.referencia,                                                                                   \
						0 AS subtotventa,                                                                                    \
						auxvnc.multmin,                                                                                      \
						auxvnc.costo,                                                                                        \
						'NC' AS tipo, \
                        auxvnc.venta \
				 FROM auxventascostoncdet auxvnc)                                                                            \
			) t                                                                                                              \
			GROUP BY t.referencia");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			// Resultado final
			instruccion.sprintf("SELECT auxv.fechavta AS fecha,                                  \
			auxv.horavta AS hora,                                                                \
			auxv.tipo AS tipo,                                                                   \
			auxv.referencia AS referencia,                                                       \
			SUM(auxv.costo) AS costo,                                                               \
			SUM(auxv.subtotventa) AS subtotventa,                                                   \
			SUM(auxv.subtotventa-auxv.costo) AS utiltot,                                            \
			SUM(((auxv.subtotventa-auxv.costo)*100)/auxv.costo) AS utilpor,                         \
			if(n.tipo=0, 'DEVOL', if(n.tipo=1, 'BONIF', if(n.tipo=2, 'DESCU', ''))) AS tiponota, \
			TRUNCATE(IFNULL(auxv.multmin/pmm.maxfactor,0),0) AS cantmayor,                       \
			IFNULL(MOD(auxv.multmin,pmm. maxfactor),0) AS cantunidad,                            \
			pmm.maxmult,                                                                         \
			pmm.maxfactor,                                                                       \
			pmm.minmult                                                                          \
			FROM auxventacostotot auxv                                                           \
			LEFT JOIN notascredcli n ON auxv.referencia = n.referencia                           \
			INNER JOIN presentacionesminmax AS pmm ON pmm.producto = @producto                   \
			AND pmm.present = @present                                                           \
            GROUP BY auxv.venta \
			ORDER BY fecha, hora  ");
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOEXISTENCIAS
void ServidorReportes::EjecutaRepCostoExistencias(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	int i;
	AnsiString fecha, almacen, producto, presentacion;
	AnsiString clasif1, clasif2, clasif3, costoexistencia;
	AnsiString cantidad_almacen = " ", condicion_producto = " ",
		condicion_presentacion = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString campos_detalle = " ";
	bool es_desglosado = false;
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ";
	bool incluir_iva;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas *resp_mov = NULL, *resp_prod = NULL, *resp_prod_iva = NULL;
	TStringList *lista_productos = new TStringList;
	TStringList *lista_productos_iva = new TStringList;

	BufferRespuestas *resp_bloques = NULL;
	AnsiString minimo, minimo2, maximo2;
	int x;
	AnsiString condicion_rango_productos;
	int count = 0;

	int indice_producto, indice_present, indice_clasif, indice_cantalma,
		indice_cantidad, indice_costounit, indice_almacen;
	int indice_tipo, indice_fecha, indice_referencia;

	AnsiString segmento, fabricante;
	AnsiString condicion_segmento = " ", condicion_fabricante = " ",
		inner_seg_fab = " ", inner_presentaciones = " ";
	AnsiString forzar_indice = "FORCE INDEX(PRIMARY)";
	AnsiString marca, condicion_marca = " ";

    AnsiString idEmpresa = " ";

	char *buffer_resp_mov = NULL;

	TDictionary__2<UnicodeString, UnicodeString> * sucursalesAlmacenes = new TDictionary__2<UnicodeString, UnicodeString>(0);
	char * bf_SucAlm = new char[1024*10];
	try{
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, "SELECT alm.almacen as almacen, sec.sucursal as sucursal FROM \
			almacenes alm \
			INNER JOIN secciones sec ON sec.seccion = alm.seccion", bf_SucAlm);
		BufferRespuestas br_SucAlm(bf_SucAlm);

		for(int i=0; i<br_SucAlm.ObtieneNumRegistros(); i++){
			br_SucAlm.IrAlRegistroNumero(i);
			sucursalesAlmacenes->Add(br_SucAlm.ObtieneDato("almacen"), br_SucAlm.ObtieneDato("sucursal"));
		}
	}__finally{
		delete bf_SucAlm;
	}
	try {
		buffer_resp_mov = new char[TAM_MAX_BUFFER_COSTOS];

		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		presentacion = mFg.ExtraeStringDeBuffer(&parametros);
		incluir_iva = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		costoexistencia = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " " && sucursal != "' '" ) {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal IN (%s)", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		IteradorCostos *iterador;
		bool hay_pendientes, aplicar_costo;
		int estado_iteracion;
		double costotot;
		char *aux, *respuesta;
		int *tam_respuesta, *num_filas;
		AnsiString nombre_producto, producto_anterior, present_anterior, iva;
		double acum_cantidad, acum_cantalma;
		double acum_costo, costoprom;
		AnsiString producto_actual, present_actual, tipo_actual;
		char clasif_actual, clasif_actual_str[2];
		double cantidad_actual, cantalma_actual;
		double costounit_actual, costotot_actual;
		int num_registros;
		AnsiString dato_almacen = " ", dato_sucursal = " ";

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("pc.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("pc.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("pc.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("pc.producto='%s' and ", producto);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (presentacion != " ") {
			condicion_presentacion.sprintf("pc.present='%s' and ",
			presentacion);
			// Se sobreentiende que cuando se manda una presentación específica es
			// porque se desea un desglosado de los cálculos
			es_desglosado = true;
			campos_detalle = ", pc.tipo, pc.fecha, pc.referencia ";
		}

		if (segmento != " " || fabricante != " " || marca != " ") {
			inner_seg_fab.sprintf
				(" INNER JOIN productos p ON p.producto = pc.producto ");
		}

		if (segmento != " ") {
			inner_presentaciones.sprintf
				(" INNER JOIN presentaciones ps ON ps.producto = pc.producto AND ps.present = pc.present \
				   INNER JOIN presentacionescb pcb ON pcb.producto=ps.producto AND pcb.present=ps.present AND pcb.idempresa=%s ",
				   FormServidor->ObtieneClaveEmpresa() );
			condicion_segmento.sprintf(" pcb.segmento = '%s' and ", segmento);

		}
		if (fabricante != " ") {
			condicion_fabricante.sprintf(" p.fabricante = '%s' and ",
			fabricante);
		}
		if (marca != " ") {
			condicion_marca.sprintf("p.marca='%s' AND ", marca);
		}

		if (es_desglosado) {
			// Si es desglosado se ocupa más por productos con demaciados movimientos
			mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
				mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*4) + "] bytes",
				Respuesta->Id);
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP*4);
		}
		else {
			mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
				mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*2) + "] bytes",
				Respuesta->Id);
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP*2);
		}

		int rr_tam_respuesta;
		char *rr_aux_resultado = Respuesta->BufferResultado;
		int *rr_aux_tam = (int *)rr_aux_resultado;
		rr_aux_resultado += sizeof(int);
		// Nos saltamos la parte del tamaño del resultado.
		rr_aux_resultado = mFg.AgregaPCharABuffer("0", rr_aux_resultado);
		// No hubo error
		rr_tam_respuesta = rr_aux_resultado - Respuesta->BufferResultado;
		*rr_aux_tam = rr_tam_respuesta -sizeof(int);
		Respuesta->TamBufferResultado = rr_tam_respuesta;

		respuesta = Respuesta->BufferResultado +
			Respuesta->TamBufferResultado; // Allì vamos a poner el resultado
		aux = respuesta;
		tam_respuesta = (int *)aux;
		// Obtenemos la direccion donde se va a poner el tamaño del resultado
		aux += sizeof(int);
		num_filas = (int *)aux;
		// Obtenemos la direccion donde se va a poner el número de registros
		(*num_filas) = 0;
		aux += sizeof(int);

		if (cad_conjunto_almacenes != " ") {
			cantidad_almacen.sprintf
				(" if(pc.tipo<>'BC' and (pc.almacen in (%s)), pc.cantidad, 0) ",
				cad_conjunto_almacenes);
		}
		else
			cantidad_almacen = " if(pc.tipo<>'BC', pc.cantidad, 0) ";

		// Obtiene la lista de nombres de productos
		lista_productos->Sorted = true;
		instruccion = "select producto, nombre from productos";
		if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_prod, TAM_MAX_BUFFER_RESPUESTA_MIN)) {
			for (i = 0; i < resp_prod->ObtieneNumRegistros(); i++) {
				resp_prod->IrAlRegistroNumero(i);
				lista_productos->AddObject(resp_prod->ObtieneDato("producto"),
					(TObject *)(resp_prod->ObtienePunteroDato("nombre")));
			}
		}

		if (incluir_iva) {
			// Obtiene la lista de nombres de productos
			lista_productos_iva->Sorted = true;
			instruccion.sprintf("SELECT producto, \
				IF(i1.tipoimpu='IVA',i1.porcentaje, \
				 IF(i2.tipoimpu='IVA',i2.porcentaje, \
				  IF(i3.tipoimpu='IVA',i3.porcentaje, \
				   IF(i4.tipoimpu='IVA',i4.porcentaje, 0) ) ) ) AS iva \
				FROM productos p \
				LEFT JOIN impuestos i1 ON i1.impuesto=p.claveimpc1 \
				LEFT JOIN impuestos i2 ON i2.impuesto=p.claveimpc2 \
				LEFT JOIN impuestos i3 ON i3.impuesto=p.claveimpc3 \
				LEFT JOIN impuestos i4 ON i4.impuesto=p.claveimpc4");
			if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_prod_iva, TAM_MAX_BUFFER_RESPUESTA)) {
				for (i = 0; i < resp_prod_iva->ObtieneNumRegistros(); i++) {
					resp_prod_iva->IrAlRegistroNumero(i);
					lista_productos_iva->AddObject
						(resp_prod_iva->ObtieneDato("producto"),
						(TObject *)(resp_prod_iva->ObtienePunteroDato("iva")));
				}
			}
		}

		// **********************************************************************************************

		instruccion.sprintf("select pmm.producto, pmm.present, pmm.minimo, pmm.maximo \
			from precalculominmaxfin%s pmm \
			order by pmm.minimo", idEmpresa);
		if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_bloques))
			throw Exception
				("Error en select precalculominmax de ID_CALC_PRECALCULOCOSTOS_MENSUAL"
				);

		for (x = 0; x < resp_bloques->ObtieneNumRegistros() - 1; x++) {
			resp_mov = NULL;
			iterador = NULL;

			resp_bloques->IrAlRegistroNumero(x);
			minimo = resp_bloques->ObtieneDato("minimo");

			resp_bloques->IrAlRegistroNumero(x + 1);
			minimo2 = resp_bloques->ObtieneDato("minimo");
			maximo2 = resp_bloques->ObtieneDato("maximo");

			if (x < resp_bloques->ObtieneNumRegistros() - 2) {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<%s ",
					minimo, minimo2);
			}
			else {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<=%s ",
					minimo, maximo2);
			}

			try {
				// Manda el resultado a un buffer
				instruccion.sprintf("select pc.producto, pc.present, \
					pc.clasif, pc.cantidad, %s as cantalma, pc.costounit, pc.almacen, pc.tipo \
					%s \
					from precalculocostos%s pc %s \
					%s   \
					%s   \
					where %s and %s %s %s %s %s %s %s %s fecha<='%s' \
					order by id", cantidad_almacen, campos_detalle, idEmpresa,
					forzar_indice, inner_seg_fab, inner_presentaciones,
					condicion_rango_productos, condicion_presentacion,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_producto, condicion_segmento,
					condicion_fabricante, condicion_marca, fecha);

				if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_mov, buffer_resp_mov)) {
					mServidorVioleta->MuestraMensaje
						("-- Finalizó mandar resultados a buffer [" +
						mFg.IntToAnsiString(resp_mov->ObtieneTamRespuesta()) +
						"] bytes", Respuesta->Id);
					// Crea objeto iterador
					iterador = new IteradorCostos(resp_mov);

					mServidorVioleta->MuestraMensaje
						("-- Finalizó creación de iterador", Respuesta->Id);

					indice_producto = resp_mov->ObtieneIndiceCampo("producto");
					indice_present = resp_mov->ObtieneIndiceCampo("present");

					indice_clasif = resp_mov->ObtieneIndiceCampo("clasif");
					indice_cantalma = resp_mov->ObtieneIndiceCampo("cantalma");
					indice_cantidad = resp_mov->ObtieneIndiceCampo("cantidad");
					indice_costounit = resp_mov->ObtieneIndiceCampo("costounit");
					indice_tipo = resp_mov->ObtieneIndiceCampo("tipo");
					if (es_desglosado) {

						indice_fecha = resp_mov->ObtieneIndiceCampo("fecha");
						indice_referencia =
							resp_mov->ObtieneIndiceCampo("referencia");
					}

					indice_almacen = resp_mov->ObtieneIndiceCampo("almacen");

					// producto_anterior se usa para que en cada registro saber que
					// producto era el registro anterior
					producto_anterior = "";

					// present_anterior se usa para en cada registro saber que
					// presentación era el registro anterior
					present_anterior = "";

					// acum_cantidad se usa para en cada registro saber
					// la sumatoria de la cantidad del último producto-presentación
					// en global (todos los almacenes)
					acum_cantidad = 0;

					// acum_costo se usa para en cada registro saber
					// la sumatoria del costo acumulado del último producto-presentación
					// en global (todos los almacenes)
					acum_costo = 0;

					// acum_cantalma se usa para en cada registro saber
					// la sumatoria de la cantidad de almacen especifico del último producto-presentación
					acum_cantalma = 0;

					// Costo promedio hasta el último producto-presentacion
					costoprom = 0;

					// Ciclo para calcular los costos.
					i = 0;
					do {
						hay_pendientes = iterador->IrRegistroPendiente();
						estado_iteracion = iterador->ObtieneEstadoIteracion();

						// Si i está dentro del rango válido nos posicionamos en el registro(i)
						// y obtenemos el producto y presentación de dicho registro
						if (hay_pendientes) {
							producto_actual = resp_mov->ObtienePunteroDatoEnIndice(indice_producto);
							present_actual =resp_mov->ObtienePunteroDatoEnIndice(indice_present);
						}

						dato_almacen =resp_mov->ObtienePunteroDatoEnIndice(indice_almacen);

						dato_sucursal = " ";

						if (sucursal != " ") {

							AnsiString almacen_mod = "'" + dato_almacen + "'";

							if (cad_conjunto_almacenes != " ") {
								TStringDynArray falmacenes(SplitString(cad_conjunto_almacenes, ","));
								if (falmacenes.Length > 0) {
									for (int f = 0; f < falmacenes.Length; f++){
										if (almacen_mod.Trim()==falmacenes[f].Trim()) {
											UnicodeString sucursalModificable = "";
											sucursalesAlmacenes->TryGetValue(StringReplace(almacen_mod.Trim(),"'","", TReplaceFlags()<<rfReplaceAll), sucursalModificable);
											dato_sucursal = sucursalModificable;
										}
									}
								}
							}
						}

						// Si ya pasamos el ultimo registro o el producto-presentacion es diferente
						// entonces manda los datos acumulados al cliente.
						if ((!hay_pendientes) ||(producto_actual != producto_anterior ||present_actual != present_anterior)) {
							// Si no es el primer registro
							if (i > 0 && !es_desglosado) {
								// Entonces manda los datos al cliente
								if (costoexistencia == "1") {
									// esta validacion, es cuando se haga en el reporte de existencia simple
									// y el checkbox de costoexistencia este palomeado, de lo contrario funcionara
									// como estaba antes  !mFg.EsCero(acum_cantidad,0.001) &&
									if (!mFg.EsCero(acum_cantalma,0.01) && (!mFg.EsCero(acum_costo,0.01) || !mFg.EsCero(acum_cantidad,0.01))) {
										try {
											nombre_producto = (char *)lista_productos->Objects[lista_productos->IndexOf(producto_anterior)];
										} catch (EStringListError &e) {
											nombre_producto = producto_anterior;
										}
										aux = mFg.AgregaStringABuffer(nombre_producto, aux); // agrega nombre
										aux = mFg.AgregaStringABuffer(present_anterior, aux);// aprega presentacion
										aux = mFg.AgregaStringABuffer(producto_anterior, aux);// agrega producto
										if (incluir_iva) {
											try {
												iva = (char *)lista_productos_iva->Objects[lista_productos_iva->IndexOf(producto_anterior)];
											} catch (EStringListError &e) {
												throw Exception
												("Se modifico un dato en el proceso, vuelva a ejecutar el reporte.");
											}
											aux = mFg.AgregaStringABuffer(iva,aux); // agrega IVA
										}
										if(almacen == " ") {
											// Si es global se manda costo global
											aux = mFg.AgregaStringABuffer(FloatToStr(acum_cantidad), aux);
											aux = mFg.AgregaStringABuffer(FloatToStr(acum_costo), aux);
										} else {
											// Si es de un almacén en específico se saca una
											// proporción de la cantidad que hay en el almacén
											// específico con respecto a el costo y la cantidad total
											aux = mFg.AgregaStringABuffer(FloatToStr(acum_cantalma), aux);
											if (!mFg.EsCero(acum_cantidad))
												aux = mFg.AgregaStringABuffer(FloatToStr((acum_costo * acum_cantalma)/ acum_cantidad), aux);
											else
												aux = mFg.AgregaStringABuffer(FloatToStr(0), aux);
										}
										aux = mFg.AgregaStringABuffer(FloatToStr(costoprom), aux);
										(*num_filas)++;
										count++;
									} // cierre del if de validacion de costo y existencia

								}
								// este else es para quue funcione normalmente, bueno antes de aplicar
								// la condicion de costoexistencia
								else {
									try {
										nombre_producto =(char *)lista_productos->Objects[lista_productos->IndexOf(producto_anterior)];
									} catch (EStringListError &e) {
										nombre_producto = producto_anterior;
									}
									aux = mFg.AgregaStringABuffer(nombre_producto, aux); // agrega nombre
									aux = mFg.AgregaStringABuffer(present_anterior, aux);// aprega presentacion
									aux = mFg.AgregaStringABuffer(producto_anterior, aux);// agrega producto
									if (incluir_iva) {
										if (incluir_iva) {
											try {
												iva = (char *)lista_productos_iva->Objects[lista_productos_iva->IndexOf(producto_anterior)];
											} catch (EStringListError &e) {
												throw Exception("Se modifico un dato en el proceso, vuelva a ejecutar el reporte.");
											}
											aux = mFg.AgregaStringABuffer(iva,aux); // agrega IVA
										}
									}
									if (almacen == " ") {
										// Si es global se manda costo global
										aux = mFg.AgregaStringABuffer(FloatToStr(acum_cantidad), aux);
										aux = mFg.AgregaStringABuffer(FloatToStr(acum_costo), aux);
									}
									else {
										// Si es de un almacén en específico se saca una
										// proporción de la cantidad que hay en el almacén
										// específico con respecto a el costo y la cantidad total
										aux = mFg.AgregaStringABuffer(FloatToStr(acum_cantalma), aux);
										if (!mFg.EsCero(acum_cantidad))
											aux = mFg.AgregaStringABuffer(FloatToStr((acum_costo * acum_cantalma)/ acum_cantidad), aux);
										else
											aux = mFg.AgregaStringABuffer(FloatToStr(0), aux);
									}
									aux = mFg.AgregaStringABuffer(FloatToStr(costoprom), aux);
									(*num_filas)++;
									count++;
								} // cierre del ese
							} // cierre del if de que no sea el primer registro
						}

						if (hay_pendientes) {

							tipo_actual = resp_mov->ObtienePunteroDatoEnIndice(indice_tipo);
							clasif_actual =*(resp_mov->ObtienePunteroDatoEnIndice(indice_clasif));
							// Solo se ocupa el primer caracter de la clasificación (siempre es solo un caracter)
							cantalma_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantalma), NULL);

							if (clasif_actual == 'A') {
								cantidad_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL);
								costounit_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_costounit), NULL);
								costotot_actual =cantidad_actual * costounit_actual;

							}
							if (clasif_actual == 'B') {
								cantidad_actual = 0;
								costounit_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_costounit), NULL);
								costotot_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL) * costounit_actual;
							}
							if (clasif_actual == 'C') {
								cantidad_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL);
								costounit_actual = costoprom;
								costotot_actual =cantidad_actual * costounit_actual;
							}

							// Si es un producto-presentacion DIFERENTE al anterior
							if ((producto_actual != producto_anterior ||present_actual != present_anterior)) {

								// Asigna los datos del registro actual a las variables
								// usadas para registro anterior, esto en preparación
								// para el siguiente ciclo.
								producto_anterior = producto_actual;
								present_anterior = present_actual;

								if(tipo_actual == "BA")
									costoprom = costounit_actual;
								else
									costoprom = 0;

								acum_cantidad = 0;
								acum_costo = 0;
								acum_cantalma = 0;

								iterador->IniciaOtroProductoPresentacion();
							}

							// si alguno de los acumulados podría dar negativo entonces
							// se ignora el registro actual, pero se acumula para posterior
							// aplicación cuando haya el positivo suficiente
							if ((acum_cantidad + cantidad_actual) < 0 || (acum_costo + costotot_actual) < 0 || (acum_cantalma + cantalma_actual) < 0) {
								// Si se generó un negativo

								// Si se no terminaron los registros y no esta en modo
								// de  forzar pendientes entonces se marca como no aplicado
								// para que se almacene en los pendientes.
								if (iterador->ObtieneEstaTerminadaIteracionNormal()== false && iterador->ObtieneForzarPendientes()== false) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								} else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}
							else { // Si No se generó un negativo

								// Si es iteracion normal y además
								// mov actual disminuye costo o existencias y
								// además hay pendientes de aplicar ENTONCES se les da prioridad
								// a los pendientes y el mov actual se pone como no
								// aplicado hasta el final de las lista de pendientes.
								if(estado_iteracion == 0 && (cantidad_actual < 0 || costotot_actual < 0 || cantalma_actual < 0)&& iterador->ObtieneNumRealNoAplicados () > 0) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								} else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}

							// Totaliza tomando en cuenta el registro actual
							if (aplicar_costo) {
								acum_cantidad = acum_cantidad + cantidad_actual;
								acum_costo = acum_costo + costotot_actual;
								acum_cantalma = acum_cantalma + cantalma_actual;
								if (!mFg.EsCero(acum_cantidad))
									costoprom = acum_costo / acum_cantidad;
								// else costoprom=0;
							}

							// Se mandan datos desglosados al cliente cuando asi se determine
							if (es_desglosado) {
								aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(aplicar_costo), aux);
								aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(estado_iteracion), aux);
								aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(iterador->ObtieneNumRegistroActivo()), aux);
								aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(iterador->ObtieneNumRealNoAplicados()), aux);
								aux = mFg.AgregaStringABuffer(resp_mov->ObtienePunteroDatoEnIndice(indice_fecha), aux);
								aux = mFg.AgregaStringABuffer(resp_mov->ObtienePunteroDatoEnIndice(indice_referencia), aux);
								aux = mFg.AgregaStringABuffer(tipo_actual, aux);
								clasif_actual_str[0] = clasif_actual;
								clasif_actual_str[1] = 0;
								// Convierte la clasificación a una cadena con terminador nulo
								aux = mFg.AgregaStringABuffer(clasif_actual_str, aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(cantidad_actual, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(cantalma_actual, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(costotot_actual, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(costounit_actual, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(acum_cantidad, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(acum_costo, 3,false), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(costoprom, 3,
									false), aux);

								// Del almacén en particular
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(acum_cantalma, 3,false), aux);
								if (!mFg.EsCero(acum_cantidad))
									aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad((acum_costo * acum_cantalma)/ acum_cantidad, 3, false), aux);
								else
									aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(0), aux);

								aux = mFg.AgregaStringABuffer(mFg.IntToAnsiString(0), aux);
								aux = mFg.AgregaStringABuffer(mFg.FormateaCantidad(0, 3, false), aux);

								aux = mFg.AgregaStringABuffer(dato_almacen, aux);

								aux = mFg.AgregaStringABuffer(dato_sucursal, aux);

								(*num_filas)++;
							}
						}
						i++;
					}
					while (hay_pendientes);

				}
				else
					throw Exception("Error en select precalculocostos%s de ID_EJE_REPCOSTOEXISTENCIAS");
			}
			__finally {
				if (iterador != NULL) {
					delete iterador;
					iterador = NULL;
				}
				if (resp_mov != NULL) {
					delete resp_mov;
					resp_mov = NULL;
				}
			}
		}
		// **********************************************************************************************

		// Establece el tamaño de la respuesta.
		*tam_respuesta = (aux - respuesta);
		Respuesta->TamBufferResultado = Respuesta->TamBufferResultado +
			*tam_respuesta; // Calcula tamaño total de buffer
		Respuesta->PosBufferResultado = 0;
		// Los resultados al cliente serán a partir del inicio del buffer.
	}
	__finally {
		if (incluir_iva) {
			if (resp_prod_iva != NULL)
				delete resp_prod_iva;
		}
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_mov != NULL)
			delete resp_mov;
		if (resp_prod != NULL)
			delete resp_prod;
		if (resp_bloques != NULL)
			delete resp_bloques;
		if (buffer_resp_mov != NULL)
			delete buffer_resp_mov;
		delete lista_productos;
		delete lista_productos_iva;

        delete sucursalesAlmacenes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTO_INVCAP
void ServidorReportes::EjecutaRepCostoInventarioCapturado
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10 * 2];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[10];
	int i;

	IteradorCostos *iterador;
	bool hay_pendientes, aplicar_costo;
	int estado_iteracion;

	BufferRespuestas *resp_mov, *resp_prod = NULL;
	double costotot;
	char *aux, *respuesta;
	int *tam_respuesta, *num_filas;
	AnsiString nomproducto_anterior, producto_anterior, present_anterior,
		lotes_anterior;
	double acum_cantidad, acum_cantalma;
	double acum_costo, costoprom;
	AnsiString nombre_producto, producto_actual, present_actual, tipo_actual,
		lotes_actual;
	char clasif_actual;
	double cantidad_actual, cantalma_actual;
	double costounit_actual, costotot_actual;
	int num_registros;
	double cantinv_actual, cantinv_anterior;

	AnsiString fecha, producto;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_lotes = " ";
	AnsiString condicion_almacen, condicion_inventario, lotes;
	AnsiString cantidad_almacen;
	AnsiString almacenes, inventarios;
	TStringList *lista_productos = new TStringList;

	BufferRespuestas *resp_bloques = NULL;
	AnsiString minimo, minimo2, maximo2;
	int x;
	AnsiString condicion_rango_productos;

	int indice_producto, indice_present, indice_clasif, indice_cantalma;
	int indice_cantinv, indice_cantidad, indice_costounit, indice_lotes, indice_tipo;
	AnsiString forzar_indice = "FORCE INDEX(PRIMARY)";

    AnsiString idEmpresa = " ";

	char *buffer_resp_mov = NULL;
	try {
		buffer_resp_mov = new char[TAM_MAX_BUFFER_COSTOS];

		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		inventarios = mFg.ExtraeStringDeBuffer(&parametros);
		almacenes = mFg.ExtraeStringDeBuffer(&parametros);
		lotes = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);

		idEmpresa = FormServidor->ObtieneClaveEmpresa();

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("pc.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("pc.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("pc.clasif3='%s' and ", clasif3);
		}
		if (producto != " ") {
			condicion_producto.sprintf("pc.producto='%s' and ", producto);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (lotes != " ") {
			condicion_lotes.sprintf(" di.lote in (%s) and ", lotes);
		}

		condicion_inventario.sprintf(" i.inventario in (%s) and ", inventarios);
		condicion_almacen.sprintf(" and pc.almacen in (%s) ", almacenes);

		// Crea una tabla donde se pondrá el inventario capturado agrupado por producto-presentacion
		instruccion = "create temporary table auxinventagrupado ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), \
			lotes TEXT, \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Inserta en la tabla se pondrán los inventarios agrupados por producto-presentacion
		// GROUP_CONCAT(distinct di.lote) AS lotes
		instruccion.sprintf("insert into auxinventagrupado (producto, present, cantidad,lotes) \
			select a.producto, a.present, sum(di.cantidad*a.factor) as cantidad, \
			GROUP_CONCAT(di.lote) AS lotes \
			from inventarios i, dinventarios di, articulos a, productos pc \
			where %s %s %s %s \
			%s  %s\
			i.inventario=di.inventario \
			and di.articulo=a.articulo and \
			a.producto=pc.producto \
			group by a.producto, a.present", condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_inventario, condicion_lotes);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
			mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*2) + "] bytes",
			Respuesta->Id);
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP*2);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			respuesta = Respuesta->BufferResultado +
				Respuesta->TamBufferResultado;
			// Allì vamos a poner el resultado
			aux = respuesta;
			tam_respuesta = (int *)aux;
			// Obtenemos la direccion donde se va a poner el tamaño del resultado
			aux += sizeof(int);
			num_filas = (int *)aux;
			// Obtenemos la direccion donde se va a poner el número de registros
			(*num_filas) = 0;
			aux += sizeof(int);

			// Obtiene la lista de nombres de productos
			lista_productos->Sorted = true;
			instruccion = "select producto, nombre from productos";
			if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_prod, TAM_MAX_BUFFER_RESPUESTA_MIN)) {
				for (i = 0; i < resp_prod->ObtieneNumRegistros(); i++) {
					resp_prod->IrAlRegistroNumero(i);
					lista_productos->AddObject
						(resp_prod->ObtieneDato("producto"),
						(TObject *)(resp_prod->ObtienePunteroDato("nombre")));
				}
			}

			cantidad_almacen.sprintf(" if(pc.tipo<>'BC' %s, pc.cantidad, 0) ",
				condicion_almacen);

			// **********************************************************************************************
			instruccion.sprintf("select pmm.producto, pmm.present, pmm.minimo, pmm.maximo \
				from precalculominmaxfin%s pmm \
				order by pmm.minimo", idEmpresa);
			if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_bloques))
				throw Exception
					("Error en select precalculominmax de ID_CALC_PRECALCULOCOSTOS_MENSUAL"
					);

			for (x = 0; x < resp_bloques->ObtieneNumRegistros() - 1; x++) {
				resp_mov = NULL;
				iterador = NULL;

				resp_bloques->IrAlRegistroNumero(x);
				minimo = resp_bloques->ObtieneDato("minimo");

				resp_bloques->IrAlRegistroNumero(x + 1);
				minimo2 = resp_bloques->ObtieneDato("minimo");
				maximo2 = resp_bloques->ObtieneDato("maximo");

				if (x < resp_bloques->ObtieneNumRegistros() - 2) {
					condicion_rango_productos.sprintf
						(" pc.id>=%s and pc.id<%s ", minimo, minimo2);
				}
				else {
					condicion_rango_productos.sprintf
						(" pc.id>=%s and pc.id<=%s ", minimo, maximo2);
				}

				try {

					// Manda el resultado a un buffer
					instruccion.sprintf("select pc.producto, pc.present, pc.tipo, \
						pc.clasif, pc.cantidad, %s as cantalma, i.cantidad as cantinv, pc.costounit, \
						i.lotes as lotes \
						from precalculocostos%s pc %s \
						LEFT JOIN  auxinventagrupado i on pc.producto=i.producto and pc.present=i.present \
						where %s and %s %s %s %s fecha<='%s'\
						order by id", cantidad_almacen, idEmpresa, forzar_indice,
						condicion_rango_productos, condicion_clasif1,
						condicion_clasif2, condicion_clasif3,
						condicion_producto, fecha);

					if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_mov, buffer_resp_mov)) {
						mServidorVioleta->MuestraMensaje
							("-- Finalizó mandar resultados a buffer [" +
							mFg.IntToAnsiString(resp_mov->ObtieneTamRespuesta())
							+ "] bytes", Respuesta->Id);
						// Crea objeto iterador
						iterador = new IteradorCostos(resp_mov);

						mServidorVioleta->MuestraMensaje
							("-- Finalizó creación de iterador", Respuesta->Id);

						indice_producto =
							resp_mov->ObtieneIndiceCampo("producto");
						indice_present =
							resp_mov->ObtieneIndiceCampo("present");
						indice_clasif = resp_mov->ObtieneIndiceCampo("clasif");
						indice_cantalma =
							resp_mov->ObtieneIndiceCampo("cantalma");
						indice_cantinv =
							resp_mov->ObtieneIndiceCampo("cantinv");
						indice_cantidad =
							resp_mov->ObtieneIndiceCampo("cantidad");
						indice_costounit =
							resp_mov->ObtieneIndiceCampo("costounit");
						indice_lotes = resp_mov->ObtieneIndiceCampo("lotes");
						indice_tipo =resp_mov->ObtieneIndiceCampo("tipo");

						// producto_anterior se usa para que en cada registro saber que
						// producto era el registro anterior
						producto_anterior = "";

						// present_anterior se usa para en cada registro saber que
						// presentación era el registro anterior
						present_anterior = "";

						// acum_cantidad se usa para en cada registro saber
						// la sumatoria de la cantidad del último producto-presentación
						// en global (todos los almacenes)
						acum_cantidad = 0;

						// acum_costo se usa para en cada registro saber
						// la sumatoria del costo acumulado del último producto-presentación
						// en global (todos los almacenes)
						acum_costo = 0;

						// acum_cantalma se usa para en cada registro saber
						// la sumatoria de la cantidad de almacen especifico del último producto-presentación
						acum_cantalma = 0;
						cantinv_anterior = 0;

						// Costo promedio hasta el último producto-presentacion
						costoprom = 0;

						lotes_anterior = "";

						// Ciclo para calcular los costos.
						i = 0;
						do {
							hay_pendientes = iterador->IrRegistroPendiente();
							estado_iteracion =
								iterador->ObtieneEstadoIteracion();

							// Si i está dentro del rango válido nos posicionamos en el registro(i)
							// y obtenemos el producto y presentación de dicho registro
							if (hay_pendientes) {
								producto_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_producto);
								present_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_present);
							}

							// Si ya pasamos el ultimo registro o el producto-presentacion es diferente
							// entonces manda los datos acumulados al cliente.
							if ((!hay_pendientes) ||
								(producto_actual != producto_anterior ||
								present_actual != present_anterior)) {
								// Si no es el primer registro
								if (i > 0) {
									// Entonces manda los datos al cliente
									nombre_producto =
										(char *)lista_productos->Objects
										[lista_productos->IndexOf
										(producto_anterior)];
									aux = mFg.AgregaStringABuffer
										(nombre_producto, aux);
									aux = mFg.AgregaStringABuffer
										(present_anterior, aux);
									aux = mFg.AgregaStringABuffer
										(producto_anterior, aux);
									// Cantidad  de sistema
									aux = mFg.AgregaStringABuffer
										(FloatToStr(acum_cantalma), aux);

									// costo de sistema
									if (!mFg.EsCero(acum_cantidad))
										aux = mFg.AgregaStringABuffer
										(FloatToStr((acum_costo * acum_cantalma)
										/ acum_cantidad), aux);
									else {

										if (mFg.EsCero(acum_cantalma)) {

										aux = mFg.AgregaStringABuffer
										(FloatToStr(0), aux);
										}
										else {
										aux = mFg.AgregaStringABuffer
										(FloatToStr
										(costoprom * acum_cantalma), aux);
										}
									}

									// Cantidad   de inventario
									aux = mFg.AgregaStringABuffer
										(FloatToStr(cantinv_anterior), aux);

									// costo de inventario
									if (!mFg.EsCero(acum_cantidad))
										aux = mFg.AgregaStringABuffer
										(FloatToStr
										((acum_costo * cantinv_anterior)
										/ acum_cantidad), aux);
									else {
										// aux=mFg.AgregaStringABuffer(FloatToStr(0), aux);
										if (mFg.EsCero(cantinv_anterior))
										aux = mFg.AgregaStringABuffer
										(FloatToStr(0), aux);
										else
										aux = mFg.AgregaStringABuffer
										(FloatToStr
										(costoprom * cantinv_anterior), aux);

									}
									// lotes
									aux = mFg.AgregaStringABuffer
										(lotes_anterior, aux);
									// aux=mFg.AgregaStringABuffer(resp_mov->ObtienePunteroDatoEnIndice(indice_lotes), aux);

									(*num_filas)++;
								}
							}

							if (hay_pendientes) {

                                tipo_actual = resp_mov->ObtienePunteroDatoEnIndice(indice_tipo);

								lotes_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_lotes);
								clasif_actual =
									*(resp_mov->ObtienePunteroDatoEnIndice
									(indice_clasif));
								// Solo se ocupa el primer caracter de la clasificación (siempre es solo un caracter)
								cantalma_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantalma), NULL);
								cantinv_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantinv), NULL);

								if (clasif_actual == 'A') {
									cantidad_actual =
										strtod(resp_mov->
										ObtienePunteroDatoEnIndice(
										indice_cantidad), NULL);
									costounit_actual =
										strtod(resp_mov->
										ObtienePunteroDatoEnIndice(
										indice_costounit), NULL);
									costotot_actual =
										cantidad_actual * costounit_actual;
								}
								if (clasif_actual == 'B') {
									cantidad_actual = 0;
									costounit_actual =
										strtod(resp_mov->
										ObtienePunteroDatoEnIndice(
										indice_costounit), NULL);
									costotot_actual =
										strtod(resp_mov->
										ObtienePunteroDatoEnIndice(
										indice_cantidad), NULL)
										* costounit_actual;
								}
								if (clasif_actual == 'C') {
									cantidad_actual =
										strtod(resp_mov->
										ObtienePunteroDatoEnIndice(
										indice_cantidad), NULL);
									costounit_actual = costoprom;
									costotot_actual =
										cantidad_actual * costounit_actual;
								}

								// Si es un producto-presentacion DIFERENTE al anterior
								if ((producto_actual != producto_anterior ||
									present_actual != present_anterior)) {

									// Asigna los datos del registro actual a las variables
									// usadas para registro anterior, esto en preparación
									// para el siguiente ciclo.
									producto_anterior = producto_actual;
									present_anterior = present_actual;
									cantinv_anterior = cantinv_actual;

									if(tipo_actual == "BA")
										costoprom = costounit_actual;
									else
										costoprom = 0;


									acum_cantidad = 0;

									acum_costo = 0;
									acum_cantalma = 0;

									lotes_anterior = lotes_actual;

									iterador->IniciaOtroProductoPresentacion();
								}

								// si alguno de los acumulados podría dar negativo entonces
								// se ignora el registro actual, pero se acumula para posterior
								// aplicación cuando haya el positivo suficiente
								if ((acum_cantidad + cantidad_actual) <
									0 || (acum_costo + costotot_actual) <
									0 || (acum_cantalma + cantalma_actual) < 0)
								{
									// Si se generó un negativo

									// Si se no terminaron los registros y no esta en modo
									// de  forzar pendientes entonces se marca como no aplicado
									// para que se almacene en los pendientes.
									if (iterador->
										ObtieneEstaTerminadaIteracionNormal()
										== false &&
										iterador->ObtieneForzarPendientes()
										== false) {
										// Lo marca como no aplicado lo que a su vez
										// lo agrega a pendientes
										aplicar_costo = false;
										iterador->MarcaComoNoAplicado();
									}
									else {
										// Aplica
										aplicar_costo = true;
										iterador->MarcaComoSiAplicado();
									}
								}
								else {
									// No se generó un negativo

									// Si es iteracion normal y además
									// mov actual disminuye costo o existencias y
									// además hay pendientes de aplicar ENTONCES se les da prioridad
									// a los pendientes y el mov actual se pone como no
									// aplicado hasta el final de las lista de pendientes.
									if (estado_iteracion == 0 &&
										(cantidad_actual <
										0 || costotot_actual <
										0 || cantalma_actual < 0)
										&& iterador->ObtieneNumRealNoAplicados
										() > 0) {
										// Lo marca como no aplicado lo que a su vez
										// lo agrega a pendientes
										aplicar_costo = false;
										iterador->MarcaComoNoAplicado();
									}
									else {
										// Aplica
										aplicar_costo = true;
										iterador->MarcaComoSiAplicado();
									}
								}

								// Totaliza tomando en cuenta el registro actual
								if (aplicar_costo) {
									acum_cantidad =
										acum_cantidad + cantidad_actual;
									acum_costo = acum_costo + costotot_actual;
									acum_cantalma =
										acum_cantalma + cantalma_actual;
									if (!mFg.EsCero(acum_cantidad))
										costoprom = acum_costo / acum_cantidad;
								}

								// lotes_actual=  resp_mov->ObtienePunteroDatoEnIndice(indice_lotes) ;
							}
							i++;
						}
						while (hay_pendientes);

					}
					else
						throw Exception
							("Error en select precalculocostos%s de ID_EJE_REPCOSTO_INVCAP");
				}
				__finally {
					if (iterador != NULL) {
						delete iterador;
						iterador = NULL;
					}
					if (resp_mov != NULL) {
						delete resp_mov;
						resp_mov = NULL;
					}
				}

			}
			// **********************************************************************************************

			// Establece el tamaño de la respuesta.
			*tam_respuesta = (aux - respuesta);
			Respuesta->TamBufferResultado = Respuesta->TamBufferResultado +
				*tam_respuesta; // Calcula tamaño total de buffer
			Respuesta->PosBufferResultado = 0;
			// Los resultados al cliente serán a partir del inicio del buffer.

		}
	}
	__finally {
		if (resp_prod != NULL)
			delete resp_prod;
		if (resp_bloques != NULL)
			delete resp_bloques;
		delete lista_productos;
		if (resp_mov != NULL)
			delete resp_mov;
		if (buffer_resp_mov != NULL)
			delete buffer_resp_mov;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOMOVALM
void ServidorReportes::EjecutaRepCostoMovimientosAlmacen
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	int i;
	AnsiString fecha_inicial, fecha_final, tipomov, conceptos, almacen,
		producto, movimiento;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_tipomov = " ", condicion_conceptos = " ",
		condicion_almacen = " ";
	AnsiString condicion_producto = " ", condicion_clasif1 = " ",
		condicion_clasif2 = " ", condicion_clasif3 = " ";
	AnsiString condicion_movimiento = " ", condicion_presentacion = " ";
	IteradorCostos *iterador;
	bool hay_pendientes, aplicar_costo;
	int estado_iteracion;

	BufferRespuestas *resp_mov = NULL, *resp_prod = NULL;
	double costotot;
	char *aux, *respuesta;
	int *tam_respuesta, *num_filas;
	AnsiString nombre_producto, producto_anterior, present_anterior;
	double acum_cantidad, acum_cantmov;
	double acum_costo, acum_costomov, costoprom;
	AnsiString producto_actual, present_actual, considerar_actual,
		almacen_actual, movimiento_actual;
	char clasif_actual;
	double cantidad_actual, cantmov_actual;
	double costounit_actual, costotot_actual;
	int num_registros;
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ";
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_present_en_mov = NULL;
	TStringList *lista_productos = new TStringList;

	BufferRespuestas *resp_bloques = NULL;
	AnsiString minimo, minimo2, maximo2;
	int x;
	AnsiString condicion_rango_productos;

	AnsiString join_productos_aux = " ";
	AnsiString condicion_producto_aux = " ", condicion_clasif1_aux = " ",
		condicion_clasif2_aux = " ", condicion_clasif3_aux = " ";

	int indice_producto, indice_present, indice_clasif, indice_considerar,
		indice_cantidad, indice_costounit, indice_mov, indice_almacen, indice_tipo;
	AnsiString forzar_indice = "FORCE INDEX(PRIMARY)";

	bool registra_costomov;
	AnsiString archivo_temp_mov;
	TFileStream *FStream1 = NULL;
	AnsiString referencia_actual = "", cadena, tipo_actual;

    AnsiString idEmpresa = " ";

	char *buffer_resp_mov = NULL;
	try {
		buffer_resp_mov = new char[TAM_MAX_BUFFER_COSTOS];

		fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		tipomov = mFg.ExtraeStringDeBuffer(&parametros);
		conceptos = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		movimiento = mFg.ExtraeStringDeBuffer(&parametros);
		registra_costomov = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

		idEmpresa = FormServidor->ObtieneClaveEmpresa();

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " " && sucursal != "' '") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal IN (%s)", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (tipomov != " ") {
			condicion_tipomov.sprintf(" and pc.tipomov='%s' ", tipomov);
		}
		if (producto != " ") {
			condicion_producto.sprintf("pc.producto='%s' and ", producto);
			condicion_producto_aux.sprintf("p.producto='%s' and ", producto);
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (clasif1 != " ") {
			condicion_clasif1.sprintf("pc.clasif1='%s' and ", clasif1);
			condicion_clasif1_aux.sprintf("p.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("pc.clasif2='%s' and ", clasif2);
			condicion_clasif2_aux.sprintf("p.clasif2='%s' and ", clasif2);

		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("pc.clasif3='%s' and ", clasif3);
			condicion_clasif3_aux.sprintf("p.clasif3='%s' and ", clasif3);
		}
		if (conceptos != " ") {
			condicion_conceptos.sprintf(" and pc.conceptomov in (%s) ",
				conceptos);

			instruccion = "create temporary table productosaux ( \
				producto varchar(8), present varchar(255), \
				INDEX(producto, present)) Engine = InnoDB";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("insert into productosaux (producto, present) \
				SELECT a.producto, a.present FROM movalma m \
				INNER JOIN dmovalma d ON m.movimiento=d.movimiento \
				INNER JOIN articulos a ON d.articulo=a.articulo \
				INNER JOIN productos p ON p.producto=a.producto \
				WHERE %s %s %s %s m.fechamov BETWEEN '%s' AND '%s' AND m.cancelado=0 AND m.aplica=1 AND m.concepto in (%s) \
				GROUP BY a.producto, a.present", condicion_producto_aux,
				condicion_clasif1_aux, condicion_clasif2_aux,
				condicion_clasif3_aux, fecha_inicial, fecha_final, conceptos);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			join_productos_aux =
				" inner join productosaux paux on paux.producto=pc.producto and paux.present=pc.present ";
			forzar_indice = "FORCE INDEX(PRIMARY)";
		}
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" and pc.almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		if (movimiento != " ") {
			condicion_movimiento.sprintf(" and pc.referencia='%s' ",
			movimiento);
		}
		if (movimiento != " ") {
			// Crea condición para restringirse a los productos y presentaciones del movimiento,
			// para evitar calcular de más.
			AnsiString producto_en_mov, present_en_mov,
			condicion_presentacion_mov;
			AnsiString cad_conjunto_present = "";

			instruccion.sprintf("SELECT a.producto, a.present FROM dmovalma dm \
				INNER JOIN articulos a ON dm.articulo=a.articulo \
				WHERE dm.movimiento='%s' \
				GROUP BY a.producto, a.present", movimiento);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_present_en_mov);
			for (i = 0; i < resp_present_en_mov->ObtieneNumRegistros(); i++) {
				resp_present_en_mov->IrAlRegistroNumero(i);
				producto_en_mov = resp_present_en_mov->ObtieneDato("producto");
				present_en_mov = resp_present_en_mov->ObtieneDato("present");

				if (i == 0)
					cad_conjunto_present += "(";

				cad_conjunto_present += "('";
				cad_conjunto_present += producto_en_mov;
				cad_conjunto_present += "','";
				cad_conjunto_present += present_en_mov;
				cad_conjunto_present += "')";

				if (i < resp_present_en_mov->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						cad_conjunto_present += ",";
				else
					cad_conjunto_present += ")";
			}
			condicion_presentacion_mov.sprintf
				(" (pc.producto, pc.present) in %s and ", cad_conjunto_present);

			// Concatena la condición resultante a la condición de la presentación.
			condicion_presentacion += condicion_presentacion_mov;
			forzar_indice = "FORCE INDEX(NOMPRODUCTO)";
		}
		if (registra_costomov) {
			archivo_temp_mov = mServidorVioleta->ObtieneArchivoTemp(99,
				Respuesta->Id);
			FStream1 = new TFileStream(archivo_temp_mov,
				fmCreate | fmShareDenyNone);
		}

		mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
			mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*2) + "] bytes",
			Respuesta->Id);
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP*2);

		int rr_tam_respuesta;
		char *rr_aux_resultado = Respuesta->BufferResultado;
		int *rr_aux_tam = (int *)rr_aux_resultado;
		rr_aux_resultado += sizeof(int);
		// Nos saltamos la parte del tamaño del resultado.
		rr_aux_resultado = mFg.AgregaPCharABuffer("0", rr_aux_resultado);
		// No hubo error
		rr_tam_respuesta = rr_aux_resultado - Respuesta->BufferResultado;
		*rr_aux_tam = rr_tam_respuesta -sizeof(int);
		Respuesta->TamBufferResultado = rr_tam_respuesta;

		respuesta = Respuesta->BufferResultado +
			Respuesta->TamBufferResultado; // Allì vamos a poner el resultado
		aux = respuesta;
		tam_respuesta = (int *)aux;
		// Obtenemos la direccion donde se va a poner el tamaño del resultado
		aux += sizeof(int);
		num_filas = (int *)aux;
		// Obtenemos la direccion donde se va a poner el número de registros
		(*num_filas) = 0;
		aux += sizeof(int);

		// Obtiene la lista de nombres de productos
		lista_productos->Sorted = true;
		instruccion = "select producto, nombre from productos";
		if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_prod, TAM_MAX_BUFFER_RESPUESTA_MIN)) {
			for (i = 0; i < resp_prod->ObtieneNumRegistros(); i++) {
				resp_prod->IrAlRegistroNumero(i);
				lista_productos->AddObject(resp_prod->ObtieneDato("producto"),
					(TObject *)(resp_prod->ObtienePunteroDato("nombre")));
			}
		}

		// **********************************************************************************************

		instruccion.sprintf("select pmm.producto, pmm.present, pmm.minimo, pmm.maximo \
			from precalculominmaxfin%s pmm \
			order by pmm.minimo", idEmpresa);
		if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_bloques))
			throw Exception
				("Error en select precalculominmaxfin%s de ID_EJE_REPCOSTOMOVALM"
				);

		for (x = 0; x < resp_bloques->ObtieneNumRegistros() - 1; x++) {
			resp_mov = NULL;
			iterador = NULL;

			resp_bloques->IrAlRegistroNumero(x);
			minimo = resp_bloques->ObtieneDato("minimo");

			resp_bloques->IrAlRegistroNumero(x + 1);
			minimo2 = resp_bloques->ObtieneDato("minimo");
			maximo2 = resp_bloques->ObtieneDato("maximo");

			if (x < resp_bloques->ObtieneNumRegistros() - 2) {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<%s ",
					minimo, minimo2);
			}
			else {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<=%s ",
					minimo, maximo2);
			}

			try {
				// Manda el resultado a un buffer
				instruccion.sprintf("select pc.producto, pc.present, pc.clasif, pc.tipo, \
					if((pc.tipo='EC' or pc.tipo='ES' or pc.tipo='SA') and pc.fecha>='%s' and pc.fecha<='%s' %s %s %s %s, 'S', 'N') as considerar, \
					pc.cantidad, pc.costounit, pc.referencia, pc.almacen \
					from precalculocostos%s pc %s \
					%s \
					where %s and %s %s %s %s %s fecha<='%s' \
					order by id", fecha_inicial, fecha_final, condicion_tipomov,
					condicion_conceptos, condicion_almacen,
					condicion_movimiento, idEmpresa, forzar_indice, join_productos_aux,
					condicion_rango_productos, condicion_clasif1,
					condicion_clasif2, condicion_clasif3, condicion_producto,
					condicion_presentacion, fecha_final);

				if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_mov, buffer_resp_mov)) {
					mServidorVioleta->MuestraMensaje
						("-- Finalizó mandar resultados a buffer [" +
						mFg.IntToAnsiString(resp_mov->ObtieneTamRespuesta()) +
						"] bytes", Respuesta->Id);
					// Crea objeto iterador
					iterador = new IteradorCostos(resp_mov);

					mServidorVioleta->MuestraMensaje
						("-- Finalizó creación de iterador", Respuesta->Id);

					indice_producto = resp_mov->ObtieneIndiceCampo("producto");
					indice_present = resp_mov->ObtieneIndiceCampo("present");
					indice_clasif = resp_mov->ObtieneIndiceCampo("clasif");
					indice_considerar =
						resp_mov->ObtieneIndiceCampo("considerar");
					indice_cantidad = resp_mov->ObtieneIndiceCampo("cantidad");
					indice_costounit = resp_mov->ObtieneIndiceCampo("costounit");
					indice_tipo = resp_mov->ObtieneIndiceCampo("tipo");

					if (registra_costomov) {
						indice_mov = resp_mov->ObtieneIndiceCampo("referencia");
						indice_almacen = resp_mov->ObtieneIndiceCampo("almacen");
					}

					// producto_anterior se usa para que en cada registro saber que
					// producto era el registro anterior
					producto_anterior = "";

					// present_anterior se usa para en cada registro saber que
					// presentación era el registro anterior
					present_anterior = "";

					// acum_cantidad se usa para en cada registro saber
					// la sumatoria de la cantidad del último producto-presentación
					// en global (todos los almacenes)
					acum_cantidad = 0;

					// acum_costo se usa para en cada registro saber
					// la sumatoria del costo acumulado del último producto-presentación
					// en global (todos los almacenes)
					acum_costo = 0;

					// acum_cantmov se usa para en cada registro saber
					// la sumatoria de la cantidad de movimientos del último producto-presentación
					acum_cantmov = 0;

					// acum_costomov se usa para en cada registro saber
					// la sumatorio del costo acumulado de movimientos del último producto-presentación
					acum_costomov = 0;

					// Costo promedio hasta el último producto-presentacion
					costoprom = 0;

					// Ciclo para calcular los costos.
					i = 0;
					do {
						hay_pendientes = iterador->IrRegistroPendiente();
						estado_iteracion = iterador->ObtieneEstadoIteracion();

						// Si i está dentro del rango válido nos posicionamos en el registro(i)
						// y obtenemos el producto y presentación de dicho registro
						if (hay_pendientes) {
							producto_actual =
								resp_mov->ObtienePunteroDatoEnIndice
								(indice_producto);
							present_actual =
								resp_mov->ObtienePunteroDatoEnIndice
								(indice_present);
						}

						// Si ya pasamos el ultimo registro o el producto-presentacion es diferente
						// entonces manda los datos acumulados al cliente.
						if ((!hay_pendientes) ||
							(producto_actual != producto_anterior ||
							present_actual != present_anterior)) {
							// Si no es el primer registro
							if (i > 0 && (!mFg.EsCero(acum_cantmov) ||
								!mFg.EsCero(acum_costomov))) {
								// Entonces manda los datos al cliente
								nombre_producto =
									(char *)lista_productos->Objects
									[lista_productos->IndexOf
									(producto_anterior)];
								aux = mFg.AgregaStringABuffer
									(nombre_producto, aux);
								aux = mFg.AgregaStringABuffer
									(present_anterior, aux);
								aux = mFg.AgregaStringABuffer
									(producto_anterior, aux);

								aux = mFg.AgregaStringABuffer
									(FloatToStr(acum_cantmov), aux);
								aux = mFg.AgregaStringABuffer
									(FloatToStr(acum_costomov), aux);

								(*num_filas)++;
							}
						}

						if (hay_pendientes) {
							tipo_actual = resp_mov->ObtienePunteroDatoEnIndice(indice_tipo);
							clasif_actual =
								*(resp_mov->ObtienePunteroDatoEnIndice
								(indice_clasif));
							// Solo se ocupa el primer caracter de la clasificación (siempre es solo un caracter)
							considerar_actual =
								resp_mov->ObtienePunteroDatoEnIndice
								(indice_considerar);

							if (registra_costomov) {
								almacen_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_almacen);
								movimiento_actual =
									resp_mov->ObtienePunteroDatoEnIndice
									(indice_mov);
							}
							if (clasif_actual == 'A') {
								cantidad_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL);
								costounit_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_costounit), NULL);
								costotot_actual =
									cantidad_actual * costounit_actual;
							}
							if (clasif_actual == 'B') {
								cantidad_actual = 0;
								costounit_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_costounit), NULL);
								costotot_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL) * costounit_actual;
							}
							if (clasif_actual == 'C') {
								cantidad_actual =
									strtod(resp_mov->ObtienePunteroDatoEnIndice
									(indice_cantidad), NULL);
								costounit_actual = costoprom;
								costotot_actual =
									cantidad_actual * costounit_actual;
							}

							// Si es un producto-presentacion DIFERENTE al anterior
							if ((producto_actual != producto_anterior ||
								present_actual != present_anterior)) {

								// Asigna los datos del registro actual a las variables
								// usadas para registro anterior, esto en preparación
								// para el siguiente ciclo.
								producto_anterior = producto_actual;
								present_anterior = present_actual;

								if(tipo_actual == "BA")
									costoprom = costounit_actual;
								else
									costoprom = 0;

								acum_cantidad = 0;
								acum_costo = 0;
								acum_cantmov = 0;
								acum_costomov = 0;

								iterador->IniciaOtroProductoPresentacion();
							}

							// si alguno de los acumulados podría dar negativo entonces
							// se ignora el registro actual, pero se acumula para posterior
							// aplicación cuando haya el positivo suficiente
							if ((acum_cantidad + cantidad_actual) <
								0 || (acum_costo + costotot_actual) < 0) {
								// Si se generó un negativo

								// Si se no terminaron los registros y no esta en modo
								// de  forzar pendientes entonces se marca como no aplicado
								// para que se almacene en los pendientes.
								if (iterador->
									ObtieneEstaTerminadaIteracionNormal()
									== false &&
									iterador->ObtieneForzarPendientes()
									== false) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								}
								else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}
							else {
								// No se generó un negativo

								// Si es iteracion normal y además
								// mov actual disminuye costo o existencias y
								// además hay pendientes de aplicar ENTONCES se les da prioridad
								// a los pendientes y el mov actual se pone como no
								// aplicado hasta el final de las lista de pendientes.
								if (estado_iteracion == 0 && (cantidad_actual <
									0 || costotot_actual < 0)
									&& iterador->ObtieneNumRealNoAplicados
									() > 0) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								}
								else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}

							// Totaliza tomando en cuenta el registro actual
							if (aplicar_costo) {
								acum_cantidad = acum_cantidad + cantidad_actual;
								acum_costo = acum_costo + costotot_actual;
								if (considerar_actual == "S") {
									acum_cantmov =
										acum_cantmov + cantidad_actual;
									acum_costomov =
										acum_costomov + costotot_actual;
								}
								if (!mFg.EsCero(acum_cantidad))
									costoprom = acum_costo / acum_cantidad;
								// else costoprom=0;

								if (registra_costomov) {
									// Guardar en archivo temporal
									if (!mFg.EsCero(cantidad_actual)) {
										if (considerar_actual == "S") {
										cadena =
										almacen_actual + "\t" +
										movimiento_actual + "\t" +
										producto_actual + "\t" +
										present_actual + "\t" +
										AnsiString(cantidad_actual) + "\t" +
										(costotot_actual) + "\n";
										FStream1->Write(cadena.c_str(),
										cadena.Length());
										}
									}
								}
							}
						}
						i++;
					}
					while (hay_pendientes);

				}
				else
					throw Exception
						("Error en select precalculocostos%s de ID_EJE_REPCOSTOMOVALM"
						);

			}
			__finally {
				if (iterador != NULL) {
					delete iterador;
					iterador = NULL;
				}
				if (resp_mov != NULL) {
					delete resp_mov;
					resp_mov = NULL;
				}
			}
		}
		// **********************************************************************************************

		if (registra_costomov) {
			instruccion.sprintf("SET SESSION sql_log_bin=0");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("truncate table precalculocostosmovalmadet");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE precalculocostosmovalmadet (almacen, movimiento, producto, present, cantidad, costomov) ",
				archivo_temp_mov);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("truncate table precalculocostosmovalma");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("insert into precalculocostosmovalma (movimiento, costomov) \
				select p.movimiento, sum(p.costomov) as costomov \
					from precalculocostosmovalmadet p \
				group by movimiento");

			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("SET SESSION sql_log_bin=1");
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));
		}

		// Establece el tamaño de la respuesta.
		*tam_respuesta = (aux - respuesta);
		Respuesta->TamBufferResultado = Respuesta->TamBufferResultado +
			*tam_respuesta; // Calcula tamaño total de buffer
		Respuesta->PosBufferResultado = 0;
		// Los resultados al cliente serán a partir del inicio del buffer.
	}
	__finally {
		if (FStream1 != NULL) {
			delete FStream1;
			mServidorVioleta->BorraArchivoTemp(archivo_temp_mov);
		}
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_mov != NULL)
			delete resp_mov;
		if (resp_prod != NULL)
			delete resp_prod;
		if (resp_bloques != NULL)
			delete resp_bloques;
		if (resp_present_en_mov != NULL)
			delete resp_present_en_mov;
		if (buffer_resp_mov != NULL)
			delete buffer_resp_mov;
		delete lista_productos;
	}
}

// ---------------------------------------------------------------------------

// ID_EJE_REPCOMPARAPEDVENT
void ServidorReportes::EjecutaRepComparaPedVent(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion, instrucciones[1000];
	int num_instrucciones = 0;
	AnsiString sucursal, fechaini, fechafin, cliente, vendedor, producto;
	AnsiString solo_diferencias, existencias, solo_con_embarque, solo_con_venta;
	AnsiString condicion_sucursal = " ", condicion_cliente = " ",
		condicion_vendedor = " ", condicion_producto = " ";
	AnsiString condicion_solo_con_embarque = " ",
		condicion_solo_con_venta = " ";
	AnsiString almacen, cad_conjunto_almacenes = " ", condicion_almacen = " ";
	BufferRespuestas* resp_almacenes = NULL;
	AnsiString instruccion_sin_diferencias = " ", cantmax, cantmin,
		cantexistencia, instruccion_join_precalculocostos;
	AnsiString partes_relacionadas, condicion_partes_relacionadas = " ";
	AnsiString condicion_supervisado_por = " ", supervisado_por = " ",
		instruccion_join_supervisado = " ";

	AnsiString idEmpresa = " ";

	try {
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		solo_diferencias = mFg.ExtraeStringDeBuffer(&parametros);
		existencias = mFg.ExtraeStringDeBuffer(&parametros);

		solo_con_embarque = mFg.ExtraeStringDeBuffer(&parametros);
		partes_relacionadas = mFg.ExtraeStringDeBuffer(&parametros);
		solo_con_venta = mFg.ExtraeStringDeBuffer(&parametros);
		supervisado_por = mFg.ExtraeStringDeBuffer(&parametros);

        idEmpresa = FormServidor->ObtieneClaveEmpresa();

		if (solo_con_venta != " ") {
			if (solo_con_venta == "1")
				condicion_solo_con_venta = " and t2.venta is not null ";
			else
				condicion_solo_con_venta = " and t2.venta is null ";

		}

		if (solo_con_embarque != " ") {
			if (solo_con_embarque == "1")
				condicion_solo_con_embarque =
					" and (pv.embarque IS NOT NULL and pv.embarque<>'') ";
			else
				condicion_solo_con_embarque =
					" and (pv.embarque IS NULL) ";
		}

		if (partes_relacionadas != " ") {
			if (partes_relacionadas == "1")
				condicion_partes_relacionadas = " and c.esparterelac=1 ";
			else
				condicion_partes_relacionadas = " and c.esparterelac=0 ";
		}

		if (sucursal != " ") {
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
				INNER JOIN secciones s ON a.seccion=s.seccion \
				WHERE s.sucursal='%s'", sucursal);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_almacenes);
			for (int i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
				resp_almacenes->IrAlRegistroNumero(i);
				almacen = resp_almacenes->ObtieneDato("almacen");

				cad_conjunto_almacenes += "'";
				cad_conjunto_almacenes += almacen;
				cad_conjunto_almacenes += "'";
				if (i < resp_almacenes->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						cad_conjunto_almacenes += ",";
			}
			condicion_almacen.sprintf(" AND pcc2.almacen IN (%s) ",
				cad_conjunto_almacenes);
			condicion_sucursal.sprintf(" and s.sucursal='%s' ", sucursal);
		}
		else
			throw Exception
				("Se requiere una sucursal en ID_EJE_REPCOMPARAPEDVENT");

		if (cliente != " ") {
			condicion_cliente.sprintf(" and pv.cliente='%s' ", cliente);
		}
		if (vendedor != " ") {
			condicion_vendedor.sprintf(" and pv.vendedor='%s' ", vendedor);
		}
		if (producto != " ") {
			condicion_producto.sprintf(" and a.producto='%s' ", producto);
		}

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (int i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			if (existencias == "1") {
				// Se calculan existencias al dia de la venta usando la tabla de precalculo de costos.
				instruccion_join_precalculocostos.sprintf("	LEFT JOIN precalculocostos%s pcc2 \
						 ON t2.cantpedido<>t2.cantventa \
						 AND pcc2.producto = t2.producto \
						 AND pcc2.present = t2.present \
						 AND pcc2.clasif IN ('A', 'C') \
						 AND pcc2.fecha < t2.fechaped \
						 %s ", idEmpresa, condicion_almacen);
				cantmax =
					"TRUNCATE(SUM(IFNULL(pcc2.cantidad,0))/pmm.maxfactor,0) ";
				cantmin =
					"ROUND(MOD((SUM(IFNULL(pcc2.cantidad,0))),pmm.maxfactor)) ";
				cantexistencia = "SUM(IFNULL(pcc2.cantidad,0))";
			}
			else {
				// No se calculan existencias.
				instruccion_join_precalculocostos = " ";
				cantmax = "0.0";
				cantmin = "0.0";
				cantexistencia = "0.0";
			}

			if (solo_diferencias == "1") {
				// Solo los diferentes.
				instruccion_sin_diferencias = " HAVING cantventa<>cantpedido ";
			}
			else {

				// Se incluyen sin importar si son diferentes o no.
				instruccion_sin_diferencias = " ";

			}

			if (supervisado_por != " ") {
				condicion_supervisado_por.sprintf(" AND ars.usuario = '%s'  ",
					supervisado_por);
				instruccion_join_supervisado.sprintf
					(" INNER JOIN articulossupervisados ars ON ars.producto=t2.producto "
					);
			}

			instruccion.sprintf(" \
					SELECT t2.pedido, t2.venta, \
					t2.fechaped, t2.fechavta, p.nombre,t2.present, \
					CONCAT(pmm.maxmult,'X',pmm.maxfactor) multmax, \
					CONCAT(pmm.minmult,'X','1') multmin, \
					%s as cantmax, \
					%s as cantmin, \
					t2.cantpedido/pmm.maxfactor AS cantpedori , \
					TRUNCATE(t2.cantpedido/pmm.maxfactor,0) cantpedmax, \
					ROUND(MOD((t2.cantpedido),pmm.maxfactor)) cantpedmin, \
					TRUNCATE(t2.cantventa/pmm.maxfactor,0) cantvtamax, \
					ROUND(MOD((t2.cantventa),pmm.maxfactor)) cantvtamin, \
					if(t2.cantventa>t2.cantpedido or t2.cantpedido=0, 1, (t2.cantventa/t2.cantpedido)) as fillrate, \
					c.cliente, \
					c.rsocial, \
					t2.precio_venta, t2.precio_total_ped, \
					((t2.precio_total_ped/t2.cantpedido)*pmm.maxfactor) AS precio_multi_mayor, \
					CONCAT(e.nombre,' ',e.appat,' ',e.apmat) as vendedor, \
					%s as cantexistencia, t2.cantpedido, t2.cantventa, t2.producto, amax.articulo,t2.embarque, \
					IF(t2.cotizacion=1, 'COTIZACION', 'PEDIDO') AS tipo, \
					TRUNCATE(t2.cantpedido/pmm.cajalogisticafactor,3) AS pedcajaslogis, \
					TRUNCATE(t2.cantventa/pmm.cajalogisticafactor,3) AS ventcajaslogis \
				FROM ( \
					SELECT venta, pedido, \
					  fechaped, fechavta, cliente, producto, \
					  present, \
					  sum(cantpedido) as cantpedido, sum(cantventa) as cantventa, \
					  max(precio_venta) as precio_venta, MAX(precio_pedido) AS precio_pedido, \
					  vendedor, sucursal, embarque, cotizacion, MAX(precio_total_ped) AS precio_total_ped \
					  from ( \
						(SELECT v.referencia as venta, \
						pv.referencia as pedido, \
						pv.fechaped, v.fechavta, pv.cliente, a.producto, \
						a.present, \
						0.000 as cantpedido, (dv.cantidad*a.factor) as cantventa, \
						dv.precioimp as precio_venta, 0.000 AS precio_pedido, \
						pv.vendedor, s.sucursal,pv.embarque,pv.cotizacion, \
                        0.000 AS precio_total_ped \
						FROM pedidosventa pv FORCE INDEX(fechaped) \
						INNER JOIN ventas v ON v.referencia=pv.venta AND v.cancelado=0 \
						INNER JOIN dventas dv ON dv.referencia=v.referencia \
						INNER JOIN articulos a ON a.articulo=dv.articulo \
						INNER JOIN terminales t ON t.terminal=pv.terminal \
						INNER JOIN secciones s ON s.seccion=t.seccion \
						WHERE pv.fechaped>='%s' AND pv.fechaped<='%s' and pv.cancelado=0 \
						%s %s %s %s %s \
						) \
					UNION \
						(SELECT v.referencia as venta, \
						pv.referencia as pedido, \
						pv.fechaped, v.fechavta, pv.cliente, a.producto, \
						a.present, \
						(dpv.cantidad*a.factor) as cantpedido, 0.000 as cantventa, \
						0.00 as precio_venta, dpv.precioimp AS precio_pedido, \
						pv.vendedor, s.sucursal,pv.embarque,pv.cotizacion, \
						(dpv.precioimp * dpv.cantidad) AS precio_total_ped \
						FROM pedidosventa pv FORCE INDEX(fechaped) \
						LEFT JOIN ventas v ON v.referencia=pv.venta AND v.cancelado=0 \
						INNER JOIN dpedidosventa dpv ON dpv.referencia=pv.referencia \
						INNER JOIN articulos a ON a.articulo=dpv.articulo \
						INNER JOIN terminales t ON t.terminal=pv.terminal \
						INNER JOIN secciones s ON s.seccion=t.seccion \
						WHERE pv.fechaped>='%s' AND pv.fechaped<='%s' and pv.cancelado=0 \
						%s %s %s %s %s \
						) \
					) a2 \
					GROUP BY a2.pedido,a2.producto,a2.present \
					%s \
				) t2 \
				%s \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=t2.producto AND pmm.present=t2.present \
				INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
				INNER JOIN productos p ON p.producto=t2.producto \
				INNER JOIN empleados e ON e.empleado=t2.vendedor  \
				INNER JOIN clientes c ON c.cliente=t2.cliente %s %s \
				WHERE 1 %s %s \
				GROUP BY t2.pedido,t2.producto,t2.present \
				ORDER BY fechaped, pedido, producto, present", cantmax, cantmin,
				cantexistencia, fechaini, fechafin, condicion_sucursal,
				condicion_solo_con_embarque, condicion_cliente,
				condicion_vendedor, condicion_producto, fechaini, fechafin,
				condicion_sucursal, condicion_solo_con_embarque,
				condicion_cliente, condicion_vendedor, condicion_producto,
				instruccion_sin_diferencias, instruccion_join_precalculocostos,
				condicion_partes_relacionadas, instruccion_join_supervisado,
				condicion_solo_con_venta,condicion_supervisado_por);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------

// ID_EJE_REPEMBARQUES
void ServidorReportes::EjecutaReporteEmbarques(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaini, fechafin, embarque, producto, tipo, via, chofer;
	AnsiString inner_ventas, condicion_embarque, condicion_producto,
		condicion_via, condicion_chofer;

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	embarque = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	via = mFg.ExtraeStringDeBuffer(&parametros);
	chofer = mFg.ExtraeStringDeBuffer(&parametros);

	if (tipo == "1") {
		inner_ventas =
			" INNER JOIN ventas ON pedidosventa.venta=ventas.referencia ";
	}
	else {
		inner_ventas = " ";
	}
	if (embarque != "") {
		condicion_embarque.sprintf(" AND embarques.embarque='%s' ", embarque);
	}
	else {
		condicion_embarque = " ";
	}
	if (producto != "") {
		condicion_producto.sprintf(" AND articulos.producto='%s' ", producto);
	}
	else {
		condicion_producto = " ";
	}
	if (via != "") {
		condicion_via.sprintf(" AND embarques.viaembarq='%s' ", via);
	}
	else {
		condicion_via = " ";
	}
	if (chofer != "") {
		condicion_chofer.sprintf(" AND embarques.chofer='%s' ", chofer);
	}
	else {
		condicion_chofer = " ";
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT embarques.embarque,                                     \
		IFNULL(embarques.fechasalid,'') fechasalid,                                     \
		viasembarque.viaembarq,                                                         \
		viasembarque.descripcion,                                                       \
        empleados.empleado,                                                             \
		CONCAT(empleados.nombre,' ',empleados.appat,' ',empleados.apmat) chofer,        \
		viasembarque.placas,                                                            \
		FORMAT(viasembarque.capacidad,2) capacidad,                                     \
		FORMAT(SUM(dpedidosventa.cantidad*articulos.peso),2) peso,                      \
		sectores.nombre,                                                                \
		IFNULL(embarques.fecharecep,'') fecharecep,                                     \
		IFNULL(embarques.horarecep,'') horarecep                                        \
		FROM embarques                                                                  \
		INNER JOIN pedidosventa ON pedidosventa.embarque = embarques.embarque 			\
		LEFT JOIN dpedidosventa ON dpedidosventa.referencia=pedidosventa.referencia 	\
		LEFT JOIN articulos ON articulos.articulo=dpedidosventa.articulo 				\
		LEFT JOIN empleados ON empleados.empleado=embarques.chofer 						\
		LEFT JOIN viasembarque ON viasembarque.viaembarq=embarques.viaembarq 			\
		LEFT JOIN clientes ON clientes.cliente=pedidosventa.cliente 					\
		LEFT JOIN colonias ON colonias.colonia=clientes.colonia 						\
		LEFT JOIN sectores ON sectores.sector=colonias.sector 							\
		%s \
		WHERE embarques.cancelado=0 AND embarques.fechasalid>='%s' AND embarques.fechasalid<='%s' \
		%s %s %s %s \
        AND embarques.sucursal IN (SELECT sucursal FROM sucursales  WHERE idempresa = %s) \
		GROUP BY embarques.embarque", inner_ventas, fechaini, fechafin,
		condicion_embarque, condicion_producto, condicion_via,
		condicion_chofer, FormServidor->ObtieneClaveEmpresa());

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------

// ID_EJE_REPEMBARQUES_DESGL
void ServidorReportes::EjecutaReporteEmbarquesDesglosado
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, sector, clv_embarque, clv_via,
		clv_chofer;
	AnsiString cond_suc, cond_sector, cond_embarque, cond_via, cond_chofer;
	AnsiString desviacionEntrega;
	AnsiString having_desviacionEntrega = " ", cond_desviacionEntrega = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	sector = mFg.ExtraeStringDeBuffer(&parametros);
	clv_embarque = mFg.ExtraeStringDeBuffer(&parametros);
	clv_via = mFg.ExtraeStringDeBuffer(&parametros);
	clv_chofer = mFg.ExtraeStringDeBuffer(&parametros);
	desviacionEntrega = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal == "") {
		cond_suc.sprintf(" AND emb.sucursal IN (SELECT sucursal FROM sucursales  WHERE idempresa = %s) ", FormServidor->ObtieneClaveEmpresa());
	}
	else {
		cond_suc.sprintf(" AND emb.sucursal='%s' ", sucursal);
	}

	if (sector == "") {
		cond_sector = " ";
	}
	else {
		cond_sector.sprintf(" AND sec.sector='%s' ", sector);
	}

	if (clv_embarque == "") {
		cond_embarque = " ";
	}
	else {
		cond_embarque.sprintf(" AND p.embarque='%s' ", clv_embarque);
	}

	if (clv_via == "") {
		cond_via = " ";
	}
	else {
		cond_via.sprintf(" AND emb.viaembarq='%s' ", clv_via);
	}

	if (clv_chofer == "") {
		cond_chofer = " ";
	}
	else {
		cond_chofer.sprintf(" AND emb.chofer='%s' ", clv_chofer);
	}

	if (desviacionEntrega == "1") {
		cond_desviacionEntrega =
			" AND (IFNULL((FORMAT(X(er.ubicaciondellegada),6)), 0)<>0 OR IFNULL((FORMAT(X(er.ubicaciondesalida),6)),0)<>0) ";
		having_desviacionEntrega = " HAVING llegada_mt >= 300 ";
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT p.embarque, emb.fechasalid AS fecha_creacion_embarque,  \
		p.referencia as pedido,                                             \
		p.fechaalta as fecha_alta_pedido,                                   \
		p.horaalta,p.venta, v.fechavta, v.horavta, \
		sec.nombre as nombre_sector,                                        \
		SUM(dp.cantidad*((dp.precioimp/if(dp.claveimp2>0, 1+i2.porcentaje/100,1))/if(dp.claveimp1>0, (1+i1.porcentaje/100),1))) AS subtotal, \
		SUM((dp.cantidad*a.factor)/pmm.maxfactor) AS tot_cajas_bultos, \
		SUM(a.peso*dp.cantidad) AS peso,                                  \
		SUM(a.volumen*dp.cantidad) AS volumen,                            \
		vem.placas,                                                         \
		emb.viaembarq,                                                      \
		vem.descripcion,                                                     \
		emb.chofer,														    \
		CONCAT(empv.nombre,' ',empv.appat,' ',empv.apmat ) chofernombre,    \
		p.cliente,                                                          \
		IFNULL( (FORMAT(X(pde.ubicaciongis),6)) ,0) latcliente,   	  			\
		IFNULL( (FORMAT(Y(pde.ubicaciongis),6)) ,0) longcliente,		    		\
		er.referenciadomic,                                                 \
		(SELECT CONCAT(nombre,' ',appat,' ',apmat)  FROM empleados exs WHERE exs.empleado=er.choferllega), \
		(SELECT CONCAT(nombre,' ',appat,' ',apmat)  FROM empleados exl WHERE exl.empleado=er.chofersale), \
		COALESCE(er.fechadesalida,emb.fechasalid) AS fecha_entrega_al_cliente ,     \
		er.horadellegada,                                                   \
		er.horadesalida,                                                    \
		IFNULL( (FORMAT(X(er.ubicaciondellegada),6)) , 0) latllegada,   	  	  	\
		IFNULL( (FORMAT(Y(er.ubicaciondellegada),6)) ,0)  longllegada,		   	\
		IFNULL( (FORMAT(X(er.ubicaciondesalida),6)) ,0) latlsalida,   	  	  	\
		IFNULL( (FORMAT(Y(er.ubicaciondesalida),6)) ,0)  longsalida,		   		\
		TRUNCATE(IFNULL((111.111 \
		* DEGREES(ACOS(LEAST(1.0, COS(RADIANS(IFNULL((FORMAT(X(er.ubicaciongis),6)) ,0))) \
		* COS(RADIANS(IFNULL((FORMAT(X(er.ubicaciondellegada),6)) , 0))) \
		* COS(RADIANS(IFNULL((FORMAT(Y(er.ubicaciongis),6)) ,0) - IFNULL((FORMAT(Y(er.ubicaciondellegada),6)) ,0))) \
		+ SIN(RADIANS(IFNULL((FORMAT(X(er.ubicaciongis),6)) ,0))) \
		* SIN(RADIANS(IFNULL((FORMAT(X(er.ubicaciondellegada),6)) , 0))))))*1000),0),0) AS  llegada_mt, \
		TRUNCATE(IFNULL((111.111 \
		* DEGREES(ACOS(LEAST(1.0, COS(RADIANS(IFNULL((FORMAT(X(er.ubicaciongis),6)) ,0))) \
		* COS(RADIANS(IFNULL((FORMAT(X(er.ubicaciondesalida),6)) ,0))) \
		* COS(RADIANS(IFNULL((FORMAT(Y(er.ubicaciongis),6)) ,0) - IFNULL((FORMAT(Y(er.ubicaciondesalida),6)) ,0))) \
		+ SIN(RADIANS(IFNULL((FORMAT(X(er.ubicaciongis),6)) ,0))) \
		* SIN(RADIANS(IFNULL((FORMAT(X(er.ubicaciondesalida),6)) ,0))))))*1000),0),0) AS salida_mt, \
		er.etapa,                                                           \
		er.observacioneschofer                                              \
		FROM pedidosventa p                                                 \
		LEFT JOIN pedidosdirent AS pde  ON pde.referencia = p.referencia    \
		LEFT JOIN embarquesruta AS er   ON er.embarque = p.embarque  AND er.cliente=pde.cliente AND er.calle=pde.calle AND er.numext=pde.numext   \
		INNER JOIN clientes c ON c.cliente = p.cliente                      \
		INNER JOIN colonias col ON col.colonia = COALESCE(pde.colonia,c.colonia)  \
		INNER JOIN sectores sec ON sec.sector = col.sector                  \
		INNER JOIN dpedidosventa dp ON dp.referencia = p.referencia         \
		INNER JOIN articulos a ON a.articulo=dp.articulo                    \
		INNER JOIN embarques emb ON emb.embarque=p.embarque                 \
		inner join presentacionesminmax pmm on pmm.producto=a.producto and pmm.present=a.present  \
		left join impuestos i1 on i1.impuesto=dp.claveimp1 \
		left join impuestos i2 on i2.impuesto=dp.claveimp2 \
		LEFT JOIN empleados  AS empv ON empv.empleado=emb.chofer            \
		LEFT JOIN viasembarque  AS vem ON vem.viaembarq = emb.viaembarq     \
		LEFT JOIN ventas v ON v.referencia=p.venta \
		WHERE emb.fechasalid >= '%s'  AND emb.fechasalid <= '%s' AND p.cancelado=0 \
		%s %s %s %s %s %s\
		GROUP BY p.referencia %s ORDER BY p.embarque, pedido, emb.fechasalid desc, sec.nombre, peso, volumen "
		, fechaini, fechafin, cond_suc, cond_sector, cond_embarque, cond_via,
		cond_chofer, cond_desviacionEntrega, having_desviacionEntrega);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------

// ID_ENVIOCFD
void ServidorReportes::EjecutaEnvioCorreo(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString email, email2, bodyMsg, idEnvio, nomPDF, nomAdj;
	AnsiString pdf64, xml64, adj64;
	BufferRespuestas* resp_envio = NULL;

	AnsiString nomremitente, emailcfd, hostsmtp, portsmtp, usersmtp, passsmtp;
	BufferRespuestas* resp_config_cfd = NULL;

	idEnvio = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT cc.pdf, cc.nombrepdf, cc.adjunto, \
		cc.nombreadjunto, cc.mensaje, cc.email, cc.email2, cfdxml.xmlgenerado \
		FROM cfdcorreos cc \
			inner join cfdxml on cc.compfiscal=cfdxml.compfiscal \
		WHERE cc.idcfdcorreos=%s ", idEnvio);

	if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
		instruccion.c_str(), resp_envio))
		throw Exception("ERROR AL CONSULTAR!");

	for (int i = 0; i < resp_envio->ObtieneNumRegistros(); i++) {
		resp_envio->IrAlRegistroNumero(i);
		pdf64 = resp_envio->ObtieneDato("pdf");
		nomPDF = resp_envio->ObtieneDato("nombrepdf");
		adj64 = resp_envio->ObtieneDato("adjunto");
		nomAdj = resp_envio->ObtieneDato("nombreadjunto");
		bodyMsg = resp_envio->ObtieneDato("mensaje");
		email = resp_envio->ObtieneDato("email");
		email2 = resp_envio->ObtieneDato("email2");
		xml64 = resp_envio->ObtieneDato("xmlgenerado");
	}

	// Obtener los streams de los adjuntos
	TMemoryStream *memStreamBMP = NULL, *memStreamXML = NULL,
		*memStreamPDF = NULL;

	// Se envia el CFD al correo del cliente
	TIdMessage *msg = NULL;
	TIdSMTP *smtp = NULL;
	TIdAttachmentMemory *attach_logo = NULL;
	TIdAttachmentMemory *attach_xml = NULL;
	TIdAttachmentMemory *attach_pdf = NULL;
	TIdText *idtext = NULL;
	TIdSSLIOHandlerSocketOpenSSL *IdSSLIOHandlerSocketOpenSSL1 = NULL;

	BufferRespuestas* res_logemailcfd = NULL;
	int logEmailCFD = 0;

	try {
		instruccion.sprintf(
		"SELECT valor FROM parametrosemp where parametro = 'LOGEMAILCFD' AND sucursal = '%s' ",
		FormServidor->ObtieneClaveSucursal());

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,instruccion.c_str(), res_logemailcfd);
		logEmailCFD = res_logemailcfd->ObtieneDato("valor").ToInt();
	}__finally {
		if (res_logemailcfd != NULL)
			delete res_logemailcfd;
	}

	TIdLogFile *IdLogFile1 = NULL;

	try {
		try {
				memStreamXML = new TMemoryStream();
				TBytes bytes_xml64 = DecodeBase64(xml64);
				memStreamXML->WriteBuffer(&bytes_xml64[0], bytes_xml64.Length);
				memStreamXML->Seek(0, soFromBeginning);

				memStreamPDF = new TMemoryStream();
				TBytes bytes_pdf64 = DecodeBase64(pdf64);
				memStreamPDF->WriteBuffer(&bytes_pdf64[0], bytes_pdf64.Length);
				memStreamPDF->Seek(0, soFromBeginning);

				memStreamBMP = new TMemoryStream();
				TBytes bytes_adj64 = DecodeBase64(adj64);
				memStreamBMP->WriteBuffer(&bytes_adj64[0], bytes_adj64.Length);
				memStreamBMP->Seek(0, soFromBeginning);

			// Consulta de parametroscfd
			instruccion.sprintf
				("select p.* from parametroscfd p where p.sucursal='%s'",
				FormServidor->ObtieneClaveSucursal());
			if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_config_cfd))
				throw Exception("ERROR AL CONSULTAR!");
			for (int y = 0; y < resp_config_cfd->ObtieneNumRegistros(); y++) {
				emailcfd = resp_config_cfd->ObtieneDato("emailenviocfd");
				nomremitente = resp_config_cfd->ObtieneDato("nomenviocfd");
				hostsmtp = resp_config_cfd->ObtieneDato("hostsmtp");
				portsmtp = resp_config_cfd->ObtieneDato("portsmtp");
				usersmtp = resp_config_cfd->ObtieneDato("usersmtp");
				passsmtp = resp_config_cfd->ObtieneDato("passsmtp");
			}

			// Configuracion del componente TIdSMTP
			smtp = new TIdSMTP(NULL);
			smtp->MailAgent = "Indy10";
			smtp->PipeLine = false;
			smtp->UseEhlo = true;
			smtp->UseVerp = false;

			if (hostsmtp.Pos("amazon") > 0) {

				IdSSLIOHandlerSocketOpenSSL1 =
					new TIdSSLIOHandlerSocketOpenSSL(NULL);
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Method =
					Idsslopenssl::sslvSSLv23;
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Mode =
					Idsslopenssl::sslmClient;
				smtp->IOHandler = IdSSLIOHandlerSocketOpenSSL1;
				smtp->UseTLS = utUseExplicitTLS;

			}
			else {

				smtp->UseTLS = utNoTLSSupport;

			}

			smtp->ConnectTimeout = (1000 * 30);
			smtp->ReadTimeout = (1000 * 60);

			smtp->AuthType = satDefault;
			smtp->Host = hostsmtp;
			smtp->Username = usersmtp;
			smtp->Password = passsmtp;
			smtp->Port = portsmtp.ToInt();

			// Configuracion del componente TIdMessage
			msg = new TIdMessage(NULL);
			msg->ExceptionOnBlockedAttachments = false;
			msg->NoDecode = false;
			msg->NoEncode = false;
			msg->UseNowForDate = true;

			// Configuracion del componente TIdLogFile
			if(logEmailCFD == 1){
				IdLogFile1 = new TIdLogFile(NULL);
				IdLogFile1->Filename = ExtractFilePath(Application->ExeName) + "\\maillogfile.log";
				IdLogFile1->Active = true;
				IdLogFile1->LogTime = false;
				IdLogFile1->ReplaceCRLF = true;
				smtp->Intercept = IdLogFile1;
			}

			// ENVIO DEL CFD
			msg->Clear();
			msg->MessageParts->Clear();

			msg->From->Address = emailcfd;
			msg->From->Name = nomremitente;
			msg->Sender->Address = emailcfd;
			msg->Sender->Name = nomremitente;
			msg->ReplyTo->EMailAddresses = emailcfd;
			msg->Recipients->EMailAddresses = email;
			if (email2 != "" && email2 != "@" && mFg.ValidaEmail(email2,
				false) && email2 != email)
				msg->CCList->EMailAddresses = email2;
			msg->Priority = mpNormal;
			msg->Subject = "Entrega de su CFDI de La Violeta";
			msg->ContentType = "multipart/mixed";
			msg->ClearBody();
			msg->IsEncoded = true;
			msg->AttachmentEncoding = "MIME";
			msg->Encoding = meMIME;
			msg->ConvertPreamble = true;
			msg->CharSet = "UTF-8";

			idtext = new TIdText(msg->MessageParts, NULL);
			idtext->ContentType = "text/html";
			idtext->ContentDescription = "multipart-1";
			idtext->CharSet = "UTF-8";
			idtext->ContentTransfer = "8bit";
			idtext->Body->Clear();
			idtext->Body->Add(UTF8String(bodyMsg));

			attach_logo = new TIdAttachmentMemory(msg->MessageParts,
				memStreamBMP);
			attach_logo->FileName = nomAdj;
			attach_logo->ContentType = "image/jpeg";
			attach_logo->ContentDisposition = "inline";
			attach_logo->ExtraHeaders->Add("Content-ID:<violeta.jpg>");

			attach_pdf = new TIdAttachmentMemory(msg->MessageParts,
				memStreamPDF);
			attach_pdf->FileName = nomPDF + ".pdf";
			attach_pdf->ContentType = "application/pdf";
			attach_pdf->ContentDisposition = "attachment";

			attach_xml = new TIdAttachmentMemory(msg->MessageParts,
				memStreamXML);
			attach_xml->FileName = nomPDF + ".xml";
			attach_xml->ContentType = "text/xml";
			attach_xml->ContentDisposition = "attachment";

			smtp->Connect();
			smtp->Authenticate();
			smtp->Send(msg);
			smtp->Disconnect();

			AnsiString sqlinstruccion;
			sqlinstruccion.sprintf
				("update cfdcorreos set enviado=1, fechahoraenv='%s %s' where idcfdcorreos='%s'",
				mFg.DateToMySqlDate(Now()), mFg.TimeToMySqlTime(Now()),
				idEnvio);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				sqlinstruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

		}
		catch (Exception &e) {
			mServidorVioleta->MuestraMensajeError
				("ERROR al enviar correo: " + e.Message);
			throw Exception("ERROR AL ENVIAR CORREO!" + e.Message);
		}

	}
	__finally {

		if (IdLogFile1 != NULL) {
			IdLogFile1->Close();
			delete IdLogFile1;
		}

		if (smtp != NULL)
			delete smtp;
		if (idtext != NULL)
			delete idtext;
		if (msg != NULL)
			delete msg;

		if (IdSSLIOHandlerSocketOpenSSL1 != NULL)
			delete IdSSLIOHandlerSocketOpenSSL1;
		if (resp_envio != NULL)
			delete resp_envio;
		if (resp_config_cfd != NULL)
			delete resp_config_cfd;
		if (memStreamXML != NULL)
			delete memStreamXML;
		if (memStreamPDF != NULL)
			delete memStreamPDF;
		if (memStreamBMP != NULL)
			delete memStreamBMP;

	}

}
// ---------------------------------------------------------------------------

// ID_ENVIOEMAILPEDIDOS
void ServidorReportes::EjecutaEnvioCorreoPedidos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString email, email2, bodyMsg, idEnvio, nomPDF, nomAdj;
	AnsiString pdf64, adj64;
	BufferRespuestas* resp_envio = NULL;

	AnsiString nomremitente, emailcfd, hostsmtp, portsmtp, usersmtp, passsmtp;
	BufferRespuestas* resp_config_cfd = NULL;

	idEnvio = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT cc.pdf, cc.nombrepdf, cc.adjunto, \
		cc.nombreadjunto, cc.mensaje, cc.email, cc.email2 \
		FROM pedidoscorreos cc \
		WHERE cc.idcorreos=%s ", idEnvio);

	if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
		instruccion.c_str(), resp_envio))
		throw Exception("ERROR AL CONSULTAR!");

	for (int i = 0; i < resp_envio->ObtieneNumRegistros(); i++) {
		resp_envio->IrAlRegistroNumero(i);
		pdf64 = resp_envio->ObtieneDato("pdf");
		nomPDF = resp_envio->ObtieneDato("nombrepdf");
		adj64 = resp_envio->ObtieneDato("adjunto");
		nomAdj = resp_envio->ObtieneDato("nombreadjunto");
		bodyMsg = resp_envio->ObtieneDato("mensaje");
		email = resp_envio->ObtieneDato("email");
		email2 = resp_envio->ObtieneDato("email2");
	}

	// Obtener los streams de los adjuntos
	TMemoryStream *memStreamBMP = NULL, *memStreamPDF = NULL;

	// Se envia el CFD al correo del cliente
	TIdMessage *msg = NULL;
	TIdSMTP *smtp = NULL;
	TIdAttachmentMemory *attach_logo = NULL;
	TIdAttachmentMemory *attach_pdf = NULL;
	TIdText *idtext = NULL;
	TIdSSLIOHandlerSocketOpenSSL *IdSSLIOHandlerSocketOpenSSL1 = NULL;

	BufferRespuestas* res_logemailcfd = NULL;
	int logEmailCFD = 0;

	try {
		instruccion.sprintf(
		"SELECT valor FROM parametrosemp where parametro = 'LOGEMAILCFD' AND sucursal = '%s' ",
		FormServidor->ObtieneClaveSucursal());

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,instruccion.c_str(), res_logemailcfd);
		logEmailCFD = res_logemailcfd->ObtieneDato("valor").ToInt();
	}__finally {
		if (res_logemailcfd != NULL)
			delete res_logemailcfd;
	}

	TIdLogFile *IdLogFile1 = NULL;

	try {

		try {

				memStreamPDF = new TMemoryStream();
				TBytes bytes_pdf64 = DecodeBase64(pdf64);
				memStreamPDF->WriteBuffer(&bytes_pdf64[0], bytes_pdf64.Length);
				memStreamPDF->Seek(0, soFromBeginning);

				memStreamBMP = new TMemoryStream();
				TBytes bytes_adj64 = DecodeBase64(adj64);
				memStreamBMP->WriteBuffer(&bytes_adj64[0], bytes_adj64.Length);
				memStreamBMP->Seek(0, soFromBeginning);

			// Consulta de parametroscfd
			instruccion.sprintf
				("select p.* from parametroscfd p where p.sucursal='%s'",
				FormServidor->ObtieneClaveSucursal());
			if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_config_cfd))
				throw Exception("ERROR AL CONSULTAR!");
			for (int y = 0; y < resp_config_cfd->ObtieneNumRegistros(); y++) {
				emailcfd = resp_config_cfd->ObtieneDato("emailenviocfd");
				nomremitente = resp_config_cfd->ObtieneDato("nomenviocfd");
				hostsmtp = resp_config_cfd->ObtieneDato("hostsmtp");
				portsmtp = resp_config_cfd->ObtieneDato("portsmtp");
				usersmtp = resp_config_cfd->ObtieneDato("usersmtp");
				passsmtp = resp_config_cfd->ObtieneDato("passsmtp");
			}

			// Configuracion del componente TIdSMTP
			smtp = new TIdSMTP(NULL);
			smtp->MailAgent = "Indy10";
			smtp->PipeLine = false;
			smtp->UseEhlo = true;
			smtp->UseVerp = false;

			if (hostsmtp.Pos("amazon") > 0) {

				IdSSLIOHandlerSocketOpenSSL1 =
					new TIdSSLIOHandlerSocketOpenSSL(NULL);
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Method =
					Idsslopenssl::sslvSSLv23;
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Mode =
					Idsslopenssl::sslmClient;
				smtp->IOHandler = IdSSLIOHandlerSocketOpenSSL1;
				smtp->UseTLS = utUseExplicitTLS;

			}
			else {

				smtp->UseTLS = utNoTLSSupport;

			}

			smtp->ConnectTimeout = (1000 * 30);
			smtp->ReadTimeout = (1000 * 60);

			smtp->AuthType = satDefault;
			smtp->Host = hostsmtp;
			smtp->Username = usersmtp;
			smtp->Password = passsmtp;
			smtp->Port = portsmtp.ToInt();

			// Configuracion del componente TIdMessage
			msg = new TIdMessage(NULL);
			msg->ExceptionOnBlockedAttachments = false;
			msg->NoDecode = false;
			msg->NoEncode = false;
			msg->UseNowForDate = true;

			// Configuracion del componente TIdLogFile
			if(logEmailCFD == 1){
				IdLogFile1 = new TIdLogFile(NULL);
				IdLogFile1->Filename = ExtractFilePath(Application->ExeName) +
					"\\maillogfile.log";
				IdLogFile1->Active = true;
				IdLogFile1->LogTime = false;
				IdLogFile1->ReplaceCRLF = true;
				smtp->Intercept = IdLogFile1;
			}

			// ENVIO DEL CFD
			msg->Clear();
			msg->MessageParts->Clear();

			msg->From->Address = emailcfd;
			msg->From->Name = nomremitente;
			msg->Sender->Address = emailcfd;
			msg->Sender->Name = nomremitente;
			msg->ReplyTo->EMailAddresses = emailcfd;
			msg->Recipients->EMailAddresses = email;
			if (email2 != "" && email2 != "@" && mFg.ValidaEmail(email2,
				false) && email2 != email)
				msg->CCList->EMailAddresses = email2;
			msg->Priority = mpNormal;
			msg->Subject = "Entrega de su pedido de La Violeta";
			msg->ContentType = "multipart/mixed";
			msg->ClearBody();
			msg->IsEncoded = true;
			msg->AttachmentEncoding = "MIME";
			msg->Encoding = meMIME;
			msg->ConvertPreamble = true;
			msg->CharSet = "UTF-8";

			idtext = new TIdText(msg->MessageParts, NULL);
			idtext->ContentType = "text/html";
			idtext->ContentDescription = "multipart-1";
			idtext->CharSet = "UTF-8";
			idtext->ContentTransfer = "8bit";
			idtext->Body->Clear();
			idtext->Body->Add(UTF8String(bodyMsg));

			attach_logo = new TIdAttachmentMemory(msg->MessageParts,
				memStreamBMP);
			attach_logo->FileName = nomAdj;
			attach_logo->ContentType = "image/jpeg";
			attach_logo->ContentDisposition = "inline";
			attach_logo->ExtraHeaders->Add("Content-ID:<violeta.jpg>");

			attach_pdf = new TIdAttachmentMemory(msg->MessageParts,
				memStreamPDF);
			attach_pdf->FileName = nomPDF + ".pdf";
			attach_pdf->ContentType = "application/pdf";
			attach_pdf->ContentDisposition = "attachment";

			smtp->Connect();
			smtp->Authenticate();
			smtp->Send(msg);
			smtp->Disconnect();

			AnsiString sqlinstruccion;
			sqlinstruccion.sprintf
				("update pedidoscorreos set enviado=1, fechahoraenv='%s %s' where idcorreos='%s'",
				mFg.DateToMySqlDate(Now()), mFg.TimeToMySqlTime(Now()),
				idEnvio);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				sqlinstruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

		}
		catch (Exception &e) {
			mServidorVioleta->MuestraMensajeError
				("ERROR al enviar correo: " + e.Message);
			throw Exception("ERROR AL ENVIAR CORREO!" + e.Message);
		}

	}
	__finally {

		if (IdLogFile1 != NULL) {
			IdLogFile1->Close();
			delete IdLogFile1;
		}

		if (smtp != NULL)
			delete smtp;
		if (idtext != NULL)
			delete idtext;
		if (msg != NULL)
			delete msg;

		if (IdSSLIOHandlerSocketOpenSSL1 != NULL)
			delete IdSSLIOHandlerSocketOpenSSL1;
		if (resp_envio != NULL)
			delete resp_envio;
		if (resp_config_cfd != NULL)
			delete resp_config_cfd;
		if (memStreamPDF != NULL)
			delete memStreamPDF;
		if (memStreamBMP != NULL)
			delete memStreamBMP;

	}

}

// ---------------------------------------------------------------------------

// ID_EJE_REPDIFCOSTOXARTICULOS
void ServidorReportes::EjecutaRepDifCostoXArticulos
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 100];
	char *aux_buffer_sql = buffer_sql;
	char *buffer_inventario_inicial = new char[1024 * 64 * 10];
	char *aux_buffer_inventario_inicial = buffer_inventario_inicial;
	char *buffer_costo_compras = new char[1024 * 64 * 10];
	char *aux_buffer_costo_compras = buffer_costo_compras;
	char *buffer_ncred_provxart = new char[1024 * 64 * 10];
	char *aux_buffer_ncred_provxart = buffer_ncred_provxart;
	char *buffer_costo_movalma = new char[1024 * 64 * 10];
	char *aux_buffer_costo_movalma = buffer_costo_movalma;
	char *buffer_inventario_final = new char[1024 * 64 * 10];
	char *aux_buffer_inventario_final = buffer_inventario_final;
	char *buffer_costo_ventas = new char[1024 * 64 * 10];
	char *aux_buffer_costo_ventas = buffer_costo_ventas;
	AnsiString fechaini, fechafin, sucursal, almacen, clasif1, clasif2, clasif3,
		producto, solodiferencias;
	AnsiString nomproducto, presentacion, cveproducto, multiplo, articulo;
	AnsiString fechaaux, instruccion, instrucciones[50000], condicionsolodif,
		dato, descontarnotas, modo_extendido;
	char *resultado_select;
	int NumeroRenglones, i, num_instrucciones = 0, j, numimpuestos = 0;
	double cantidad, costo, subtotalgeneral, subtotalgrabado, subtotalnograbado,
		total, unitariosinimpuestos, unitarioconimpuestos, sumaimpuestos;
	BufferRespuestas *resp_impuestos = NULL;
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6;
	TFileStream *FStream1 = NULL, *FStream2 = NULL, *FStream3 = NULL,
		*FStream4 = NULL, *FStream5 = NULL, *FStream6 = NULL;
	AnsiString cadena;
	TStringList *lista_impuestos = new TStringList;

	try {
		fechaini = mFg.ExtraeStringDeBuffer(&parametros);
		fechafin = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		solodiferencias = mFg.ExtraeStringDeBuffer(&parametros);
		descontarnotas = AnsiString(mFg.ExtraeStringDeBuffer(&parametros));
		// Descontar notas de crédito de ventas
		modo_extendido = AnsiString(mFg.ExtraeStringDeBuffer(&parametros));

		// Obtiene la lista de impuestos activos
		lista_impuestos->Sorted = true;
		instruccion =
			"SELECT i.activo AS marcado, i.impuesto, ti.nombre, i.porcentaje, i.tipoimpu \
			FROM impuestos i INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.activo=1 AND i.tipoimpu <> 'ISR' ORDER BY ti.tipoimpu DESC, i.porcentaje";
		if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos, TAM_MAX_BUFFER_RESPUESTA_REP))
		{
			numimpuestos = resp_impuestos->ObtieneNumRegistros();
			for (i = 0; i < numimpuestos; i++) {
				resp_impuestos->IrAlRegistroNumero(i);
				lista_impuestos->AddObject
					(resp_impuestos->ObtieneDato("impuesto"),
					(TObject *)(resp_impuestos->ObtienePunteroDato
					("impuesto")));
			}
		}

		// Crea tablas temporales
		instruccion.sprintf("create temporary table auxdifscostos1 ( \
			nomproducto varchar(60), presentacion varchar(255), cveproducto varchar(8), \
			cantidad decimal(12,3), costo decimal(16,6), \
			primary key(cveproducto,presentacion)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("create temporary table auxdifscostos2 ( \
			nomproducto varchar(60), presentacion varchar(255), articulo varchar(9), \
			cantidad decimal(12,3), multiplo varchar(10), subtotalgeneral decimal(12,3), \
			subtotalgrabado decimal(12,3), subtotalnograbado decimal(12,3), total decimal(16,6), \
			unitariosinimpuestos decimal(12,3), unitarioconimpuestos decimal(12,3), \
			primary key(articulo)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("create temporary table auxdifscostos3 ( \
			nomproducto varchar(60), presentacion varchar(255), articulo varchar(9), \
			cantidad decimal(12,3), multiplo varchar(10), subtotalgeneral decimal(12,3), \
			subtotalgrabado decimal(12,3), subtotalnograbado decimal(12,3), total decimal(16,6), \
			primary key(articulo)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("create temporary table auxdifscostos4 ( \
			nomproducto varchar(60), presentacion varchar(255), cveproducto varchar(8), \
			cantidad decimal(12,3), costo decimal(16,6), \
			primary key(cveproducto,presentacion)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("create temporary table auxdifscostos5 ( \
			nomproducto varchar(60), presentacion varchar(255), cveproducto varchar(8), \
			cantidad decimal(12,3), costo decimal(16,6), \
			primary key(cveproducto,presentacion)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("create temporary table auxdifscostos6 ( \
			nomproducto varchar(60), presentacion varchar(255), costo decimal(16,6), \
			primary key(nomproducto,presentacion)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		// Inventario inicial
		fechaaux = DateToStr(IncDay(mFg.MySqlDateToTDate(mFg.StrToMySqlDate(fechaini).c_str()), -1));

		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(fechaaux, aux_buffer_inventario_inicial);//fecha
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(sucursal, aux_buffer_inventario_inicial);  //sucursal
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(almacen, aux_buffer_inventario_inicial); //almacen
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(clasif1, aux_buffer_inventario_inicial); //clasif1
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(clasif2, aux_buffer_inventario_inicial); //clasif2
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(clasif3, aux_buffer_inventario_inicial); //clasif3
		aux_buffer_inventario_inicial =	mFg.AgregaStringABuffer(producto, aux_buffer_inventario_inicial); //producto
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_inicial); //presentacion
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer("0", aux_buffer_inventario_inicial); //incluir iva
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer("0", aux_buffer_inventario_inicial); //costo existencia
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_inicial); //segmento
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_inicial); //fabricante
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_inicial); //marca
		aux_buffer_inventario_inicial = mFg.AgregaStringABuffer(FormServidor->ObtieneClaveEmpresa(), aux_buffer_inventario_inicial); //Envia empresa

		// ID_EJE_REPCOSTOEXISTENCIAS
		mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOEXISTENCIAS ", Respuesta->Id);
		EjecutaRepCostoExistencias(Respuesta, MySQL, buffer_inventario_inicial);

		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.

		mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error
		resultado_select += sizeof(int); // Se salta el tamaño del buffer

		NumeroRenglones = *((int *)resultado_select);

		// Obtiene número de registros
		resultado_select += sizeof(int); // Se salta el numero de registros

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1, Respuesta->Id);
		FStream1 = new TFileStream(archivo_temp1, fmCreate | fmShareDenyNone);

		// Llena los datos del inventario inicial
		for (i = 0; i < NumeroRenglones; i++) {
			nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
			cveproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			cantidad = mFg.CadenaAFlotante(mFg.ExtraeStringDeBuffer(&resultado_select));
			costo = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));
			mFg.ExtraeStringDeBuffer(&resultado_select); // No se usa el costo promedio unitario, lo saltamos.

			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + cveproducto +
				"\t" + cantidad + "\t" + costo + "\n";

			FStream1->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos1 (nomproducto, presentacion, cveproducto, cantidad, costo) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Costo de compras
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(fechaini, aux_buffer_costo_compras); //fecha inicial
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(fechafin, aux_buffer_costo_compras); //fecha final
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(FormServidor->ObtieneClaveEmpresa(), aux_buffer_costo_compras); //empresa
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(sucursal, aux_buffer_costo_compras); //sucursal
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // acredito
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(almacen, aux_buffer_costo_compras); // almacén de entrada
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(clasif1, aux_buffer_costo_compras); //clasif1
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(clasif2, aux_buffer_costo_compras); //clasif2
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(clasif3, aux_buffer_costo_compras); //clasif3
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// clasifcont1
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // clasifcont2
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(producto, aux_buffer_costo_compras);
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // marca
		aux_buffer_costo_compras = mFg.AgregaStringABuffer("0", aux_buffer_costo_compras); // incluir_devoluciones
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(fechafin, aux_buffer_costo_compras); // fecha_limite_devoluciones
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// tipo_impuestos
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// impuesto_particular
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // proveedor
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // articulo
		aux_buffer_costo_compras = mFg.AgregaStringABuffer("0", aux_buffer_costo_compras); // desglosar_modo
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// prov_partesrel
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// almacen según configuración por artículo
		aux_buffer_costo_compras = mFg.AgregaStringABuffer("0", aux_buffer_costo_compras);// consulta por Fecha de Alta poner 1
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// fabricante
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // segmento
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras); // comprador
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);// supervisado por
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);//referencia de la compra
		aux_buffer_costo_compras = mFg.AgregaStringABuffer("0", aux_buffer_costo_compras);		//negar impuesto1
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);//tipo impuesto2
		aux_buffer_costo_compras = mFg.AgregaStringABuffer(" ", aux_buffer_costo_compras);//impuesto especifico2
		aux_buffer_costo_compras = mFg.AgregaStringABuffer("0", aux_buffer_costo_compras);//negar impuesto2


		// ID_EJE_REPCOMPRAS_X_ARTICULO
		mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOMPRAS_X_ARTICULO ", Respuesta->Id);
		EjecutaRepComprasXArticulo(Respuesta, MySQL, buffer_costo_compras);

		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.
		mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error

		BufferRespuestas resp_reporte_costocompras(resultado_select);
		resultado_select += resp_reporte_costocompras.ObtieneTamRespuesta();
		NumeroRenglones = resp_reporte_costocompras.ObtieneNumRegistros(); // Obtiene número de registros

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(2, Respuesta->Id);
		FStream2 = new TFileStream(archivo_temp2, fmCreate | fmShareDenyNone);

		// Llena los datos de costos de compras
		for (i = 0; i < NumeroRenglones; i++) {
			cantidad = resp_reporte_costocompras.ObtieneDato("cantxart").ToDouble();
			multiplo = resp_reporte_costocompras.ObtieneDato("multiplo");
			nomproducto = resp_reporte_costocompras.ObtieneDato("nomproducto");
			presentacion = resp_reporte_costocompras.ObtieneDato("present");
			total = resp_reporte_costocompras.ObtieneDato("subtotal").ToDouble();
			articulo = resp_reporte_costocompras.ObtieneDato("articulo");
			resp_reporte_costocompras.IrAlSiguienteRegistro();

			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + articulo +
				"\t" + cantidad + "\t" + multiplo + "\t" + total + "\n";
			FStream2->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos2 (\
				nomproducto, presentacion, articulo, cantidad, multiplo, total) "
			, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Notas de credito de proveedores
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(fechaini, aux_buffer_ncred_provxart); //fecha inicial
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(fechafin, aux_buffer_ncred_provxart); //fecha final
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //Empresa
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(sucursal, aux_buffer_ncred_provxart); //sucursal
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("01/01/1900", aux_buffer_ncred_provxart); //fecha_inicial_compras
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("01/01/2099", aux_buffer_ncred_provxart); //fecha_final_compras
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //tipo
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(almacen, aux_buffer_ncred_provxart); //almacen
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(clasif1, aux_buffer_ncred_provxart); //clasif1
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(clasif2, aux_buffer_ncred_provxart); //clasif2
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(clasif3, aux_buffer_ncred_provxart); //clasif3
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(producto, aux_buffer_ncred_provxart); //producto
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("0", aux_buffer_ncred_provxart); //canceladas
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("0", aux_buffer_ncred_provxart); //tipo canceladas
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //tipo impuestos
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //impuesto particular
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //proveedor
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //articulo
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //proveedor partes relacionadas
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); // clasif_cont1
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart);// clasif_cont2
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); // Supervisado por
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("0", aux_buffer_ncred_provxart); //negar impuesto1
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //tipos impuestos2
		aux_buffer_ncred_provxart = mFg.AgregaStringABuffer(" ", aux_buffer_ncred_provxart); //impuesto particular2
        aux_buffer_ncred_provxart = mFg.AgregaStringABuffer("0", aux_buffer_ncred_provxart); //negar impuesto2


		// ID_EJE_REPNOTCREDPROV_X_ARTICULO
		mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPNOTCREDPROV_X_ARTICULO ", Respuesta->Id);
		EjecutaRepNotcredprovXArticulo(Respuesta, MySQL, buffer_ncred_provxart);

		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.
		mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error

		BufferRespuestas resp_reporte_ncredprov(resultado_select);
		resultado_select += resp_reporte_ncredprov.ObtieneTamRespuesta();
		NumeroRenglones = resp_reporte_ncredprov.ObtieneNumRegistros(); // Obtiene número de registros

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(3, Respuesta->Id);
		FStream3 = new TFileStream(archivo_temp3, fmCreate | fmShareDenyNone);

		// Llena los datos de notas de credito de proveedores
		for (i = 0; i < NumeroRenglones; i++) {
			cantidad = resp_reporte_ncredprov.ObtieneDato("cantxart").ToDouble();
			multiplo = resp_reporte_ncredprov.ObtieneDato("multiplo");
			nomproducto = resp_reporte_ncredprov.ObtieneDato("nomproducto");
			presentacion = resp_reporte_ncredprov.ObtieneDato("present");
			total = resp_reporte_ncredprov.ObtieneDato("subtotal").ToDouble();
			articulo = resp_reporte_ncredprov.ObtieneDato("articulo");
			resp_reporte_ncredprov.IrAlSiguienteRegistro();

			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + articulo +
				"\t" + cantidad + "\t" + multiplo + "\t" + total + "\n";
			FStream3->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos3 (\
				nomproducto, presentacion, articulo, cantidad, multiplo, total) "
			, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Costo de movimientos de almacen
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(fechaini, aux_buffer_costo_movalma); //fecha inicial
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(fechafin, aux_buffer_costo_movalma); //fecha final
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(" ", aux_buffer_costo_movalma); //tipo de movimiento
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(" ", aux_buffer_costo_movalma); //conceptos
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(sucursal, aux_buffer_costo_movalma); //sucursal
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(almacen, aux_buffer_costo_movalma); //almacen
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(clasif1, aux_buffer_costo_movalma); //clasif1
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(clasif2, aux_buffer_costo_movalma); //clasif2
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(clasif3, aux_buffer_costo_movalma); //clasif3
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(producto, aux_buffer_costo_movalma); //producto
		aux_buffer_costo_movalma = mFg.AgregaStringABuffer(" ", aux_buffer_costo_movalma); // Movimiento

		if (modo_extendido == "0") {
			aux_buffer_costo_movalma = mFg.AgregaStringABuffer("0", aux_buffer_costo_movalma); // Se indica que no se va a guardar precalculo de costos.

			// ID_EJE_REPCOSTOMOVALM
			mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOMOVALM ", Respuesta->Id);
			EjecutaRepCostoMovimientosAlmacen(Respuesta, MySQL, buffer_costo_movalma);

			resultado_select = Respuesta->BufferResultado;
			resultado_select += sizeof(int); // Se salta el tamaño del resultado.
			mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error
			resultado_select += sizeof(int); // Se salta el tamaño del buffer

			NumeroRenglones = *((int *)resultado_select); // Obtiene número de registros
			resultado_select += sizeof(int); // Se salta el numero de registros
			archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(4, Respuesta->Id);
			FStream4 = new TFileStream(archivo_temp4, fmCreate | fmShareDenyNone);

			// Llena los datos de costos de movimientos de almacen
			for (i = 0; i < NumeroRenglones; i++) {
				// Extrae los datos en el orden que el servidor los manda
				nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
				presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
				cveproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
				cantidad = mFg.CadenaAFlotante(mFg.ExtraeStringDeBuffer(&resultado_select));
				costo = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));

				// Guardar en archivo temporal
				cadena = nomproducto + "\t" + presentacion + "\t" +
					cveproducto + "\t" + cantidad + "\t" + costo + "\n";
				FStream4->Write(cadena.c_str(), cadena.Length());
			}
			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos4 (\
					nomproducto, presentacion, cveproducto, cantidad, costo) ",
				archivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;
		}
		else if (modo_extendido == "1") {
			aux_buffer_costo_movalma = mFg.AgregaStringABuffer("0", aux_buffer_costo_movalma); // agrconcepto

			// ID_EJE_REPCOSTOMOVALM_EXT
			mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOMOVALM_EXT ", Respuesta->Id);
			EjecutaRepCostoMovExt(Respuesta, MySQL, buffer_costo_movalma);

			resultado_select = Respuesta->BufferResultado;
			BufferRespuestas resp_reporte_costomovalm(resultado_select);

			NumeroRenglones = resp_reporte_costomovalm.ObtieneNumRegistros();

			archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(4,
				Respuesta->Id);
			FStream4 = new TFileStream(archivo_temp4,
				fmCreate | fmShareDenyNone);

			for (i = 0; i < NumeroRenglones; i++) {
				cantidad = mFg.CadenaAFlotante(resp_reporte_costomovalm.ObtieneDato("SUM(pm.cantidad)"));
				nomproducto = resp_reporte_costomovalm.ObtieneDato("nombre");
				presentacion = resp_reporte_costomovalm.ObtieneDato("present");
				costo = StrToFloat(resp_reporte_costomovalm.ObtieneDato("costo"));
				cveproducto = resp_reporte_costomovalm.ObtieneDato("producto");

				// Guardar en archivo temporal
				cadena = nomproducto + "\t" + presentacion + "\t" +
					cveproducto + "\t" + cantidad + "\t" + costo + "\n";
				FStream4->Write(cadena.c_str(), cadena.Length());

				resp_reporte_costomovalm.IrAlSiguienteRegistro();
			}

			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos4 (\
				nomproducto, presentacion, cveproducto, cantidad, costo) ",
				archivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;
		}

		// Inventario final
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(fechafin, aux_buffer_inventario_final); //fecha
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(sucursal, aux_buffer_inventario_final); //sucursal
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(almacen, aux_buffer_inventario_final); //almacen
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(clasif1, aux_buffer_inventario_final); //clasif1
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(clasif2, aux_buffer_inventario_final); //clasif2
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(clasif3, aux_buffer_inventario_final); //clasif3
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(producto, aux_buffer_inventario_final); //producto
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_final); //presentacion
		aux_buffer_inventario_final = mFg.AgregaStringABuffer("0", aux_buffer_inventario_final); //incluir_iva
		aux_buffer_inventario_final = mFg.AgregaStringABuffer("0", aux_buffer_inventario_final); //costoexistencia
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_final); //segmento
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_final); //fabricante
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(" ", aux_buffer_inventario_final); //marca
		aux_buffer_inventario_final = mFg.AgregaStringABuffer(FormServidor->ObtieneClaveEmpresa(), aux_buffer_inventario_final); //Envia empresa

		// ID_EJE_REPCOSTOEXISTENCIAS
		mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOEXISTENCIAS ", Respuesta->Id);
		EjecutaRepCostoExistencias(Respuesta, MySQL, buffer_inventario_final);

		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.
		mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error
		resultado_select += sizeof(int); // Se salta el tamaño del buffer

		NumeroRenglones = *((int *)resultado_select); // Obtiene número de registros

		resultado_select += sizeof(int); // Se salta el numero de registros

		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(5, Respuesta->Id);
		FStream5 = new TFileStream(archivo_temp5, fmCreate | fmShareDenyNone);

		// Llena los datos del inventario final
		for (i = 0; i < NumeroRenglones; i++) {
			nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
			cveproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			cantidad = mFg.CadenaAFlotante(mFg.ExtraeStringDeBuffer(&resultado_select));
			costo = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));

			mFg.ExtraeStringDeBuffer(&resultado_select); // No se usa el costo promedio unitario, lo saltamos.

			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + cveproducto +
				"\t" + cantidad + "\t" + costo + "\n";
			FStream5->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos5 (\
				nomproducto, presentacion, cveproducto, cantidad, costo) ",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		// Costo de ventas
		// Parametros en común
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(fechaini, aux_buffer_costo_ventas); //fecha_inicial
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(fechafin, aux_buffer_costo_ventas); //fecha_final
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //acredito
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(sucursal, aux_buffer_costo_ventas); //sucursal
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(almacen, aux_buffer_costo_ventas); //almacen
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif1, aux_buffer_costo_ventas); //clasif1
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif2, aux_buffer_costo_ventas);  //clasif2
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif3, aux_buffer_costo_ventas); //clasif3
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // marca
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // proveedor_predeterminado
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(producto, aux_buffer_costo_ventas); // producto

		if (modo_extendido == "0") {
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //presentacion
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // No desglosar movimientos
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(descontarnotas, aux_buffer_costo_ventas); //incluir_devoluciones
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //tipo_facturacion
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //cliente
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //vendedor
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //sector
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //localidad
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //venta
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); //diferencias
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // proveedor de compras
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // Registra costo de venta
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // meses a la fecha
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Envia partes relacionas
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Segmento
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Fabricante
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(FormServidor->ObtieneClaveEmpresa(), aux_buffer_costo_ventas); //Enviar la empresa

			// ID_EJE_REPCOSTOVENTAS
			mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOVENTAS ", Respuesta->Id);
			EjecutaRepCostoVentas(Respuesta, MySQL, buffer_costo_ventas);

			resultado_select = Respuesta->BufferResultado;
			resultado_select += sizeof(int); // Se salta el tamaño del resultado.
			mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error
			resultado_select += sizeof(int); // Se salta el tamaño del buffer

			NumeroRenglones = *((int *)resultado_select); // Obtiene número de registros
			resultado_select += sizeof(int); // Se salta el numero de registros
			archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(6, Respuesta->Id);
			FStream6 = new TFileStream(archivo_temp6, fmCreate | fmShareDenyNone);

			// Llena los datos del reporte de costos de ventas
			for (i = 0; i < NumeroRenglones; i++) {
				nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
				presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
				cveproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
				mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta la cantidad
				costo = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));

				mFg.ExtraeStringDeBuffer(&resultado_select);
				mFg.ExtraeStringDeBuffer(&resultado_select);
				mFg.ExtraeStringDeBuffer(&resultado_select);

				// Guardar en archivo temporal
				cadena = nomproducto + "\t" + presentacion + "\t" +
					costo + "\n";
				FStream6->Write(cadena.c_str(), cadena.Length());
			}
			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos6 (\
					nomproducto, presentacion, costo) ", archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;

		}
		else if (modo_extendido == "1") {

			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // tipo facturacion
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // cliente
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // vendedor
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // sector
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // localidad
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // venta
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // proveedor de compras
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // meses
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // El porcentaje de utilidad
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Segmento
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Fabricante
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Partes relacionadas
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Supervisado por
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Origen venta
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Descontar notas de crédito como reporte de articulos
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Fecha descontar notas
			aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Lista tipos de precio

			// ID_EJE_REPCOSTOVENTAS_EXT
			mServidorVioleta->MuestraMensaje("-- Parte de ID_EJE_REPCOSTOVENTAS_EXT ", Respuesta->Id);
			EjecutaRepCostoVentasExt(Respuesta, MySQL, buffer_costo_ventas);

			resultado_select = Respuesta->BufferResultado;
			resultado_select += sizeof(int); // Se salta el tamaño del resultado.
			mFg.ExtraeStringDeBuffer(&resultado_select); // Se salta el indicador de error

			BufferRespuestas resp_rep_costo_ventas(resultado_select);

			NumeroRenglones = resp_rep_costo_ventas.ObtieneNumRegistros();

			archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(6, Respuesta->Id);
			FStream6 = new TFileStream(archivo_temp6, fmCreate | fmShareDenyNone);

			for (i = 0; i < NumeroRenglones; i++) {
				nomproducto = resp_rep_costo_ventas.ObtieneDato("nombre");
				presentacion = resp_rep_costo_ventas.ObtieneDato("present");
				costo = StrToFloat(resp_rep_costo_ventas.ObtieneDato("costo"));

				// Guardar en archivo temporal
				cadena = nomproducto + "\t" + presentacion + "\t" + costo + "\n";
				FStream6->Write(cadena.c_str(), cadena.Length());

				resp_rep_costo_ventas.IrAlSiguienteRegistro();
			}

			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos6 (nomproducto, presentacion, costo) ", archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;

		}

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i], aux_buffer_sql);
		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL, buffer_sql)) {
			mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

			mServidorVioleta->MuestraMensaje("-- Parte de RESULTADO FINAL ", Respuesta->Id);
			// Unifica todo en un solo resultado para regresarlo al cliente
			if (solodiferencias == "1") {
				condicionsolodif = "AND (ABS((IFNULL(a1.costo,0.000000)+IFNULL(a2.total,0.000000)-IFNULL(a3.total,0.000000)+IFNULL(a4.costo,0.000000)-IFNULL(a5.costo,0.000000))-(IFNULL(a6.costo,0.000000))))>=0.01";
			}
			else {
				condicionsolodif = " ";
			}
			instruccion.sprintf("SELECT pro.nombre, pre.present, IFNULL(a1.costo,0.000000) costoinvini, \
				IFNULL(a2.total,0.000000) costocompras, IFNULL(a3.total,0.000000) ncredprov, \
				IFNULL(a4.costo,0.000000) costomovalma, IFNULL(a5.costo,0.000000) costoinvfin, \
				(IFNULL(a1.costo,0.000000)+IFNULL(a2.total,0.000000)-IFNULL(a3.total,0.000000)+ \
				IFNULL(a4.costo,0.000000)-IFNULL(a5.costo,0.000000)) costoventas, IFNULL(a6.costo,0.000000) repoventas, \
				ABS((IFNULL(a1.costo,0.000000)+IFNULL(a2.total,0.000000)-IFNULL(a3.total,0.000000)+ \
				IFNULL(a4.costo,0.000000)-IFNULL(a5.costo,0.000000))-(IFNULL(a6.costo,0.000000))) as diferenciaabs, \
				((IFNULL(a1.costo,0.000000)+IFNULL(a2.total,0.000000)-IFNULL(a3.total,0.000000)+ \
				IFNULL(a4.costo,0.000000)-IFNULL(a5.costo,0.000000))-(IFNULL(a6.costo,0.000000))) as diferencia \
				FROM productos pro INNER JOIN presentaciones pre ON pro.producto=pre.producto \
				LEFT JOIN auxdifscostos1 a1 ON a1.presentacion=pre.present AND a1.nomproducto=pro.nombre \
				LEFT JOIN (SELECT nomproducto, presentacion, SUM(total) total FROM auxdifscostos2 GROUP BY \
				nomproducto,presentacion) a2 ON a2.presentacion=pre.present AND a2.nomproducto=pro.nombre \
				LEFT JOIN (SELECT nomproducto, presentacion, SUM(total) total FROM auxdifscostos3 GROUP BY \
				nomproducto,presentacion) a3 ON a3.presentacion=pre.present AND a3.nomproducto=pro.nombre \
				LEFT JOIN auxdifscostos4 a4 ON a4.presentacion=pre.present AND a4.nomproducto=pro.nombre \
				LEFT JOIN auxdifscostos5 a5 ON a5.presentacion=pre.present AND a5.nomproducto=pro.nombre \
				LEFT JOIN auxdifscostos6 a6 ON a6.presentacion=pre.present AND a6.nomproducto=pro.nombre \
				WHERE (a1.costo<>0 OR a2.total IS NOT NULL OR a3.total IS NOT NULL OR a4.costo \
				IS NOT NULL OR a5.costo<>0) %s ORDER BY diferenciaabs desc ",
				condicionsolodif);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (FStream1 != NULL) {
			delete FStream1;
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}
		if (FStream2 != NULL) {
			delete FStream2;
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		}
		if (FStream3 != NULL) {
			delete FStream3;
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		}
		if (FStream4 != NULL) {
			delete FStream4;
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
		}
		if (FStream5 != NULL) {
			delete FStream5;
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		}
		if (FStream6 != NULL) {
			delete FStream6;
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
		}
		delete buffer_inventario_inicial;
		delete buffer_costo_compras;
		delete buffer_ncred_provxart;
		delete buffer_costo_movalma;
		delete buffer_inventario_final;
		delete buffer_costo_ventas;
		delete buffer_sql;
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete lista_impuestos;
	}
}

// ---------------------------------------------------------------------------

// ID_EJE_REP_ROTACION_INVENTARIO
void ServidorReportes::EjecutaRepRotacionInventario
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	char *buffer_costo_ventas = new char[1024 * 64 * 10];
	char *aux_buffer_costo_ventas = buffer_costo_ventas;
	char *resultado_select;
	int i, NumeroRenglones;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString fecha, fecha_inicial;
	int meses, dias, orden;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos, sucursal;
	AnsiString condicionsoloactivos, cadena_orden;
	AnsiString archivo_temp6, cadena, ax1;
	TFileStream *FStream6 = NULL;
	AnsiString nomproducto, presentacion, producto, cveproducto;
	double cantvta, costovta, promcostoinv, costoinv, cantinv;
	TDate a1;

	try {
		fecha = mFg.ExtraeStringDeBuffer(&parametros);
		meses = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		orden = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		cveproducto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);

		ax1 = mFg.StrToMySqlDate(fecha);
		a1 = IncMonth(mFg.MySqlDateToTDate(ax1.c_str()), meses*-1);
		fecha_inicial = a1.DateString();
		dias = DaysBetween(mFg.MySqlDateToTDate(ax1.c_str()), a1);

		switch (orden) {
		case 0: // Por costo de venta
			cadena_orden = " a6.costovta desc";
			break;
		case 1: // Por veces que rota
			cadena_orden = " veces desc";
			break;
		default: // Por nombre de producto
			cadena_orden = " a1.nombre, a1.present ";

		}

		// Crea tablas temporales
		instruccion.sprintf("create temporary table auxdifscostos6 ( \
			nomproducto varchar(60), presentacion varchar(255), producto varchar(8), promcostoinv decimal(16,6), \
			costoinv decimal(16,6), cantinv decimal(16,6), \
			costovta decimal(16,6), cantvta decimal(16,6), \
			primary key(nomproducto,presentacion)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		// Costo de ventas
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(fecha_inicial, aux_buffer_costo_ventas); //fecha inicial
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(fecha, aux_buffer_costo_ventas); //fecha final
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //acredito
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("'" + sucursal +"'",aux_buffer_costo_ventas); //sucursal
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //almacen
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif1, aux_buffer_costo_ventas); //clasif1
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif2, aux_buffer_costo_ventas); //clasif2
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(clasif3, aux_buffer_costo_ventas); //clasif3
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // marca
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // proveedor
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(cveproducto, aux_buffer_costo_ventas); //producto
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //presentacion
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); //desglosado
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); //incluir devoluciones
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //tipo facturacion
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //cliente
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //vendedor
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //sector
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //localidad
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); //venta
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); //diferencias
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // proveedor de compras
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // Registra costo de venta
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer("0", aux_buffer_costo_ventas); // meses a la fecha
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Envia partes relacionas
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Segmento
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(" ", aux_buffer_costo_ventas); // Fabricante
		aux_buffer_costo_ventas = mFg.AgregaStringABuffer(FormServidor->ObtieneClaveEmpresa(), aux_buffer_costo_ventas); // Empresa

		// ID_EJE_REPCOSTOVENTAS
		EjecutaRepCostoVentas(Respuesta, MySQL, buffer_costo_ventas);
		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.
		mFg.ExtraeStringDeBuffer(&resultado_select);
		// Se salta el indicador de error
		resultado_select += sizeof(int); // Se salta el tamaño del buffer
		NumeroRenglones = *((int *)resultado_select);
		// Obtiene número de registros
		resultado_select += sizeof(int); // Se salta el numero de registros
		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(6, Respuesta->Id);
		FStream6 = new TFileStream(archivo_temp6, fmCreate | fmShareDenyNone);
		// Llena los datos del reporte de costos de ventas
		for (i = 0; i < NumeroRenglones; i++) {
			nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
			producto = mFg.ExtraeStringDeBuffer(&resultado_select);
			cantvta =
				mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));
			costovta = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));
			promcostoinv =
				StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));
			costoinv = StrToFloat(mFg.ExtraeStringDeBuffer(&resultado_select));
			cantinv =
				mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));
			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + producto +
				"\t" + promcostoinv + "\t" + costovta + "\t" + cantvta + "\t" +
				costoinv + "\t" + cantinv + "\n";
			FStream6->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos6 (\
				nomproducto, presentacion, producto, promcostoinv, costovta, cantvta, costoinv, cantinv) "
			, archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);
		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA);
			// Unifica todo en un solo resultado para regresarlo al cliente
			if (obtener_articulos_inactivos == "1") {
				condicionsoloactivos = " ";
			}
			else {
				condicionsoloactivos = "AND a1.activo=1";
			}
			instruccion.sprintf("SELECT a1.nombre, a1.present, a1.producto, a6.promcostoinv, a6.costovta, a6.cantvta, a6.costoinv, a6.cantinv, \
				(a6.costovta/a6.promcostoinv) as veces, '%d' as dias \
				FROM (SELECT a.producto,p.nombre,a.present,a.activo FROM articulos a \
				LEFT JOIN productos p ON p.producto=a.producto GROUP BY a.producto, a.present) a1 \
				LEFT JOIN auxdifscostos6 a6 ON a6.nomproducto=a1.nombre AND a6.presentacion=a1.present \
				WHERE a6.nomproducto IS NOT NULL %s ORDER BY %s", dias,
				condicionsoloactivos, cadena_orden);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (FStream6 != NULL)
			delete FStream6;
		mServidorVioleta->BorraArchivoTemp(archivo_temp6);
		delete buffer_costo_ventas;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------

// ID_EJE_REPSEG_MOVS_ART_OPT
void ServidorReportes::EjecutaRepSeguimientoMovsArtOpt
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	// CONSULTA LAS EXISTENCIAS DE UN ARTICULO A UNA FECHA DADA (DE FORMA OPTIMIZADA CON BASE A LA TABLA PRECALCULADA LLAMADA VENTASXMES)
	AnsiString instruccion;
	AnsiString almacen, articulo, condicion_almacen, considerar_cortes;
	TDate fecha, fecha_hoy, fecha_inicial_promedio;
	int dias, i, tipopromedio;
	AnsiString calculo_promedio_ventas, calculo_promedio_devventas;
	AnsiString obtener_articulos_inactivos, condicion_articulos_inactivos = " ";
	AnsiString empresa, sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ", indice_ventas,
		modo_calcular_existencias;
	double divisor;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_ventasxmes_aux = NULL;
	bool hay_ventasxmes = false;
    AnsiString condicion_almacen3 = " ";

	fecha_hoy = Today();
	int anio_actual = YearOf(fecha_hoy);
	int anio_anterior = anio_actual - 1;
	int anio_ante_anterior = anio_actual - 2;
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes que se va a modificar
	AnsiString cad_mes_actual = mFg.IntToAnsiString(mes_actual);
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_anio_actual = mFg.IntToAnsiString(anio_actual);
	AnsiString cad_anio_anterior = mFg.IntToAnsiString(anio_anterior);
	AnsiString cad_anio_ante_anterior = mFg.IntToAnsiString(anio_ante_anterior);
	AnsiString cad_fecha_hoy = mFg.DateToMySqlDate(fecha_hoy);
	AnsiString cad_fecha_inicio = cad_anio_ante_anterior + "-01-01";

	AnsiString fechaResF, fechaResFglon;///cod agr
	bool bandExist;///cod agr
	try {
		//fecha = StrToDate(mFg.ExtraeStringDeBuffer(&parametros)); //cod orig
		AnsiString fech, exVal, fecha1;
		exVal=mFg.ExtraeStringDeBuffer(&parametros);  //exVal
		fech = mFg.StrToMySqlDate(exVal);  // exVal
        fecha = StrToDate(exVal);
		/// codigo agr
		//AnsiString fech = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

		if(fech!=" "){
			BufferRespuestas* resp_n = NULL;
			BufferRespuestas* resp_n2 = NULL;
			AnsiString resultEstGlob, resultPuntCort;
			try {
				//instruccion = "select max(p.fecha) as fcorte from puntoscorte p where p.fecha<= '"+fecha+"'";
				instruccion.sprintf("SELECT IFNULL(MAX(p.fecha),'1900-01-01') AS fcorte \
					FROM puntoscorte p \
					WHERE p.fecha<='%s'",fech);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n);

				if (resp_n->ObtieneNumRegistros() > 0) {
					resultPuntCort = resp_n->ObtieneDato("fcorte");
				}

				if(resultPuntCort == " ")
					resultPuntCort="1900-01-01";

				//instruccion = "SELECT valor FROM estadosistemaglob WHERE estado ='FCORTEINI'";
				instruccion.sprintf("SELECT IFNULL(valor, '2000-01-01') AS val \
				FROM estadosistemaglob \
				WHERE estado = 'FCORTEINI'");

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_n2);

				resultEstGlob = resp_n2->ObtieneDato("val");
				fechaResFglon = resp_n2->ObtieneDato("val");
				if(resultEstGlob == "")
					resultEstGlob = "1900-01-01";

				 TDateTime resultDFech, resultDPc, resultDEg;
				 int difpc, difeg;
				 int a, m ,d;

				 if(sscanf(resultPuntCort.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3) {
				 	resultDPc= EncodeDate(a,m,d);
				 }

				 if(sscanf(resultEstGlob.c_str(),"%4d-%2d-%2d",&a, &m, &d) == 3) {
				 	resultDEg= EncodeDate(a,m,d);
				 }

				 difpc = DaysBetween(mFg.MySqlDateToTDate(fech.c_str()),resultDPc); //resultDFech
				 difeg = DaysBetween(mFg.MySqlDateToTDate(fech.c_str()),resultDEg); //resultDFech

				 if(difpc == difeg){
                    fechaResF = resultEstGlob;
					bandExist=true; //eglob
				 } else if(difpc < difeg){
					//fecha = difpc;
					bandExist=false; //pc
					fechaResF = resultPuntCort;
				 } else {
					//fecha = difeg;
					fechaResF = resultEstGlob;
					bandExist=true; //eglob
				 }
			}
			__finally {
				if (resp_n != NULL)
					delete resp_n;
				if (resp_n2 != NULL)
					delete resp_n2;
			}
        }
		///fin cod agr
		dias = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		articulo = mFg.ExtraeStringDeBuffer(&parametros);
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		tipopromedio = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		modo_calcular_existencias = mFg.ExtraeStringDeBuffer(&parametros);

		// Si se quiere usar modo de existencias actuales solo se permite si la fecha de las existencias es hoy
		// de lo contrario se usa el modo normal.
		if (modo_calcular_existencias == "MODEA" && fecha != fecha_hoy) {
			modo_calcular_existencias = "MODN";
		}else if(modo_calcular_existencias == "MODEA" && fecha == fecha_hoy && considerar_cortes == "1"){ //prb
			modo_calcular_existencias = "MODEAAC";
		} //prb

		// mServidorVioleta->MuestraMensajeError("corte:  "+considerar_cortes);
		if (tipopromedio == 0) {
			divisor = dias / 30.5;
		}
		if (tipopromedio == 1) {
			divisor = dias / 15;
		}
		if (tipopromedio == 2) {
			divisor = dias / 7;
		}
		if (tipopromedio == 3) {
			divisor = dias / 1;
		}

		// fecha_inicial_promedio=IncMonth(fecha, meses*-1);
		fecha_inicial_promedio = fecha - dias;

		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		// Obtiene los almacenes que corresponden a una sucursal
		// anterior: almacen !=" "
		// anterior:sucursal!=" "
		if (!almacen.Trim().IsEmpty()) {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {

			if (!sucursal.Trim().IsEmpty() && sucursal!=" ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
			} else {
				AnsiString condicionEmpresa = " ";
				if (empresa != " ") {
					condicionEmpresa.sprintf(" AND suc.idempresa = %s ", empresa);
				}
				instruccion.sprintf("SELECT a.almacen FROM almacenes a\
				INNER JOIN secciones s ON a.seccion=s.seccion\
				INNER JOIN sucursales suc ON suc.sucursal = s.sucursal %s ", condicionEmpresa);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), resp_almacenes);
			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
			}
		}

		// Obtiene el producto, la presentacion y el multiplo
		instruccion.sprintf("select @producto:=a.producto, @present:=a.present, @multiplo:=a.multiplo \
			from articulos a where a.articulo='%s'", articulo);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		if (fecha_hoy == fecha) {
			// Revisa si hay registro en ventasxmes (solo cuando se la fecha del reporte es hoy, que es cuando se va a ocupar)
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("SELECT ventascorte \
				  FROM ventasxmes \
				  WHERE  producto=@producto AND present=@present %s ",
				condicion_almacen);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_ventasxmes_aux);
			if (resp_ventasxmes_aux->ObtieneNumRegistros() > 0) {
				hay_ventasxmes = true;
			}
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		// Obtiene fecha del corte más próximo previo a la fecha dada
		// PENDIENTE (probar casos cuando considerar_cortes=="1", también revisar
		// ventas promedio y desglosado de ventas mes x mes.
		if (considerar_cortes == "1") {
			/*indice_ventas = "force index(fechavta)";
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'",
				mFg.DateToMySqlDate(fecha)); *///cod. orig
			indice_ventas = "force index(fechavta)"; //agr prb
			if(/*fechaResF!="" && */ fecha_hoy == fecha ){
				instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'",
				mFg.DateToMySqlDate(fecha));
				bandExist = false; //exist actuales
			}else{
				instruccion.sprintf("set @fechacorte='%s'", fechaResF);
			}//agr prb
		}
		else {
			if(fechaResF != "" && fechaResFglon!="2000-01-01"){
				instruccion.sprintf("set @fechacorte='%s'", fechaResF);
			}else{
				instruccion.sprintf("set @fechacorte='1900-01-01'");
			}

			/*
			//instruccion.sprintf("set @fechacorte='1900-01-01'"); //cod orig
			instruccion.sprintf("set @fechacorte='%s'",fechaResFglon); ///agred
			bandExist=true;///   */
			indice_ventas = " ";
		}
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		if ( (modo_calcular_existencias == "MODN" || modo_calcular_existencias == "MODEA" ) && (considerar_cortes == "0" || considerar_cortes == "1") && fechaResFglon != "2000-01-01" ) {

			// Calcula la existencia al momento del corte previo.
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and pce.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " "; ///cod org

			instruccion.sprintf("select @totinicial:=sum(pce.cantidad) as cantidad \
				from existenciasiniciales pce \
				where pce.producto=@producto and pce.present=@present %s ", condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,instruccion.c_str());


			/*instruccion.sprintf("select @totinicial:=sum(pce.cantidad) as cantidad \
				from puntoscorteexistencias pce \
				where pce.fecha=@fechacorte and pce.producto=@producto and pce.present=@present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str()); *////cod orig


			// Calcula las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and c.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totcompras:=sum(d.cantidad*a.factor) as cantidad \
				from compras c, dcompras d, articulos a \
				where c.fechacom>@fechacorte and c.fechacom<='%s' and c.referencia=d.referencia \
				and c.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen); //fecha
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones a las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and c.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totdevcompras:=(sum(d.cantidad*a.factor)*-1) as cantidad \
				from notascredprov n, compras c, dnotascredprov d, articulos a \
				where n.fechanot>@fechacorte and n.fechanot<='%s' and n.tipo='0' \
				and n.referencia=d.referencia and n.compra=c.referencia and \
				n.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las ventas.
			if (considerar_cortes == "1" && hay_ventasxmes)
			{ // Se usa lo precalculado si: se toman en cuenta los cortes y además la fecha del reporte es igual a hoy
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" and almacen in (%s) ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf(" \
					SELECT @totventas:=sum(ventascorte*-1) AS cantidad \
					  FROM \
					ventasxmes \
					  WHERE  producto=@producto AND present=@present %s ",
					condicion_almacen);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
					instruccion.c_str());
			}
			else {
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" and d.almacen in (%s) ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf(" \
					select @totventas:=sum((d.cantidad*a.factor)*-1) as cantidad \
					from ventas v %s, dventas d, articulos a \
					where v.fechavta>@fechacorte and v.fechavta<='%s' and v.referencia=d.referencia \
					and v.cancelado=0 and d.articulo=a.articulo and  \
					a.producto=@producto and a.present=@present %s",
					indice_ventas, mFg.DateToMySqlDate(fecha),
					condicion_almacen);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
					instruccion.c_str());
			}

			// Calcula las devoluciones a las ventas
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and dv.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf(" \
				select @totdevventas:=sum(dn.cantidad*a.factor) as cantidad \
				from notascredcli n, dnotascredcli dn, ventas v, dventas dv, articulos a \
				where n.fechanot>@fechacorte and n.fechanot<='%s' and n.tipo='0' \
				and n.referencia=dn.referencia and n.venta=v.referencia \
				and v.referencia=dv.referencia and \
				n.cancelado=0 and dn.articulo=a.articulo and dv.articulo=dn.articulo and \
				a.producto=@producto and a.present=@present %s",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las entradas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and m.almaent in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totentradas:=sum(d.cantidad*a.factor) as cantidad \
				from movalma m, dmovalma d, articulos a \
				where m.fechamov>@fechacorte and m.fechamov<='%s' and m.movimiento=d.movimiento \
				and m.tipo<>'S' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las salidas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and m.almasal in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totsalidas:=(sum(d.cantidad*a.factor)*-1) as cantidad \
				from movalma m, dmovalma d, articulos a \
				where m.fechamov>@fechacorte and m.fechamov<='%s' and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

		}else if( (modo_calcular_existencias == "MODN" || modo_calcular_existencias == "MODEA") && (considerar_cortes == "1" || considerar_cortes == "0") && fechaResFglon=="2000-01-01"){
			// Calcula la existencia al momento del corte previo.
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and pce.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " "; ///cod org
			instruccion.sprintf("select @totinicial:=sum(pce.cantidad) as cantidad \
				from puntoscorteexistencias pce \
				where pce.fecha=@fechacorte and pce.producto=@producto and pce.present=@present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str()); ///cod orig


			// Calcula las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and c.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totcompras:=sum(d.cantidad*a.factor) as cantidad \
				from compras c, dcompras d, articulos a \
				where c.fechacom>@fechacorte and c.fechacom<='%s' and c.referencia=d.referencia \
				and c.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen); //fecha
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones a las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and c.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totdevcompras:=(sum(d.cantidad*a.factor)*-1) as cantidad \
				from notascredprov n, compras c, dnotascredprov d, articulos a \
				where n.fechanot>@fechacorte and n.fechanot<='%s' and n.tipo='0' \
				and n.referencia=d.referencia and n.compra=c.referencia and \
				n.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las ventas.
			if (considerar_cortes == "1" && hay_ventasxmes)
			{ // Se usa lo precalculado si: se toman en cuenta los cortes y además la fecha del reporte es igual a hoy
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" and almacen in (%s) ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf(" \
					SELECT @totventas:=sum(ventascorte*-1) AS cantidad \
					  FROM \
					ventasxmes \
					  WHERE  producto=@producto AND present=@present %s ",
					condicion_almacen);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
					instruccion.c_str());
			}
			else {
				if (cad_conjunto_almacenes != " ") {
					condicion_almacen.sprintf(" and d.almacen in (%s) ",
						cad_conjunto_almacenes);
				}
				else
					condicion_almacen = " ";
				instruccion.sprintf(" \
					select @totventas:=sum((d.cantidad*a.factor)*-1) as cantidad \
					from ventas v %s, dventas d, articulos a \
					where v.fechavta>@fechacorte and v.fechavta<='%s' and v.referencia=d.referencia \
					and v.cancelado=0 and d.articulo=a.articulo and  \
					a.producto=@producto and a.present=@present %s",
					indice_ventas, mFg.DateToMySqlDate(fecha),
					condicion_almacen);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
					instruccion.c_str());
			}

			// Calcula las devoluciones a las ventas
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and dv.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf(" \
				select @totdevventas:=sum(dn.cantidad*a.factor) as cantidad \
				from notascredcli n, dnotascredcli dn, ventas v, dventas dv, articulos a \
				where n.fechanot>@fechacorte and n.fechanot<='%s' and n.tipo='0' \
				and n.referencia=dn.referencia and n.venta=v.referencia \
				and v.referencia=dv.referencia and \
				n.cancelado=0 and dn.articulo=a.articulo and dv.articulo=dn.articulo and \
				a.producto=@producto and a.present=@present %s",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las entradas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and m.almaent in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totentradas:=sum(d.cantidad*a.factor) as cantidad \
				from movalma m, dmovalma d, articulos a \
				where m.fechamov>@fechacorte and m.fechamov<='%s' and m.movimiento=d.movimiento \
				and m.tipo<>'S' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las salidas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and m.almasal in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("select @totsalidas:=(sum(d.cantidad*a.factor)*-1) as cantidad \
				from movalma m, dmovalma d, articulos a \
				where m.fechamov>@fechacorte and m.fechamov<='%s' and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s ",
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
		}//prb else if con 3 condiciones
		else if ( modo_calcular_existencias == "MODEAAC"/*modo_calcular_existencias == "MODEA" && considerar_cortes == "1"*/ /*|| considerar_cortes=="0")*/ ) {

			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and alm.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			///cod original
			// Inicial en cero
			AnsiString condicionEmpresa = " ";
			if (empresa != " ") {
				condicionEmpresa.sprintf(" AND suc.idempresa = %s ", empresa);
			}
			instruccion.sprintf("SELECT @totinicial:=SUM(cantinicial) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				, condicionEmpresa ,condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las compras
			instruccion.sprintf("SELECT @totcompras:=SUM(compras) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				, condicionEmpresa ,condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones de compras
			instruccion.sprintf("SELECT @totdevcompras:=(SUM(devcompras)*-1) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				, condicionEmpresa ,condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las ventas
			instruccion.sprintf("SELECT @totventas:=(SUM(ventas)*-1) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				, condicionEmpresa, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones de ventas
			instruccion.sprintf("SELECT @totdevventas:=SUM(devventas) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				,condicionEmpresa ,condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las entradas
			instruccion.sprintf("SELECT @totentradas:=SUM(entradas) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				,condicionEmpresa ,condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las salidas
			instruccion.sprintf("SELECT @totsalidas:=(SUM(salidas)*-1) as cantidad FROM \
					existenciasactuales ex\
					INNER JOIN almacenes alm ON alm.almacen=ex.almacen\
					INNER JOIN secciones sec ON sec.seccion=alm.seccion\
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
					WHERE producto = @producto AND present = @present %s "
				, condicionEmpresa, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());



		} else if( modo_calcular_existencias == "MODN" && considerar_cortes == "1"){
			// Inicial en cero
			instruccion.sprintf("SELECT @totinicial:=SUM(cantidad) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las compras
			instruccion.sprintf("SELECT @totcompras:=SUM(compras) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones de compras
			instruccion.sprintf("SELECT @totdevcompras:=(SUM(devcompras)*-1) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las ventas
			instruccion.sprintf("SELECT @totventas:=(SUM(ventas)*-1) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las devoluciones de ventas
			instruccion.sprintf("SELECT @totdevventas:=SUM(devventas) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las entradas
			instruccion.sprintf("SELECT @totentradas:=SUM(entradas) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());

			// Calcula las salidas
			instruccion.sprintf("SELECT @totsalidas:=(SUM(salidas)*-1) as cantidad FROM \
					existenciasiniciales WHERE producto = @producto AND present = @present %s "
				, condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
		}else
			throw Exception
				("Configuración de modo de calculo de existencias con modo de corte está incorrecta"
				);

		if ((dias == 30 || dias == 60 || dias == 90 || dias == 180)
			&& hay_ventasxmes) {
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and almacen in (%s) ",
					cad_conjunto_almacenes);
				condicion_almacen3.sprintf(" and alm.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";

			AnsiString condicionEmpresa = " ";
			if (empresa != " ") {
				condicionEmpresa.sprintf(" AND suc.idempresa = %s ", empresa);
			}
			instruccion.sprintf(" \
				SELECT @totventasparapromediar:=sum(ventas%d) AS cantidad \
				FROM ventasxmes vm\
				INNER JOIN almacenes alm ON alm.almacen=vm.almacen\
				INNER JOIN secciones sec ON sec.seccion=alm.seccion\
				INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
				WHERE  producto=@producto AND present=@present %s ", dias,
				 condicionEmpresa,condicion_almacen3);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
		}
		else {
			// En caso de que se quiera un promedio de ventas de un número diferente a 180,
			// se tiene que Calcular dichas ventas.
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" and d.almacen in (%s) ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf(" \
				select @totventasparapromediar:=sum(cantvent) from \
				((select sum((d.cantidad*a.factor)) as cantvent \
				from ventas v %s, dventas d, articulos a \
				where v.fechavta>='%s' and v.fechavta<='%s' and v.referencia=d.referencia \
				and v.cancelado=0 and d.articulo=a.articulo and  \
				a.producto=@producto and a.present=@present %s) \
				UNION \
				(select sum(dn.cantidad*a.factor*-1) as cantvent \
				from notascredcli n, dnotascredcli dn, ventas v, dventas d, articulos a \
				where n.fechanot>='%s' and n.fechanot<='%s' and n.tipo='0' \
				and n.referencia=dn.referencia and n.venta=v.referencia \
				and v.referencia=d.referencia and \
				n.cancelado=0 and dn.articulo=a.articulo and d.articulo=dn.articulo and \
				a.producto=@producto and a.present=@present %s)) t ",
				indice_ventas, mFg.DateToMySqlDate(fecha_inicial_promedio),
				mFg.DateToMySqlDate(fecha), condicion_almacen,
				mFg.DateToMySqlDate(fecha_inicial_promedio),
				mFg.DateToMySqlDate(fecha), condicion_almacen);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				instruccion.c_str());
		}

		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf("  AND ma.almaent NOT IN (%s)  \
				AND ma.almasal IN (%s)", cad_conjunto_almacenes,
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		instruccion.sprintf("SELECT @totsum:=SUM(dm.cantidad * a.factor) \
				FROM movalma ma INNER JOIN dmovalma dm ON ma.movimiento = dm.movimiento INNER JOIN    \
				articulos a ON a.articulo = dm.articulo WHERE ma.tipo = 'T' %s AND ma.fechamov >= '%s'  and ma.aplica='1' \
				AND ma.fechamov <= '%s' AND a.producto = @producto AND a.present = @present AND ma.cancelado = 0 \
				GROUP BY a.producto,a.present  ORDER BY a.producto",
			condicion_almacen, mFg.DateToMySqlDate(fecha_inicial_promedio),
			mFg.DateToMySqlDate(fecha));
		mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
			instruccion.c_str());

		instruccion.sprintf("SELECT @totsalidassucnounif:=SUM(dm.cantidad * a.factor) \
					FROM movalma ma \
						INNER JOIN dmovalma dm ON ma.movimiento = dm.movimiento \
						INNER JOIN articulos a ON a.articulo = dm.articulo \
						INNER JOIN conceptosmovalma cma ON ma.concepto = cma.concepto \
					WHERE ma.tipo = 'S' AND ma.fechamov >= '%s' AND ma.fechamov <= '%s' \
						AND ma.aplica='1' %s  AND a.producto = @producto AND a.present = @present \
						AND ma.cancelado = 0 AND cma.traspasosucnouni = 1 \
					GROUP BY a.producto,a.present  ORDER BY a.producto",
			mFg.DateToMySqlDate(fecha_inicial_promedio),
			mFg.DateToMySqlDate(fecha), condicion_almacen);
		mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
			instruccion.c_str());

		// Obtiene las ventas x mes precalculadas
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" and almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		AnsiString condicion_almacen2;
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen2.sprintf(" and alm.almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen2 = " ";
		AnsiString condicionEmpresa = " ";
		if (empresa != " ") {
			condicionEmpresa.sprintf(" AND suc.idempresa = %s ", empresa);
		}
		instruccion.sprintf(" \
			SELECT vx.almacen, vx.producto, vx.present, \
				sum(cant1) as cant1, sum(cant2) as cant2, sum(cant3) as cant3, sum(cant4) as cant4, sum(cant5) as cant5, sum(cant6) as cant6, sum(cant7) as cant7, sum(cant8) as cant8, \
				sum(cant9) as cant9, sum(cant10) as cant10, sum(cant11) as cant11, sum(cant12) as cant12, sum(cant13) as cant13, sum(cant14) as cant14, sum(cant15) as cant15, \
				sum(cant16) as cant16, sum(cant17) as cant17, sum(cant18) as cant18, sum(cant19) as cant19, sum(cant20) as cant20, sum(cant21) as cant21, sum(cant22) as cant22, \
				sum(cant23) as cant23, sum(cant24) as cant24,\
				SUM(cant25) AS cant25, SUM(cant26) AS cant26, SUM(cant27) AS cant27, SUM(cant28) AS cant28, SUM(cant29) AS cant29, SUM(cant30) AS cant30, SUM(cant31) AS cant31, SUM(cant32) AS cant32,  \
				SUM(cant33) AS cant33, SUM(cant34) AS cant34, SUM(cant35) AS cant35, SUM(cant36) AS cant36,  \
				sum(ventas180) as ventas180, sum(ventascorte) as ventascorte \
			  FROM ventasxmes vx\
			INNER JOIN almacenes alm ON alm.almacen=vx.almacen\
			INNER JOIN secciones sec ON sec.seccion=alm.seccion \
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal %s\
			  WHERE  producto=@producto AND present=@present %s ",
			condicionEmpresa,condicion_almacen2);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Desglose de movimientos por almacén
		instruccion.sprintf("select \
			IFNULL(@totinicial,0) as cantinic, \
			IFNULL(@totcompras,0) as cantcomp, \
			IFNULL(@totdevcompras,0) as cantdevc, \
			IFNULL(@totventas,0) as cantvent, \
			IFNULL(@totdevventas,0) as cantdevv, \
			IFNULL(@totentradas,0) as cantentr, \
			IFNULL(@totsalidas,0) as cantsali, \
			(IFNULL(@totinicial,0)+IFNULL(@totcompras,0)+IFNULL(@totdevcompras,0)+IFNULL(@totventas,0)+IFNULL(@totdevventas,0)+IFNULL(@totentradas,0)+IFNULL(@totsalidas,0)) as canttot, \
			IFNULL(@totventasparapromediar,0)/(%s) as cantpromedio,  \
			IFNULL(@totsum,0) as saltrasp, \
			IFNULL(@totsum,0)/(%s) as saltraspprom, \
			IFNULL(@totsalidassucnounif,0) as saltraspnouni, \
			IFNULL(@totsalidassucnounif,0)/(%s) as saltraspnouniprom, \
			IFNULL(IFNULL(@totsum,0) + IFNULL(@totventasparapromediar,0) + IFNULL(@totsalidassucnounif,0),0)/(%s) as saltrasptotvtasprom"
			, mFg.FormateaCantidad(divisor, 6, false),
			mFg.FormateaCantidad(divisor, 6, false),
			mFg.FormateaCantidad(divisor, 6, false),
			mFg.FormateaCantidad(divisor, 6, false));
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Posibles multiplos del producto-presentacion
		instruccion.sprintf("select multiplo, factor from articulos a where a.producto=@producto and a.present=@present \
							%s order by a.factor desc",
			condicion_articulos_inactivos);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Fecha del corte
		instruccion.sprintf("select @fechacorte as fechacorte, '%s' as mes",
			cad_mes_actual);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" AND dv.almacen in (%s) ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		instruccion.sprintf("SELECT SUM(cant%s) AS cantidad \
			FROM \
				((SELECT dv.almacen AS almacen, a.producto, a.present, SUM(IF(YEAR(v.fechavta)=%s \
				AND MONTH(fechavta)=%s, dv.cantidad * a.factor, 0)) AS cant%s, \
				SUM(IF(v.fechavta>=DATE_SUB('%s', INTERVAL 180 DAY) AND \
				v.fechavta<='%s', dv.cantidad * a.factor, 0)) AS ventas180, \
				SUM(IF(v.fechavta>@fechacorte AND v.fechavta<='%s', dv.cantidad * a.factor, 0)) AS ventascorte \
			FROM ventas v \
				INNER JOIN dventas dv ON v.referencia = dv.referencia \
				INNER JOIN articulos a ON dv.articulo=a.articulo \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones sec ON sec.seccion = t.seccion \
				INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND a.producto = @producto \
				AND a.present = @present %s \
				AND v.cancelado = 0 %s GROUP BY dv.almacen, a.producto, a.present)   \
			UNION  \
				(SELECT dv.almacen AS almacen, a.producto, a.present, SUM(IF(YEAR(n.fechanot)=%s AND  \
				MONTH(n.fechanot)=%s, dn.cantidad * a.factor*-1, 0)) AS cant%s, \
				SUM(IF(n.fechanot>=DATE_SUB('%s', INTERVAL 180 DAY) AND n.fechanot<='%s', \
				dn.cantidad * a.factor*-1, 0)) AS ventas180, 0 AS ventascorte \
			FROM notascredcli n \
				INNER JOIN dnotascredcli dn ON  n.referencia = dn.referencia \
				INNER JOIN ventas v ON  n.venta = v.referencia \
				INNER JOIN dventas dv ON v.referencia = dv.referencia AND dv.articulo=dn.articulo \
				INNER JOIN articulos a ON dv.articulo=a.articulo \
				INNER JOIN terminales t ON t.terminal = n.terminal \
				INNER JOIN secciones sec ON sec.seccion = t.seccion \
				INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
				WHERE n.fechanot BETWEEN '%s' AND '%s' AND n.cancelado = 0 AND \
				n.tipo = '0' AND a.producto = @producto AND a.present = @present %s \
				%s \
				GROUP BY dv.almacen, a.producto, a.present )) t GROUP BY producto, present",
				cad_mes_corresp,
				cad_anio_actual,
				cad_mes_actual, cad_mes_corresp,
				cad_fecha_hoy,
				cad_fecha_hoy,
				cad_fecha_hoy,
				cad_fecha_inicio, cad_fecha_hoy,
				condicion_almacen,
				condicionEmpresa,
				cad_anio_actual,
				cad_mes_actual,
				cad_mes_corresp,
				cad_fecha_hoy, cad_fecha_hoy,
				cad_fecha_inicio, cad_fecha_hoy,
				condicion_almacen,
				condicionEmpresa);
		/* mes correspondiente, año actual, mes actual, mes correspondiente,
		 fecha de hoy, fecha de hoy, fecha de hoy , fecha de inicio, fecha de hoy, fecha de hoy
		 año actual, mes actual, mes correspondiente, fecha de hoy, fecha de hoy,
		 fecha de inicio, fecha de hoy */
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Conjunto de almacenes
		instruccion.sprintf("select cast(\"%s\" as char) as conjalma ",
			cad_conjunto_almacenes);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		condicionEmpresa = " ";
		if (empresa != " ") {
			condicionEmpresa.sprintf(" AND t.idempresa = %s ", empresa);
		}

		// Todos los precios del articulo.
		instruccion.sprintf("select p.tipoprec, t.descripcion, precio from tiposdeprecios t, \
						   precios p where p.tipoprec=t.tipoprec and p.articulo='%s' %s order by p.tipoprec"
			, articulo, condicionEmpresa);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		condicionEmpresa = " ";
		if (empresa != " ") {
			condicionEmpresa.sprintf(" AND idempresa = %s ", empresa);
		}

		// Costo base
		instruccion.sprintf
			("SELECT costobase FROM presentacionescb WHERE producto=@producto AND present=@present %s ",
				condicionEmpresa);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// ALERTA DESCONTINUADO// Obtiene si el producto por sucursal se encuentra descontinuado
		// Funciona solo la sucursal es difenrete de vacio
		instruccion.printf
			("select descontinuado from articulosped where producto=@producto and present=@present and sucursal='%s'",
			sucursal);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_ventasxmes_aux != NULL)
			delete resp_ventasxmes_aux;

	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCARTAS_PORTE
void ServidorReportes::EjecutaRepCartasPorte(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fecha_inicial, fecha_final, empresa, acredito, status, terminal;
	AnsiString tipo_carta, cuota, via, chofer, proveedor_origen,
		cliente_destino;

	AnsiString condicion_empresa = " ";
	AnsiString condicion_acredito = " ";
	AnsiString condicion_status = " ";
	AnsiString condicion_terminal = " ";
	AnsiString condicion_tipo_carta = " ";
	AnsiString condicion_cuota = " ";
	AnsiString condicion_via = " ";
	AnsiString condicion_chofer = " ";
	AnsiString condicion_proveedor_origen = " ";
	AnsiString condicion_cliente_destino = " ";

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	status = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_carta = mFg.ExtraeStringDeBuffer(&parametros);
	cuota = mFg.ExtraeStringDeBuffer(&parametros);
	via = mFg.ExtraeStringDeBuffer(&parametros);
	chofer = mFg.ExtraeStringDeBuffer(&parametros);
	cliente_destino = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor_origen = mFg.ExtraeStringDeBuffer(&parametros);

	if (empresa != " ") {
		condicion_empresa.sprintf("and cp.empresatrans='%s' ", empresa);
	}

	if (status != " ") {
		condicion_status.sprintf("and cp.cancelado='%s' ", status);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf("and cp.terminal='%s' ", terminal);
	}

	if (tipo_carta != " ") {
		condicion_tipo_carta.sprintf("and cp.tipocarta=%s ", tipo_carta);
	}

	if (cuota != " ") {
		condicion_cuota.sprintf("and cp.cuota=%s ", cuota);
	}

	if (via != " ") {
		condicion_via.sprintf("and cp.via='%s' ", via);
	}

	if (chofer != " ") {
		condicion_chofer.sprintf("and cp.chofer='%s' ", chofer);
	}

	if (cliente_destino != " ") {
		condicion_cliente_destino.sprintf("and cp.clientedest='%s' ",
			cliente_destino);
	}

	if (proveedor_origen != " ") {
		condicion_proveedor_origen.sprintf("and cp.proveedororig='%s' ",
			proveedor_origen);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	instruccion.sprintf("select  cp.referencia, cfdcartasporte.cfduuid, cp.empresatrans, cp.fechacp, c.rsocial AS nomcliente, p.razonsocial AS nomprov, \
			  cp.valor, \
			  (cp.flete + cp.maniobras) AS subtotal, \
			  ((cp.flete + cp.maniobras) * cp.porciva) / 100 AS iva, \
			  (cp.flete * cp.porcret) / 100 AS retencion, \
			  cp.flete, cp.maniobras, SUM(d.peso) AS peso, \
			  cp.cancelado \
			from cartasporte cp \
			INNER JOIN dcartaspconcep d ON cp.referencia=d.referencia \
			LEFT JOIN clientes c ON cp.clientedest=c.cliente \
			LEFT JOIN proveedores p ON cp.proveedororig=p.proveedor \
			LEFT JOIN cfdcartasporte on cp.referencia=cfdcartasporte.referencia \
			where cp.fechacp between '%s' and '%s' \
			%s %s %s %s %s %s %s %s %s %s \
			group by cp.referencia \
			order by cp.fechacp, cp.referencia ", fecha_inicial, fecha_final,
		condicion_empresa, condicion_acredito, condicion_status,
		condicion_terminal, condicion_tipo_carta, condicion_cuota,
		condicion_via, condicion_chofer, condicion_proveedor_origen,
		condicion_cliente_destino);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCALCULAR_PEDIDOS
void ServidorReportes::EjecutaRepCalcularPedidos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 21];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1202];
	AnsiString terminal, articulo, considerar_cortes;
	AnsiString prov_predeterminado, condicion_prov = " ";
	AnsiString fecha, fecha_ini_venta, fecha_venta;
	AnsiString almacen, stock, producto, perdidas, ventas;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos, marca;
	AnsiString condicion_almacen = " ", condicion_producto = " ",
		condicion_preciounit = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ",
		condicion_marca = " ", condicion_perdidas = " ";
	AnsiString join_productos = " ", join_precios_perdidas = " ";
	AnsiString calculo_promedio_ventas, calculo_promedio_devventas;
	TDate fecha_inicial_promedio, fv;
	int dias, tipopromedio;
	AnsiString forzar_indice_vta = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5;
	AnsiString archivo_temp6 = "", archivo_temp7 = "", archivo_temp8 = "",
		archivo_temp9 = "", archivo_temp10 = "";
	double divisor;
	BufferRespuestas* resp_almacenes = NULL;
	int costoscompra;
	AnsiString camposcostoscompra = " ", leftcostoscompra = " ", leftauxnotas =
		" ", camposauxnotas = " ", camposmesesant = " ";
	AnsiString cadena_join_ventasxmes = " ";
	AnsiString inner_provcompras = " ", condicion_meses = " ";

	BufferRespuestas* resp_conceptosmovvent = NULL;
	AnsiString concepto;
	AnsiString cad_conjunto_conceptos = " ";
	AnsiString calculo_promedio_salidas;
	AnsiString condicion_concepto = " ";
	AnsiString productobloqueados, condicion_productob = " ",
		campo_productobloqueado = " ";
	AnsiString consider_salidas_ventas, present_super_gere,
		condicion_present_super_geren = " ";
	AnsiString condicion_prov_esp_INNER = " ";
	AnsiString no_mostrar_marcas_excluidas, condicion_marca_excluir = " ",
		mostrar_presentaciones_cotizables = " ";
	AnsiString archivo_temp11, archivo_temp12, archivo_temp13, archivo_temp14,
		archivo_temp15, archivo_temp16;
	AnsiString archivo_temp17, archivo_temp18, archivo_temp19, archivo_temp21;
	AnsiString promediar_dias_con_exist;
	AnsiString prov_historico, meses;
	AnsiString fabricante, segmento;
	AnsiString condicion_fabricante = " ", condicion_segmento = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString ultima_fecha_compra_desplazamiento, join_fecha_compra = " ",
		campo_fecha_compra = " ";

	TDate fecha_hoy = Today();
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes actual
	int mes_ant = (mes_actual + 24) - 1; // Mes anterior
	int mes_penant = (mes_actual + 24) - 2; // Mes penultimo anterior
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_mes_ant = mFg.IntToAnsiString(mes_ant);
	AnsiString cad_mes_penant = mFg.IntToAnsiString(mes_penant);
	bool archivo_temp15_delete = false;

	AnsiString artactxsuc;
	AnsiString inner_artactxsuc = " ";
	AnsiString listaTags, join_art_tags = " ", condicion_art_tags = " ";

	AnsiString ventaOnline;
	AnsiString condicion_ventaOnline = " ";
	AnsiString claveSucExist, condicion_claveSucExist = " ";

	AnsiString diasmuestra;

	AnsiString clasifcont, clasifcont2, supervisado, campo_supervisado = " ";
	AnsiString condicion_clasifcont = " ", condicion_clasifcont2 = " ";
	AnsiString condicion_supervisado = " ", condicion_supervisado2 = " ",
		condicion_supervisado3 = " ";
	AnsiString join_supervisado = " ", join_supervisado2 = " ",
		join_supervisado3 = " ", join_supervisado4 = " ";

	AnsiString essupervisado, productosSinVenta;
	AnsiString inner_productossinventa = " ", condicion_tr_sucursal = " ";

    AnsiString idEmpresa = " ";

	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		perdidas = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		dias = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		tipopromedio = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		costoscompra = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		prov_predeterminado = mFg.ExtraeStringDeBuffer(&parametros);
		ventas = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_ini_venta = mFg.ExtraeStringDeBuffer(&parametros);
		productobloqueados = mFg.ExtraeStringDeBuffer(&parametros);
		consider_salidas_ventas = mFg.ExtraeStringDeBuffer(&parametros);
		present_super_gere = mFg.ExtraeStringDeBuffer(&parametros);
		// nuevo parametro de presentacion supervisadas por gerencia
		no_mostrar_marcas_excluidas = mFg.ExtraeStringDeBuffer(&parametros);
		mostrar_presentaciones_cotizables =
			mFg.ExtraeStringDeBuffer(&parametros);
		promediar_dias_con_exist = mFg.ExtraeStringDeBuffer(&parametros);
		prov_historico = mFg.ExtraeStringDeBuffer(&parametros);
		meses = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		ultima_fecha_compra_desplazamiento =
			mFg.ExtraeStringDeBuffer(&parametros);
		artactxsuc = mFg.ExtraeStringDeBuffer(&parametros);
		listaTags = mFg.ExtraeStringDeBuffer(&parametros);
		ventaOnline = mFg.ExtraeStringDeBuffer(&parametros);
		claveSucExist = mFg.ExtraeStringDeBuffer(&parametros);
		diasmuestra = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		supervisado = mFg.ExtraeStringDeBuffer(&parametros);
		essupervisado = mFg.ExtraeStringDeBuffer(&parametros);

		productosSinVenta = mFg.ExtraeStringDeBuffer(&parametros);

        idEmpresa = FormServidor->ObtieneClaveEmpresa();

		if (tipopromedio == 0) {
			divisor = dias / 30.5;
		}
		if (tipopromedio == 1) {
			divisor = dias / 15;
		}
		if (tipopromedio == 2) {
			divisor = dias / 7;
		}
		if (tipopromedio == 3) {
			divisor = dias / 1;
		}

		/*
		 cuando se cambien los dias 30-60-90-180 es necesario que la validacion
		 del case=when cambie para considerar la columna de los dias correspondientes

		 */

		if (perdidas == 1) {
			condicion_preciounit = ", prec1.precio";
			join_precios_perdidas =
				"INNER JOIN precios prec1 ON prec1.articulo= am.articulo  AND  prec1.tipoprec=@precautosu  \
				INNER JOIN tiposdeprecios tp ON tp.tipoprec=prec1.tipoprec AND tp.idempresa="+ FormServidor->ObtieneClaveEmpresa()+" \ ";
		}

		if (costoscompra == 1) {
			camposcostoscompra =
				" , acc.costocompraimp , acc.ultimcostocompsin, \
			(acc.costocompraimp/e.maxfactor) as ultimcostounidad,(acc.ultimcostocompsin/e.maxfactor) as ulcostosinmpunid ";
			leftcostoscompra =
				" left join auxcostoscompra acc ON acc.producto=a.producto and acc.present=a.present ";
		}
		if (ventas == "1") {
			camposauxnotas = ", axn.totventa,axn.totunidades ,axn.subtotventa";
			leftauxnotas =
				" left join auxnotas axn ON axn.producto=a.producto and axn.present=a.present ";
		}

		if (prov_predeterminado != " ") {
			condicion_prov = " and ap.proveedor='" + prov_predeterminado + "'";
		}

		// fecha_inicial_promedio=IncMonth(mFg.MySqlDateToTDate(fecha.c_str()), meses*-1);
		fecha_inicial_promedio = mFg.MySqlDateToTDate(fecha.c_str()) - dias;
		// fv = mFg.DateToMySqlDate(fecha_ini_venta);

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		// Obtiene los conceptos de movalma que se interpretan como venta para
		// propósito de rotacion de mercancía (ej: calculo de cuanto pedir)
		instruccion.sprintf("SELECT concepto FROM conceptosmovvent");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_conceptosmovvent);
		for (i = 0; i < resp_conceptosmovvent->ObtieneNumRegistros(); i++) {
			resp_conceptosmovvent->IrAlRegistroNumero(i);
			concepto = resp_conceptosmovvent->ObtieneDato("concepto");

			cad_conjunto_conceptos += "'";
			cad_conjunto_conceptos += concepto;
			cad_conjunto_conceptos += "'";
			if (i < resp_conceptosmovvent->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo le signo +.
					cad_conjunto_conceptos += ",";
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (productobloqueados == "1") {
			condicion_productob.sprintf
				("AND (present.producto, present.present) NOT IN (SELECT producto, present FROM ProdbloqueadoCompra pb WHERE pb.producto=present.producto and pb.present=present.present) "
				);
			campo_productobloqueado.sprintf
				(",   IFNULL((SELECT '0'),0) AS prodbloq");
		}
		else {
			// este nuevo campo se tiene que ejecutar encuentre o no productos bloqueados para compra
			campo_productobloqueado.sprintf
				(", IFNULL((SELECT '1' FROM ProdbloqueadoCompra pb WHERE  pb.producto=e.producto AND pb.present=e.present),0) AS prodbloq "
				);
		}

		if (clasifcont != " ") {
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasifcont.sprintf(" prod.clasifcont='%s' AND ",
				clasifcont);
		}

		if (clasifcont2 != " ") {
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasifcont2.sprintf(" prod.clasifcont2='%s' AND ",
				clasifcont2);
		}
		join_supervisado =
			" INNER JOIN articulossupervisados arts ON arts.producto = a.producto AND arts.present = a.present \
								INNER JOIN empleados emp on emp.empleado=arts.usuario ";
		join_supervisado2 =
			" INNER JOIN articulossupervisados arts ON arts.producto = vm.producto AND arts.present = vm.present \
								INNER JOIN empleados emp on emp.empleado=arts.usuario ";

		join_supervisado4 =
			" INNER JOIN articulossupervisados arts ON arts.producto = pce.producto AND arts.present = pce.present \
								INNER JOIN empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado =
			", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado";

		if (supervisado != " ") {
			join_supervisado3 = ", articulossupervisados arts , empleados emp ";
			condicion_supervisado.sprintf(" arts.usuario='%s' AND ",
				supervisado);
			condicion_supervisado2.sprintf(" arts.producto = a.producto AND \
			arts.present = a.present AND ");
			condicion_supervisado3.sprintf(" arts.producto = pce.producto AND \
			arts.present = pce.present AND emp.empleado=arts.usuario AND ");

		}
		else {
			// campo_supervisado = " , ' ' AS supervisado";
		}

		if (no_mostrar_marcas_excluidas == "1") {
			// Se obtienen todas las marcas para excluirlas
			BufferRespuestas* res_marcasexistsim = NULL;
			AnsiString marcasExcluirReporte;
			int cantMarcas = 0;
			try {
				instruccion = "SELECT marca FROM marcasexistsim";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), res_marcasexistsim);

				cantMarcas = res_marcasexistsim->ObtieneNumRegistros();
				for (i = 0; i < res_marcasexistsim->ObtieneNumRegistros(); i++)
				{
					if (i == res_marcasexistsim->ObtieneNumRegistros() - 1)
						marcasExcluirReporte +=
							"'" + res_marcasexistsim->ObtieneDato
							("marca") + "'";
					else
						marcasExcluirReporte +=
							"'" + res_marcasexistsim->ObtieneDato
							("marca") + "',";

					res_marcasexistsim->IrAlSiguienteRegistro();
				}

			}
			__finally {
				if (res_marcasexistsim != NULL)
					delete res_marcasexistsim;
			}

			if (cantMarcas > 0)
				condicion_marca_excluir.sprintf(" AND prod.marca NOT IN(%s) ",
				marcasExcluirReporte);
			else
				condicion_marca_excluir.sprintf(" ");
		}

		if (mostrar_presentaciones_cotizables == "1") {
			mostrar_presentaciones_cotizables = " AND present.cotizable=1 ";
		}
		else {
			mostrar_presentaciones_cotizables = " ";
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		// Usaremos el segmento de presentacion
		if (segmento != " ") {

			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);
			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=a.producto AND present.present=a.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="
				  + FormServidor->ObtieneClaveEmpresa();
			// 1 y 4 y 5
			join_presentacion2 =
				" INNER JOIN presentaciones present ON present.producto=pce.producto  AND present.present=pce.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="
				  + FormServidor->ObtieneClaveEmpresa();
			// 2
			join_presentacion3 =
				" INNER JOIN presentaciones present ON  vm.producto=present.producto AND vm.present=present.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="
				  + FormServidor->ObtieneClaveEmpresa();
			// 3

			join_productos =
				" inner join productos prod on a.producto=prod.producto ";

		}

		if (artactxsuc != "0") {
			inner_artactxsuc.sprintf
				("INNER JOIN articulosxsuc axs ON axs.producto = a.producto AND axs.present = a.present AND axs.sucursal IN ('%s')",
				sucursal);
		}

		if (listaTags != " ") {

			join_art_tags.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags.sprintf(" AND artt.idarticulotag in (%s)  ",
				listaTags);
		}

		if (ventaOnline != "0") {
			condicion_ventaOnline.sprintf
				(" INNER JOIN ecommerceproductos ep ON ep.articulo = a.articulo "
				);
		}

		if (sucursal != " ") {
			condicion_tr_sucursal.sprintf(" AND sec.sucursal = '%s' ",
			sucursal);
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		if (considerar_cortes == "1") {
			forzar_indice_vta = " force index(fechavta) ";
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'", fecha);
		}
		else {
			instruccion.sprintf("set @fechacorte='1900-01-01'");
		}
		instrucciones[num_instrucciones++] = instruccion;

		// Sección de optimización
		if (producto != " " || clasif3 != " " || clasif2 != " ") {
			// Si probablemente pueda servirnos más los indices de productos,
			// entonces evitamos forzar el indice de ventas, y dejamos que mysql decida.
			forzar_indice_vta = " ";
		}

		instruccion.sprintf("set @vardias=%d", dias);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("SET @fechainicial=DATE_ADD(@fechafinal, INTERVAL - @vardias DAY) "
			);
		instrucciones[num_instrucciones++] = instruccion;

		if (present_super_gere == 1) {
			condicion_present_super_geren = " AND present.sgerencia=1";
		}
		else {
			condicion_present_super_geren = " ";
		}

		// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
		instruccion = "create temporary table existenciasaux ( \
			producto varchar(8), present varchar(255), \
			tipo varchar(2), cantidad decimal(15,3), cantvpprom decimal(12,3), cantsalprom decimal(12,3), cantvtotprom decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias sumadas
		instruccion = "create temporary table auxexistsumadas ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), cantvpprom decimal(12,3), cantsalprom decimal(12,3), cantvtotprom decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistfinales ( \
			producto varchar(8), present varchar(255), \
			cantidad decimal(12,3), cantvpprom decimal(12,3), cantsalprom decimal(12,3), cantvtotprom decimal(12,3), \
			maxfactor int(5), multmax varchar(10), \
			minfactor int(5), multmin varchar(10), \
			supervisado VARCHAR(120), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			// Crea una tabla donde se pondrán los costos de compra
			instruccion =
				"create temporary table auxcostoscompra (producto varchar(8), present varchar(255), \
				costocompraimp decimal(12,3), ultimcostocompsin DECIMAL(12,3),INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;
		}
		if (ventas == "1") {

			instruccion = "CREATE TEMPORARY TABLE auxnotas ( nombre VARCHAR(50), present VARCHAR(255), producto VARCHAR(8),  \
						totunidades DECIMAL(12,3), subtotventa DECIMAL(16,6), totventa DECIMAL(16,6), \
						INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;
		}

		if (prov_historico == " ") {
			inner_provcompras = " ";
		}
		else {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha, meses, fecha);
			}
			else {
				condicion_meses = " ";
			}
			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present",
				AnsiString(prov_historico).c_str(), condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			inner_provcompras.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pppca.producto=a.producto AND pppca.present=a.present "
				);
		}

		instruccion = "CREATE TEMPORARY TABLE productosprovaux (producto VARCHAR(8), present VARCHAR(255),sucursal VARCHAR(2), \
					 INDEX(producto, present)) ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"CREATE TEMPORARY TABLE totaldiasparapromedio ( producto VARCHAR(8), present VARCHAR(255), \
					 totaldias INT(5),INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		AnsiString condicion_suc_prov = " ";
		if (sucursal != " ")
			condicion_suc_prov.sprintf(" AND sucursal = '%s' ", sucursal);

		archivo_temp11 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT producto, present, sucursal FROM articulosped WHERE \
					proveedor = '%s' %s INTO OUTFILE '%s'", prov_predeterminado,
			condicion_suc_prov, archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE productosprovaux ",
			archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula base (0) de los artículos en cuestión.
		// La utilidad de esto es simplemente para tomar en cuenta todos los articulos aunque no
		// tengan ningun movimiento
		condicion_almacen = " ";
		AnsiString condicion_prov_esp_join = " ";
		AnsiString condicion_prov_esp = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_join = ",productosprovaux ppa ";
			condicion_prov_esp =
				" AND a.producto = ppa.producto AND a.present = ppa.present ";
			condicion_prov_esp_INNER =
				"INNER JOIN productosprovaux ppa ON a.producto = ppa.producto AND a.present = ppa.present";

		}

		archivo_temp12 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'BA' as tipo, \
			0 as cantidad \
			from articulos a %s, productos prod %s %s  \
			where %s %s %s %s %s %s %s %s %s %s %s \
			a.producto=prod.producto %s \
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_prov_esp_join, join_supervisado3,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			condicion_prov_esp,

			archivo_temp12);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp12);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula la existencia al momento del corte previo.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" pce.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		AnsiString condicion_prov_esp_in = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_in =
				" pce.producto = ppa.producto AND pce.present = ppa.present AND ";
		}

		archivo_temp13 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select pce.producto, pce.present, 'IN' as tipo, \
			sum(pce.cantidad) as cantidad \
			from puntoscorteexistencias pce %s, productos prod %s %s \
			where %s %s %s %s %s %s %s %s %s %s %s %s \
			pce.fecha=@fechacorte and pce.producto=prod.producto \
			group by pce.producto, pce.present INTO OUTFILE '%s' ",
			join_presentacion2, condicion_prov_esp_join, join_supervisado3,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_prov_esp_in,
			condicion_fabricante, condicion_segmento, condicion_clasifcont,
			condicion_clasifcont2, condicion_supervisado3,
			condicion_supervisado,

			archivo_temp13);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad)  ",
			archivo_temp13);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		AnsiString condicion_prov_esp_comp = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_comp =
				" INNER JOIN productosprovaux ppa ON ppa.producto = a.producto AND ppa.present = a.present ";
		}
		// ARCHIVO TEMPORAL #1
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from compras c \
			inner join dcompras d on c.referencia=d.referencia \
			inner join articulos a on d.articulo=a.articulo \
			%s %s %s %s\
			where %s %s %s %s %s %s %s %s %s %s %s \
			c.fechacom>@fechacorte and c.fechacom<=@fechafinal and c.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'", join_productos,
			condicion_prov_esp_comp, join_supervisado, join_presentacion1,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		AnsiString condicion_prov_esp_dc = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_dc =
				" AND a.producto = ppa.producto AND a.present = ppa.present ";
		}
		archivo_temp14 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from notascredprov n, compras c, dnotascredprov d, articulos a %s, productos prod %s %s \
			where  %s %s %s %s %s %s %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' \
			and n.referencia=d.referencia and n.compra=c.referencia and \
			n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s \
			group by a.producto, a.present INTO OUTFILE '%s' ",
			join_presentacion1, condicion_prov_esp_join, join_supervisado3,

			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			condicion_prov_esp_dc, archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad)  ",
			archivo_temp14);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las ventas.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" d.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_ventas.sprintf
				(" sum(if(v.fechavta>='%s', d.cantidad*a.factor,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {

			AnsiString condicion_prov_esp_ventas = " ";
			if (cad_conjunto_almacenes != " ") {
				instruccion =
					"CREATE TEMPORARY TABLE ventasxmesaux ( producto VARCHAR(8), present VARCHAR(255), \
							   cantidad DECIMAL(12,3), INDEX(producto, present)) ENGINE = INNODB ";
				instrucciones[num_instrucciones++] = instruccion;

				if (prov_predeterminado != " ") {
					condicion_prov_esp_ventas = " INNER JOIN productosprovaux ppa ON ppa.producto = vxm.producto AND  \
						ppa.present = vxm.present ";
				}

				archivo_temp15 = mServidorVioleta->ObtieneArchivoTemp
					(num_instrucciones, Respuesta->Id);
				instruccion.sprintf("SELECT vxm.producto, vxm.present, SUM(vxm.ventas%d) \
							   FROM ventasxmes vxm %s \
							   WHERE vxm.almacen IN (%s) GROUP BY vxm.producto,vxm.present INTO OUTFILE '%s' "
					, dias, condicion_prov_esp_ventas, cad_conjunto_almacenes,
					archivo_temp15);
				instrucciones[num_instrucciones++] = instruccion;

				instruccion.sprintf
					("LOAD DATA INFILE '%s' INTO TABLE ventasxmesaux ",
					archivo_temp15);
				instrucciones[num_instrucciones++] = instruccion;

				archivo_temp15_delete = true;
				// Confirmación de que el siguiente archivo temporal se va a eliminar

				calculo_promedio_ventas = " vxm.cantidad ";
				cadena_join_ventasxmes =
					" inner join ventasxmesaux vxm ON a.producto = vxm.producto AND a.present = vxm.present ";
				// condicion_almacen = " ";
			}
			else {
				calculo_promedio_ventas.sprintf(" (SELECT SUM(ventas%d) FROM ventasxmes WHERE producto= a.producto \
								AND present = a.present GROUP BY producto, present) "
					, dias);

				if (prov_predeterminado != " ") {
					cadena_join_ventasxmes = " INNER JOIN productosprovaux ppa ON ppa.producto = a.producto AND \
												  ppa.present = a.present ";
				}
				else
					cadena_join_ventasxmes = " ";
			}
		}
		// ARCHIVO TEMPORAL #2
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad, \
			%s as cantvpprom \
			from ventas v %s \
			inner join dventas d on v.referencia=d.referencia \
			inner join articulos a on d.articulo=a.articulo \
			%s %s %s %s \
			where %s %s %s %s %s %s %s %s %s %s %s \
			v.fechavta>@fechacorte and v.fechavta<=@fechafinal and v.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'",
			calculo_promedio_ventas,

			forzar_indice_vta, join_presentacion1, join_productos,
			cadena_join_ventasxmes, join_supervisado,

			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad, cantvpprom)",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las ventas
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" dv.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_devventas.sprintf
				("SUM(IF(n.fechanot>='%s', dn.cantidad*a.factor*-1,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			calculo_promedio_devventas = "0.000";
		}

		AnsiString condicion_prov_esp_dv = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_dv =
				" INNER JOIN productosprovaux ppa ON ppa.producto = a.producto AND ppa.present = a.present ";
		}
		// ARCHIVO TEMPORAL #3
		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad, \
			%s  AS cantdevprom \
			from notascredcli n \
			inner join dnotascredcli dn on n.referencia=dn.referencia \
			inner join ventas v on n.venta=v.referencia \
			inner join dventas dv on v.referencia=dv.referencia and dv.articulo=dn.articulo \
			inner join articulos a on dn.articulo=a.articulo \
			%s %s %s %s \
			where %s %s %s %s %s %s %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' and n.cancelado=0 \
			group by a.producto, a.present INTO OUTFILE '%s'",
			calculo_promedio_devventas, join_presentacion1, join_productos,
			condicion_prov_esp_dv, join_supervisado,

			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_clasifcont, condicion_clasifcont2, condicion_segmento,
			condicion_supervisado2, condicion_supervisado, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad, cantvpprom) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las entradas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almaent in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		AnsiString condicion_prov_esp_join_en = " ";
		AnsiString condicion_prov_esp_en = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_join_en = ",productosprovaux ppa ";
			condicion_prov_esp_en =
				" AND a.producto = ppa.producto AND a.present = ppa.present";
		}
		// ARCHIVO TEMPORAL #4
		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'EN' as tipo, TRUNCATE(sum(d.cantidad*a.factor),3) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod %s %s \
			where %s %s %s %s %s %s %s %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'S' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s \
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_prov_esp_join_en, join_supervisado3,

			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			condicion_prov_esp_en, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las salidas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		AnsiString condicion_prov_esp_join_sa = " ";
		AnsiString condicion_prov_esp_sa = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_join_sa = ",productosprovaux ppa ";
			condicion_prov_esp_sa =
				" AND a.producto = ppa.producto AND a.present = ppa.present";
		}
		// ARCHIVO TEMPORAL #5
		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod %s %s \
			where %s %s %s %s %s %s %s %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'E' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s \
			group by a.producto, a.present INTO OUTFILE '%s'",
			join_presentacion1, condicion_prov_esp_join_sa, join_supervisado3,

			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_fabricante,
			condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
			condicion_supervisado2, condicion_supervisado,

			condicion_prov_esp_sa, archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las salidas de almacén (SOLO LAS QUE SE TOMAN COMO VENTA)
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {

			AnsiString condicion_prov_esp_join_sv = " ";
			AnsiString condicion_prov_esp_sv = " ";
			if (prov_predeterminado != " ") {
				condicion_prov_esp_join_sv = ",productosprovaux ppa ";
				condicion_prov_esp_sv =
					" AND a.producto = ppa.producto AND a.present = ppa.present";
			}

			condicion_concepto.sprintf(" m.concepto in (%s) and ",
				cad_conjunto_conceptos);

			calculo_promedio_salidas.sprintf(" sum(d.cantidad*a.factor) ");
			// ARCHIVO TEMPORAL #6
			archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf(" \
				select a.producto, a.present, 'SV' as tipo, 0 as cantidad, %s as cantsalprom \
				from movalma m, dmovalma d, articulos a %s, productos prod %s %s \
				where m.fechamov>='%s' and %s %s %s %s %s %s %s %s %s %s %s %s \
				m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s \
				group by a.producto, a.present INTO OUTFILE '%s'",
				calculo_promedio_salidas, join_presentacion1,
				condicion_prov_esp_join_sv, join_supervisado3,

				mFg.DateToMySqlDate(fecha_inicial_promedio),

				condicion_almacen, condicion_concepto, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_producto,
				condicion_fabricante, condicion_segmento, condicion_clasifcont,
				condicion_clasifcont2, condicion_supervisado2,
				condicion_supervisado,

				condicion_prov_esp_sv, archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad, cantsalprom) ",
				archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;
		}

		/* CAMBIO DE LUGAR DE LA NUEVA IMPLEMENTACION DE TOTALDE DIAS
		 */
		// ARCHIVO TEMPORAL #7
		// condicion de alamcen
		AnsiString condicion_almacen_mov = " ";
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and",
				cad_conjunto_almacenes);
			condicion_almacen_mov.sprintf(" mv.almaent in (%s) and",
				cad_conjunto_almacenes);
		}
		else {
			condicion_almacen = " ";
			condicion_almacen_mov = " ";
		}

		/* AnsiString condicion_prov_esp_comp = " ";
		 if(prov_predeterminado != " "){
		 condicion_prov_esp_comp = " INNER JOIN productosprovaux ppa ON ppa.producto = a.producto AND ppa.present = a.present ";
		 } */
		archivo_temp7 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		/* quitamos la condicion de almacen
		 condicion_almacen,
		 */

		if (promediar_dias_con_exist == "1" && (dias == 30 || dias == 60 ||
			dias == 90 || dias == 180)) {
			instruccion.sprintf("SELECT pre.producto, pre.present, \
					pre.diasconexist%d AS totaldias \
				FROM precalculohistoriaconexist%s pre \
				inner join productos prod on pre.producto=prod.producto \
				WHERE %s pre.sucursal='%s' \
				INTO OUTFILE '%s' ", dias, idEmpresa, condicion_producto, sucursal,
				archivo_temp7);
		}
		else {
			instruccion.sprintf("SELECT producto, present, \
					(CASE WHEN (TO_DAYS(@fechafinal) - TO_DAYS(MIN(fechacommin))+1)>=@vardias THEN @vardias \
					WHEN (TO_DAYS(@fechafinal) - TO_DAYS(MIN(fechacommin))+1)>=0 THEN (TO_DAYS(@fechafinal) - TO_DAYS(MIN(fechacommin))+1)  \
					WHEN (TO_DAYS(@fechafinal) - TO_DAYS(MIN(fechacommin))+1)<0 THEN @vardias ELSE 0 END) AS totaldias \
					FROM( \
						(SELECT   a.producto, a.present,MIN( c.fechacom) AS fechacommin \
						FROM compras c INNER JOIN dcompras d ON c.referencia=d.referencia \
						INNER JOIN articulos a ON d.articulo=a.articulo \
						INNER JOIN productos prod ON a.producto=prod.producto \
						%s %s %s \
						WHERE  %s %s %s %s %s %s %s %s %s %s %s \
						c.cancelado=0  AND c.fechacom<=@fechafinal \
						GROUP BY a.producto, a.present) \
					UNION \
						(SELECT  a.producto, a.present, MIN( mv.fechamov) AS fechacommin \
						FROM movalma mv \
						INNER JOIN dmovalma dmv ON mv.movimiento=dmv.movimiento \
						INNER JOIN articulos a ON dmv.articulo=a.articulo \
						INNER JOIN productos prod ON a.producto=prod.producto \
						%s %s \
						WHERE %s %s %s %s %s %s %s %s %s %s %s \
						mv.cancelado=0  AND mv.fechamov<=@fechafinal \
						AND  mv.tipo<>'S' AND mv.aplica=1 \
						GROUP BY a.producto, a.present) \
					) t \
					GROUP BY  producto, present \
					INTO OUTFILE '%s' ", join_presentacion1,
				condicion_prov_esp_INNER, join_supervisado, condicion_almacen,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_producto, condicion_fabricante,

				condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
				condicion_supervisado2, condicion_supervisado,

				join_presentacion1, join_supervisado2, condicion_almacen_mov,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_producto, condicion_fabricante, condicion_segmento,
				condicion_clasifcont, condicion_clasifcont2,
				condicion_supervisado2, condicion_supervisado,

				archivo_temp7);
		}

		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE  totaldiasparapromedio (producto, present, totaldias) ",
			archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;
		/* FIN DE LA IMPLEMENTACION DE TOTAL DE DIAS
		 */
		/*
		 * esta instruccion hace excactamente lo mismo
		 ---- mv.tipo<>'S'
		 ---- mv.tipo='E' OR mv.tipo='T'
		 por eso lo que quitado mv.tipo='E' OR mv.tipo='T'
		 */

		// Suma los movimientos para obtener las existencias
		archivo_temp16 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select e.producto, e.present, sum(e.cantidad) as cantidad, \
				 (sum(if(tipo='VE' OR tipo='DV',cantvpprom,0))/IFNULL(tdc.totaldias, @vardias)) as cantvpprom, \
				 (sum(if(tipo='SV',cantsalprom,0))/IFNULL(tdc.totaldias, @vardias)) as cantsalprom, \
				 (sum(if(tipo='VE' OR tipo='DV',cantvpprom,0)+if(tipo='SV',cantsalprom,0))/IFNULL(tdc.totaldias, @vardias)) as cantvtotprom \
				from existenciasaux e \
				LEFT JOIN totaldiasparapromedio tdc ON e.producto=tdc.producto AND e.present=tdc.present \
				group by e.producto, e.present INTO OUTFILE '%s' ",
			archivo_temp16);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxexistsumadas (producto, present, cantidad, cantvpprom, cantsalprom, cantvtotprom) ",
			archivo_temp16);
		instrucciones[num_instrucciones++] = instruccion;

		// join_supervisado
		// Obtiene los factores minimo y máximo max(a.factor) as maxfactor,
		archivo_temp9 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select a.producto, a.present, e.cantidad, e.cantvpprom,  e.cantsalprom, e.cantvtotprom, \
			MAX(IF(a.activo=1,a.factor,1)), min(a.factor) as minfactor \
            %s \
			from auxexistsumadas e, articulos a \
			%s \
			where e.producto=a.producto and e.present=a.present %s \
			group by e.producto, e.present \
			INTO OUTFILE '%s' ", campo_supervisado, join_supervisado,
			condicion_articulos_inactivos, archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxexistfinales (producto, present, cantidad, cantvpprom, cantsalprom, cantvtotprom,  maxfactor, minfactor, supervisado) ",
			archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmax=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmin=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		if (costoscompra == 1) {
			AnsiString condicion_prov_esp_costos = " ";
			if (prov_predeterminado != " ") {
				condicion_prov_esp_costos =
					" INNER JOIN productosprovaux ppa ON ppa.producto = aa.producto AND ppa.present = aa.present ";
			}

			archivo_temp10 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			// Obtiene los costos de compra
			instruccion.sprintf(" \
				SELECT aa.producto, aa.present, MAX(dcc.`costoimp`) AS costocompraimp , MAX(dcc.`costo`) AS ultimcostocompsin \
				FROM compras cc INNER JOIN dcompras dcc ON cc.`referencia` = dcc.`referencia` \
				INNER JOIN articulos aa ON dcc.`articulo`=aa.`articulo` \
				INNER JOIN ( \
					SELECT a.producto, a.present, MAX(c.`fechacom`) AS ultimafechacom \
					FROM compras c INNER JOIN dcompras dc ON c.`referencia`=dc.`referencia` \
					INNER JOIN articulos a ON dc.`articulo`=a.`articulo` GROUP BY a.`producto`, a.`present` \
				) ultcompras ON ultcompras.ultimafechacom = cc.`fechacom` AND ultcompras.producto=aa.`producto` AND ultcompras.present=aa.`present` \
				%s GROUP BY aa.`producto`, aa.`present` \
				INTO OUTFILE '%s' ", condicion_prov_esp_costos, archivo_temp10);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxcostoscompra (producto, present, costocompraimp,ultimcostocompsin ) ",
				archivo_temp10);
			instrucciones[num_instrucciones++] = instruccion;

		}

		if (ventas == 1) {

			// ARCHIVO TEMPORAL #8
			archivo_temp8 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf(" SELECT p.nombre, a.present, a.producto,  \
							  SUM(dv.cantidad*a.factor- IF(n.tipo='0',IFNULL(dn.cantidad*a.factor,0),0) ) AS totunidades,  \
							  SUM(dv.precio*dv.cantidad-IFNULL(dn.precio*dn.cantidad,0)) AS subtotventa,  \
							  SUM(dv.precioimp*dv.cantidad-IFNULL(dn.precioimp*dn.cantidad,0)) AS totventa   \
							 FROM ventas v   \
							 INNER JOIN terminales ter ON ter.terminal=v.terminal  \
							INNER JOIN secciones sec ON ter.seccion=sec.seccion  \
							  INNER JOIN dventas dv ON dv.referencia=v.referencia   \
							  INNER JOIN articulos a ON a.articulo=dv.articulo      \
							  INNER JOIN productos p ON p.producto=a.producto        \
							  LEFT JOIN notascredcli n ON n.venta=v.referencia AND n.cancelado=0 AND n.fechanot<=@fechafinal  \
							  LEFT JOIN dnotascredcli dn ON n.referencia=dn.referencia AND dv.articulo=dn.articulo  \
							 WHERE v.cancelado=0 and sec.sucursal='%s'       \
							  AND v.fechavta>='%s' AND v.fechavta<=@fechafinal  \
							  AND p.producto=a.producto \
							 GROUP BY a.producto, a.present  \
							 ORDER BY p.nombre, a.present \
							 INTO OUTFILE '%s'", sucursal,
				mFg.StrToMySqlDate(fecha_ini_venta), archivo_temp8);
			// mFg.DateToMySqlDate(fecha_inicial_promedio)
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxnotas (nombre, present,producto, totunidades, subtotventa, totventa) ",
				archivo_temp8);
			instrucciones[num_instrucciones++] = instruccion;

		}

		// se obtiene el precio de autoservicio
		// parametros que causan conflicto
		// and para.valor=cli.cliente AND cli.tipoprec=t.tipoprec
		instruccion.sprintf("select @precautosu:= t.tipoprec,@descripcion:=t.descripcion \
			from parametrosemp para, clientes cli, clientesemp ce, tiposdeprecios t \
			where para.parametro='AUTOSUCLI' AND para.valor=cli.cliente \
			AND ce.cliente = cli.cliente AND ce.idempresa=%s  \
			AND ce.tipoprec=t.tipoprec AND para.sucursal='%s' AND t.idempresa=%s ",
			FormServidor->ObtieneClaveEmpresa(), FormServidor->ObtieneClaveSucursal(),
			FormServidor->ObtieneClaveEmpresa() );
		instrucciones[num_instrucciones++] = instruccion;

		/*
		 Crear una tabla, en la cual se almacenará el código de barras del múltiplo mínimo de cada producto.
		 */
		instruccion =
			"CREATE TEMPORARY TABLE ean13aux(producto VARCHAR(8), present VARCHAR(255),ean13multiplo varchar(14) , INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		// Llenar valores correspondientes de cada múltiplo menor de cada artículo.
		archivo_temp17 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf
			("SELECT producto,present ,ean13 FROM articulos WHERE factor = 1 INTO OUTFILE '%s' ",
			archivo_temp17);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE ean13aux ",
			archivo_temp17);
		instrucciones[num_instrucciones++] = instruccion;

		/*
		 Creacion de una tabla temporal en la que se guardara las cantidades de maximas y min de los ultimos 3 meses
		 */
		AnsiString condicion_almacen_vtames = " ";
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen_vtames.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else {
			condicion_almacen_vtames = " ";
		}

		AnsiString cadena_sucursal = " ";
		if (sucursal != " ") {
			cadena_sucursal.sprintf(" s.sucursal='%s' ", sucursal);
		}
		else {
			cadena_sucursal = " ";
		}
		AnsiString condic_prov_vtaxmes = " ", condic_prov_vtaxmes_INNER = " ";
		if (prov_predeterminado != " ") {

			condic_prov_vtaxmes =
				"  vm.producto = ppa.producto AND vm.present = ppa.present AND ";
			condic_prov_vtaxmes_INNER =
				"INNER JOIN productosprovaux ppa ON vm.producto = ppa.producto AND vm.present = ppa.present";

		}
		else {
			condic_prov_vtaxmes = " ";
			condic_prov_vtaxmes_INNER = " ";
		}

		instruccion =
			" CREATE TEMPORARY TABLE ventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), cantidadmespreant DECIMAL(12,3),cantidadmesant DECIMAL(12,3),cantidadmesact DECIMAL(12,3), INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;
		archivo_temp18 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT vm.producto, vm.present,  \
		SUM(vm.cant%s),SUM(vm.cant%s), SUM(vm.cant%s) \
		FROM ventasxmes vm  \
		%s %s \
		INNER JOIN productos prod ON vm.producto = prod.producto  \
		INNER JOIN almacenes c ON vm.almacen = c.almacen \
		INNER JOIN secciones s ON c.seccion = s.seccion  \
		%s \
		WHERE  \
		%s  \
		%s %s %s %s %s %s %s %s %s %s \
		%s  \
		GROUP BY  vm.producto,vm.present INTO OUTFILE '%s'", cad_mes_penant,
			cad_mes_ant, cad_mes_corresp,

			condic_prov_vtaxmes_INNER, join_supervisado2, join_presentacion3,
			condicion_almacen_vtames, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condic_prov_vtaxmes,
			condicion_fabricante, condicion_segmento, condicion_clasifcont,
			condicion_clasifcont2, condicion_supervisado, cadena_sucursal,

			archivo_temp18);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE ventasmesesantaux ",
			archivo_temp18);
		instrucciones[num_instrucciones++] = instruccion;

		if (ultima_fecha_compra_desplazamiento == "1") {
			// sacar ultima fecha de compra por articulo
			instruccion =
				" CREATE TEMPORARY TABLE fechacompraaux(producto VARCHAR(8), present VARCHAR(255),ultimafechacom date , INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp19 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			if (productosSinVenta == "1") {
				instruccion.sprintf("SELECT t.* FROM (( \
				SELECT \
					ar.producto, \
					ar.present, \
					MAX(m.fechamov)  AS ultimafechacom \
				FROM movalma m \
				INNER JOIN dmovalma dm ON dm.movimiento = m.movimiento \
				INNER JOIN articulos ar ON ar.articulo=dm.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto AND pmm.present= ar.present \
				INNER JOIN terminales t ON t.terminal = m.terminal \
				INNER JOIN secciones sec ON sec.seccion = t.seccion \
				INNER JOIN almacenes almae ON m.almaent = almae.almacen AND almae.seccion = sec.seccion \
				WHERE pmm.activo=1 AND m.tipo = 'T' AND m.fechamov <= @fechafinal %s \
				GROUP BY ar.producto, ar.present) \
				UNION ALL ( \
				SELECT ar.producto , \
				ar.present , \
				MAX(com.fechaalta) AS ultimafechacom \
				FROM compras com \
				INNER JOIN dcompras dc ON com.referencia=dc.referencia \
				INNER JOIN articulos ar ON ar.articulo=dc.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto \
				AND pmm.present= ar.present \
				WHERE pmm.activo=1 AND com.fechacom <= @fechafinal \
				GROUP BY ar.producto , \
				ar.present )) t \
				GROUP BY t.producto, t.present \
				INTO OUTFILE '%s'", condicion_tr_sucursal, archivo_temp19);
				instrucciones[num_instrucciones++] = instruccion;
			}
			else {
				instruccion.sprintf("SELECT ar.producto , ar.present ,MAX(com.fechaalta) as ultimafechacom \
								FROM compras com \
								INNER JOIN dcompras dc ON com.referencia=dc.referencia \
								INNER JOIN articulos ar ON ar.articulo=dc.articulo \
								INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto and pmm.present= ar.present \
								WHERE pmm.activo=1 \
								GROUP BY ar.producto , ar.present \
								INTO OUTFILE '%s'", archivo_temp19);
				instrucciones[num_instrucciones++] = instruccion;
			}

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE fechacompraaux ",
				archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;
			// fin de ultima fecha de compra por articulo

			instruccion.sprintf("select * from fechacompraaux ");
			instrucciones[num_instrucciones++] = instruccion;

			join_fecha_compra =
				"LEFT JOIN fechacompraaux fc ON fc.producto=a.producto AND fc.present=a.present";
			campo_fecha_compra = ", fc.ultimafechacom";
		}
		else {
			join_fecha_compra = " ";
			campo_fecha_compra = " ";
		}

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		if (productosSinVenta == "1") {

			archivo_temp21 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			// sacar ultima fecha de venta por articulo
			instruccion =
				" CREATE TEMPORARY TABLE fechaventaaux(producto VARCHAR(8), present VARCHAR(255),fechadeventa date , INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("SELECT ar.producto, ar.present, MAX(v.fechavta) AS fechadeventa \
			FROM ventas v \
				INNER JOIN dventas dv ON v.referencia=dv.referencia \
				INNER JOIN articulos ar ON ar.articulo=dv.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto AND pmm.present= ar.present \
			WHERE pmm.activo=1 AND v.fechavta between @fechainicial and @fechafinal and v.cancelado=0 \
			GROUP BY ar.producto, ar.present \
			INTO OUTFILE '%s'", archivo_temp21);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE fechaventaaux ",
				archivo_temp21);
			instrucciones[num_instrucciones++] = instruccion;
			// fin de ultima fecha de compra por articulo

			// sacar ultima fecha de venta por articulo
			instruccion =
				" CREATE TEMPORARY TABLE prodsinventas(producto VARCHAR(8), present VARCHAR(255),  INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion =
				"INSERT INTO prodsinventas " "SELECT fc.producto, fc.present "
				"FROM fechacompraaux fc " "LEFT JOIN fechaventaaux fv ON fv.producto = fc.producto AND fv.present = fc.present "
				"WHERE fechadeventa < ultimafechacom OR fv.fechadeventa IS NULL " "ORDER BY fechadeventa DESC, ultimafechacom DESC ";
			instrucciones[num_instrucciones++] = instruccion;

			inner_productossinventa.sprintf
				(" INNER JOIN prodsinventas psv ON psv.producto = e.producto AND psv.present = e.present "
				);
		}

		camposmesesant =
			" ,TRUNCATE(vma.cantidadmespreant / e.maxfactor, 0) AS cantmaxmespreant, MOD(vma.cantidadmespreant, e.maxfactor) AS restomespreant, \
						TRUNCATE(vma.cantidadmesant / e.maxfactor, 0) AS cantmaxmesant, MOD(vma.cantidadmesant, e.maxfactor) AS restomesant,  \
						TRUNCATE(vma.cantidadmesact / e.maxfactor, 0) AS cantmaxmesact, MOD(vma.cantidadmesact, e.maxfactor) AS restomesact";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// Resultado final
			instruccion.sprintf("select prod.nombre as nomproducto, e.producto, (mod(e.cantvtotprom, a.factor)) AS vtamultimen,  truncate(e.cantvtotprom/a.factor,0) AS vtamultim, a.factor, e.present, \
				truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, \
				(@resto/e.minfactor) as cantmin, \
				e.multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				truncate(e.cantvpprom/e.maxfactor,0) as cantmaxvp, \
				@restovp:=mod(e.cantvpprom, e.maxfactor) as restovp, \
				(@restovp/e.minfactor) as cantminvp, \
				e.cantvpprom, \
				truncate(e.cantsalprom/e.maxfactor,0) as cantmaxsalp, \
				@restosal:=mod(e.cantsalprom, e.maxfactor) as restosalp, \
				(@restosal/e.minfactor) as cantminsalp, \
				e.cantsalprom, \
				truncate(e.cantvtotprom/e.maxfactor,7) as cantmaxvtotp, \
				@restovtotprom:=mod(e.cantvtotprom, e.maxfactor) as restovtotp, \
				(@restovtotprom/e.minfactor) as cantminvtotp, \
				e.cantvtotprom, \
				a.articulo as articulomax, \
				am.articulo as articulomin, \
				ap.proveedor, prov.razonsocial as nomprov, \
				ifnull(ap.duracionreorden,0) as duracionreorden, \
				ifnull(ap.duracionmax,0) as duracionmax, \
				ifnull(ap.descontinuado,0) as descontinuado, \
				ifnull(ap.redondeocaja,1) as redondeocaja, \
				ifnull(amulped.factor,0) as factorpedir, \
				ifnull(amulped.articulo,'') as articulopedir, \
				ifnull(amulped.multiplo,'') as multpedir, \
				ifnull(prov.redondeocptecho, 1) AS redondeocptecho, \
				pcb.costobase as costounitario, \
				(pcb.costobase*e.maxfactor) as costobasexmultmay, a.articulo,\
				pcb.costoultimo as costoultimo, \
				(pcb.costoultimo*e.maxfactor) as costoultimoxmultmay, a.articulo,\
				ifnull(cp.costounit, 0) as cunitario,\
				a.ean13, e.supervisado \
				%s %s %s %s , ean13aux.ean13multiplo \
				%s %s \
				from auxexistfinales e  inner join  productos prod  inner join  presentaciones present \
				inner join presentacionescb pcb \
				inner join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo \
				%s                                                                                               \
				left JOIN precalculocostospromedio%s cp ON cp.producto=a.producto AND cp.present=a.present\
				inner join articulos am on e.producto=am.producto and e.present=am.present and e.multmin=am.multiplo \
				%s \
				%s \
				left join articulosped ap on e.producto=ap.producto and e.present=ap.present AND ap.sucursal='%s' \
				left join articulos amulped on ap.producto=amulped.producto and ap.present=amulped.present and ap.multiplopedir=amulped.multiplo \
				left join proveedores prov on prov.proveedor=ap.proveedor \
				CROSS JOIN ean13aux on a.producto=ean13aux.producto and a.present=ean13aux.present \
				%s %s %s %s \
				LEFT JOIN ventasmesesantaux vma ON vma.producto = e.producto AND vma.present = e.present\
				%s \
				%s \
				where %s \
				prod.producto=e.producto and e.producto=present.producto and \
				e.present=present.present and \
                pcb.producto=present.producto and pcb.present=present.present and \
				pcb.idempresa=%s %s %s %s %s %s %s AND ap.descontinuado=0 order by nomproducto, e.present "
				, camposcostoscompra, condicion_preciounit, camposauxnotas,
				campo_productobloqueado, camposmesesant, campo_fecha_compra,
				inner_artactxsuc,FormServidor->ObtieneClaveEmpresa(), condicion_ventaOnline,
				inner_productossinventa, sucursal, leftcostoscompra,
				join_precios_perdidas, leftauxnotas, inner_provcompras,
				join_fecha_compra, join_art_tags, condicion_marca,
				FormServidor->ObtieneClaveEmpresa(),
				condicion_prov, condicion_productob,
				condicion_present_super_geren, condicion_marca_excluir,
				mostrar_presentaciones_cotizables, condicion_art_tags);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_conceptosmovvent != NULL)
			delete resp_conceptosmovvent;
		delete buffer_sql;

		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		mServidorVioleta->BorraArchivoTemp(archivo_temp4);
		mServidorVioleta->BorraArchivoTemp(archivo_temp5);

		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1")
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);

		mServidorVioleta->BorraArchivoTemp(archivo_temp7);

		if (ventas == 1)
			mServidorVioleta->BorraArchivoTemp(archivo_temp8);

		mServidorVioleta->BorraArchivoTemp(archivo_temp9);

		if (costoscompra == 1)
			mServidorVioleta->BorraArchivoTemp(archivo_temp10);

		mServidorVioleta->BorraArchivoTemp(archivo_temp11);
		mServidorVioleta->BorraArchivoTemp(archivo_temp12);
		mServidorVioleta->BorraArchivoTemp(archivo_temp13);
		mServidorVioleta->BorraArchivoTemp(archivo_temp14);

		if (archivo_temp15_delete)
			mServidorVioleta->BorraArchivoTemp(archivo_temp15);

		mServidorVioleta->BorraArchivoTemp(archivo_temp16);
		mServidorVioleta->BorraArchivoTemp(archivo_temp17);
		mServidorVioleta->BorraArchivoTemp(archivo_temp18);

		if (ultima_fecha_compra_desplazamiento == "1")
			mServidorVioleta->BorraArchivoTemp(archivo_temp19);

	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCALCULAR_PEDIDOS_OPT
void ServidorReportes::EjecutaRepCalcularPedidosOpt
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 21];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1202];
	AnsiString terminal, articulo, considerar_cortes;
	AnsiString prov_predeterminado, condicion_prov = " ";
	AnsiString fecha, fecha_ini_venta, fecha_venta;
	AnsiString almacen, stock, producto, perdidas, ventas;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos, marca;
	AnsiString condicion_almacen = " ", condicion_producto = " ",
		condicion_preciounit = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ",
		condicion_marca = " ", condicion_perdidas = " ";
	AnsiString join_productos = " ", join_precios_perdidas = " ";
	AnsiString calculo_promedio_ventas, calculo_promedio_devventas;
	TDate fecha_inicial_promedio, fv;
	int dias, tipopromedio;
	AnsiString forzar_indice_vta = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString cad_conjunto_almacenes = " ";
	double divisor;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_almaexist = NULL;
	int costoscompra;
	AnsiString camposcostoscompra = " ", leftcostoscompra = " ", leftauxnotas =
		" ", camposauxnotas = " ", camposmesesant = " ";
	AnsiString cadena_join_ventasxmes = " ";
	AnsiString inner_provcompras = " ", condicion_meses = " ";

	BufferRespuestas* resp_conceptosmovvent = NULL;
	AnsiString concepto;
	AnsiString cad_conjunto_conceptos = " ";
	AnsiString calculo_promedio_salidas;
	AnsiString condicion_concepto = " ";
	AnsiString productobloqueados, condicion_productob = " ",
		campo_productobloqueado = " ";
	AnsiString consider_salidas_ventas, present_super_gere,
		condicion_present_super_geren = " ";
	AnsiString condicion_prov_esp_INNER = " ";
	AnsiString no_mostrar_marcas_excluidas, condicion_marca_excluir = " ",
		mostrar_presentaciones_cotizables = " ";
	AnsiString promediar_dias_con_exist;
	AnsiString prov_historico, meses;
	AnsiString fabricante, segmento;
	AnsiString essupervisado, productosSinVenta;
	AnsiString condicion_fabricante = " ", condicion_segmento = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString archivo_temp1 = "", archivo_temp2 = "", archivo_temp3 = "",
		archivo_temp4 = "", archivo_temp5;
	AnsiString archivo_temp6 = "", archivo_temp7 = "", archivo_temp8 = "",
		archivo_temp9 = "", archivo_temp10 = "";
	AnsiString archivo_temp11, archivo_temp12, archivo_temp13, archivo_temp14,
		archivo_temp15, archivo_temp16, archivo_temp17, archivo_temp18,
		archivo_temp19;
	AnsiString archivo_temp21;

	TDate fecha_hoy = Today();
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes actual
	int mes_ant = (mes_actual + 24) - 1; // Mes anterior
	int mes_penant = (mes_actual + 24) - 2; // Mes penultimo anterior
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_mes_ant = mFg.IntToAnsiString(mes_ant);
	AnsiString cad_mes_penant = mFg.IntToAnsiString(mes_penant);
	bool archivo_temp15_delete = false;
	bool archivo_temp19_delete = false;

	AnsiString condicion_almacen_vta = " ", condicion_almacen_vta2 = " ";
	AnsiString condicion_almacen_dv = " ";
	AnsiString condicion_almacen_sv = " ";
	AnsiString condicion_prov_esp_join_sv = " ";
	AnsiString condicion_prov_esp_sv = " ";
	AnsiString condicion_suc_prov = " ", condicion_suc = " ";
	AnsiString condicion_producto2 = " ", condicion_producto_pmm = " ";

	AnsiString inner_join_salida = " ", campo_salida = "0", campo_salida2 = "0";
	AnsiString ultima_fecha_compra_desplazamiento;
	AnsiString join_fecha_compra, campo_fecha_compra;
	AnsiString artactxsuc;
	AnsiString inner_artactxsuc = " ";
	AnsiString listaTags, join_art_tags = " ", condicion_art_tags = " ";

	AnsiString ventaOnline;
	AnsiString condicion_ventaOnline = " ";
	AnsiString claveSucExist, condicion_claveSucExist = " ",
		join_claveSucExist = " ", archivo_temp20 = "", condicion_almacen_exsuc =
		" ", almacenexistencia;
	AnsiString diasmuestra, condicion_diasmuestra = " ", join_diasmuestra = " ",
		campo_diasmuestra = " ", campo_diasmuestra_CASE = " ";

	AnsiString clasifcont, clasifcont2;
	AnsiString condicion_clasifcont = " ", condicion_clasifcont2 = " ",
		join_supervisado = " ";
	AnsiString condicion_supervisado = " ", join_supervisado2 = " ",
		join_supervisado3 = " ", condicion_supervisado2 = " ";
	AnsiString supervisado = "", empleadosupervisor = " ";
	AnsiString condicion_empleadosupervisor = " ", inner_empleadosupervisor =
		" ", campo_supervisado = " ";
	AnsiString inner_stock = " ", compos_stock = " ";

	AnsiString inner_productossinventa = " ", condicion_tr_sucursal = " ";
	AnsiString condicion_prov_prod_bloc_com = " ";
	AnsiString esCalculoGlobal = "", ifdias = "";

    AnsiString idEmpresa = " ";

	AnsiString archivo_temp22=" "; //para tabla resumen venta
	AnsiString condicion_producto_resventa=" ", condicion_sucursal_resventa=" ";
	AnsiString select_sucursal_emp=" ";
	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		perdidas = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		dias = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		tipopromedio = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		costoscompra = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		prov_predeterminado = mFg.ExtraeStringDeBuffer(&parametros);
		ventas = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_ini_venta = mFg.ExtraeStringDeBuffer(&parametros);
		productobloqueados = mFg.ExtraeStringDeBuffer(&parametros);
		consider_salidas_ventas = mFg.ExtraeStringDeBuffer(&parametros);
		present_super_gere = mFg.ExtraeStringDeBuffer(&parametros);
		// nuevo parametro de presentacion supervisadas por gerencia
		no_mostrar_marcas_excluidas = mFg.ExtraeStringDeBuffer(&parametros);
		mostrar_presentaciones_cotizables =
			mFg.ExtraeStringDeBuffer(&parametros);
		promediar_dias_con_exist = mFg.ExtraeStringDeBuffer(&parametros);
		prov_historico = mFg.ExtraeStringDeBuffer(&parametros);
		meses = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		ultima_fecha_compra_desplazamiento =
			mFg.ExtraeStringDeBuffer(&parametros);
		artactxsuc = mFg.ExtraeStringDeBuffer(&parametros);
		listaTags = mFg.ExtraeStringDeBuffer(&parametros);
		ventaOnline = mFg.ExtraeStringDeBuffer(&parametros);
		claveSucExist = mFg.ExtraeStringDeBuffer(&parametros);
		diasmuestra = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifcont2 = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);
		essupervisado = mFg.ExtraeStringDeBuffer(&parametros);
		productosSinVenta = mFg.ExtraeStringDeBuffer(&parametros);
		esCalculoGlobal = mFg.ExtraeStringDeBuffer(&parametros);

        idEmpresa = FormServidor->ObtieneClaveEmpresa();

		/*if (promediar_dias_con_exist == "0") {
			throw(Exception
				("Siempre se debe de calcular con las existencias actuales"));
		} */

		if (tipopromedio == 0) {
			divisor = dias / 30.5;
		}
		if (tipopromedio == 1) {
			divisor = dias / 15;
		}
		if (tipopromedio == 2) {
			divisor = dias / 7;
		}
		if (tipopromedio == 3) {
			divisor = dias / 1;
		}

		if (perdidas == 1) {
			condicion_preciounit = ", prec1.precio";
			join_precios_perdidas =
				"INNER JOIN precios prec1 ON prec1.articulo= am.articulo  AND  prec1.tipoprec=@precautosu \
				INNER JOIN tiposdeprecios tp ON tp.tipoprec=prec1.tipoprec AND tp.idempresa="+ FormServidor->ObtieneClaveEmpresa()+" \ ";
		}

		if (costoscompra == 1) {
			camposcostoscompra =
				" , (COALESCE(acc.costocompraimp, 0) * e.maxfactor) AS costocompraimp,\
				 (COALESCE(acc.ultimcostocompsin, 0) * e.maxfactor) AS ultimcostocompsin, \
			COALESCE(acc.costocompraimp, 0) as ultimcostounidad, COALESCE(acc.ultimcostocompsin, 0) as ulcostosinmpunid ";
			leftcostoscompra =
				" left join auxcostoscompra acc ON acc.producto=a.producto and acc.present=a.present ";
		}
		if (ventas == "1") {
			camposauxnotas = ", axn.totventa,axn.totunidades ,axn.subtotventa";
			leftauxnotas =
				" left join auxnotas axn ON axn.producto=a.producto and axn.present=a.present ";
		}

		if (prov_predeterminado != " ") {
			condicion_prov = " and ap.proveedor='" + prov_predeterminado + "'";
		}

		inner_stock.sprintf
			("LEFT JOIN stock st ON st.producto=am.producto AND st.present=am.present AND ap.sucursal=st.sucursal "
			);
		compos_stock.sprintf
			(", st.minimo AS stockmin, st.maximo AS stockmax, ap.stockminimo, st.reorden "
			);
		// compos_stock.sprintf(", if(ap.stockminimo=1, st.minimo,0 )AS stockmin, if(ap.stockminimo=1, st.maximo,0 )  AS stockmax, ap.stockminimo, if(ap.stockminimo=1, st.reorden,0 ) as reorden");

		fecha_inicial_promedio = mFg.MySqlDateToTDate(fecha.c_str()) - dias;

		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " " || (esCalculoGlobal == "2" && sucursal == "")) {
				if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
					// todos los reportes
					instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion \
						WHERE s.sucursal='%s'", sucursal);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);
				}
				else if (esCalculoGlobal == "2") {
					// desplazamiento de mercancia
					instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion\
						INNER JOIN sucursales suc ON suc.sucursal = s.sucursal AND suc.idempresa = %s", FormServidor->ObtieneClaveEmpresa());
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);
				}

				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (clasifcont != " ") {
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasifcont.sprintf(" prod.clasifcont='%s' AND ",
				clasifcont);
		}

		if (clasifcont2 != " ") {
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasifcont2.sprintf(" prod.clasifcont2='%s' AND ",
				clasifcont2);
		}

		join_supervisado =
			" LEFT JOIN articulossupervisados arts ON arts.producto = a.producto AND arts.present = a.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";
		join_supervisado2 =
			" LEFT JOIN articulossupervisados arts ON arts.producto = vm.producto AND arts.present = vm.present \
								LEFT JOIN empleados emp on emp.empleado=arts.usuario ";

		campo_supervisado =
			", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado";

		if (empleadosupervisor != " ") {
			join_supervisado3 = ", articulossupervisados arts, empleados emp  ";

			condicion_supervisado.sprintf(" arts.usuario='%s' AND ",
				empleadosupervisor);

			condicion_supervisado2.sprintf(" arts.producto = a.producto AND \
			arts.present = a.present AND arts.usuario= emp.empleado   AND ");

		}
		else {
			/* campo_supervisado = " , ' ' AS supervisado";

			 join_supervisado = " ";
			 */
			condicion_supervisado = " ";
		}

		// Obtiene los conceptos de movalma que se interpretan como venta para
		// propósito de rotacion de mercancía (ej: calculo de cuanto pedir)
		instruccion.sprintf("SELECT concepto FROM conceptosmovvent");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_conceptosmovvent);
		for (i = 0; i < resp_conceptosmovvent->ObtieneNumRegistros(); i++) {
			resp_conceptosmovvent->IrAlRegistroNumero(i);
			concepto = resp_conceptosmovvent->ObtieneDato("concepto");

			cad_conjunto_conceptos += "'";
			cad_conjunto_conceptos += concepto;
			cad_conjunto_conceptos += "'";
			if (i < resp_conceptosmovvent->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo le signo +.
					cad_conjunto_conceptos += ",";
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);  //("prod.producto='%s' and ", producto);
			condicion_producto2.sprintf("producto='%s' AND ", producto);
			condicion_producto_pmm.sprintf(" AND pmm.producto = '%s' ",
				producto);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_producto_resventa.sprintf(" producto = '%s' and ", producto);
		}/*else{
			condicion_producto_resventa.sprintf(" 1 and ");
		} */

		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (prov_predeterminado != " ") {
			// limit 1
			condicion_prov_prod_bloc_com.sprintf
				(" AND (pb.proveedor='%s' OR pb.proveedor='TODOS')  GROUP BY pb.producto, pb.present ",
				prov_predeterminado);
		}
		else {
			condicion_prov_prod_bloc_com.sprintf(" AND pb.proveedor='TODOS' ");
		}

		if (productobloqueados == "1") {
			condicion_productob.sprintf("AND (present.producto, present.present) NOT IN (SELECT producto, present FROM ProdbloqueadoCompra pb \
					WHERE pb.producto=present.producto and pb.present=present.present %s ) "
				, condicion_prov_prod_bloc_com);
			campo_productobloqueado.sprintf
				(",   IFNULL((SELECT '0'),0) AS prodbloq");
		}
		else {
			// este nuevo campo se tiene que ejecutar encuentre o no productos bloqueados para compra
			campo_productobloqueado.sprintf(", IFNULL((SELECT '1' FROM ProdbloqueadoCompra pb WHERE  pb.producto=e.producto  \
				AND pb.present=e.present %s ),0) AS prodbloq ",
				condicion_prov_prod_bloc_com);
		}

		if (no_mostrar_marcas_excluidas == "1") {
			// Se obtienen todas las marcas para excluirlas
			BufferRespuestas* res_marcasexistsim = NULL;
			AnsiString marcasExcluirReporte;
			int cantMarcas = 0;
			try {
				instruccion = "SELECT marca FROM marcasexistsim";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), res_marcasexistsim);

				cantMarcas = res_marcasexistsim->ObtieneNumRegistros();
				for (i = 0; i < res_marcasexistsim->ObtieneNumRegistros(); i++)
				{
					if (i == res_marcasexistsim->ObtieneNumRegistros() - 1)
						marcasExcluirReporte +=
							"'" + res_marcasexistsim->ObtieneDato
							("marca") + "'";
					else
						marcasExcluirReporte +=
							"'" + res_marcasexistsim->ObtieneDato
							("marca") + "',";

					res_marcasexistsim->IrAlSiguienteRegistro();
				}

			}
			__finally {
				if (res_marcasexistsim != NULL)
					delete res_marcasexistsim;
			}

			if (cantMarcas > 0)
				condicion_marca_excluir.sprintf(" AND prod.marca NOT IN(%s) ",
				marcasExcluirReporte);
			else
				condicion_marca_excluir.sprintf(" ");
		}

		if (mostrar_presentaciones_cotizables == "1") {
			mostrar_presentaciones_cotizables = " AND present.cotizable=1 ";
		}
		else {
			mostrar_presentaciones_cotizables = " ";
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf("prod.fabricante='%s' and ",
			fabricante);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}
		// Usaremos el segmento de presentacion
		if (segmento != " ") {

			condicion_segmento.sprintf("pcb.segmento='%s' and ", segmento);
			join_presentacion1 =
				" INNER JOIN presentaciones present ON present.producto=a.producto AND present.present=a.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+
				  FormServidor->ObtieneClaveEmpresa();
			// 1 y 4 y 5
			join_presentacion2 =
				" INNER JOIN presentaciones present ON present.producto=vm.producto  AND present.present=vm.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+
				  FormServidor->ObtieneClaveEmpresa();
			// 1 y 4 y 5
			// 2
			join_presentacion3 =
				" INNER JOIN presentaciones present ON  v.producto=present.producto AND v.present=present.present \
				  INNER JOIN presentacionescb pcb ON pcb.producto=present.producto AND pcb.present=present.present AND pcb.idempresa="+
				  FormServidor->ObtieneClaveEmpresa();
			// 3

			join_productos =
				" inner join productos prod on a.producto=prod.producto ";

		}
		if (artactxsuc != "0") {
			if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
				inner_artactxsuc.sprintf
					("INNER JOIN articulosxsuc axs ON axs.producto = a.producto AND axs.present = a.present AND axs.sucursal IN ('%s')",
					sucursal);
			}
			else if (esCalculoGlobal == "2") {
				inner_artactxsuc.sprintf
					("INNER JOIN articulosxsuc axs ON axs.producto = a.producto AND axs.present = a.present "
					);
			}
		}

		if (listaTags != " ") {

			join_art_tags.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags.sprintf(" AND artt.idarticulotag in (%s) ",
				listaTags);
		}

		if (ventaOnline != "0") {
			condicion_ventaOnline.sprintf
				(" INNER JOIN ecommerceproductos ep ON ep.articulo = a.articulo "
				);
		}

		if (sucursal != " ") {
			if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
				condicion_tr_sucursal.sprintf(" AND sec.sucursal = '%s' ",
					sucursal);

				condicion_sucursal_resventa.sprintf(" sucursal = '%s' and ",sucursal);
			}
			else if (esCalculoGlobal == "2") {
				condicion_tr_sucursal.sprintf(" ");

				condicion_sucursal_resventa.sprintf(" ");
			}
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		if (considerar_cortes == "1") {
			forzar_indice_vta = " force index(fechavta) ";
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'", fecha);
		}
		else {
			instruccion.sprintf("set @fechacorte='1900-01-01'");
		}
		instrucciones[num_instrucciones++] = instruccion;

		// Sección de optimización
		if (producto != " " || clasif3 != " " || clasif2 != " " ||
			fabricante != " " || segmento != " " || marca != " ") {
			// Si probablemente pueda servirnos más los indices de productos,
			// entonces evitamos forzar el indice de ventas, y dejamos que mysql decida.
			forzar_indice_vta = " ";
		}

		if (ultima_fecha_compra_desplazamiento == "1") {
			// sacar ultima fecha de compra por articulo
			instruccion =
				" CREATE TEMPORARY TABLE fechacompraaux(producto VARCHAR(8), present VARCHAR(255),ultimafechacom date , INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp19 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			if (productosSinVenta == "1") {
				instruccion.sprintf("SELECT t.* FROM (( \
				SELECT \
					ar.producto, \
					ar.present, \
					MAX(m.fechamov)  AS ultimafechacom \
				FROM movalma m \
				INNER JOIN dmovalma dm ON dm.movimiento = m.movimiento \
				INNER JOIN articulos ar ON ar.articulo=dm.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto AND pmm.present= ar.present \
				INNER JOIN terminales t ON t.terminal = m.terminal \
				INNER JOIN secciones sec ON sec.seccion = t.seccion \
				INNER JOIN almacenes almae ON m.almaent = almae.almacen AND almae.seccion = sec.seccion \
				WHERE pmm.activo=1 AND m.tipo = 'T' %s \
				GROUP BY ar.producto, ar.present) \
				UNION ALL ( \
				SELECT ar.producto , \
				ar.present , \
				MAX(com.fechaalta) AS ultimafechacom \
				FROM compras com \
				INNER JOIN dcompras dc ON com.referencia=dc.referencia \
				INNER JOIN articulos ar ON ar.articulo=dc.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto \
				AND pmm.present= ar.present \
				WHERE pmm.activo=1 \
				GROUP BY ar.producto , \
				ar.present )) t \
				GROUP BY t.producto, t.present \
				INTO OUTFILE '%s'", condicion_tr_sucursal, archivo_temp19);
				instrucciones[num_instrucciones++] = instruccion;

			}
			else {
				instruccion.sprintf("SELECT ar.producto , ar.present ,MAX(com.fechaalta) as ultimafechacom \
								FROM compras com \
								INNER JOIN dcompras dc ON com.referencia=dc.referencia \
								INNER JOIN articulos ar ON ar.articulo=dc.articulo \
								INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto and pmm.present= ar.present \
								INNER JOIN almacenes alm ON alm.almacen = com.almacen\
								INNER JOIN secciones sec ON sec.seccion = alm.seccion\
								INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal AND suc.idempresa = %s\
								WHERE pmm.activo=1 \
								GROUP BY ar.producto , ar.present \
								INTO OUTFILE '%s'", FormServidor->ObtieneClaveEmpresa(), archivo_temp19);
				instrucciones[num_instrucciones++] = instruccion;
			}

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE fechacompraaux ",
				archivo_temp19);
			instrucciones[num_instrucciones++] = instruccion;
			// fin de ultima fecha de compra por articulo

			instruccion.sprintf("select * from fechacompraaux ");
			instrucciones[num_instrucciones++] = instruccion;

			join_fecha_compra =
				"LEFT JOIN fechacompraaux fc ON fc.producto=a.producto AND fc.present=a.present";
			campo_fecha_compra = ", fc.ultimafechacom";

			archivo_temp19_delete = true;
		}
		else {
			join_fecha_compra = " ";
			campo_fecha_compra = " ";
		}

		instruccion.sprintf("set @vardias=%d", dias);
		instrucciones[num_instrucciones++] = instruccion;

		// nuevo parametro de dias muestra IFNULL(auxvtadev.cantvpprom,0)/NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)) AS cantvpprom,
		if (diasmuestra != " ") {
			instruccion.sprintf("set @diasmuestra=%d", StrToInt(diasmuestra));
			instrucciones[num_instrucciones++] = instruccion;

			campo_diasmuestra.sprintf
				("((IFNULL(auxvtadev.cantvpprom,0) + IFNULL(rvent.cantresventa,0)) /(CASE WHEN pre.diasconexist%d=@vardias THEN pre.diasconexist%d WHEN pre.diasconexist%d<@diasmuestra THEN @diasmuestra WHEN pre.diasconexist%d<@vardias THEN pre.diasconexist%d ELSE 0 END)) as cantvpprom, ",
				dias, dias, dias, dias, dias);
			campo_diasmuestra_CASE.sprintf
				("(CASE WHEN pre.diasconexist%d=@vardias THEN pre.diasconexist%d WHEN pre.diasconexist%d<@diasmuestra THEN @diasmuestra WHEN pre.diasconexist%d<@vardias THEN pre.diasconexist%d ELSE 0 END) ",
				dias, dias, dias, dias, dias);
		}
		else {
			if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
				campo_diasmuestra.sprintf
					("((IFNULL(auxvtadev.cantvpprom,0) + IFNULL(rvent.cantresventa,0))/NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)) as cantvpprom, ",
					dias);
				campo_diasmuestra_CASE.sprintf
					(" NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)", dias);
			}
			else if (esCalculoGlobal == "2") {
				// esCalculoGlobal=="2" --> ESTE ES EN EL SOLO CASO DE DEZPLAZAMIENTO DE MERCANCIA GLOBLAL
				campo_diasmuestra.sprintf
					("(IFNULL(auxvtadev.cantvpprom,0) + IFNULL(rvent.cantresventa,0)/(if(pre.diasconexist%d=0, @vardias, pre.diasconexist%d) ) ) as cantvpprom, ",
					dias, dias);
				campo_diasmuestra_CASE.sprintf
					(" if(pre.diasconexist%d=0, @vardias, pre.diasconexist%d)",
					dias, dias);
			}
		}

		instruccion.sprintf
			("SET @fechainicial=DATE_ADD(@fechafinal, INTERVAL - @vardias DAY) "
			);
		instrucciones[num_instrucciones++] = instruccion;

		if (productosSinVenta == "1") {

			archivo_temp21 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			// sacar ultima fecha de venta por articulo
			instruccion =
				" CREATE TEMPORARY TABLE fechaventaaux(producto VARCHAR(8), present VARCHAR(255),fechadeventa date , INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("SELECT ar.producto, ar.present, MAX(v.fechavta) AS fechadeventa \
			FROM ventas v \
				INNER JOIN dventas dv ON v.referencia=dv.referencia \
				INNER JOIN articulos ar ON ar.articulo=dv.articulo \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=ar.producto AND pmm.present= ar.present \
				INNER JOIN terminales ter ON ter.terminal = v.terminal\
				INNER JOIN secciones sec ON sec.seccion = ter.seccion\
				INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal AND suc.idempresa = %s\
			WHERE pmm.activo=1 AND v.fechavta between @fechainicial and @fechafinal and v.cancelado=0 \
			GROUP BY ar.producto, ar.present \
			INTO OUTFILE '%s'", FormServidor->ObtieneClaveEmpresa(), archivo_temp21);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE fechaventaaux ",
				archivo_temp21);
			instrucciones[num_instrucciones++] = instruccion;
			// fin de ultima fecha de compra por articulo

			// sacar ultima fecha de venta por articulo
			instruccion =
				" CREATE TEMPORARY TABLE prodsinventas(producto VARCHAR(8), present VARCHAR(255),  INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;

			instruccion =
				"INSERT INTO prodsinventas " "SELECT fc.producto, fc.present "
				"FROM fechacompraaux fc " "LEFT JOIN fechaventaaux fv ON fv.producto = fc.producto AND fv.present = fc.present "
				"WHERE fechadeventa < ultimafechacom OR fv.fechadeventa IS NULL " "ORDER BY fechadeventa DESC, ultimafechacom DESC ";
			instrucciones[num_instrucciones++] = instruccion;

			inner_productossinventa.sprintf
				(" INNER JOIN prodsinventas psv ON psv.producto = e.producto AND psv.present = e.present "
				);
		}

		if (present_super_gere == 1) {
			condicion_present_super_geren = " AND present.sgerencia=1";
		}
		else {
			condicion_present_super_geren = " ";
		}

		if (costoscompra == 1) {
			// Crea una tabla donde se pondrán los costos de compra
			instruccion =
				"create temporary table auxcostoscompra (producto varchar(8), present varchar(255), \
				costocompraimp decimal(12,3), ultimcostocompsin DECIMAL(12,3),INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;
		}
		if (ventas == "1") {

			instruccion = "CREATE TEMPORARY TABLE auxnotas ( nombre VARCHAR(50), present VARCHAR(255), producto VARCHAR(8),  \
						totunidades DECIMAL(12,3), subtotventa DECIMAL(16,6), totventa DECIMAL(16,6), \
						INDEX(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;
		}

		if (prov_historico == " ") {
			inner_provcompras = " ";
		}
		else {
			if (meses != "0") {
				condicion_meses.sprintf
					(" AND fechacom BETWEEN DATE_ADD('%s', INTERVAL - %s MONTH) AND '%s'",
					fecha, meses, fecha);
			}
			else {
				condicion_meses = " ";
			}
			// Para notas de crédito de ventas (en utilidad)
			instruccion =
				"CREATE TEMPORARY TABLE prodpresentprovcompraaux (producto VARCHAR(8), \
				present VARCHAR(255) ,PRIMARY KEY (producto, present)) ENGINE = INNODB ";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf("INSERT INTO prodpresentprovcompraaux (producto,present) \
						SELECT a.producto, a.present   \
						FROM compras com                        \
						INNER JOIN dcompras dc ON com.referencia=dc.referencia \
						INNER JOIN articulos a ON dc.articulo=a.articulo       \
						WHERE com.proveedor='%s' and com.cancelado=0 %s \
						GROUP BY a.producto, a.present",
				AnsiString(prov_historico).c_str(), condicion_meses);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			inner_provcompras.sprintf
				("INNER JOIN prodpresentprovcompraaux pppca ON pppca.producto=a.producto AND pppca.present=a.present "
				);
		}

		instruccion = "CREATE TEMPORARY TABLE productosprovaux (producto VARCHAR(8), present VARCHAR(255),sucursal VARCHAR(2), \
					 INDEX(producto, present)) ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
			if (sucursal != " ") {
				condicion_suc_prov.sprintf(" AND sucursal = '%s' ", sucursal);
				condicion_suc.sprintf(" AND pre.sucursal = '%s' ", sucursal);

				select_sucursal_emp.sprintf("  AND suc.idempresa = (SELECT idempresa FROM sucursales WHERE sucursal='%s' )", sucursal);
			}
		}
		else if (esCalculoGlobal == "2") {
			if (sucursal != "") {
                condicion_suc_prov.sprintf(" AND sucursal = '%s' ", sucursal);
				condicion_suc.sprintf(" AND pre.sucursal = '%s' ", sucursal);
				select_sucursal_emp.sprintf(" AND suc.idempresa = %s ", idEmpresa);
			} else {
                condicion_suc_prov.sprintf(" ");
				condicion_suc.sprintf(" AND pre.sucursal IN(SELECT sucursal FROM sucursales WHERE idempresa=%s)", FormServidor->ObtieneClaveEmpresa());
				select_sucursal_emp.sprintf("  AND suc.idempresa = (SELECT idempresa FROM sucursales WHERE sucursal='%s')", sucursal);
            }
		}

		archivo_temp11 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT producto, present, sucursal FROM articulosped WHERE \
					proveedor = '%s' %s INTO OUTFILE '%s'", prov_predeterminado,
			condicion_suc_prov, archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE productosprovaux ",
			archivo_temp11);
		instrucciones[num_instrucciones++] = instruccion;

		if (prov_predeterminado != " ") {
			condicion_prov_esp_INNER =
				"INNER JOIN productosprovaux ppa ON a.producto = ppa.producto AND a.present = ppa.present";
		}

		// Calcula las ventas.
		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_ventas.sprintf
				(" sum(if(v.fechavta>='%s', d.cantidad*a.factor,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			if (cad_conjunto_almacenes != " ") {
				calculo_promedio_ventas = " vxm.cantidad ";
			}
			else {
				calculo_promedio_ventas.sprintf(" (SELECT SUM(ventas%d) FROM ventasxmes WHERE producto= a.producto \
							AND present = a.present GROUP BY producto, present) "
					, dias);
			}
		}
		AnsiString condicion_prov_esp_dv = " ";
		if (prov_predeterminado != " ") {
			condicion_prov_esp_dv =
				" INNER JOIN productosprovaux ppa ON ppa.producto = a.producto AND ppa.present = a.present ";
		}

		/* CAMBIO DE LUGAR DE LA NUEVA IMPLEMENTACION DE TOTALDE DIAS
		 */
		// ARCHIVO TEMPORAL #7
		AnsiString condicion_almacen_mov = " ";
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and",
				cad_conjunto_almacenes);
			condicion_almacen_mov.sprintf(" mv.almaent in (%s) and",
				cad_conjunto_almacenes);
		}
		else {
			condicion_almacen = " ";
			condicion_almacen_mov = " ";
		}

		if (costoscompra == 1) {
			AnsiString condicion_prov_esp_costos = " ";
			if (prov_predeterminado != " ") {
				condicion_prov_esp_costos =
					" INNER JOIN productosprovaux ppa ON ppa.producto = aa.producto AND ppa.present = aa.present ";
			}

			archivo_temp10 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			// Obtiene los costos de las últimas compras (solo considera el ultimo año, ya de antes es irrelevante ya que su uso es solo como referencia para comparar con el costo que se piensa comprar).
 		instruccion =
				"SET @fechacomprasini=DATE_ADD(CURDATE(), INTERVAL -1 YEAR)";
			instrucciones[num_instrucciones++] = instruccion;
			instruccion = "SET @fechacomprasfin=CURDATE()";
			instrucciones[num_instrucciones++] = instruccion;
			if(esCalculoGlobal == " " || esCalculoGlobal == "1"){
			instruccion.sprintf(" \
				SELECT aa.producto, aa.present, MAX(dcc.`costoimp` / aa.`factor`) AS costocompraimp , MAX(dcc.`costo` / aa.`factor`) AS ultimcostocompsin \
				FROM compras cc INNER JOIN dcompras dcc ON cc.`referencia` = dcc.`referencia` \
				INNER JOIN articulos aa ON dcc.`articulo`=aa.`articulo` \
				INNER JOIN ( \
					SELECT a.producto, a.present, MAX(TIMESTAMP(c.`fechacom`,c.horaalta)) AS ultimafechacom \
					FROM compras c INNER JOIN dcompras dc ON c.`referencia`=dc.`referencia` \
					INNER JOIN articulos a ON dc.`articulo`=a.`articulo` \
					INNER JOIN productos prod ON a.producto=prod.producto \
					%s \
					INNER JOIN terminales ter ON c.terminal = ter.terminal \
					INNER JOIN secciones sec ON ter.seccion = sec.seccion \
					INNER JOIN sucursales suc ON sec.sucursal = suc.sucursal \
					WHERE c.cancelado=0 AND c.fechacom BETWEEN @fechacomprasini AND @fechacomprasfin \
						and %s %s %s %s %s %s %s %s  \
						1 AND suc.idempresa = (SELECT idempresa FROM sucursales WHERE sucursal='%s')\
						AND (dc.costoimp > 1 OR dc.costo > 1)\
					GROUP BY a.`producto`, a.`present` \
				) ultcompras ON ultcompras.ultimafechacom = TIMESTAMP(cc.`fechacom`,cc.horaalta) AND ultcompras.producto=aa.`producto` AND ultcompras.present=aa.`present` \
				%s \
				WHERE cc.cancelado=0 AND cc.fechacom BETWEEN @fechacomprasini AND @fechacomprasfin \
				GROUP BY aa.`producto`, aa.`present` \
				INTO OUTFILE '%s' ", join_presentacion1,condicion_producto,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_fabricante, condicion_segmento, condicion_clasifcont,
				condicion_clasifcont2, sucursal, condicion_prov_esp_costos,
				archivo_temp10);
			instrucciones[num_instrucciones++] = instruccion;
			} else if(esCalculoGlobal == "2"){
            instruccion.sprintf(" \
				SELECT aa.producto, aa.present, MAX(dcc.`costoimp`) AS costocompraimp , MAX(dcc.`costo`) AS ultimcostocompsin \
				FROM compras cc INNER JOIN dcompras dcc ON cc.`referencia` = dcc.`referencia` \
				INNER JOIN articulos aa ON dcc.`articulo`=aa.`articulo` \
				INNER JOIN ( \
					SELECT a.producto, a.present, MAX(TIMESTAMP(c.`fechacom`,c.horaalta)) AS ultimafechacom \
					FROM compras c INNER JOIN dcompras dc ON c.`referencia`=dc.`referencia` \
					INNER JOIN articulos a ON dc.`articulo`=a.`articulo` \
					INNER JOIN productos prod ON a.producto=prod.producto \
					%s \
					INNER JOIN terminales ter ON c.terminal = ter.terminal \
					INNER JOIN secciones sec ON ter.seccion = sec.seccion \
					INNER JOIN sucursales suc ON sec.sucursal = suc.sucursal \
					WHERE c.cancelado=0 AND c.fechacom BETWEEN @fechacomprasini AND @fechacomprasfin \
						and %s %s %s %s %s %s %s %s  \
						1 AND suc.idempresa = %s \
					GROUP BY a.`producto`, a.`present` \
				) ultcompras ON ultcompras.ultimafechacom = TIMESTAMP(cc.`fechacom`,cc.horaalta) AND ultcompras.producto=aa.`producto` AND ultcompras.present=aa.`present` \
				%s \
				WHERE cc.cancelado=0 AND cc.fechacom BETWEEN @fechacomprasini AND @fechacomprasfin \
				GROUP BY aa.`producto`, aa.`present` \
				INTO OUTFILE '%s' ", join_presentacion1,condicion_producto,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_fabricante, condicion_segmento, condicion_clasifcont,
				condicion_clasifcont2, idEmpresa, condicion_prov_esp_costos,
				archivo_temp10);
			instrucciones[num_instrucciones++] = instruccion;
			}

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxcostoscompra (producto, present, costocompraimp,ultimcostocompsin ) ",
				archivo_temp10);
			instrucciones[num_instrucciones++] = instruccion;

		}

		if (ventas == 1) {

			// ARCHIVO TEMPORAL #8
			archivo_temp8 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			AnsiString condicion_sin_sucursal = " ";
			if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
				condicion_sin_sucursal.sprintf(" and sec.sucursal='%s' ",
					sucursal);
			}
			else if (esCalculoGlobal == "2") {
				condicion_sin_sucursal.sprintf(" ");
			}

			instruccion.sprintf(" SELECT p.nombre, a.present, a.producto,  \
							  SUM(dv.cantidad*a.factor- IF(n.tipo='0',IFNULL(dn.cantidad*a.factor,0),0) ) AS totunidades,  \
							  SUM(dv.precio*dv.cantidad-IFNULL(dn.precio*dn.cantidad,0)) AS subtotventa,  \
							  SUM(dv.precioimp*dv.cantidad-IFNULL(dn.precioimp*dn.cantidad,0)) AS totventa   \
							 FROM ventas v   \
							 INNER JOIN terminales ter ON ter.terminal=v.terminal  \
							INNER JOIN secciones sec ON ter.seccion=sec.seccion  \
							  INNER JOIN dventas dv ON dv.referencia=v.referencia   \
							  INNER JOIN articulos a ON a.articulo=dv.articulo      \
							  INNER JOIN productos p ON p.producto=a.producto        \
							  LEFT JOIN notascredcli n ON n.venta=v.referencia AND n.cancelado=0 AND n.fechanot<=@fechafinal  \
							  LEFT JOIN dnotascredcli dn ON n.referencia=dn.referencia AND dv.articulo=dn.articulo  \
							 WHERE v.cancelado=0  %s     \
							  AND v.fechavta>='%s' AND v.fechavta<=@fechafinal  \
							  AND p.producto=a.producto \
							 GROUP BY a.producto, a.present  \
							 ORDER BY p.nombre, a.present \
							 INTO OUTFILE '%s'", condicion_sin_sucursal,
				mFg.StrToMySqlDate(fecha_ini_venta), archivo_temp8);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxnotas (nombre, present,producto, totunidades, subtotventa, totventa) ",
				archivo_temp8);
			instrucciones[num_instrucciones++] = instruccion;

		}

		// se obtiene el precio de autoservicio
		// parametros que causan conflicto
		instruccion.sprintf("select @precautosu:= t.tipoprec,@descripcion:=t.descripcion \
			from parametrosemp para, clientes cli, clientesemp ce, tiposdeprecios t \
			where para.parametro='AUTOSUCLI' AND para.valor=cli.cliente AND \
			ce.cliente = cli.cliente AND ce.idempresa=%s AND \
			ce.tipoprec=t.tipoprec AND para.sucursal='%s' AND t.idempresa=%s ",
			FormServidor->ObtieneClaveEmpresa(),
			FormServidor->ObtieneClaveSucursal(), FormServidor->ObtieneClaveEmpresa() );
		instrucciones[num_instrucciones++] = instruccion;

		/*
		 Creacion de una tabla temporal en la que se guardara las cantidades de maximas y min de los ultimos 3 meses
		 */
		AnsiString condicion_almacen_vtames = " ";
		if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen_vtames.sprintf(" c.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else {
				condicion_almacen_vtames = " ";
			}
		}
		else {
			condicion_almacen_vtames = " ";
		}

		AnsiString cadena_sucursal = " ";
		if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
			if (sucursal != " ") {
				cadena_sucursal.sprintf(" s.sucursal='%s' ", sucursal);
			}
			else {
				cadena_sucursal = " ";
			}
		}
		else if (esCalculoGlobal == "2") {
			if (sucursal != "") {
				cadena_sucursal.sprintf(" AND s.sucursal='%s' ", sucursal);
			} else {
				cadena_sucursal.sprintf(" AND s.sucursal IN(SELECT sucursal FROM sucursales WHERE idempresa=%s) ", idEmpresa);
			}
		}

		AnsiString condic_prov_vtaxmes = " ", condic_prov_vtaxmes_INNER = " ";
		if (prov_predeterminado != " ") {

			/*condic_prov_vtaxmes =
				"  vm.producto = ppa.producto AND vm.present = ppa.present AND "; */
			condic_prov_vtaxmes = " ";
			condic_prov_vtaxmes_INNER =
				"INNER JOIN productosprovaux ppa ON vm.producto = ppa.producto AND vm.present = ppa.present";

		}
		else {
			condic_prov_vtaxmes = " ";
			condic_prov_vtaxmes_INNER = " ";
		}

		AnsiString where = " ";
		if (condicion_almacen_vtames != " " || condicion_clasif1 != " " ||
			condicion_clasif2 != " " || condicion_clasif3 != " " ||
			condicion_producto != " " || condic_prov_vtaxmes != " " ||
			condicion_fabricante != " " || condicion_segmento != " " ||
			condicion_clasifcont != " " || condicion_clasifcont2 != " " ||
			condicion_supervisado != " " || cadena_sucursal != " ") {

			where.sprintf(" WHERE ");
		}
		instruccion =
			" CREATE TEMPORARY TABLE ventasmesesantaux ( producto VARCHAR(8), present VARCHAR(255), cantidadmespreant DECIMAL(12,3),cantidadmesant DECIMAL(12,3),cantidadmesact DECIMAL(12,3), INDEX(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp18 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		if(esCalculoGlobal == " " || esCalculoGlobal == "1"){
			instruccion.sprintf("SELECT vm.producto, vm.present,  \
			SUM(vm.cant%s),SUM(vm.cant%s), SUM(vm.cant%s) \
			FROM ventasxmes vm  \
			 %s \
			INNER JOIN productos prod ON vm.producto = prod.producto  \
			INNER JOIN almacenes c ON vm.almacen = c.almacen \
			INNER JOIN secciones s ON c.seccion = s.seccion  \
			%s \
			%s \
				 %s \
			%s  \
			%s %s %s %s %s %s %s %s %s %s \
			%s \
			GROUP BY  vm.producto,vm.present INTO OUTFILE '%s'", cad_mes_penant,
			cad_mes_ant, cad_mes_corresp, condic_prov_vtaxmes_INNER,
			join_presentacion2, join_supervisado2, where,
			condicion_almacen_vtames, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condic_prov_vtaxmes,
			condicion_fabricante, condicion_segmento, condicion_clasifcont,
			condicion_clasifcont2, condicion_supervisado, cadena_sucursal,
			archivo_temp18);
		}else if(esCalculoGlobal == "2"){
			instruccion.sprintf("SELECT vm.producto, vm.present,  \
			SUM(vm.cant%s),SUM(vm.cant%s), SUM(vm.cant%s) \
			FROM ventasxmes vm  \
			 %s \
			INNER JOIN productos prod ON vm.producto = prod.producto  \
			INNER JOIN almacenes c ON vm.almacen = c.almacen \
			INNER JOIN secciones s ON c.seccion = s.seccion  \
			%s \
			%s \
				 where  \
			%s  \
			%s %s %s %s %s %s %s %s %s %s \
			1 %s \
			GROUP BY  vm.producto,vm.present INTO OUTFILE '%s'", cad_mes_penant,
			cad_mes_ant, cad_mes_corresp, condic_prov_vtaxmes_INNER,
			join_presentacion2, join_supervisado2,
			condicion_almacen_vtames, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condic_prov_vtaxmes,
			condicion_fabricante, condicion_segmento, condicion_clasifcont,
			condicion_clasifcont2, condicion_supervisado, cadena_sucursal,
			archivo_temp18);
		}
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE ventasmesesantaux ",
			archivo_temp18);
		instrucciones[num_instrucciones++] = instruccion;

		if (esCalculoGlobal == " " || esCalculoGlobal == "1") {
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen_vta2.sprintf(" almacen in (%s) and ",
					cad_conjunto_almacenes);
				condicion_almacen_vta.sprintf(" d.almacen in (%s) and ",
					cad_conjunto_almacenes);

				condicion_almacen_dv.sprintf(" dv.almacen in (%s) and ",
					cad_conjunto_almacenes);

				condicion_almacen_sv.sprintf(" m.almasal in (%s) and ",
					cad_conjunto_almacenes);
			}
		}
		else if (esCalculoGlobal == "2") {
			if (sucursal != "") {
                condicion_almacen_sv.sprintf(" ");
				condicion_almacen_vta2.sprintf(" ");
				condicion_almacen_vta.sprintf(" ");
				condicion_almacen_dv.sprintf(" ");
			} else {
               condicion_almacen_vta2.sprintf(" almacen in (%s) and ",
					cad_conjunto_almacenes);
				condicion_almacen_vta.sprintf(" d.almacen in (%s) and ",
					cad_conjunto_almacenes);

				condicion_almacen_dv.sprintf(" dv.almacen in (%s) and ",
					cad_conjunto_almacenes);

				condicion_almacen_sv.sprintf(" m.almasal in (%s) and ",
					cad_conjunto_almacenes);
			}
		}

		if (dias > 0 && considerar_cortes == "0") {
			calculo_promedio_devventas.sprintf
				("SUM(IF(n.fechanot>='%s', dn.cantidad*a.factor*-1,0)) ",
				mFg.DateToMySqlDate(fecha_inicial_promedio));
		}
		else {
			calculo_promedio_devventas = "0.000";
		}

		instruccion = " CREATE TEMPORARY TABLE auxventasdev (producto VARCHAR(8), present VARCHAR(255), cantvpprom DECIMAL(16,3), \
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		if (dias > 0 && considerar_cortes == "0") {
			instruccion.sprintf("                                                                    \
			SELECT                                                                                   \
				t.producto,                                                                          \
				t.present,                                                                           \
				SUM(t.cantvpprom)                                                                    \
			FROM (                                                                                   \
				   (                                                                                 \
					SELECT                                                                			 \
						  a.producto,                                                                \
						  a.present,                                                                 \
						  %s AS cantvpprom                                                           \
					FROM ventas v %s                                                                 \
					INNER JOIN dventas d ON v.referencia=d.referencia                                \
					INNER JOIN articulos a ON d.articulo=a.articulo                                  \
					%s \
					%s                                                                               \
					%s                                                                               \
					LEFT JOIN (                                                                      \
								SELECT SUM(ventas%d) AS cantidad, producto, present 				 \
								FROM ventasxmes WHERE %s 1 											 \
								GROUP BY producto, present                                           \
					) vxm ON a.producto = vxm.producto AND a.present = vxm.present                   \
					WHERE                                                                            \
							%s                                                                       \
							%s	                                                                     \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							%s                                                                       \
							v.fechavta>@fechacorte                                                   \
							AND v.fechavta<=@fechafinal                                              \
							AND v.cancelado=0                                                        \
					GROUP BY a.producto, a.present                                                   \
					)                                                                                \
					UNION ALL                                                                        \
					(                                                                                \
					 SELECT                                                     					 \
						a.producto,                                                                  \
						a.present,                                                                   \
						%s AS cantvpprom                                                             \
					 FROM notascredcli n                                                             \
					 INNER JOIN dnotascredcli dn ON n.referencia=dn.referencia                       \
					 INNER JOIN ventas v ON n.venta=v.referencia                                     \
					 INNER JOIN dventas dv ON v.referencia=dv.referencia AND dv.articulo=dn.articulo \
					 INNER JOIN articulos a ON dn.articulo=a.articulo                                \
					 %s \
					 %s                                                                              \
					 %s                                                                              \
					 %s                                                                              \
					 WHERE                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						%s                                                                           \
						n.fechanot>@fechacorte                                                       \
						AND n.fechanot<=@fechafinal                                                  \
						AND n.tipo='0'                                                               \
						AND n.cancelado=0                                                            \
					 GROUP BY a.producto, a.present                                                  \
					)                                                                                \
				 ) t                                                                              	 \
				 GROUP BY t.producto, t.present INTO OUTFILE '%s'",
				calculo_promedio_ventas, forzar_indice_vta, join_productos,
				join_presentacion1, join_supervisado,

				dias, condicion_almacen_vta2,

				condicion_producto, condicion_almacen_vta, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
				condicion_supervisado,

				calculo_promedio_devventas,

				join_productos, join_presentacion1, join_supervisado,
				condicion_prov_esp_dv,

				condicion_producto, condicion_almacen_dv, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, condicion_clasifcont, condicion_clasifcont2,
				condicion_supervisado,

				archivo_temp1);

		}
		else {
			instruccion.sprintf
				("SELECT v.producto, v.present, SUM(v.ventas%d) "
				"FROM ventasxmes v " "inner join productos prod on prod.producto=v.producto %s "
				"where %s %s %s %s %s %s %s %s %s 1 " "GROUP BY v.producto,v.present "
				"INTO OUTFILE '%s' ", dias, join_presentacion3,
				condicion_producto, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_fabricante, condicion_segmento,
				condicion_clasifcont, condicion_clasifcont2,

				condicion_almacen_vta2, archivo_temp1);
		}
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventasdev ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = " CREATE TEMPORARY TABLE auxventasxmes (producto VARCHAR(8), present VARCHAR(255), cantidad DECIMAL(16,3), \
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("SELECT                     \
			producto,                                   \
			present,                                    \
			SUM(cantidad) AS cantidad                   \
		FROM existenciasactuales WHERE %s %s 1 			\
		GROUP BY producto, present INTO OUTFILE '%s'", condicion_producto2,
			condicion_almacen_vta2, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventasxmes ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {
			instruccion = " CREATE TEMPORARY TABLE auxsalidas (producto VARCHAR(8), present VARCHAR(255), cantsalprom DECIMAL(16,3), \
			PRIMARY KEY(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;
			archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			if (prov_predeterminado != " ") {
				condicion_prov_esp_join_sv = ",productosprovaux ppa ";
				condicion_prov_esp_sv =
					"  a.producto = ppa.producto AND a.present = ppa.present AND";
			}

			condicion_concepto.sprintf(" m.concepto in (%s) and ",
				cad_conjunto_conceptos);

			instruccion.sprintf("SELECT                                                     \
				a.producto,                                                                 \
				a.present,                                                                  \
				SUM(d.cantidad*a.factor) AS cantsalprom                                     \
			FROM movalma m, dmovalma d, articulos a 	%s , productos prod %s %s                   \
			WHERE                                                                           \
				%s                                                                          \
				m.fechamov>='%s' AND                                                        \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				%s                                                                          \
				m.fechamov>@fechacorte                                                      \
				AND m.fechamov<=@fechafinal                                                 \
				AND m.movimiento=d.movimiento                                               \
				AND m.tipo<>'E'                                                             \
				AND m.aplica=1                                                              \
				AND m.cancelado=0                                                           \
				AND d.articulo=a.articulo                                                   \
				AND a.producto=prod.producto                                                \
			GROUP BY a.producto, a.present INTO OUTFILE '%s'",
				join_presentacion1, condicion_prov_esp_join_sv,
				join_supervisado3, condicion_producto,
				mFg.DateToMySqlDate(fecha_inicial_promedio),

				condicion_almacen_sv, condicion_concepto, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_fabricante,
				condicion_segmento, condicion_prov_esp_sv, condicion_clasifcont,

				condicion_clasifcont2, condicion_supervisado,
				condicion_supervisado2,

				archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxsalidas ",
				archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			inner_join_salida =
				" LEFT JOIN auxsalidas auxsal ON pmm.producto = auxsal.producto AND pmm.present = auxsal.present ";
			campo_salida.sprintf("IFNULL(auxsal.cantsalprom,0)/ %s",
				campo_diasmuestra_CASE);
			campo_salida2 = "IFNULL(auxsal.cantsalprom,0)";

		}

		if (prov_predeterminado != " ") {
			condicion_prov_esp_join_sv =
				"INNER JOIN productosprovaux ppa ON pmm.producto = ppa.producto AND pmm.present = ppa.present ";
		}
		else {
			condicion_prov_esp_join_sv = " ";
		}

		//nueva tabla temporal para resumen de ventas
		instruccion = "CREATE TEMPORARY TABLE auxresventas (producto VARCHAR(8), present VARCHAR(255), cantresventa DECIMAL(16,3),\
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;
		archivo_temp22 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,Respuesta->Id);

		if(esCalculoGlobal == " " || esCalculoGlobal == "1"){
			instruccion.sprintf("SELECT producto, present, SUM(unidades) \
			FROM resumenventas \
			WHERE %s %s 1 and \
			fechavta BETWEEN @fechainicial AND @fechafinal \
			GROUP BY producto, present, sucursal INTO OUTFILE '%s' ", condicion_producto_resventa, condicion_sucursal_resventa, archivo_temp22);

		}else if(esCalculoGlobal == "2"){
			instruccion.sprintf("SELECT producto, present, SUM(unidades) \
			FROM resumenventas \
			WHERE %s %s 1 and \
			fechavta BETWEEN @fechainicial AND @fechafinal \
			GROUP BY producto, present INTO OUTFILE '%s' ", condicion_producto_resventa, condicion_sucursal_resventa, archivo_temp22);
		}
		/*instruccion.sprintf("SELECT producto, present, SUM(unidades) \
			FROM resumenventas \
			WHERE %s %s 1 and \
			fechavta BETWEEN @fechainicial AND @fechafinal \
			GROUP BY producto, present, sucursal INTO OUTFILE '%s' ", condicion_producto_resventa, condicion_sucursal_resventa, archivo_temp22);*/

		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxresventas ", archivo_temp22);
		instrucciones[num_instrucciones++] = instruccion;
		// fin tabla resumen de ventas

		// (IFNULL(auxvtadev.cantvpprom,0)/NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)) AS cantvpprom,
		// NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)
		// campo_salida.sprintf("IFNULL(auxsal.cantsalprom,0)/NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)",dias);
		// NULLIF(IFNULL(pre.diasconexist%d, @vardias),0)",dias
		instruccion = " CREATE TEMPORARY TABLE auxventastot (producto VARCHAR(8), present VARCHAR(255), maxfactor decimal(10,3), \
		multmax varchar(10), minfactor int(5), multmin varchar(10), cantidad DECIMAL(16,3), cantvpprom DECIMAL(16,3),  \
		cantsalprom DECIMAL(16,3), cantvtotprom DECIMAL(16,3), ean13 varchar(14), supervisado VARCHAR(120),\
		PRIMARY KEY(producto, present)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT                                                                                               \
			pmm.producto,                                                                                                         \
			pmm.present,                                                                                                          \
			pmm.maxfactor,                                                                                                        \
			pmm.maxmult,                                                                                                          \
			1 AS minfactor,                                                                                                       \
			pmm.minmult,                                                                                                          \
			IFNULL(e.cantidad,0),                                                                                                 \
			%s \
			%s AS cantsalprom,                    																				  \
			((IFNULL(auxvtadev.cantvpprom,0)+%s + IFNULL(rvent.cantresventa,0) )/ %s) AS cantvtotprom, 	  						  \
			a.ean13 \
			%s \
		FROM presentacionesminmax pmm                                                                                             \
		%s                                                                                          							  \
		INNER JOIN articulos a ON a.producto = pmm.producto AND a.present = pmm.present AND a.factor = 1                          \
        INNER JOIN articulosped ped ON ped.producto=a.producto AND ped.descontinuado = 0\
		%s                                                                                                                        \
		%s                                                                                                                        \
		LEFT JOIN precalculohistoriaconexist%s pre ON pmm.producto = pre.producto AND pmm.present = pre.present %s                  \
		LEFT JOIN auxventasdev auxvtadev ON pmm.producto = auxvtadev.producto AND pmm.present = auxvtadev.present                 \
		%s																														  \
		%s                                                                                                                        \
		LEFT JOIN auxventasxmes e ON pmm.producto = e.producto AND pmm.present = e.present                                        \
		LEFT JOIN auxresventas rvent ON pmm.producto = rvent.producto AND pmm.present = rvent.present \
		%s \
		WHERE %s %s %s %s %s %s %s %s pmm.activo = 1 %s 																			  \
		GROUP BY pmm.producto, pmm.present INTO OUTFILE '%s'",
			campo_diasmuestra, campo_salida, campo_salida2,
			campo_diasmuestra_CASE,
			campo_supervisado,

			condicion_prov_esp_join_sv, inner_artactxsuc, join_supervisado, idEmpresa,
			condicion_suc, inner_join_salida, join_productos,
			join_presentacion1, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_fabricante, condicion_segmento,
			condicion_clasifcont, condicion_clasifcont2, condicion_supervisado,
			condicion_producto_pmm, archivo_temp4);

		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxventastot ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		if (claveSucExist != " ") {

			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", claveSucExist);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_almaexist);
			for (i = 0; i < resp_almaexist->ObtieneNumRegistros(); i++) {
				resp_almaexist->IrAlRegistroNumero(i);
				almacenexistencia = resp_almaexist->ObtieneDato("almacen");

				condicion_almacen_exsuc += "'";
				condicion_almacen_exsuc += almacenexistencia;
				condicion_almacen_exsuc += "'";
				if (i < resp_almaexist->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						condicion_almacen_exsuc += ",";
			}

			condicion_claveSucExist = " and cantidad>0 ";

			instruccion = " CREATE TEMPORARY TABLE auxsucursalexistencia \
				(producto VARCHAR(8), present VARCHAR(255), cantidad DECIMAL(16,3), \
				PRIMARY KEY(producto, present)) ENGINE = INNODB";
			instrucciones[num_instrucciones++] = instruccion;
			archivo_temp20 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);

			instruccion.sprintf("SELECT  producto,present,SUM(cantidad) AS cantidad \
				FROM existenciasactuales WHERE %s  almacen in (%s)  %s \
				GROUP BY producto, present INTO OUTFILE '%s'",
				condicion_producto2, condicion_almacen_exsuc,
				condicion_claveSucExist, archivo_temp20);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxsucursalexistencia ",
				archivo_temp20);
			instrucciones[num_instrucciones++] = instruccion;

			join_claveSucExist =
				" INNER JOIN auxsucursalexistencia exsuc on  exsuc.producto=e.producto and exsuc.present=e.present";

		}

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		camposmesesant =
			" ,TRUNCATE(vma.cantidadmespreant / e.maxfactor, 0) AS cantmaxmespreant, MOD(vma.cantidadmespreant, e.maxfactor) AS restomespreant, \
						TRUNCATE(vma.cantidadmesant / e.maxfactor, 0) AS cantmaxmesant, MOD(vma.cantidadmesant, e.maxfactor) AS restomesant,  \
						TRUNCATE(vma.cantidadmesact / e.maxfactor, 0) AS cantmaxmesact, MOD(vma.cantidadmesact, e.maxfactor) AS restomesact";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		if (esCalculoGlobal == "2" && sucursal == "") {
            sucursal = FormServidor->ObtieneClaveSucursal();
		}

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// Resultado final
			instruccion.sprintf("select                                \
				prod.nombre as nomproducto,                            \
				e.producto,                                            \
				(mod(e.cantvtotprom, a.factor)) AS vtamultimen,        \
				truncate(e.cantvtotprom/a.factor,0) AS vtamultim,      \
				a.factor,                                              \
				e.present, 											   \
				truncate(e.cantidad/e.maxfactor,0) as cantmax, 		   \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, 		   \
				e.multmax, 											   \
				(@resto/e.minfactor) as cantmin, 					   \
				e.multmin, 											   \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				truncate(e.cantvpprom/e.maxfactor,0) as cantmaxvp, \
				@restovp:=mod(e.cantvpprom, e.maxfactor) as restovp, \
				(@restovp/e.minfactor) as cantminvp, \
				e.cantvpprom, \
				truncate(e.cantsalprom/e.maxfactor,0) as cantmaxsalp, \
				@restosal:=mod(e.cantsalprom, e.maxfactor) as restosalp, \
				(@restosal/e.minfactor) as cantminsalp, \
				e.cantsalprom, \
				truncate(e.cantvtotprom/e.maxfactor,7) as cantmaxvtotp, \
				@restovtotprom:=mod(e.cantvtotprom, e.maxfactor) as restovtotp, \
				(@restovtotprom/e.minfactor) as cantminvtotp, \
				e.cantvtotprom, \
				a.articulo as articulomax, \
				am.articulo as articulomin, \
				ap.proveedor, prov.razonsocial as nomprov, \
				ifnull(ap.duracionreorden,0) as duracionreorden, \
				ifnull(ap.duracionmax,0) as duracionmax, \
				ifnull(ap.descontinuado,0) as descontinuado, \
				ifnull(ap.redondeocaja,1) as redondeocaja, \
				ifnull(amulped.factor,0) as factorpedir, \
				ifnull(amulped.articulo,'') as articulopedir, \
				ifnull(amulped.multiplo,'') as multpedir, \
				ifnull(prov.redondeocptecho, 1) AS redondeocptecho, \
				presentcb.costobase as costounitario, \
				(presentcb.costobase*e.maxfactor) as costobasexmultmay, a.articulo,\
				presentcb.costoultimo as costoultimo, \
				(COALESCE(acc.costocompraimp, 0) * e.maxfactor) AS costoultimoxmultmay, \
				a.articulo,\
				ifnull(cp.costounit, 0) as cunitario,\
				a.ean13, e.supervisado \
				%s %s %s %s %s, e.ean13 AS ean13multiplo \
				%s %s \
				from auxventastot e  inner join  productos prod  inner join  presentaciones present inner join  presentacionescb presentcb \
				inner join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo \
				inner join articulos am on e.producto=am.producto and e.present=am.present and e.multmin=am.multiplo \
				%s \
				%s \
				left JOIN precalculocostospromedio%s cp ON cp.producto=a.producto AND cp.present=a.present\
				left join articulosped ap on e.producto=ap.producto and e.present=ap.present AND ap.sucursal='%s' \
				left join articulos amulped on ap.producto=amulped.producto and ap.present=amulped.present and ap.multiplopedir=amulped.multiplo  AND amulped.activo=1 \
				left join proveedores prov on prov.proveedor=ap.proveedor \
				%s %s %s %s %s %s %s %s \
				LEFT JOIN ventasmesesantaux vma ON vma.producto = e.producto AND vma.present = e.present\
				where %s\
				prod.producto=e.producto and e.producto=present.producto and \
				e.present=present.present and presentcb.present=present.present and presentcb.producto=present.producto \
				   and presentcb.idempresa=%s %s %s %s %s %s %s AND ap.descontinuado = 0 \
				GROUP BY e.producto, e.present order by nomproducto, e.present "
				, camposcostoscompra, condicion_preciounit, camposauxnotas,
				campo_productobloqueado, campo_fecha_compra, camposmesesant,
				compos_stock, condicion_ventaOnline, inner_productossinventa,
				FormServidor->ObtieneClaveEmpresa(),
				sucursal,

				leftcostoscompra, join_precios_perdidas, leftauxnotas,
				inner_provcompras, join_art_tags, join_fecha_compra,
				join_claveSucExist, inner_stock, condicion_marca,
				FormServidor->ObtieneClaveEmpresa(), condicion_prov, condicion_productob,
				condicion_present_super_geren, condicion_marca_excluir,
				mostrar_presentaciones_cotizables, condicion_art_tags);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		if (resp_conceptosmovvent != NULL)
			delete resp_conceptosmovvent;
		if (resp_almaexist != NULL)
			delete resp_almaexist;
		delete buffer_sql;

		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		if (cad_conjunto_conceptos != " " && dias >
			0 && consider_salidas_ventas == "1") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		}
		mServidorVioleta->BorraArchivoTemp(archivo_temp4);

		mServidorVioleta->BorraArchivoTemp(archivo_temp7);

		if (ventas == 1)
			mServidorVioleta->BorraArchivoTemp(archivo_temp8);

		if (costoscompra == 1)
			mServidorVioleta->BorraArchivoTemp(archivo_temp10);

		mServidorVioleta->BorraArchivoTemp(archivo_temp11);

		if (archivo_temp15_delete)
			mServidorVioleta->BorraArchivoTemp(archivo_temp15);

		if (archivo_temp19_delete)
			mServidorVioleta->BorraArchivoTemp(archivo_temp19);

		mServidorVioleta->BorraArchivoTemp(archivo_temp17);
		mServidorVioleta->BorraArchivoTemp(archivo_temp18);

		if (claveSucExist != " ")
			mServidorVioleta->BorraArchivoTemp(archivo_temp20);

		mServidorVioleta->BorraArchivoTemp(archivo_temp21);
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPGLOBAL_IEPS
void ServidorReportes::EjecutaRepGlobalIEPS(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, empresa;
	AnsiString campos_base = " ", campos_base_compras = " ";
	BufferRespuestas* resp_impuestos = NULL;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = FormServidor->ObtieneClaveEmpresa();

		// Obtiene los impuestos existentes
		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 AND i.tipoimpu <> 'ISR' \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);
		// Con base a los impuesto existentes forma los campos de consulta que llevan el resultado x
		// cada impuesto existente.
		for (i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");

			cad_val_impuesto.sprintf(" sum(@impcol%s:=(case when i1.orden=%s then @impuesto1 when i2.orden=%s then @impuesto2 \
					  when i3.orden=%s then @impuesto3 when i4.orden=%s then @impuesto4 else 0 end) ) as impcol%s "
				, impuesto, impuesto, impuesto, impuesto, impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le pone coma.
					campos_val_impuestos += ", ";

			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1)
				// A todos menos al ultimo impuesto le signo +.
					campos_suma_impuestos += "+";
		}

		instruccion =
			"create temporary table auximpuestos (impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion =
			"insert into auximpuestos (impuesto) select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

		for (i = 1; i <= 4; i++) {
			// Auxiliares para impuestos de ventas
			instruccion.sprintf("create temporary table auximpuestos%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestos%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;

			// Auxiliares para impuestos de compras (parece redundante, pero se hace a causa de el error
			// Can't reopen table: 'i1' de mysql 5.5.23
			instruccion.sprintf("create temporary table auximpuestosc%d ( \
				orden int(2), impuesto int(2), tipoimpu char(10), \
				porcentaje decimal(5,2), nombre varchar(40), \
				primary key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB"
				, i);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into auximpuestosc%d \
				(orden, impuesto, tipoimpu, porcentaje, nombre) \
				select i.impuesto as orden, i.impuesto as impuesto, \
				i.tipoimpu as tipoimpu, i.porcentaje as porcentaje, \
				t.nombre as nombre \
				from impuestos i, tiposdeimpuestos t, auximpuestos aux \
				where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto", i);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion.sprintf("create temporary table dnotascredcliaux ( \
			venta char(11), \
			articulo varchar(9), \
			cantidad decimal(12,3), \
			precio decimal(16,6), \
			precioimp decimal(16,6), \
			primary key  (venta, articulo) \
			) ENGINE=InnoDB ");
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las compras.
		instruccion.sprintf("insert into dnotascredcliaux \
			(venta, articulo, cantidad, precio, precioimp) \
			select v.referencia as venta, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.precio,0)) as precio, \
			sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp \
			from notascredcli n \
			inner join dnotascredcli d ON n.referencia=d.referencia \
			inner join  ventas v ON n.venta=v.referencia \
			inner join  dventas dv ON dv.referencia=v.referencia AND dv.articulo=d.articulo \
			inner join  articulos ON d.articulo=articulos.articulo \
			inner join  productos prod ON articulos.producto=prod.producto \
			inner join terminales ter ON ter.terminal = n.terminal \
			inner join secciones sec ON sec.seccion = ter.seccion \
			inner join sucursales suc ON suc.sucursal = sec.sucursal \
			where n.cancelado=0 and v.cancelado=0 and \
			n.fechanot<='%s' and suc.idempresa=%s \
			group by v.referencia, d.articulo", fecha_final, empresa);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table dnotascredprovaux ( \
			compra char(11), \
			articulo varchar(9), \
			cantidad decimal(12,3), \
			costo decimal(16,6), \
			costoimp decimal(16,6), \
			primary key  (compra, articulo) \
			) ENGINE=InnoDB ");
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de credito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las compras.
		instruccion.sprintf("insert into dnotascredprovaux \
			(compra, articulo, cantidad, costo, costoimp) \
			select c.referencia as compra, d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad, \
			sum(if(n.tipo<>'0',d.costo,0)) as costo, \
			sum(if(n.tipo<>'0',d.costoimp,0)) as costoimp \
			from notascredprov n inner join  dnotascredprov d inner join  compras c inner join  articulos inner join  productos prod \
				inner join proveedores prov on prov.proveedor=c.proveedor \
				inner join terminales ter ON ter.terminal=c.terminal \
				inner join secciones sec ON ter.seccion=sec.seccion \
				inner join sucursales suc ON suc.sucursal = sec.sucursal \
			where n.compra=c.referencia and n.cancelado=0 and c.cancelado=0 and \
			n.referencia=d.referencia and n.fechanot<='%s' and \
			d.articulo=articulos.articulo and articulos.producto=prod.producto \
			and suc.idempresa=%s \
			group by c.referencia, d.articulo", fecha_final, empresa);
		instrucciones[num_instrucciones++] = instruccion;

		campos_base_compras =
			" 'P' as tipooper, \
			prov.razonsocial as nombre, \
			REPLACE(REPLACE(prov.rfc,' ',''),'-','') AS rfccorto, \
			est.clavesat as clavesatedo, \
			est.nombre as nombreestado, \
			stp.tipoprod, \
			stp.descripcion AS sattipoprod, \
			scve.idclave, \
			scve.descripcion AS satclave, \
			sgrad.idgraduacion, \
			sgrad.descripcion AS satgraduacion, \
			sunid.idunidad, \
			sunid.descripcion AS satunidad, \
			semp.idempaque, \
			semp.descripcion AS satempaque, \
			pre.presentsat, \
			sum((dc.cantidad-ifnull(dn.cantidad,0))) as cantxart, articulos.articulo, \
			articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
			sum(@unidades:=(dc.cantidad-ifnull(dn.cantidad,0))*articulos.factor) as unidades, \
			sum(@suma:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))) as suma, \
			sum(@descuento:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(c.descuento/100)) as descuento, \
			sum(@subtotal:=(dc.costo-ifnull(dn.costo,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)) as subtotal, \
			max((dc.costo-ifnull(dn.costo,0))*(1-c.descuento/100)) as costunit, \
			max((dc.costoimp-ifnull(dn.costoimp,0))*(1-c.descuento/100)) as costunitimp, \
			sum(@iepscuota:=(dc.cantidad-ifnull(dn.cantidad,0))*dc.iepscuota) as iepscuota, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  (@subtotal-@iepscuota) *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
			sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
			sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
			sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";

		campos_base =
			" 'C' as tipooper, \
			cli.rsocial AS nombre, \
			REPLACE(REPLACE(cli.rfc,' ',''),'-','') AS rfccorto, \
			est.clavesat as clavesatedo, \
			est.nombre as nombreestado, \
			stp.tipoprod, \
			stp.descripcion AS sattipoprod, \
			scve.idclave, \
			scve.descripcion AS satclave, \
			sgrad.idgraduacion, \
			sgrad.descripcion AS satgraduacion, \
			sunid.idunidad, \
			sunid.descripcion AS satunidad, \
			semp.idempaque, \
			semp.descripcion AS satempaque, \
			pre.presentsat, \
			sum((dv.cantidad-ifnull(dn.cantidad,0))) as cantxart, articulos.articulo, \
			articulos.multiplo, prod.nombre as nomproducto, articulos.present, \
			sum(@unidades:=(dv.cantidad-ifnull(dn.cantidad,0))*articulos.factor) as unidades, \
			sum(@suma:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))) as suma, \
			sum(@descuento:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(dv.porcdesc/100)) as descuento, \
			sum(@subtotal:=(dv.precio-ifnull(dn.precio,0))*(dv.cantidad-ifnull(dn.cantidad,0))*(1-dv.porcdesc/100)) as subtotal, \
			max((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100)) as costunit, \
			max((dv.precio-ifnull(dn.precio,0))*(1-dv.porcdesc/100)) as costunitimp, \
			sum(@iepscuota:=0.0) as iepscuota, \
			sum(@impuesto1:=if (isnull(i1.porcentaje),0, \
			  @subtotal *( i1.porcentaje/100) ) ) as imp1, \
			sum(@impuesto2:=if (isnull(i2.porcentaje),0, \
			  (@subtotal + @impuesto1) * (i2.porcentaje/100)) ) as imp2, \
			sum(@impuesto3:=if (isnull(i3.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100)) ) as imp3, \
			sum(@impuesto4:=if (isnull(i4.porcentaje),0, \
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100)) ) as imp4, \
			sum(@iva1:=if (@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA', @impuesto1, 0) ) as iva1, \
			sum(@iva2:=if (@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA', @impuesto2, 0) ) as iva2, \
			sum(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) as subgrabado, \
			sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) as subnograbado, ";

		consulta.sprintf("(select \
			%s \
			%s \
			from ventas v force index(fechavta) \
			inner join dventas dv ON v.referencia=dv.referencia \
			inner join articulos ON dv.articulo=articulos.articulo \
			inner join productos prod ON articulos.producto=prod.producto \
			inner join presentaciones pre ON articulos.producto=pre.producto and articulos.present=pre.present \
			inner join clientes cli ON v.cliente=cli.cliente \
			INNER JOIN colonias col ON cli.colonia=col.colonia \
			INNER JOIN localidades loc ON col.localidad=loc.localidad \
			INNER JOIN municipios mun ON  loc.municipio=mun.municipio \
			INNER JOIN estados est ON mun.estado=est.estado \
			INNER JOIN clasifcont cc1 ON prod.clasifcont=cc1.clasif \
			INNER JOIN clasifcont2 cc2 ON	prod.clasifcont2=cc2.clasif2 \
			INNER JOIN sattiposprod stp ON stp.tipoprod=cc1.tipoprod \
			INNER JOIN satgenericaprod scve ON scve.tipoprod=cc2.tipoprod and scve.idclave=cc2.idclave \
			INNER JOIN satgraduacion sgrad ON sgrad.idgraduacion=prod.idgraduacion \
			INNER JOIN satunidadmed sunid ON sunid.idunidad=pre.idunidad \
			INNER JOIN satempaques semp ON semp.idempaque=pre.idempaque \
			INNER JOIN terminales ter ON ter.terminal=v.terminal \
			INNER JOIN secciones sec ON ter.seccion=sec.seccion \
			INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
			left join auximpuestos1 i1 on i1.impuesto=dv.claveimp1 \
			left join auximpuestos2 i2 on i2.impuesto=dv.claveimp2 \
			left join auximpuestos3 i3 on i3.impuesto=dv.claveimp3 \
			left join auximpuestos4 i4 on i4.impuesto=dv.claveimp4 \
			left join dnotascredcliaux dn on dn.articulo=dv.articulo and dn.venta=v.referencia \
			where v.fechavta>='%s' and v.fechavta<='%s' and v.cancelado = 0 and v.tipofac in ('IVADES','VIESPS') \
				and (i1.tipoimpu='IESPS' or i2.tipoimpu='IESPS' or i3.tipoimpu='IESPS' or i4.tipoimpu='IESPS') \
                and suc.idempresa=%s \
			GROUP BY cli.rsocial, est.clavesat, stp.tipoprod, scve.idclave, sgrad.idgraduacion, sunid.idunidad, semp.idempaque, pre.presentsat) \
			UNION ALL \
			(select \
			%s \
			%s \
			from compras c \
				inner join dcompras dc ON c.referencia=dc.referencia \
				inner join articulos ON dc.articulo=articulos.articulo \
				inner join productos prod ON articulos.producto=prod.producto \
				inner join presentaciones pre ON articulos.producto=pre.producto and articulos.present=pre.present \
				inner join proveedores prov ON c.proveedor=prov.proveedor \
				INNER JOIN estados est ON prov.estado=est.estado \
				INNER JOIN clasifcont cc1 ON prod.clasifcont=cc1.clasif \
				INNER JOIN clasifcont2 cc2 ON	prod.clasifcont2=cc2.clasif2 \
				INNER JOIN sattiposprod stp ON stp.tipoprod=cc1.tipoprod \
				INNER JOIN satgenericaprod scve ON scve.tipoprod=cc2.tipoprod and scve.idclave=cc2.idclave \
				INNER JOIN satgraduacion sgrad ON sgrad.idgraduacion=prod.idgraduacion \
				INNER JOIN satunidadmed sunid ON sunid.idunidad=pre.idunidad \
				INNER JOIN satempaques semp ON semp.idempaque=pre.idempaque \
				INNER JOIN terminales ter ON ter.terminal=c.terminal \
				INNER JOIN secciones sec ON ter.seccion=sec.seccion \
				INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
				left join auximpuestosc1 i1 on i1.impuesto=dc.claveimp1 \
				left join auximpuestosc2 i2 on i2.impuesto=dc.claveimp2 \
				left join auximpuestosc3 i3 on i3.impuesto=dc.claveimp3 \
				left join auximpuestosc4 i4 on i4.impuesto=dc.claveimp4 \
				left join dnotascredprovaux dn on dn.articulo=dc.articulo and dn.compra=c.referencia \
			where c.fechacom>='%s' and c.fechacom<='%s' and c.cancelado = 0 and suc.idempresa=%s \
				and (i1.tipoimpu='IESPS' or i2.tipoimpu='IESPS' or i3.tipoimpu='IESPS' or i4.tipoimpu='IESPS') \
			GROUP BY prov.proveedor, est.clavesat, stp.tipoprod, scve.idclave, sgrad.idgraduacion, sunid.idunidad, semp.idempaque, pre.presentsat) \
			ORDER BY tipooper, nombre, nombreestado, tipoprod, idclave, idgraduacion, idunidad, idempaque, presentsat "
			, campos_base, campos_val_impuestos, fecha_inicial, fecha_final, empresa,
			campos_base_compras, campos_val_impuestos, fecha_inicial,
			fecha_final, empresa);

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			instruccion = "select * from impuestos order by impuesto";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTO_INVCAP_COMPARATIVO
void ServidorReportes::EjecutaRepCostoInvcapComparativo
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	char *buffer_inventario_inicial = new char[1024 * 64 * 10];
	char *aux_buffer_inventario_inicial = buffer_inventario_inicial;
	AnsiString fecha, inventarios, almacenes, clasif1, clasif2, clasif3,
		producto, lotes;
	AnsiString nomproducto, presentacion, cveproducto, multiplo, articulo;
	AnsiString fechaaux, instruccion, instrucciones[1000];
	char *resultado_select;
	int NumeroRenglones, i, num_instrucciones = 0, j;
	double cantidad, cantcapturado;
	double costo, costocapturado;
	AnsiString archivo_temp1;
	TFileStream *FStream1 = NULL;
	AnsiString cadena, OrdenarCosto, cond_costos, DiferenciaCostos,
		cond_diferencia_costos,cad_conjunto_almacenes;
	AnsiString OrdenarNombre, cad_orden_nombre = "", lots,sucursal,almacen;
	BufferRespuestas* resp_almacenes = NULL;

	try {
		fecha = mFg.ExtraeStringDeBuffer(&parametros);
		inventarios = mFg.ExtraeStringDeBuffer(&parametros);
		almacenes = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		lotes = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);

        if(almacenes == 0){
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion \
						WHERE s.sucursal='%s'", sucursal);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);

			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
						resp_almacenes->IrAlRegistroNumero(i);
						almacen = resp_almacenes->ObtieneDato("almacen");

						cad_conjunto_almacenes += "'";
						cad_conjunto_almacenes += almacen;
						cad_conjunto_almacenes += "'";
						if (i < resp_almacenes->ObtieneNumRegistros() - 1)
							// A todos menos al ultimo impuesto le signo +.
								cad_conjunto_almacenes += ",";
			}
		}else{
			instruccion.sprintf("SELECT DISTINCT(i.almacen) \
				FROM inventarios i WHERE i.inventario IN (%s)", inventarios);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);

			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
						resp_almacenes->IrAlRegistroNumero(i);
						almacen = resp_almacenes->ObtieneDato("almacen");

						cad_conjunto_almacenes += "'";
						cad_conjunto_almacenes += almacen;
						cad_conjunto_almacenes += "'";
						if (i < resp_almacenes->ObtieneNumRegistros() - 1)
							// A todos menos al ultimo impuesto le signo +.
								cad_conjunto_almacenes += ",";
			}
        }

        almacenes = cad_conjunto_almacenes;


		// Crea tablas temporales
		instruccion.sprintf("create temporary table auxdifscostos1 ( \
			nomproducto varchar(60), present varchar(255), producto varchar(8), \
			cantidad decimal(12,3), costo decimal(16,6), \
			cantcapturado decimal(12,3), costocapturado decimal(16,6), \
			lotes text, \
			primary key(producto,present)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán los multiplos mínimo y máximo.
		instruccion = "create temporary table auxmultminmax ( \
			articulo varchar(9), producto varchar(8), present varchar(255), \
			maxfactor decimal(10,3), multmax varchar(10), cantmax decimal(12,3), \
			minfactor decimal(10,3), multmin varchar(10), cantmin decimal(12,3), \
			INDEX(producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Reporte de costo de inventarios
		// fechaaux=DateToStr(IncDay(mFg.MySqlDateToTDate(mFg.StrToMySqlDate(fecha).c_str()), -1));
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(fecha, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(inventarios, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(almacenes, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(lotes, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(clasif1, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(clasif2, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(clasif3, aux_buffer_inventario_inicial);
		aux_buffer_inventario_inicial =
			mFg.AgregaStringABuffer(producto, aux_buffer_inventario_inicial);
		// ID_EJE_REPCOSTO_INVCAP
		EjecutaRepCostoInventarioCapturado(Respuesta, MySQL,
			buffer_inventario_inicial);
		resultado_select = Respuesta->BufferResultado;
		resultado_select += sizeof(int); // Se salta el tamaño del resultado.
		mFg.ExtraeStringDeBuffer(&resultado_select);
		// Se salta el indicador de error
		resultado_select += sizeof(int); // Se salta el tamaño del buffer
		NumeroRenglones = *((int *)resultado_select);
		// Obtiene número de registros
		resultado_select += sizeof(int); // Se salta el numero de registros
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1, Respuesta->Id);
		FStream1 = new TFileStream(archivo_temp1, fmCreate | fmShareDenyNone);
		// Llena los datos del inventario inicial
		for (i = 0; i < NumeroRenglones; i++) {
			nomproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			presentacion = mFg.ExtraeStringDeBuffer(&resultado_select);
			cveproducto = mFg.ExtraeStringDeBuffer(&resultado_select);
			cantidad =
				mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));
			costo = mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));

			cantcapturado =
				mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));
			costocapturado =
				mFg.CadenaAFlotante
				(mFg.ExtraeStringDeBuffer(&resultado_select));
			lots = mFg.ExtraeStringDeBuffer(&resultado_select);

			// Guardar en archivo temporal
			cadena = nomproducto + "\t" + presentacion + "\t" + cveproducto +
				"\t" + cantidad + "\t" + costo + "\t" + cantcapturado + "\t" +
				costocapturado + "\t" + lots + "\n";
			FStream1->Write(cadena.c_str(), cadena.Length());
		}
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE auxdifscostos1 (nomproducto, present, producto, cantidad, costo, cantcapturado, costocapturado, lotes) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Condicion para ordenar por costos
		OrdenarCosto = mFg.ExtraeStringDeBuffer(&parametros);
		if (OrdenarCosto == "1")
			cond_costos.sprintf(" order by abs(costodiferencia) desc ");
		if (OrdenarCosto == "2")
			cond_costos.sprintf("order by e.nomproducto asc");
		if (OrdenarCosto == "3")
			cond_costos.sprintf("order by e.lotes desc ");
		if (OrdenarCosto == "0")
			cond_costos.sprintf(" ");

		DiferenciaCostos = mFg.ExtraeStringDeBuffer(&parametros);
		if (DiferenciaCostos != " ") {
			cond_diferencia_costos.sprintf
				(" AND abs(e.costocapturado-e.costo)>= %s ", DiferenciaCostos);
		}
		else {
			cond_diferencia_costos = " ";
		}

		// Obtiene los factores minimo y máximo
		instruccion.sprintf("insert into auxmultminmax (articulo, producto, present, maxfactor, minfactor) \
			select a.articulo, a.producto, a.present, max(if(a.activo=1,a.factor,1)) as maxfactor, min(a.factor) as minfactor \
			from articulos a \
			group by a.producto, a.present");
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos (solo para activos)
		instruccion.sprintf("update auxmultminmax e, articulos a \
			set e.multmax=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor");
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxmultminmax e, articulos a \
			set e.multmin=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor ");
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			instruccion.sprintf("select prod.nombre as nomproducto, \
                    amm.articulo AS producto_max, \
					@auxproducto:=e.producto as producto, @auxpresent:=e.present as present, \
					e.costo, \
					@maxcantidad:=truncate(e.cantidad/amm.maxfactor,0) as cantmax, \
					@resto:=mod(e.cantidad, amm.maxfactor) as resto, \
					(@resto/amm.minfactor) as cantmin, \
					e.costocapturado, \
					@maxcantidadinv:=truncate(ifnull(e.cantcapturado,0)/amm.maxfactor,0) as cantmaxinv, \
					@restoinv:=mod(ifnull(e.cantcapturado,0), amm.maxfactor) as restoinv, \
					(@restoinv/amm.minfactor) as cantmininv, \
					(e.costocapturado-e.costo) as costodiferencia, \
					@maxcantidaddif:=((truncate((ifnull(e.cantcapturado,0)-e.cantidad)/amm.maxfactor,0))*-1) as cantmaxdif, \
					@restodif:=mod(ifnull(e.cantcapturado ,0)-e.cantidad, amm.maxfactor) as restodif, \
					((@restodif/amm.minfactor)*-1) as cantmindif, \
					@auxmultmax:=amm.multmax as multmax, \
					@auxmultmin:=amm.multmin as multmin, \
					e.cantidad, \
					amm.minfactor, \
					amm.maxfactor, \
                    e.lotes \
				from auxdifscostos1 e \
					inner join auxmultminmax amm ON e.producto=amm.producto and e.present=amm.present \
					inner join productos prod ON prod.producto=e.producto\
					inner join presentaciones present ON e.producto=present.producto and e.present=present.present \
				where (abs(e.cantidad)>=0.01 or abs(e.cantcapturado)>=0.01) %s %s "
				, cond_diferencia_costos, cond_costos);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (FStream1 != NULL) {
			delete FStream1;
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}
		delete buffer_inventario_inicial;
		delete buffer_sql;
		delete resp_almacenes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPVENTAS_X_COTIZACION
void ServidorReportes::EjecutaRepVentasXCotizacion(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	DatosTabla datos(mServidorVioleta->Tablas);
	// int num_instrucciones=0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, status, tipopago, tipopagoaux;
	AnsiString empresa, sucursal, terminal, cliente, estadofactura, cotzEspecial;
	AnsiString condicion_status = " ", condicion_tipopago = " ",
		condicion_tipopagoaux = " ";
	AnsiString condicion_empresa = " " , condicion_sucursal = " ", condicion_terminal = " ",
		condicion_cliente = " ", condicion_estadofactura = " ";
	AnsiString condicion_cotzEspecial=" ";


	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	status = mFg.ExtraeStringDeBuffer(&parametros);
	tipopago = mFg.ExtraeStringDeBuffer(&parametros);
	tipopagoaux = mFg.ExtraeStringDeBuffer(&parametros);
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	estadofactura = mFg.ExtraeStringDeBuffer(&parametros);
	AnsiString maximas_iteraciones = mFg.ExtraeStringDeBuffer(&parametros);
	AnsiString calcularCostos =mFg.ExtraeStringDeBuffer(&parametros);
	cotzEspecial =mFg.ExtraeStringDeBuffer(&parametros);
	if (status != " ") {
		condicion_status.sprintf(" and pv.cancelado='%s' ", status);
	}
	else
		condicion_status = " ";

	if (tipopago != " ") {
		condicion_tipopago.sprintf("and pv.acredito='%s' ", tipopago);
	}
	else
		condicion_tipopago = " ";

	if (tipopagoaux != " ") {
		condicion_tipopagoaux.sprintf("and pv.termino='%s' ", tipopagoaux);
	}
	else
		condicion_tipopagoaux = " ";

	if(empresa != " "){
		condicion_empresa.sprintf(" and s.idempresa = %s ", empresa);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf("and s.sucursal='%s' ", sucursal);
	}
	else
		condicion_sucursal = " ";

	if (terminal != " ") {
		condicion_terminal.sprintf("and pv.terminal='%s' ", terminal);
	}
	else
		condicion_terminal = " ";
	if (cliente != " ") {
		condicion_cliente.sprintf("and pv.cliente='%s' ", cliente);
	}
	else
		condicion_cliente = " ";
	if (estadofactura != " ") {
		condicion_estadofactura.sprintf("and pv.facturado='%s' ",
			estadofactura);
	}
	else
		condicion_estadofactura = " ";

	if(cotzEspecial!=" "){
		condicion_cotzEspecial.sprintf("and pv.cotzEspecial=%s ", cotzEspecial);
	}

	AnsiString tempResultadoIncompleto = mServidorVioleta->ObtieneArchivoTemp(0, Respuesta->Id);

	mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, "DROP TABLE IF EXISTS aux_resultado_ventasxcotizacion");
	mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		"CREATE TEMPORARY TABLE IF NOT EXISTS aux_resultado_ventasxcotizacion(\
		cotizacion VARCHAR(11) NOT NULL PRIMARY KEY,\
		venta VARCHAR(11),\
		cliente VARCHAR(255),\
		usuarioalta VARCHAR(125),\
		fechaalta DATE,\
		usuariomodi VARCHAR(125),\
		fechamodi DATE,\
		costo DECIMAL(16,2),\
		cancelado BOOLEAN,\
		facturado BOOLEAN,\
		ticket BOOLEAN,\
		costovta DOUBLE, \
		costo_impreciso BOOLEAN DEFAULT FALSE, \
		presentaciones_sin_costo VARCHAR(500))");

	try{
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		instruccion.sprintf("SELECT pv.referencia AS cotizacion ,pv.venta AS venta, \
			IF(c.tipoempre=0,CONCAT(c.nombre,' ',c.appat,' ',c.apmat), c.rsocial) AS cliente, \
			(SELECT CONCAT(e.nombre,' ',e.appat,' ',e.apmat) FROM empleados e WHERE e.empleado=pv.usualta) AS usuarioalta,pv.fechaalta,  \
			(SELECT CONCAT(e.nombre,' ',e.appat,' ',e.apmat) FROM empleados e WHERE e.empleado=pv.usumodi) AS usuariomodi,pv.fechamodi,  \
			pv.valor AS costo, pv.cancelado,pv.facturado,v.ticket,-pcv.costovta, FALSE, NULL\
			FROM clientes c \
			INNER JOIN pedidosventa pv ON c.cliente=pv.cliente \
			INNER JOIN sucursales s ON SUBSTRING(pv.referencia,1,2)=s.sucursal \
			LEFT JOIN  ventas v ON pv.venta=v.referencia \
			LEFT JOIN precalculocostosventa pcv ON pcv.referencia = v.referencia\
			WHERE   pv.fechaped BETWEEN '%s' AND '%s' AND pv.cotizacion=1 %s %s %s %s %s %s %s %s %s INTO OUTFILE '%s' ",
			fecha_inicial, fecha_final, condicion_status, condicion_tipopago,
		condicion_tipopagoaux, condicion_empresa, condicion_sucursal, condicion_terminal,
		condicion_cliente, condicion_estadofactura, condicion_cotzEspecial, tempResultadoIncompleto);
		mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE aux_resultado_ventasxcotizacion",
			tempResultadoIncompleto);
		mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());
	}__finally{
		mServidorVioleta->BorraArchivoTemp(tempResultadoIncompleto);
	}

    int iteracion = 0;
	int faltantes = 1;


	// Esta tabla contendrá todos los artículos cuyo costo no se ha calculado
	instruccion = "DROP TABLE if EXISTS aux_articulos_sin_costo";
	mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

	instruccion = "CREATE TEMPORARY TABLE aux_articulos_sin_costo( \
		fecha_cotizacion DATE, \
		cotizacion varchar(11), \
		producto VARCHAR(8), \
		present VARCHAR(255), \
		factor DECIMAL(10,3), \
		cantidad_cotizada INT UNSIGNED, \
		costovta DOUBLE, \
		INDEX(fecha_cotizacion), \
		INDEX(producto, present), \
		INDEX(cotizacion))";
	mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

	//Esta contendrá los que se vayan calculando en cada iteración
	instruccion = "DROP TABLE if EXISTS aux_articulos_costo";
	mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

	instruccion = "CREATE TEMPORARY TABLE aux_articulos_costo( \
		fecha_cotizacion DATE, \
		cotizacion varchar(11), \
		producto VARCHAR(8), \
		present VARCHAR(255), \
		factor DECIMAL(10,3), \
		cantidad_cotizada INT UNSIGNED,\
		costovta DOUBLE, \
		INDEX(fecha_cotizacion), \
		INDEX(producto, present), \
		INDEX(present), \
		INDEX(cotizacion))";
	mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());


	if(calcularCostos=="1"){
		AnsiString at_sinCosto = mServidorVioleta->ObtieneArchivoTemp(1, Respuesta->Id);
		try{
			instruccion.sprintf("SELECT c.fechaalta, c.cotizacion, art.producto, art.present, art.factor, dc.cantidad, NULL \
				FROM aux_resultado_ventasxcotizacion c \
				INNER JOIN dpedidosventa dc ON dc.referencia = c.cotizacion \
                INNER JOIN articulos art ON art.articulo = dc.articulo \
				WHERE ISNULL(c.costovta) \
				INTO OUTFILE '%s'", at_sinCosto);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

			instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE aux_articulos_sin_costo",
				at_sinCosto);
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

		}__finally{
			mServidorVioleta->BorraArchivoTemp(at_sinCosto);
		}

		// Esta tabla servirá para almacenar las fechas máximas en ventas que coincidan en productos y fechas
		// *****************************Inicia la parte iterativa*****************************

		while(faltantes > 0 && iteracion < StrToInt(maximas_iteraciones)){
			AnsiString at_maxFechasVendidos = mServidorVioleta->ObtieneArchivoTemp(2, Respuesta->Id);
			try{
				instruccion = "DROP TABLE if EXISTS aux_articulos_vendidos";
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

				instruccion = "CREATE TEMPORARY TABLE aux_articulos_vendidos( \
					distancia INT UNSIGNED, venta VARCHAR(11), cotizacion VARCHAR(11), producto VARCHAR(8), \
					present VARCHAR(255), factor DECIMAL(10,3), INDEX (distancia), INDEX (venta), \
					INDEX (cotizacion), INDEX(producto, present))";
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

				if(iteracion == 0){

					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SET @fechamin = (SELECT MIN(fecha_cotizacion) FROM aux_articulos_sin_costo)");
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SET @fechamax = (SELECT MAX(fecha_cotizacion) FROM aux_articulos_sin_costo)");

					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
						"SET @fecha1 = @fechamin, @fecha2 = @fechamax, @fecha3 = @fechamax, @fecha4 = @fechamax");
				} else {
					instruccion.sprintf("SET @fecha1 = DATE_ADD(@fecha1,INTERVAL -%s DAY)", AnsiString(IntToStr(iteracion + 1)));
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

					instruccion.sprintf("SET @fecha2 = LEAST(DATE_ADD(@fecha1,INTERVAL %s DAY), CURDATE())", AnsiString(IntToStr(iteracion)));
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

					instruccion.sprintf("SET @fecha3 = LEAST(DATE_ADD(@fecha3, INTERVAL %s DAY), CURDATE())", AnsiString(IntToStr(iteracion)));
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

					instruccion.sprintf("SET @fecha4 = LEAST(DATE_ADD(@fecha3, INTERVAL %s DAY), CURDATE())", AnsiString(IntToStr(iteracion)));
					mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());
				}

				#ifdef _DEBUG
					//mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SELECT @fecha1, @fecha2, @fecha3, @fecha4");
				#endif

				instruccion.sprintf("SELECT ABS(DATEDIFF(v.fechavta, ars.fecha_cotizacion)), v.referencia, ars.cotizacion, \
                    ars.producto, ars.present, ars.factor \
					FROM ventas v FORCE INDEX(fechavta)\
					INNER JOIN dventas dv ON v.referencia = dv.referencia \
                    INNER JOIN articulos art ON art.articulo = dv.articulo \
					INNER JOIN aux_articulos_sin_costo ars ON ars.producto = art.producto AND ars.present = art.present \
					WHERE \
					((v.fechavta BETWEEN \
						@fecha1 \
						AND \
						@fecha2) \
					OR (@fecha3 > @fecha2 AND @fecha3 <= CURDATE() AND v.fechavta BETWEEN \
						@fecha3 \
						AND \
						@fecha4)) and v.cancelado = 0 \
					ORDER BY ars.cotizacion, ars.producto, ars.present \
					INTO OUTFILE '%s'", at_maxFechasVendidos);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

				instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE aux_articulos_vendidos",
					at_maxFechasVendidos);
				mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

				#ifdef _DEBUG
					//mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SELECT * FROM aux_articulos_vendidos");
				#endif

			}__finally{
				mServidorVioleta->BorraArchivoTemp(at_maxFechasVendidos);
			}

			instruccion = "DROP TABLE if EXISTS aux_max_articulos_vendidos";
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

			instruccion = "CREATE TEMPORARY TABLE aux_max_articulos_vendidos(\
				distancia INT UNSIGNED, venta VARCHAR(11), cotizacion VARCHAR(11), producto VARCHAR(8), \
				present VARCHAR(255), factor DECIMAL(10,3), \
				INDEX (distancia), INDEX (venta), INDEX (cotizacion), INDEX(producto, present))";
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "INSERT INTO aux_max_articulos_vendidos \
				SELECT a1.* from aux_articulos_vendidos a1 \
				INNER JOIN (SELECT MIN(ABS(distancia)) AS distancia, cotizacion, producto, present, factor  \
				FROM aux_articulos_vendidos GROUP BY cotizacion, producto, present, factor) a2 \
				ON a1.distancia = a2.distancia AND a1.cotizacion = a2.cotizacion AND a1.producto = a2.producto \
				AND a1.present = a2.present  AND a1.factor = a2.factor GROUP BY a1.producto, a1.present, a1.factor, a1.cotizacion ");

			#ifdef _DEBUG
				//mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SELECT * FROM aux_max_articulos_vendidos");
			#endif

			// Se actualizan los costos encontrados en la venta con la fecha correspondiente
			instruccion.sprintf("UPDATE \
				aux_articulos_sin_costo ars, \
				aux_max_articulos_vendidos mav, \
				precalculocostosventadet pcv \
				SET ars.costovta = ars.cantidad_cotizada * mav.factor * pcv.costovta/pcv.cantidad \
				WHERE mav.cotizacion = ars.cotizacion AND ars.producto = mav.producto AND ars.present = mav.present \
				AND ars.factor = mav.factor AND pcv.producto = mav.producto AND pcv.present = mav.present \
				AND pcv.referencia = mav.venta AND pcv.tipo ='VE'");
			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, instruccion.c_str());

			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				"INSERT INTO aux_articulos_costo \
					SELECT * FROM aux_articulos_sin_costo arc WHERE \
					NOT ISNULL(arc.costovta)");

			#ifdef _DEBUG
				//mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SELECT * FROM aux_articulos_costo");
			#endif

			mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,
				"DELETE FROM aux_articulos_sin_costo where NOT ISNULL(costovta)");

			#ifdef _DEBUG
				//mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL, "SELECT * FROM aux_articulos_sin_costo");
			#endif

			char * bu_conteoFaltantes = new char[1024];
			try{
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, " SELECT COUNT(*) FROM aux_articulos_sin_costo ", bu_conteoFaltantes);
				BufferRespuestas br_conteoFaltantes(bu_conteoFaltantes);
				faltantes = StrToInt(br_conteoFaltantes.ObtieneDato());
			}__finally{
				delete bu_conteoFaltantes;
			}

			iteracion += 1;
		}
		mServidorVioleta->EjecutaSelectSqlNulo(Respuesta, MySQL,"UPDATE aux_resultado_ventasxcotizacion vxc \
			INNER JOIN (SELECT cotizacion, SUM(costovta) as costovta FROM aux_articulos_costo t1 GROUP BY t1.cotizacion) arc ON vxc.cotizacion = arc.cotizacion \
			SET vxc.costovta = arc.costovta ");

		mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, "UPDATE aux_resultado_ventasxcotizacion vxc \
			INNER JOIN ( SELECT _asc.*, GROUP_CONCAT(CONCAT_WS(',', _asc.producto, _asc.present) SEPARATOR ';') as presentaciones_sin_costo \
				FROM aux_articulos_sin_costo _asc \
				GROUP BY _asc.cotizacion) psc ON psc.cotizacion = vxc.cotizacion \
			set vxc.costo_impreciso = TRUE, vxc.presentaciones_sin_costo =  psc.presentaciones_sin_costo ");
	}

	instruccion.sprintf("SELECT %s as iteraciones, @fecha1 as f1, @fecha4 as f2, count(*) as incompletas FROM (select cotizacion FROM aux_articulos_sin_costo a1 GROUP BY a1.cotizacion) r",
		AnsiString(IntToStr(iteracion)));
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);

	// Resultado
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
		"SELECT * FROM aux_resultado_ventasxcotizacion", Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPORTUTILIDADES
void ServidorReportes::EjecutaReportUtilidades(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo;
	TDate fecha = Today();
	AnsiString producto, minmax, obtener_existencias,
		obtener_articulos_inactivos, marca, tipoprecio;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString condicion_almacen = " ", condicion_producto = " ",
		condicion_minmax = " ", condicion_articulos_inactivos = " ",
		condicion_marca = " ", condicion_tipoprecio = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString campos_existencias = " ", join_existencias = " ";
	AnsiString mandar_lista_completa_articulos_autoservicio = " ",
		condicion_mandar_lista_completa = " ";
	AnsiString forzar_indice_vta = " force index(fechavta) ";
	AnsiString empresa, sucursal, condicion_sucursal = " ";
	AnsiString almacen, cad_conjunto_almacenes = " ";
	AnsiString lista_autoservicio, solo_cambio_precio, fecha_corte_precios,
		solo_con_existencias, solo_autoservicio;
	AnsiString condicion_solo_cambio_precio = " ",
		condicion_solo_con_existencias = " ", condicion_solo_autoservicio = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5;
	AnsiString tipo_utilidad, tipo_orden_busqueda, condicion_utilidad = " ",
		innerjoin_utilidad = " ", order_by_descrip = " ";
	AnsiString empleadosupervisor = " ", condicion_empleadosupervisor = " ",
		inner_empleadosupervisor = " ", campo_supervisado = " ";
	BufferRespuestas* resp_almacenes = NULL;

	try {
		empresa = FormServidor->ObtieneClaveEmpresa(); //si se requiere, reemplazar por un parámetro
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// minmax=mFg.ExtraeStringDeBuffer(&parametros);
		// obtener_existencias=mFg.ExtraeStringDeBuffer(&parametros);
		// obtener_articulos_inactivos=mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		tipoprecio = mFg.ExtraeStringDeBuffer(&parametros);
		lista_autoservicio = mFg.ExtraeStringDeBuffer(&parametros);
		solo_cambio_precio = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_corte_precios = mFg.ExtraeStringDeBuffer(&parametros);
		solo_con_existencias = mFg.ExtraeStringDeBuffer(&parametros);
		solo_autoservicio = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_utilidad = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_orden_busqueda = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);

        if(lista_autoservicio != "1"){
			throw Exception("El parametro de la lista autoservicio siempre debe ser 1");
		}

		// Seleccionar el tipo de orden de búsqueda
		if (tipo_orden_busqueda == "0") {
			order_by_descrip =
				" porcentaje ASC, prod.nombre ASC,  a.multiplo ASC ";
		}
		else {
			order_by_descrip = "  prod.nombre ";
		}

		// Obtiene los almacenes que corresponden a una sucursal
		if (sucursal != " ") {
			instruccion.sprintf("SELECT a.almacen FROM almacenes a \
				INNER JOIN secciones s ON a.seccion=s.seccion \
				WHERE s.sucursal='%s'", sucursal);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_almacenes);
			for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
				resp_almacenes->IrAlRegistroNumero(i);
				almacen = resp_almacenes->ObtieneDato("almacen");

				cad_conjunto_almacenes += "'";
				cad_conjunto_almacenes += almacen;
				cad_conjunto_almacenes += "'";
				if (i < resp_almacenes->ObtieneNumRegistros() - 1)
					// A todos menos al ultimo impuesto le signo +.
						cad_conjunto_almacenes += ",";
			}
		}

		if (minmax == "0")
			condicion_minmax = "min";
		else
			condicion_minmax = "max";

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			forzar_indice_vta = " ";
		}
		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			forzar_indice_vta = " ";
		}

		if (marca != " ") {
			condicion_marca.sprintf("prod.marca='%s' AND ", marca);
		}

		if (tipoprecio != " ") {
			condicion_tipoprecio.sprintf(" t.tipoprec='%s' ", tipoprecio);
		}

		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}
		// tipo de utilidad
		if (tipo_utilidad != " ") {
			condicion_utilidad.sprintf("ae.tipoutil='%s' and ", tipo_utilidad);
		}
		else {
			condicion_utilidad = " ";
		}

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf(" ars.usuario='%s' and ",
				empleadosupervisor);
		}
		else {
			condicion_empleadosupervisor = " ";
		}
		inner_empleadosupervisor.sprintf("LEFT JOIN articulossupervisados ars ON ars.producto=prod.producto and ars.present=pre.present  \
			LEFT JOIN empleados emp on emp.empleado=ars.usuario  ");
		campo_supervisado.sprintf
			(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado "
			);

		// Obtiene las existencias solo si se requieren
		if (obtener_existencias == "1" ||
			(lista_autoservicio == "1" && solo_con_existencias == "1")) {/*

			// Obtiene fecha del corte más próximo previo a la fecha dada
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'",
				mFg.DateToMySqlDate(fecha));
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
			instruccion = "create temporary table existenciasaux ( \
				producto varchar(8), present varchar(255), \
				tipo char(2), cantidad decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias finales
			instruccion = "create temporary table auxexistsumadas ( \
				producto varchar(8), present varchar(255), \
				cantidad decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;

			// Crea una tabla donde se pondrán las existencias finales
			instruccion = "create temporary table auxexistfinales ( \
				producto varchar(8), present varchar(255), \
				cantidad decimal(12,3), \
				maxfactor decimal(10,3), multmax char(16), cantmax decimal(12,3), \
				minfactor decimal(10,3), multmin char(16), cantmin decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula la existencia al momento del corte previo.
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" pce.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select pce.producto, pce.present, 'IN' as tipo, \
				sum(pce.cantidad) as cantidad \
				from puntoscorteexistencias pce, productos prod \
				where %s %s %s %s %s \
				pce.fecha=@fechacorte and pce.producto=prod.producto \
				group by pce.producto, pce.present INTO OUTFILE '%s'",
				condicion_almacen, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_producto, archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" c.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad \
				from compras c, dcompras d, articulos a, productos prod \
				where %s %s %s %s %s \
				c.fechacom>@fechacorte and c.referencia=d.referencia \
				and c.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
				group by a.producto, a.present INTO OUTFILE '%s'",
				condicion_almacen, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_producto, archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
				archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las devoluciones a las compras
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" c.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
				select a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
				from notascredprov n, compras c, dnotascredprov d, articulos a, productos prod \
				where  %s %s %s %s %s \
				n.fechanot>@fechacorte and n.tipo='0' \
				and n.referencia=d.referencia and n.compra=c.referencia and \
				n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
				group by a.producto, a.present", condicion_almacen,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_producto);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las ventas.
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" d.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
				from ventas v %s  inner join  dventas d  inner join  articulos a \
				left join productos prod on a.producto=prod.producto \
				where %s %s %s %s %s \
				v.fechavta>@fechacorte and v.referencia=d.referencia \
				and v.cancelado=0 and d.articulo=a.articulo \
				group by a.producto, a.present INTO OUTFILE '%s'",
				forzar_indice_vta, condicion_almacen, condicion_clasif1,
				condicion_clasif2, condicion_clasif3, condicion_producto,
				archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
				archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las devoluciones a las ventas
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" dv.almacen in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			instruccion.sprintf("insert into existenciasaux (producto, present, tipo, cantidad) \
				select a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad \
				from notascredcli n, dnotascredcli dn, ventas v, dventas dv, articulos a, productos prod \
				where %s %s %s %s %s \
				n.fechanot>@fechacorte and n.tipo='0' \
				and n.referencia=dn.referencia and n.venta=v.referencia \
				and v.referencia=dv.referencia and \
				n.cancelado=0 and dn.articulo=a.articulo and dv.articulo=dn.articulo and a.producto=prod.producto \
				group by a.producto, a.present", condicion_almacen,
				condicion_clasif1, condicion_clasif2, condicion_clasif3,
				condicion_producto);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las entradas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" m.almaent in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select a.producto, a.present, 'EN' as tipo, sum(d.cantidad*a.factor) as cantidad \
				from movalma m, dmovalma d, articulos a, productos prod \
				where %s %s %s %s %s \
				m.fechamov>@fechacorte and m.movimiento=d.movimiento \
				and m.tipo<>'S' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
				group by a.producto, a.present INTO OUTFILE '%s'",
				condicion_almacen, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_producto, archivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
				archivo_temp4);
			instrucciones[num_instrucciones++] = instruccion;

			// Calcula las salidas de almacén
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" m.almasal in (%s) and ",
					cad_conjunto_almacenes);
			}
			else
				condicion_almacen = " ";
			archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("select a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
				from movalma m, dmovalma d, articulos a, productos prod \
				where %s %s %s %s %s \
				m.fechamov>@fechacorte and m.movimiento=d.movimiento \
				and m.tipo<>'E' \
				AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto \
				group by a.producto, a.present INTO OUTFILE '%s'",
				condicion_almacen, condicion_clasif1, condicion_clasif2,
				condicion_clasif3, condicion_producto, archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (producto, present, tipo, cantidad) ",
				archivo_temp5);
			instrucciones[num_instrucciones++] = instruccion;

			if (obtener_existencias == "1") {
				// Suma los movimientos para obtener las existencias
				instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
						select e.producto, e.present, sum(e.cantidad) as cantidad \
						from existenciasaux e \
						group by e.producto, e.present");
				instrucciones[num_instrucciones++] = instruccion;

				// Obtiene los factores minimo y máximo
				instruccion.sprintf("insert into auxexistfinales (producto, present, cantidad, maxfactor, minfactor) \
					select a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
					from auxexistsumadas e, articulos a \
					where e.producto=a.producto and e.present=a.present %s \
					group by e.producto, e.present",
					condicion_articulos_inactivos);
				instrucciones[num_instrucciones++] = instruccion;

				// Obtiene los múltiplos maximos
				instruccion.sprintf("update auxexistfinales e, articulos a \
					set e.multmax=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
					e.present=a.present and e.maxfactor=a.factor %s ",
					condicion_articulos_inactivos);
				instrucciones[num_instrucciones++] = instruccion;

				// Obtiene los múltiplos minimos
				instruccion.sprintf("update auxexistfinales e, articulos a \
					set e.multmin=concat(a.multiplo,' X ',a.factor) where e.producto=a.producto and \
					e.present=a.present and e.minfactor=a.factor %s ",
					condicion_articulos_inactivos);
				instrucciones[num_instrucciones++] = instruccion;

				// Resultado final
				instruccion.sprintf("create temporary table auxexisttotales \
					select e.producto, e.present, \
					@maxcantidad:=truncate(e.cantidad/e.maxfactor,0) as cantmax, \
					@resto:=mod(e.cantidad, e.maxfactor) as resto, \
					e.multmax, \
					(@resto/e.minfactor) as cantmin, \
					e.multmin \
					from auxexistfinales e");
				instrucciones[num_instrucciones++] = instruccion;

				campos_existencias =
					", ex.multmax, ex.cantmax, ex.multmin, ex.cantmin ";
				join_existencias =
					" left join auxexisttotales ex on ex.producto=a.producto and ex.present=a.present ";

			}
			else {
				// Suma los movimientos para obtener las existencias (SOLO LOS QUE TENGAN cantida>0)
				instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
						select e.producto, e.present, sum(e.cantidad) as cantidad \
						from existenciasactuales e \
						group by e.producto, e.present \
						having cantidad>0");
				instrucciones[num_instrucciones++] = instruccion;

				campos_existencias = ", ex.cantidad ";
				join_existencias =
					" inner join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
			}*/

            instruccion = "create temporary table auxexistsumadas ( \
				producto varchar(8), present varchar(255), \
				cantidad decimal(12,3), \
				INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;


            instruccion.sprintf("insert into auxexistsumadas (producto, present, cantidad) \
						select e.producto, e.present, sum(e.cantidad) as cantidad \
						from existenciasactuales e \
						group by e.producto, e.present \
						having cantidad>0");
				instrucciones[num_instrucciones++] = instruccion;

			if (obtener_existencias == "1") {
				join_existencias = " left join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
			}else{
				join_existencias = " inner join auxexistsumadas ex on ex.producto=a.producto and ex.present=a.present ";
			}
		}
		instruccion.sprintf("create temporary table auxfactor select articulo, producto, \
			present, %s(factor) as factor from articulos group by producto, present"
			, condicion_minmax);
		instrucciones[num_instrucciones++] = instruccion;

		// se obtiene el precio de autoservicio
		// parametros que causan conflicto
		// and para.valor=cli.cliente AND cli.tipoprec=t.tipoprec
		instruccion.sprintf("select @precautosu:= t.tipoprec,@descripcion:=t.descripcion \
			from parametrosemp para, clientes cli, tiposdeprecios t \
			where para.parametro='AUTOSUCLI' and %s AND para.sucursal = '%s' ", condicion_tipoprecio, FormServidor->ObtieneClaveSucursal());
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			//////////////
			// Respuesta//
			//////////////
			if (lista_autoservicio == "0") {
				// En caso de NO ser lista para imprimir precios que se han modificado
				instruccion.sprintf("select prod.producto, prod.nombre, pre.present, a.multiplo, a.factor, \
					 prec1.precio as supermayoreo, \
					 prec2.precio as mayoreo, \
					 prec3.precio as mayoreocredito, \
					 prec4.precio as publico %s \
					from articulos a  inner join  productos prod  inner join  presentaciones pre  inner join  auxfactor aux \
					inner join articulosemp ae ON ae.articulo = a.articulo AND ae.idempresa=%s \
					left join precios prec1 on prec1.tipoprec='4' and prec1.articulo=a.articulo \
					left join precios prec2 on prec2.tipoprec='3' and prec2.articulo=a.articulo \
					left join precios prec3 on prec3.tipoprec='5' and prec3.articulo=a.articulo \
					left join precios prec4 on prec4.tipoprec='6' and prec4.articulo=a.articulo \
					%s \
					where %s %s %s %s %s %s\
					a.producto=prod.producto and a.producto=pre.producto and a.present=pre.present \
					and a.factor=aux.factor and aux.producto=a.producto and aux.present=a.present %s \
					group by prod.producto, pre.present \
					order by prod.nombre, pre.present", campos_existencias, empresa,
					join_existencias, condicion_clasif1, condicion_clasif2,
					condicion_clasif3, condicion_producto, condicion_marca,
					condicion_utilidad, condicion_articulos_inactivos);
			}
			else {

				if (solo_cambio_precio == "1") {
					condicion_solo_cambio_precio.sprintf
						(" and prec1.fechamodi >= '%s' ", fecha_corte_precios);
				}
				if (solo_autoservicio == "1") {
					condicion_solo_autoservicio.sprintf(" and a.asigautosu=1 ");
				}

				// En caso de ser lista para imprimir precios que se han modificado   pl.porcutil,
				// @cost:=IF(ISNULL(aut.fechaVigencia) OR ISNULL(pl.costo), prec1.costo, pl.costo)*a.factor as costo,
				instruccion.sprintf("SELECT prec1.tipoprec,@descripcion as descripcion, a.producto, prod.nombre, pre.present, a.multiplo, a.factor,a.articulo, \
									@auto:=IF(ISNULL(pl.precio) OR ISNULL(aut.fechavigencia), prec1.precio, pl.precio) AS autoservicio, 	\
									@cost:=IF(cp.costounit*a.factor<0.001,'999999999',cp.costounit*a.factor) AS costo, cp.costounit, \
									IF(ISNULL(pl.precio) OR ISNULL(aut.fechavigencia), '0', '1') AS espreciolocal, 	 \
									a.ean13 AS codigobarras ,\
									IF(ISNULL(pl.precio), prec1.porcutil, pl.porcutil) AS porcutil, ae.tipoutil, \
									@precionsimp:=@auto/(1+(IFNULL(i2.porcentaje,0.0)/100)) AS subtotal,  	  \
									@precionsimpuestos:=@precionsimp/(1+(IFNULL(i1.porcentaje,0.0)/100)) AS total,  \
									@util:=(@precionsimpuestos - @cost) AS utilidad, \
									(@util*100)/@cost AS porcentaje \
									%s\
									from articulos a  inner join  productos prod  inner join  presentaciones pre \
									inner join precios prec1 inner join precalculocostospromedio%s cp ON cp.present=a.present AND cp.producto=a.producto \
									inner join tiposdeprecios tp ON tp.tipoprec = prec1.tipoprec and tp.idempresa=%s \
									inner join articulosemp ae ON ae.articulo = a.articulo AND ae.idempresa=%s \
									%s \
									%s \
									left join impuestos i1 on i1.impuesto=prod.claveimpv1 \
									left join impuestos i2 on i2.impuesto=prod.claveimpv2 \
									LEFT JOIN preciolocal pl \
										ON pl.articulo = a.articulo \
										AND pl.tipoprec = @precautosu \
										AND pl.sucursal='%s' \
									LEFT JOIN autorizarprecios aut \
										ON aut.sucursal='%s' \
										AND aut.producto=a.producto AND aut.present=a.present \
										AND aut.fechavigencia>='%s' \
									where %s %s %s %s %s %s\
									%s\
									prec1.tipoprec=@precautosu and prec1.articulo=a.articulo and a.activo=1 and  pre.producto=cp.producto and pre.present=cp.present and\
									a.producto=prod.producto and a.producto=pre.producto and a.present=pre.present %s %s \
									group by prod.producto, pre.present, a.multiplo \
									ORDER BY %s ", campo_supervisado, empresa,empresa,empresa,
					join_existencias, inner_empleadosupervisor, sucursal,
					sucursal, mFg.DateToMySqlDate(fecha), condicion_clasif1,
					condicion_clasif2, condicion_clasif3, condicion_producto,
					condicion_marca, condicion_utilidad,
					condicion_empleadosupervisor, condicion_solo_cambio_precio,
					condicion_solo_autoservicio, order_by_descrip);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		mServidorVioleta->BorraArchivoTemp(archivo_temp4);
		mServidorVioleta->BorraArchivoTemp(archivo_temp5);

	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_REP_DETALLEINVENTARIO
void ServidorReportes::EjecutaReportDetalleInventario
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {

	int num_instrucciones = 0, i;
	AnsiString instruccion, instrucciones[100], producto, present, inventario;
	char *buffer_sql = new char[1024 * 10];
	char *aux_buffer_sql = buffer_sql;

	try {
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		present = mFg.ExtraeStringDeBuffer(&parametros);
		inventario = mFg.ExtraeStringDeBuffer(&parametros);

		instrucciones[num_instrucciones++] =
			"CREATE TEMPORARY TABLE auxmultminmax ( producto VARCHAR(8), present VARCHAR(255),    \
		maxfactor DECIMAL(10,3), minfactor DECIMAL(10,3),	INDEX(producto, present)) ENGINE = INNODB";

		instruccion.sprintf("INSERT INTO auxmultminmax SELECT IFNULL(producto,'%s'),IFNULL(present,'%s'), \
		IFNULL(MAX(factor),1), IFNULL(MIN(factor),1) 	FROM articulos WHERE producto = '%s' AND present = '%s' \
		AND activo = '1' ", producto, present, producto, present);
		instrucciones[num_instrucciones++] = instruccion;

		instrucciones[num_instrucciones++] = "CREATE TEMPORARY TABLE auxcantidad (producto VARCHAR(8), present VARCHAR(255), 	\
		articulo VARCHAR(9), maxfactor DECIMAL(10,3),cantmax DECIMAL(12,3), minfactor DECIMAL(10,3), cantmin DECIMAL(12,3), \
		inventario VARCHAR(11),lote VARCHAR(11),factor DECIMAL(10,3), cantidad DECIMAL(12,3), \
		INDEX(producto, present,articulo)) ENGINE = INNODB ";

		instruccion.sprintf("INSERT INTO auxcantidad SELECT a.producto,a.present,a.articulo,au.maxfactor,0.000 AS cantmax, \
		au.minfactor,0.000 AS cantmin, d.inventario,d.lote, a.factor, d.cantidad FROM dinventarios d INNER JOIN articulos \
		a ON a.producto = '%s' AND  a.present = '%s' AND a.articulo = d.articulo  INNER JOIN auxmultminmax au WHERE \
		d.inventario IN(%s)", producto, present, inventario);
		instrucciones[num_instrucciones++] = instruccion;

		instrucciones[num_instrucciones++] =
			"UPDATE auxcantidad SET cantmax = TRUNCATE((factor * cantidad)/maxfactor,0), \
		cantmin = ((factor * cantidad) - TRUNCATE((factor * cantidad)/maxfactor,0) * maxfactor) ";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			instruccion = "SELECT producto,present,maxfactor, SUM(cantmax) AS cantmax,minfactor,SUM(cantmin) AS cantmin,inventario,lote  \
		FROM auxcantidad GROUP BY inventario,lote ORDER BY inventario,lote";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {

		// if (aux_buffer_sql!=NULL) delete aux_buffer_sql;
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------

// ---------------------------------------------------------------------------
// ID_CON_REPMODALM
void ServidorReportes::ConsultaReporteModificacionAlm
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	// CONSULTA MOVIMIENTO DE ALMACEN
	AnsiString instruccion;
	AnsiString id;
	AnsiString producto, present;
	AnsiString fechaini, fechafin;
	AnsiString sucursal = "", almacen = "", movmod;
	AnsiString cancelado, condicion_canc, condicion_cancnot, condicion_canccomp,
		condicion_cancmov;
	AnsiString condicion_movmod = " ", condicion_movmodnot = " ";
	AnsiString condicion_movmodcomp = " ", condicion_movmodmov = " ";

	producto = mFg.ExtraeStringDeBuffer(&parametros);
	present = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	almacen = mFg.ExtraeStringDeBuffer(&parametros);
	fechaini = mFg.ExtraeStringDeBuffer(&parametros);
	fechafin = mFg.ExtraeStringDeBuffer(&parametros);
	cancelado = mFg.ExtraeStringDeBuffer(&parametros);
	// Incluir cancelados si o no
	movmod = mFg.ExtraeStringDeBuffer(&parametros);
	// Incluir archivos modificados SI o NO
	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	if (cancelado == "SI") {
		condicion_canc = "AND (v.cancelado = '0' OR v.cancelado = '1')";
		condicion_cancnot = "AND (n.cancelado = '0' OR n.cancelado = '1')";
		condicion_canccomp = "AND (c.cancelado = '0' OR c.cancelado = '1')";
		condicion_cancmov = "AND (m.cancelado = '0' OR m.cancelado = '1')";
	}
	else {
		condicion_canc = "AND v.cancelado = '0' ";
		condicion_cancnot = "AND n.cancelado = '0'";
		condicion_canccomp = "AND c.cancelado = '0'";
		condicion_cancmov = "AND m.cancelado = '0'";
	}

	if (movmod == "SI") {
		condicion_movmod =
			" AND (v.fechamodi <> v.fechaalta OR v.horaalta <> v.horamodi) AND (v.fechamodi <> v.fechavta OR v.horaalta <> v.horamodi) ";
		condicion_movmodnot =
			" AND (n.fechamodi <> n.fechaalta OR n.horaalta <> n.horamodi) AND (n.fechamodi <> n.fechanot OR n.horaalta <> n.horamodi) ";
		condicion_movmodcomp =
			" AND (c.fechamodi <> c.fechaalta OR c.horaalta <> c.horamodi) AND (c.fechamodi <> c.fechacom OR c.horaalta <> c.horamodi) ";
		condicion_movmodmov =
			" AND (m.fechamodi <> m.fechaalta OR m.horaalta <> m.horamodi) AND (m.fechamodi <> m.fechamov OR m.horaalta <> m.horamodi) ";
	}

	instruccion = "SELECT cancelado, referencia, concepto, tipomov, nombre, present, fechaalta, horaalta, fechamodi, \
		 horamodi, SUM(totunidades) AS totunidades, IF(TRUNCATE(SUM(subtot),9)=0, '', TRUNCATE(SUM(subtot),9)) AS subtot, \
		 IF(TRUNCATE(SUM(tot),9)=0,'', TRUNCATE(SUM(tot),9)) AS tot FROM ( ";
	instruccion +=
		"SELECT v.cancelado, v.referencia,'' AS concepto, 'VENTA' as tipomov, p.nombre, a.present, ";
	instruccion +=
		"DATE_FORMAT(v.fechaalta,'%d/%m/%Y') AS fechaalta, v.horaalta, ";
	instruccion +=
		"DATE_FORMAT(v.fechamodi,'%d/%m/%Y') AS fechamodi, v.horamodi, ";
	instruccion += "(dv.cantidad * a.factor ) AS totunidades, ";
	instruccion += "(dv.precio * dv.cantidad) AS subtot, ";
	instruccion += "(dv.precioimp * dv.cantidad) AS tot ";
	instruccion += "FROM ventas v ";
	instruccion += "INNER JOIN dventas dv ON dv.referencia=v.referencia ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dv.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion += "INNER JOIN terminales t ON v.terminal = t.terminal ";
	instruccion += "INNER JOIN secciones s ON t.seccion = s.seccion ";
	instruccion += "WHERE v.fechamodi >= '" + mFg.StrToMySqlDate
		(fechaini) + "' ";
	instruccion += "AND v.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto='" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND dv.almacen = '" + almacen + "' ";
	instruccion += condicion_canc;
	instruccion += condicion_movmod;
	if (almacen != "")
		instruccion += " GROUP BY v.referencia ";

	instruccion += "UNION ALL ";
	// Notas de credito clientes
	instruccion +=
		"SELECT n.cancelado, n.referencia, n.venta AS concepto,'NOTA DE CRED. CLIENTES' as tipomov,p.nombre, a.present, ";
	instruccion +=
		"DATE_FORMAT(n.fechaalta,'%d/%m/%Y') AS fechaalta, n.horaalta, ";
	instruccion +=
		"DATE_FORMAT( n.fechamodi,'%d/%m/%Y') AS fechamodi, n.horamodi, ";
	instruccion += "(dn.cantidad * a.factor ) AS totunidades, ";
	instruccion += "(dn.precio * dn.cantidad) AS subtot,  ";
	instruccion += "(dn.precioimp * dn.cantidad) AS tot  ";
	instruccion += "FROM notascredcli n ";
	instruccion += "INNER JOIN dnotascredcli dn ON dn.referencia=n.referencia ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dn.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion +=
		"INNER JOIN dventas dv ON n.venta = dv.referencia AND dv.articulo = a.articulo ";
	instruccion += "INNER JOIN almacenes al ON al.almacen = dv.almacen ";
	instruccion += "INNER JOIN secciones s ON al.seccion = s.seccion ";
	instruccion += "WHERE n.fechamodi >= '" + mFg.StrToMySqlDate
		(fechaini) + "' ";
	instruccion += "AND n.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto= '" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND  dv.almacen = '" + almacen + "' ";
	instruccion += condicion_cancnot;
	instruccion += condicion_movmodnot;
	if (almacen != "")
		instruccion += " GROUP BY n.referencia ";

	instruccion += "UNION ALL ";
	// Notas de credito proveedores
	instruccion +=
		"SELECT n.cancelado, n.referencia, n.compra AS concepto, 'NOTA DE CREDITO PROV.' as tipomov, p.nombre, a.present, ";
	instruccion +=
		" DATE_FORMAT(n.fechaalta,'%d/%m/%Y') AS fechaalta, n.horaalta, ";
	instruccion +=
		"DATE_FORMAT(n.fechamodi,'%d/%m/%Y') AS fechamodi, n.horamodi, ";
	instruccion += "(dn.cantidad * a.factor ) AS totunidades, ";
	instruccion += "(dn.costo * dn.cantidad) AS subtot, ";
	instruccion += "(dn.costoimp * dn.cantidad) AS tot ";
	instruccion += "FROM notascredprov n ";
	instruccion +=
		"INNER JOIN dnotascredprov dn ON dn.referencia=n.referencia ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dn.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion += "INNER JOIN compras c ON n.compra = c.referencia ";
	instruccion += "INNER JOIN almacenes al ON al.almacen = c.almacen ";
	instruccion += "INNER JOIN secciones s ON al.seccion = s.seccion ";
	instruccion += "WHERE n.fechamodi >= '" + mFg.StrToMySqlDate
		(fechaini) + "' ";
	instruccion += "AND n.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto='" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND  c.almacen = '" + almacen + "' ";
	instruccion += condicion_cancnot;
	instruccion += condicion_movmodnot;

	instruccion += "UNION ALL ";
	// Compras
	instruccion +=
		"SELECT c.cancelado, c.referencia, '' AS concepto,'COMPRA' as tipomov, p.nombre, a.present, ";
	instruccion +=
		"DATE_FORMAT( c.fechaalta,'%d/%m/%Y') AS fechaalta, c.horaalta, ";
	instruccion +=
		"DATE_FORMAT(c.fechamodi,'%d/%m/%Y') AS fechamodi, c.horamodi, ";
	instruccion += "(dc.cantidad * a.factor ) AS totunidades, ";
	instruccion += "(dc.costo * dc.cantidad) AS subtot, ";
	instruccion += "(dc.costoimp * dc.cantidad) AS tot ";
	instruccion += "FROM compras c ";
	instruccion += "INNER JOIN dcompras dc ON dc.referencia=c.referencia ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dc.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion += "INNER JOIN terminales t ON c.terminal = t.terminal ";
	instruccion += "INNER JOIN secciones s ON t.seccion = s.seccion ";
	instruccion += "WHERE c.fechamodi >= '" + mFg.StrToMySqlDate
		(fechaini) + "' ";
	instruccion += "AND c.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto='" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND c.almacen = '" + almacen + "'  ";
	instruccion += condicion_canccomp;
	instruccion += condicion_movmodcomp;

	instruccion += "UNION ALL ";
	// entradas
	instruccion +=
		"SELECT m.cancelado, m.movimiento AS referencia, m.tipo AS concepto, 'ENTRADA' as tipomov, p.nombre, a.present, ";
	instruccion +=
		"DATE_FORMAT(m.fechaalta,'%d/%m/%Y') AS fechaalta, m.horaalta, ";
	instruccion +=
		"DATE_FORMAT(m.fechamodi,'%d/%m/%Y') AS fechamodi, m.horamodi, ";
	instruccion += "(dm.cantidad * a.factor ) AS totunidades, ";
	instruccion += "'' AS subtot, ";
	instruccion += "'' AS tot ";
	instruccion += "FROM movalma m ";
	instruccion += "INNER JOIN dmovalma dm ON dm.movimiento=m.movimiento ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dm.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion += "INNER JOIN almacenes al ON m.almaent = al.almacen ";
	instruccion += "INNER JOIN secciones s ON al.seccion = s.seccion ";
	instruccion += "WHERE m.aplica='1' AND m.tipo <> 'S' AND m.fechamodi >= '" +
		mFg.StrToMySqlDate(fechaini) + "' ";
	instruccion += "AND m.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto= '" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND m.almaent = '" + almacen + "'  ";
	instruccion += condicion_cancmov;
	instruccion += condicion_movmodmov;

	instruccion += "UNION ALL ";
	// salidas
	instruccion +=
		"SELECT m.cancelado, m.movimiento AS referencia, m.tipo AS concepto, 'SALIDA' as tipomov, p.nombre, a.present, ";
	instruccion +=
		"DATE_FORMAT(m.fechaalta,'%d/%m/%Y') AS fechaalta, m.horaalta, ";
	instruccion +=
		"DATE_FORMAT(m.fechamodi,'%d/%m/%Y') AS fechamodi, m.horamodi, ";
	instruccion += "(dm.cantidad * a.factor ) AS totunidades, ";
	instruccion += "'' AS subtot, ";
	instruccion += "'' AS tot ";
	instruccion += "FROM movalma m ";
	instruccion += "INNER JOIN dmovalma dm ON dm.movimiento=m.movimiento ";
	instruccion += "INNER JOIN articulos a ON a.articulo=dm.articulo ";
	instruccion += "INNER JOIN productos p ON p.producto=a.producto ";
	instruccion += "INNER JOIN almacenes al ON m.almasal = al.almacen ";
	instruccion += "INNER JOIN secciones s ON al.seccion = s.seccion ";
	instruccion += "WHERE m.tipo <> 'E' AND m.fechamodi >= '" +
		mFg.StrToMySqlDate(fechaini) + "' ";
	instruccion += "AND m.fechamodi <= '" + mFg.StrToMySqlDate(fechafin) + "' ";
	instruccion += "AND a.producto= '" + producto + "' AND a.present = '" +
		present + "' ";
	if (sucursal != "")
		instruccion += "AND s.sucursal = '" + sucursal + "' ";
	if (almacen != "")
		instruccion += "AND m.almasal = '" + almacen + "'  ";
	instruccion += condicion_cancmov;
	instruccion += condicion_movmodmov;

	instruccion +=
		" ) AS info GROUP BY referencia, tipomov, nombre, present \
		ORDER BY FIELD (tipomov, 'VENTA', 'NOTA DE CRED. CLIENTES', 'NOTA DE CREDITO PROV.', 'COMPRA', 'ENTRADA', 'SALIDA') ";

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

}

// ----------------------------------------------------------------------------
// ID_ENVIOCONDICION
void ServidorReportes::EjecutaEnvioCorreoCondicionComercial
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString email, email2, bodyMsg, idEnvio, nomPDF, nomAdj;
	AnsiString pdf64, xml64, adj64;
	BufferRespuestas* resp_envio = NULL;

	AnsiString nomremitente, emailcfd, hostsmtp, portsmtp, usersmtp, passsmtp;
	BufferRespuestas* resp_config_cfd = NULL;

	idEnvio = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf
		("SELECT * FROM condicionescorreos con WHERE idemailcondicion='%s' ",
		idEnvio);

	if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
		instruccion.c_str(), resp_envio))
		throw Exception("ERROR AL CONSULTAR!");

	for (int i = 0; i < resp_envio->ObtieneNumRegistros(); i++) {
		resp_envio->IrAlRegistroNumero(i);
		// pdf64 = resp_envio->ObtieneDato("pdf");
		// nomPDF = resp_envio->ObtieneDato("nombrepdf");
		// adj64 = resp_envio->ObtieneDato("adjunto");
		// nomAdj = resp_envio->ObtieneDato("nombreadjunto");
		bodyMsg = resp_envio->ObtieneDato("mensaje");
		email = resp_envio->ObtieneDato("email");
		email2 = resp_envio->ObtieneDato("emailcto");
		// xml64 = resp_envio->ObtieneDato("xmlgenerado");
	}

	// Obtener los streams de los adjuntos
	TMemoryStream *memStreamBMP = NULL, *memStreamXML = NULL,
		*memStreamPDF = NULL;

	/* memStreamXML = new TMemoryStream();
	 TBytes bytes_xml64=DecodeBase64(xml64);
	 memStreamXML->WriteBuffer(&bytes_xml64[0], bytes_xml64.Length);
	 memStreamXML->Seek(0, soFromBeginning);

	 memStreamPDF = new TMemoryStream();
	 TBytes bytes_pdf64=DecodeBase64(pdf64);
	 memStreamPDF->WriteBuffer(&bytes_pdf64[0], bytes_pdf64.Length);
	 memStreamPDF->Seek(0, soFromBeginning);

	 memStreamBMP = new TMemoryStream();
	 TBytes bytes_adj64=DecodeBase64(adj64);
	 memStreamBMP->WriteBuffer(&bytes_adj64[0], bytes_adj64.Length);
	 memStreamBMP->Seek(0, soFromBeginning); */

	// Se envia el CFD al correo del cliente
	TIdMessage *msg = NULL;
	TIdSMTP *smtp = NULL;
	TIdAttachmentMemory *attach_logo = NULL;
	TIdAttachmentMemory *attach_xml = NULL;
	TIdAttachmentMemory *attach_pdf = NULL;
	TIdText *idtext = NULL;
	TIdSSLIOHandlerSocketOpenSSL *IdSSLIOHandlerSocketOpenSSL1 = NULL;

#ifdef _DEBUG
	TIdLogFile *IdLogFile1 = NULL;
#endif

	try {

		try {

			// Consulta de parametroscfd
			instruccion.sprintf
				("select p.* from parametroscfd p where p.sucursal='%s'",
				FormServidor->ObtieneClaveSucursal());
			if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_config_cfd))
				throw Exception("ERROR AL CONSULTAR!");
			for (int y = 0; y < resp_config_cfd->ObtieneNumRegistros(); y++) {
				emailcfd = resp_config_cfd->ObtieneDato("emailenviocfd");
				nomremitente = resp_config_cfd->ObtieneDato("nomenviocfd");
				hostsmtp = resp_config_cfd->ObtieneDato("hostsmtp");
				portsmtp = resp_config_cfd->ObtieneDato("portsmtp");
				usersmtp = resp_config_cfd->ObtieneDato("usersmtp");
				passsmtp = resp_config_cfd->ObtieneDato("passsmtp");
			}

			// Configuracion del componente TIdSMTP
			smtp = new TIdSMTP(NULL);
			smtp->MailAgent = "Indy10";
			smtp->PipeLine = false;
			smtp->UseEhlo = true;
			smtp->UseVerp = false;

			if (hostsmtp.Pos("amazon") > 0) {

				IdSSLIOHandlerSocketOpenSSL1 =
					new TIdSSLIOHandlerSocketOpenSSL(NULL);
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Method =
					Idsslopenssl::sslvSSLv23;
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Mode =
					Idsslopenssl::sslmClient;
				smtp->IOHandler = IdSSLIOHandlerSocketOpenSSL1;
				smtp->UseTLS = utUseExplicitTLS;

			}
			else {

				smtp->UseTLS = utNoTLSSupport;

			}

			smtp->ConnectTimeout = (1000 * 30);
			smtp->ReadTimeout = (1000 * 60);

			smtp->AuthType = satDefault;
			smtp->Host = hostsmtp;
			smtp->Username = usersmtp;
			smtp->Password = passsmtp;
			smtp->Port = portsmtp.ToInt();

			// Configuracion del componente TIdMessage
			msg = new TIdMessage(NULL);
			msg->ExceptionOnBlockedAttachments = false;
			msg->NoDecode = false;
			msg->NoEncode = false;
			msg->UseNowForDate = true;

			// Configuracion del componente TIdLogFile
#ifdef _DEBUG
			IdLogFile1 = new TIdLogFile(NULL);
			IdLogFile1->Filename = ExtractFilePath(Application->ExeName) +
				"\\maillogfile.log";
			IdLogFile1->Active = true;
			IdLogFile1->LogTime = false;
			IdLogFile1->ReplaceCRLF = true;
			smtp->Intercept = IdLogFile1;
#endif

			// ENVIO DEL CFD
			msg->Clear();
			msg->MessageParts->Clear();

			msg->From->Address = emailcfd;
			msg->From->Name = nomremitente;
			msg->Sender->Address = emailcfd;
			msg->Sender->Name = nomremitente;
			msg->ReplyTo->EMailAddresses = emailcfd;
			msg->Recipients->EMailAddresses = email;
			if (email2 != "" && email2 != "@" && mFg.ValidaEmail(email2,
				false) && email2 != email)
				msg->CCList->EMailAddresses = email2;
			msg->Priority = mpNormal;
			msg->Subject = "Entrega de su Condición Comercial con La Violeta";
			msg->ContentType = "multipart/mixed";
			msg->ClearBody();
			msg->IsEncoded = true;
			msg->AttachmentEncoding = "MIME";
			msg->Encoding = meMIME;
			msg->ConvertPreamble = true;
			msg->CharSet = "UTF-8";

			idtext = new TIdText(msg->MessageParts, NULL);
			idtext->ContentType = "text/html";
			idtext->ContentDescription = "multipart-1";
			idtext->CharSet = "UTF-8";
			idtext->ContentTransfer = "8bit";
			idtext->Body->Clear();
			idtext->Body->Add(UTF8String(bodyMsg));

			/* attach_logo = new TIdAttachmentMemory(msg->MessageParts, memStreamBMP);
			 attach_logo->FileName = nomAdj;
			 attach_logo->ContentType = "image/jpeg";
			 attach_logo->ContentDisposition = "inline";
			 attach_logo->ExtraHeaders->Add("Content-ID:<violeta.jpg>"); */

			/* attach_pdf = new TIdAttachmentMemory(msg->MessageParts, memStreamPDF);
			 attach_pdf->FileName = nomPDF+".pdf";
			 attach_pdf->ContentType = "application/pdf";
			 attach_pdf->ContentDisposition = "attachment";

			 attach_xml = new TIdAttachmentMemory(msg->MessageParts, memStreamXML);
			 attach_xml->FileName = nomPDF+".xml";
			 attach_xml->ContentType = "text/xml";
			 attach_xml->ContentDisposition = "attachment"; */

			smtp->Connect();
			smtp->Authenticate();
			smtp->Send(msg);
			smtp->Disconnect();

			AnsiString sqlinstruccion;
			sqlinstruccion.sprintf
				("update condicionescorreos set enviado=1, fechahoraenv='%s %s' where idemailcondicion='%s'",
				mFg.DateToMySqlDate(Now()), mFg.TimeToMySqlTime(Now()),
				idEnvio);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				sqlinstruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

		}
		catch (Exception &e) {
			mServidorVioleta->MuestraMensajeError
				("ERROR al enviar correo: " + e.Message);
			throw Exception("ERROR AL ENVIAR CORREO!" + e.Message);
		}

	}
	__finally {
#ifdef _DEBUG
		if (IdLogFile1 != NULL) {
			IdLogFile1->Close();
			delete IdLogFile1;
		}
#endif

		if (smtp != NULL)
			delete smtp;
		if (idtext != NULL)
			delete idtext;
		if (msg != NULL)
			delete msg;

		if (IdSSLIOHandlerSocketOpenSSL1 != NULL)
			delete IdSSLIOHandlerSocketOpenSSL1;
		if (resp_envio != NULL)
			delete resp_envio;
		if (resp_config_cfd != NULL)
			delete resp_config_cfd;
		if (memStreamXML != NULL)
			delete memStreamXML;
		if (memStreamPDF != NULL)
			delete memStreamPDF;
		if (memStreamBMP != NULL)
			delete memStreamBMP;

	}

}

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// ID_REP_ART_COINCIDENCIAS
void ServidorReportes::EjecutaRepArticulosCoincidencias
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fecha_inicial, fecha_final, sucursal, producto, excluircliente;
	AnsiString clasificacion1, clasificacion2, clasificacion3, ordenar;
	AnsiString condicion_ordenar;

	AnsiString condicion_sucursal = " ";
	AnsiString join_sucursales = " ";
	AnsiString condicion_producto = " ";
	AnsiString condicion_clasif1 = " ";
	AnsiString condicion_clasif2 = " ";
	AnsiString condicion_clasif3 = " ";
	AnsiString inner_cliente = " ";
	AnsiString condicion_cliente = " ";
	AnsiString archivo_temp1;
	int num_instrucciones = 0;
	AnsiString instrucciones[1000];
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		clasificacion1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasificacion2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasificacion3 = mFg.ExtraeStringDeBuffer(&parametros);
		ordenar = mFg.ExtraeStringDeBuffer(&parametros);
		excluircliente = mFg.ExtraeStringDeBuffer(&parametros);

		if (ordenar == "NOMBRE") {
			condicion_ordenar =
				"ORDER BY nombre1, present1, multiplo1, coincidencias DESC";
		}
		if (ordenar == "COINCIDENCIA") {
			condicion_ordenar =
				"ORDER BY coincidencias DESC, nombre1, present1, multiplo1";
		}

		if (sucursal != "") {
			condicion_sucursal.sprintf(" AND s1.sucursal = '%s' ", sucursal);
			join_sucursales =
				" INNER JOIN terminales t1 ON t1.terminal = v.terminal \
								INNER JOIN secciones s1 ON s1.seccion = t1.seccion ";
		}

		if (producto != "") {
			condicion_producto.sprintf(" AND p.producto = '%s' ", producto);
		}

		if (clasificacion1 != "") {
			condicion_clasif1.sprintf(" AND p.clasif1 = '%s' ", clasificacion1);
		}

		if (clasificacion2 != "") {
			condicion_clasif2.sprintf(" AND p.clasif2 = '%s' ", clasificacion2);
		}

		if (clasificacion3 != "") {
			condicion_clasif3.sprintf(" AND p.clasif3 = '%s' ", clasificacion3);
		}
		// si esta palomeado==1, entonces no mostrar(excluir) los clientes relacionales
		if (excluircliente == "1") {
			inner_cliente =
				"INNER JOIN clientes c1 ON c1.cliente = v.cliente AND c1.esparterelac=0";
		}
		else {
			inner_cliente = " ";
		}
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		// Obtiene parámetro para ver un minimo de coincidencias
		instruccion.sprintf(
			"SELECT @maxcan:=valor FROM parametrosemp WHERE parametro = 'MAXCANA' AND sucursal = '%s' ", FormServidor->ObtieneClaveSucursal());
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán la información resumida de los detalles de ventas.
		instruccion =
			"CREATE TEMPORARY TABLE dventasresumida (referencia VARCHAR(11) \
				,articulo VARCHAR(11), nombre VARCHAR(60), presentacion VARCHAR(255), \
				multiplo varchar(10), INDEX(referencia, articulo), INDEX(articulo)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Se procesa la información antes para ahorrar tiempo y recursos.
		instruccion.sprintf("SELECT v.referencia,dv.articulo,p.nombre,a.present, a.multiplo \
				FROM ventas v   \
				%s	\
				%s	\
				INNER JOIN dventas dv ON  dv.referencia = v.referencia  \
				INNER JOIN articulos a ON a.articulo = dv.articulo \
				INNER JOIN productos p ON p.producto = a.producto   \
				WHERE v.fechavta BETWEEN '%s' AND '%s'  \
				%s %s %s %s %s \
				AND v.cancelado=0 INTO OUTFILE '%s'", inner_cliente,
			join_sucursales, fecha_inicial, fecha_final, condicion_producto,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_sucursal, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE dventasresumida (referencia, articulo, nombre, \
				presentacion,multiplo)", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (int i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);

			// Resultado final
			instruccion.sprintf("SELECT COUNT(*)/2 AS coincidencias,	\
					dv1.articulo AS articulo1, dv1.nombre AS nombre1,   \
					dv1.presentacion AS present1, dv1.multiplo AS multiplo1,    \
					dv2.articulo AS articulo2, dv2.nombre AS nombre2,   \
					dv2.presentacion AS present2, dv2.multiplo AS multiplo2,    \
					IF (dv1.articulo<dv2.articulo, dv1.articulo, dv2.articulo) AS articulomin,  \
					IF (dv1.articulo>dv2.articulo, dv1.articulo, dv2.articulo) AS articulomax   \
					FROM  dventasresumida dv1   \
					INNER JOIN dventasresumida dv2 ON dv1.referencia=dv2.referencia \
					AND dv1.articulo<>dv2.articulo  \
					GROUP BY articulomin, articulomax   \
					HAVING coincidencias>=@maxcan   \
					%s ", condicion_ordenar);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPEXISTENCIAS_SUCURSAL
void ServidorReportes::EjecutaRepExistenciasSucursal
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	bool fil_prov_sup = false;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo, considerar_cortes;
	AnsiString fecha;
	AnsiString almacen, marca, producto;
	AnsiString clasif1, clasif2, clasif3, obtener_articulos_inactivos;
	AnsiString condicion_almacen = " ", condicion_marca = " ",
		condicion_producto = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ", condicion_articulos_inactivos = " ";
	AnsiString join_productos = " ";
	AnsiString calculo_promedio_ventas;
	AnsiString forzar_indice_vta = " ";
	AnsiString sucursal;
	AnsiString cad_conjunto_almacenes = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5, archivo_temp6;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursales = NULL;
	int costoscompra;
	int exixtenciascero = 0;
	AnsiString camposcostoscompra = " ", leftcostoscompra = " ";
	AnsiString condicion_sucursal, condicion_producto_ventasmes = " ";
	AnsiString condicion_clasif1_ventasmes = " ", condicion_clasif2_ventasmes =
		" ", condicion_clasif3_ventasmes = " ";
	AnsiString condicion_devventas = " ";
	TDate fecha_hoy = Today();
	int mes_actual = MonthOf(fecha_hoy);
	int mes_corresp = mes_actual + 24; // Mes actual
	int mes_ant = (mes_actual + 24) - 1; // Mes anterior
	int mes_penant = (mes_actual + 24) - 2; // Mes penultimo anterior
	AnsiString cad_mes_corresp = mFg.IntToAnsiString(mes_corresp);
	AnsiString cad_mes_ant = mFg.IntToAnsiString(mes_ant);
	AnsiString cad_mes_penant = mFg.IntToAnsiString(mes_penant);

	AnsiString listaTags, fabricante, segmento, proveedor_principal, supervisor;
	AnsiString condicion_art_tags = " ", condicion_art_tags2 = " ",
		condicion_art_tags3 = " ";
	AnsiString join_art_tags = " ", join_art_tags2 = " ", join_art_tags3 = " ",
		join_auxprovprincprod = " ";
	AnsiString condicion_fabricante = " ", condicion_segmento = " ",
		condicion_prov_princ = " ", condicion_supervisor = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString idEmpresa;
	AnsiString condicion_empresa=" ";

	try {
		fecha = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa una sucursal entonces el almacen debe ser " "
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		// Si se pasa un almacen entonces la sucursal debe ser " "
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		obtener_articulos_inactivos = mFg.ExtraeStringDeBuffer(&parametros);
		considerar_cortes = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		listaTags = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor_principal = mFg.ExtraeStringDeBuffer(&parametros);
		supervisor = mFg.ExtraeStringDeBuffer(&parametros);
		idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);

		if(idEmpresa != " "){
			condicion_empresa.sprintf(" AND suc.idempresa = %s ", idEmpresa);
		}
		// Obtiene los almacenes que corresponden a una sucursal
		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++) {
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" WHERE s.sucursal='%s' ", sucursal);
		}
		else {
			AnsiString cadena_sucursal = "";
			instruccion = "SELECT sucursal FROM sucursales";
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_sucursales);
			for (i = 0; i < resp_sucursales->ObtieneNumRegistros(); i++) {

				resp_sucursales->IrAlRegistroNumero(i);

				if (i != resp_sucursales->ObtieneNumRegistros() - 1)
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "',";
				else
					cadena_sucursal = cadena_sucursal + "'" +
						resp_sucursales->ObtieneDato("sucursal") + "'";

			}

			condicion_sucursal.sprintf(" WHERE s.sucursal IN(%s) ",
				cadena_sucursal);
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf("prod.clasif1='%s' and ", clasif1);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif1_ventasmes.sprintf(" AND prod.clasif1='%s' ",
				clasif1);
		}
		if (clasif2 != " ") {
			condicion_clasif2.sprintf("prod.clasif2='%s' and ", clasif2);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif2_ventasmes.sprintf(" AND prod.clasif2='%s' ",
				clasif2);
		}
		if (clasif3 != " ") {
			condicion_clasif3.sprintf("prod.clasif3='%s' and ", clasif3);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_clasif3_ventasmes.sprintf(" AND prod.clasif3='%s' ",
				clasif3);
		}
		if (marca != " ") {
			condicion_marca.sprintf(" AND prod.marca='%s'  ", marca);
		}

		if (producto != " ") {
			condicion_producto.sprintf("prod.producto='%s' and ", producto);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
			condicion_producto_ventasmes.sprintf(" AND prod.producto='%s' ",
				producto);
		}
		if (obtener_articulos_inactivos == "0") {
			condicion_articulos_inactivos = " and a.activo=1 ";
		}

		if (listaTags != " ") {

			join_art_tags.sprintf(" , articulostagsasignados artt ");
			condicion_art_tags.sprintf
				(" AND artt.producto=a.producto AND artt.present=a.present AND artt.idarticulotag in (%s) ",
				listaTags);

			join_art_tags2.sprintf(" , articulostagsasignados artt ");
			condicion_art_tags2.sprintf
				(" AND artt.producto=pce.producto AND artt.present=pce.present AND artt.idarticulotag in (%s) ",
				listaTags);

			join_art_tags3.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags3.sprintf("  AND artt.idarticulotag in (%s) ",
				listaTags);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND prod.fabricante='%s' ",
				fabricante);
			join_productos =
				" inner join productos prod on a.producto=prod.producto ";
		}

		// Usaremos el segmento de presentacioncb
		if (segmento != " ") {
			condicion_segmento.sprintf("AND pcb.segmento='%s' ", segmento);
			join_presentacion1 =
				" INNER JOIN presentacionescb pcb ON pcb.producto=a.producto AND pcb.present = a.present AND pcb.idempresa = "+idEmpresa;

			join_presentacion2 =
				" INNER JOIN presentacionescb pcb ON pcb.producto=pce.producto AND pcb.present = pce.present AND pcb.idempresa = "+idEmpresa;

            join_productos =
				" INNER JOIN productos prod on a.producto=prod.producto ";
		}

		if (proveedor_principal != " ") {
			condicion_prov_princ.sprintf(" AND ap.proveedor = '%s' ",
				proveedor_principal);
			join_auxprovprincprod =
				" INNER JOIN auxprovprincprod pp ON pp.producto=e.producto AND pp.present=e.present ";
			fil_prov_sup = true;
		}

		if (supervisor != " ") {
			condicion_supervisor.sprintf(" AND asp.usuario = '%s' ",
			supervisor);
			join_auxprovprincprod =
				" INNER JOIN auxprovprincprod pp ON pp.producto=e.producto AND pp.present=e.present ";
			fil_prov_sup = true;
		}

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal='%s'", fecha);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene fecha del corte más próximo previo a la fecha dada
		if (considerar_cortes == "1") {
			forzar_indice_vta = " force index(fechavta) ";
			instruccion.sprintf("select @fechacorte:=ifnull(max(p.fecha),'1900-01-01') as fcorte \
				 from puntoscorte p where p.fecha<='%s'", fecha);
		}
		else {
			instruccion.sprintf("set @fechacorte='1900-01-01'");
		}
		instrucciones[num_instrucciones++] = instruccion;

		// Sección de optimización
		if (producto != " " || clasif3 != " " || clasif2 != " ") {
			// Si probablemente pueda servirnos más los indices de productos,
			// entonces evitamos forzar el indice de ventas, y dejamos que mysql decida.
			forzar_indice_vta = " ";
		}

		// Crea una tabla donde se pondrán las existencias que se vayan encontrando.
		instruccion = "create temporary table existenciasaux ( \
			almacen varchar (4), producto varchar(8), present varchar(255), \
			tipo varchar(2), cantidad decimal(12,3),  \
			INDEX(almacen, producto, present)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias sumadas
		instruccion = "create temporary table auxexistsumadas ( \
			almacen varchar (4), producto varchar(8),   \
			present varchar(255), cantidad decimal(12,3), \
			INDEX(almacen, producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde se pondrán las existencias finales
		instruccion = "create temporary table auxexistfinales ( \
			almacen varchar (4), producto varchar(8),         \
			present varchar(255), cantidad decimal(12,3),      \
			maxfactor decimal(10,3), multmax varchar(10), \
			minfactor decimal(10,3), multmin varchar(10), \
			INDEX(almacen, producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla donde de copia para las existencias finales
		instruccion = "create temporary table auxexistfinalessuc ( \
			sucursal varchar (4), producto varchar(8),         \
			present varchar(255), cantidad decimal(12,3),      \
			maxfactor decimal(10,3), multmax varchar(10), \
			minfactor decimal(10,3), multmin varchar(10), \
			INDEX(sucursal, producto, present)) Engine = InnoDB;";
		instrucciones[num_instrucciones++] = instruccion;

		if (fil_prov_sup) {
			// Crear una tabla donde se dejarán los productos filtrados por proveedor y/o supervisor
			instruccion =
				"create temporary table auxprovprincprod ( \
			producto varchar(8), present varchar(255), INDEX(producto, present)) Engine = InnoDB;";
			instrucciones[num_instrucciones++] = instruccion;
		}

		// Calcula base (0) de los artículos en cuestión.
		// La utilidad de esto es simplemente para tomar en cuenta todos los articulos aunque no
		// tengan ningun movimiento
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" al.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		instruccion.sprintf("insert into existenciasaux (almacen, producto, present, tipo, cantidad) \
			select al.almacen, a.producto, a.present, 'BA' as tipo, \
			0 as cantidad \
			from articulos a %s, productos prod, almacenes al \
			%s \
			where %s %s %s %s %s \
			a.producto=prod.producto %s %s %s \
			group by a.producto, a.present, al.almacen", join_presentacion1,
			join_art_tags, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_art_tags, condicion_fabricante, condicion_segmento);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula la existencia al momento del corte previo.
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" pce.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		instruccion.sprintf("insert into existenciasaux (almacen, producto, present, tipo, cantidad) \
			select pce.almacen, pce.producto, pce.present, 'IN' as tipo, \
			sum(pce.cantidad) as cantidad \
			from puntoscorteexistencias pce %s, productos prod \
			%s \
			where %s %s %s %s %s \
			pce.fecha=@fechacorte and pce.producto=prod.producto %s %s %s \
			group by pce.producto, pce.present, pce.almacen",
			join_presentacion2, join_art_tags2, condicion_almacen,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_art_tags2, condicion_fabricante,
			condicion_segmento);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select c.almacen, a.producto, a.present, 'CO' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from compras c \
			inner join dcompras d on c.referencia=d.referencia \
			inner join articulos a on d.articulo=a.articulo \
			%s %s %s \
			where %s %s %s %s %s \
			c.fechacom>@fechacorte and c.fechacom<=@fechafinal and c.cancelado=0 %s %s %s \
			group by a.producto, a.present, c.almacen INTO OUTFILE '%s'",
			join_presentacion1, join_productos, join_art_tags3,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_art_tags3,
			condicion_fabricante, condicion_segmento, archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (almacen, producto, present, tipo, cantidad) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las compras
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" c.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		instruccion.sprintf("insert into existenciasaux (almacen, producto, present, tipo, cantidad) \
			select c.almacen, a.producto, a.present, 'DC' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from notascredprov n, compras c, dnotascredprov d, articulos a %s, productos prod \
			%s \
			where  %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' \
			and n.referencia=d.referencia and n.compra=c.referencia and \
			n.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s %s %s \
			group by a.producto, a.present, c.almacen", join_presentacion1,
			join_art_tags, condicion_almacen, condicion_clasif1,
			condicion_clasif2, condicion_clasif3, condicion_producto,
			condicion_art_tags, condicion_fabricante, condicion_segmento);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las ventas.
		AnsiString cadena_join_ventasxmes = " ";
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" d.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("select d.almacen, a.producto, a.present, 'VE' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from ventas v %s \
			inner join dventas d  on v.referencia=d.referencia \
			inner join articulos a on d.articulo=a.articulo \
			%s %s %s %s \
			where %s %s %s %s %s \
			v.fechavta>@fechacorte and v.fechavta<=@fechafinal and v.cancelado=0 %s %s %s \
			group by a.producto, a.present, d.almacen INTO OUTFILE '%s'",
			forzar_indice_vta, join_presentacion1, join_productos,
			cadena_join_ventasxmes, join_art_tags3, condicion_almacen,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_art_tags3, condicion_fabricante,
			condicion_segmento, archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las devoluciones a las ventas
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" dv.almacen in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf(" \
			select dv.almacen, a.producto, a.present, 'DV' as tipo, sum(dn.cantidad*a.factor) as cantidad \
			from notascredcli n \
			inner join dnotascredcli dn on n.referencia=dn.referencia \
			inner join ventas v on n.venta=v.referencia \
			inner join dventas dv on v.referencia=dv.referencia and dv.articulo=dn.articulo \
			inner join articulos a on dn.articulo=a.articulo \
			%s %s %s \
			where %s %s %s %s %s \
			n.fechanot>@fechacorte and n.fechanot<=@fechafinal and n.tipo='0' and n.cancelado=0 %s %s %s \
			group by a.producto, a.present, dv.almacen INTO OUTFILE '%s'",
			join_presentacion1, join_productos, join_art_tags3,
			condicion_almacen, condicion_clasif1, condicion_clasif2,
			condicion_clasif3, condicion_producto, condicion_art_tags3,
			condicion_fabricante, condicion_segmento, archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE existenciasaux ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las entradas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almaent in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select m.almaent, a.producto, a.present, 'EN' as tipo, sum(d.cantidad*a.factor) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod \
			%s \
			where %s %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'S' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s %s %s \
			group by a.producto, a.present, m.almaent INTO OUTFILE '%s'",
			join_presentacion1, join_art_tags, condicion_almacen,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_art_tags, condicion_fabricante,
			condicion_segmento, archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (almacen, producto, present, tipo, cantidad) ",
			archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		// Calcula las salidas de almacén
		if (cad_conjunto_almacenes != " ") {
			condicion_almacen.sprintf(" m.almasal in (%s) and ",
				cad_conjunto_almacenes);
		}
		else
			condicion_almacen = " ";
		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" \
			select m.almasal, a.producto, a.present, 'SA' as tipo, (sum(d.cantidad*a.factor)*-1) as cantidad \
			from movalma m, dmovalma d, articulos a %s, productos prod \
			%s \
			where %s %s %s %s %s \
			m.fechamov>@fechacorte and m.fechamov<=@fechafinal and m.movimiento=d.movimiento \
			and m.tipo<>'E' \
			AND m.aplica=1 and m.cancelado=0 and d.articulo=a.articulo and a.producto=prod.producto %s %s %s \
			group by a.producto, a.present, m.almasal INTO OUTFILE '%s'",
			join_presentacion1, join_art_tags, condicion_almacen,
			condicion_clasif1, condicion_clasif2, condicion_clasif3,
			condicion_producto, condicion_art_tags, condicion_fabricante,
			condicion_segmento, archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE existenciasaux (almacen, producto, present, tipo, cantidad) ",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma los movimientos para obtener las existencias
		instruccion = "insert into auxexistsumadas (almacen, producto, present, cantidad) \
				select e.almacen, e.producto, e.present, sum(e.cantidad) as cantidad \
				from existenciasaux e \
				group by e.producto, e.present, e.almacen";
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los factores minimo y máximo
		instruccion.sprintf("insert into auxexistfinales (almacen, producto, present, cantidad, maxfactor, minfactor) \
			select e.almacen, a.producto, a.present, e.cantidad, max(a.factor) as maxfactor, min(a.factor) as minfactor \
			from auxexistsumadas e, articulos a \
			where e.producto=a.producto and e.present=a.present %s \
			group by e.producto, e.present, e.almacen",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos maximos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmax=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.maxfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		// Obtiene los múltiplos minimos
		instruccion.sprintf("update auxexistfinales e, articulos a \
			set e.multmin=a.multiplo where e.producto=a.producto and \
			e.present=a.present and e.minfactor=a.factor %s ",
			condicion_articulos_inactivos);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into auxexistfinalessuc select sec.sucursal, ae.producto, ae.present, sum(ae.cantidad), \
			ae.maxfactor, ae.multmax, ae.minfactor, ae.multmin from auxexistfinales ae inner join almacenes al \
			ON al.almacen = ae.almacen INNER JOIN secciones sec ON sec.seccion = al.seccion  \
			group by ae.producto, ae.present, sec.sucursal ");
		instrucciones[num_instrucciones++] = instruccion;

		if (fil_prov_sup) {
			// Filtra productos de acuerdo con el proveedor principal y/o supervisor
			archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp
				(num_instrucciones, Respuesta->Id);
			instruccion.sprintf("SELECT  ef.producto, ef.present \
				FROM auxexistfinalessuc ef \
				LEFT JOIN articulosped ap ON ap.producto = ef.producto AND ap.present = ef.present AND ap.sucursal = ef.sucursal  \
				LEFT JOIN articulossupervisados asp ON asp.producto = ef.producto AND asp.present = ef.present \
				WHERE 1 %s %s  \
				GROUP BY ef.producto, ef.present INTO OUTFILE '%s' ",
				condicion_supervisor, condicion_prov_princ, archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE auxprovprincprod(producto, present) ",
				archivo_temp6);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
			if (fil_prov_sup)
				mServidorVioleta->BorraArchivoTemp(archivo_temp6);

			// Resultado final
			instruccion.sprintf("select e.sucursal, IF(amin.activo=1,prod.nombre,  \
				CONCAT(prod.nombre ,' (inactivo)') ) as nomproducto, \
				e.producto, e.present, \
				truncate(e.cantidad/e.maxfactor,0) as cantmax, \
				@resto:=mod(e.cantidad, e.maxfactor) as resto, \
				e.multmax, \
				(@resto/e.minfactor) as cantmin, \
				e.multmin, \
				e.cantidad, \
				e.minfactor, \
				e.maxfactor, \
				a.articulo as articulo, \
				present.costobase as costounitario, \
				(present.costobase*e.maxfactor) as costobasexmultmay, \
				amin.activo \
				from auxexistfinalessuc e \
				inner join  productos prod \
				inner join  presentacionescb present \
				INNER JOIN sucursales suc ON suc.sucursal = e.sucursal \
				left join articulos a on e.producto=a.producto and e.present=a.present and e.multmax=a.multiplo  \
				left join articulos amin on e.producto=amin.producto and e.present=amin.present and e.multmin=amin.multiplo  \
				%s \
				where \
				prod.producto=e.producto and e.producto=present.producto and \
				e.present=present.present and present.idempresa=%s %s %s \
				order by nomproducto, e.present, e.sucursal ",
				join_auxprovprincprod, FormServidor->ObtieneClaveEmpresa(), condicion_marca, condicion_empresa);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_REP_CONDICIONCOMERCIAL
void ServidorReportes::EjecutaReporteCondicionComercial
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	//
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	AnsiString terminal, articulo;
	TDate fecha = Today();
	AnsiString fecha_inicio, fecha_fin, activo_can, estado, proveedor, sucursal;
	AnsiString condicion_activo = " ", condicion_estado = " ",
		condicion_proveedor = " ";

	BufferRespuestas* resp_condiciones = NULL;

	try {

		// fecha inicio
		fecha_inicio =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		// fecha fin
		fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		// activo/cancelado
		activo_can = mFg.ExtraeStringDeBuffer(&parametros);
		// estado
		estado = mFg.ExtraeStringDeBuffer(&parametros);
		// proveedor
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		// sucursal
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);

		if (!activo_can.IsEmpty()) {
			condicion_activo.sprintf("and ccp.cancelado=%d ",
				StrToInt(activo_can));
		}
		if (!estado.IsEmpty()) {
			condicion_estado.sprintf("and ccp.cumplido=%d ", StrToInt(estado));
		}

		if (!proveedor.IsEmpty()) {
			condicion_proveedor.sprintf("and p.proveedor='%s' ", proveedor);
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		instruccion.sprintf("SELECT ccp.*, p.razonsocial, CONCAT(em.nombre,' ',em.appat,' ',em.apmat) AS nombre, \
                    IF(ccp.fecha_vigencia < CURDATE(),1, 0)AS vigente\
					FROM condicionescomerprov ccp                        \
					LEFT JOIN proveedores p ON ccp.proveedor=p.proveedor \
					LEFT JOIN empleados em ON ccp.empleado=em.empleado   \
					WHERE fecha_pacto BETWEEN  '%s' AND '%s' %s %s %s     \
					order by ccp.fecha_pacto DESC, idcondicion DESC",
			fecha_inicio, fecha_fin, condicion_activo, condicion_estado,
			condicion_proveedor);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {
		delete resp_condiciones;
	}

}

// ---------------------------------------------------------------------------
// ID_EJE_REPDOCUMENTOSMODIF
void ServidorReportes::EjecutaReporteDocumentosModificados
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString ins01, ins02, ins03, ins04, ins05, ins06, ins07, ins08, ins09;
	AnsiString fechaini, fechafin, fechainiModDoc, fechafinModDoc;

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechainiModDoc = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafinModDoc = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	ins01.sprintf("(                                                                                             \
		SELECT 'COMPRA',com.referencia,CASE com.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,      \
		CONCAT('Dpto. ',com.docdepart),                                                                          \
		em.nombre,                                                                                               \
		com.fechaalta,                                                                                           \
		com.horaalta,                                                                                            \
		com.fechamodi,                                                                                           \
		com.horamodi,                                                                                            \
		com.valor                                                                                                \
		FROM compras   com                                                                                       \
		LEFT JOIN empleados em ON em.empleado=com.usumodi                                                        \
		WHERE (com.fechaalta<>com.fechamodi OR (com.fechaalta = com.fechamodi AND com.horaalta<>com.horamodi))   \
		AND (com.fechaalta >= '%s' AND com.fechaalta <= '%s')                                                    \
		AND (com.fechamodi >= '%s' AND com.fechamodi <= '%s')                                                    \
		ORDER BY com.fechaalta,com.horaalta,com.referencia,com.valor)",
		fechaini, fechafin, fechainiModDoc, fechafinModDoc);

	ins02.sprintf("UNION ALL                                                                                     \
		(                                                                                                        \
		SELECT 'MOV. ALMACÉN',m.movimiento,CASE m.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,    \
		if(m.tipo='T', 'Traspaso', if(m.tipo='E','Entrada','Salida') ) as mvtipo,                                \
		em.nombre,                                                                                               \
		m.fechaalta,                                                                                             \
		m.horaalta,                                                                                              \
		m.fechamodi,                                                                                             \
		m.horamodi,                                                                                              \
		'0'                                                                                                      \
		FROM movalma  m                                                                                          \
		LEFT JOIN empleados em ON em.empleado=usumodi                                                            \
		WHERE (m.fechaalta<>m.fechamodi OR (m.fechaalta = m.fechamodi AND m.horaalta<>m.horamodi))               \
		AND (m.fechaalta >= '%s' AND m.fechaalta <= '%s')                                                        \
		AND (m.fechamodi >= '%s' AND m.fechamodi <= '%s')                                                        \
		ORDER BY m.fechaalta,m.horaalta,m.movimiento,m.concepto)", fechaini,
		fechafin, fechainiModDoc, fechafinModDoc);

	ins03.sprintf("UNION ALL                                                                                     \
		(                                                                                                        \
		SELECT 'NOTA CAR. CLI.',ntc.referencia,' ',                                                              \
		if(ntc.tipo='O','Cargo','Rebote'),                                                                       \
		em.nombre,                                                                                               \
		ntc.fechaalta,                                                                                           \
		ntc.horaalta,                                                                                            \
		ntc.fechamodi,                                                                                           \
		ntc.horamodi,                                                                                            \
		ntc.valor                                                                                                \
		FROM notascarcli   ntc                                                                                   \
		LEFT JOIN empleados em ON em.empleado=ntc.usumodi                                                        \
		WHERE (ntc.fechaalta<>ntc.fechamodi OR (ntc.fechaalta = ntc.fechamodi AND ntc.horaalta<>ntc.horamodi))   \
		AND (ntc.fechaalta >= '%s' AND ntc.fechaalta <= '%s')                                                    \
		AND (ntc.fechamodi >= '%s' AND ntc.fechamodi <= '%s')                                                    \
		ORDER BY ntc.fechaalta,ntc.horaalta,ntc.referencia,ntc.valor)",
		fechaini, fechafin, fechainiModDoc, fechafinModDoc);

	ins04.sprintf("UNION ALL                                                                                         \
		(                                                                                                            \
		SELECT 'NOTA CAR. PROV.',ncp.referencia,CASE ncp.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can, \
		if(ncp.tipo='O','Cargo','Rebote'),                                                                           \
		em.nombre,                                                                                                   \
		ncp.fechaalta,                                                                                               \
		ncp.horaalta,                                                                                                \
		ncp.fechamodi,                                                                                               \
		ncp.horamodi,                                                                                                \
		ncp.valor                                                                                                    \
		FROM notascarprov   ncp                                                                                      \
		LEFT JOIN empleados em ON em.empleado=ncp.usumodi                                                            \
		WHERE (ncp.fechaalta<>ncp.fechamodi OR (ncp.fechaalta = ncp.fechamodi AND ncp.horaalta<>ncp.horamodi))       \
		AND (ncp.fechaalta >= '%s' AND ncp.fechaalta <= '%s')                                                        \
		AND (ncp.fechamodi >= '%s' AND ncp.fechamodi <= '%s')                                                        \
		ORDER BY ncp.fechaalta,ncp.horaalta,ncp.referencia,ncp.valor)",
		fechaini, fechafin, fechainiModDoc, fechafinModDoc);

	ins05.sprintf("UNION ALL                                                                                         \
		(                                                                                                            \
		SELECT 'NOTA CRED. CLI.',ncc.referencia,CASE ncc.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can, \
		CASE ncc.tipo WHEN 0 THEN ('Devo. venta') WHEN 1 THEN ('Desp. venta') WHEN 2 THEN ('Desg. venta') END AS can,\																								  \
		em.nombre,                                                                                                   \
		ncc.fechaalta,                                                                                               \
		ncc.horaalta,                                                                                                \
		ncc.fechamodi,                                                                                               \
		ncc.horamodi,                                                                                                \
		ncc.valor                                                                                                    \
		FROM notascredcli  ncc                                                                                       \
		LEFT JOIN empleados em ON em.empleado=ncc.usumodi                                                            \
		WHERE (ncc.fechaalta<>ncc.fechamodi OR (ncc.fechaalta = ncc.fechamodi AND ncc.horaalta<>ncc.horamodi))       \
		AND (ncc.fechaalta >= '%s' AND ncc.fechaalta <= '%s')                                                        \
		AND (ncc.fechamodi >= '%s' AND ncc.fechamodi <= '%s')                                                        \
		ORDER BY ncc.fechaalta,ncc.horaalta,ncc.referencia,ncc.valor)",
		fechaini, fechafin, fechainiModDoc, fechafinModDoc);

	ins06.sprintf("UNION ALL                                                                                             \
		(                                                                                                                \
		SELECT 'NOTA CRED. PROV.',npp.referencia,CASE npp.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,    \
		CASE npp.tipo WHEN 0 THEN ('Devo. compra') WHEN 1 THEN ('Desp. compra') WHEN 2 THEN ('Desg. compra') END AS dv,  \
		em.nombre,                                                                                                       \
		npp.fechaalta,                                                                                                   \
		npp.horaalta,                                                                                                    \
		npp.fechamodi,                                                                                                   \
		npp.horamodi,                                                                                                    \
		npp.valor                                                                                                        \
		FROM notascredprov      npp                                                                                      \
		LEFT JOIN empleados em ON em.empleado=npp.usumodi                                                                \
		WHERE (npp.fechaalta<>npp.fechamodi OR (npp.fechaalta = npp.fechamodi AND npp.horaalta<>npp.horamodi))           \
		AND (npp.fechaalta >= '%s' AND npp.fechaalta <= '%s')                                                            \
		AND (npp.fechamodi >= '%s' AND npp.fechamodi <= '%s')                                                            \
		ORDER BY npp.fechaalta,npp.horaalta,npp.referencia,npp.valor)",
		fechaini, fechafin, fechainiModDoc, fechafinModDoc);

	ins07.sprintf("UNION ALL                                                                                             \
		(                                                                                                                \
		SELECT 'PAGO CLIENTE',pc.pago,CASE pc.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,                \
		CASE pc.formapag WHEN 'E' THEN ('Efectivo') WHEN 'C' THEN ('Cheque') WHEN 'T' THEN ('Transferencia Bancaria') WHEN 'D' THEN ('Depósito') END AS dv,  \																									 \
		em.nombre,                                                                                                       \
		pc.fecha,                                                                                                        \
		pc.hora,                                                                                                         \
		pc.fechamodi,                                                                                                    \
		pc.horamodi,                                                                                                     \
		pc.valor                                                                                                         \
		FROM pagoscli   pc                                                                                               \
		LEFT JOIN empleados em ON em.empleado=pc.usumodi                                                                 \
		WHERE (pc.fecha<>pc.fechamodi OR (pc.fecha = pc.fechamodi AND pc.hora<>pc.horamodi))                             \
		AND (pc.fecha >= '%s' AND pc.fecha <= '%s')                                                                      \
		AND (pc.fechamodi >= '%s' AND pc.fechamodi <= '%s')                                                              \
		ORDER BY pc.fecha,pc.hora,pc.pago,pc.valor)", fechaini, fechafin,
		fechainiModDoc, fechafinModDoc);

	ins08.sprintf("UNION ALL                                                                                             \
		(                                                                                                                \
		SELECT 'PAGO PROVEEDOR',pp.pago,CASE pp.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,              \
		CASE pp.formapag WHEN 'E' THEN ('Efectivo') WHEN 'C' THEN ('Cheque') WHEN 'T' THEN ('Transferencia Bancaria') WHEN 'D' THEN ('Depósito') END AS dv,  \
		em.nombre,                                                                                                       \
		pp.fecha,                                                                                                        \
		pp.hora,                                                                                                         \
		pp.fechamodi,                                                                                                    \
		pp.horamodi,                                                                                                     \
		pp.valor                                                                                                         \
		FROM pagosprov  pp                                                                                               \
		LEFT JOIN empleados em ON em.empleado=pp.usumodi                                                                 \
		WHERE (pp.fecha<>pp.fechamodi OR (pp.fecha = pp.fechamodi AND pp.hora<>pp.horamodi))                             \
		AND (pp.fecha >= '%s' AND pp.fecha <= '%s')                                                                      \
		AND (pp.fechamodi >= '%s' AND pp.fechamodi <= '%s')                                                              \
		ORDER BY pp.fecha,pp.hora,pp.pago,pp.valor)", fechaini, fechafin,
		fechainiModDoc, fechafinModDoc);

	ins09.sprintf("UNION ALL                                                                                             \
		(                                                                                                                \
		SELECT 'VENTA',v.referencia,CASE v.cancelado WHEN 0 THEN ('No') WHEN 1 THEN ('Si') END AS can,                   \
		tp.descripcion,                                                                                                  \
		em.nombre,                                                                                                       \
		v.fechavta,                                                                                                      \
		v.horavta,                                                                                                       \
		v.fechamodi,                                                                                                     \
		v.horamodi,                                                                                                      \
		v.valor                                                                                                          \
		FROM ventas  v                                                                                                   \
		LEFT JOIN empleados em ON em.empleado=v.usumodi                                                                  \
		LEFT JOIN dventasfpago vf ON vf.referencia = v.referencia                                                        \
		LEFT JOIN formasdepago fp ON fp.formapag = vf.formapag                                                           \
		LEFT JOIN terminosdepago tp ON tp.termino= fp.termino                                                            \
		WHERE (v.fechavta<>v.fechamodi OR (v.fechavta = v.fechamodi AND v.horavta<>v.horamodi))                          \
		AND (v.fechavta >= '%s' AND v.fechavta <= '%s')                                                                  \
		AND (v.fechamodi >= '%s' AND v.fechamodi <= '%s')                                                                \
		ORDER BY v.fechavta,v.horavta,v.referencia,v.valor)", fechaini,
		fechafin, fechainiModDoc, fechafinModDoc);

	ins01 = ins01 + ins02 + ins03 + ins04 + ins05 + ins06 + ins07 +
		ins08 + ins09;

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, ins01.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REP_VARIACION_PRECIOS
void ServidorReportes::EjecutaReporteVariacionPrecios
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[20];
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3;
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursales = NULL;
	AnsiString sucursal, fecha_inicial, fecha_final, porcentaje;
	AnsiString empleadosupervisor = " ", condicion_empleadosupervisor = " ",
		inner_empleadosupervisor = " ", campo_supervisado = " ";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ",
		join_clientes = " ";

	try {

		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicial = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_final = mFg.ExtraeStringDeBuffer(&parametros);
		porcentaje = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);
		clientes_partesrel = mFg.ExtraeStringDeBuffer(&parametros);

		instruccion.sprintf("set @fecha_inicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fecha_final='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @porcentaje=%s", porcentaje);
		instrucciones[num_instrucciones++] = instruccion;

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf(" and  ars.usuario='%s'",
				empleadosupervisor);
			inner_empleadosupervisor.sprintf("LEFT JOIN articulossupervisados ars ON p.producto = ars.producto AND a.present = ars.present  \
			LEFT JOIN empleados emp ON ars.usuario = emp.empleado ");
			campo_supervisado.sprintf
				(", concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado "
				);
		}
		else {
			condicion_empleadosupervisor = " ";
		}

		if (clientes_partesrel != " ") {
			join_clientes =
				" INNER JOIN clientes cli ON v.cliente = cli.cliente ";
			condicion_clientes_partesrel.sprintf(" and cli.esparterelac=%s ",
				clientes_partesrel);
		}

		/////Tabla temporal, la cual contendrá los valores mínimos y maximos de los artículos vendidos
		instruccion = "CREATE TEMPORARY TABLE listadogeneral (                                     \
					  nombre varchar(60) ,                                                       \
					  producto varchar(8) ,                                                      \
					  present varchar(255) ,                                                      \
					  preciominimo decimal(20,4) ,                                               \
					  preciomaximo decimal(20,4) ,                                               \
					  porcdif decimal(38,4) ,INDEX(nombre) , INDEX(producto) ,INDEX(present)     \
					) ENGINE=InnoDB";
		instrucciones[num_instrucciones++] = instruccion;
		/////Tabla temporal, la cual contendrá las referencias de los artículos con los precios más bajos
		instruccion = "CREATE TEMPORARY TABLE referenciaminimo (                                  \
					  referencia varchar(11) ,                                                  \
					  nombre varchar(60) ,                                                      \
					  producto varchar(8) ,                                                     \
					  present varchar(255) ,                                                     \
					  INDEX(referencia),INDEX(nombre) , INDEX(producto) ,INDEX(present)         \
					) ENGINE=InnoDB";
		instrucciones[num_instrucciones++] = instruccion;
		/////Tabla temporal, la cual contendrá las referencias de los artículos con los precios más altos
		instruccion = "CREATE TEMPORARY TABLE referenciamaximo (                                 \
					  referencia varchar(11) ,                                                 \
					  nombre varchar(60) ,                                                     \
					  producto varchar(8) ,                                                    \
					  present varchar(255) ,                                                    \
					  INDEX(referencia),INDEX(nombre) , INDEX(producto) ,INDEX(present)        \
					) ENGINE=InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" SELECT p.nombre, a.producto, a.present,                                                                  \
								MIN( ROUND(dv.precioimp/a.factor,4)  ) AS preciominimo,                                                \
								MAX( ROUND(dv.precioimp/a.factor,4)  ) AS preciomaximo,                                                \
								ROUND( ((MAX( ROUND(dv.precioimp/a.factor,4)  )-                                                       \
								MIN( ROUND(dv.precioimp/a.factor,4)  ))*100)/MIN( ROUND(dv.precioimp/a.factor,4)  ),4)AS porcdif       \
								FROM ventas v                                                                                          \
								INNER JOIN dventas dv ON v.referencia=dv.referencia                                                    \
								INNER JOIN articulos a ON dv.articulo=a.articulo                                                       \
								INNER JOIN productos p ON a.producto=p.producto                                                        \
								%s %s\
								WHERE v.fechavta between @fecha_inicial and @fecha_final and v.cancelado=0 and SUBSTRING(v.referencia, 1, 2) IN ( %s )  \
								%s %s\
								GROUP BY a.producto, a.present                                                                        \
								HAVING preciominimo<>preciomaximo and porcdif>=@porcentaje INTO OUTFILE '%s'  "
			, inner_empleadosupervisor, join_clientes, sucursal,
			condicion_empleadosupervisor, condicion_clientes_partesrel,
			archivo_temp1);

		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE listadogeneral (nombre, producto, present, preciominimo,preciomaximo,porcdif ) ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" SELECT  v.referencia , p.nombre, a.producto, a.present                                       \
								FROM ventas v                                                                              \
								INNER JOIN dventas dv ON v.referencia=dv.referencia                                        \
								INNER JOIN articulos a ON dv.articulo=a.articulo                                           \
								INNER JOIN productos p ON a.producto=p.producto                                            \
								INNER JOIN listadogeneral pi ON pi.producto=a.producto and pi.present=a.present            \
								WHERE v.fechavta between @fecha_inicial and @fecha_final and v.cancelado=0 and             \
								SUBSTRING(dv.referencia, 1, 2) IN (%s) and pi.preciominimo=( ROUND(dv.precioimp/a.factor,4)  )       \
								group by p.nombre, a.producto, a.present                                                   \
								order by v.referencia , p.nombre, a.producto, a.present INTO OUTFILE  '%s'  "
		   , sucursal, archivo_temp2);

		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE referenciaminimo (referencia,nombre, producto, present) ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" SELECT  v.referencia , p.nombre, a.producto, a.present                                        \
								FROM ventas v                                                                               \
								INNER JOIN dventas dv ON v.referencia=dv.referencia                                         \
								INNER JOIN articulos a ON dv.articulo=a.articulo                                            \
								INNER JOIN productos p ON a.producto=p.producto                                             \
								INNER JOIN listadogeneral pi ON pi.producto=a.producto and pi.present=a.present             \
								WHERE v.fechavta between @fecha_inicial and @fecha_final and v.cancelado=0 and              \
								SUBSTRING(dv.referencia, 1, 2) IN (%s) and pi.preciomaximo=( ROUND(dv.precioimp/a.factor,4)  )        \
								group by p.nombre, a.producto, a.present                                                    \
								order by v.referencia , p.nombre, a.producto, a.present INTO OUTFILE  '%s'  "
			, sucursal, archivo_temp3);

		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE referenciamaximo (referencia,nombre, producto, present) ",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);

			// Resultado final
			instruccion.sprintf("select lg.nombre,lg.producto,lg.present, rm.referencia as ventavalorminimo,                    \
									lg.preciominimo,rx.referencia as ventmax ,lg.preciomaximo as ventavalormaximo ,lg.porcdif   \
									from listadogeneral lg                                                                      \
									inner join  referenciaminimo rm on rm.producto=lg.producto and rm.present=lg.present        \
									inner join  referenciamaximo rx on rx.producto=lg.producto and rx.present=lg.present        \
									ORDER BY lg.porcdif desc ");
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOVENTASXCLIENTES
void ServidorReportes::EjecutaRepCostoVentasAgrupadoxCliente
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	int i;
	AnsiString fecha_inicial, fecha_final, acredito, almacen, producto,
		presentacion, marca, proveedor;
	AnsiString sector, localidad, vendedor, venta, cliente, sucursal,
		prov_predeterminado, diferencias;
	AnsiString condicion_acredito = " ";
	AnsiString incluir_devoluciones, desglosado, join_devoluciones = " ";
	AnsiString tipofacturacion, condicion_tipofac = " ",
		condicion_tipofac_diferencia = " ", condicion_cliente = " ",
		condicion_cliente_diferencia = " ";
	AnsiString condicion_sector = " ", condicion_sector_diferencia = " ",
		inner_sectolocalidad_diferencia = " ";
	AnsiString condicion_localidad = " ", condicion_localidad_diferencia = " ";
	AnsiString condicion_vendedor = " ", condicion_vendedor_diferencia = " ";
	AnsiString condicion_venta = " ", condicion_venta_diferencia = " ",
		condicion_acredito_diferencia = " ";
	AnsiString campos_detalle = " ";
	AnsiString cantvta, cantdev;
	AnsiString inner_empleado = " ";
	bool es_desglosado = false;
	bool hay_pendientes, aplicar_costo;
	int registra_costovta;
	AnsiString cad_conjunto_almacenes = " ", condicion_sucursal = " ";
	AnsiString incluir_dirCliente, campos_incluir_dirCliente = " ";
	AnsiString condicion_empresa = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		desglosado = mFg.ExtraeStringDeBuffer(&parametros);
		tipofacturacion = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		vendedor = mFg.ExtraeStringDeBuffer(&parametros);
		sector = mFg.ExtraeStringDeBuffer(&parametros);
		localidad = mFg.ExtraeStringDeBuffer(&parametros);
		venta = mFg.ExtraeStringDeBuffer(&parametros);
		registra_costovta = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		incluir_dirCliente = mFg.ExtraeStringDeBuffer(&parametros);

		int indice_producto, indice_present, indice_clasif, indice_cantvta,
			indice_cantidad, indice_costounit;
		int indice_tipo, indice_fecha, indice_referencia;
		int indice_subtotventa, indice_suma;

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" and sec.sucursal='%s' ", sucursal);
		} else {
			condicion_empresa.sprintf(" and suc.idempresa=%s", FormServidor->ObtieneClaveEmpresa());
		}

		if (sector != " ") {
			condicion_sector_diferencia.sprintf(" and col.sector='%s' ",
			sector);
		}
		if (localidad != " ") {
			condicion_localidad_diferencia.sprintf(" and col.localidad='%s' ",
				localidad);
		}
		if (vendedor != " ") {
			condicion_vendedor_diferencia.sprintf(" and v.vendedor='%s' ",
				vendedor);
		}
		if (incluir_dirCliente != " ") {
			campos_incluir_dirCliente.sprintf
				("cli.calle, col.nombre AS nomcolonia, loc.nombre AS nomloc, mun.nombre AS nommunicipio, est.nombre AS nomestado, cli.cp, "
				);
		}
		if (tipofacturacion != " ") {
			condicion_tipofac_diferencia.sprintf(" and v.tipofac='%s' ",
				tipofacturacion);
		}
		if (cliente != " ") {
			condicion_cliente_diferencia.sprintf(" and v.cliente='%s' ",
			cliente);
		}
		if (venta != " ") {
			condicion_venta_diferencia.sprintf(" and v.referencia='%s' ",
			venta);
		}
		if (acredito != " ") {
			condicion_acredito_diferencia.sprintf(" and v.acredito=%s ",
				acredito);
		}

		if (desglosado == "1" && registra_costovta)
			throw Exception
				("desglosado y registra_costovta no pueden estar ambos activos."
				);

		if (desglosado == "1") {
			es_desglosado = true;
			campos_detalle = ", pc.tipo, pc.referencia ";
		}
		if (registra_costovta) {
			campos_detalle = ", pc.tipo, pc.referencia ";
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);

		instruccion.sprintf("SELECT cli.cliente, IF(cli.tipoempre=0, CONCAT(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial) AS nomcliente, \
					cli.nomnegocio, cemp.vendedor,  CONCAT(em.nombre, ' ',em.appat,' ',em.apmat) as nomvendedor, \
					%s \
					TRUNCATE((SUM(pcv.costovta)*-1),2) AS costovta, \
					TRUNCATE(SUM(pv.subtotal),2) AS subtotal, \
					TRUNCATE(SUM(pv.total),2) AS total \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN precalculoventas pv ON v.referencia=pv.referencia  \
					INNER JOIN precalculocostosventa pcv ON pcv.referencia=pv.referencia  \
					INNER JOIN clientes cli ON v.cliente=cli.cliente \
					INNER JOIN colonias col ON cli.colonia=col.colonia \
					INNER JOIN localidades loc ON col.localidad=loc.localidad \
					INNER JOIN municipios mun ON loc.municipio=mun.municipio \
					INNER JOIN estados est ON mun.estado=est.estado \
					INNER JOIN terminales ter ON ter.terminal=v.terminal \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion \
                    INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					LEFT JOIN clientesemp cemp ON cli.cliente = cemp.cliente AND cemp.idempresa = %s\
					LEFT JOIN empleados em on em.empleado=cemp.vendedor \
					WHERE v.cancelado=0 AND v.fechavta>= '%s' AND v.fechavta<='%s' \
					%s %s %s %s \
					%s %s %s %s %s \
					GROUP BY v.cliente  \
					ORDER BY v.cliente", campos_incluir_dirCliente, FormServidor->ObtieneClaveEmpresa(),
			fecha_inicial, fecha_final, condicion_sucursal,
			condicion_cliente_diferencia, condicion_sector_diferencia,
			condicion_localidad_diferencia, condicion_vendedor_diferencia,
			condicion_tipofac_diferencia, condicion_acredito_diferencia,
			condicion_venta_diferencia, condicion_empresa);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {
	}
}
// ---------------------------------------------------------------------------

// ID_REP_VENTAS_CLIENTE_POR_DIA
void ServidorReportes::EjecutaRepVentasClientePorDia
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString sucursal, mes, anio, modo_totalizar;
	AnsiString condicion_sucursal = " ";
	AnsiString left_join_sumas;

	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	mes = mFg.ExtraeStringDeBuffer(&parametros);
	anio = mFg.ExtraeStringDeBuffer(&parametros);
	modo_totalizar = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != "") {
		condicion_sucursal.sprintf(" AND sec.sucursal = '%s' ", sucursal);
	}else{
		condicion_sucursal.sprintf(" AND sec.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
	}

	if (modo_totalizar == "C") {
		left_join_sumas.sprintf("LEFT JOIN ( \
			SELECT v.cliente, SUM(pv.unidades/pmm.maxfactor) AS tot_cajas_bultos, SUM((pv.unidades/pmm.cajalogisticafactor)) AS subtot_venta, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=1,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_01, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=2,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_02, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=3,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_03, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=4,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_04, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=5,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_05, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=6,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_06, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=7,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_07, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=8,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_08, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=9,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_09, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=10,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_10, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=11,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_11, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=12,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_12, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=13,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_13, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=14,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_14, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=15,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_15, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=16,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_16, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=17,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_17, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=18,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_18, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=19,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_19, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=20,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_20, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=21,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_21, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=22,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_22, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=23,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_23, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=24,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_24, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=25,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_25, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=26,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_26, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=27,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_27, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=28,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_28, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=29,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_29, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=30,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_30, \
			SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=31,(pv.unidades/pmm.cajalogisticafactor),0)) AS sub_31 \
			FROM ventas v FORCE INDEX(fechavta) \
			INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
			INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
			INNER JOIN terminales t ON t.terminal=v.terminal \
			INNER JOIN secciones sec ON sec.seccion=t.seccion \
			WHERE v.fechavta BETWEEN @fechaini and @fechafin AND v.cancelado=0 %s \
			GROUP BY v.cliente \
		) ventascajas ON ventascajas.cliente=c.cliente ", condicion_sucursal);
	}
	else {
		if (modo_totalizar == "S") {
			left_join_sumas.sprintf("LEFT JOIN ( \
				SELECT v.cliente, SUM(pv.unidades/pmm.maxfactor) AS tot_cajas_bultos, SUM(pv.subtotal) AS subtot_venta, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=1,pv.subtotal,0)) AS sub_01, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=2,pv.subtotal,0)) AS sub_02, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=3,pv.subtotal,0)) AS sub_03, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=4,pv.subtotal,0)) AS sub_04, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=5,pv.subtotal,0)) AS sub_05, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=6,pv.subtotal,0)) AS sub_06, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=7,pv.subtotal,0)) AS sub_07, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=8,pv.subtotal,0)) AS sub_08, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=9,pv.subtotal,0)) AS sub_09, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=10,pv.subtotal,0)) AS sub_10, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=11,pv.subtotal,0)) AS sub_11, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=12,pv.subtotal,0)) AS sub_12, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=13,pv.subtotal,0)) AS sub_13, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=14,pv.subtotal,0)) AS sub_14, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=15,pv.subtotal,0)) AS sub_15, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=16,pv.subtotal,0)) AS sub_16, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=17,pv.subtotal,0)) AS sub_17, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=18,pv.subtotal,0)) AS sub_18, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=19,pv.subtotal,0)) AS sub_19, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=20,pv.subtotal,0)) AS sub_20, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=21,pv.subtotal,0)) AS sub_21, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=22,pv.subtotal,0)) AS sub_22, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=23,pv.subtotal,0)) AS sub_23, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=24,pv.subtotal,0)) AS sub_24, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=25,pv.subtotal,0)) AS sub_25, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=26,pv.subtotal,0)) AS sub_26, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=27,pv.subtotal,0)) AS sub_27, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=28,pv.subtotal,0)) AS sub_28, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=29,pv.subtotal,0)) AS sub_29, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=30,pv.subtotal,0)) AS sub_30, \
				SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=31,pv.subtotal,0)) AS sub_31 \
				FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
				INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
				INNER JOIN terminales t ON t.terminal=v.terminal \
				INNER JOIN secciones sec ON sec.seccion=t.seccion \
				WHERE v.fechavta BETWEEN @fechaini and @fechafin AND v.cancelado=0 %s \
				GROUP BY v.cliente \
			) ventascajas ON ventascajas.cliente=c.cliente ",
			condicion_sucursal);
		}
		else {
			if (modo_totalizar == "T") {
				left_join_sumas.sprintf("LEFT JOIN ( \
					SELECT v.cliente, SUM(pv.unidades/pmm.maxfactor) AS tot_cajas_bultos, SUM(pv.total) AS subtot_venta, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=1,pv.total,0)) AS sub_01, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=2,pv.total,0)) AS sub_02, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=3,pv.total,0)) AS sub_03, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=4,pv.total,0)) AS sub_04, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=5,pv.total,0)) AS sub_05, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=6,pv.total,0)) AS sub_06, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=7,pv.total,0)) AS sub_07, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=8,pv.total,0)) AS sub_08, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=9,pv.total,0)) AS sub_09, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=10,pv.total,0)) AS sub_10, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=11,pv.total,0)) AS sub_11, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=12,pv.total,0)) AS sub_12, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=13,pv.total,0)) AS sub_13, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=14,pv.total,0)) AS sub_14, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=15,pv.total,0)) AS sub_15, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=16,pv.total,0)) AS sub_16, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=17,pv.total,0)) AS sub_17, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=18,pv.total,0)) AS sub_18, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=19,pv.total,0)) AS sub_19, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=20,pv.total,0)) AS sub_20, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=21,pv.total,0)) AS sub_21, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=22,pv.total,0)) AS sub_22, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=23,pv.total,0)) AS sub_23, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=24,pv.total,0)) AS sub_24, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=25,pv.total,0)) AS sub_25, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=26,pv.total,0)) AS sub_26, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=27,pv.total,0)) AS sub_27, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=28,pv.total,0)) AS sub_28, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=29,pv.total,0)) AS sub_29, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=30,pv.total,0)) AS sub_30, \
					SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=31,pv.total,0)) AS sub_31 \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
					INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
					INNER JOIN terminales t ON t.terminal=v.terminal \
					INNER JOIN secciones sec ON sec.seccion=t.seccion \
					WHERE v.fechavta BETWEEN @fechaini and @fechafin AND v.cancelado=0 %s \
					GROUP BY v.cliente \
				) ventascajas ON ventascajas.cliente=c.cliente ",
					condicion_sucursal);
			}
			else {
				if (modo_totalizar == "U") {
					left_join_sumas.sprintf("LEFT JOIN ( \
						SELECT v.cliente, SUM(pv.unidades/pmm.maxfactor) AS tot_cajas_bultos, SUM((pv.unidades)) AS subtot_venta, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=1,(pv.unidades),0)) AS sub_01, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=2,(pv.unidades),0)) AS sub_02, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=3,(pv.unidades),0)) AS sub_03, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=4,(pv.unidades),0)) AS sub_04, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=5,(pv.unidades),0)) AS sub_05, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=6,(pv.unidades),0)) AS sub_06, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=7,(pv.unidades),0)) AS sub_07, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=8,(pv.unidades),0)) AS sub_08, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=9,(pv.unidades),0)) AS sub_09, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=10,(pv.unidades),0)) AS sub_10, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=11,(pv.unidades),0)) AS sub_11, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=12,(pv.unidades),0)) AS sub_12, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=13,(pv.unidades),0)) AS sub_13, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=14,(pv.unidades),0)) AS sub_14, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=15,(pv.unidades),0)) AS sub_15, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=16,(pv.unidades),0)) AS sub_16, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=17,(pv.unidades),0)) AS sub_17, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=18,(pv.unidades),0)) AS sub_18, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=19,(pv.unidades),0)) AS sub_19, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=20,(pv.unidades),0)) AS sub_20, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=21,(pv.unidades),0)) AS sub_21, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=22,(pv.unidades),0)) AS sub_22, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=23,(pv.unidades),0)) AS sub_23, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=24,(pv.unidades),0)) AS sub_24, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=25,(pv.unidades),0)) AS sub_25, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=26,(pv.unidades),0)) AS sub_26, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=27,(pv.unidades),0)) AS sub_27, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=28,(pv.unidades),0)) AS sub_28, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=29,(pv.unidades),0)) AS sub_29, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=30,(pv.unidades),0)) AS sub_30, \
						SUM(if(YEAR(v.fechavta)=@rep_anio AND MONTH(v.fechavta)=@rep_mes AND DAY(v.fechavta)=31,(pv.unidades),0)) AS sub_31 \
						FROM ventas v FORCE INDEX(fechavta) \
						INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
						INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
						INNER JOIN terminales t ON t.terminal=v.terminal \
						INNER JOIN secciones sec ON sec.seccion=t.seccion \
						WHERE v.fechavta BETWEEN @fechaini and @fechafin AND v.cancelado=0 %s \
						GROUP BY v.cliente \
					) ventascajas ON ventascajas.cliente=c.cliente ",
						condicion_sucursal);
				}
				else {
					throw Exception("Modo de totalizar no soportado: " +
						modo_totalizar);
				}
			}
		}
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	instruccion.sprintf("SET @rep_mes=%s", mes);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("SET @rep_anio=%s", anio);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf
		("SET @fechaini=DATE_ADD(MAKEDATE(@rep_anio,1), INTERVAL @rep_mes-1 MONTH)"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf
		("SET @fechafin=DATE_ADD(DATE_ADD(MAKEDATE(@rep_anio,1), INTERVAL @rep_mes MONTH), INTERVAL -1 DAY)"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf(" \
		SELECT c.cliente AS nocliente, \
		IF(c.tipoempre=0, CONCAT(c.appat,' ',c.apmat,' ',c.nombre),c.rsocial) AS nombre, \
		est.nombre AS estado, \
		mun.nombre AS ciudad, \
		clcan.descripcion as canal, \
		sec.nombre AS sector, \
		IFNULL(ventascajas.subtot_venta,0) AS subtot_venta, \
		IFNULL(ventascred.numventas,0) AS numventas, \
		IFNULL(ventascred.totcredito,0) AS docscredito, \
		IFNULL(ventascred.totcontado,0) AS docscontado, \
		if(IFNULL(ventascred.numventas,0)>0,(IFNULL(ventascred.totcredito,0)*100)/ventascred.numventas,0) AS porccredito, \
		IFNULL(sub_01,0) AS sub_01, \
		IFNULL(sub_02,0) AS sub_02, \
		IFNULL(sub_03,0) AS sub_03, \
		IFNULL(sub_04,0) AS sub_04, \
		IFNULL(sub_05,0) AS sub_05, \
		IFNULL(sub_06,0) AS sub_06, \
		IFNULL(sub_07,0) AS sub_07, \
		IFNULL(sub_08,0) AS sub_08, \
		IFNULL(sub_09,0) AS sub_09, \
		IFNULL(sub_10,0) AS sub_10, \
		IFNULL(sub_11,0) AS sub_11, \
		IFNULL(sub_12,0) AS sub_12, \
		IFNULL(sub_13,0) AS sub_13, \
		IFNULL(sub_14,0) AS sub_14, \
		IFNULL(sub_15,0) AS sub_15, \
		IFNULL(sub_16,0) AS sub_16, \
		IFNULL(sub_17,0) AS sub_17, \
		IFNULL(sub_18,0) AS sub_18, \
		IFNULL(sub_19,0) AS sub_19, \
		IFNULL(sub_20,0) AS sub_20, \
		IFNULL(sub_21,0) AS sub_21, \
		IFNULL(sub_22,0) AS sub_22, \
		IFNULL(sub_23,0) AS sub_23, \
		IFNULL(sub_24,0) AS sub_24, \
		IFNULL(sub_25,0) AS sub_25, \
		IFNULL(sub_26,0) AS sub_26, \
		IFNULL(sub_27,0) AS sub_27, \
		IFNULL(sub_28,0) AS sub_28, \
		IFNULL(sub_29,0) AS sub_29, \
		IFNULL(sub_30,0) AS sub_30, \
		IFNULL(sub_31,0) AS sub_31 \
		FROM clientes c \
		INNER JOIN canalesclientes clcan ON c.canal=clcan.canal \
		INNER JOIN gironegocio		 clgir ON c.giro=clgir.giro \
		INNER JOIN colonias col ON c.colonia=col.colonia \
		INNER JOIN localidades loc ON col.localidad=loc.localidad \
		INNER JOIN municipios mun ON loc.municipio=mun.municipio \
		INNER JOIN estados est ON mun.estado=est.estado \
		INNER JOIN sectores sec ON col.sector=sec.sector \
		%s \
		LEFT JOIN ( \
			SELECT v.cliente, COUNT(*) AS numventas, SUM(if(v.acredito=1,1,0)) AS totcredito, SUM(if(v.acredito=0,1,0)) AS totcontado \
			FROM ventas v FORCE INDEX(fechavta) \
			INNER JOIN terminales t ON t.terminal=v.terminal \
			INNER JOIN secciones sec ON sec.seccion=t.seccion \
			WHERE v.fechavta BETWEEN @fechaini and @fechafin AND v.cancelado=0 %s \
			GROUP BY v.cliente \
		) ventascred ON ventascred.cliente=c.cliente \
		ORDER BY nombre", left_join_sumas, condicion_sucursal);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------

// ID_REP_TRASPASOS_ARTICULOS_MENSUAL
void ServidorReportes::EjecutaRepTraspasosArticulosMensual
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString sucursales_salida, sucursales_entrada, UltimoAnioTotalizar;
	AnsiString fecha_inicio, fecha_fin;
	int anio1, anio2, anio3;

	sucursales_salida = mFg.ExtraeStringDeBuffer(&parametros);
	sucursales_entrada = mFg.ExtraeStringDeBuffer(&parametros);
	UltimoAnioTotalizar = mFg.ExtraeStringDeBuffer(&parametros);

	anio3 = StrToInt(UltimoAnioTotalizar); // Año actual
	anio2 = anio3 - 1; // Año anterior
	anio1 = anio3 - 2; // 2 años atras

	fecha_inicio = mFg.IntToAnsiString(anio1) + "-01-01";
	fecha_fin = mFg.IntToAnsiString(anio3) + "-12-31";

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	instruccion.sprintf(" \
		SELECT amax.articulo AS noarticulo, \
			prod.producto, \
			prod.nombre AS descripcion, \
			pre.present AS presentacion, \
			amax.factor AS factormax, \
			pmm.cajalogisticafactor, \
			ifnull(satum.descripcion,'') AS unidadmedidasat, \
			amax.multiplo AS multiplomax, \
			if(pmm.cajalogisticafactor<>amax.factor,'SI','NO') as usacajalogistica, \
			sum(IFNULL(traspcajas.tot_cajas_bultos,0)) AS totcajasbultos, \
			sum(IFNULL(trasp_%d_01,0)) AS trasp_%d_01, \
			sum(IFNULL(trasp_%d_02,0)) AS trasp_%d_02, \
			sum(IFNULL(trasp_%d_03,0)) AS trasp_%d_03, \
			sum(IFNULL(trasp_%d_04,0)) AS trasp_%d_04, \
			sum(IFNULL(trasp_%d_05,0)) AS trasp_%d_05, \
			sum(IFNULL(trasp_%d_06,0)) AS trasp_%d_06, \
			sum(IFNULL(trasp_%d_07,0)) AS trasp_%d_07, \
			sum(IFNULL(trasp_%d_08,0)) AS trasp_%d_08, \
			sum(IFNULL(trasp_%d_09,0)) AS trasp_%d_09, \
			sum(IFNULL(trasp_%d_10,0)) AS trasp_%d_10, \
			sum(IFNULL(trasp_%d_11,0)) AS trasp_%d_11, \
			sum(IFNULL(trasp_%d_12,0)) AS trasp_%d_12, \
			sum(IFNULL(trasp_%d_01,0)) AS trasp_%d_01, \
			sum(IFNULL(trasp_%d_02,0)) AS trasp_%d_02, \
			sum(IFNULL(trasp_%d_03,0)) AS trasp_%d_03, \
			sum(IFNULL(trasp_%d_04,0)) AS trasp_%d_04, \
			sum(IFNULL(trasp_%d_05,0)) AS trasp_%d_05, \
			sum(IFNULL(trasp_%d_06,0)) AS trasp_%d_06, \
			sum(IFNULL(trasp_%d_07,0)) AS trasp_%d_07, \
			sum(IFNULL(trasp_%d_08,0)) AS trasp_%d_08, \
			sum(IFNULL(trasp_%d_09,0)) AS trasp_%d_09, \
			sum(IFNULL(trasp_%d_10,0)) AS trasp_%d_10, \
			sum(IFNULL(trasp_%d_11,0)) AS trasp_%d_11, \
			sum(IFNULL(trasp_%d_12,0)) AS trasp_%d_12, \
			sum(IFNULL(trasp_%d_01,0)) AS trasp_%d_01, \
			sum(IFNULL(trasp_%d_02,0)) AS trasp_%d_02, \
			sum(IFNULL(trasp_%d_03,0)) AS trasp_%d_03, \
			sum(IFNULL(trasp_%d_04,0)) AS trasp_%d_04, \
			sum(IFNULL(trasp_%d_05,0)) AS trasp_%d_05, \
			sum(IFNULL(trasp_%d_06,0)) AS trasp_%d_06, \
			sum(IFNULL(trasp_%d_07,0)) AS trasp_%d_07, \
			sum(IFNULL(trasp_%d_08,0)) AS trasp_%d_08, \
			sum(IFNULL(trasp_%d_09,0)) AS trasp_%d_09, \
			sum(IFNULL(trasp_%d_10,0)) AS trasp_%d_10, \
			sum(IFNULL(trasp_%d_11,0)) AS trasp_%d_11, \
			sum(IFNULL(trasp_%d_12,0)) AS trasp_%d_12 \
		FROM presentaciones pre \
			INNER JOIN productos prod ON pre.producto=prod.producto \
			INNER JOIN presentacionesminmax pmm ON pre.producto=pmm.producto AND pre.present = pmm.present \
			INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
			INNER JOIN articulos amin ON pmm.producto=amin.producto and pmm.present=amin.present and pmm.minmult=amin.multiplo \
			LEFT JOIN satunidadmed satum ON pre.idunidad=satum.idunidad \
		LEFT JOIN ( \
			SELECT pmm.producto, pmm.present, pmm.maxmult, sum((a.factor*dm.cantidad)/pmm.cajalogisticafactor) AS tot_cajas_bultos, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=1,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_01, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=2,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_02, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=3,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_03, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=4,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_04, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=5,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_05, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=6,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_06, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=7,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_07, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=8,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_08, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=9,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_09, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=10,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_10, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=11,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_11, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=12,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_12, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=1,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_01, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=2,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_02, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=3,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_03, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=4,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_04, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=5,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_05, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=6,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_06, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=7,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_07, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=8,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_08, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=9,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_09, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=10,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_10, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=11,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_11, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=12,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_12, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=1,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_01, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=2,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_02, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=3,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_03, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=4,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_04, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=5,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_05, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=6,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_06, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=7,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_07, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=8,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_08, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=9,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_09, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=10,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_10, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=11,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_11, \
				SUM(if(YEAR(m.fechamov)=%d AND MONTH(m.fechamov)=12,(a.factor*dm.cantidad),0)/pmm.cajalogisticafactor) AS trasp_%d_12 \
			FROM movalma m \
			INNER JOIN almacenes asal ON asal.almacen=m.almasal \
			INNER JOIN secciones secsal ON asal.seccion=secsal.seccion \
			INNER JOIN almacenes aent ON aent.almacen=m.almaent \
			INNER JOIN secciones secent ON aent.seccion=secent.seccion \
			INNER JOIN dmovalma dm ON dm.movimiento=m.movimiento \
			INNER JOIN articulos a ON a.articulo=dm.articulo \
			INNER JOIN presentacionesminmax pmm ON pmm.producto=a.producto AND pmm.present=a.present \
			WHERE m.tipo='T' AND m.cancelado=0 AND m.aplica=1 \
			AND m.fechamov BETWEEN '%s' AND '%s' \
			AND secsal.sucursal in (%s) AND secent.sucursal in (%s) \
			GROUP BY pmm.producto, pmm.present \
		) traspcajas ON traspcajas.producto=prod.producto AND traspcajas.present=pre.present \
		  GROUP BY prod.producto, pre.present \
		HAVING totcajasbultos<>0 \
		ORDER BY prod.nombre, pre.present ", anio1, anio1, anio1, anio1, anio1,
		anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
		anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio2,
		anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
		anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
		anio2, anio2, anio2, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
		anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
		anio3, anio3, anio3, anio3, anio3, anio3, anio3,

		anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
		anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
		anio1, anio1, anio1, anio1, anio2, anio2, anio2, anio2, anio2, anio2,
		anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
		anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio3, anio3,
		anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
		anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
		anio3, anio3,

		fecha_inicio, fecha_fin, sucursales_salida, sucursales_entrada);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------

// ID_REP_VENTAS_ARTICULOS_MENSUAL
void ServidorReportes::EjecutaRepVentasArticulosMensual
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString sucursales_ventas, modo_totalizar, campo_usado, operacion,
		campo_usado2;
	AnsiString fecha_inicio, fecha_fin, condicion_costos, UltimoAnioTotalizar;
	AnsiString ProveedorPrincipal, EsParteRelacionada, fabricante;
	AnsiString condicion_proveedor = " ", condicion_parterelacionada = " ",
		inner_prov = " ", condicion_fabricante = " ";
	int anio1, anio2, anio3;

	sucursales_ventas = mFg.ExtraeStringDeBuffer(&parametros);
	modo_totalizar = mFg.ExtraeStringDeBuffer(&parametros);
	UltimoAnioTotalizar = mFg.ExtraeStringDeBuffer(&parametros);
	ProveedorPrincipal = mFg.ExtraeStringDeBuffer(&parametros);
	EsParteRelacionada = mFg.ExtraeStringDeBuffer(&parametros);
	fabricante = mFg.ExtraeStringDeBuffer(&parametros);

	condicion_costos = " ";

	if (modo_totalizar == "C") {
		campo_usado = "pv.unidades";
		operacion = "/pmm.cajalogisticafactor";
	}
	else {
		if (modo_totalizar == "S") {
			campo_usado = "pv.subtotal";
			operacion = " ";
			campo_usado2 = " ";
		}
		else {
			if (modo_totalizar == "T") {
				campo_usado = "pv.total";
				operacion = " ";
				campo_usado2 = " ";
			}
			else {
				if (modo_totalizar == "U") { // Totalizar por Utilidad
					campo_usado = " pv.subtotal+ifnull(cv.costovta,0)";
					condicion_costos =
						" LEFT JOIN precalculocostosventadet cv  on cv.referencia=pv.referencia and cv.producto=pv.producto and cv.present=pv.present ";
					operacion = " ";
					campo_usado2 = " ";
				}
				else {
					if (modo_totalizar == "P")
					{ // para totalizar por porcentaje de Utilidad
						campo_usado =
							"(pv.subtotal+ IFNULL(cv.costovta,0))*100";
						condicion_costos =
							" LEFT JOIN precalculocostosventadet cv  on cv.referencia=pv.referencia and cv.producto=pv.producto and cv.present=pv.present ";
						operacion = " ";
						campo_usado2 = "ifnull(cv.costovta*-1,0)";
					}
					else {
						if (modo_totalizar == "O") { // Totalizar por Costo
							campo_usado = " ifnull(cv.costovta*-1,0)";
							condicion_costos =
								" LEFT JOIN precalculocostosventadet cv  on cv.referencia=pv.referencia and cv.producto=pv.producto and cv.present=pv.present ";
							operacion = " ";
							campo_usado2 = " ";
						}

						else {
							throw Exception("Modo de totalizar no soportado: " +
								modo_totalizar);
						}
					}
				}

			}
		}

	}

	if (ProveedorPrincipal != " ") {
		inner_prov.sprintf("INNER JOIN ( \
			SELECT producto, present FROM articulosped WHERE proveedor = '%s' GROUP BY producto, present \
		) prov ON prov.producto = prod.producto AND prov.present = pre.present "
			, ProveedorPrincipal);
	}

	if (EsParteRelacionada != " ") {
		condicion_parterelacionada.sprintf(" AND c.esparterelac = %s ",
			EsParteRelacionada);
	}

	if (fabricante != " ") {
		condicion_fabricante.sprintf(" AND prod.fabricante = '%s' ",
		fabricante);
	}

	anio3 = StrToInt(UltimoAnioTotalizar); // YearOf(Today()); // Año actual
	anio2 = anio3 - 1; // Año anterior
	anio1 = anio3 - 2; // 2 años atras

	fecha_inicio = mFg.IntToAnsiString(anio1) + "-01-01";
	fecha_fin = mFg.IntToAnsiString(anio3) + "-12-31";

	// Creamos una tabla temporal con la relación de articulos unificados, para evitar que se repitan para un artículo
	// en caso de repetición se deja la clave máxima (alfabéticamente).
	instruccion =
		"CREATE temporary TABLE articulosunifaux ( " "articulo VARCHAR(9) NULL DEFAULT NULL COLLATE 'latin1_swedish_ci', "
		"articulorem VARCHAR(9) NOT NULL COLLATE 'latin1_swedish_ci', " "PRIMARY KEY (articulo) USING BTREE, "
		"INDEX articulorem (articulorem) USING BTREE " ") COLLATE='latin1_swedish_ci' ENGINE=InnoDB";
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));
	instruccion =
		"INSERT INTO articulosunifaux (articulo, articulorem) " "SELECT au.articulo, max(au.articulorem) AS articulorem "
		"from articulosunif au " "WHERE articulo IS NOT null "
		"GROUP BY articulo ";
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
	if (modo_totalizar == "P") { // para calculo de Porcentaje de Utilidad
		instruccion.sprintf(" \
				SELECT amax.articulo AS noarticulo, \
					concat(LEAST(au.articulo,au.articulorem),'-', GREATEST(au.articulo,au.articulorem)) as idunificado, \
					prod.producto, \
					prod.nombre AS descripcion, \
					pre.present AS presentacion, \
					amax.factor AS factormax, \
					pmm.cajalogisticafactor, \
					ifnull(satum.descripcion,'') AS unidadmedidasat, \
					amax.multiplo AS multiplomax, \
					if(pmm.cajalogisticafactor<>amax.factor,'SI','NO') as usacajalogistica, \
					sum(IFNULL(ventascajas.total,0)) AS total, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12 \
				FROM presentaciones pre \
					INNER JOIN productos prod ON pre.producto=prod.producto \
					INNER JOIN presentacionesminmax pmm ON pre.producto=pmm.producto AND pre.present = pmm.present \
					INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
					INNER JOIN articulos amin ON pmm.producto=amin.producto and pmm.present=amin.present and pmm.minmult=amin.multiplo \
					LEFT JOIN articulosunifaux au ON au.articulo=amax.articulo \
					LEFT JOIN satunidadmed satum ON pre.idunidad=satum.idunidad \
				INNER JOIN ( \
					SELECT pv.producto, pv.present, SUM(%s%s)/SUM(%s) AS total,\
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s)/SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s)/SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s)/SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s)/SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12 \
					FROM ventas v \
					INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
					INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes c ON c.cliente = v.cliente \
					%s \
					WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) %s \
					 GROUP BY pv.producto, pv.present \
				) ventascajas ON ventascajas.producto=prod.producto AND ventascajas.present=pre.present \
				%s \
				WHERE 1 %s \
				GROUP BY prod.producto, pre.present \
				ORDER BY prod.nombre, pre.present ",

			anio1, anio1, anio2, anio2, anio3, anio3,

			anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
			anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
			anio1, anio1, anio1, anio1, anio1, anio1, anio2, anio2, anio2,
			anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
			anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
			anio2, anio2, anio2, anio3, anio3, anio3, anio3, anio3, anio3,
			anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
			anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,

			campo_usado, operacion, campo_usado2, anio1, campo_usado, operacion,
			anio1, campo_usado2, operacion, anio1, anio2, campo_usado,
			operacion, anio2, campo_usado2, operacion, anio2, anio3,
			campo_usado, operacion, anio3, campo_usado2, operacion, anio3,

			anio1, campo_usado, operacion, anio1, campo_usado2, operacion,
			anio1, anio1, campo_usado, operacion, anio1, campo_usado2,
			operacion, anio1, anio1, campo_usado, operacion, anio1,
			campo_usado2, operacion, anio1, anio1, campo_usado, operacion,
			anio1, campo_usado2, operacion, anio1, anio1, campo_usado,
			operacion, anio1, campo_usado2, operacion, anio1, anio1,
			campo_usado, operacion, anio1, campo_usado2, operacion, anio1,
			anio1, campo_usado, operacion, anio1, campo_usado2, operacion,
			anio1, anio1, campo_usado, operacion, anio1, campo_usado2,
			operacion, anio1, anio1, campo_usado, operacion, anio1,
			campo_usado2, operacion, anio1, anio1, campo_usado, operacion,
			anio1, campo_usado2, operacion, anio1, anio1, campo_usado,
			operacion, anio1, campo_usado2, operacion, anio1, anio1,
			campo_usado, operacion, anio1, campo_usado2, operacion, anio1,
			anio2, campo_usado, operacion, anio2, campo_usado2, operacion,
			anio2, anio2, campo_usado, operacion, anio2, campo_usado2,
			operacion, anio2, anio2, campo_usado, operacion, anio2,
			campo_usado2, operacion, anio2, anio2, campo_usado, operacion,
			anio2, campo_usado2, operacion, anio2, anio2, campo_usado,
			operacion, anio2, campo_usado2, operacion, anio2, anio2,
			campo_usado, operacion, anio2, campo_usado2, operacion, anio2,
			anio2, campo_usado, operacion, anio2, campo_usado2, operacion,
			anio2, anio2, campo_usado, operacion, anio2, campo_usado2,
			operacion, anio2, anio2, campo_usado, operacion, anio2,
			campo_usado2, operacion, anio2, anio2, campo_usado, operacion,
			anio2, campo_usado2, operacion, anio2, anio2, campo_usado,
			operacion, anio2, campo_usado2, operacion, anio2, anio2,
			campo_usado, operacion, anio2, campo_usado2, operacion, anio2,
			anio3, campo_usado, operacion, anio3, campo_usado2, operacion,
			anio3, anio3, campo_usado, operacion, anio3, campo_usado2,
			operacion, anio3, anio3, campo_usado, operacion, anio3,
			campo_usado2, operacion, anio3, anio3, campo_usado, operacion,
			anio3, campo_usado2, operacion, anio3, anio3, campo_usado,
			operacion, anio3, campo_usado2, operacion, anio3, anio3,
			campo_usado, operacion, anio3, campo_usado2, operacion, anio3,
			anio3, campo_usado, operacion, anio3, campo_usado2, operacion,
			anio3, anio3, campo_usado, operacion, anio3, campo_usado2,
			operacion, anio3, anio3, campo_usado, operacion, anio3,
			campo_usado2, operacion, anio3, anio3, campo_usado, operacion,
			anio3, campo_usado2, operacion, anio3, anio3, campo_usado,
			operacion, anio3, campo_usado2, operacion, anio3, anio3,
			campo_usado, operacion, anio3, campo_usado2, operacion, anio3,
			condicion_costos, fecha_inicio, fecha_fin, sucursales_ventas,
			condicion_parterelacionada, inner_prov, condicion_fabricante);
	}
	else {
		instruccion.sprintf(" \
				SELECT amax.articulo AS noarticulo, \
					concat(LEAST(au.articulo,au.articulorem),'-', GREATEST(au.articulo,au.articulorem)) as idunificado, \
					prod.producto, \
					prod.nombre AS descripcion, \
					pre.present AS presentacion, \
					amax.factor AS factormax, \
					pmm.cajalogisticafactor, \
					ifnull(satum.descripcion,'') AS unidadmedidasat, \
					amax.multiplo AS multiplomax, \
					if(pmm.cajalogisticafactor<>amax.factor,'SI','NO') as usacajalogistica, \
					sum(IFNULL(ventascajas.total,0)) AS total, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d,0)) AS vent_%d, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12, \
					sum(IFNULL(vent_%d_01,0)) AS vent_%d_01, \
					sum(IFNULL(vent_%d_02,0)) AS vent_%d_02, \
					sum(IFNULL(vent_%d_03,0)) AS vent_%d_03, \
					sum(IFNULL(vent_%d_04,0)) AS vent_%d_04, \
					sum(IFNULL(vent_%d_05,0)) AS vent_%d_05, \
					sum(IFNULL(vent_%d_06,0)) AS vent_%d_06, \
					sum(IFNULL(vent_%d_07,0)) AS vent_%d_07, \
					sum(IFNULL(vent_%d_08,0)) AS vent_%d_08, \
					sum(IFNULL(vent_%d_09,0)) AS vent_%d_09, \
					sum(IFNULL(vent_%d_10,0)) AS vent_%d_10, \
					sum(IFNULL(vent_%d_11,0)) AS vent_%d_11, \
					sum(IFNULL(vent_%d_12,0)) AS vent_%d_12 \
				FROM presentaciones pre \
					INNER JOIN productos prod ON pre.producto=prod.producto \
					INNER JOIN presentacionesminmax pmm ON pre.producto=pmm.producto AND pre.present = pmm.present \
					INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
					INNER JOIN articulos amin ON pmm.producto=amin.producto and pmm.present=amin.present and pmm.minmult=amin.multiplo \
					LEFT JOIN articulosunifaux au ON au.articulo=amax.articulo \
					LEFT JOIN satunidadmed satum ON pre.idunidad=satum.idunidad \
				INNER JOIN ( \
					SELECT pv.producto, pv.present, SUM(%s%s) AS total,\
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(IF(YEAR(v.fechavta)=%d,%s,0)%s) AS vent_%d, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=1,%s,0)%s) AS vent_%d_01, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=2,%s,0)%s) AS vent_%d_02, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=3,%s,0)%s) AS vent_%d_03, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=4,%s,0)%s) AS vent_%d_04, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=5,%s,0)%s) AS vent_%d_05, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=6,%s,0)%s) AS vent_%d_06, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=7,%s,0)%s) AS vent_%d_07, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=8,%s,0)%s) AS vent_%d_08, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=9,%s,0)%s) AS vent_%d_09, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=10,%s,0)%s) AS vent_%d_10, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=11,%s,0)%s) AS vent_%d_11, \
					SUM(if(YEAR(v.fechavta)=%d AND MONTH(v.fechavta)=12,%s,0)%s) AS vent_%d_12 \
					FROM ventas v \
					INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
					INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes c ON c.cliente = v.cliente \
					%s \
					WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) %s \
					GROUP BY pv.producto, pv.present \
				) ventascajas ON ventascajas.producto=prod.producto AND ventascajas.present=pre.present \
				%s \
				WHERE 1 %s \
				GROUP BY prod.producto, pre.present \
				ORDER BY prod.nombre, pre.present ",

			anio1, anio1, anio2, anio2, anio3, anio3,

			anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
			anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1, anio1,
			anio1, anio1, anio1, anio1, anio1, anio1, anio2, anio2, anio2,
			anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
			anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2, anio2,
			anio2, anio2, anio2, anio3, anio3, anio3, anio3, anio3, anio3,
			anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,
			anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3, anio3,

			campo_usado, operacion, anio1, campo_usado, operacion, anio1, anio2,
			campo_usado, operacion, anio2, anio3, campo_usado, operacion, anio3,

			anio1, campo_usado, operacion, anio1, anio1, campo_usado, operacion,
			anio1, anio1, campo_usado, operacion, anio1, anio1, campo_usado,
			operacion, anio1, anio1, campo_usado, operacion, anio1, anio1,
			campo_usado, operacion, anio1, anio1, campo_usado, operacion, anio1,
			anio1, campo_usado, operacion, anio1, anio1, campo_usado, operacion,
			anio1, anio1, campo_usado, operacion, anio1, anio1, campo_usado,
			operacion, anio1, anio1, campo_usado, operacion, anio1, anio2,
			campo_usado, operacion, anio2, anio2, campo_usado, operacion, anio2,
			anio2, campo_usado, operacion, anio2, anio2, campo_usado, operacion,
			anio2, anio2, campo_usado, operacion, anio2, anio2, campo_usado,
			operacion, anio2, anio2, campo_usado, operacion, anio2, anio2,
			campo_usado, operacion, anio2, anio2, campo_usado, operacion, anio2,
			anio2, campo_usado, operacion, anio2, anio2, campo_usado, operacion,
			anio2, anio2, campo_usado, operacion, anio2, anio3, campo_usado,
			operacion, anio3, anio3, campo_usado, operacion, anio3, anio3,
			campo_usado, operacion, anio3, anio3, campo_usado, operacion, anio3,
			anio3, campo_usado, operacion, anio3, anio3, campo_usado, operacion,
			anio3, anio3, campo_usado, operacion, anio3, anio3, campo_usado,
			operacion, anio3, anio3, campo_usado, operacion, anio3, anio3,
			campo_usado, operacion, anio3, anio3, campo_usado, operacion, anio3,
			anio3, campo_usado, operacion, anio3, condicion_costos,
			fecha_inicio, fecha_fin, sucursales_ventas,
			condicion_parterelacionada, inner_prov, condicion_fabricante);
	}

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------

// Definicion: ID_REP_VENTAS_ARTICULOS_DESGLOSADO
void ServidorReportes::EjecutaRepVentasArticulosDesglosado
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString sucursales_ventas, modo_totalizar, modo_desglosar, campo_usado,
		operacion;
	AnsiString fecha_inicial, fecha_final;
	AnsiString campo_iddesglose, group_iddesglose, order_iddesglose, joins_desglose;
	AnsiString prov_princ, parte_rela, fabricante, origenventa, tiposprecios;
	AnsiString innerjoin_precalculo=" ", innerjoin_precalculo2=" ";
	AnsiString innerjoin_prov_princ = " ", condicion_prov_princ = " ";
	AnsiString condicion_parte_rela = " ", condicion_fabricante = " ";
	AnsiString archivo_temp1 = "";
	AnsiString condicion_costos = " ", campo_usado_2 = " ";
	AnsiString condicion_origenventa = " ", condicion_tiposprecios = " ";
	AnsiString join_tipoprecios = " ", join_tipoprecios2=" ";
	AnsiString campoproducto = " ", campopresent = " ";

	AnsiString operacionTotalizadora = "SUM";
	AnsiString operacionTotalizadora2 = " ";
	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursales_ventas = mFg.ExtraeStringDeBuffer(&parametros);
		modo_desglosar = mFg.ExtraeStringDeBuffer(&parametros);
		modo_totalizar = mFg.ExtraeStringDeBuffer(&parametros);

		prov_princ = mFg.ExtraeStringDeBuffer(&parametros);
		parte_rela = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		origenventa = mFg.ExtraeStringDeBuffer(&parametros);
		tiposprecios = mFg.ExtraeStringDeBuffer(&parametros);

		// Cambiar el modo de totalizar
		if (modo_totalizar == "C") {
			campo_usado = "pv.unidades";
			operacion = "/pmm.cajalogisticafactor";
		}
		else if (modo_totalizar == "S") {
			campo_usado = "pv.subtotal";
			operacion = " ";
		} else if (modo_totalizar == "T") {
			campo_usado = "pv.total";
			operacion = " ";
		} else if (modo_totalizar == "U") {
			campo_usado = "pv.unidades";
			operacion = " ";
		} else if (modo_totalizar == "D") { // Totalizar por Utilidad
			campo_usado =
				" ifnull(pv.subtotal,0)+ifnull(cv.costovta,0)";
			condicion_costos.sprintf("INNER JOIN precalculocostosventadet cv  \
						on cv.referencia = pv.referencia and cv.producto=pv.producto \
						and cv.present=pv.present  AND  cv.tipo = 'VE'	\
						LEFT JOIN (	\
							SELECT v.referencia,pccd.producto, pccd.present,	\
							IFNULL(pccd.costovta,0) AS costonc	\
							FROM ventas v	\
							INNER JOIN terminales t ON v.terminal=t.terminal	\
							INNER JOIN secciones sec ON t.seccion=sec.seccion	\
							INNER JOIN notascredcli nc ON nc.venta = v.referencia \
							 AND nc.cancelado = 0  \
							INNER JOIN dnotascredcli dnc ON dnc.referencia = nc.referencia  \
							INNER JOIN articulos a2 ON a2.articulo=dnc.articulo	\
							INNER JOIN precalculocostosventadet pccd ON pccd.referencia = dnc.referencia \
							AND pccd.producto=a2.producto AND pccd.present=a2.present AND pccd.tipo = 'DV'	\
							WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s)) AS cnc ON cnc.referencia = pv.referencia \
							AND cnc.producto=pv.producto AND cnc.present=pv.present"
				, fecha_inicial, fecha_final,
				sucursales_ventas);
			operacion = " ";
			campo_usado_2 = "+SUM(IFNULL(costonc,0))";
		} else if (modo_totalizar == "P"){ // para totalizar por porcentaje de Utilidad
			campo_usado =
				"(ifnull(pv.subtotal,0)+ (IFNULL(cv.costovta,0)+IFNULL(costonc,0)))*100";
			condicion_costos.sprintf("INNER JOIN precalculocostosventadet cv  \
					on cv.referencia = pv.referencia and cv.producto=pv.producto \
					and cv.present=pv.present  AND  cv.tipo = 'VE'	\
					LEFT JOIN (	\
						SELECT v.referencia,pccd.producto, pccd.present,	\
						IFNULL(pccd.costovta,0) AS costonc	\
						FROM ventas v	\
						INNER JOIN terminales t ON v.terminal=t.terminal	\
						INNER JOIN secciones sec ON t.seccion=sec.seccion	\
						INNER JOIN notascredcli nc ON nc.venta = v.referencia \
						 AND nc.cancelado = 0  \
						INNER JOIN dnotascredcli dnc ON dnc.referencia = nc.referencia  \
						INNER JOIN articulos a2 ON a2.articulo=dnc.articulo	\
						INNER JOIN precalculocostosventadet pccd ON pccd.referencia = dnc.referencia \
						AND pccd.producto=a2.producto AND pccd.present=a2.present AND pccd.tipo = 'DV'	\
						WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s)) AS cnc ON cnc.referencia = pv.referencia \
						AND cnc.producto=pv.producto AND cnc.present=pv.present"
				, fecha_inicial, fecha_final,
				sucursales_ventas);
			operacion = " ";
			campo_usado_2 =
				"/(SUM(IFNULL(cv.costovta*-1,0)-ifnull(costonc,0)))";
		} else if (modo_totalizar == "O"){ // Totalizar por Costo
		campo_usado = "(ifnull(cv.costovta*-1,0))";
		condicion_costos.sprintf("INNER JOIN precalculocostosventadet cv  \
			on cv.referencia = pv.referencia and cv.producto=pv.producto \
			and cv.present=pv.present  AND  cv.tipo = 'VE'	\
			LEFT JOIN (	\
				SELECT v.referencia,pccd.producto, pccd.present,	\
				IFNULL(pccd.costovta,0) AS costonc	\
				FROM ventas v	\
				INNER JOIN terminales t ON v.terminal=t.terminal	\
				INNER JOIN secciones sec ON t.seccion=sec.seccion	\
				INNER JOIN notascredcli nc ON nc.venta = v.referencia \
				 AND nc.cancelado = 0  \
				INNER JOIN dnotascredcli dnc ON dnc.referencia = nc.referencia  \
				INNER JOIN articulos a2 ON a2.articulo=dnc.articulo	\
				INNER JOIN precalculocostosventadet pccd ON pccd.referencia = dnc.referencia \
				AND pccd.producto=a2.producto AND pccd.present=a2.present AND pccd.tipo = 'DV'	\
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s)) AS cnc ON cnc.referencia = pv.referencia \
				AND cnc.producto=pv.producto AND cnc.present=pv.present"
			, fecha_inicial, fecha_final,
			sucursales_ventas);
		operacion = " ";
		campo_usado_2 = "-SUM(IFNULL(costonc,0))";
		} else if (modo_totalizar == "A"){
			campo_usado = "v.referencia";
			operacion = " ";
			operacionTotalizadora = "COUNT";
		}else {
			throw Exception
				("Modo de totalizar no soportado: " +
				modo_totalizar);
		}

		// * * * * * * * * * * * * * * * * * * * * * Fín de modo totalizar * * * * * * * * * * * * * * * * * * * * *

		if (prov_princ != " ") {

			condicion_prov_princ.sprintf(" AND ap.proveedor= '%s' ",
			prov_princ);
			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1,
				Respuesta->Id);

			// guarda productos, presentacion de un correspondiente proveedor princial, sucursal, etc
			instruccion = "CREATE TEMPORARY TABLE artprovprinaux (producto VARCHAR(8), present VARCHAR(255),\
					 INDEX(producto, present)) ENGINE = INNODB;";
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf(" \
			SELECT ap.producto, ap.present \
			FROM articulosped ap \
			WHERE 1 %s   \
			GROUP BY ap.producto, ap.present \
			INTO OUTFILE '%s' ", condicion_prov_princ, archivo_temp1);

			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

			instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE artprovprinaux (producto, present) ",
				archivo_temp1);

			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				instruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));
			if(tiposprecios != " "){
				innerjoin_prov_princ.sprintf("INNER JOIN artprovprinaux ap ON ap.producto=a.producto AND ap.present=a.present ");
			} else {
				innerjoin_prov_princ.sprintf("INNER JOIN artprovprinaux ap ON ap.producto=pv.producto AND ap.present=pv.present ");
			}


		}
		if (parte_rela != " ") {
			condicion_parte_rela.sprintf(" AND cli.esparterelac = %s ",
				parte_rela);
		}
		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND pro.fabricante = '%s' ",
				fabricante);
		}

		if(origenventa != " "){
			condicion_origenventa.sprintf(" AND v.tipoorigen IN (%s) ", origenventa);
		}

		if(tiposprecios != " "){
			AnsiString agrupacion, condicion_join;
			if (modo_desglosar == "VE") {
				condicion_join = "dnc.vendedor = v.vendedor";
				agrupacion = "v.vendedor";
			} else if (modo_desglosar == "CF") {
				condicion_join = "dnc.cliente = v.cliente";
				agrupacion = "v.cliente";
			} else if (modo_desglosar == "CA") {
				condicion_join = "dnc.canal = cli.canal";
				agrupacion = "cli.canal";
			} else if (modo_desglosar == "GI") {
				condicion_join = "dnc.giro = cli.giro";
				agrupacion = "cli.giro";
			} else if (modo_desglosar == "SE") {
				condicion_join = "dnc.sector = sect.sector";
				agrupacion = "sect.sector";
			} else if (modo_desglosar == "MU") {
				condicion_join = "dnc.municipio = mu.municipio";
				agrupacion = "mu.municipio";
			} else if (modo_desglosar == "LO") {
				condicion_join = "dnc.localidad = loc.localidad";
				agrupacion = "loc.localidad";
			} else if (modo_desglosar == "FE") {
				condicion_join = "dnc.fechavta = v.fechavta";
				agrupacion = "v.fechavta";
			} else if (modo_desglosar == "FC") {
				condicion_join = "dnc.fechavta = v.fechavta";
				agrupacion = "v.fechavta";
			} else if (modo_desglosar == "SU") {
				condicion_join = "dnc.sucursal = sec.sucursal";
				agrupacion = "sec.sucursal";
			} else if (modo_desglosar == "NO") {
				condicion_join = "dnc.desglosado = 1";
				agrupacion = "desglosado";
			}
			campoproducto = "a.producto";
			campopresent = "a.present";
			innerjoin_precalculo2 = "INNER JOIN presentacionesminmax pmm ON pmm.producto=a.producto AND pmm.present=a.present \
			INNER JOIN productos pro ON pro.producto=a.producto \
			INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
			INNER JOIN articulos amin ON pmm.producto=amin.producto AND pmm.present=amin.present AND pmm.minmult=amin.multiplo";
			join_tipoprecios.sprintf("INNER JOIN dventas dv ON dv.referencia = v.referencia \
			INNER JOIN articulos a ON a.articulo = dv.articulo \
			INNER JOIN productos pro ON pro.producto = a.producto \
			LEFT JOIN ( \
				SELECT \
					1 AS desglosado, \
					v.referencia, \
					v.vendedor, \
					v.cliente, \
					cli.canal, \
					cli.giro, \
					sect.sector, \
					sec.sucursal, \
					mu.municipio, \
					loc.localidad, \
					v.fechavta, \
					SUM(dnc.cantidad * dnc.precioimp) AS totdevimp, \
					SUM(dnc.cantidad * dnc.precio) AS totdev \
				FROM ventas v \
					INNER JOIN dventas dv ON dv.referencia = v.referencia \
					INNER JOIN notascredcli nc ON nc.venta = v.referencia \
					INNER JOIN terminales t ON v.terminal = t.terminal \
					INNER JOIN secciones sec ON t.seccion = sec.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN sectores sect ON sect.sector=col.sector \
					INNER JOIN localidades loc ON loc.localidad=col.localidad \
					INNER JOIN municipios mu ON mu.municipio=loc.municipio \
					INNER JOIN dnotascredcli dnc ON dnc.referencia = nc.referencia AND dv.articulo = dnc.articulo \
					INNER JOIN articulos a ON a.articulo = dnc.articulo \
					INNER JOIN productos pro ON pro.producto = a.producto \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' \
					AND v.cancelado = 0 \
					AND nc.cancelado = 0 \
					AND sec.sucursal IN(%s) \
					AND dv.tipoprec IN (%s) \
					%s \
					%s \
				GROUP BY %s \
			) dnc ON %s ",
			innerjoin_prov_princ,
			fecha_inicial, fecha_final,
			sucursales_ventas, tiposprecios,
			condicion_parte_rela,
			condicion_fabricante,
			agrupacion,
			condicion_join);
			join_tipoprecios2.sprintf("INNER JOIN dventas dv ON dv.referencia = v.referencia \
			INNER JOIN articulos a ON a.articulo = dv.articulo \
			LEFT JOIN ( \
				SELECT \
					a.producto, \
					a.present, \
					dv.articulo, \
					SUM(dnc.cantidad * dnc.precioimp) AS totdevimp, \
					SUM(dnc.cantidad * dnc.precio) AS totdev \
				FROM ventas v \
					INNER JOIN dventas dv ON dv.referencia = v.referencia \
					INNER JOIN notascredcli nc ON nc.venta = v.referencia \
					INNER JOIN terminales t ON v.terminal = t.terminal \
					INNER JOIN secciones sec ON t.seccion = sec.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN dnotascredcli dnc ON dnc.referencia = nc.referencia AND dv.articulo = dnc.articulo \
					INNER JOIN articulos a ON a.articulo = dnc.articulo \
                    INNER JOIN productos pro ON pro.producto = a.producto \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' \
					AND v.cancelado = 0 \
					AND nc.cancelado = 0 \
					AND sec.sucursal IN(%s) \
					AND dv.tipoprec IN (%s) \
					%s \
					%s \
				GROUP BY a.producto, a.present \
			) dnc ON dnc.producto = a.producto AND dnc.present = a.present ",
			innerjoin_prov_princ,
			fecha_inicial, fecha_final,
			sucursales_ventas, tiposprecios,
			condicion_parte_rela,
			condicion_fabricante);
			condicion_tiposprecios.sprintf(" AND dv.tipoprec IN (%s) ", tiposprecios);
			operacionTotalizadora = " ";
			if (modo_totalizar == "S") {
				campo_usado = "SUM(dv.cantidad * dv.precio) - IFNULL(totdev, 0)";
			} else if (modo_totalizar == "T") {
				campo_usado = "SUM(dv.cantidad * dv.precioimp) - IFNULL(totdevimp, 0)";
			}
			operacion = " ";
			campo_usado_2 = " ";
			operacionTotalizadora2=" ";
		} else {
			operacionTotalizadora2="SUM";
			join_tipoprecios2=" ";
			campoproducto = "pv.producto";
			campopresent = "pv.present";
			innerjoin_precalculo2 = "INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
			INNER JOIN productos pro ON pro.producto=pv.producto \
			INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present\
			INNER JOIN articulos amax ON pmm.producto=amax.producto and pmm.present=amax.present and pmm.maxmult=amax.multiplo \
			INNER JOIN articulos amin ON pmm.producto=amin.producto AND pmm.present=amin.present AND pmm.minmult=amin.multiplo";
			innerjoin_precalculo = "INNER JOIN precalculoventasdet pv ON v.referencia=pv.referencia \
			INNER JOIN presentacionesminmax pmm ON pmm.producto=pv.producto AND pmm.present=pv.present \
			INNER JOIN productos pro ON pro.producto=pv.producto ";
		}

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*3);

		if (modo_desglosar == "CF") {
			// CF|Cliente
			campo_iddesglose = "v.cliente";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT v.cliente as iddesglose, cli.rsocial as desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
				   INNER JOIN terminales t ON v.terminal=t.terminal \
				   INNER JOIN secciones sec ON t.seccion=sec.seccion \
				   INNER JOIN clientes cli ON cli.cliente=v.cliente \
				   %s \
				   %s \
				   %s \
				   %s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s \
				%s \
				%s \
				%s \
				GROUP BY v.cliente \
				ORDER BY v.cliente ", 
				operacionTotalizadora, campo_usado, operacion, campo_usado_2,
				innerjoin_precalculo,
				condicion_costos, 
				join_tipoprecios,
				innerjoin_prov_princ,
				fecha_inicial, fecha_final, sucursales_ventas, 
				condicion_parte_rela,
				condicion_fabricante, 
				condicion_origenventa, 
				condicion_tiposprecios);
		} else if (modo_desglosar == "VE") {
			// VE|Vendedor
			campo_iddesglose = "v.vendedor";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT v.vendedor AS iddesglose, concat(emp.nombre, ' ', emp.appat, ' ',emp.apmat) AS desglose, \
				%s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN vendedores vend ON vend.empleado=v.vendedor \
					INNER JOIN empleados emp ON emp.empleado=vend.empleado \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s %s %s %s \
				GROUP BY v.vendedor \
				ORDER BY v.vendedor ",
				operacionTotalizadora, campo_usado, operacion,campo_usado_2,
				innerjoin_precalculo,
				condicion_costos,
				join_tipoprecios,
				innerjoin_prov_princ,
				fecha_inicial, fecha_final, sucursales_ventas,
				condicion_parte_rela, 
				condicion_fabricante, 
				condicion_origenventa, 
				condicion_tiposprecios);
		} else if (modo_desglosar == "CA") {
			// CA|Canal
			campo_iddesglose = "cli.canal";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT ca.canal AS iddesglose, ca.descripcion AS desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					INNER JOIN canalesclientes ca ON cli.canal=ca.canal \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s \
				%s \
				%s \
				%s \
				GROUP BY ca.canal \
				ORDER BY ca.canal ", 
				operacionTotalizadora, campo_usado, operacion, campo_usado_2,
				innerjoin_precalculo,
				innerjoin_prov_princ, 
				condicion_costos, 
				join_tipoprecios,
				fecha_inicial, fecha_final, sucursales_ventas,
				condicion_parte_rela, 
				condicion_fabricante, 
				condicion_origenventa, 
				condicion_tiposprecios);
		} else if (modo_desglosar == "GI") {
			// GI|Giro
			campo_iddesglose = "cli.giro";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
			SELECT gi.giro AS iddesglose, gi.nombre AS desglose, %s(%s%s)%s AS total \
			FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN clientes cli ON cli.cliente=v.cliente \
				INNER JOIN gironegocio gi ON cli.giro=gi.giro \
				%s \
				%s \
				%s \
				%s \
			WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
			%s \
			%s \
			%s \
			%s \
			GROUP BY gi.giro \
			ORDER BY gi.giro ",
			operacionTotalizadora, campo_usado, operacion, campo_usado_2, 
			innerjoin_precalculo,
			innerjoin_prov_princ,
			condicion_costos, 
			join_tipoprecios, 
			fecha_inicial, fecha_final, sucursales_ventas, 
			condicion_parte_rela,
			condicion_fabricante, 
			condicion_origenventa, 
			condicion_tiposprecios);
		} else if (modo_desglosar == "SE") {
			// SE|Sector
			campo_iddesglose = "sect.sector";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN sectores sect ON sect.sector=col.sector \
					INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT sect.sector AS iddesglose, sect.nombre AS desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN sectores sect ON sect.sector=col.sector \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s \
				%s \
				%s \
				%s \
				GROUP BY sect.sector \
				ORDER BY sect.sector ",
				operacionTotalizadora, campo_usado, operacion, campo_usado_2,
				innerjoin_precalculo,
				innerjoin_prov_princ,
				condicion_costos, 
				join_tipoprecios, 
				fecha_inicial, fecha_final, sucursales_ventas, 
				condicion_parte_rela,
				condicion_fabricante, 
				condicion_origenventa, 
				condicion_tiposprecios);
		} else if (modo_desglosar == "MU") {
			// MU|Municipio
			campo_iddesglose = "mu.municipio";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN localidades loc ON loc.localidad=col.localidad \
					INNER JOIN municipios mu ON mu.municipio=loc.municipio \
					INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT mu.municipio AS iddesglose, mu.nombre AS desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN localidades loc ON loc.localidad=col.localidad \
					INNER JOIN municipios mu ON mu.municipio=loc.municipio \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s \
				%s \
				%s \
				%s \
				GROUP BY mu.municipio \
				ORDER BY mu.municipio ", 
				operacionTotalizadora, campo_usado, operacion, campo_usado_2,   
				innerjoin_precalculo,
				innerjoin_prov_princ, 
				condicion_costos, 
				join_tipoprecios,
				fecha_inicial, fecha_final, sucursales_ventas, 
				condicion_parte_rela,
				condicion_fabricante, 
				condicion_origenventa,
				condicion_tiposprecios);
		} else if (modo_desglosar == "LO") {
			// LO|Localidad
			campo_iddesglose = "loc.localidad";
			group_iddesglose = campo_iddesglose;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
				" INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN localidades loc ON loc.localidad=col.localidad \
					INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT loc.localidad AS iddesglose, loc.nombre AS desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					INNER JOIN ventadirent vdir ON v.referencia=vdir.referencia \
					INNER JOIN colonias col ON vdir.colonia=col.colonia \
					INNER JOIN localidades loc ON loc.localidad=col.localidad \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s %s %s %s \
				GROUP BY loc.localidad \
				ORDER BY loc.localidad ", 
				operacionTotalizadora2, campo_usado, operacion, campo_usado_2,    
				innerjoin_precalculo,
				innerjoin_prov_princ, 
				condicion_costos, 
				join_tipoprecios,
				fecha_inicial, fecha_final, sucursales_ventas, 
				condicion_parte_rela,
				condicion_fabricante, 
				condicion_origenventa,
				condicion_tiposprecios);
		} else if (modo_desglosar == "FE") {
			// FE|Fecha
			campo_iddesglose =
			"date_format(v.fechavta, '%Y-%m-%d')";
			group_iddesglose = "v.fechavta";
			order_iddesglose = "v.fechavta";
			joins_desglose =
			" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
				SELECT date_format(v.fechavta, '%%Y-%%m-%%d') AS iddesglose, v.fechavta AS desglose, %s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
				%s \
				%s \
				%s \
				%s \
				GROUP BY v.fechavta \
				ORDER BY v.fechavta ", 
				operacionTotalizadora, campo_usado, operacion, campo_usado_2,            
				innerjoin_precalculo,
				innerjoin_prov_princ, 
				condicion_costos, 
				join_tipoprecios,
				fecha_inicial, fecha_final, sucursales_ventas, 
				condicion_parte_rela,
				condicion_fabricante, 
				condicion_origenventa, 
				condicion_tiposprecios);
		} else if (modo_desglosar == "SU") {
			// SU|Sucursales
			campo_iddesglose = "sec.sucursal";
			group_iddesglose = campo_iddesglose; ;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
			" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
					SELECT suc.sucursal AS iddesglose, suc.nombre AS desglose, %s(%s%s)%s AS total \
					FROM ventas v FORCE INDEX(fechavta) \
						INNER JOIN terminales t ON v.terminal=t.terminal \
						INNER JOIN secciones sec ON t.seccion=sec.seccion \
						INNER JOIN clientes cli ON cli.cliente=v.cliente \
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
						%s \
						%s \
						%s \
						%s \
					WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND suc.sucursal IN (%s) \
					%s \
					%s \
					%s \
					%s \
					GROUP BY sec.sucursal \
					ORDER BY sec.sucursal ",
			operacionTotalizadora2, campo_usado, operacion, campo_usado_2,
			innerjoin_precalculo,
			innerjoin_prov_princ, 
			condicion_costos, 
			join_tipoprecios,
			fecha_inicial, fecha_final, sucursales_ventas, 
			condicion_parte_rela,
			condicion_fabricante, 
			condicion_origenventa, 
			condicion_tiposprecios);
		} else if (modo_desglosar == "FC") {
			// FE|Fechas Completas
			campo_iddesglose =
			"date_format(v.fechavta, '%Y-%m-%d')";
			group_iddesglose = "v.fechavta";
			order_iddesglose = "v.fechavta";
			joins_desglose =
			" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
			( \
				SELECT \
					date_format(v.fechavta, '%%Y-%%m-%%d') AS iddesglose, \
					v.fechavta AS desglose, \
					%s(%s%s)%s AS total \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					%s \
					%s \
					%s \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
					%s \
					%s \
					%s \
					%s \
				GROUP BY v.fechavta \
			) UNION ALL ( \
				SELECT \
					fechas_completas.fechadia AS iddesglose, \
					fechas_completas.fechadia AS fechaTotal, \
					COALESCE(fechas_total.total, 0) AS Total \
				FROM ( \
					SELECT fechadia \
					FROM fechasdias \
					WHERE fechadia BETWEEN '%s' AND '%s' \
				) AS fechas_completas \
				LEFT JOIN ( \
					SELECT \
						date_format(v.fechavta, '%%Y-%%m-%%d') AS iddesglose, \
						v.fechavta AS desglose, \
						%s(%s%s)%s AS total \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN clientes cli ON cli.cliente=v.cliente \
					%s \
					%s \
					%s \
					%s \
					WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
						%s \
						%s \
						%s \
						%s \
					GROUP BY v.fechavta \
					ORDER BY v.fechavta \
				) AS fechas_total ON fechas_completas.fechadia = fechas_total.iddesglose   \
				WHERE fechas_total.iddesglose IS NULL \
			) ORDER BY iddesglose", 
			operacionTotalizadora, campo_usado, operacion, campo_usado_2,
			innerjoin_precalculo,
			innerjoin_prov_princ,
			condicion_costos,
			join_tipoprecios,
			fecha_inicial, fecha_final, sucursales_ventas,
			condicion_parte_rela,
			condicion_fabricante,
			condicion_origenventa,
			condicion_tiposprecios,
			fecha_inicial, fecha_final,
			operacionTotalizadora, campo_usado, operacion, campo_usado_2,
			innerjoin_precalculo,
			innerjoin_prov_princ,
			condicion_costos,
			join_tipoprecios,
			fecha_inicial, fecha_final, sucursales_ventas,
			condicion_parte_rela,
			condicion_fabricante,
			condicion_origenventa,
			condicion_tiposprecios);
		} else if (modo_desglosar == "NO") {

			campo_iddesglose = "1";
			group_iddesglose = campo_iddesglose; ;
			order_iddesglose = campo_iddesglose;
			joins_desglose =
			" INNER JOIN clientes cli ON cli.cliente=v.cliente ";
			instruccion.sprintf(" \
			SELECT 1 AS iddesglose, 1 AS desglose, %s(%s%s)%s AS total \
			FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN terminales t ON v.terminal=t.terminal \
				INNER JOIN secciones sec ON t.seccion=sec.seccion \
				INNER JOIN clientes cli ON cli.cliente=v.cliente \
				%s \
				%s \
				%s \
				%s \
			WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
			%s \
			%s \
			%s \
			%s ",
			operacionTotalizadora, campo_usado, operacion, campo_usado_2,
			innerjoin_precalculo,
			innerjoin_prov_princ,
			condicion_costos,
			join_tipoprecios,
			fecha_inicial, fecha_final, sucursales_ventas,
			condicion_parte_rela,
			condicion_fabricante,
			condicion_origenventa,
			condicion_tiposprecios);
		} else {
			throw Exception("Modo de desglosar no soportado: " + modo_desglosar);
		}

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

		// Creamos una tabla temporal con la relación de articulos unificados, para evitar que se repitan para un artículo
		// en caso de repetición se deja la clave máxima (alfabéticamente).
		instruccion =
			"CREATE temporary TABLE articulosunifaux ( " "articulo VARCHAR(9) NULL DEFAULT NULL COLLATE 'latin1_swedish_ci', "
			"articulorem VARCHAR(9) NOT NULL COLLATE 'latin1_swedish_ci', " "PRIMARY KEY (articulo) USING BTREE, "
			"INDEX articulorem (articulorem) USING BTREE " ") COLLATE='latin1_swedish_ci' ENGINE=InnoDB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));
		instruccion =
			"INSERT INTO articulosunifaux (articulo, articulorem) " "SELECT au.articulo, max(au.articulorem) AS articulorem "
			"from articulosunif au " "WHERE articulo IS NOT null "
			"GROUP BY articulo ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf(" \
			SELECT amax.articulo AS noarticulo \
			 , COALESCE(CONCAT(LEAST(au.articulo,au.articulorem),'-', GREATEST(au.articulo,au.articulorem)), \
				CONCAT(LEAST(au2.articulo,au2.articulorem),'-', GREATEST(au2.articulo,au2.articulorem)), \
				amax.articulo) AS idunificado \
			 , %s \
			 , pro.nombre \
			 , %s \
			 , amax.factor AS factormax \
			 , pmm.cajalogisticafactor \
			 , amax.multiplo AS multiplomax \
			 , if(pmm.cajalogisticafactor<>amax.factor,'SI','NO') as usacajalogistica \
			 , %s(%s%s)%s AS total \
			 , %s AS iddesglose \
			FROM ventas v FORCE INDEX(fechavta) \
			   INNER JOIN terminales t ON v.terminal=t.terminal \
			   INNER JOIN secciones sec ON t.seccion=sec.seccion \
			   %s \
			   %s \
			   %s \
			   LEFT JOIN articulosunifaux au ON au.articulo=amax.articulo \
			   LEFT JOIN articulosunifaux au2 ON au2.articulo=amin.articulo \
			   %s \
			   %s \
			WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 AND sec.sucursal IN (%s) \
			%s \
			%s \
			%s \
			%s \
			GROUP BY %s, %s, %s \
			ORDER BY pro.nombre, %s, %s ",
			campoproducto,
			campopresent,
			operacionTotalizadora, campo_usado, operacion, campo_usado_2,
			campo_iddesglose,
			join_tipoprecios2,
			innerjoin_precalculo2,
			joins_desglose,
			innerjoin_prov_princ,
			condicion_costos,
			fecha_inicial, fecha_final, sucursales_ventas,
			condicion_parte_rela,
			condicion_fabricante,
			condicion_origenventa,
			condicion_tiposprecios,
			campoproducto, campopresent, group_iddesglose,
			campopresent, order_iddesglose);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		if (prov_princ != " " && archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}

	}

}
// ---------------------------------------------------------------------------

// ID_EJE_REPPREC_DIFERID
void ServidorReportes::EjecutaRepActualizaPreciosDiferidos
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[20];
	AnsiString producto = " ", tipo_precio = " ", hora = " ",
		condicion_producto, condicion_hora;
	AnsiString marca, fabricante, segCompra, clasifMaestra, clasifGeneral,
		clasifEspecif;
	AnsiString condicion_marca = " ", condicion_fabricante = " ",
		condicion_segCompra = " ";
	AnsiString join_presentacion1 = " ";

	AnsiString condicion_clasifMaestra = " ", condicion_clasifGeneral = " ",
		condicion_clasifEspecif = " ";
	AnsiString tipoprecio;
	AnsiString condicion_tipoprecio = " ";
	AnsiString deprecioactual, aprecioactual;
	AnsiString deprecioprox, aprecioprox;
	AnsiString condicion_precioactual = " ", condicion_precioproximo = " ";
	double diferencia, porcdif;
	AnsiString condicion_diferencia = " ", condicion_porcdif = " ";
	BufferRespuestas* resp_almacenes = NULL;
	BufferRespuestas* resp_sucursales = NULL;
	AnsiString sucursal, fecha_inicial, fecha_final, porcentaje;
	AnsiString redondearprecio;
	AnsiString campo_preciomod;
	AnsiString mostrarpreconfig;
	AnsiString supervisadopor;
	AnsiString condicion_mostrarpreconfig = " ";
	AnsiString condicion_supervisadopor = " ";
	char *resultado;

	AnsiString lista;
	AnsiString inner_join_tags = " ";
	AnsiString condicion_tags = " ";

	AnsiString desde1, hasta1, redondeo1;
	AnsiString desde2, hasta2, redondeo2;
	AnsiString desde3, hasta3, redondeo3;
	AnsiString desde4, hasta4, redondeo4;
	AnsiString idempresa;

	AnsiString tipoutilidad, precio, campo_tipoutilidad;
	AnsiString inner_tipoutilidad = " ";

	AnsiString diasMod = "0";

	producto = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_precio = mFg.ExtraeStringDeBuffer(&parametros);
	hora = mFg.ExtraeStringDeBuffer(&parametros);
	marca = mFg.ExtraeStringDeBuffer(&parametros);
	fabricante = mFg.ExtraeStringDeBuffer(&parametros);
	segCompra = mFg.ExtraeStringDeBuffer(&parametros);
	clasifMaestra = mFg.ExtraeStringDeBuffer(&parametros);
	clasifGeneral = mFg.ExtraeStringDeBuffer(&parametros);
	clasifEspecif = mFg.ExtraeStringDeBuffer(&parametros);
	lista = mFg.ExtraeStringDeBuffer(&parametros);
	tipoprecio = mFg.ExtraeStringDeBuffer(&parametros);
	diferencia = StrToFloat(mFg.ExtraeStringDeBuffer(&parametros));
	porcdif = StrToFloat(mFg.ExtraeStringDeBuffer(&parametros));
	deprecioactual = mFg.ExtraeStringDeBuffer(&parametros);
	aprecioactual = mFg.ExtraeStringDeBuffer(&parametros);
	deprecioprox = mFg.ExtraeStringDeBuffer(&parametros);
	aprecioprox = mFg.ExtraeStringDeBuffer(&parametros);
	redondearprecio = mFg.ExtraeStringDeBuffer(&parametros);
	desde1 = mFg.ExtraeStringDeBuffer(&parametros);
	hasta1 = mFg.ExtraeStringDeBuffer(&parametros);
	redondeo1 = mFg.ExtraeStringDeBuffer(&parametros);
	desde2 = mFg.ExtraeStringDeBuffer(&parametros);
	hasta2 = mFg.ExtraeStringDeBuffer(&parametros);
	redondeo2 = mFg.ExtraeStringDeBuffer(&parametros);
	desde3 = mFg.ExtraeStringDeBuffer(&parametros);
	hasta3 = mFg.ExtraeStringDeBuffer(&parametros);
	redondeo3 = mFg.ExtraeStringDeBuffer(&parametros);
	desde4 = mFg.ExtraeStringDeBuffer(&parametros);
	hasta4 = mFg.ExtraeStringDeBuffer(&parametros);
	redondeo4 = mFg.ExtraeStringDeBuffer(&parametros);
	tipoutilidad = mFg.ExtraeStringDeBuffer(&parametros);
	mostrarpreconfig = mFg.ExtraeStringDeBuffer(&parametros);
	supervisadopor = mFg.ExtraeStringDeBuffer(&parametros);
	idempresa = mFg.ExtraeStringDeBuffer(&parametros);

	BufferRespuestas* resp_parametro = NULL;
	try {
		instruccion.sprintf(
			"SELECT valor FROM parametrosglobemp where parametro = 'DIASPRECMOD' AND idempresa = %s ", idempresa);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_parametro);
		diasMod = resp_parametro->ObtieneDato("valor");
	}
	__finally {
		if (resp_parametro != NULL)
			delete resp_parametro;
	}

	if (producto != " ") {
		condicion_producto.sprintf(" and pro.producto='%s' ", producto);
	}
	else
		condicion_producto = " ";

	if (hora != " ") {
		condicion_hora.sprintf
			(" and (precios.fechamodiprox < CURDATE() OR precios.horamodiprox <= '%s') ",
			hora);
	}
	else {
		condicion_hora = " ";
	}

	if (marca != " ") {
		condicion_marca.sprintf(" AND pro.marca = '%s' ", marca);
	}

	if (fabricante != " ") {
		condicion_fabricante.sprintf(" AND pro.fabricante = '%s' ", fabricante);
	}
	// Usaremos el segmento de presentacion
	if (segCompra != " ") {

		condicion_segCompra.sprintf(" AND present.segmento='%s' ", segCompra);
		join_presentacion1 =
			" INNER JOIN presentaciones present ON present.producto=a.producto AND present.present=a.present ";

	}

	if (clasifMaestra != " ") {
		condicion_clasifMaestra.sprintf(" AND pro.clasif1 = '%s' ",
			clasifMaestra);
	}

	if (clasifGeneral != " ") {
		condicion_clasifGeneral.sprintf(" AND pro.clasif2 = '%s' ",
			clasifGeneral);
	}

	if (clasifEspecif != " ") {
		condicion_clasifEspecif.sprintf(" AND pro.clasif3 = '%s' ",
			clasifEspecif);
	}

	if (lista != " ") {
		inner_join_tags =
			" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present ";
		condicion_tags.sprintf(" AND idarticulotag in (%s) ", lista);
	}

	if (tipoprecio != " ") {
		condicion_tipoprecio.sprintf(" AND a.tipoprec IN(%s) ", tipoprecio);
	}

	if (diferencia > 0) {
		condicion_diferencia.sprintf
			(" AND (a.diferencia >= %f OR a.diferencia <= %f) ", diferencia,
			diferencia*-1);
	}

	if (porcdif > 0) {
		condicion_porcdif.sprintf
			(" AND (a.porcdiferencia >= %f OR a.porcdiferencia <= %f) ",
			porcdif, porcdif*-1);
	}

	if (deprecioactual != " " && aprecioactual != " ") {
		condicion_precioactual.sprintf(" AND (a.precio BETWEEN %s AND %s) ",
			deprecioactual, aprecioactual);
	}

	if (deprecioprox != " " && aprecioprox != " ") {
		condicion_precioproximo.sprintf
			(" AND (a.precioproximo BETWEEN %s AND %s) ", deprecioprox,
			aprecioprox);
	}

	if (tipoutilidad != " ") {
		inner_tipoutilidad =
			"INNER JOIN tmputilidadesprecios apre ON apre.articulo = a.articulo AND apre.tipoprec = a.tipoprec";
		precio = "apre.precioutil";
		if (tipoutilidad == "1") {
			campo_tipoutilidad = "tpre.porcutil";
		}
		else if (tipoutilidad == "2") {
			campo_tipoutilidad = "tpre.porcutil2";
		}
		else if (tipoutilidad == "3") {
			campo_tipoutilidad = "tpre.porcutil3";
		}
		else if (tipoutilidad == "4") {
			campo_tipoutilidad = "tpre.porcutil4";
		}
		else if (tipoutilidad == "5") {
			campo_tipoutilidad = "tpre.porcutil5";
		}
	}
	else {
		precio = "a.precioproximo";
	}

	if (redondearprecio == "1") {

		campo_preciomod.sprintf("(CASE WHEN MOD(%s,1) = 0.0 THEN %s ELSE \
		CASE WHEN MOD(%s,1) >=%s AND MOD(%s,1) <=%s THEN ((%s-MOD(%s,1))+%s) ELSE \
		CASE WHEN MOD(%s,1) >=%s AND MOD(%s,1) <=%s THEN ((%s-MOD(%s,1))+%s) ELSE \
		CASE WHEN MOD(%s,1) >=%s AND MOD(%s,1) <=%s THEN ((%s-MOD(%s,1))+%s) ELSE \
		CASE WHEN MOD(%s,1) >=%s AND MOD(%s,1) <=%s THEN ((%s-MOD(%s,1))+%s) END END END END END)"
			, precio, precio, precio, desde1, precio, hasta1, redondeo1, precio,
			precio, precio, desde2, precio, hasta2, redondeo2, precio, precio,
			precio, desde3, precio, hasta3, redondeo3, precio, precio, precio,
			desde4, precio, hasta4, redondeo4, precio, precio);
	}
	else {
		campo_preciomod.sprintf("%s", precio);
	}

	if (mostrarpreconfig == "0") {
		condicion_mostrarpreconfig.sprintf(" AND (a.actuprecauto IS NULL OR a.actuprecauto = 0) ");
	} else if (mostrarpreconfig == "1") {
		condicion_mostrarpreconfig.sprintf(" AND a.actuprecauto = 1 ");
	}

	if (supervisadopor != " ") {
		condicion_supervisadopor.sprintf(" AND ars.usuario='%s' ",
			supervisadopor);
	}

	try {
		/////Tabla temporal, la cual contendrá los valores mínimos y maximos de los artículos vendidos
		instruccion = "CREATE TEMPORARY TABLE auxpreciosdiferidos  ( \
					nombre VARCHAR(60), \
					producto VARCHAR(8), \
					present VARCHAR(255), \
					multiplo VARCHAR(10), \
					tipoprec VARCHAR(2), \
					precio DECIMAL(16,6), \
					precioproximo DECIMAL(16,6), \
					preciomod DECIMAL(16,6), \
					diferencia DECIMAL(16,6), \
					porcdiferencia DECIMAL(12,2), \
					articulo VARCHAR(9), \
					actuprecauto TINYINT, \
					costo DECIMAL(12,2), INDEX(present), INDEX(articulo) \
					)ENGINE=InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		/////Tabla temporal, la cual contendrá los valores mínimos y maximos de los artículos vendidos
		instruccion = "CREATE TEMPORARY TABLE auxpreciosdiferidos2  ( \
					nombre VARCHAR(60), \
					producto VARCHAR(8), \
					present VARCHAR(255), \
					multiplo VARCHAR(10), \
					tipoprec VARCHAR(2), \
					precio DECIMAL(16,6), \
					precioproximo DECIMAL(16,6), \
					preciomod DECIMAL(16,6), \
					diferencia DECIMAL(16,6), \
					porcdiferencia DECIMAL(12,2), \
					articulo VARCHAR(9), \
					actuprecauto TINYINT, \
					costo DECIMAL(12,2), INDEX(present), INDEX(articulo) \
					)ENGINE=InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		if (tipoutilidad != " ") {

			BufferRespuestas* res_digitosredondeo = NULL;
			AnsiString redondeo;
			try {
				instruccion.sprintf(
					"SELECT valor FROM parametrosemp where parametro = 'DIGREDOND' AND sucursal = '%s' ", FormServidor->ObtieneClaveSucursal());
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), res_digitosredondeo);
				redondeo = res_digitosredondeo->ObtieneDato("valor");
			}
			__finally {
				if (res_digitosredondeo != NULL)
					delete res_digitosredondeo;
			}

			/////Tabla temporal para guardar los precios calculados en base al porcentaje de utilidad
			instruccion = "CREATE TEMPORARY TABLE tmputilidadesprecios ( \
			articulo VARCHAR(9), \
			producto VARCHAR(8), \
			present VARCHAR(255), \
			tipoprec VARCHAR(2), \
			precioutil DECIMAL(16,6), INDEX(articulo), INDEX(tipoprec) \
			)ENGINE=InnoDB";
			instrucciones[num_instrucciones++] = instruccion;

			/////se agregan los articulos con precio diferente y que sean precio 03  que viene el en parametro tipo_precio
			instruccion.sprintf("INSERT INTO tmputilidadesprecios \
			SELECT \
				a.articulo, \
				a.producto, \
				a.present, \
				pre.tipoprec, \
				ROUND(ROUND((1+%s/100)*costo, %s)*a.factor, %s) AS precioutil \
			FROM articulos a \
			INNER JOIN precios pre ON pre.articulo = a.articulo \
			INNER JOIN tiposdeprecios tpre ON tpre.tipoprec = pre.tipoprec AND tpre.idempresa=%s ",
				campo_tipoutilidad, redondeo, redondeo, idempresa);
			instrucciones[num_instrucciones++] = instruccion;
		}

		/////se agregan los articulos con precio diferente y que sean precio 03  que viene el en parametro tipo_precio
		instruccion.sprintf("INSERT INTO auxpreciosdiferidos(nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
							 diferencia, porcdiferencia, articulo, actuprecauto, costo) \
					SELECT pro.nombre, a.producto, a.present, a.multiplo, precios.tipoprec, precios.precio, precios.precioproximo, precios.preciomod, \
						(precios.precioproximo-precios.precio) AS diferencia, \
						CAST((ABS(precios.precioproximo-precios.precio)*100)/precios.precio AS DECIMAL(12,2)) AS porcdiferencia ,precios.articulo, \
						precios.actualizarpendiente, pre.costobase \
					FROM precios \
					INNER JOIN articulos a ON precios.articulo=a.articulo \
					INNER JOIN productos pro ON a.producto=pro.producto \
					%s %s \
					LEFT JOIN tiposdeprecios tp ON precios.tipoprec=tp.tipoprec AND tp.idempresa=%s \
					LEFT JOIN articulossupervisados ars ON ars.producto=a.producto and ars.present=a.present \
					LEFT JOIN presentacionescb pre ON pre.producto=a.producto and pre.present=a.present \
					WHERE a.activo=1 AND tp.verprecdif<>0  \
					AND precios.precio<>0 AND precios.tipoprec='%s' AND pre.idempresa=%s %s %s %s %s %s %s %s %s %s %s \
					AND CURDATE() >= DATE_SUB(precios.fechamodi, INTERVAL - %s DAY) \
					HAVING ABS(diferencia)>(SELECT valor from parametrosemp where parametro='DIFMINPRECDIF' AND sucursal = '%s' ) \
					LIMIT 3000", join_presentacion1, inner_join_tags, idempresa,
			tipo_precio,idempresa, condicion_producto, condicion_hora, condicion_marca,
			condicion_fabricante, condicion_segCompra, condicion_clasifMaestra,
			condicion_clasifGeneral, condicion_clasifEspecif, condicion_tags,
			condicion_supervisadopor, diasMod, FormServidor->ObtieneClaveSucursal() );
		instrucciones[num_instrucciones++] = instruccion;

		/////se agregan los articulos con precio diferente y que sean precio 03  que viene el en parametro tipo_precio
		instruccion.sprintf("INSERT INTO auxpreciosdiferidos2(nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
							 diferencia, porcdiferencia, articulo, actuprecauto, costo) \
					SELECT nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
							 diferencia, porcdiferencia, articulo, actuprecauto, costo \
					FROM auxpreciosdiferidos");
		instrucciones[num_instrucciones++] = instruccion;

		/////se agregan los articulos con precio diferente a precio 03 (que viene el en parametro tipo_precio) y que sean reelevantes en el cambio
		instruccion.sprintf("INSERT INTO auxpreciosdiferidos(nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
				 diferencia, porcdiferencia, articulo, actuprecauto, costo) \
		SELECT pro.nombre, a.producto, a.present, a.multiplo, precios.tipoprec, precios.precio, precios.precioproximo, precios.preciomod, \
			(precios.precioproximo-precios.precio) AS diferencia, \
			CAST((ABS(precios.precioproximo-precios.precio)*100)/precios.precio AS DECIMAL(12,2)) AS porcdiferencia ,precios.articulo, \
			precios.actualizarpendiente, pre.costobase \
		FROM precios \
		INNER JOIN articulos a ON precios.articulo=a.articulo \
		INNER JOIN productos pro ON a.producto=pro.producto \
		INNER JOIN auxpreciosdiferidos2 AS aux on aux.articulo=a.articulo \
		LEFT JOIN tiposdeprecios tp ON precios.tipoprec=tp.tipoprec AND tp.idempresa=%s \
		LEFT JOIN presentacionescb pre ON pre.producto=a.producto and pre.present=a.present\
		WHERE a.activo=1 AND tp.verprecdif<>0 \
		AND precios.precio<>0 AND precios.tipoprec<>'%s' AND pre.idempresa=%s \
		 and (ABS(precios.precioproximo-precios.precio)> ABS(aux.diferencia)+0.1 AND \
			CAST((ABS(precios.precioproximo-precios.precio)*100)/precios.precio AS DECIMAL(12,2))> aux.porcdiferencia+0.1) \
					AND CURDATE() >= DATE_SUB(precios.fechamodi, INTERVAL - %s DAY)  \
		HAVING ABS(diferencia)>(SELECT valor from parametrosemp where parametro='DIFMINPRECDIF' AND sucursal = '%s' ) ",
			idempresa, tipo_precio, idempresa,
			diasMod, FormServidor->ObtieneClaveSucursal());
		instrucciones[num_instrucciones++] = instruccion;

		/////se agregan los articulos con precio diferente y que sean precio 03  que viene el en parametro tipo_precio
		instruccion.sprintf("DELETE FROM auxpreciosdiferidos2 ");
		instrucciones[num_instrucciones++] = instruccion;

		/////se agregan los articulos con precio diferente y que sean precio 03  que viene el en parametro tipo_precio
		instruccion.sprintf("INSERT INTO auxpreciosdiferidos2(nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
							 diferencia, porcdiferencia, articulo, actuprecauto, costo) \
					SELECT nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
							 diferencia, porcdiferencia, articulo, actuprecauto, costo \
					FROM auxpreciosdiferidos ");
		instrucciones[num_instrucciones++] = instruccion;

		/////se agregan los articulos con precio diferente a precio 03 (que viene el en parametro tipo_precio) y que sean reelevantes en el cambio que no estén en la consulta anterior
		instruccion.sprintf("INSERT INTO auxpreciosdiferidos(nombre, producto, present, multiplo, tipoprec, precio, precioproximo, preciomod, \
			 diferencia, porcdiferencia, articulo, actuprecauto, costo) \
		SELECT pro.nombre, a.producto, a.present, a.multiplo, precios.tipoprec, precios.precio, precios.precioproximo, precios.preciomod, \
			(precios.precioproximo-precios.precio) AS diferencia, \
			CAST((ABS(precios.precioproximo-precios.precio)*100)/precios.precio AS DECIMAL(12,2)) AS porcdiferencia ,precios.articulo, \
			precios.actualizarpendiente, pre.costobase \
		FROM precios \
		INNER JOIN articulos a ON precios.articulo=a.articulo \
		INNER JOIN productos pro ON a.producto=pro.producto \
		%s %s \
		LEFT JOIN tiposdeprecios tp ON precios.tipoprec=tp.tipoprec AND tp.idempresa=%s \
		LEFT JOIN articulossupervisados ars ON ars.producto=a.producto and ars.present=a.present \
		LEFT JOIN presentacionescb pre ON pre.producto=a.producto and pre.present=a.present \
		WHERE a.activo=1 AND tp.verprecdif<>0  \
		AND precios.precio<>0 AND precios.tipoprec<>'%s' and pre.idempresa=%s %s %s %s %s %s %s %s %s %s %s \
		 and a.articulo not in(select articulo from auxpreciosdiferidos2) \
					AND CURDATE() >= DATE_SUB(precios.fechamodi, INTERVAL - %s DAY) \
		HAVING ABS(diferencia)>(SELECT valor from parametrosemp where parametro='DIFMINPRECDIF' AND sucursal = '%s' )"
			, join_presentacion1, inner_join_tags, idempresa,
			tipo_precio, idempresa,
			condicion_producto, condicion_hora, condicion_marca,
			condicion_fabricante, condicion_segCompra, condicion_clasifMaestra,
			condicion_clasifGeneral, condicion_clasifEspecif, condicion_tags,
			condicion_supervisadopor, diasMod,  FormServidor->ObtieneClaveSucursal());
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// Resultado final
			instruccion.sprintf(" select a.articulo, a.nombre, a.producto, a.present, a.multiplo, \
			a.tipoprec, a.precio, a.precioproximo, %s AS preciomod, a.diferencia, a.porcdiferencia, a.actuprecauto, a.costo \
			from auxpreciosdiferidos a \
			%s \
			WHERE a.articulo NOT IN (SELECT a.articulo \
			FROM preciosbloqueados p \
			INNER JOIN articulos a ON a.producto = p.producto AND a.present = p.present \
			WHERE CURDATE() <= p.fechaVigencia and p.idempresa=%s ) \
			%s %s %s %s %s %s \
			HAVING a.precio <> preciomod \
			ORDER BY a.porcdiferencia DESC , a.precio ", campo_preciomod,
				inner_tipoutilidad, idempresa,
				condicion_tipoprecio, condicion_diferencia,
				condicion_porcdif, condicion_precioactual,
				condicion_precioproximo, condicion_mostrarpreconfig);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			// Resultado final
			instruccion.sprintf(" SELECT  DISTINCT a.producto, a.present \
					from auxpreciosdiferidos as p \
					inner join articulos a ON p.articulo=a.articulo \
					order by a.producto, a.present ");
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}

	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;

		delete buffer_sql;
	}

}

// ID_REP_CLASIF_EN_PLANTILLAS
void ServidorReportes::EjecutaRepClasificacionEnPlantillas
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	// Obtener el reporte general
	instruccion.sprintf("SELECT clasif1,clasif2, clasif3, clasifcont, clasifcont2, \
		GROUP_CONCAT(DISTINCT tipocomprobante ORDER BY tipocomprobante) AS tiposcomprobantes, \
		GROUP_CONCAT(DISTINCT sucursal ORDER BY sucursal) AS sucursales, \
		GROUP_CONCAT(DISTINCT tipoplantilla ORDER BY tipoplantilla) AS tipoplantillas, \
		GROUP_CONCAT(DISTINCT tipopartida ORDER BY tipopartida) AS tipopartidas, \
		GROUP_CONCAT(DISTINCT expresion ORDER BY expresion) AS expresiones \
		FROM plantillaspoliz \
		WHERE clasif1<>'' OR clasif2<>'' OR clasif3<>'' OR clasifcont<>'' OR clasifcont2<>'' \
		GROUP BY clasif1, clasif2, clasif3, clasifcont, clasifcont2");
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	// Obtener el reporte detallado
	instruccion.sprintf("SELECT DISTINCT orden,clasif1,clasif2, clasif3, clasifcont, clasifcont2, \
		tipocomprobante, \
		sucursal, \
		tipoplantilla, \
		tipopartida, \
		expresion \
		FROM plantillaspoliz \
		WHERE clasif1<>'' OR clasif2<>'' OR clasif3<>'' OR clasifcont<>'' OR clasifcont2<>'' \
		ORDER BY clasif1, clasif2, clasif3, clasifcont, clasifcont2, tipocomprobante, tipoplantilla, sucursal"
		);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOMOVALM_EXT
void ServidorReportes::EjecutaRepCostoMovExt(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fecha_inicial, fecha_final, tipo, concepto, sucursal, almacen,
		clasif1, clasif2, clasif3, producto, movimiento;
	int agrconcepto = 0;
	AnsiString condicion_tipo = " ", condicion_concepto = " ",
		condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_producto = " ", condicion_movimiento = " ",
		condicion_clasif = " ", condicion_almacen = " ",
		condicion_concepto2 = " ";

	AnsiString cad_conjunto_almacenes = " ";

	BufferRespuestas* resp_almacenes = NULL;
	try {
		try {

			fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
			fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
			tipo = mFg.ExtraeStringDeBuffer(&parametros);
			concepto = mFg.ExtraeStringDeBuffer(&parametros);
			sucursal = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa una sucursal entonces el almacen debe ser " "
			almacen = mFg.ExtraeStringDeBuffer(&parametros); // Si se pasa un almacen entonces la sucursal debe ser " "
			clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
			clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
			clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
			producto = mFg.ExtraeStringDeBuffer(&parametros);
			movimiento = mFg.ExtraeStringDeBuffer(&parametros);
			agrconcepto = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

			if (tipo != " ") {
				condicion_tipo.sprintf(" AND m.tipo = '%s' ", tipo);
			}
			if (concepto != " ") {
				condicion_concepto.sprintf(" AND m.concepto IN(%s) ", concepto);
				condicion_concepto2.sprintf(" AND c.concepto IN(%s) ",
					concepto);
			}
			if (almacen != " ") {
				cad_conjunto_almacenes = "'" + almacen + "'";
			}
			else {
				if (sucursal != " " && sucursal != "' '") {
					instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion \
						WHERE s.sucursal IN (%s)", sucursal);
					mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
						instruccion.c_str(), resp_almacenes);
					for (int i = 0;
					i < resp_almacenes->ObtieneNumRegistros(); i++) {
						resp_almacenes->IrAlRegistroNumero(i);
						almacen = resp_almacenes->ObtieneDato("almacen");

						cad_conjunto_almacenes += "'";
						cad_conjunto_almacenes += almacen;
						cad_conjunto_almacenes += "'";
						if (i < resp_almacenes->ObtieneNumRegistros() - 1)
							// A todos menos al ultimo impuesto le signo +.
								cad_conjunto_almacenes += ",";
					}
				}
			}
			if (clasif3 != " ") {
				condicion_clasif.sprintf(" AND prod.clasif3 = '%s' ", clasif3);
			}
			else {
				if (clasif2 != " ") {
					condicion_clasif.sprintf(" AND prod.clasif2 = '%s' ",
						clasif2);
				}
				else {
					if (clasif1 != " ") {
						condicion_clasif.sprintf(" AND prod.clasif1 = '%s' ",
							clasif1);
					}
				}
			}
			if (producto != " ") {
				condicion_producto.sprintf(" AND pm.producto = '%s' ",
				producto);
			}
			if (movimiento != " ") {
				condicion_movimiento.sprintf(" AND pm.movimiento = '%s' ",
					movimiento);
			}
			if (cad_conjunto_almacenes != " ") {
				condicion_almacen.sprintf(" AND pm.almacen IN (%s) ",
					cad_conjunto_almacenes);
			}

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (agrconcepto == 1) {
				// Resultado final
				instruccion.sprintf("SELECT t.concepto, t.tipo, t.descripcion, SUM(t.costo) AS costo FROM (  \
				(SELECT                                                                                      \
				c.concepto,                                                                                  \
				c.tipomov,                                                                                   \
				(CASE WHEN c.tipomov=0 THEN 'ENTRADA' WHEN c.tipomov=1 THEN 'SALIDA'                         \
				WHEN c.tipomov=2 THEN 'TRASPASO' WHEN c.tipomov=3 THEN 'TRANSFORM.' END) AS tipo,            \
				c.descripcion,                                                                               \
				SUM(pm.costomov) AS costo                                                                    \
				FROM conceptosmovalma c                                                                      \
				INNER JOIN movalma m ON c.concepto = m.concepto                                              \
				INNER JOIN precalculocostosmovalmadet pm ON m.movimiento = pm.movimiento                     \
				INNER JOIN productos prod ON pm.producto = prod.producto                                     \
				WHERE m.fechamov BETWEEN '%s' AND '%s'                                                       \
				AND m.cancelado = 0                                                                          \
				AND m.aplica = 1                                                                             \
				%s %s %s %s %s %s                                                                            \
				GROUP BY c.concepto)                                                                         \
				UNION ALL                                                                                    \
				(SELECT                                                                                      \
				c.concepto,                                                                                  \
				c.tipomov,                                                                                   \
				(CASE WHEN c.tipomov=0 THEN 'ENTRADA' WHEN c.tipomov=1 THEN 'SALIDA'                         \
				WHEN c.tipomov=2 THEN 'TRASPASO' WHEN c.tipomov=3 THEN 'TRANSFORM.' END) AS tipo,            \
				c.descripcion,                                                                               \
				0 AS costo                                                                                   \
				FROM conceptosmovalma c                                                                      \
				WHERE 1 %s                                                                                   \
				GROUP BY c.concepto)                                                                         \
				) t                                                                                          \
				GROUP BY t.concepto                                                                          \
				ORDER BY t.tipomov, t.descripcion", fecha_inicial, fecha_final,
					condicion_concepto2, condicion_almacen, condicion_tipo,
					condicion_clasif, condicion_producto, condicion_movimiento,
					condicion_concepto2);
			}
			else if (agrconcepto == 0) {

				// Resultado final
				instruccion.sprintf("SELECT                                              \
				SUM(pm.cantidad),                                   		 			 \
				prod.nombre,                                       						 \
				pm.present,                                           					 \
				SUM(pm.costomov) AS costo,                                             	 \
				pm.producto                                               				 \
				FROM movalma m                                                           \
				INNER JOIN precalculocostosmovalmadet pm ON pm.movimiento = m.movimiento \
				INNER JOIN productos prod ON pm.producto = prod.producto                 \
				WHERE m.fechamov BETWEEN '%s' AND '%s'                                   \
				AND m.cancelado = 0                                                      \
				AND m.aplica = 1                                                         \
				%s %s %s %s %s %s                                                        \
				GROUP BY pm.producto, pm.present                                         \
				HAVING (SUM(pm.cantidad) <> 0 OR ROUND(SUM(pm.costomov),2) <> 0)         \
				ORDER BY prod.nombre, pm.present ASC", fecha_inicial,
					fecha_final, condicion_concepto, condicion_almacen,
					condicion_tipo, condicion_clasif, condicion_producto,
					condicion_movimiento);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
		catch (Exception &e) {
			mServidorVioleta->MuestraMensajeError
				("ERROR AL CONSULTAR EL REPORTE: " + e.Message);
			throw Exception("ERROR AL CONSULTAR EL REPORTE");
		}
	}
	__finally {
		if (resp_almacenes != NULL)
			delete resp_almacenes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REP_CAMBIO_PROV_PRIN
void ServidorReportes::EjecutaRepCamProvPrin(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, sucursal, proveedor, producto;
	AnsiString condicion_suc = " ", condicion_suc2 = " ";

	AnsiString condicion_proveedor = " ", condicion_producto = " ";
	AnsiString condicion_proveedor2 = " ";

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[10];

	AnsiString archivo_temp1, archivo_temp2;

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);

		if (sucursal != " ") {
			condicion_suc.sprintf(" AND sec.sucursal = '%s' ", sucursal);
			condicion_suc2.sprintf(" AND ap.sucursal = '%s' ", sucursal);
		}

		if (proveedor != " ") {
			condicion_proveedor.sprintf(" AND ap.proveedor = '%s' ", proveedor);
			condicion_proveedor2.sprintf(" AND prov.proveedor = '%s' ",
				proveedor);
		}

		if (producto != " ") {
			condicion_producto.sprintf(" AND  a.producto = '%s' ", producto);
		}

		instruccion =
			"CREATE TEMPORARY TABLE auxcompras (articulo VARCHAR(9), nombre VARCHAR(60),        \
		producto VARCHAR(8), present VARCHAR(255), proveedor VARCHAR(11), razonsocial VARCHAR(60),       \
        total DOUBLE, sucursal VARCHAR(2), PRIMARY KEY(producto,present,proveedor)) ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" SELECT                                \
        a.articulo,                                                 \
        p.nombre,                                                   \
        a.producto,                                                 \
        a.present,                                                  \
        prov.proveedor,                                             \
        prov.razonsocial,                                           \
        SUM(dc.cantidad*dc.costoimp) AS COMPRADO,                   \
        sec.sucursal                                                \
        FROM compras c                                              \
        INNER JOIN dcompras dc ON c.referencia=dc.referencia        \
        INNER JOIN articulos a ON a.articulo=dc.articulo            \
		INNER JOIN productos p ON p.producto=a.producto             \
        INNER JOIN proveedores prov ON prov.proveedor=c.proveedor   \
        INNER JOIN terminales ter ON ter.terminal=c.terminal        \
        INNER JOIN secciones sec ON ter.seccion=sec.seccion         \
        WHERE c.fechacom BETWEEN '%s' AND '%s'                      \
        AND c.cancelado=0                                           \
		AND a.activo=1                                              \
		%s  %s %s                                                        \
        GROUP BY prov.proveedor,                                    \
        a.producto INTO OUTFILE '%s'  ", fecha_inicial, fecha_final,
			condicion_suc, condicion_proveedor2, condicion_producto,
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxcompras (articulo, nombre, producto, present, \
        proveedor, razonsocial, total, sucursal ) ", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auxprovprincipal (producto VARCHAR(8), present VARCHAR(255), \
		provprinc VARCHAR(11), razonprovprin VARCHAR(60), total DOUBLE, sucursal VARCHAR(2), 			\
		PRIMARY KEY(producto,present,provprinc)) ENGINE = INNODB ";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf(" SELECT                                                      \
        a.producto,                                                                       \
		a.present,                                                                        \
		provprin.proveedor,                                              				  \
		provprin.razonsocial,                                            				  \
        SUM(dc.cantidad*dc.costoimp) AS COMPRADO,                                         \
        ap.sucursal                                                                       \
        FROM compras c                                                                    \
        INNER JOIN dcompras dc ON c.referencia=dc.referencia                              \
        INNER JOIN articulos a ON a.articulo=dc.articulo                                  \
		INNER JOIN productos p ON p.producto=a.producto                                   \
        INNER JOIN articulosped ap ON a.producto=ap.producto AND a.present=ap.present     \
        INNER JOIN proveedores provprin ON provprin.proveedor=ap.proveedor                \
		WHERE c.fechacom BETWEEN '%s' AND '%s'                                            \
		AND c.cancelado=0                                                                 \
		AND a.activo=1                                                                    \
		%s  %s %s                                                       					  \
        GROUP BY provprin.proveedor,                                                      \
        a.producto,                                                                       \
        a.present                                                                         \
        ORDER BY a.producto,                                                              \
        a.present INTO OUTFILE '%s'  ", fecha_inicial, fecha_final,
			condicion_suc2, condicion_proveedor, condicion_producto,
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxprovprincipal (producto, present, provprinc, razonprovprin, \
        total, sucursal ) ", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			// Resultado final
			instruccion.sprintf
				("SELECT "
				"c.nombre, c.producto, c.present, p.provprinc, p.razonprovprin,c.proveedor, c.razonsocial, " "c.total, c.articulo, c.sucursal "
				"FROM auxcompras c " "LEFT JOIN auxprovprincipal p ON p.producto=c.producto AND p.present=c.present "
				"GROUP BY c.producto, 			c.present, 			c.proveedor " "ORDER BY c.producto, 			c.present, 			c.proveedor "
				);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		delete buffer_sql;

		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		mServidorVioleta->BorraArchivoTemp(archivo_temp2);
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPOLIZACOBRANZA
void ServidorReportes::EjecutaRepPolizaCobranza(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial_operacion, fecha_final_operacion,
		fecha_inicial_poliza, fecha_final_poliza;
	AnsiString tipoComp, tipoPlantilla, plantilla_cobranza_detalles,
		plantilla_agrupabanco;

	AnsiString afectadosxnotascargo, tipo_nombre;
	AnsiString fecha_inicial_notas, fecha_final_notas;
	AnsiString condicion_tipo_nombre = " ";
    AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString terminal, condicion_terminal = " ";

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	BufferRespuestas* resp_clientes = NULL;
	AnsiString cad_totimpuestos_create = "", campos_totimpuestos_create = "";
	AnsiString cad_porcimpuestos_create = "", campos_porcimpuestos_create = "";
	AnsiString impuesto_aux = "", tipo_impuesto_aux = "", cad_totimpuestos_col =
		"", campos_totimpuestos_col = "";
	AnsiString cad_totimpuestos = "", campos_totimpuestos = "",
		cad_porcimpuestos = "", campos_porcimpuestos = "";
	AnsiString cad_porcimpuestosVA = "", campos_porcimpuestosVA = "",
		cad_porcimpuestosVA_def = "", campos_porcimpuestosVA_def = "",
		cad_propor_impuestos = "", campos_propor_impuestos = "";
	AnsiString cad_propor_impuestos_sum = "", campos_propor_impuestos_sum = "";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";

	AnsiString archivo_temp1, archivo_temp2;
	AnsiString cuentabancaria, join_cuentabancaria = " ",
		campo_valor_pago = " ";

	try {
		fecha_inicial_poliza =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_poliza =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		tipoComp = mFg.ExtraeStringDeBuffer(&parametros);
		tipoPlantilla = mFg.ExtraeStringDeBuffer(&parametros);
		plantilla_cobranza_detalles = mFg.ExtraeStringDeBuffer(&parametros);
		plantilla_agrupabanco = mFg.ExtraeStringDeBuffer(&parametros);

		if(empresa != " ")
            condicion_empresa.sprintf(" suc.idempresa = %s AND ", empresa);

		if (plantilla_cobranza_detalles == "1") {
			// Crea una tablas tamporales
			instruccion.sprintf("create temporary table ventasreferenciasaux (referencia varchar(11), \
				KEY (referencia)) Engine = InnoDB ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("create temporary table ventasreferenciasfinalaux like ventasreferenciasaux "
				);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("create temporary table ventasaux (referencia varchar(11), \
				KEY (referencia)) Engine = InnoDB");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("create temporary table ventasaaux like ventasaux ");
			instrucciones[num_instrucciones++] = instruccion;
			instruccion.sprintf
				("create temporary table ventasbaux like ventasaux ");
			instrucciones[num_instrucciones++] = instruccion;

			// tabla temporal para insertar campos de la consulta de la venta y cobranza del rango de busqueda
			instruccion.sprintf("CREATE temporary TABLE bancosmovsaux ( \
				idmovbanco INT(11) NOT NULL ,	transacc INT(11) NOT NULL ,	idnumcuenta INT(11) NOT NULL, \
				numerocuenta VARCHAR(20) NOT NULL,	banco VARCHAR(20) NOT NULL, \
				descconceptomov VARCHAR(50) NULL DEFAULT NULL,	descripcion VARCHAR(50) NULL DEFAULT NULL, \
				identificador VARCHAR(20) NOT NULL,	fechaaplbanco DATE NOT NULL, \
				tipodet VARCHAR(1) NOT NULL,	identdet VARCHAR(20) NOT NULL,	afectacion VARCHAR(1) NULL DEFAULT NULL, \
				totalmov DECIMAL(16,2) NOT NULL,	naturaleza VARCHAR(20) NOT NULL, \
				sucursal VARCHAR(2) NOT NULL,	origen VARCHAR(5) NOT NULL,	fechaalta DATE NOT NULL, \
				horaalta TIME NOT NULL,	valordoc DECIMAL(16,2) NOT NULL,	PRIMARY KEY (idmovbanco) \
			)ENGINE=InnoDB ");
			instrucciones[num_instrucciones++] = instruccion;

			// tabla temporal para insertar campos de la consulta de la venta y cobranza del rango de busqueda CLONADA1
			instruccion.sprintf
				("CREATE TEMPORARY TABLE bancosmovs1aux LIKE bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			// tabla temporal para insertar campos de la consulta de la venta y cobranza del rango de busqueda CLONADA2
			instruccion.sprintf
				("CREATE TEMPORARY TABLE bancosmovs2aux LIKE bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			// tabla temporal para insertar campos de la consulta de la venta y cobranza del rango de busqueda CLONADA3
			instruccion.sprintf
				("CREATE TEMPORARY TABLE bancosmovs3aux LIKE bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("set @FechaInicioPol='%s', @FechaFinalPol='%s', @Sucursal='%s', \
				@TipoComprobante='%s', @TipoPlantilla='%s' ",
				fecha_inicial_poliza, fecha_final_poliza, sucursal, tipoComp,
				tipoPlantilla);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("set @Fecha1=DATE_ADD(@FechaInicioPol, INTERVAL -1 MONTH), \
				@Fecha2=DATE_ADD(@FechaFinalPol, INTERVAL 2 MONTH) ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into ventasreferenciasaux (referencia) \
				(SELECT txc.referencia \
				FROM bancosmov bm \
				INNER JOIN bancostransacc bt ON bm.idmovbanco = bt.idmovbanco \
				INNER JOIN bancoscuentas bc ON bc.idnumcuenta = bm.idnumcuenta \
				INNER JOIN bancosxcob bxc ON bxc.transacc=bt.transacc \
				INNER JOIN transxcob txc ON txc.tracredito=bxc.tracredito \
				INNER JOIN pagoscli pag ON txc.pago=pag.pago \
				INNER JOIN ventas v ON v.referencia=txc.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON t.seccion = s.seccion  AND s.sucursal = bm.sucursal \
				WHERE bm.cancelado = 0 AND bm.aplicado = 1 AND bm.fechaaplbanco \
				BETWEEN @Fecha1 and @Fecha2  \
				AND bm.sucursal in(select DISTINCT(COALESCE(sucdetalle,p.sucursal,'')) from plantillaspoliz p \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				 where %s p.sucursal=@Sucursal and tipocomprobante=@TipoComprobante AND tipoplantilla=@TipoPlantilla )\
				AND bm.origen in ('PACLE','PACLI','VENCE','VENTC') and pag.fecha between @FechaInicioPol and @FechaFinalPol \
				AND bm.origen in ('PACLI', 'PACLE')	) \
				UNION \
				( SELECT bdv.venta \
				FROM bancosmov bm \
				INNER JOIN bancostransacc bt ON bm.idmovbanco = bt.idmovbanco \
				INNER JOIN bancoscuentas bc ON bc.idnumcuenta = bm.idnumcuenta \
				INNER JOIN bancosxventas bxv ON bxv.idmovbanco=bm.idmovbanco \
				INNER JOIN bancosdventas bdv ON bdv.idbancosventas=bxv.idbancosventas and bdv.idmovbanco=bm.idmovbanco \
				INNER JOIN ventas v ON v.referencia=bdv.venta \
				WHERE bm.cancelado = 0 AND bm.aplicado = 1   AND bm.fechaaplbanco BETWEEN @Fecha1 and @Fecha2 \
				AND bm.sucursal in(select DISTINCT(COALESCE(sucdetalle,p.sucursal,'')) from plantillaspoliz p \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				where %s p.sucursal=@Sucursal and tipocomprobante=@TipoComprobante AND tipoplantilla=@TipoPlantilla ) \
				AND bm.origen in ('PACLE','PACLI','VENCE','VENTC') \
				and v.fechavta between @FechaInicioPol and @FechaFinalPol  AND bm.origen IN('VENCE','VENTC') ) ",
				condicion_empresa, condicion_empresa);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into ventasreferenciasfinalaux \
				select DISTINCT * from ventasreferenciasaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("create temporary table dnotascredcliaux \
				select v.referencia as venta, d.articulo \
				from notascredcli n, dnotascredcli d, ventas v, ventasreferenciasfinalaux ra \
				where n.venta=v.referencia and n.cancelado=0 and v.cancelado=0 and ra.referencia=v.referencia and \
				n.referencia=d.referencia group by v.referencia, d.articulo ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into ventasaux (referencia) \
				select v.referencia \
				from ventas v \
				inner join  dventas dv on v.referencia=dv.referencia \
				inner join ventasreferenciasfinalaux ra 	on v.referencia=ra.referencia \
				left join dnotascredcliaux dn on dn.articulo=dv.articulo and dn.venta=v.referencia \
				group by v.referencia 		order by v.referencia ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("insert into ventasaaux select * from ventasaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("insert into ventasbaux select * from ventasaaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("insert into bancosmovsaux(idmovbanco, transacc, idnumcuenta, numerocuenta, banco, \
				descconceptomov, descripcion, identificador, fechaaplbanco, tipodet, identdet, afectacion, totalmov, \
				naturaleza, sucursal, origen, fechaalta, horaalta, valordoc) \
				SELECT 		 idmovbanco, transacc, idnumcuenta, numerocuenta, banco, descconceptomov, descripcion, \
				identificador, fechaaplbanco, tipodet, identdet, afectacion, totalmov, \
				naturaleza, sucursal, origen, fechaalta, horaalta, SUM(valordoc) AS valordoc \
				FROM (	( \
				SELECT 	bm.idmovbanco, bt.transacc, bc.idnumcuenta, bc.numerocuenta, bc.banco, \
				bcm.descripcion AS descconceptomov, bm.descripcion, bm.identificador, \
				bm.fechaaplbanco, bt.tipodet, bt.identificador AS identdet, \
				bm.afectacion, bm.total AS totalmov, bn.naturaleza, bm.sucursal, bm.origen, \
				bm.fechaalta, bm.horaalta, bt.total AS valordoc \
				FROM bancosmov bm \
				INNER JOIN bancostransacc bt ON bm.idmovbanco = bt.idmovbanco AND bt.tipodet='A' \
				INNER JOIN bancoscuentas bc ON bc.idnumcuenta = bm.idnumcuenta \
				INNER JOIN bancosnaturalezas bn ON bn.naturaleza = bc.naturaleza \
				INNER JOIN bancosconceptomov bcm ON bm.conceptomov = bcm.conceptomov \
				INNER JOIN pagoscli pag ON bt.pagcliajuste = pag.pago \
				WHERE bm.cancelado = 0 AND bm.aplicado = 1 \
				AND bm.fechaaplbanco BETWEEN @Fecha1 AND @Fecha2 AND bm.origen IN ('PACLE','PACLI','VENCE','VENTC') \
				AND pag.fecha BETWEEN @FechaInicioPol AND @FechaFinalPol AND bm.origen IN ('PACLI', 'PACLE') AND \
				bm.sucursal in(select DISTINCT(COALESCE(sucdetalle,p.sucursal,'')) from plantillaspoliz p \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				where %s p.sucursal=@Sucursal and tipocomprobante=@TipoComprobante AND tipoplantilla=@TipoPlantilla )  ) \
				UNION ALL \
				(SELECT bm.idmovbanco, bt.transacc, bc.idnumcuenta, bc.numerocuenta, bc.banco, \
				bcm.descripcion AS descconceptomov, bm.descripcion, bm.identificador, \
				bm.fechaaplbanco, bt.tipodet, bt.identificador AS identdet, \
				bm.afectacion, bm.total AS totalmov, bn.naturaleza, bm.sucursal, bm.origen, bm.fechaalta, bm.horaalta, \
				 @valormov:=bxc.valorconsiderado AS valordoc \
				FROM bancosmov bm \
				INNER JOIN bancostransacc bt ON bm.idmovbanco = bt.idmovbanco \
				INNER JOIN bancoscuentas bc ON bc.idnumcuenta = bm.idnumcuenta \
				INNER JOIN bancosnaturalezas bn ON bn.naturaleza = bc.naturaleza \
				INNER JOIN bancosconceptomov bcm ON bm.conceptomov = bcm.conceptomov \
				INNER JOIN bancosxcob bxc ON bxc.transacc=bt.transacc \
				INNER JOIN transxcob txc ON txc.tracredito=bxc.tracredito \
				 INNER JOIN ventasaaux va ON txc.referencia=va.referencia \
				INNER JOIN pagoscli pag ON txc.pago=pag.pago \
				WHERE bm.cancelado = 0 AND bm.aplicado = 1 AND bm.fechaaplbanco BETWEEN \
				@Fecha1 AND @Fecha2 AND bm.origen IN ('PACLE','PACLI','VENCE','VENTC') \
				AND pag.fecha BETWEEN @FechaInicioPol AND @FechaFinalPol AND bm.origen IN ('PACLI', 'PACLE') \
				AND bm.sucursal in(select DISTINCT(COALESCE(sucdetalle,p.sucursal,'')) from plantillaspoliz p \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				 where %s p.sucursal=@Sucursal and tipocomprobante=@TipoComprobante AND tipoplantilla=@TipoPlantilla )) \
				UNION ALL \
				( SELECT bm.idmovbanco, bt.transacc, bc.idnumcuenta, bc.numerocuenta, bc.banco, \
				bcm.descripcion AS descconceptomov, bm.descripcion, bm.identificador, \
				bm.fechaaplbanco, bt.tipodet, bt.identificador AS identdet, \
				bm.afectacion, bm.total AS totalmov, bn.naturaleza, bm.sucursal, bm.origen, bm.fechaalta, \
				bm.horaalta, @valormov:=bdv.valorconsiderado AS valordoc \
				FROM bancosmov bm \
				INNER JOIN bancostransacc bt ON bm.idmovbanco = bt.idmovbanco \
				INNER JOIN bancoscuentas bc ON bc.idnumcuenta = bm.idnumcuenta \
				INNER JOIN bancosnaturalezas bn ON bn.naturaleza = bc.naturaleza \
				INNER JOIN bancosconceptomov bcm ON bm.conceptomov = bcm.conceptomov \
				INNER JOIN bancosxventas bxv ON bxv.idmovbanco=bm.idmovbanco \
				INNER JOIN bancosdventas bdv ON bdv.idbancosventas=bxv.idbancosventas AND bdv.idmovbanco=bm.idmovbanco \
				INNER JOIN ventasbaux va ON bdv.venta=va.referencia \
				WHERE bm.cancelado = 0 AND bm.aplicado = 1 AND bm.fechaaplbanco BETWEEN @Fecha1 AND @Fecha2 \
				AND bm.sucursal in(select DISTINCT(COALESCE(sucdetalle,p.sucursal,'')) from plantillaspoliz p \
                LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				 where %s p.sucursal=@Sucursal and tipocomprobante=@TipoComprobante AND tipoplantilla=@TipoPlantilla ) \
				AND bm.origen IN ('PACLE','PACLI','VENCE','VENTC') \
				AND bm.origen IN ('VENCE','VENTC') 			) \
						) t \
				GROUP BY idmovbanco \
				ORDER BY idnumcuenta, fechaaplbanco, fechaalta, horaalta, idmovbanco ",
                condicion_empresa, condicion_empresa, condicion_empresa
				);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("INSERT INTO bancosmovs1aux SELECT * FROM bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("INSERT INTO bancosmovs2aux SELECT * FROM bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf
				("INSERT INTO bancosmovs3aux SELECT * FROM bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("select * from bancosmovsaux ");
			instrucciones[num_instrucciones++] = instruccion;

			if (plantilla_agrupabanco == "0") {
				// se agrega detalle de registros por movimiento bancario
				instruccion.sprintf("SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
				p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, p.tipoimpu2, \
				CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, \
				COALESCE (p.segmentodefault,par.segmento) AS segmento, p.formaspago, p.tiporfc, \
				IFNULL(p.idnumcuenta,0) AS idnumcuenta,bm.totalmov AS total, p.agrupabanco \
				FROM  bancosmovsaux as bm \
				LEFT JOIN plantillaspoliz AS p ON p.idnumcuenta = bm.idnumcuenta AND p.sucdetalle= bm.sucursal AND p.termino= 'CONEF' \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE bm.origen='VENCE' AND %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante \
				AND p.tipoplantilla=@TipoPlantilla AND p.tipopartida='VENT' \
				AND p.tipoafectacion='C' AND p.expresion='TOTAL' AND p.idnumcuenta >0 \
				UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
				p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, p.tipoimpu2, \
				CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, \
				COALESCE (p.segmentodefault,par.segmento) AS segmento, p.formaspago, p.tiporfc, \
				IFNULL(p.idnumcuenta,0) AS idnumcuenta,bm.totalmov AS total, p.agrupabanco \
				FROM  bancosmovs1aux as bm \
				LEFT JOIN plantillaspoliz AS p ON p.idnumcuenta = bm.idnumcuenta AND p.sucdetalle= bm.sucursal AND p.termino= 'TARCR' \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE bm.origen='VENTC' AND %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante AND p.tipoplantilla=@TipoPlantilla \
				AND p.tipopartida='VENT' \
				AND p.tipoafectacion='C' AND p.expresion='TOTAL' AND p.idnumcuenta >0 \
				 UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
				p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, 			 p.tipoimpu2, \
				CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, \
				COALESCE (p.segmentodefault,par.segmento) AS segmento, p.formaspago, p.tiporfc, \
				IFNULL(p.idnumcuenta,0) AS idnumcuenta,bm.totalmov AS total, p.agrupabanco \
				FROM  bancosmovs2aux as bm \
				INNER JOIN plantillaspoliz AS p ON p.idnumcuenta = bm.idnumcuenta AND p.sucdetalle= bm.sucursal AND IFNULL(p.termino,'')= '' \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE bm.origen NOT IN('PACLI','PACLE') AND %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante \
				AND p.tipoplantilla=@TipoPlantilla AND p.tipopartida='VENT' \
				AND p.tipoafectacion='C' AND p.expresion='TOTAL' AND p.idnumcuenta >0 \
				UNION ALL \
				SELECT  p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, p.fechainivent, p.fechafinvent, \
				p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, \
				p.tipoimpu2, CONCAT(p.impuesto2) AS impuesto2, \
				CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, COALESCE (p.segmentodefault,par.segmento) AS segmento, \
				p.formaspago, p.tiporfc, IFNULL(p.idnumcuenta,0) AS idnumcuenta,bm.totalmov AS total, p.agrupabanco \
				FROM bancosmovs3aux as bm \
				INNER JOIN plantillaspoliz AS p ON p.idnumcuenta = bm.idnumcuenta AND p.sucdetalle= bm.sucursal AND p.tipopartida='COBR' \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante AND p.tipoplantilla=@TipoPlantilla AND p.tipopartida='COBR' \
				AND p.tipoafectacion='C' AND bm.origen in('PACLI','PACLE') AND p.expresion='TOTAL' AND p.idnumcuenta >0 \
				UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, p.tipoafectacion, p.expresion, \
				p.sucursal, p.parametros, p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
				p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, p.tipoimpu2, \
				CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel,  \
				COALESCE (p.segmentodefault,par.segmento) AS segmento, p.formaspago, p.tiporfc, \
				IFNULL(p.idnumcuenta,0) AS idnumcuenta, 0 AS total, p.agrupabanco \
				FROM plantillaspoliz AS p \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante \
				AND p.tipoplantilla=@TipoPlantilla AND IFNULL(p.idnumcuenta,0)=0 AND c.nombrecuenta <>'CUENTA PUENTE'\
				UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, 		p.fechainivent, p.fechafinvent, \
				p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, \
				p.tipoimpu2, CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, COALESCE (p.segmentodefault,par.segmento) AS segmento, \
				p.formaspago, p.tiporfc, IFNULL(p.idnumcuenta,0) AS idnumcuenta, SUM(bm.totalmov) AS total, p.agrupabanco \
				FROM bancosmovsaux AS bm \
				LEFT JOIN plantillaspoliz AS p ON  p.sucdetalle= bm.sucursal AND p.tipopartida='VENT' AND IFNULL(p.termino,'') in('CONEF','') \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				INNER JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante AND p.tipoplantilla=@TipoPlantilla \
				AND p.tipopartida='VENT' AND p.expresion='TOTAL' \
				and c.nombrecuenta ='CUENTA PUENTE' \
				GROUP BY p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, p.tipocomprobante, p.clasif1, \
				p.clasif2, p.clasif3, p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, p.acredito, p.termino, \
				p.tipoimpu, p.impuesto, p.negimpuesto, p.tipoimpu2, p.impuesto2,p.negimpuesto2, p.parterel, segmento, \
				p.formaspago, p.tiporfc, p.idnumcuenta, p.agrupabanco \
				ORDER BY orden ",
				condicion_empresa, condicion_empresa, condicion_empresa, condicion_empresa, condicion_empresa, condicion_empresa
				);
				// instrucciones[num_instrucciones++]=instruccion;
			}
			else {
				// se agrupa por bancos y se totaliza en un solo movimiento
				instruccion.sprintf("SELECT  p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, 		p.fechainivent, p.fechafinvent, \
				p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, \
				p.tipoimpu2, CONCAT(p.impuesto2) AS impuesto2, \
				CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, COALESCE (p.segmentodefault,par.segmento) AS segmento, \
				p.formaspago, p.tiporfc, IFNULL(p.idnumcuenta,0) AS idnumcuenta, sum(bm.totalmov) AS total, p.agrupabanco \
				FROM bancosmovsaux as bm \
				LEFT JOIN plantillaspoliz AS p ON p.idnumcuenta = bm.idnumcuenta AND p.sucdetalle= bm.sucursal AND p.tipopartida='VENT' \
					AND IFNULL(p.termino,'') in('CONEF','') \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				INNER JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante AND p.tipoplantilla=@TipoPlantilla AND p.tipopartida='VENT' \
				AND p.tipoafectacion='C' AND p.expresion='TOTAL' AND p.idnumcuenta >0 \
				group  by p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, p.tipocomprobante, p.clasif1, \
				p.clasif2, p.clasif3, p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, p.acredito, p.termino, \
				p.tipoimpu, p.impuesto, p.negimpuesto, p.tipoimpu2, p.impuesto2,p.negimpuesto2, p.parterel, segmento, \
				p.formaspago, p.tiporfc, p.idnumcuenta, p.agrupabanco \
				UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, p.tipoafectacion, p.expresion, \
				p.sucursal, p.parametros, 			 p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
				p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, 			 p.tipoimpu2, \
				CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel,  \
				COALESCE (p.segmentodefault,par.segmento) AS segmento, 			 p.formaspago, p.tiporfc, \
				IFNULL(p.idnumcuenta,0) AS idnumcuenta, 0 AS total, p.agrupabanco \
				FROM plantillaspoliz AS p \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
                LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante \
				AND p.tipoplantilla=@TipoPlantilla AND IFNULL(p.idnumcuenta,0)=0 AND c.nombrecuenta <>'CUENTA PUENTE'\
				UNION ALL \
				SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
				p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, 		p.fechainivent, p.fechafinvent, \
				p.clasifcont, p.clasifcont2, CONCAT(p.acredito) AS acredito, p.termino, \
				p.tipoimpu, CONCAT(p.impuesto) AS impuesto, CONCAT(p.negimpuesto) AS negimpuesto, \
				p.tipoimpu2, CONCAT(p.impuesto2) AS impuesto2, CONCAT(p.negimpuesto2) AS negimpuesto2, CONCAT(p.parterel) AS parterel, COALESCE (p.segmentodefault,par.segmento) AS segmento, \
				p.formaspago, p.tiporfc, IFNULL(p.idnumcuenta,0) AS idnumcuenta, SUM(bm.totalmov) AS total, p.agrupabanco \
				FROM bancosmovsaux AS bm \
				LEFT JOIN plantillaspoliz AS p ON p.sucdetalle= bm.sucursal \
				AND p.tipopartida='VENT' AND IFNULL(p.termino,'') in('CONEF','') \
				INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
				INNER JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
				LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
				WHERE %s p.sucursal=@Sucursal AND p.tipocomprobante=@TipoComprobante AND p.tipoplantilla=@TipoPlantilla \
				AND p.tipopartida='VENT' AND p.expresion='TOTAL' \
				and c.nombrecuenta ='CUENTA PUENTE' \
				GROUP BY p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
				p.tipoafectacion, p.expresion, p.sucursal, p.parametros, p.tipocomprobante, p.clasif1, \
				p.clasif2, p.clasif3, p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, p.acredito, p.termino, \
				p.tipoimpu, p.impuesto, p.negimpuesto, p.tipoimpu2, p.impuesto2,p.negimpuesto2, p.parterel, segmento, \
				p.formaspago, p.tiporfc, p.idnumcuenta, p.agrupabanco \
				ORDER BY orden ",
                condicion_empresa, condicion_empresa, condicion_empresa
				);
				// instrucciones[num_instrucciones++]=instruccion;
			}

		} // fin si te tiene detalles para agrupar por pago o por bancos
		else {
			instruccion.sprintf("SELECT p.plantilla, p.orden, p.tipopartida, p.numcuenta, c.nombrecuenta, p.sucdetalle, \
			 p.tipoafectacion, p.expresion, p.sucursal, p.parametros, \
			 p.tipocomprobante, p.clasif1, p.clasif2, p.clasif3, \
			 p.fechainivent, p.fechafinvent, p.clasifcont, p.clasifcont2, \
			 concat(p.acredito) as acredito, p.termino, \
			 p.tipoimpu, concat(p.impuesto) as impuesto, concat(p.negimpuesto) as negimpuesto, \
			 p.tipoimpu2, concat(p.impuesto2) as impuesto2, concat(p.negimpuesto2) as negimpuesto2, \
			 concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, p.formaspago, p.tiporfc, \
			 ifnull(p.idnumcuenta,0) as idnumcuenta, 0 as total, p.agrupabanco \
		 FROM plantillaspoliz AS p \
		 INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		 LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
		 LEFT JOIN sucursales suc ON suc.sucursal = p.sucdetalle \
		 WHERE %s p.sucursal='%s' AND p.tipocomprobante='%s' AND p.tipoplantilla='%s' \
		 ORDER BY p.orden ", condicion_empresa, sucursal, tipoComp, tipoPlantilla);
			// instrucciones[num_instrucciones++]=instruccion;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		delete buffer_sql;
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		if (resp_clientes != NULL)
			delete resp_clientes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTODET_MOVALMA_EXT
void ServidorReportes::EjecutaRepCostoDetalleMovAlma
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, almacen, sucursal, producto,
		presenta, clasif1, clasif2, clasif3;
	AnsiString movimiento, agruparConcepto, tipo, conceptos, concepto;

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[15];
	AnsiString cad_conjunto_almacenes = " ";

	BufferRespuestas* resp_almacenes = NULL;

	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " ",
		condicion_clasif3 = " ";
	AnsiString condicion_mov = " ", condicion_tipo = " ", condicion_conceptos =
		" ", condicion_concepto = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		presenta = mFg.ExtraeStringDeBuffer(&parametros);
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		movimiento = mFg.ExtraeStringDeBuffer(&parametros);
		agruparConcepto = mFg.ExtraeStringDeBuffer(&parametros);
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		conceptos = mFg.ExtraeStringDeBuffer(&parametros);
		concepto = mFg.ExtraeStringDeBuffer(&parametros);

		if (almacen != " ") {
			cad_conjunto_almacenes = "'" + almacen + "'";
		}
		else {
			if (sucursal != " ") {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
					INNER JOIN secciones s ON a.seccion=s.seccion \
					WHERE s.sucursal='%s'", sucursal);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (int i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++)
				{
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
			else {
				instruccion.sprintf("SELECT a.almacen FROM almacenes a \
						INNER JOIN secciones s ON a.seccion=s.seccion");
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_almacenes);
				for (int i = 0; i < resp_almacenes->ObtieneNumRegistros(); i++)
				{
					resp_almacenes->IrAlRegistroNumero(i);
					almacen = resp_almacenes->ObtieneDato("almacen");

					cad_conjunto_almacenes += "'";
					cad_conjunto_almacenes += almacen;
					cad_conjunto_almacenes += "'";
					if (i < resp_almacenes->ObtieneNumRegistros() - 1)
						// A todos menos al ultimo impuesto le signo +.
							cad_conjunto_almacenes += ",";
				}
			}
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" AND p.clasif1 = '%s' ", clasif1);
		}

		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" AND p.clasif2 = '%s' ", clasif2);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" AND p.clasif3 = '%s' ", clasif3);
		}

		if (movimiento != " ") {
			condicion_mov.sprintf(" AND m.movimiento = '%s' ", movimiento);
		}

		if (tipo != " ") {
			condicion_tipo.sprintf(" AND m.tipo = '%s' ", tipo);
		}

		if (conceptos != " ") {
			condicion_conceptos.sprintf(" AND m.concepto IN(%s) ", conceptos);
		}

		if (concepto != " ") {
			condicion_concepto.sprintf(" AND m.concepto IN('%s') ", concepto);
		}

		if (agruparConcepto == 0) {
			/////Inicializamos la variable producto
			instruccion.sprintf("SET @producto = '%s' ", producto);
			instrucciones[num_instrucciones++] = instruccion;

			/////Inicializamos la variable presentacion
			instruccion.sprintf("SET @present  = '%s'", presenta);
			instrucciones[num_instrucciones++] = instruccion;

			/////Inicializamos la variable fecha final
			instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
			instrucciones[num_instrucciones++] = instruccion;

			/////Inicializamos la variable fecha final
			instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
			instrucciones[num_instrucciones++] = instruccion;

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql =
				mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones),
				aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				instruccion.sprintf("SELECT m.movimiento, m.fechamov,                                                         \
				m.horamodi,                                                                                     \
				(pma.cantidad) AS multmin,                                                                      \
				(pma.costomov) AS costo,                                                                        \
				TRUNCATE(IFNULL(pma.cantidad/pmm.maxfactor,0),0) AS cantmayor,                                  \
				IFNULL(MOD(pma.cantidad,pmm.maxfactor),0) AS cantunidad,                                        \
				pmm.maxmult,                                                                                    \
				pmm.maxfactor,                                                                                  \
				pmm.minmult                                                                                     \
				FROM movalma m                                                                                  \
				INNER JOIN precalculocostosmovalmadet pma ON pma.movimiento = m.movimiento                      \
				INNER JOIN presentacionesminmax AS pmm ON pmm.producto = @producto AND pmm.present = @present   \
				INNER JOIN productos p ON pma.producto = p.producto                                             \
				WHERE                                                                                           \
				m.fechamov BETWEEN @fechaini AND @fechafin                                                      \
				AND m.cancelado = 0                                                                             \
				AND m.aplica = 1                                                                                \
				AND pma.almacen IN (%s)                                                                         \
				AND pma.producto = @producto                                                                    \
				AND pma.present = @present                                                                      \
				%s %s %s %s %s                                                                                  \
				ORDER BY m.fechamov DESC ", cad_conjunto_almacenes,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_mov, condicion_conceptos);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), Respuesta->TamBufferResultado);
			}
		}
		else if (agruparConcepto == 1) {

			/////Inicializamos la variable fecha final
			instruccion.sprintf("SET @fechaini = '%s'", fecha_inicial);
			instrucciones[num_instrucciones++] = instruccion;

			/////Inicializamos la variable fecha final
			instruccion.sprintf("SET @fechafin = '%s'", fecha_final);
			instrucciones[num_instrucciones++] = instruccion;

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql =
				mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones),
				aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				instruccion.sprintf("SELECT m.fechamov,                                                         \
				m.horamodi,                                                                                     \
				(pma.cantidad) AS multmin,                                                                      \
				(pma.costomov) AS costo,                                                                        \
				TRUNCATE(IFNULL(pma.cantidad/pmm.maxfactor,0),0) AS cantmayor,                                  \
				IFNULL(MOD(pma.cantidad,pmm.maxfactor),0) AS cantunidad,                                        \
				pmm.maxmult,                                                                                    \
				pmm.maxfactor,                                                                                  \
				pmm.minmult                                                                                     \
				FROM movalma m                                                                                  \
				INNER JOIN precalculocostosmovalmadet pma ON pma.movimiento = m.movimiento                      \
				INNER JOIN productos p ON pma.producto = p.producto                                       		\
				INNER JOIN presentacionesminmax AS pmm ON pmm.producto = pma.producto                           \
				AND pmm.present = pma.present 																	\
				WHERE                                                                                           \
				m.fechamov BETWEEN @fechaini AND @fechafin                                                      \
				AND m.cancelado = 0                                                                             \
				AND m.aplica = 1                                                                                \
				AND pma.almacen IN (%s)                                                                         \
				%s %s %s %s %s                                                                                  \
				ORDER BY m.fechamov DESC ", cad_conjunto_almacenes,
					condicion_clasif1, condicion_clasif2, condicion_clasif3,
					condicion_mov, condicion_concepto);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), Respuesta->TamBufferResultado);
			}

		}
	}
	__finally {
		delete buffer_sql;
		if (resp_almacenes != NULL)
			delete resp_almacenes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPOLIZASMASIVAS
void ServidorReportes::EjecutaRepPolizasMasivas(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial_poliza, fecha_final_poliza;
	AnsiString tipoComp, tipoPlantilla, tipoPoliza, sucursal;
	AnsiString empresa, condicion_empresa = " ";

	AnsiString condicion_sucursal = " ";

	// Obtiene los impuestos existentes
	BufferRespuestas* resp_impuestos = NULL;
	BufferRespuestas* resp_clientes = NULL;
	AnsiString cad_totimpuestos_create = "", campos_totimpuestos_create = "";
	AnsiString cad_porcimpuestos_create = "", campos_porcimpuestos_create = "";
	AnsiString impuesto_aux = "", tipo_impuesto_aux = "", cad_totimpuestos_col =
		"", campos_totimpuestos_col = "";
	AnsiString cad_totimpuestos = "", campos_totimpuestos = "",
		cad_porcimpuestos = "", campos_porcimpuestos = "";
	AnsiString cad_porcimpuestosVA = "", campos_porcimpuestosVA = "",
		cad_porcimpuestosVA_def = "", campos_porcimpuestosVA_def = "",
		cad_propor_impuestos = "", campos_propor_impuestos = "";
	AnsiString cad_propor_impuestos_sum = "", campos_propor_impuestos_sum = "";
	AnsiString clientes_partesrel, condicion_clientes_partesrel = " ";

	AnsiString archivo_temp1, archivo_temp2;
	AnsiString cuentabancaria, join_cuentabancaria = " ",
		campo_valor_pago = " ";

	try {
		fecha_inicial_poliza =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_poliza =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		tipoComp = mFg.ExtraeStringDeBuffer(&parametros);
		tipoPlantilla = mFg.ExtraeStringDeBuffer(&parametros);
		tipoPoliza = mFg.ExtraeStringDeBuffer(&parametros);
		// plantilla_cobranza_detalles=mFg.ExtraeStringDeBuffer(&parametros);
		// plantilla_agrupabanco=mFg.ExtraeStringDeBuffer(&parametros);

		if(empresa != " "){
            condicion_empresa.sprintf(" suc.idempresa = %s AND ", empresa);
		}

		// Crea una tablas y variables tamporales
		instruccion.sprintf("set @FechaInicioPol='%s', @FechaFinalPol='%s', @Sucursal='%s', \
			@TipoComprobante='%s', @TipoPlantilla='%s', @TipoPoliza='%s' ",
			fecha_inicial_poliza, fecha_final_poliza, sucursal, tipoComp,
			tipoPlantilla, tipoPoliza);
		instrucciones[num_instrucciones++] = instruccion;

		if (tipoComp == "VENT" || tipoComp == "COBR") {
			// validando fechas de las ventas
			instruccion.sprintf("set @Fecha1=DATE_ADD(@FechaInicioPol, INTERVAL -1 MONTH), \
				@Fecha2=DATE_ADD(@FechaFinalPol, INTERVAL 2 MONTH) ");
			instrucciones[num_instrucciones++] = instruccion;

			if (sucursal != "GG") {
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select v.fechaalta as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM ventas v \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON t.seccion = s.seccion \
					LEFT JOIN (select fechaini, fechafin, COUNT(*) AS cuenta from polizascont \
					WHERE sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = v.fechaalta \
					and cuentapol.fechafin=v.fechaalta \
					WHERE V.fechaalta between @FechaInicioPol and @FechaFinalPol \
					AND s.sucursal=@Sucursal \
					group by v.fechaalta ");
				// instrucciones[num_instrucciones++]=instruccion;

			}
			else {
				// se agrupa por fecha para validar fechas de pólizas sin filtro sucursal por ser Global
				instruccion.sprintf("select v.fechaalta as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM ventas v \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = v.fechaalta \
					and cuentapol.fechafin=v.fechaalta \
					WHERE V.fechaalta between @FechaInicioPol and @FechaFinalPol \
					group by v.fechaalta ", condicion_empresa);
				// instrucciones[num_instrucciones++]=instruccion;

			}

		} // fin si es Ventas o Cobranza
		else if (tipoComp == "COMP") { // para pólizas de compras

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select c.fechacom as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM compras c \
					INNER JOIN terminales ter ON ter.terminal=c.terminal \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion \
					LEFT JOIN (select fechaini, fechafin, COUNT(*) AS cuenta from polizascont \
					WHERE sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = c.fechacom \
					and cuentapol.fechafin=c.fechacom \
					WHERE sec.sucursal=@Sucursal AND c.cancelado=0 \
					AND c.fechacom between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY c.fechacom ");

			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select c.fechacom as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM compras c \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza ) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = c.fechacom \
					and cuentapol.fechafin=c.fechacom \
					WHERE c.cancelado=0 \
					AND c.fechacom between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY c.fechacom ", condicion_empresa);
			}

		} // fin si es Compras
		else if (tipoComp == "NCRP")
		{ // para pólizas de NOTAS DE CREDITO PROVEEDORES

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM notascredprov as n \
					INNER JOIN compras comp ON n.compra=comp.referencia \
					INNER JOIN terminales ter ON ter.terminal=comp.terminal \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion \
					LEFT JOIN (select fechaini, fechafin, COUNT(*) AS cuenta from polizascont \
					WHERE sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
					and cuentapol.fechafin=n.fechanot \
					WHERE sec.sucursal=@Sucursal AND n.cancelado=0 \
					AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY n.fechanot ");
			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM notascredprov as n \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
					and cuentapol.fechafin=n.fechanot \
					WHERE n.cancelado=0 \
					AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY n.fechanot ", condicion_empresa);
			}

		} // fin si es NOTAS DE CREDITO PROVEEDORES

		else if (tipoComp == "NCRE")
		{ // para pólizas de NOTAS DE CREDITO CLIENTES

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM notascredcli as n \
					INNER JOIN ventas vent ON n.venta=vent.referencia \
					INNER JOIN terminales ter ON ter.terminal=vent.terminal \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion \
					LEFT JOIN (select fechaini, fechafin, COUNT(*) AS cuenta from polizascont \
					WHERE sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
					and cuentapol.fechafin=n.fechanot \
					WHERE sec.sucursal=@Sucursal AND n.cancelado=0 \
					AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY n.fechanot ");
			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM notascredcli as n \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
					and cuentapol.fechafin=n.fechanot \
					WHERE n.cancelado=0 \
					AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY n.fechanot ", condicion_empresa);
			}

		} // fin si es NOTAS DE CREDITO CLIENTES
		else if (tipoComp == "PAGO") { // para pólizas de PAGOS a proveedores

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select '' as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, 1 as TienePoliza "
					);
			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select t.fechaapl as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, \
					p.proveedor, t.pago, p.razonsocial, SUM(t.valor)*-1 as valor, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM compras c \
					INNER JOIN transxpag t ON t.referencia = c.referencia \
					INNER JOIN proveedores p ON p.proveedor=c.proveedor \
					LEFT JOIN (SELECT proveedor,fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta \
					FROM polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					  WHERE %s tipocomprobante='PAGO' AND enviado=1 AND \
						fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND \
						fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
						GROUP BY proveedor,fechaini, fechafin) cuentapol ON p.proveedor=cuentapol.proveedor \
						and cuentapol.fechaini = t.fechaapl and cuentapol.fechafin=t.fechaapl \
					WHERE t.fechaapl between @FechaInicioPol and @FechaFinalPol AND t.cancelada = 0 \
					AND t.aplicada = 1 AND t.tipo = 'PAGO' AND c.cancelado = 0 \
					GROUP BY t.fechaapl, p.proveedor, t.pago \
					ORDER BY t.pago ASC ", condicion_empresa);
			}

		} // fin si es NOPAGOS a proveedores
		else if (tipoComp == "PAGG") { // para pólizas de PAGOS a GASTOS

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select '' as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, 1 as TienePoliza "
					);
			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select t.fechaapl as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, \
					p.proveedor, t.pago, p.razonsocial, SUM(t.valor)*-1 as valor, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM gastos c \
					INNER JOIN transxpaggastos t ON t.referencia = c.referencia \
					INNER JOIN proveedores p ON p.proveedor=c.proveedor \
					INNER JOIN terminales ter ON ter.terminal = c.terminal \
					INNER JOIN secciones sec ON sec.seccion = ter.seccion \
					INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					LEFT JOIN ( \
					   SELECT proveedor,fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta \
					   FROM polizascont pc \
					   LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					   LEFT JOIN sucursales suc ON suc.sucursal = mc.sucdetalle \
					   WHERE %s tipocomprobante='PAGG' AND enviado=1 AND \
						fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND \
						fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					   GROUP BY proveedor,fechaini, fechafin \
					) cuentapol ON p.proveedor=cuentapol.proveedor \
						and cuentapol.fechaini = t.fechaapl and cuentapol.fechafin=t.fechaapl \
					WHERE %s t.fechaapl between @FechaInicioPol and @FechaFinalPol AND t.cancelada = 0 \
					AND t.aplicada = 1 AND t.tipo = 'PAGO' AND c.cancelado = 0 \
					GROUP BY t.fechaapl, p.proveedor, t.pago \
					ORDER BY t.pago ASC ", condicion_empresa, condicion_empresa);
			}

		} // fin si es NOPAGOS a proveedores
		else if (tipoComp == "GAST") { // para pólizas de GASTOS

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select c.fechagas as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM gastos c \
					INNER JOIN terminales ter ON ter.terminal=c.terminal \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales AS suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = c.fechagas \
					and cuentapol.fechafin=c.fechagas \
					WHERE sec.sucursal=@Sucursal AND c.cancelado=0 \
					AND c.fechagas between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY c.fechagas ", condicion_empresa );

			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select c.fechagas as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM gastos c \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
					LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales AS suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = c.fechagas \
					and cuentapol.fechafin=c.fechagas \
					WHERE c.cancelado=0 \
					AND c.fechagas between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY c.fechagas ", condicion_empresa);
			}

		} // fin si es GASTOS
		else if (tipoComp == "NCRG")
		{ // para pólizas de NOTAS DE CREDITO GASTOS

			if (sucursal != "GG")
			{ // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
				@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
				FROM notascredgasto as n \
				INNER JOIN gastos g ON n.gasto=g.referencia \
				INNER JOIN terminales ter ON ter.terminal=g.terminal \
				INNER JOIN secciones sec ON ter.seccion=sec.seccion \
				LEFT JOIN (select fechaini, fechafin, COUNT(*) AS cuenta from polizascont \
				WHERE sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
				fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
				AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
				and cuentapol.fechafin=n.fechanot \
				WHERE sec.sucursal=@Sucursal AND n.cancelado=0 \
				AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
				GROUP BY n.fechanot ");
			}
			else { // no hay pólizas Global o de todas las sucursales
				// se agrupa por fecha para validar fechas de pólizas
				instruccion.sprintf("select n.fechanot as Fecha, @Sucursal as Sucursal, @TipoComprobante as TipoComprobante, \
					@TipoPlantilla as TipoPlantilla, @TipoPoliza as TipoPoliza, 1 as Generar, ifnull(cuentapol.cuenta,0) as TienePoliza \
					FROM notascredgasto as n \
					LEFT JOIN (select fechaini, fechafin, COUNT(DISTINCT pc.nPoliza) AS cuenta from polizascont pc \
                    LEFT JOIN movimientoscont mc ON mc.nPoliza = pc.nPoliza \
					LEFT JOIN sucursales AS suc ON suc.sucursal = mc.sucdetalle \
					WHERE %s pc.sucursal=@Sucursal and tipocomprobante=@TipoComprobante and tipoplantilla=@TipoPlantilla and \
					fechaini BETWEEN @FechaInicioPol AND @FechaFinalPol AND fechafin BETWEEN @FechaInicioPol AND @FechaFinalPol \
					AND enviado=1 group by fechaini, fechafin) cuentapol ON cuentapol.fechaini = n.fechanot \
					and cuentapol.fechafin=n.fechanot \
					WHERE n.cancelado=0 \
					AND n.fechanot between @FechaInicioPol AND @FechaFinalPol \
					GROUP BY n.fechanot ", condicion_empresa);
			}

		} // fin si es NOTAS DE CREDITO GASTOS

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		delete buffer_sql;
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		if (resp_clientes != NULL)
			delete resp_clientes;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPRETEFECSUPERS
void ServidorReportes::EjecutaRepRetiroEfectivoSupers
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, terminal, rangohora, horaini;
	AnsiString listaconceptos, horafin;
	AnsiString condicion_sucursal = " ", condicion_terminal = " ";
	AnsiString condicion_horas = " ", condicion_listaconceptos = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	rangohora = mFg.ExtraeStringDeBuffer(&parametros);
	horaini = mFg.ExtraeStringDeBuffer(&parametros);
	horafin = mFg.ExtraeStringDeBuffer(&parametros);
	listaconceptos = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != "") {
		condicion_sucursal.sprintf(" AND s.sucursal = '%s' ", sucursal);
	}else{
        condicion_sucursal.sprintf(" AND s.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
	}

	if (terminal != "") {
		condicion_terminal.sprintf(" AND rv.terminal='%s' ", terminal);
	}

	if (rangohora == "1") {
		condicion_horas.sprintf(" AND rv.horaretiro BETWEEN '%s' AND '%s' ",
			horaini, horafin);
	}

	if (listaconceptos != " ") {
		condicion_listaconceptos.sprintf(" AND cm.clave IN (%s)",
		listaconceptos);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT \
	rv.terminal, \
	s.sucursal, \
	rv.fechaalta, \
	rv.horaalta, \
	IF(rv.concepto='D','Depositado','Retirado') AS concepto, \
	cm.descripcion, \
	rv.cantretirado, \
	CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario, \
	CONCAT(sup.nombre, ' ', sup.appat, ' ', sup.apmat) AS usuario \
	FROM movsefectivocaja rv \
	INNER JOIN empleados e ON rv.usuario = e.empleado \
	INNER JOIN empleados sup ON rv.usuarioautoriza = sup.empleado \
	INNER JOIN terminales t ON t.terminal = rv.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	LEFT JOIN catalogomovscaja cm ON cm.clave = rv.conceptomovs \
	WHERE rv.fechaalta BETWEEN '%s' AND '%s'\
	%s %s %s %s \
	ORDER BY rv.terminal, rv.fechaalta DESC, rv.horaalta DESC ", fechaini,
		fechafin, condicion_sucursal, condicion_terminal, condicion_horas,
		condicion_listaconceptos);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT \
	IF(rv.concepto='R', 'Total Retirado', 'Total Depositado'), \
	SUM(rv.cantretirado) AS retirado \
	FROM movsefectivocaja rv \
	INNER JOIN terminales t ON t.terminal = rv.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	LEFT JOIN catalogomovscaja cm ON cm.clave = rv.conceptomovs \
	WHERE rv.fechaalta BETWEEN '%s' AND '%s' \
	%s %s %s %s \
	GROUP BY rv.concepto \
	ORDER BY rv.terminal, rv.fechaalta DESC, rv.horaalta DESC ", fechaini,
		fechafin, condicion_sucursal, condicion_terminal, condicion_horas,
		condicion_listaconceptos);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_ARTICULOS_GENERAL
void ServidorReportes::EjecutaRepArtGeneral(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString fecha_inicio, fecha_final, marca, fabricante, segmentos,
		clasifica1;
	AnsiString clasifica2, clasifica3, clasifica_cont, clasifica_cont2,
		clave_Unidad;
	AnsiString prod_Serv_CFDI, prov_principal, articulos_activ, multiplo,
		nom_producto;
	AnsiString clv_producto, mult_product, utilidad, activo, existencias, lista,
		cotizable;
	AnsiString factorcaja, volumenDe, volumenA, pesoDe, pesoA, comisionDe,
		comisionA, porcentajeDe, porcentajeA;
	AnsiString precioDe, precioA, factorDe, factorA, supergerencia, fracciones,
		tipoPrec, sucursal, ieps;

	AnsiString mSucursalExistencias, mParametroEccomerce;
	AnsiString condicion_sucursal_existencias = " ";
	AnsiString condicion_fechas = " ";
	AnsiString condicion_marca = " ", condicion_fabricante = " ",
		condicion_segmentos = " ";

	AnsiString join_presentacion1 = " ", join_presentacion2 = " ",
		join_presentacion3 = " ";

	AnsiString condicion_clasifica1 = " ", join_clasif1 = " ";
	AnsiString condicion_clasifica2 = " ", join_clasif2 = " ";
	AnsiString condicion_clasifica3 = " ", join_clasif3 = " ";
	AnsiString condicion_clasifica_cont = " ", condicion_clasifica_cont2 = " ";
	AnsiString condicion_clave_Unidad = " ", condicion_prod_Serv_CFDI = " ";
	AnsiString condicion_prov_principal = " ";
	AnsiString join_articulos_activ = " ", having_minmax = " ";
	AnsiString condicion_nom_producto = " ", condicion_clv_producto = " ",
		condicion_mult_product = " ";
	AnsiString condicion_utilidad = " ", condicion_activo = " ",
		condicion_existencias = " ";
	AnsiString condicion_art_tags = " ", join_art_tags = " ",
		condicion_cotizable = " ", condicion_factorcaja = " ";
	AnsiString condicion_volumen = " ", condicion_peso = " ",
		condicion_comision = " ", condicion_porcentaje = " ", condicion_precio =
		" ", condicion_factor = " ";
	AnsiString condicion_supergerencia = " ", condicion_fracciones = " ",
		condicion_ieps = " ";

	AnsiString supervisado = "", empleadosupervisor = " ";
	AnsiString condicion_empleadosupervisor = " ", inner_empleadosupervisor =
		" ", campo_supervisado = " ";

	AnsiString noIncluidosEnCartaPorte = " ",
		condicion_NoInluidosEncartaPorte = " ";
	AnsiString estatusarticulos, fecha_inicio_mod, fecha_final_mod;
	AnsiString join_estatusarticulos = " ";

	AnsiString join_ecommerce_articulos = " ";
	AnsiString condicion_ecommerce_articulos = " ";
	AnsiString archivo_temp1, instruccion;
	AnsiString sin_supervisor;
	AnsiString condicion_sin_supervisor = " ";
	AnsiString tipo_imp1, tipo_imp2, negar_imp1, negar_imp2, imp1, imp2,
		modo_util;
	AnsiString condicion_tipoimp1 = " ", condicion_tipoimp2 = " ",
		condicion_imp1 = " ", condicion_imp2 = " ", condicion_modoutil = " ";

	AnsiString muestraStock, join_muestraStock = " ", condicion_muestraStock = " ";

	AnsiString idempresa;
	AnsiString condicion_idempresa_ae=" ";
	AnsiString condicion_idempresa_pcb=" ";
	AnsiString condicion_idempresa_tp=" ";
	AnsiString condicion_idempresa_pb=" ";

	AnsiString condicion_imagen=" ";
	AnsiString condicion_actividades=" ";
	AnsiString condicion_prov_2=" ";

	AnsiString campo_clasifgen_prodpres = "" , inner_clasifgen_prodpres = " ";

	try {
		fecha_inicio =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmentos = mFg.ExtraeStringDeBuffer(&parametros);
		clasifica1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifica2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifica3 = mFg.ExtraeStringDeBuffer(&parametros);
		clasifica_cont = mFg.ExtraeStringDeBuffer(&parametros);
		clasifica_cont2 = mFg.ExtraeStringDeBuffer(&parametros);
		clave_Unidad = mFg.ExtraeStringDeBuffer(&parametros);
		prod_Serv_CFDI = mFg.ExtraeStringDeBuffer(&parametros);
		prov_principal = mFg.ExtraeStringDeBuffer(&parametros);
		articulos_activ = mFg.ExtraeStringDeBuffer(&parametros);
		multiplo = mFg.ExtraeStringDeBuffer(&parametros);
		nom_producto = mFg.ExtraeStringDeBuffer(&parametros);
		clv_producto = mFg.ExtraeStringDeBuffer(&parametros);
		mult_product = mFg.ExtraeStringDeBuffer(&parametros);
		utilidad = mFg.ExtraeStringDeBuffer(&parametros);
		activo = mFg.ExtraeStringDeBuffer(&parametros);
		existencias = mFg.ExtraeStringDeBuffer(&parametros);
		lista = mFg.ExtraeStringDeBuffer(&parametros);
		cotizable = mFg.ExtraeStringDeBuffer(&parametros);
		factorcaja = mFg.ExtraeStringDeBuffer(&parametros);
		volumenDe = mFg.ExtraeStringDeBuffer(&parametros);
		volumenA = mFg.ExtraeStringDeBuffer(&parametros);
		pesoDe = mFg.ExtraeStringDeBuffer(&parametros);
		pesoA = mFg.ExtraeStringDeBuffer(&parametros);
		comisionDe = mFg.ExtraeStringDeBuffer(&parametros);
		comisionA = mFg.ExtraeStringDeBuffer(&parametros);
		porcentajeDe = mFg.ExtraeStringDeBuffer(&parametros);
		porcentajeA = mFg.ExtraeStringDeBuffer(&parametros);
		precioDe = mFg.ExtraeStringDeBuffer(&parametros);
		precioA = mFg.ExtraeStringDeBuffer(&parametros);
		factorDe = mFg.ExtraeStringDeBuffer(&parametros);
		factorA = mFg.ExtraeStringDeBuffer(&parametros);
		supergerencia = mFg.ExtraeStringDeBuffer(&parametros);
		fracciones = mFg.ExtraeStringDeBuffer(&parametros);
		tipoPrec = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		ieps = mFg.ExtraeStringDeBuffer(&parametros);
		empleadosupervisor = mFg.ExtraeStringDeBuffer(&parametros);
		noIncluidosEnCartaPorte = mFg.ExtraeStringDeBuffer(&parametros);
		estatusarticulos = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_inicio_mod =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_mod =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

		mSucursalExistencias = mFg.ExtraeStringDeBuffer(&parametros);
		mParametroEccomerce = mFg.ExtraeStringDeBuffer(&parametros);
		sin_supervisor = mFg.ExtraeStringDeBuffer(&parametros);

		tipo_imp1 = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_imp2 = mFg.ExtraeStringDeBuffer(&parametros);
		imp1 = mFg.ExtraeStringDeBuffer(&parametros);
		imp2 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_imp1 = mFg.ExtraeStringDeBuffer(&parametros);
		negar_imp2 = mFg.ExtraeStringDeBuffer(&parametros);
		modo_util = mFg.ExtraeStringDeBuffer(&parametros);

        muestraStock = mFg.ExtraeStringDeBuffer(&parametros);
		idempresa = mFg.ExtraeStringDeBuffer(&parametros);
		condicion_imagen = mFg.ExtraeStringDeBuffer(&parametros);
		condicion_actividades = mFg.ExtraeStringDeBuffer(&parametros);

		condicion_sucursal_existencias = " ";

		if (mSucursalExistencias != "") {
			condicion_sucursal_existencias.sprintf(" e INNER JOIN almacenes AS a ON e.almacen = a.almacen INNER JOIN secciones     \
				ON a.seccion = secciones.seccion INNER JOIN sucursales ON secciones.sucursal = sucursales.sucursal                 \
				 WHERE sucursales.sucursal ='%s' \
			 ", mSucursalExistencias);
		}else{
            condicion_sucursal_existencias.sprintf(" e INNER JOIN almacenes AS a ON e.almacen = a.almacen INNER JOIN secciones     \
				ON a.seccion = secciones.seccion INNER JOIN sucursales ON secciones.sucursal = sucursales.sucursal                 \
				 WHERE sucursales.idempresa = %s \
			 ", idempresa);
		}

		condicion_fechas.sprintf(" AND (a.fechaalta BETWEEN '%s' AND '%s') ",
			fecha_inicio, fecha_final);

		if (marca != " ") {
			condicion_marca.sprintf(" AND marca='%s' ", marca);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND p.fabricante='%s' ", fabricante);
		}
		// Usaremos el segmento de presentacion
		if (segmentos != " ") {
			condicion_segmentos.sprintf(" AND pcb.segmento='%s' ", segmentos);

		}

		if (clasifica1 != " ") {
			condicion_clasifica1.sprintf(" AND p.clasif1='%s' ", clasifica1);
			join_clasif1.sprintf
				(" LEFT JOIN clasificacion1 c1 on p.clasif1=c1.clasif1 ");
		}

		if (clasifica2 != " ") {
			condicion_clasifica2.sprintf(" AND p.clasif2='%s' ", clasifica2);
			join_clasif2.sprintf
				(" LEFT JOIN clasificacion2 c2 on p.clasif2=c2.clasif2 ");
		}

		if (clasifica3 != " ") {
			condicion_clasifica3.sprintf(" AND p.clasif3='%s' ", clasifica3);
			join_clasif3.sprintf
				(" LEFT JOIN clasificacion3 c3 on p.clasif3=c3.clasif3 ");
		}

		if (clasifica_cont != " ") {
			condicion_clasifica_cont.sprintf(" AND clasifcont='%s' ",
				clasifica_cont);

		}

		if (clasifica_cont2 != " ") {
			condicion_clasifica_cont2.sprintf(" AND clasifcont2='%s' ",
				clasifica_cont2);

		}

		if (clave_Unidad != " ") {
			condicion_clave_Unidad.sprintf(" AND a.idclaveunidadcfdi = '%s' ",
				clave_Unidad);
		}

		if (prod_Serv_CFDI != " ") {
			condicion_prod_Serv_CFDI.sprintf(" AND ccp.cveprodserv = '%s' ",
				prod_Serv_CFDI);

		}

		if (prov_principal != " ") {
			condicion_prov_principal.sprintf(" AND artp.proveedor = '%s' ",
				prov_principal);
		}

		if (prov_principal != " ") {
			if (idempresa == 1){
				condicion_prov_2.sprintf(" AND artp.proveedor_may = '%s' ", prov_principal);
			} else {
				condicion_prov_2.sprintf(" AND artp.proveedor_sup = '%s' ", prov_principal);
			}
		}

		if (articulos_activ != " ") {
			join_articulos_activ.sprintf
				(" INNER JOIN articulosxsuc axs ON a.producto = axs.producto AND a.present = axs.present AND axs.sucursal = '%s' ",
				articulos_activ);

		}

		if (multiplo != " ") {
			if (multiplo == "0") {
				having_minmax.sprintf(" HAVING  MIN(pmm.minmult)=a.multiplo");
			}
			else if (multiplo == "1") {
				having_minmax.sprintf(" HAVING  MAX(pmm.maxmult)=a.multiplo");
			}
		}

		if (nom_producto != " ") {
			// condicion_nom_producto.sprintf(" AND p.nombre LIKE '%s%%' ",nom_producto);
			condicion_nom_producto.sprintf
				("AND (p.nombre LIKE '%s%%' OR a.present LIKE '%s%%')",
				nom_producto, nom_producto);
		}

		if (clv_producto != " ") {
			condicion_clv_producto.sprintf(" AND p.producto='%s' ",
			clv_producto);
		}

		if (mult_product != " ") {
			condicion_mult_product.sprintf(" AND a.multiplo LIKE '%s%' ",
				mult_product);

		}

		if (utilidad != " ") {
			condicion_utilidad.sprintf(" AND ae.tipoutil='%s' ", utilidad);

		}

		if (estatusarticulos == "2") {
			if (activo != " ") {
				if (activo == "0") {
					condicion_activo.sprintf(" AND a.activo=0");
				}
				else if (activo == "1") {
					condicion_activo.sprintf(" AND a.activo=1 ");
				}
			}
		}
		else {
			if (estatusarticulos == "0") {
				condicion_activo.sprintf
					(" AND (bita.activoant = 1 AND bita.activo = 0) AND a.activo=0 "
					);
			}
			else if (estatusarticulos == "1") {
				condicion_activo.sprintf
					(" AND (bita.activoant = 0 AND bita.activo = 1) AND a.activo=1 "
					);
			}
			join_estatusarticulos.sprintf
				(" INNER JOIN bitacoraart bita ON bita.articulo = a.articulo AND bita.fecha BETWEEN '%s' AND '%s' ",
				fecha_inicio_mod, fecha_final_mod);
		}

		if (existencias != " ") {
			if (existencias == "0") {
				condicion_existencias.sprintf
					(" AND (p.producto, a.present) in(select producto, present from existenciasactuales %s group by producto, present having sum(cantidad)<=0) ",
					condicion_sucursal_existencias);
			}
			else if (existencias == "1") {
				condicion_existencias.sprintf
					(" AND (p.producto, a.present) in(select producto, present from existenciasactuales %s group by producto, present having sum(cantidad)>0) ",
					condicion_sucursal_existencias);
			}
		}

		if (lista != " ") {
			join_art_tags.sprintf
				(" INNER JOIN articulostagsasignados artt ON artt.producto=a.producto AND artt.present=a.present "
				);
			condicion_art_tags.sprintf
				(" AND artt.idarticulotag in (%s) ", lista);
		}

		if (cotizable != "0") {
			condicion_cotizable.sprintf(" AND pre.cotizable=1 ");
		}

		if (factorcaja != "0") {
			condicion_factorcaja.sprintf
				(" AND pmm.maxfactor<>pmm.cajalogisticafactor ");
		}

		if (volumenDe != " " && volumenA != " ") {
			condicion_volumen.sprintf("AND (a.volumen BETWEEN %s AND %s)",
				volumenDe, volumenA);
		}

		if (pesoDe != " " && pesoA != " ") {
			condicion_peso.sprintf("AND (a.peso BETWEEN %s AND %s)",
				pesoDe, pesoA);
		}

		if (comisionDe != " " && comisionA != " ") {
			condicion_comision.sprintf("AND (a.porccomi BETWEEN %s AND %s)",
				comisionDe, comisionA);
		}

		if (porcentajeDe != " " && porcentajeA != " ") {
			condicion_porcentaje.sprintf("AND (pr.porcutil BETWEEN %s AND %s)",
				porcentajeDe, porcentajeA);
		}

		if (precioDe != " " && precioA != " ") {
			condicion_precio.sprintf(" AND (pr.precio BETWEEN %s AND %s) ",
				precioDe, precioA);
		}

		if (factorDe != " " && factorA != " ") {
			condicion_factor.sprintf(" AND (a.factor BETWEEN %s AND %s) ",
				factorDe, factorA);
		}

		if (supergerencia != "0") {
			condicion_supergerencia.sprintf(" AND pre.sgerencia=1 ");
		}

		if (fracciones != "0") {
			condicion_fracciones.sprintf(" AND pre.permitfrac=1 ");
		}

		if (ieps != "0") {
			condicion_ieps.sprintf(" AND pre.iepscuota<>0 ");
		}

		if (empleadosupervisor != " ") {
			condicion_empleadosupervisor.sprintf(" AND ars.usuario='%s'  ",
				empleadosupervisor);
		}

		if (noIncluidosEnCartaPorte != "0") {
			condicion_NoInluidosEncartaPorte.sprintf
				(" and ccp.cveprodserv NOT IN (SELECT cveprod FROM ccpclaveprod) AND pmm.activo = 1 "
				);
		}

		if (mParametroEccomerce != " ") {

			if(mParametroEccomerce == "0" || mParametroEccomerce == "1" || mParametroEccomerce == "2") {
				join_ecommerce_articulos.sprintf(" LEFT JOIN ecommerceproductos ecom ON a.articulo = ecom.articulo ");
			}

			if (mParametroEccomerce == "0") { // Abmbos
				condicion_ecommerce_articulos = " AND (ecom.shopify = 1 OR ecom.rappi = 1 OR ae.activoecom = 1 OR ae.activokiosko = 1) ";
			} else if (mParametroEccomerce == "1") { // Shopofy
				condicion_ecommerce_articulos = " AND (ecom.shopify = 1 ) ";
			} else if (mParametroEccomerce == "2") { // Rappi
				condicion_ecommerce_articulos = " AND ( ecom.rappi = 1) ";
			} else if (mParametroEccomerce == "3") { // Ecommerce
				condicion_ecommerce_articulos = " AND ae.activoecom = 1 ";
			} else if (mParametroEccomerce == "4") { // Ecommerce
				condicion_ecommerce_articulos = " AND ae.activokiosko = 1 ";
			}
		}

		if (sin_supervisor != " ") {
			condicion_sin_supervisor = "AND c.activo = 0 ";
		}
		else {
			condicion_sin_supervisor = " ";
		}

		if (tipo_imp1 != " ") {
			if (negar_imp1 == 0) {
				condicion_tipoimp1.sprintf("and (i1.tipoimpu='%s' or i2.tipoimpu='%s'\
				or i3.tipoimpu='%s'\
				or i4.tipoimpu='%s')", tipo_imp1, tipo_imp1, tipo_imp1,
					tipo_imp1);
			}
			else {
				condicion_tipoimp1.sprintf("and(IFNULL(i1.tipoimpu,'')<>'%s'\
					and  IFNULL(i2.tipoimpu,'')<>'%s'\
					and IFNULL(i3.tipoimpu,'')<>'%s'\
					and IFNULL(i4.tipoimpu,'')<>'%s') ", tipo_imp1, tipo_imp1,
					tipo_imp1, tipo_imp1);
			}
		}

		if (tipo_imp2 != " ") {
			if (negar_imp2 == 0) {
				condicion_tipoimp2.sprintf("and (i1.tipoimpu='%s' or i2.tipoimpu='%s'\
				or i3.tipoimpu='%s'\
				or i4.tipoimpu='%s')", tipo_imp2, tipo_imp2, tipo_imp2,
					tipo_imp2);
			}
			else {
				condicion_tipoimp2.sprintf("and(IFNULL(i1.tipoimpu,'')<>'%s'\
					and  IFNULL(i2.tipoimpu,'')<>'%s'\
					and IFNULL(i3.tipoimpu,'')<>'%s'\
					and IFNULL(i4.tipoimpu,'')<>'%s') ", tipo_imp2, tipo_imp2,
					tipo_imp2, tipo_imp2);
			}

		}

		if (imp1 != " ") {
			if (negar_imp1 == 0) {
				condicion_tipoimp1.sprintf("and (i1.impuesto='%s' or i2.impuesto='%s'\
				or i3.impuesto='%s'\
				or i4.impuesto='%s')", imp1, imp1, imp1, imp1);
			}
			else {
				condicion_tipoimp1.sprintf("and(IFNULL(i1.impuesto,'')<>'%s'\
					and  IFNULL(i2.impuesto,'')<>'%s'\
					and IFNULL(i3.impuesto,'')<>'%s'\
					and IFNULL(i4.impuesto,'')<>'%s') ", imp1, imp1,
				imp1, imp1);
			}
		}

		if (imp2 != " ") {
			if (negar_imp2 == 0) {
				condicion_tipoimp2.sprintf("and (i1.impuesto='%s' or i2.impuesto='%s'\
				or i3.impuesto='%s'\
				or i4.impuesto='%s')", imp2, imp2, imp2, imp2);
			}
			else {
				condicion_tipoimp2.sprintf("and(IFNULL(i1.impuesto,'')<>'%s'\
					and  IFNULL(i2.impuesto,'')<>'%s'\
					and IFNULL(i3.impuesto,'')<>'%s'\
					and IFNULL(i4.impuesto,'')<>'%s') ", imp2, imp2,
				imp2, imp2);
			}
		}

		if (modo_util != " ") {
			condicion_modoutil.sprintf(" AND pre.modoutil = %s ", modo_util);
		}

		if (muestraStock != " ") {
			if (muestraStock == "1") { //seleccionado
				condicion_muestraStock.sprintf(" stock.minimo, stock.maximo, stock.reorden, ");
				join_muestraStock.sprintf(" LEFT JOIN stock ON stock.producto = a.producto AND stock.present = a.present AND stock.sucursal = '%s' ",sucursal);
			}
			else if (muestraStock == "0") { //sin seleccionar
				condicion_muestraStock.sprintf(" 0 as minimo, 0 as maximo, 0 as reorden, ");
				join_muestraStock.sprintf(" ");
			}
		}

		if(idempresa!=" "){
			condicion_idempresa_pcb.sprintf(" AND pcb.idempresa=%s ", idempresa);
			condicion_idempresa_tp.sprintf(" AND tp.idempresa=%s ", idempresa);
			condicion_idempresa_ae.sprintf(" AND ae.idempresa=%s ", idempresa);
			condicion_idempresa_pb.sprintf(" AND pb.idempresa=%s ", idempresa);

			campo_clasifgen_prodpres.sprintf(" , ce.clasificacion_compuesta ");
			inner_clasifgen_prodpres.sprintf(" LEFT JOIN clasificacion_articulos_empresas ce ON a.producto = ce.producto AND a.present = ce.present AND ce.idempresa = %s ", idempresa );
		}

		if(condicion_imagen!=" "){
			condicion_imagen.sprintf(" AND EXISTS \
											(SELECT id \
											FROM imagenesarticulos \
											WHERE producto = p.producto \
											AND present = a.present \
											HAVING COUNT(*) %s) ", condicion_imagen);
		}

		if(condicion_actividades!=" "){
			AnsiString act = condicion_actividades.SubString(1,2);
			AnsiString grup = condicion_actividades.SubString(3,2);
			AnsiString actExist = condicion_actividades.SubString(5,2);

			AnsiString havingPart, gr1, gr2, existPart;

			if(act == "SA"){
				havingPart = "MAX(artcfg.permiteventas) = 0 \
								AND MAX(artcfg.permitecompras) = 0 \
								AND MAX(artcfg.permitemovalma) = 0 ";
			}else{
				havingPart = "MIN(artcfg.permiteventas) = 1 \
								AND MIN(artcfg.permitecompras) = 1 \
								AND MIN(artcfg.permitemovalma) = 1 ";
			}

			if(grup == "PM"){
				gr1 = ", art2.multiplo ";
				gr2 = ", art3.multiplo ";
			}else{
				gr1 = " ";
				gr2 = " ";
			}

			if(actExist == "CE"){
				existPart.sprintf(" AND (art2.producto, \
										art2.present \
										%s) IN \
										(SELECT e.producto, \
											e.present \
											 %s \
										FROM existenciasactuales e \
										INNER JOIN almacenes alm ON alm.almacen = e.almacen \
										INNER JOIN secciones s ON s.seccion = alm.seccion \
										INNER JOIN sucursales suc ON s.sucursal = suc.sucursal \
										INNER JOIN articulos art3 ON art3.producto = e.producto \
											AND art3.present = e.present \
											WHERE suc.idempresa = %s \
										GROUP BY art3.producto, \
											art3.present \
											%s \
										HAVING sum(e.cantidad) <> 0) ", gr1, gr2, idempresa, gr2);
			} else {
				if(actExist == "SE"){
					existPart.sprintf(" AND (art2.producto, \
										art2.present \
										%s) IN \
										(SELECT e.producto, \
											e.present \
											 %s \
										FROM existenciasactuales e \
										INNER JOIN almacenes alm ON alm.almacen = e.almacen \
										INNER JOIN secciones s ON s.seccion = alm.seccion \
										INNER JOIN sucursales suc ON s.sucursal = suc.sucursal \
										INNER JOIN articulos art3 ON art3.producto = e.producto \
											AND art3.present = e.present \
											WHERE suc.idempresa = %s \
										GROUP BY art3.producto, \
											art3.present \
											%s \
										HAVING sum(e.cantidad) = 0) ", gr1, gr2, idempresa, gr2);
				}else{
					existPart = " ";
				}
			}

			condicion_actividades.sprintf("AND (a.articulo) IN \
											(SELECT artcfg.articulo \
											FROM articuloempresacfg artcfg \
											INNER JOIN articulos art2 ON artcfg.articulo = art2.articulo \
											WHERE artcfg.idempresa = %s \
												%s \
											GROUP BY art2.producto, \
												art2.present \
												%s \
											HAVING %s )", idempresa, existPart, gr1, havingPart);
		}

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(1, Respuesta->Id);

		// guarda productos, presentacion de un correspondiente proveedor princial, sucursal, etc
		instruccion = "CREATE TEMPORARY TABLE artprovprinaux (producto VARCHAR(8), present VARCHAR(255), \
		proveedor_may VARCHAR(11), proveedor_sup VARCHAR(11), \
		duracionreorden DECIMAL(5,2), \
		duracionmax DECIMAL(5,2),\
		clveprovm VARCHAR(15), \
		clveprovs VARCHAR(15), \
		INDEX(producto, present)) ENGINE = INNODB;";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "CREATE TEMPORARY TABLE auxprovxempresa1 (producto VARCHAR(8), present VARCHAR(255), provm VARCHAR(11), claveprovm VARCHAR(15), INDEX(producto, present)) ENGINE = INNODB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "CREATE TEMPORARY TABLE auxprovxempresa2 (producto VARCHAR(8), present VARCHAR(255), provs VARCHAR(11), claveprovs VARCHAR(15), INDEX(producto, present)) ENGINE = INNODB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf("INSERT INTO auxprovxempresa1 \
		SELECT \
			artp.producto, \
			artp.present, \
			IFNULL(prov.proveedor, '') AS provm, \
			MAX(artp.claveproductoproveedor) \
		FROM articulosped artp \
			INNER JOIN sucursales s ON s.sucursal = artp.sucursal \
			LEFT JOIN proveedores prov ON prov.proveedor = artp.proveedor \
		WHERE s.idempresa = 1 \
		GROUP BY artp.producto, artp.present ");

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf("INSERT INTO auxprovxempresa2 \
		SELECT \
			artp.producto, \
			artp.present, \
			IFNULL(prov.proveedor, '') AS provs, \
			MAX(artp.claveproductoproveedor) \
		FROM articulosped artp \
			INNER JOIN sucursales s ON s.sucursal = artp.sucursal \
			LEFT JOIN proveedores prov ON prov.proveedor = artp.proveedor \
		WHERE s.idempresa = 2 \
		GROUP BY artp.producto, artp.present ");

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf(" \
		SELECT artp.producto, artp.present, \
		ifnull(apxe1.provm,'') AS proveedor_may, \
		ifnull(apxe2.provs,'') AS proveedor_sup, \
		artp.duracionreorden, \
		artp.duracionmax, \
		apxe1.claveprovm, \
		apxe2.claveprovs \
		FROM articulosped artp \
		INNER JOIN auxprovxempresa1 apxe1 ON apxe1.producto = artp.producto AND apxe1.present = artp.present \
		LEFT JOIN auxprovxempresa2 apxe2 ON apxe1.producto = apxe2.producto AND apxe1.present = apxe2.present \
		WHERE 1 %s   \
		GROUP BY artp.producto, artp.present \
		INTO OUTFILE '%s' ", condicion_prov_principal, archivo_temp1);

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE artprovprinaux (producto, present, proveedor_may, proveedor_sup, duracionreorden, duracionmax, clveprovm, clveprovs ) ",
			archivo_temp1);

		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		Instruccion.sprintf("SELECT a.articulo,p.producto,p.nombre,a.present,a.multiplo, a.factor, pr.tipoprec, p.marca, \
		IF(pre.permitfrac=0,'NO','SI') as permitfrac , \
		IF(ae.tipoutil=0,'Manual',IF(ae.tipoutil=1,'Automatica',IF(ae.tipoutil=2,'Automatica 2', \
		IF(ae.tipoutil=3,'Automatica 3',IF(ae.tipoutil=4,'Automatica 4','Automatica 5'))))) AS utilidad, \
		pr.costo, \
		pr.porcutil, pr.precio, pr.precioproximo,a.porccomi, p.clasif3, c3.nombre , \
		fb.fabricante, fb.nombre, se.segmento, se.nombre, \
		a.peso,a.volumen,a.altura,a.longitud,a.profundidad, \
		i1.tipoimpu, i2.tipoimpu, i3.tipoimpu, i4.tipoimpu, \
		ic1.tipoimpu, ic2.tipoimpu, ic3.tipoimpu, ic4.tipoimpu, \
		%s \
		a.ean13 as codigos, \
		IF(a.activo=1,'ACTIVO','INACTIVO'),IF(ISNULL(pb.producto),'NO','SI') as bloqueado, \
		CONCAT(ccu.claveunidad,' ',ccu.nombre) as claveunidad, CONCAT(ccp.cveprodserv,' ',ccp.descripcion) as claveprodserv, \
		pmm.maxfactor, pmm.maxmult, pmm.cajalogisticafactor, \
		c2.nombre, c1.nombre, \
		prov_m.razonsocial, \
		prov.razonsocial, \
		concat(emp.nombre, ' ', emp.appat,' ', emp.apmat) AS supervisado, \
		IF(a.asigautosu = '1', 'Sí', 'No'), \
		IF(pre.sgerencia = '1', 'Sí', 'No'), \
		IF(pre.cotizable = '1', 'Sí', 'No') \
		,artp.duracionreorden, artp.duracionmax\
		,p.claveimpv1, p.claveimpv2, p.idgraduacion, p.claveimpc1, p.claveimpc2, p.etiquetasgr, a.idclaveunidadcfdi \
		,pre.cotizable, pre.modoutil, pre.sgerencia, pre.permitfrac, pre.idempaque,pre.idunidad, pre.presentsat, pre.iepscuota \
		,ccu.idclaveunidad, a.porccomi, a.activo, a.asigautosu, ae.tipoutil,emp.empleado, \
		p.clasif2 , p.clasif1, p.clasifcont, p.clasifcont2,ccp.idclaveprodserv, \
		IF(ae.idempresa = 1, artp.clveprovm, artp.clveprovs) AS claveproductoproveedor \
		%s \
		FROM articulos a \
		INNER JOIN articulosemp ae ON ae.articulo=a.articulo %s \
		INNER JOIN productos p ON a.producto=p.producto \
		INNER JOIN presentaciones pre ON a.producto=pre.producto  \
		INNER JOIN presentacionescb pcb ON pcb.producto=pre.producto AND pcb.present=pre.present %s \
		INNER JOIN precios pr ON pr.articulo = a.articulo AND pr.tipoprec = '%s'  \
		INNER JOIN tiposdeprecios tp ON tp.tipoprec=pr.tipoprec %s \
		INNER JOIN cclaveunidad ccu ON ccu.idclaveunidad = a.idclaveunidadcfdi     \
		INNER JOIN cclaveprodserv ccp ON ccp.idclaveprodserv = p.idclaveprodservcfdi \
		INNER JOIN presentacionesminmax pmm ON a.producto=pmm.producto and a.present=pmm.present \
		INNER JOIN clasificacion1 c1 ON c1.clasif1 = p.clasif1 \
		INNER JOIN clasificacion2 c2 ON c2.clasif2 = p.clasif2 \
		INNER JOIN clasificacion3 c3 ON c3.clasif3 = p.clasif3 \
		%s \
		%s  \
        %s \
		LEFT JOIN preciosbloqueados pb ON pb.producto = pre.producto  AND pb.present = pre.present AND pb.present = pre.present AND CURDATE()<=pb.fechaVigencia %s \
		LEFT JOIN fabricantes fb ON p.fabricante=fb.fabricante  \
		LEFT JOIN segmentos se ON pcb.segmento=se.segmento \
		LEFT JOIN artprovprinaux artp ON artp.producto = p.producto AND artp.present = a.present \
		LEFT JOIN proveedores prov_m ON prov_m.proveedor = artp.proveedor_may \
		LEFT JOIN proveedores prov ON prov.proveedor = artp.proveedor_sup \
		LEFT JOIN articulossupervisados ars ON ars.producto=p.producto and ars.present=pre.present  \
		LEFT JOIN empleados emp on emp.empleado=ars.usuario \
		%s \
		LEFT JOIN impuestos i1 ON i1.impuesto = p.claveimpv1 \
		LEFT JOIN impuestos i2 ON i2.impuesto = p.claveimpv2 \
		LEFT JOIN impuestos i3 ON i3.impuesto = p.claveimpv3 \
		LEFT JOIN impuestos i4 ON i4.impuesto = p.claveimpv4 \
		LEFT JOIN impuestos ic1 ON i1.impuesto = p.claveimpc1 \
		LEFT JOIN impuestos ic2 ON i2.impuesto = p.claveimpc2 \
		LEFT JOIN impuestos ic3 ON i3.impuesto = p.claveimpc3 \
		LEFT JOIN impuestos ic4 ON i4.impuesto = p.claveimpc4 \
		LEFT JOIN compradores c ON emp.empleado = c.empleado \
		%s \
		%s \
		WHERE pre.present=a.present \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s %s %s %s %s \
		%s \
		group BY a.articulo \
		%s \
		order by p.nombre, pre.present, a.factor, a.multiplo ", condicion_muestraStock, campo_clasifgen_prodpres,
			condicion_idempresa_ae, condicion_idempresa_pcb, tipoPrec, condicion_idempresa_tp,
			join_articulos_activ, join_estatusarticulos, inner_clasifgen_prodpres ,condicion_idempresa_pb,
			join_muestraStock, //sucursal,
			join_art_tags, join_ecommerce_articulos,
			condicion_ecommerce_articulos, condicion_activo,
			condicion_existencias, condicion_marca, condicion_peso,
			condicion_volumen, condicion_comision, condicion_porcentaje,
			condicion_clv_producto, condicion_clasifica1, condicion_clasifica2,
			condicion_clasifica3, condicion_clasifica_cont,
			condicion_clasifica_cont2, condicion_supergerencia,
			condicion_fracciones, condicion_utilidad, condicion_nom_producto,
			condicion_fechas, condicion_clave_Unidad, condicion_prod_Serv_CFDI,
			condicion_mult_product, condicion_precio, condicion_prov_2,
			condicion_cotizable, condicion_factorcaja, condicion_factor,
			condicion_fabricante, condicion_segmentos, condicion_art_tags,
			condicion_ieps, condicion_empleadosupervisor,
			condicion_NoInluidosEncartaPorte, condicion_sin_supervisor,
			condicion_tipoimp1, condicion_tipoimp2, condicion_imp1,
			condicion_imp2, condicion_modoutil, condicion_imagen, condicion_actividades, having_minmax);

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			Instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {
		if (archivo_temp1 != "") {
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		}

	}
}

// ---------------------------------------------------------------------------
// ID_EJE_ARTICULOS_TAG
void ServidorReportes::EjecutaRepArtTag(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[100];
	AnsiString archivo_temp1, archivo_temp2;
	int IdTag = 1;

	try {
		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechafinal=CURDATE()");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("set @inicioventa:=DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ");
		instrucciones[num_instrucciones++] = instruccion;

		// Suma el subtotal de ventas
		instruccion =
			"SELECT @sumados:=SUM(subtotal) FROM precalculoventas pv " "INNER JOIN ventas v ON pv.referencia=v.referencia AND v.cancelado=0 "
			"WHERE v.fechavta BETWEEN @inicioventa AND @fechafinal ";
		instrucciones[num_instrucciones++] = instruccion;

		// table registrosaux
		instruccion =
			" create temporary table registrosaux (producto VARCHAR(8), present VARCHAR(255), " "subtotal decimal(12,3), porcentaje decimal(12,3), primary key (producto,present) ) ENGINE=InnoDB ";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf
			("SELECT pvd.producto, pvd.present, SUM(pvd.subtotal) AS subtotal, sum(pvd.subtotal*100)/@sumados AS porcentaje "
			"FROM precalculoventas pv " "INNER JOIN ventas v ON pv.referencia=v.referencia AND v.cancelado=0 "
			"INNER JOIN precalculoventasdet pvd ON pvd.referencia=pv.referencia " "WHERE v.fechavta BETWEEN @inicioventa AND @fechafinal "
			"GROUP BY producto, present " "INTO OUTFILE '%s'", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE  registrosaux ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// table clasificacionaux
		instruccion =
			" create temporary table clasificacionaux (producto VARCHAR(8),	present VARCHAR(255), " "subtotal decimal(12,3), porcentaje decimal(12,3) ,sumaporcentaje decimal(12,3), "
			"posicion integer, primary key (producto,present) ) ENGINE=INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf
			(" SELECT * FROM ( "
			" 	SELECT producto, present, subtotal,porcentaje, sum(porcentaje) OVER (ORDER BY porcentaje DESC) AS sumaporcent, " " 	SUM(1) OVER (ORDER BY porcentaje DESC, subtotal DESC) AS posicion "
			" 	FROM registrosaux " " ) t " " ORDER BY posicion "
			"INTO OUTFILE '%s'", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf
			("LOAD DATA INFILE '%s' INTO TABLE clasificacionaux ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			// Resultado final
			instruccion =
				"select ca.posicion, p.nombre,  ca.producto,ca.present, ca.subtotal, ca.porcentaje, ca.sumaporcentaje " "from clasificacionaux ca "
				"INNER JOIN productos p ON ca.producto=p.producto " "order by ca.posicion asc ";

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
		if (archivo_temp1 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		if (archivo_temp2 != "")
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
	}

}

// ---------------------------------------------------------------------------
// ID_EJE_REP_TENDENCIA_VENTAS_CLI
void ServidorReportes::EjecutaRepTendVtaCli(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString Instruccion, instrucciones[1000];
	int i;

	AnsiString fecha_ini_global, fecha_fin_global, fecha_ini_reciente, sucursal,
		vendedor, cliente, producto, presentacion, listaOrigenVenta;
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3;

	AnsiString condicion_sucursal = " ", condicion_vendedor = " ",
		condicion_cliente = " ", condicion_producto = " ",
		condicion_presentacion = " ", condicion_origen_venta = " ";

	fecha_ini_global =
		mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin_global =
		mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_ini_reciente =
		mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);
	presentacion = mFg.ExtraeStringDeBuffer(&parametros);
	listaOrigenVenta = mFg.ExtraeStringDeBuffer(&parametros);
	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND s.sucursal = '%s' ", sucursal);
	}else{
		condicion_sucursal.sprintf(" AND s.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
	}

	if (vendedor != " ") {
		condicion_vendedor.sprintf(" AND cemp.vendedor='%s' ", vendedor);
	}

	if (cliente != " ") {
		condicion_cliente.sprintf(" AND c.cliente='%s' ", cliente);
	}

	if (producto != "") {
		condicion_producto.sprintf(" AND pvd.producto='%s' ", producto);
	}

	if (presentacion != "") {
		condicion_presentacion.sprintf(" AND pvd.present='%s' ", presentacion);
	}

    if (listaOrigenVenta != " ") {
		condicion_origen_venta.sprintf(" AND v.tipoorigen IN (%s) ", listaOrigenVenta);
	}

	if (producto != "") {
            try {
			Instruccion.sprintf
				("CREATE TEMPORARY TABLE totventrecientesaux(totvent DOUBLE) ENGINE = INNODB");
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT SUM(pvd.total) AS totvent \
				FROM precalculoventasdet pvd \
				INNER JOIN ventas v ON v.referencia = pvd.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				WHERE v.fechavta BETWEEN '%s' AND '%s' \
				AND v.cancelado = 0 \
				%s %s %s %s INTO OUTFILE '%s'  ", fecha_ini_reciente, fecha_fin_global,
				condicion_sucursal, condicion_producto, condicion_presentacion, condicion_origen_venta, archivo_temp1);
				instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE totventrecientesaux (totvent) ",
					archivo_temp1);
				instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE ventrecientescliaux(cliente VARCHAR(11), ventrecientescli DOUBLE, \
				totventrecientes DOUBLE, INDEX(cliente)) ENGINE = INNODB");
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT v.cliente, SUM(pvd.total) AS ventrecientescli, \
				tvr.totvent AS totventrecientes \
				FROM precalculoventasdet pvd \
				INNER JOIN ventas v ON v.referencia = pvd.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal  \
				INNER JOIN secciones s ON s.seccion = t.seccion     \
				INNER JOIN clientes c ON v.cliente=c.cliente        \
				INNER JOIN totventrecientesaux tvr                  \
				WHERE v.fechavta BETWEEN '%s' AND '%s'              \
				AND v.cancelado = 0                                 \
				%s %s %s %s                               					\
				GROUP BY v.cliente INTO OUTFILE '%s'  ", fecha_ini_reciente, fecha_fin_global,
					condicion_sucursal, condicion_producto, condicion_presentacion, condicion_origen_venta, archivo_temp2);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE ventrecientescliaux (cliente, ventrecientescli, totventrecientes) ",
					archivo_temp2);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("CREATE TEMPORARY TABLE totventrangoaux(totventglob DOUBLE) ENGINE = INNODB"
				);
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT SUM(pvd.total) AS totventglob \
				FROM precalculoventasdet pvd \
				INNER JOIN ventas v ON v.referencia = pvd.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal  \
				INNER JOIN secciones s ON s.seccion = t.seccion     \
				WHERE v.fechavta BETWEEN '%s' AND '%s'              \
				AND v.cancelado = 0                                 \
				%s %s %s %s \
				INTO OUTFILE '%s'  ", fecha_ini_global, fecha_fin_global,
				condicion_sucursal, condicion_producto, condicion_presentacion, condicion_origen_venta, archivo_temp3);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE totventrangoaux (totventglob) ",
				archivo_temp3);
			instrucciones[num_instrucciones++] = Instruccion;

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql = mFg.AgregaStringABuffer
				(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				// Resultado final
				Instruccion.sprintf("SELECT                                                         \
				v.cliente,                                                                          \
				c.rsocial,                                                                          \
				CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS nomvendedor,                        \
				SUM(pvd.total) AS totventcli, \
				IFNULL(vrca.ventrecientescli, 0) AS ventrecientescli, \
				(SUM(pvd.total)*.25) AS ventesperadascli, \
				((((SUM(pvd.total) / tvr.totventglob)) - IFNULL((vrca.ventrecientescli / vrca.totventrecientes), 0)) / (SUM(pvd.total) / tvr.totventglob)) * - 100 AS pdiferenciaponderada, \
				IFNULL(vrca.ventrecientescli, 0)-(SUM(pvd.total) * .25) AS diferenciacontraesperado \
				FROM precalculoventasdet pvd \
				INNER JOIN ventas v ON v.referencia = pvd.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal                                  \
				INNER JOIN secciones s ON s.seccion = t.seccion                                     \
				INNER JOIN clientes c ON v.cliente=c.cliente                                      \
				INNER JOIN totventrangoaux tvr                                                      \
				LEFT JOIN ventrecientescliaux vrca ON vrca.cliente = v.cliente                      \
				LEFT JOIN clientesemp cemp ON c.cliente= cemp.cliente %s \
				LEFT JOIN empleados e ON cemp.vendedor=e.empleado %s\
				WHERE v.fechavta BETWEEN '%s' AND '%s'                              				\
				AND v.cancelado = 0                                                                 \
				%s %s %s %s                                                             					\
				GROUP BY v.cliente                                                                  \
				ORDER BY diferenciacontraesperado ASC, pdiferenciaponderada ASC ",
					condicion_vendedor, condicion_cliente, fecha_ini_global,
					fecha_fin_global, condicion_sucursal, condicion_producto,
					condicion_presentacion, condicion_origen_venta);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);
			}
		}
		__finally {
			delete buffer_sql;
			if (archivo_temp1 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			}
			if (archivo_temp2 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			}
			if (archivo_temp3 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			}
		}
	} else {
        try {
			Instruccion.sprintf
				("CREATE TEMPORARY TABLE totventrecientesaux(totvent DOUBLE) ENGINE = INNODB");
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT                          \
				SUM(pv.total) AS totvent                             \
				FROM precalculoventas pv                             \
				INNER JOIN ventas v ON v.referencia = pv.referencia  \
				INNER JOIN terminales t ON t.terminal = v.terminal   \
				INNER JOIN secciones s ON s.seccion = t.seccion      \
		  		WHERE v.fechavta BETWEEN '%s' AND '%s'				 \
				AND v.cancelado = 0                                  \
				%s %s INTO OUTFILE '%s'  ", fecha_ini_reciente, fecha_fin_global,
				condicion_sucursal, condicion_origen_venta, archivo_temp1);
				instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE totventrecientesaux (totvent) ",
					archivo_temp1);
				instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE ventrecientescliaux(cliente VARCHAR(11), ventrecientescli DOUBLE, \
				totventrecientes DOUBLE, INDEX(cliente)) ENGINE = INNODB");
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT                         \
				v.cliente,                                          \
				SUM(pv.total) AS ventrecientescli,                  \
				tvr.totvent AS totventrecientes                     \
				FROM precalculoventas pv                            \
				INNER JOIN ventas v ON v.referencia = pv.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal  \
				INNER JOIN secciones s ON s.seccion = t.seccion     \
				INNER JOIN clientes c ON v.cliente=c.cliente        \
				INNER JOIN totventrecientesaux tvr                  \
				WHERE v.fechavta BETWEEN '%s' AND '%s'              \
				AND v.cancelado = 0                                 \
				%s %s                              					\
				GROUP BY v.cliente INTO OUTFILE '%s'  ", fecha_ini_reciente,
					fecha_fin_global, condicion_sucursal, condicion_origen_venta, archivo_temp2);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE ventrecientescliaux (cliente, ventrecientescli, totventrecientes) ",
					archivo_temp2);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("CREATE TEMPORARY TABLE totventrangoaux(totventglob DOUBLE) ENGINE = INNODB"
				);
			instrucciones[num_instrucciones++] = Instruccion;

			archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			Instruccion.sprintf("SELECT                         \
				SUM(pv.total) AS totventglob                        \
				FROM precalculoventas pv                            \
				INNER JOIN ventas v ON v.referencia = pv.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal  \
				INNER JOIN secciones s ON s.seccion = t.seccion     \
				WHERE v.fechavta BETWEEN '%s' AND '%s'              \
				AND v.cancelado = 0                                 \
				%s %s INTO OUTFILE '%s'  ", fecha_ini_global, fecha_fin_global,
				condicion_sucursal, condicion_origen_venta, archivo_temp3);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf
				("LOAD DATA INFILE '%s' INTO TABLE totventrangoaux (totventglob) ",
				archivo_temp3);
			instrucciones[num_instrucciones++] = Instruccion;

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql = mFg.AgregaStringABuffer
				(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				// Resultado final
				Instruccion.sprintf("SELECT                                                         \
				v.cliente,                                                                          \
				c.rsocial,                                                                          \
				CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS nomvendedor,                        \
				SUM(pv.total) AS totventcli,                                                        \
				IFNULL(vrca.ventrecientescli, 0) AS ventrecientescli,                               \
				(SUM(pv.total)*.25) AS ventesperadascli,                                            \
				((((SUM(pv.total) / tvr.totventglob)) - IFNULL((vrca.ventrecientescli / vrca.totventrecientes), 0)) / (SUM(pv.total) / tvr.totventglob)) * - 100 AS pdiferenciaponderada, \
				IFNULL(vrca.ventrecientescli, 0)-(SUM(pv.total) * .25) AS diferenciacontraesperado  \
				FROM precalculoventas pv                                                            \
				INNER JOIN ventas v ON v.referencia = pv.referencia                                 \
				INNER JOIN terminales t ON t.terminal = v.terminal                                  \
				INNER JOIN secciones s ON s.seccion = t.seccion                                     \
				INNER JOIN clientes c ON v.cliente=c.cliente                                      \
				INNER JOIN totventrangoaux tvr                                                      \
				LEFT JOIN ventrecientescliaux vrca ON vrca.cliente = v.cliente                      \
				LEFT JOIN clientesemp cemp ON c.cliente= cemp.cliente %s\
				LEFT JOIN empleados e ON cemp.vendedor=e.empleado %s\
				WHERE v.fechavta BETWEEN '%s' AND '%s'                              				\
				AND v.cancelado = 0                                                                 \
				%s %s                                                               					\
				GROUP BY v.cliente                                                                  \
				ORDER BY diferenciacontraesperado ASC, pdiferenciaponderada ASC ",
					condicion_vendedor, condicion_cliente, fecha_ini_global,
					fecha_fin_global, condicion_sucursal, condicion_origen_venta);
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);
			}
		}
		__finally {
			delete buffer_sql;
			if (archivo_temp1 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			}
			if (archivo_temp2 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			}
			if (archivo_temp3 != "") {
				mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			}
		}
    }

}

// ---------------------------------------------------------------------------
// ID_EJE_REP_TENDENCIA_VENTAS
void ServidorReportes::EjecutaRepTendVta(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString Instruccion, instrucciones[50];
	AnsiString cliente, criterio, listaOrigenVenta;
	int i;

	AnsiString fechaIni, fechaFin, fechaIniHoy, sucursal, OrderByBusquedaInf;
	AnsiString mSucursalconsulta = " ", mSucursalconsultaVta = " ",
		condicionSucursalExistencias = " ", camposminmax = " ", condicion_cliente=" ",
		condicion_origen_venta = " ";

	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaIniHoy = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	OrderByBusquedaInf = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	criterio = mFg.ExtraeStringDeBuffer(&parametros);
    listaOrigenVenta = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	if (sucursal != " ") {
		mSucursalconsulta.sprintf(" AND LEFT(referencia,2)='%s' ", sucursal);
		mSucursalconsultaVta.sprintf(" AND LEFT(v.referencia,2)='%s' ",
			sucursal);
		condicionSucursalExistencias.sprintf(" and almacen in(select alm.almacen from almacenes as alm \
			inner join secciones as sec on sec.seccion=alm.seccion where sec.sucursal='%s' ) "
			, sucursal);
	}else{
		mSucursalconsulta.sprintf(" AND LEFT(referencia,2) IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
		mSucursalconsultaVta.sprintf(" AND LEFT(v.referencia,2) IN ( %s ) ",
			FormServidor->ObtieneSucursalesEmpAct());
		condicionSucursalExistencias.sprintf(" and almacen in(select alm.almacen from almacenes as alm \
			inner join secciones as sec on sec.seccion=alm.seccion where sec.sucursal IN ( %s ) ) "
			, FormServidor->ObtieneSucursalesEmpAct());
	}

	if (cliente != " ") {
		condicion_cliente.sprintf(" AND v.cliente='%s' ", cliente);
	}

	if (criterio=="subtotal") {
		mSucursalconsulta.sprintf(" AND LEFT(v.referencia,2)='%s' ", sucursal);
	}

    if (listaOrigenVenta != " ") {
		condicion_origen_venta.sprintf(" AND v.tipoorigen IN (%s) ", listaOrigenVenta);
	}

    camposminmax.sprintf(",TRUNCATE((@exist / (SELECT maxfactor FROM presentacionesminmax WHERE producto=a.producto AND present=a.present )),0) AS existenciamax \
			,TRUNCATE((MOD(@exist, (SELECT maxfactor FROM presentacionesminmax WHERE producto=a.producto AND present=a.present ))),0) AS existenciamin \
			,(SELECT concat(maxmult,'X',(SELECT maxfactor FROM presentacionesminmax WHERE producto=a.producto AND present=a.present )) FROM presentacionesminmax WHERE producto=a.producto AND present=a.present ) AS multmax \
			,(SELECT concat(minmult,'X',(SELECT MIN(factor) FROM articulos ax WHERE ax.producto=a.producto AND ax.present=a.present )) FROM presentacionesminmax WHERE producto=a.producto AND present=a.present ) AS multmin "
	);

	if (criterio=="numeroventas") {

		try {
			Instruccion.sprintf("CREATE TEMPORARY TABLE totvtasrangoaux AS( SELECT v.referencia, v.fechavta, COUNT(*) AS totventas \
					FROM ventas v \
					WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 %s %s) ",
				fechaIni, fechaFin, mSucursalconsulta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE totvtashoyaux AS( SELECT v.referencia, v.fechavta, COUNT(*) AS totventas  \
						FROM ventas v \
						WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 %s %s) ",
				fechaIniHoy, fechaFin, mSucursalconsulta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE vdiaaux AS ( \
					SELECT a.producto, a.present, COUNT(*) AS numventas, totvtashoyaux.totventas AS tothoy  \
					FROM ventas v \
					INNER JOIN totvtashoyaux  \
					INNER JOIN dventas dv ON v.referencia=dv.referencia  \
					INNER JOIN articulos a ON dv.articulo=a.articulo \
					WHERE v.fechavta BETWEEN '%s' AND '%s'  AND v.cancelado=0 %s \
					GROUP BY a.producto, a.present ) ", fechaIniHoy, fechaFin,
				mSucursalconsultaVta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			instrucciones[num_instrucciones++] =
				"CREATE INDEX IF NOT EXISTS vdia_pk ON vdiaaux (producto, present)";

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql = mFg.AgregaStringABuffer
				(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				Instruccion.sprintf("SELECT p.nombre, a.producto, a.present, \
					COUNT(*) AS numventas, totvtasrangoaux.totventas, (COUNT(*)/totvtasrangoaux.totventas)*100 AS porcglobal, \
					IFNULL(vdiaaux.numventas,0) AS numventashoyaux, COUNT(*)*.2 AS numventasesperadas, \
					IFNULL(vdiaaux.tothoy,0) AS tothoy, IFNULL((vdiaaux.numventas/vdiaaux.tothoy)*100,0) AS porchoy, \
					(((COUNT(*)/totvtasrangoaux.totventas)*100)-IFNULL((vdiaaux.numventas/vdiaaux.tothoy)*100,0))*-1 AS pdiferencia, \
					((((COUNT(*)/totvtasrangoaux.totventas))-IFNULL((vdiaaux.numventas/vdiaaux.tothoy),0))/(COUNT(*)/totvtasrangoaux.totventas))*-100 AS pdiferenciaponderada   \
					,a.articulo,\
					@exist:=(select sum(cantidad) as cantidad from existenciasactuales where producto=a.producto and present=a.present %s ) as existencias \
					%s \
				FROM ventas v \
				INNER JOIN totvtasrangoaux \
				INNER JOIN dventas dv ON v.referencia=dv.referencia  \
				INNER JOIN articulos a ON dv.articulo=a.articulo \
				INNER JOIN productos p ON a.producto=p.producto  \
				LEFT JOIN vdiaaux ON a.producto=vdiaaux.producto AND a.present=vdiaaux.present  \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 %s  \
				%s %s \
				GROUP BY a.producto, a.present \
				HAVING numventas>0 \
				%s ", condicionSucursalExistencias, camposminmax, fechaIni,
					fechaFin, mSucursalconsultaVta, condicion_cliente,
					condicion_origen_venta, OrderByBusquedaInf);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), Respuesta->TamBufferResultado);
			}
		}
		__finally {
			delete buffer_sql;
		}
	} else {

		try {
			Instruccion.sprintf("CREATE TEMPORARY TABLE totalmontorangoaux AS( SELECT v.referencia, v.fechavta, \
				SUM(pv.subtotal) AS valortotalventas \
				FROM ventas v \
				INNER JOIN precalculoventas pv ON v.referencia = pv.referencia \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND cancelado=0 %s %s) ",
				fechaIni, fechaFin, mSucursalconsulta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE totalmontohoyaux AS( SELECT v.referencia, v.fechavta, \
				SUM(pv.subtotal) AS valortotalventas \
				FROM ventas v \
				INNER JOIN precalculoventas pv ON v.referencia = pv.referencia \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND cancelado=0 %s %s)",
				fechaIniHoy, fechaFin, mSucursalconsulta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			Instruccion.sprintf("CREATE TEMPORARY TABLE mdiaaux AS ( \
					SELECT a.producto, a.present, COUNT(*) AS numventas, \
					SUM(dv.cantidad * dv.precio) AS montosub, \
					totalmontohoyaux.valortotalventas AS mtothoy \
					FROM ventas v \
					INNER JOIN totalmontohoyaux \
					INNER JOIN dventas dv ON v.referencia=dv.referencia \
					INNER JOIN articulos a ON dv.articulo=a.articulo \
					WHERE v.fechavta BETWEEN '%s' AND '%s'  AND v.cancelado=0 %s %s \
					GROUP BY a.producto, a.present ) ", fechaIniHoy, fechaFin,
				mSucursalconsultaVta, condicion_origen_venta);
			instrucciones[num_instrucciones++] = Instruccion;

			instrucciones[num_instrucciones++] = "CREATE INDEX IF NOT EXISTS mdia_pk ON mdiaaux (producto, present)";

			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql = mFg.AgregaStringABuffer
				(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP);
			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {
				Instruccion.sprintf("SELECT p.nombre, a.producto, a.present, \
					SUM(dv.cantidad * dv.precio) AS montosubtotal, \
					totalmontorangoaux.valortotalventas, \
					(SUM(dv.cantidad * dv.precio)/ totalmontorangoaux.valortotalventas)*100 AS porcglobal, \
					IFNULL(mdiaaux.montosub,0) AS numventashoy, \
                    (SUM(dv.cantidad * dv.precio)) *.2 AS montosubtotalesperado, \
					IFNULL(mdiaaux.mtothoy,0) AS numventashoy, \
					IFNULL((mdiaaux.montosub/mdiaaux.mtothoy)*100,0) AS montohoy, \
					(((SUM(dv.cantidad * dv.precio)/totalmontorangoaux.valortotalventas)*100) - IFNULL((mdiaaux.montosub/mdiaaux.mtothoy)*100,0))*-1 AS pdiferencia, \
					((((SUM(dv.cantidad * dv.precio)/totalmontorangoaux.valortotalventas)) - IFNULL((mdiaaux.montosub/mdiaaux.mtothoy),0))/(SUM(dv.cantidad * dv.precio)/totalmontorangoaux.valortotalventas))*-100 AS pdiferenciaponderada \
					, a.articulo, @exist:=(select sum(cantidad) as cantidad from existenciasactuales where producto=a.producto and present=a.present %s ) as existencias \
					%s \
				FROM ventas v \
				INNER JOIN totalmontorangoaux \
				INNER JOIN dventas dv ON v.referencia=dv.referencia  \
				INNER JOIN articulos a ON dv.articulo=a.articulo \
				INNER JOIN productos p ON a.producto=p.producto  \
				LEFT JOIN mdiaaux ON a.producto=mdiaaux.producto AND a.present=mdiaaux.present  \
				WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.cancelado=0 %s  \
				%s %s \
				GROUP BY a.producto, a.present \
				%s ", condicionSucursalExistencias, camposminmax, fechaIni,
					fechaFin, mSucursalconsultaVta, condicion_cliente,
					condicion_origen_venta, OrderByBusquedaInf);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), Respuesta->TamBufferResultado);
			}
		}
		__finally {
			delete buffer_sql;
		}
    }
}

// ---------------------------------------------------------------------------
// ID_EJE_REPTRANSACCIONES_BILLETO
void ServidorReportes::EjecutaRepTransaccionesBilleto
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString fecha_ini, fecha_fin, sucursal, terminal, usuario, transaccion;
	AnsiString condicion_sucursal = " ", condicion_terminal = " ",
		condicion_usuario = " ", condicion_transaccion = " ";
	AnsiString condicion_terminal2 = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	transaccion = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != "") {
		condicion_sucursal.sprintf(" AND s.sucursal = '%s' ", sucursal);
	}else{
        condicion_sucursal.sprintf(" AND s.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
	}

	if (terminal != "") {
		condicion_terminal.sprintf(" AND billetrans.terminal = '%s' ",
		terminal);
		condicion_terminal2.sprintf(" AND v.terminal = '%s' ", terminal);
	}

	if (usuario != "") {
		condicion_usuario.sprintf(" AND billetrans.usuario = '%s' ", usuario);
	}

	if (transaccion != "") {
		condicion_transaccion.sprintf(" AND t.tipo = '%s' ", transaccion);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("SELECT                                          \
	t.keydeposito,                                                       \
	t.keyretiro,                                                         \
	t.keypago,                                                           \
	t.venta,                                                             \
	t.terminal,                                                          \
	t.fechaalta,                                                         \
	t.horaalta,                                                          \
	t.cantDepos,                                                         \
	t.cantPagada,                                                        \
	t.cantReembolso,                                                     \
	t.cantRetir,                                                         \
	t.cancelado,                                                         \
	t.fechacancel,                                                       \
	t.horacancel,                                                        \
	t.usuario                                                            \
	FROM (                                                               \
			(                                                            \
				SELECT                                                   \
				billetrans.keydeposito,                                  \
				'' AS keyretiro,                                         \
				'' AS keypago,                                           \
				'' AS venta,                                             \
				billetrans.terminal,                                     \
				billetrans.fechaalta,                                    \
				billetrans.horaalta,                                     \
				billebit.monto AS cantDepos,                             \
				0 AS cantPagada,                                         \
				0 AS cantReembolso,                                      \
				0 AS cantRetir,                                          \
				'' AS cancelado,                                         \
				'' AS fechacancel,                                       \
				'' AS horacancel,                                        \
				CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario, \
				'D' AS tipo                                              \
				FROM billetodepositos billetrans                         \
				INNER JOIN bitacoradepositosbilleto billebit ON          \
				billebit.keydeposito = billetrans.keydeposito AND        \
				billebit.estatus = 'C'                                   \
				INNER JOIN terminales t ON                               \
				t.terminal = billetrans.terminal                         \
				INNER JOIN secciones s ON s.seccion = t.seccion          \
				INNER JOIN empleados e ON                                \
				e.empleado = billetrans.usuario                          \
				WHERE billetrans.fechaalta BETWEEN '%s' AND '%s'         \
				%s %s %s                                   			   	 \
				GROUP BY billetrans.keydeposito                          \
				ORDER BY billetrans.fechaalta DESC,                      \
				billetrans.horaalta DESC                                 \
			)                                                            \
			UNION ALL                                                    \
			(                                                            \
				SELECT                                                   \
				'' AS keydeposito,                                       \
				'' AS keyretiro,                                         \
				billetrans.transaccion AS keypago,                       \
				billetrans.venta,                                        \
				'' AS terminal,                                          \
				billetrans.fechaalta,                                    \
				billetrans.horaalta,                                     \
				0 AS cantDepos,                                          \
				bitbille.total_cobrado AS cantPagada,                    \
				IF(bitbille2.total_reembolsado                           \
				IS NULL,0,bitbille2.total_reembolsado) AS cantReembolso, \
				0 AS cantRetir,                                 		 \
				IF(billetrans.cancelado='1','SI','NO') AS cancelado,     \
				billetrans.fechacancel,                                  \
				billetrans.horacancel,                                   \
				CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario, \
				'P' AS tipo                                              \
				FROM billetopagos billetrans                             \
				LEFT JOIN bitacoratransaccionesbilleto bitbille ON       \
				bitbille.merchant_transaction_id = billetrans.transaccion\
				LEFT JOIN (                                              \
				SELECT                                                   \
				bitra.total_reembolsado,                                 \
				bitra.merchant_transaction_id                            \
				FROM billetopagos billetrans                             \
				INNER JOIN bitacoratransaccionesbilleto bitra ON         \
				bitra.merchant_transaction_id = billetrans.transaccion   \
				WHERE bitra.estatus = 'R'                                \
				GROUP BY billetrans.transaccion                          \
				) bitbille2 ON                                           \
				bitbille2.merchant_transaction_id = billetrans.transaccion\
				INNER JOIN ventas v ON v.referencia = billetrans.venta   \
				INNER JOIN terminales t ON t.terminal = v.terminal       \
				INNER JOIN secciones s ON s.seccion = t.seccion          \
				INNER JOIN empleados e ON e.empleado = billetrans.usuario\
				WHERE billetrans.fechaalta BETWEEN '%s' AND '%s'       	\
				OR billetrans.fechacancel BETWEEN '%s' AND '%s'         \
				%s %s %s                                   			   	\
				GROUP BY billetrans.transaccion                         \
				ORDER BY billetrans.fechaalta DESC,                     \
				billetrans.horaalta DESC                                \
			)                                                           \
			UNION ALL                                                   \
			(                                                           \
				SELECT                                                  \
				'' AS keydeposito,                                      \
				billetrans.keyretiro,                                   \
				'' AS keypago,                                          \
				'' AS venta,                                            \
				billetrans.terminal,                                    \
				billetrans.fechaalta,                                   \
				billetrans.horaalta,                                    \
				0 AS cantDepos,                                         \
				0 AS cantPagada,                                        \
				0 AS cantReembolso,                                     \
				IF(cantajustable=1, billebit.montomodi,                 \
				billebit.monto ) AS cantRetir,                          \
				'' AS cancelado,                                        \
				'' AS fechacancel,                                      \
				'' AS horacancel,                                       \
				CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario,\
				'R' AS tipo                                             \
				FROM billetoretiros billetrans                          \
				INNER JOIN bitacoraretirosbilleto billebit ON           \
				billebit.keyretiro = billetrans.keyretiro AND           \
				billebit.estatus = 'C'                                  \
				INNER JOIN terminales t ON                              \
				t.terminal = billetrans.terminal                        \
				INNER JOIN secciones s ON s.seccion = t.seccion         \
				INNER JOIN empleados e ON                               \
				e.empleado = billetrans.usuario                         \
				WHERE billetrans.fechaalta BETWEEN '%s' AND '%s'        \
				%s %s %s                                   			    \
				GROUP BY billetrans.keyretiro                           \
				ORDER BY billetrans.fechaalta DESC,                     \
				billetrans.horaalta DESC                                \
			)                                                           \
	) AS t                                                              \
	WHERE 1 %s                                                          \
	ORDER BY t.fechaalta DESC, t.horaalta DESC ", fecha_ini, fecha_fin,
		condicion_sucursal, condicion_usuario, condicion_terminal,

		fecha_ini, fecha_fin, fecha_ini, fecha_fin, condicion_sucursal,
		condicion_usuario, condicion_terminal2,

		fecha_ini, fecha_fin, condicion_sucursal, condicion_usuario,
		condicion_terminal,

		condicion_transaccion);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPBITACORA_TRANSACCIONES_BILLETO
void ServidorReportes::EjecutaRepBitacoraTransaccionesBilleto
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString fecha_ini, fecha_fin, sucursal, terminal, usuario, transaccion;
	AnsiString condicion_sucursal = " ", condicion_terminal = " ",
		condicion_usuario = " ";
	AnsiString condicion_terminal2 = " ", condicion_usuario2 = " ";
	AnsiString condicion_terminal3 = " ", condicion_usuario3 = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	transaccion = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != "") {
		condicion_sucursal.sprintf(" AND s.sucursal = '%s' ", sucursal);
	}else{
		condicion_sucursal.sprintf(" AND s.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
	}

	if (terminal != "") {
		condicion_terminal.sprintf(" AND bitbille.terminal = '%s' ", terminal);
		condicion_terminal2.sprintf(" AND v.terminal = '%s' ", terminal);
	}

	if (usuario != "") {
		condicion_usuario.sprintf(" AND bitbille.usuario = '%s' ", usuario);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	// DEPOSITOS
	if (transaccion == "0") {
		Instruccion.sprintf("SELECT                                 \
		bitbille.keydeposito,                                       \
		bitbille.refdeposito,                                       \
		bitbille.curp,                                              \
		bitbille.fecha,                                             \
		bitbille.hora,                                              \
		bitbille.nombrebenefi,                                      \
		bitbille.nacionalidad,                                      \
		IF (bitbille.calle!='', CONCAT(bitbille.calle, ' No. ',     \
		bitbille.numeroext, ' Interior: ', bitbille.numeroint,      \
		' Colonia ', bitbille.colonia), '')  AS domicilio,          \
		bitbille.telefono,                                          \
		bitbille.monto,                                             \
		bitbille.comision,                                          \
		IF(bitbille.direccreq=0, 'NO', 'SI') AS direccreq,          \
		IF(bitbille.curpreq=0, 'NO', 'SI') AS curpreq,              \
		CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario,    \
		eab.descripcion AS estatus,                                 \
		bitbille.mensajeservidor                                    \
		FROM bitacoradepositosbilleto bitbille                      \
		LEFT JOIN estatusapibilleto eab ON                          \
		eab.tipoestatus = bitbille.estatus                          \
		LEFT JOIN terminales t ON t.terminal = bitbille.terminal    \
		LEFT JOIN secciones s ON s.seccion = t.seccion              \
		LEFT JOIN empleados e ON e.empleado = bitbille.usuario      \
		WHERE bitbille.fecha BETWEEN '%s' AND '%s'                  \
		%s %s %s                                    		   		\
		ORDER BY bitbille.fecha DESC,                               \
		bitbille.hora DESC ", fecha_ini, fecha_fin, condicion_sucursal,
			condicion_usuario, condicion_terminal);
	}
	else if (transaccion == "1") { // PAGOS
		Instruccion.sprintf("SELECT                                             \
		bitbille.merchant_transaction_id,                                       \
		billetrans.venta,                     								    \
		bitbille.total_cobrado,               									\
		bitbille.total_reembolsado,                                             \
		bitbille.fecha,                                                         \
		bitbille.hora,                                          				\
		IF(billetrans.cancelado=0,'NO','SI') AS cancelado,                      \
		IF(billetrans.fechacancel='0000-00-00','0000-00-00',billetrans.fechacancel) AS fechacancel, \
		billetrans.horacancel,                                                  \
		bitbille.cliente,                                                       \
		bitbille.whatsappcliente,                                               \
		bitbille.codigocliente,     											\
		CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario,                \
		eab.descripcion AS estatus,                                             \
		bitbille.mensajeservidor					                            \
		FROM bitacoratransaccionesbilleto bitbille                              \
		LEFT JOIN billetopagos billetrans ON                                    \
		billetrans.transaccion = bitbille.merchant_transaction_id               \
		INNER JOIN estatusapibilleto eab ON eab.tipoestatus = bitbille.estatus  \
		INNER JOIN ventas v ON v.referencia = billetrans.venta                  \
		INNER JOIN terminales t ON t.terminal = v.terminal                      \
		INNER JOIN secciones s ON s.seccion = t.seccion                         \
		INNER JOIN empleados e ON e.empleado = bitbille.usuario                 \
		WHERE bitbille.fecha BETWEEN '%s' AND '%s'       						\
		%s %s %s                                    		   					\
		ORDER BY bitbille.fecha DESC, bitbille.hora DESC ", fecha_ini,
			fecha_fin, condicion_sucursal, condicion_usuario,
			condicion_terminal2);
	}
	else if (transaccion == "2") { // RETIROS
		Instruccion.sprintf("SELECT                                             \
		bitbille.keyretiro,                                                     \
		bitbille.refretiro,     												\
		bitbille.curp,                                                          \
		bitbille.fecha,                                                         \
		bitbille.hora,                                                          \
		bitbille.nombrebenefi,    												\
		bitbille.nacionalidad,                                                  \
		IF (bitbille.calle!='', CONCAT(bitbille.calle, ' No. ',                 \
		bitbille.numeroext, ' Interior: ', bitbille.numeroint,                  \
		' Colonia ', bitbille.colonia), '')  AS domicilio,                      \
		bitbille.telefono,                                                      \
		bitbille.monto,                                                         \
		bitbille.montomodi,                  									\
		bitbille.comision,                                                      \
		IF(bitbille.direccreq=0, 'NO', 'SI') AS direccreq,                      \
		IF(bitbille.curpreq=0, 'NO', 'SI') AS curpreq,                          \
		IF(bitbille.telreq=0, 'NO', 'SI') AS telreq,                            \
		IF(bitbille.cantajustable=0, 'NO', 'SI') AS cantajustable,              \
		CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario,                \
		eab.descripcion AS estatus,                                             \
		bitbille.mensajeservidor                    							\
		FROM bitacoraretirosbilleto bitbille                                    \
		INNER JOIN estatusapibilleto eab ON eab.tipoestatus = bitbille.estatus  \
		INNER JOIN terminales t ON t.terminal = bitbille.terminal               \
		INNER JOIN secciones s ON s.seccion = t.seccion                         \
		INNER JOIN empleados e ON e.empleado = bitbille.usuario                 \
		WHERE bitbille.fecha BETWEEN '%s' AND '%s'              				\
		%s %s %s                                    		   					\
		ORDER BY bitbille.fecha DESC,                                           \
		bitbille.hora DESC ", fecha_ini, fecha_fin, condicion_sucursal,
			condicion_usuario, condicion_terminal);
	}

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPART_ELIMINADOS_EMBARQUES
void ServidorReportes::EjecutaRepArtEliminadosEmbarques
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString fecha_ini, fecha_fin, sucursal, embarque, pedido;
	AnsiString producto, cliente, usuario, modo_agrupar;
	AnsiString condicion_sucursal = " ", condicion_embarque = " ",
		condicion_pedido = " ";
	AnsiString condicion_producto = " ", condicion_cliente = " ";
	AnsiString condicion_usuario = " ", condicion_modo_agrupar = " ";

	AnsiString agrupar = " ";

	AnsiString campos =
		" dps.cantidad, \ dps.precio*dps.cantidad AS subtotal, \ dps.precioimp*dps.cantidad AS total, \ ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	embarque = mFg.ExtraeStringDeBuffer(&parametros);
	pedido = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	modo_agrupar = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND sec.sucursal = '%s' ", sucursal);
	}

	if (embarque != " ") {
		condicion_embarque.sprintf(" AND dps.embarque = '%s' ", embarque);
	}

	if (pedido != " ") {
		condicion_pedido.sprintf(" AND dps.referencia = '%s' ", pedido);
	}

	if (producto != " ") {
		condicion_producto.sprintf(" AND prod.producto = '%s' ", producto);
	}

	if (cliente != " ") {
		condicion_cliente.sprintf(" AND pv.cliente = '%s' ", cliente);
	}

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND dps.usuario = '%s' ", usuario);
	}

	if (modo_agrupar == "1") {
		campos =
			" SUM(dps.cantidad) AS cantidad, \ SUM(dps.precio*dps.cantidad) AS subtotal, \ SUM(dps.precioimp*dps.cantidad) AS total, \ ";
		agrupar.sprintf(" GROUP BY dps.articulo ");
	}
	else if (modo_agrupar == "2") {
		campos =
			" SUM(dps.cantidad) AS cantidad, \ SUM(dps.precio*dps.cantidad) AS subtotal, \ SUM(dps.precioimp*dps.cantidad) AS total, \ ";
		agrupar.sprintf(" GROUP BY pv.cliente");
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("SELECT \
	dps.embarque, \
	dps.referencia, \
	pv.cliente, \
	cli.rsocial, \
	dps.articulo, \
	prod.nombre, \
	a.producto, \
	a.present, \
	%s \
	CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat) AS usuario, \
	dps.fechamodi, \
	dps.horamodi \
	FROM dpedidosventasinexistencia dps \
	INNER JOIN articulos a ON a.articulo = dps.articulo \
	INNER JOIN empleados emp ON emp.empleado = dps.usuario \
	INNER JOIN pedidosventa pv ON pv.referencia = dps.referencia \
	inner join clientes cli on cli.cliente = pv.cliente \
	INNER JOIN terminales t ON t.terminal = pv.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	INNER JOIN productos prod ON prod.producto = a.producto \
	WHERE dps.fechamodi BETWEEN '%s' AND '%s' \
	%s %s %s %s %s %s \
	%s \
	ORDER BY dps.fechamodi ASC, dps.horamodi ASC", campos, fecha_ini, fecha_fin,
		condicion_sucursal, condicion_embarque, condicion_pedido,
		condicion_producto, condicion_cliente, condicion_usuario, agrupar);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCORTESCAJA
void ServidorReportes::EjecutaRepCortesCaja(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64 * 20];
	char *aux_buffer_sql = buffer_sql;
	BufferRespuestas* resp_parametro = NULL;
	int i;
	int cortexsuc = 0;

	int num_instrucciones = 0;
	AnsiString instruccion, Instruccion, consulta, instrucciones[1000];

	AnsiString fecha_ini, fecha_fin, cancelNormales, consulCancel, terminoPago;
	AnsiString terminoPagoAux, formaPago, tipoVenta, especialNormal,
		tipoFactura, mostrarVM;
	AnsiString sucursal, terminal, cortes, cliente, parteRel, origenVenta,
		horaChecked, horaIni, horaFin, usuario, omiteDocFacWeb;

	AnsiString condicion_cancelNormales = " ", condicion_contabilizadas = " ",
		condicion_fechas_canceladas = " ", condicion_fechas_pagos = " ";
	AnsiString condicion_terminoPago = " ", condicion_terminoPagoAux = " ",
		condicion_formaPago = " ";
	AnsiString condicion_tipoVenta = " ", condicion_especialNormal = " ",
		condicion_sucursal = " ";
	AnsiString condicion_terminal = " ", condicion_cortes = " ",
		condicion_clientes = " ", condicion_parteRel = " ";
	AnsiString condicion_origenVenta = " ", condicion_hora = " ",
		condicion_cortes_notascredito = " ";
	AnsiString condicion_notas_cred = " ", condicion_cortes_mov_caja = " ",
		condicion_hora_nota_cred = " ";

	AnsiString condicion_terminal_retiro = " ", condicion_hora_retiro = " ",
		condicion_formasDePago = " ", condicion_hora_modi = " ";

	AnsiString campo_valor = "dv.precio*dv.cantidad", campos_base,
		campos_base_cancel, campo_nomcliente;
	AnsiString impuesto = "", cad_suma_impuesto = "", cad_val_impuesto = "",
		campos_suma_impuestos = "", campos_val_impuestos = "";

	AnsiString condicion_cortes_cancel = " ";

	AnsiString cajero, resumido;
	AnsiString condicion_cajero = " ", condicion_cajero_mov_caja = " ",
		condicion_terminal_cancel = " ";
	AnsiString sumatoria_mov_cajas = " ", campo_movs_caja;

	AnsiString seguimiento, auth;
	AnsiString condicion_seguimiento = " ", condicion_auth = " ";
	AnsiString inner_join_trndetvta = " ", condicion_fecha_notas = " ";

    AnsiString join_cfdiweb_venta=" ", condicion_cfdiweb_venta=" ", join_cfdiweb_nota=" ", condicion_cfdiweb_nota=" ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	cancelNormales = mFg.ExtraeStringDeBuffer(&parametros);
	consulCancel = mFg.ExtraeStringDeBuffer(&parametros);
	terminoPago = mFg.ExtraeStringDeBuffer(&parametros);
	terminoPagoAux = mFg.ExtraeStringDeBuffer(&parametros);
	formaPago = mFg.ExtraeStringDeBuffer(&parametros);
	tipoVenta = mFg.ExtraeStringDeBuffer(&parametros);
	especialNormal = mFg.ExtraeStringDeBuffer(&parametros);
	tipoFactura = mFg.ExtraeStringDeBuffer(&parametros);
	mostrarVM = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	cortes = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	parteRel = mFg.ExtraeStringDeBuffer(&parametros);
	origenVenta = mFg.ExtraeStringDeBuffer(&parametros);
	horaChecked = mFg.ExtraeStringDeBuffer(&parametros);
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	cajero = mFg.ExtraeStringDeBuffer(&parametros);
	resumido = mFg.ExtraeStringDeBuffer(&parametros);
	seguimiento = mFg.ExtraeStringDeBuffer(&parametros);
	auth = mFg.ExtraeStringDeBuffer(&parametros);
	omiteDocFacWeb = mFg.ExtraeStringDeBuffer(&parametros);

	try {

		instruccion.sprintf
			("SELECT valor FROM parametrosemp WHERE parametro='CORTEPORSUC' AND sucursal = '%s' ", FormServidor->ObtieneClaveSucursal());
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_parametro);
		if (resp_parametro->ObtieneNumRegistros() > 0) {
			cortexsuc = resp_parametro->ObtieneDato("valor").ToInt();
		}

		if (cancelNormales != " ") {
			condicion_cancelNormales.sprintf(" AND v.cancelado=%s ",
				cancelNormales);
			if (cancelNormales == "1") {
				if (consulCancel == "0") {
					condicion_fechas_canceladas.sprintf
						(" AND v.fechamodi>='%s' AND v.fechamodi<='%s' ",
						fecha_ini, fecha_fin);
					condicion_fecha_notas.sprintf
						("AND n.fechamodi BETWEEN '%s' AND '%s'", fecha_ini,
						fecha_fin);
					condicion_fechas_pagos.sprintf
						("AND txc.fechamodi BETWEEN '%s' AND '%s'", fecha_ini,
						fecha_fin);
				}
				else {
					condicion_fechas_canceladas.sprintf
						(" AND v.fechavta>='%s' AND v.fechavta<='%s' ",
						fecha_ini, fecha_fin);
					condicion_fecha_notas.sprintf
						("AND n.fechanot BETWEEN '%s' AND '%s'", fecha_ini,
						fecha_fin);
					condicion_fechas_pagos.sprintf
						("AND txc.fechaapl BETWEEN '%s' AND '%s'", fecha_ini,
						fecha_fin);
				}
			}
			else {
				condicion_fechas_canceladas.sprintf
					(" AND v.fechavta>='%s' AND v.fechavta<='%s' ", fecha_ini,
					fecha_fin);
				condicion_fecha_notas.sprintf
					("AND n.fechanot BETWEEN '%s' AND '%s'", fecha_ini,
					fecha_fin);
				condicion_fechas_pagos.sprintf
					("AND txc.fechamodi BETWEEN '%s' AND '%s'", fecha_ini,
					fecha_fin);
			}
		}
		else {
			condicion_fechas_canceladas.sprintf
				(" AND v.fechavta>='%s' AND v.fechavta<='%s' ", fecha_ini,
				fecha_fin);
			condicion_fecha_notas.sprintf
				("AND n.fechanot BETWEEN '%s' AND '%s'", fecha_ini, fecha_fin);
			condicion_fechas_pagos.sprintf
				("AND txc.fechamodi BETWEEN '%s' AND '%s'", fecha_ini,
				fecha_fin);
		}

		if (terminoPago != " ") {
			condicion_terminoPago.sprintf(" AND v.acredito = %s ", terminoPago);
		}

		if (terminoPagoAux != " ") {
			condicion_terminoPagoAux.sprintf(" AND fp.termino = '%s' ",
				terminoPagoAux);
		}

		if (formaPago != " ") {
			condicion_formaPago.sprintf(" AND df.formapag = '%s' ", formaPago);
		}

		if (tipoVenta != " ") {
			condicion_tipoVenta.sprintf(" AND v.ticket=%s ", tipoVenta);
		}

		if (especialNormal == " ") {
			if (tipoFactura != " ") {
				condicion_especialNormal.sprintf(" AND v.tipofac='%s' ",
					tipoFactura);
			}
		}
		if (especialNormal == "1") {
			condicion_especialNormal.sprintf(" AND v.tipofac='ESPECIAL' ");
		}
		if (especialNormal == "0") {
			if (tipoFactura == " ")
				condicion_especialNormal.sprintf(" AND v.tipofac<>'ESPECIAL' ");
			else
				condicion_especialNormal.sprintf(" AND v.tipofac='%s' ",
				tipoFactura);
		}

		if (sucursal != " ") {
			condicion_sucursal.sprintf(" AND s.sucursal = '%s' ", sucursal);
		}else{
			condicion_sucursal.sprintf(" AND s.sucursal IN ( %s )  ", FormServidor->ObtieneSucursalesEmpAct());
		}

		if (terminal != " ") {
			condicion_terminal.sprintf(" AND v.terminal = '%s' ", terminal);
			condicion_terminal_cancel.sprintf(" AND v.terminalcancel = '%s' ",
				terminal);
			condicion_notas_cred.sprintf(" AND n.terminal = '%s' ", terminal);
			condicion_terminal_retiro.sprintf(" AND m.terminal = '%s' ",
				terminal);
		}

		if (cortes != " ") {
			condicion_cortes.sprintf(" AND v.corte = '%s' ", cortes);
			condicion_cortes_notascredito.sprintf(" AND n.corte = '%s' ",
				cortes);
			condicion_cortes_mov_caja.sprintf(" AND m.corte = '%s' ", cortes);
			condicion_cortes_cancel.sprintf(" AND v.cortecancel = '%s' ",
				cortes);
		}

		if (cliente != " ") {
			condicion_clientes.sprintf(" AND cli.cliente='%s' ", cliente);
		}

		if (parteRel != " ") {
			condicion_parteRel.sprintf(" AND cli.esparterelac='%s' ", parteRel);
		}

		if (origenVenta != " ") {
			condicion_origenVenta.sprintf(" AND v.tipoorigen IN (%s) ",
				origenVenta);
		}

		if (horaChecked != "0") {
			condicion_hora.sprintf(" AND v.horavta>='%s' AND v.horavta<='%s' ",
				horaIni, horaFin);
			condicion_hora_modi.sprintf
				(" AND v.horamodi>='%s' AND v.horamodi<='%s' ", horaIni,
				horaFin);
			condicion_hora_nota_cred.sprintf
				(" AND n.horamodi>='%s' AND n.horamodi<='%s' ", horaIni,
				horaFin);
			condicion_hora_retiro.sprintf
				(" AND m.horaretiro>='%s' AND m.horaretiro<='%s' ", horaIni,
				horaFin);
		}

		if (mostrarVM == "0") {
			campo_nomcliente =
				"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
		}
		else {
			campo_nomcliente = "'VENTA DE MOSTRADOR'";
		}

		if (cajero != " ") {
			condicion_cajero.sprintf(" AND v.usualta = '%s' ", cajero);
			condicion_cajero_mov_caja.sprintf(" AND m.usuario = '%s' ", cajero);
		}

		if (resumido == "0") {
			sumatoria_mov_cajas = "(m.cantretirado)";
			campo_movs_caja =
				"IF(m.concepto='D', CONCAT('D', '-', cm.descripcion), CONCAT('R', '-', cm.descripcion))";
		}
		else if (resumido == "1") {
			sumatoria_mov_cajas = "SUM(m.cantretirado)";
			campo_movs_caja = "'DEPOSITOS Y RETIROS'";
		}

		if (seguimiento != " ") {
			inner_join_trndetvta =
				" LEFT JOIN dettrnxventa dtrnv ON dtrnv.trn_id = df.trn_id ";
			condicion_seguimiento.sprintf(" AND dtrnv.trn_id = '%s' ",
				seguimiento);
		}

		if (auth != " ") {
			inner_join_trndetvta =
				" LEFT JOIN dettrnxventa dtrnv ON dtrnv.trn_id = df.trn_id ";
			condicion_auth.sprintf(" AND dtrnv.trn_auth_code = '%s' ", auth);
		}

		if(omiteDocFacWeb=="1"){
			join_cfdiweb_venta = " LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia ";
			join_cfdiweb_nota = " LEFT JOIN cfdiweb wn ON wn.refticket=n.venta ";
			condicion_cfdiweb_venta = " AND w.factgenerada IS NULL ";
			condicion_cfdiweb_nota = " AND wn.factgenerada IS NULL ";
		}

		Instruccion =
			"CREATE TEMPORARY TABLE auxnumoperaciones (referencia VARCHAR(11), numoper INT(5), PRIMARY KEY(referencia)) ENGINE = INNODB;";
		instrucciones[num_instrucciones++] = Instruccion;

		Instruccion.sprintf("INSERT INTO auxnumoperaciones	(referencia, numoper) \
		Select df.referencia, COUNT(df.formapag) AS numoper \
		from dventasfpago df INNER JOIN ventas v on v.referencia = df.referencia \
		WHERE v.fechavta>='%s' AND v.fechavta<='%s' AND df.formapag IN ('FTARCR','FTARDE') \
		GROUP BY v.referencia", fecha_ini, fecha_fin);
		instrucciones[num_instrucciones++] = Instruccion;

		Instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = Instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// resp_totalfpago
			Instruccion.sprintf(" SELECT t.descripcion, SUM(t.totact) as total FROM (( \
				SELECT \
						CONCAT(UCASE(LEFT(fp.descripcion, 1)),LCASE(SUBSTRING(fp.descripcion, 2))) AS descripcion, \
						fp.formapag, \
						SUM(df.valor) AS totact, \
						tp.terminoreal \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
					%s \
					WHERE v.cancelado = 0 \
                    AND fp.termino != 'TARCR' \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY df.formapag  \
			) UNION ALL ( \
				SELECT \
						CONCAT(UCASE(LEFT(fp.descripcion, 1)),LCASE(SUBSTRING(fp.descripcion, 2))) AS descripcion, \
						fp.formapag, \
						SUM(df.valor)*-1 AS totact, \
						tp.terminoreal \
					FROM notascredcli n FORCE INDEX(fechanot) \
					INNER JOIN ventas v ON v.referencia = n.venta \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia \
					%s \
					WHERE n.cancelado = 0 \
					AND fp.termino != 'TARCR' \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY df.formapag  \
			) UNION ALL ( \
				SELECT \
						'Cobro Pinpad' AS descripcion, \
						fp.formapag, \
						SUM(df.valor) AS totact, \
						tp.terminoreal \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
					%s \
					WHERE v.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NOT NULL \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY fp.termino  \
			) UNION ALL ( \
				SELECT \
						'Cobro Pinpad' AS descripcion, \
						fp.formapag, \
						SUM(df.valor)*-1 AS totact, \
						tp.terminoreal \
					FROM notascredcli n FORCE INDEX(fechanot) \
					INNER JOIN ventas v ON v.referencia = n.venta \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
					%s \
					WHERE n.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NOT NULL \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY fp.termino  \
			) UNION ALL ( \
				SELECT \
						'Cobro TPV' AS descripcion, \
						fp.formapag, \
						SUM(df.valor) AS totact, \
						tp.terminoreal \
					FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
					%s \
					WHERE v.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NULL \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY fp.termino  \
			) UNION ALL ( \
				SELECT \
						'Cobro TPV' AS descripcion, \
						fp.formapag, \
						SUM(df.valor)*-1 AS totact, \
						tp.terminoreal \
					FROM notascredcli n FORCE INDEX(fechanot) \
					INNER JOIN ventas v ON v.referencia = n.venta \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
					%s \
					WHERE n.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NULL \
					%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
					GROUP BY fp.termino  \
			) UNION ALL ( \
				SELECT \
					'Cobranza Efectivo' AS descripcion, \
					fp.formapag, \
					SUM(txc.valor)*-1 AS totact, \
					1 AS efecrecib \
				FROM transxcob txc \
				INNER JOIN pagoscli p ON p.pago = txc.pago \
				INNER JOIN ventas v ON txc.referencia = v.referencia \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
				%s \
				%s \
				WHERE v.cancelado = 0 \
				AND p.cancelado = 0 \
				AND txc.aplicada = 1 \
				AND txc.cancelada = 0 \
				AND p.formapag = 'E' \
				%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY df.formapag \
			)) t \
			GROUP BY t.descripcion \
				ORDER BY t.formapag ",
				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fechas_canceladas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta,

				condicion_cancelNormales, condicion_fecha_notas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_notas_cred, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora_nota_cred, condicion_terminoPago,
				condicion_terminoPagoAux, condicion_formaPago, condicion_cajero,
				condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fechas_canceladas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fecha_notas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_notas_cred, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fechas_canceladas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fecha_notas,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_notas_cred, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_cancelNormales, condicion_fechas_pagos,
				condicion_tipoVenta, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_terminoPago, condicion_terminoPagoAux,
				condicion_formaPago, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_movcaja
			Instruccion.sprintf("SELECT %s AS concepto, %s AS cantidad \
			FROM movsefectivocaja m \
			INNER JOIN terminales t ON t.terminal = m.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
			WHERE m.fecharetiro BETWEEN '%s' AND '%s' %s %s %s %s %s \
			ORDER BY m.concepto ", campo_movs_caja, sumatoria_mov_cajas,
				fecha_ini, fecha_fin, condicion_terminal_retiro,
				condicion_hora_retiro, condicion_cortes_mov_caja,
				condicion_sucursal, condicion_cajero_mov_caja);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_notascred
			Instruccion.sprintf("SELECT n.referencia, \
			SUM((dn.cantidad*dn.precioimp)*df.porcentaje) AS cantidad, \
			v.referencia, \
			v.fechavta \
			FROM notascredcli n \
			INNER JOIN dnotascredcli dn ON dn.referencia = n.referencia \
			INNER JOIN ventas v ON v.referencia = n.venta \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN formasdepago fp ON df.formapag = fp.formapag \
            %s \
			%s \
			%s \
			WHERE n.fechanot BETWEEN '%s' AND '%s' AND v.cancelado = 0 AND n.cancelado = 0 \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			GROUP BY n.referencia ",
				inner_join_trndetvta, join_cfdiweb_venta, join_cfdiweb_nota,

				fecha_ini, fecha_fin, condicion_tipoVenta,
				condicion_especialNormal, condicion_sucursal,
				condicion_notas_cred, condicion_cortes_notascredito,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora_nota_cred, condicion_terminoPago,
				condicion_terminoPagoAux, condicion_formaPago, condicion_cajero,
				condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta, condicion_cfdiweb_nota);
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_reporte
			Instruccion.sprintf("SELECT \
			v.referencia, \
			v.corte, \
			IFNULL(num.numoper,0) AS numoperaciones, \
			v.fechavta as fecha, \
			v.horavta as hora, \
			cli.cliente, \
			%s as nomcliente, \
			IF(v.cancelado=0,'ACTIVA','CANCELADA') AS estatus, \
			sum((dv.precioimp*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS total, \
			sum((dv.precio*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS subtotal \
			FROM ventas v FORCE INDEX(fechavta) \
			INNER JOIN dventas dv ON dv.referencia = v.referencia \
			INNER JOIN articulos ON articulos.articulo = dv.articulo \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN dventasfpago df ON v.referencia = df.referencia \
			INNER JOIN formasdepago fp ON df.formapag = fp.formapag \
			LEFT JOIN auxnumoperaciones num ON num.referencia = v.referencia \
			%s \
			%s \
			WHERE v.cancelado=0 \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			group by v.referencia \
			order by v.referencia", campo_nomcliente,

				inner_join_trndetvta, join_cfdiweb_venta,

				condicion_fechas_canceladas, condicion_tipoVenta,
				condicion_especialNormal, condicion_sucursal,
				condicion_terminal, condicion_cortes, condicion_clientes,
				condicion_parteRel, condicion_origenVenta, condicion_hora,
				condicion_terminoPago, condicion_terminoPagoAux,
				condicion_cajero, condicion_formaPago, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_reporte_cancel
			Instruccion.sprintf("SELECT v.referencia, \
			v.cortecancel as corte, \
			IFNULL(num.numoper,0) AS numoperaciones, \
			v.fechavta as fecha, \
			v.horavta as hora, \
			cli.cliente, \
			%s as nomcliente, \
			IF(v.cancelado=0,'ACTIVA','CANCELADA') AS estatus, \
			cc.nombre AS canceladopor, \
			sum((dv.precioimp*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS total, \
			sum((dv.precio*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS subtotal \
			FROM ventas v FORCE INDEX(fechamodi) \
			INNER JOIN dventas dv ON dv.referencia = v.referencia \
			INNER JOIN articulos ON articulos.articulo = dv.articulo \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN dventasfpago df ON v.referencia = df.referencia \
			INNER JOIN formasdepago fp ON df.formapag = fp.formapag \
			LEFT JOIN auxnumoperaciones num ON num.referencia = v.referencia \
			LEFT JOIN ventascanceladas vc ON vc.referencia = v.referencia \
			LEFT JOIN catalogocancel cc ON cc.id = vc.idcancel \
			%s \
			%s \
			WHERE v.fechamodi BETWEEN '%s' AND '%s' AND v.cancelado=1 \
			%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
			group by v.referencia \
			order by v.referencia", campo_nomcliente,

				inner_join_trndetvta, join_cfdiweb_venta,

				fecha_ini, fecha_fin, condicion_tipoVenta,
				condicion_especialNormal, condicion_sucursal,
				condicion_terminal_cancel, condicion_cortes_cancel,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora_modi, condicion_terminoPago,
				condicion_terminoPagoAux, condicion_cajero, condicion_formaPago,
				condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_reporte_cancel_dif_corte
			if (terminal != " " || cortes != " ") {
				Instruccion.sprintf("SELECT v.referencia, \
				v.cortecancel as corte, \
				IFNULL(num.numoper,0) AS numoperaciones, \
				v.fechavta as fecha, \
				v.horavta as hora, \
				cli.cliente, \
				%s as nomcliente, \
				IF(v.cancelado=0,'ACTIVA','CANCELADA') AS estatus, \
				cc.nombre AS canceladopor, \
				sum((dv.precioimp*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS total, \
				sum((dv.precio*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje) AS subtotal \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN articulos ON articulos.articulo = dv.articulo \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON v.referencia = df.referencia \
				INNER JOIN formasdepago fp ON df.formapag = fp.formapag \
				LEFT JOIN auxnumoperaciones num ON num.referencia = v.referencia \
				LEFT JOIN ventascanceladas vc ON vc.referencia = v.referencia \
				LEFT JOIN catalogocancel cc ON cc.id = vc.idcancel \
				%s \
				%s \
				WHERE v.fechamodi BETWEEN '%s' AND '%s' AND v.cancelado=1 \
				AND v.cortecancel != v.corte AND v.terminalcancel != v.terminal \
				%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
				group by v.referencia \
				order by v.referencia", campo_nomcliente,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_tipoVenta,
					condicion_especialNormal, condicion_sucursal,
					condicion_terminal, condicion_cortes, condicion_clientes,
					condicion_parteRel, condicion_origenVenta,
					condicion_hora_modi, condicion_terminoPago,
					condicion_terminoPagoAux, condicion_cajero,
					condicion_formaPago, condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), Respuesta->TamBufferResultado);
			}

			// resp_ventasefectivo
			if (cortexsuc == 1) {

				Instruccion.sprintf("SELECT t.tipo, SUM(t.total) as total FROM (( \
				SELECT \
				'TICKET' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 1 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 1 AND v.cancelado = 0 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT \
				'FACTURA' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 2 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 0  AND v.cancelado = 0 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT %s AS tipo, %s AS total, 3 AS orden \
				FROM movsefectivocaja m \
				INNER JOIN terminales t ON t.terminal = m.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
				WHERE m.fecharetiro BETWEEN '%s' AND '%s' %s %s %s %s %s \
				ORDER BY m.concepto \
				) UNION ALL ( \
                SELECT \
					'COBRANZA EFECTIVO' AS tipo, \
					SUM(txc.valor)*-1 AS totact, \
					4 AS orden \
				FROM ventas v FORCE INDEX(fechavta) \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN transxcob txc ON txc.referencia = v.referencia \
				INNER JOIN pagoscli p ON p.pago = txc.pago \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
				%s \
				%s \
				WHERE txc.fechaapl BETWEEN '%s' AND '%s' \
				AND v.cancelado = 0 \
				AND p.cancelado = 0 \
				AND txc.aplicada = 1 \
				AND txc.cancelada = 0 \
				AND p.formapag = 'E' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY df.formapag \
				)) t \
				GROUP BY t.tipo \
				ORDER BY t.orden ASC ",
					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal, condicion_cortes,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal, condicion_cortes,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					campo_movs_caja, sumatoria_mov_cajas, fecha_ini, fecha_fin,
					condicion_terminal_retiro, condicion_hora_retiro,
					condicion_cortes_mov_caja, condicion_sucursal,
					condicion_cajero_mov_caja,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal, condicion_cortes,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), Respuesta->TamBufferResultado);
			}
			else {

				Instruccion.sprintf("SELECT t.tipo, SUM(t.total) as total FROM (( \
				SELECT \
				'TICKET' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 1 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 1 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT \
				'TICKET' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje)*-1 AS total, 1 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 1 AND v.cancelado = 1 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT \
				'FACTURA' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 2 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 0 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT \
				'FACTURA' AS tipo, \
				SUM((dv.precioimp*dv.cantidad)*df.porcentaje)*-1 AS total, 2 AS orden \
				FROM ventas v FORCE INDEX(fechamodi) \
				INNER JOIN dventas dv ON dv.referencia = v.referencia \
				INNER JOIN terminales t ON t.terminal = v.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				INNER JOIN clientes cli ON cli.cliente = v.cliente \
				INNER JOIN dventasfpago df ON df.referencia = v.referencia \
				INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
				%s \
				%s \
				WHERE v.acredito = 0 AND v.ticket = 0 AND v.cancelado = 1 \
				AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCONEF' \
				%s %s %s %s %s %s %s %s %s %s %s %s \
				GROUP BY v.ticket \
				) UNION ALL ( \
				SELECT %s AS tipo, %s AS total, 3 AS orden \
				FROM movsefectivocaja m \
				INNER JOIN terminales t ON t.terminal = m.terminal \
				INNER JOIN secciones s ON s.seccion = t.seccion \
				LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
				WHERE m.fecharetiro BETWEEN '%s' AND '%s' %s %s %s %s %s \
				ORDER BY m.concepto \
				)) t \
				GROUP BY t.tipo \
				ORDER BY t.orden ASC ",
					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal, condicion_cortes,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal_cancel, condicion_cortes_cancel,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal, condicion_cortes,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					inner_join_trndetvta, join_cfdiweb_venta,

					fecha_ini, fecha_fin, condicion_especialNormal,
					condicion_sucursal, condicion_terminal_cancel, condicion_cortes_cancel,
					condicion_clientes, condicion_parteRel,
					condicion_origenVenta, condicion_hora, condicion_cajero,
					condicion_seguimiento, condicion_auth, condicion_cfdiweb_venta,

					campo_movs_caja, sumatoria_mov_cajas, fecha_ini, fecha_fin,
					condicion_terminal_retiro, condicion_hora_retiro,
					condicion_cortes_mov_caja, condicion_sucursal,
					condicion_cajero_mov_caja);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), Respuesta->TamBufferResultado);
			}

			// resp_ventastarjetas
			Instruccion.sprintf("SELECT t.tipo, SUM(t.numoperaciones), t.total FROM (( \
			SELECT \
			'TARJETA CRED.' AS tipo, \
			COUNT(df.formapag) AS numoperaciones, \
			SUM(df.valor) AS total \
			FROM ventas v FORCE INDEX(fechamodi) \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
			%s \
			%s \
			WHERE v.acredito = 0 AND v.cancelado = 0 \
			AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FTARCR' \
			%s %s %s %s %s %s %s %s %s %s %s %s \
			) UNION ALL ( \
			SELECT \
			'TARJETA DEBI.' AS tipo, \
			COUNT(df.formapag) AS numoperaciones, \
			SUM(df.valor) AS total \
			FROM ventas v FORCE INDEX(fechamodi) \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
			%s \
			%s \
			WHERE v.acredito = 0 AND v.cancelado = 0 \
			AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FTARDE' \
			%s %s %s %s %s %s %s %s %s %s %s %s \
			)) t GROUP BY t.tipo",
				inner_join_trndetvta, join_cfdiweb_venta,

				fecha_ini, fecha_fin, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta,

				inner_join_trndetvta, join_cfdiweb_venta,

				fecha_ini, fecha_fin, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_ventascredito
			Instruccion.sprintf(" SELECT \
			'CREDITO' AS tipo, \
			SUM(df.valor) AS total \
			FROM ventas v FORCE INDEX(fechamodi) \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones s ON s.seccion = t.seccion \
			INNER JOIN clientes cli ON cli.cliente = v.cliente \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
			%s \
			%s \
			WHERE v.acredito = 1 AND v.cancelado = 0 \
			AND v.fechamodi BETWEEN '%s' AND '%s' AND fp.formapag = 'FCREDI' \
			%s %s %s %s %s %s %s %s %s %s %s %s ",
				inner_join_trndetvta, join_cfdiweb_venta,

				fecha_ini, fecha_fin, condicion_especialNormal,
				condicion_sucursal, condicion_terminal, condicion_cortes,
				condicion_clientes, condicion_parteRel, condicion_origenVenta,
				condicion_hora, condicion_cajero, condicion_seguimiento,
				condicion_auth, condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_adicionales
			Instruccion.sprintf("SELECT \
				UPPER(t.descripcion) AS descripcion, \
				(t.totact) AS total, \
				t.formapag, \
				t.seccion, \
				t.termino \
			FROM (( \
				SELECT \
					fp.descripcion AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					tp.termino, \
					1 AS seccion \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.cancelado = 0 \
					AND fp.formapag = 'FCONEF' \
					AND v.fechavta>='%s' \
					AND v.fechavta<='%s' \
					%s %s \
				GROUP BY df.formapag \
			)UNION ALL( \
				SELECT \
					cm.descripcion AS descripcion, \
					'SERVIC' AS formapag, \
					SUM(m.cantretirado) AS totact, \
					'' AS termino, \
					1 AS seccion \
				FROM movsefectivocaja m \
					INNER JOIN terminales t ON t.terminal = m.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
				WHERE m.fecharetiro BETWEEN '%s' AND '%s' \
					AND cm.clave = 'REFECL' \
					%s \
				ORDER BY m.concepto \
			)UNION ALL( \
				SELECT \
					fp.descripcion AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					tp.termino, \
					2 AS seccion \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.cancelado = 0 \
					AND fp.termino != 'TARCR' \
					AND fp.formapag != 'FCONEF' \
                    AND tp.termino NOT IN ('CONCH','CONEN','CREDI') \
					AND v.fechavta>='%s' \
					AND v.fechavta<='%s' \
					%s %s \
				GROUP BY df.formapag \
			)UNION ALL( \
				SELECT \
					'Cobro Pinpad' AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					tp.termino, \
					2 AS seccion \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NOT NULL \
					AND v.fechavta>='%s' \
					AND v.fechavta<='%s' \
					%s %s \
				GROUP BY fp.termino \
			)UNION ALL( \
				SELECT \
					'Cobro TPV' AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					tp.termino, \
					2 AS seccion \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v. cliente \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.cancelado = 0 \
					AND fp.termino = 'TARCR' \
					AND df.trn_id IS NULL \
					AND v.fechavta>='%s' \
					AND v.fechavta<='%s' \
					%s %s \
				GROUP BY fp.termino \
			)UNION ALL( \
				SELECT \
					'Ventas a Crédito' AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					'CREDITO' AS termino, \
					3 AS seccion \
				FROM ventas v FORCE INDEX(fechamodi) \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.acredito = 1 \
					AND v.cancelado = 0 \
					AND v.fechamodi BETWEEN '%s' AND '%s' \
					AND tp.terminoreal = 1 \
					%s %s \
			) UNION ALL( \
				SELECT \
					cm.descripcion AS descripcion, \
					'SERVIC' AS formapag, \
					SUM(m.cantretirado) AS totact, \
					'' AS termino, \
					1 AS seccion \
				FROM movsefectivocaja m \
					INNER JOIN terminales t ON t.terminal = m.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
				WHERE m.fecharetiro BETWEEN '%s' AND '%s' \
					AND cm.clave = 'DPGSER' \
					%s \
				ORDER BY m.concepto \
			)UNION ALL( \
				SELECT \
					'Cobranza Efectivo' AS descripcion, \
					'PAGCLI' AS formapag, \
					SUM(t.valor)*-1 AS totact, \
					'' AS termino, \
					1 AS seccion \
				FROM ventas v \
					INNER JOIN transxcob t ON t.referencia = v.referencia \
					INNER JOIN pagoscli p ON p.pago = t.pago \
					INNER JOIN terminales ter ON ter.terminal = p.terminal \
					INNER JOIN secciones s ON s.seccion = ter.seccion \
					%s \
				WHERE t.fechaapl BETWEEN '%s' AND '%s' \
					AND p.cancelado = 0 \
					AND t.aplicada = 1  \
					AND t.cancelada = 0 \
					AND p.formapag = 'E' \
					%s %s \
			)UNION ALL( \
				SELECT \
					prod.nombre AS descripcion, \
					'RECEL' AS formapag, \
					SUM(dv.cantidad*dv.precioimp) AS total, \
					'' AS termino, \
					3 AS seccion \
				FROM ventas v FORCE INDEX(fechamodi) \
					INNER JOIN dventas dv ON dv.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN articulos a ON a.articulo = dv.articulo \
					INNER JOIN productos prod ON prod.producto = a.producto \
					%s \
				WHERE prod.nombre LIKE '%%RECARGAS%%' \
					AND a.activo = 1 \
					AND v.cancelado = 0 \
					AND v.fechamodi BETWEEN '%s' AND '%s' \
					%s %s \
			)UNION ALL( \
				SELECT \
					'Cobranza Elect.' AS descripcion, \
					'PAGCLI' AS formapag, \
					SUM(t.valor)*-1 AS totact, \
                    '' AS termino, \
					2 AS seccion \
				FROM ventas v \
					INNER JOIN transxcob t ON t.referencia = v.referencia \
					INNER JOIN pagoscli p ON p.pago = t.pago \
					INNER JOIN terminales ter ON ter.terminal = p.terminal \
					INNER JOIN secciones s ON s.seccion = ter.seccion \
					%s \
				WHERE t.fechaapl BETWEEN '%s' AND '%s' \
				AND p.cancelado = 0 \
				AND t.aplicada = 1 \
				AND t.cancelada = 0 \
				AND p.formapag != 'E' \
				%s %s \
			)UNION ALL( \
				SELECT \
					'TOTAL VENTAS' AS descripcion, \
					'TOTVTS' AS formapag, \
					SUM(dv.cantidad*dv.precioimp) AS totact, \
                    '' AS termino, \
					5 AS seccion \
				FROM ventas v FORCE INDEX(fechavta) \
					INNER JOIN dventas dv ON dv.referencia = v.referencia \
					INNER JOIN terminales ter ON ter.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = ter.seccion  \
					%s \
				WHERE v.fechavta BETWEEN '%s' AND '%s' \
				AND v.cancelado = 0 \
				%s %s \
			))t \
			GROUP BY t.descripcion, t.seccion \
			HAVING total IS NOT NULL \
			ORDER BY t.seccion ASC, t.formapag ASC",
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal, condicion_cfdiweb_venta,
				join_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal,  condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);

			// resp_info_adicionales
			Instruccion.sprintf("SELECT \
				UPPER(t.descripcion) AS descripcion, \
				(t.totact) AS total, \
				t.formapag, \
				t.seccion, \
				t.termino \
			FROM (( \
				SELECT \
					'Ventas a Crédito' AS descripcion, \
					fp.formapag, \
					SUM(df.valor) AS totact, \
					'CREDITO' AS termino, \
					3 AS seccion \
				FROM ventas v FORCE INDEX(fechamodi) \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					INNER JOIN dventasfpago df ON df.referencia = v.referencia \
					INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
					INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
					%s \
				WHERE v.acredito = 1 \
					AND v.cancelado = 0 \
					AND v.fechamodi BETWEEN '%s' AND '%s' \
					AND tp.terminoreal = 1 \
					%s %s \
			) UNION ALL( \
				SELECT \
					cm.descripcion AS descripcion, \
					'SERVIC' AS formapag, \
					SUM(m.cantretirado) AS totact, \
                    '' AS termino, \
					1 AS seccion \
				FROM movsefectivocaja m \
					INNER JOIN terminales t ON t.terminal = m.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
				WHERE m.fecharetiro BETWEEN '%s' AND '%s' \
					AND cm.clave = 'DPGSER' \
					%s \
				ORDER BY m.concepto \
			)UNION ALL( \
				SELECT \
					prod.nombre AS descripcion, \
					'RECEL' AS formapag, \
					SUM(dv.cantidad*dv.precioimp) AS total, \
					'' AS termino, \
					3 AS seccion \
				FROM ventas v FORCE INDEX(fechamodi) \
					INNER JOIN dventas dv ON dv.referencia = v.referencia \
					INNER JOIN terminales t ON t.terminal = v.terminal \
					INNER JOIN secciones s ON s.seccion = t.seccion \
					INNER JOIN articulos a ON a.articulo = dv.articulo \
					INNER JOIN productos prod ON prod.producto = a.producto \
					%s \
				WHERE prod.nombre LIKE '%%RECARGAS%%' \
					AND a.activo = 1 \
					AND v.cancelado = 0 \
					AND v.fechamodi BETWEEN '%s' AND '%s' \
					%s %s \
			))t \
			GROUP BY t.descripcion, t.seccion \
			HAVING total IS NOT NULL \
			ORDER BY t.seccion ASC, t.formapag ASC",
				join_cfdiweb_venta, fecha_ini, fecha_fin, condicion_sucursal,  condicion_cfdiweb_venta,
				fecha_ini, fecha_fin, condicion_sucursal,
				join_cfdiweb_venta, fecha_ini, fecha_fin, condicion_sucursal,  condicion_cfdiweb_venta);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				Instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		if (resp_parametro != NULL)
			delete resp_parametro;
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPARTSUP
void ServidorReportes::EjecutaRepArtSupervisados(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString usuario;
	AnsiString condicion_usuario = " ";

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND art.usuario = '%s' ", usuario);
	}

	Instruccion.sprintf("SELECT \
	p.nombre, \
	art.producto, \
	art.present, \
	art.usuario, \
	CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario \
	FROM articulossupervisados art \
	INNER JOIN productos p ON p.producto = art.producto \
	INNER JOIN empleados e ON art.usuario = e.empleado \
	WHERE 1 %s \
	GROUP BY art.producto, art.present \
	ORDER BY p.nombre ASC", condicion_usuario);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_FACTURAS_CAMBIOS_FECHAVENC
void ServidorReportes::ConsultaReporteModFechaVenc(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString muestrasolofacturassincheque = " ";
	AnsiString busquedaporsector = " ";
	AnsiString busquedaporlocalidad = " ";
	AnsiString fecha_inicio, fecha_fin, proveedor, sucursal, fecha_vence_ini,
		fecha_vence, usar_fechavence, con_saldo, fecha_saldo;
	AnsiString condicion_cobrador = " ", condicion_status = " ";
	AnsiString vendedor, status;
	AnsiString cliente, condicion_cliente = " ";
	AnsiString forzar_indice = " ";
	TDate date_fecha_inicio, date_fecha_fin, date_fecha_vence_ini,
		date_fecha_vence, date_fecha_saldo;
	AnsiString condicion_proveedor = " ", condicion_sucursal = " ",
		condicion_fechavence = " ";
	AnsiString condicion_con_saldo = " ", condicion_left = " ",
		mostrarfacturascheque;
	AnsiString omitiruuid;
	AnsiString condicion_mostraruuid = " ";

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	fecha_inicio = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_fin = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_saldo = mFg.ExtraeStringDeBuffer(&parametros);

	date_fecha_inicio = StrToDate(fecha_inicio);
	date_fecha_fin = StrToDate(fecha_fin);
	date_fecha_saldo = StrToDate(fecha_saldo);

	if (proveedor != "") {
		condicion_proveedor.sprintf(" and c.proveedor='%s' ", proveedor);
	}
	if (sucursal != "") {
		condicion_sucursal.sprintf(" and sec.sucursal='%s' ", sucursal);
	}

	// Crea una tabla donde se van a poner los saldos de las ventas
	// afectadas por la cancelación
	instruccion =
		"CREATE TEMPORARY TABLE auxcomprasprove (compra CHAR(11),sucursal CHAR(3), saldor DECIMAL(16,2), \
		chcnc DECIMAL(16,2), tncredito DECIMAL(16,2), tncargo DECIMAL(16,2), fechach DATE, PRIMARY KEY (compra)) ENGINE = INNODB";
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	// Crea una tabla donde se van a poner las compras que tienen notas de crédito a las que les falta capturar el UUID
	instruccion = "CREATE TEMPORARY TABLE auxNotasSinUuid (compra CHAR(11), notasSinUuid tinyint, \
		PRIMARY KEY (compra)) ENGINE = INNODB";
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	// Calcula notas de crédito a las que les falta capturar el UUID
	instruccion.sprintf("insert into auxNotasSinUuid (compra,notasSinUuid) \
		SELECT c.referencia AS compra, \
		max(if(LENGTH(IFNULL(nc.muuid,''))=0,1,0)) as notaSinUuid \
		FROM bitacorafechasvencimiento bfv \
		INNER JOIN compras c ON c.referencia = bfv.referencia \
		inner join terminales ter on ter.terminal=c.terminal \
		inner JOIN secciones sec ON sec.seccion=ter.seccion \
		INNER JOIN notascredprov nc ON nc.compra=c.referencia and nc.cancelado=0 \
		WHERE bfv.fechavencant>='%s' AND bfv.fechavencant<='%s' AND nc.fechanot<='%s' \
		AND bfv.fechavencact>='%s' AND bfv.fechavencact<='%s' \
		%s %s \
		AND c.cancelado = 0 \
		GROUP BY c.referencia ", mFg.StrToMySqlDate(fecha_inicio),
		mFg.StrToMySqlDate(fecha_fin), mFg.StrToMySqlDate(fecha_saldo),
		mFg.StrToMySqlDate(fecha_inicio), mFg.StrToMySqlDate(fecha_fin),
		condicion_proveedor, condicion_sucursal);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	// Calcula los saldos de las ventas del proveedor
	instruccion.sprintf("insert into auxcomprasprove (compra,sucursal, saldor, chcnc, tncredito, tncargo,fechach) \
		SELECT a.compra,a.sucursal,a.saldor,a.chcnc,a.tncredito,a.tncargo,a.fechach FROM ( \
		SELECT c.referencia AS compra, \
		sec.sucursal , \
		SUM(IF(t.aplicada=1, t.valor, 0)) AS saldor, \
		SUM(IF(t.aplicada=0, t.valor, 0)) AS chcnc, \
		SUM(IF(t.aplicada=1 AND t.tipo='DEVO', t.valor, 0)) AS tncredito, \
		SUM(IF(t.aplicada=1 AND (t.tipo='NCAR' OR t.tipo='INTE'), t.valor, 0)) AS tncargo, \
		MAX(IFNULL(chcl.fechacob, CAST('1900-01-01' AS DATE))) AS fechach \
		FROM bitacorafechasvencimiento bfv \
		INNER JOIN compras c ON c.referencia = bfv.referencia \
		INNER JOIN transxpag t \
		inner join terminales ter on ter.terminal=c.terminal \
		inner JOIN secciones sec ON sec.seccion=ter.seccion \
		LEFT JOIN pagosprov p ON t.pago=p.pago AND t.aplicada=0 \
		LEFT JOIN cheqxpag chxc ON p.pago=chxc.pago \
		LEFT JOIN chequesproveedores chcl ON chxc.chequeprov=chcl.chequeprov \
		WHERE bfv.fechavencant>='%s' AND bfv.fechavencant<='%s' AND t.referencia=c.referencia AND t.fechaapl<='%s'\
		and bfv.fechavencact>='%s' and bfv.fechavencact<='%s' \
		%s %s \
		AND t.cancelada = 0 \
		AND c.cancelado = 0 \
		GROUP BY c.referencia \
		) AS a ", mFg.StrToMySqlDate(fecha_inicio),
		mFg.StrToMySqlDate(fecha_fin), mFg.StrToMySqlDate(fecha_saldo),
		mFg.StrToMySqlDate(fecha_inicio), mFg.StrToMySqlDate(fecha_fin),
		condicion_proveedor, condicion_sucursal);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("SELECT \
	c.referencia, \
	cs.sucursal, \
	IFNULL(c.folioprov,'') AS folio, \
	c.muuid as uuid, \
	ifnull(nsu.notasSinUuid,0) as notasSinUuid, \
	c.proveedor AS codigoprove, \
	p.razonsocial, \
	c.fechacom, \
	cs.saldor, \
	bfv.fechavencant, \
	bfv.fechavencact, \
	c.valor, \
	(cs.chcnc*-1) AS chnocob, \
	cs.fechach, \
	(cs.tncredito*-1) AS tncredito, \
	cs.tncargo, \
    DATEDIFF(CURDATE(),c.fechacom) AS dias, \
	DATEDIFF('%s',c.fechacom)- IFNULL(c.plazo,0) AS diasvenc \
	FROM bitacorafechasvencimiento bfv \
	INNER JOIN compras c ON c.referencia = bfv.referencia \
	INNER JOIN proveedores p ON p.proveedor=c.proveedor \
	INNER JOIN auxcomprasprove cs ON cs.compra=c.referencia \
	LEFT JOIN auxNotasSinUuid nsu ON c.referencia=nsu.compra \
	WHERE bfv.fechavencant>='%s' AND bfv.fechavencant<='%s' \
	and bfv.fechavencact>='%s' and bfv.fechavencact<='%s' \
	ORDER BY c.referencia ", mFg.StrToMySqlDate(fecha_saldo),
		mFg.StrToMySqlDate(fecha_inicio), mFg.StrToMySqlDate(fecha_fin),
		mFg.StrToMySqlDate(fecha_inicio), mFg.StrToMySqlDate(fecha_fin));
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPAGOSGASTOS
void ServidorReportes::EjecutaRepPagosGastos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString agrupaxcliente, agrupaxtranxpaggas ;
	AnsiString fecha_inicial_pagos, fecha_final_pagos, fecha_inicial_gastos,
		fecha_final_gastos;
	AnsiString forma_pago, proveedor, pago, numcuenta;
	AnsiString foliopago, cuenta_bancaria, joins_cuenta_bancaria = " ";

	AnsiString condicion_forma_pago = " ";
	AnsiString condicion_proveedor = " ";
	AnsiString condicion_pago = " ";
	AnsiString condicion_foliopago = " ";

	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3, archivo_temp4,
		archivo_temp5;

	AnsiString departamento, solicitadopor, autorizadopor, tipogasto,
		parterelacion;
	AnsiString condicion_departamento = " ", condicion_solicitadopor = " ",
		condicion_autorizadopor = " ";
	AnsiString condicion_tipogasto = " ", condicion_proveedor_pago = " ",
		condicion_parterelacion = " ";
	AnsiString condicion_numcuenta = " ";

	AnsiString agrupar;

	try {
		fecha_inicial_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_pagos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_gastos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_gastos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		forma_pago = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		pago = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxcliente = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxtranxpaggas = mFg.ExtraeStringDeBuffer(&parametros);
		departamento = mFg.ExtraeStringDeBuffer(&parametros);
		solicitadopor = mFg.ExtraeStringDeBuffer(&parametros);
		autorizadopor = mFg.ExtraeStringDeBuffer(&parametros);
		tipogasto = mFg.ExtraeStringDeBuffer(&parametros);
		parterelacion = mFg.ExtraeStringDeBuffer(&parametros);
		numcuenta = mFg.ExtraeStringDeBuffer(&parametros);
		foliopago = mFg.ExtraeStringDeBuffer(&parametros);
		cuenta_bancaria = mFg.ExtraeStringDeBuffer(&parametros);

		instruccion.sprintf("SET SESSION sql_log_bin = 0 ");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SET SESSION tx_isolation='READ-COMMITTED' ");
		instrucciones[num_instrucciones++] = instruccion;

		if (sucursal.Trim() != "") {

			condicion_sucursal.sprintf(" AND g.sucursal='%s' ", sucursal);

		} else if(empresa != " "){
			condicion_empresa.sprintf(" AND sg.idempresa = %s ", empresa);
		}

		if (forma_pago != " ") {
			condicion_forma_pago.sprintf(" AND pg.formapag='%s' ", forma_pago);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf(" AND g.proveedor='%s' ", proveedor);
			condicion_proveedor_pago.sprintf(" AND pg.proveedor='%s' ",
				proveedor);
		}
		if (pago != " ") {
			condicion_pago.sprintf(" AND t.pago='%s' ", pago);
		}
		if (departamento != " ") {
			condicion_departamento.sprintf(" AND g.depart='%s' ", departamento);
		}
		if (solicitadopor != " ") {
			condicion_solicitadopor.sprintf(" AND g.solicita='%s' ",
				solicitadopor);
		}
		if (autorizadopor != " ") {
			condicion_autorizadopor.sprintf(" AND g.autoriza='%s' ",
				autorizadopor);
		}
		if (tipogasto != " ") {
			condicion_tipogasto.sprintf(" AND g.tipogasto='%s' ", tipogasto);
		}
		if (parterelacion != " ") {
			condicion_parterelacion.sprintf(" AND p.esparterelac=%s ",
				parterelacion);
		}
		if (numcuenta != " ") {
			condicion_numcuenta.sprintf(" AND g.numcuenta='%s' ", numcuenta);
		}
		if (foliopago != " ") {
			condicion_foliopago.sprintf("AND tpg.pago='%s' ", foliopago);
			//condicion_foliopago.sprintf("AND g.referencia='%s' ", foliopago);
		}

		if(cuenta_bancaria != " "){
			joins_cuenta_bancaria.sprintf(" INNER JOIN bancosxpaggasto bxp ON bxp.tracredito = tpg.tracredito  \
			INNER JOIN bancostransacc bt ON bt.transacc=bxp.transacc  \
			INNER JOIN bancosmov bm ON bm.idmovbanco=bt.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1 AND bm.idnumcuenta=%s ",
			cuenta_bancaria);
		}

		instruccion.sprintf("CREATE TEMPORARY TABLE auximpuestos( \
		referencia VARCHAR(11), \
		valorunitario DECIMAL(16,6), \
		descuento DECIMAL(16,6), \
		isr_retenido DECIMAL(16,4), \
		tasa_isr_retenido DECIMAL(16,4), \
		iva_retenido DECIMAL(16,4), \
		tasa_iva_retenido DECIMAL(16,4), \
		ieps_retenido DECIMAL(16,4), \
		tasa_ieps_retenido DECIMAL(16,4), \
		iva_trasladado DECIMAL(16,4), \
		tasa_iva_trasladado DECIMAL(16,4), \
		ieps_trasladado DECIMAL(16,4), \
		tasa_ieps_trasladado DECIMAL(16,4), \
		costo DECIMAL(16,6), \
		costoimp DECIMAL(16,6), \
		INDEX (referencia)) ENGINE = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		// Consulta todas los gastos que tienen al menos un pago entre las fechas dadas
		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT t.referencia, SUM(t.valorunitario), SUM(t.descuento), \
		SUM(t.isr_retenido), (t.tasa_isr_retenido), SUM(t.iva_retenido), t.tasa_iva_retenido, \
		SUM(t.ieps_retenido), t.tasa_ieps_retenido, SUM(t.iva_trasladado), t.tasa_iva_trasladado, \
		SUM(t.ieps_trasladado), t.tasa_ieps_trasladado, SUM(t.costo), SUM(t.costoimp) FROM (( \
		SELECT \
		g.referencia, \
		SUM(dg.valorunitario) AS valorunitario, \
		SUM(dg.descuento) AS descuento, \
		SUM(dg.isr_retenido) AS isr_retenido, \
		(dg.tasa_isr_retenido) AS tasa_isr_retenido, \
		SUM(dg.iva_retenido) AS iva_retenido, \
		(dg.tasa_iva_retenido) AS tasa_iva_retenido, \
		SUM(dg.ieps_retenido) AS ieps_retenido, \
		(dg.tasa_ieps_retenido) AS tasa_ieps_retenido, \
		SUM(dg.iva_trasladado) AS iva_trasladado, \
		(dg.tasa_iva_trasladado) AS tasa_iva_trasladado, \
		SUM(dg.ieps_trasladado) AS ieps_trasladado, \
		(dg.tasa_ieps_trasladado) AS tasa_ieps_trasladado, \
		SUM(dg.costo) AS costo, \
		SUM(dg.costoimp) AS costoimp \
		FROM gastos g \
		INNER JOIN dgastos dg ON dg.referencia = g.referencia \
        INNER JOIN sucursales sg ON sg.sucursal = g.sucursal \
		WHERE g.cancelado = 0 AND g.fechagas BETWEEN '%s' AND '%s' %s %s %s %s %s %s %s \
		GROUP BY g.referencia \
		) \
		UNION ALL \
		( \
		SELECT \
		n.gasto AS referencia, \
		SUM(dn.valorunitario)*-1 AS valorunitario, \
		SUM(dn.descuento)*-1 AS descuento, \
		SUM(dn.isr_retenido)*-1 AS isr_retenido, \
		(dn.tasa_isr_retenido) AS tasa_isr_retenido, \
		SUM(dn.iva_retenido)*-1 AS iva_retenido, \
		(dn.tasa_iva_retenido) AS tasa_iva_retenido, \
		SUM(dn.ieps_retenido)*-1 AS ieps_retenido, \
		(dn.tasa_ieps_retenido) AS tasa_ieps_retenido, \
		SUM(dn.iva_trasladado)*-1 AS iva_trasladado, \
		(dn.tasa_iva_trasladado) AS tasa_iva_trasladado, \
		SUM(dn.ieps_trasladado)*-1 AS ieps_trasladado, \
		(dn.tasa_ieps_trasladado) AS tasa_ieps_trasladado, \
		SUM(dn.costo)*-1 AS costo, \
		SUM(dn.costoimp)*-1 AS costoimp \
		FROM notascredgasto n \
		INNER JOIN dnotascredgasto dn ON dn.referencia= n.referencia \
		INNER JOIN terminales ter ON ter.terminal = n.terminal \
		INNER JOIN secciones sec ON sec.seccion = ter.seccion \
		INNER JOIN sucursales sg ON sg.sucursal = sec.sucursal \
		WHERE n.cancelado = 0 \
		AND n.fechanot BETWEEN '%s' AND '%s' %s \
		GROUP BY n.referencia \
		)) t GROUP BY t.referencia INTO OUTFILE '%s'", fecha_inicial_gastos,
			fecha_final_gastos,

			condicion_departamento, condicion_solicitadopor,
			condicion_autorizadopor, condicion_tipogasto, condicion_empresa, condicion_sucursal,
			condicion_proveedor,
			fecha_inicial_gastos, fecha_final_gastos, condicion_empresa,

			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos ",
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,

		instruccion.sprintf("CREATE TEMPORARY TABLE auxpagos( \
		pago VARCHAR(11), \
		proveedor VARCHAR(11), \
		valor DECIMAL(16,6), \
		ajuste DECIMAL(16,6), \
		fecha DATE, \
		muuid VARCHAR(36), \
		ident VARCHAR(20), \
		INDEX (proveedor)) ENGINE = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		// para luego hacerle un left join con los gastos.
		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT \
		pg.pago, \
		pg.proveedor, \
		SUM(pg.valor), \
		SUM(pg.ajuste), \
		pg.fecha, \
		pg.muuid, \
		pg.ident \
		FROM pagosgastos pg \
		WHERE pg.fecha BETWEEN '%s' AND '%s' %s %s \
		AND pg.cancelado = 0 \
		GROUP BY pg.pago INTO OUTFILE '%s'", fecha_inicial_pagos,
			fecha_final_pagos, condicion_forma_pago, condicion_proveedor_pago,

			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auxpagos ",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			// borrar archivos temporales
			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);

			if (agrupaxcliente=="1") {
				agrupar = "p.proveedor";
			}else if(agrupaxtranxpaggas=="1"){
				agrupar = "tpg.pago, g.referencia";
			}else {
				agrupar = "g.referencia";
			}

			instruccion.sprintf("SELECT \
			g.folioprov as factura, \
			tpg.pago as foliopago, \
			g.muuid, \
			p.rfc, \
			g.fechagas, \
			ifnull(ch.fechacob, apg.fecha) as fechapag, \
			g.sucursal, \
			g.proveedor, \
			p.razonsocial as rsocial, \
			ai.valorunitario, \
			SUM(ai.descuento) AS descuento, \
			SUM(ai.isr_retenido) AS isr_retenido, \
			ai.tasa_isr_retenido, \
			SUM(ai.iva_retenido) AS iva_retenido, \
			ai.tasa_iva_retenido, \
			SUM(ai.ieps_retenido) AS ieps_retenido, \
			ai.tasa_ieps_retenido, \
			SUM(ai.iva_trasladado) AS iva_trasladado, \
			ai.tasa_iva_trasladado, \
			SUM(ai.ieps_trasladado) AS ieps_trasladado, \
			ai.tasa_ieps_trasladado, \
			SUM(ai.costo) AS costo, \
			SUM(ai.costoimp) AS costoimp, \
			SUM((tpg.valor*-1)) AS vpagos, \
			SUM(apg.valor) AS pagos, \
			SUM(apg.ajuste) AS ajuste, \
			IFNULL(apg.muuid,'') as uuidpago, \
			IFNULL(apg.ident,'') as seriefoliopago, \
			cp.cuenta_retencion_iva, cc_iva.nombrecuenta as cuenta_iva_nombre, \
			cp.cuenta_retencion_isr, cc_isr.nombrecuenta as cuenta_isr_nombre, \
			ROUND((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento),2) AS subtotal_pag, \
			ROUND(((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento))*(ai.tasa_isr_retenido),2) AS isr_ret_pag,  \
			ROUND(((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento))*(ai.tasa_iva_retenido),2) AS iva_ret_pag,  \
			ROUND(((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento))*(ai.tasa_ieps_retenido),2) AS ieps_ret_pag, \
			ROUND(((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento))*(ai.tasa_iva_trasladado),2) AS iva_tras_pag, \
            ROUND(((SUM(tpg.valor*-1))/(SUM(ai.costoimp-ai.descuento))*SUM(ai.costo-ai.descuento))*(ai.tasa_ieps_trasladado),2) AS ieps_tras_pag \
			FROM gastos g \
			INNER JOIN proveedores p ON p.proveedor = g.proveedor \
			INNER JOIN transxpaggastos tpg ON tpg.referencia = g.referencia \
			INNER JOIN auximpuestos ai ON ai.referencia = g.referencia \
			INNER JOIN terminales ter ON ter.terminal = g.terminal \
			INNER JOIN secciones sec ON sec.seccion = ter.seccion \
			INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
			INNER JOIN sucursales sg ON sg.sucursal = g.sucursal  %s \
			LEFT JOIN cuentas_proveedor cp ON cp.proveedor = p.proveedor   \
			LEFT JOIN cuentascont cc_iva ON cc_iva.numcuenta = cp.cuenta_retencion_iva AND cc_iva.sucursal = g.sucursal \
			LEFT JOIN cuentascont cc_isr ON cc_isr.numcuenta = cp.cuenta_retencion_isr AND cc_isr.sucursal = g.sucursal \
			LEFT JOIN cheqxgas chg ON chg.pago = tpg.pago \
			LEFT JOIN chequesgastos ch ON ch.chequegasto = chg.chequegasto \
			LEFT JOIN auxpagos apg ON apg.pago = tpg.pago \
			WHERE \
			tpg.tipo = 'PAGO' AND tpg.cancelada = 0 \
			%s \
			%s \
			%s \
			%s \
			%s \
			%s \
			%s \
			%s \
            %s \
			AND tpg.fechaapl BETWEEN '%s' AND '%s' \
			AND g.fechagas BETWEEN '%s' AND '%s' \
			AND g.cancelado = 0 \
			%s \
			GROUP BY %s \
			ORDER BY suc.numid, IFNULL(ch.fechacob, apg.fecha) ASC, tpg.pago ASC "
				,
                joins_cuenta_bancaria,
				condicion_departamento, condicion_solicitadopor,
				condicion_autorizadopor, condicion_tipogasto,
				condicion_empresa, condicion_sucursal, condicion_parterelacion,
				condicion_numcuenta, condicion_proveedor,


				fecha_inicial_pagos, fecha_final_pagos,

				fecha_inicial_gastos, fecha_final_gastos,
				condicion_foliopago,

				agrupar);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPSALDOSGASTOS
void ServidorReportes::EjecutaRepSaldosGastos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;

	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	int i, agrupaxcliente;

	AnsiString fecha_saldos, fecha_inicial_gastos, fecha_final_gastos;
	AnsiString proveedor, parterelacion;
	AnsiString condicion_proveedor = " ";

   	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString campo_uuid = " ", condicion_uuid = " ";

	AnsiString departamento, solicitadopor, autorizadopor, tipogasto;
	AnsiString condicion_departamento = " ", condicion_solicitadopor = " ",
		condicion_autorizadopor = " ";
	AnsiString condicion_tipogasto = " ", condicion_proveedor_pago = " ",
		condicion_parterelacion = " ";

	try {
		fecha_saldos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_inicial_gastos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final_gastos =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		agrupaxcliente = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		departamento = mFg.ExtraeStringDeBuffer(&parametros);
		solicitadopor = mFg.ExtraeStringDeBuffer(&parametros);
		autorizadopor = mFg.ExtraeStringDeBuffer(&parametros);
		tipogasto = mFg.ExtraeStringDeBuffer(&parametros);
		parterelacion = mFg.ExtraeStringDeBuffer(&parametros);

		if (sucursal != " ") {
			condicion_sucursal.sprintf("g.sucursal='%s' AND ", sucursal);
		} else if (empresa != " ") {
			condicion_empresa.sprintf("sg.idempresa = %s AND ", empresa);
		}
		if (proveedor != " ") {
			condicion_proveedor.sprintf("g.proveedor='%s' AND ", proveedor);
		}
		if (departamento != " ") {
			condicion_departamento.sprintf(" g.depart='%s' AND ", departamento);
		}
		if (solicitadopor != " ") {
			condicion_solicitadopor.sprintf(" g.solicita='%s' AND ",
				solicitadopor);
		}
		if (autorizadopor != " ") {
			condicion_autorizadopor.sprintf(" g.autoriza='%s' AND ",
				autorizadopor);
		}
		if (tipogasto != " ") {
			condicion_tipogasto.sprintf(" g.tipogasto='%s' AND ", tipogasto);
		}
		if (parterelacion != " ") {
			condicion_parterelacion.sprintf(" p.esparterelac=%s AND ",
				parterelacion);
		}
		if (!agrupaxcliente) {
			campo_uuid = " muuid VARCHAR(36), ";
			condicion_uuid = " ifnull(g.muuid,'') as muuid, ";
		}

		// Crea una tabla para tener las compras en cuestión
		instruccion.sprintf("create temporary table gastosaux \
                  (referencia char(11), \
                  saldo decimal(16,4), \
                  cargos decimal(16,4), \
                  %s  \
                  saldodecargos decimal(16,4), \
                  totaltodo decimal(16,4), \
                  isr_retenido DECIMAL(16,4), \
                  tasa_isr_retenido DECIMAL(16,4), \
                  iva_retenido DECIMAL(16,4), \
                  tasa_iva_retenido DECIMAL(16,4), \
                  ieps_retenido DECIMAL(16,4), \
                  tasa_ieps_retenido DECIMAL(16,4), \
                  iva_trasladado DECIMAL(16,4), \
                  tasa_iva_trasladado DECIMAL(16,4), \
                  ieps_trasladado DECIMAL(16,4), \
                  tasa_ieps_trasladado DECIMAL(16,4), \
                  PRIMARY KEY (referencia)) Engine = INNODB", campo_uuid);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla para tener las referencias en cuestión
		instruccion = "create temporary table referenciasaux \
                  (gasto char(11), \
                  saldo decimal(16,4), \
                  cargos decimal(16,4), \
                  PRIMARY KEY (gasto)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table dnotascredgastosaux \
                  (gasto char(11), \
                  saldo decimal(16,4), \
                  cargos decimal(16,4), \
                  claveprodserv VARCHAR(11), \
                  cantidad decimal(12,3), \
                  costo decimal(16,6), \
                  costoimp decimal(16,6), \
                  isr_retenido DECIMAL(16,4), \
                  tasa_isr_retenido DECIMAL(16,4), \
                  iva_retenido DECIMAL(16,4), \
                  tasa_iva_retenido DECIMAL(16,4), \
                  ieps_retenido DECIMAL(16,4), \
                  tasa_ieps_retenido DECIMAL(16,4), \
                  iva_trasladado DECIMAL(16,4), \
                  tasa_iva_trasladado DECIMAL(16,4), \
                  ieps_trasladado DECIMAL(16,4), \
                  tasa_ieps_trasladado DECIMAL(16,4), \
                  INDEX (gasto), INDEX(claveprodserv)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea una tabla con todas las compras que cumplen las condiciones y
		// que tengan saldo.
		instruccion.sprintf("insert into referenciasaux \
                  select \
						g.referencia as gasto, \
                        sum(t.valor) as saldo, \
                        sum(if(t.concepto='C' and t.destino='C' and t.tipo<>'CHDE' and t.tipo<>'COMP', t.valor, 0)) as cargos \
				  from gastos g \
                    INNER JOIN sucursales sg ON sg.sucursal = g.sucursal \
                    inner join  proveedores p on p.proveedor=g.proveedor \
                    inner join terminales ter on ter.terminal=g.terminal \
					inner join secciones sec on ter.seccion=sec.seccion \
                    inner join transxpaggastos t on t.referencia=g.referencia  \
                  where \
                        %s \
                        %s \
                        %s \
                        %s \
                        %s \
						%s \
						%s \
						%s \
                        t.cancelada=0 and \
                        g.cancelado=0 and \
                        g.acredito=1 and \
                        t.fechaapl<='%s' and \
                        t.aplicada=1 and \
                        g.fechagas>='%s' and \
                        g.fechagas<='%s' \
                  group by \
                        g.referencia \
				  having saldo>=0.01", condicion_empresa, condicion_sucursal, condicion_proveedor,
			condicion_departamento, condicion_solicitadopor,
			condicion_autorizadopor, condicion_tipogasto,
			condicion_parterelacion, fecha_saldos, fecha_inicial_gastos,
			fecha_final_gastos);
		instrucciones[num_instrucciones++] = instruccion;

		// Suma las notas de crédito y deja el resultado en una tabla temporal,
		// para luego hacerle un left join con las compras.
		instruccion.sprintf("insert into dnotascredgastosaux \
                  select \
                        g.referencia as gasto, \
                        ra.saldo, \
                        ra.cargos, \
                        dn.claveprodserv, \
                        sum(if(n.tipo='0',dn.cantidad,0)) as cantidad, \
						sum(if(n.tipo<>'0',dn.costo,0)) as costo, \
						sum(if(n.tipo<>'0',dn.costoimp,0)) as costoimp, \
						SUM(dn.isr_retenido), \
						(dn.tasa_isr_retenido), \
						SUM(dn.iva_retenido), \
						(dn.tasa_iva_retenido), \
						SUM(dn.ieps_retenido), \
						(dn.tasa_ieps_retenido), \
						SUM(dn.iva_trasladado), \
						(dn.tasa_iva_trasladado), \
						SUM(dn.ieps_trasladado), \
						(dn.tasa_ieps_trasladado) \
                  from notascredgasto n, dnotascredgasto dn, gastos g, referenciasaux ra \
                  where \
                        n.gasto=g.referencia and \
                        n.fechanot<='%s' and \
                        n.cancelado=0 and \
                        g.cancelado=0 and \
                        ra.gasto=g.referencia and \
                        n.referencia=dn.referencia \
                  group by \
                        g.referencia, \
                        dn.claveprodserv", fecha_saldos);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into gastosaux \
                  select \
                        g.referencia, \
                        ra.saldo, \
                        ra.cargos, \
                        %s \
                        if (ra.saldo<ra.cargos, ra.saldo, ra.cargos) as saldodecargos, \
                        sum((dg.costoimp-ifnull(dn.costoimp,0)) ) as totaltodo, \
						SUM(dg.isr_retenido)-ifnull(dn.isr_retenido,0), \
						(dg.tasa_isr_retenido-ifnull(dn.tasa_isr_retenido,0)), \
						SUM(dg.iva_retenido)-ifnull(dn.iva_retenido,0), \
						(dg.tasa_iva_retenido-ifnull(dn.tasa_iva_retenido,0)), \
						SUM(dg.ieps_retenido)-ifnull(dn.ieps_retenido,0), \
						(dg.tasa_ieps_retenido-ifnull(dn.tasa_ieps_retenido,0)), \
						SUM(dg.iva_trasladado)-ifnull(dn.iva_trasladado,0), \
						(dg.tasa_iva_trasladado-ifnull(dn.tasa_iva_trasladado,0)), \
						SUM(dg.ieps_trasladado)-ifnull(dn.ieps_trasladado,0), \
						(dg.tasa_ieps_trasladado-ifnull(dn.tasa_ieps_trasladado,0)) \
                  from gastos g \
                        inner join dgastos dg ON g.referencia=dg.referencia \
                        inner join referenciasaux ra ON g.referencia=ra.gasto \
                        left join dnotascredgastosaux dn on dn.claveprodserv=dg.claveprodserv and dn.gasto=g.referencia \
                  group by g.referencia \
                  order by g.referencia", condicion_uuid);
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {

			if (agrupaxcliente) {
				instruccion.sprintf("SELECT \
							  '' AS referencia, \
                              '' AS sucursal, \
                              '' AS fechagas, \
                              '' AS factura, \
                    '' AS uuid, \
                              p.razonsocial as rsocial, \
                              sum(ga.saldo) as saldo, \
                    0 AS cargos, \
                              sum(ga.isr_retenido) AS isr_retenido, \
							  (ga.tasa_isr_retenido) AS tasa_isr_retenido, \
                              sum(ga.iva_retenido) AS iva_retenido, \
							  (ga.tasa_iva_retenido) AS tasa_iva_retenido, \
                              sum(ga.ieps_retenido) AS ieps_retenido, \
							  (ga.tasa_ieps_retenido) AS tasa_ieps_retenido, \
                              sum(ga.iva_trasladado) AS iva_trasladado, \
							  (ga.tasa_iva_trasladado) AS tasa_iva_trasladado, \
                              sum(ga.ieps_trasladado) AS ieps_trasladado, \
                              (ga.tasa_ieps_trasladado) AS tasa_ieps_trasladado \
						from gastosaux ga, gastos g, proveedores p \
                        where \
                              ga.referencia=g.referencia and \
                              g.proveedor=p.proveedor \
                        group by g.proveedor order by p.razonsocial");
			}
			else {
				instruccion.sprintf("SELECT \
							  g.referencia, \
							  g.sucursal, \
                              g.fechagas, \
                              g.folioprov as factura, \
                              %s \
                              p.razonsocial as rsocial, \
                              ga.saldo, \
                              ga.cargos, \
                              ga.isr_retenido, \
                              ga.tasa_isr_retenido, \
                              ga.iva_retenido, \
                              ga.tasa_iva_retenido, \
                              ga.ieps_retenido, \
                              ga.tasa_ieps_retenido, \
                              ga.iva_trasladado, \
                              ga.tasa_iva_trasladado, \
                              ga.ieps_trasladado, \
                              ga.tasa_ieps_trasladado \
						from gastosaux ga \
						INNER JOIN gastos g ON ga.referencia=g.referencia \
						INNER JOIN proveedores p ON g.proveedor=p.proveedor \
						INNER JOIN terminales ter on ter.terminal = g.terminal \
						INNER JOIN secciones sec on sec.seccion = ter.seccion \
						INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
						order by suc.numid, g.referencia ", condicion_uuid);
			}
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPNOTCREDPGASTO_X_NOTA
void ServidorReportes::EjecutaRepNotcredGastosXNota
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fecha_inicial, fecha_final, tipo, canceladas,
		condicion_fechas_canceladas;
	AnsiString tipo_canceladas, fecha_inicial_gastos, fecha_final_gastos,
		partesrelacion;
	AnsiString condicion_tipo = " ", condicion_canceladas = " ";
	AnsiString proveedor, condicion_proveedor = " ";
   	AnsiString empresa, condicion_empresa = " ";
	AnsiString sucursal, condicion_sucursal = " ",
		condicion_partesrelacion = " ";

	fecha_inicial = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa= mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_inicial_gastos =
		mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final_gastos =
		mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	canceladas = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	partesrelacion = mFg.ExtraeStringDeBuffer(&parametros);

	//Si se envía el parametro sucursal, es lógico pensar que la empresa coincide en la base de datos
	if (sucursal != " ") {
		condicion_sucursal.sprintf("sec.sucursal='%s' and ", sucursal);
	} else if (empresa != " ") {
		condicion_empresa.sprintf("suc.idempresa=%s and ", empresa);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf("g.proveedor='%s' and ", proveedor);
	}

	if (tipo != " ") {
		condicion_tipo.sprintf("n.tipo='%s' and ", tipo);
	}

	// condiciones cancelaciones
	if (canceladas != " ") {
		condicion_canceladas.sprintf("n.cancelado=%s and ", canceladas);
		if (canceladas == "1") {
			if (tipo_canceladas == "0") {
				condicion_fechas_canceladas.sprintf
					("n.fechamodi>='%s' and n.fechamodi<='%s' and ",
					fecha_inicial, fecha_final);
			}
			else {
				condicion_fechas_canceladas.sprintf
					("n.fechanot>='%s' and n.fechanot<='%s' and ",
					fecha_inicial, fecha_final);
			}
		}
		else {
			condicion_fechas_canceladas.sprintf
				("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
				fecha_final);
		}
	}
	else {
		condicion_fechas_canceladas.sprintf
			("n.fechanot>='%s' and n.fechanot<='%s' and ", fecha_inicial,
			fecha_final);
	}

	if (partesrelacion != " ") {
		condicion_partesrelacion.sprintf("pro.esparterelac='%s' and ",
			partesrelacion);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
	instruccion.sprintf("SELECT \
		n.referencia, \
		n.muuid, \
		n.folioprov AS nota, \
		if(n.tipo=0, 'DEVOL', if(n.tipo=1, 'BONIF', 'DESCU')) AS tipodescrito, \
		g.folioprov AS factura, \
		n.fechanot AS fecha, \
		pro.razonsocial, \
		SUM(dn.costoimp) AS total, \
		SUM(dn.costo) AS subtotal, \
		SUM(dn.isr_retenido) AS isr_retenido, \
		SUM(dn.tasa_isr_retenido) AS tasa_isr_retenido, \
		SUM(dn.iva_retenido) AS iva_retenido, \
		SUM(dn.tasa_iva_retenido) AS tasa_iva_retenido, \
		SUM(dn.ieps_retenido) AS ieps_retenido, \
		SUM(dn.tasa_ieps_retenido) AS tasa_ieps_retenido, \
		SUM(dn.iva_trasladado) AS iva_trasladado, \
		SUM(dn.tasa_iva_trasladado) AS tasa_iva_trasladado, \
		SUM(dn.ieps_trasladado) AS ieps_trasladado, \
		SUM(dn.tasa_ieps_trasladado) AS tasa_ieps_trasladado, \
	   ((SUM(dn.costo)*i.porcentaje)/100) \
	FROM notascredgasto n \
	INNER JOIN dnotascredgasto dn ON n.referencia=dn.referencia \
	INNER JOIN gastos g ON g.referencia=n.gasto AND g.referencia=n.gasto \
	INNER JOIN proveedores pro ON g.proveedor=pro.proveedor \
	INNER JOIN terminales ter ON ter.terminal=g.terminal \
	INNER JOIN secciones sec ON ter.seccion=sec.seccion \
    INNER JOIN sucursales suc on sec.sucursal = suc.sucursal\
	LEFT JOIN impuestos i ON i.impuesto = n.impuestoret \
	WHERE %s %s %s %s %s %s %s \
		n.cancelado=0 \
		AND g.fechagas>='%s' \
		AND g.fechagas<='%s' \
		GROUP BY n.referencia \
	ORDER BY n.referencia", condicion_empresa, condicion_sucursal, condicion_tipo,
		condicion_canceladas, condicion_fechas_canceladas, condicion_proveedor,
		condicion_partesrelacion, fecha_inicial_gastos, fecha_final_gastos);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REG_MODCFDICOM
void ServidorReportes::EjecutarRegModCFDICom(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString usuario, condicion_usuario = " ", fechaini, fechafin,
		condicion_fecha = " ", tipo, condicion_tipo = " ", between = " ";
	AnsiString condicion_empresa=" ";
    AnsiString idempresa;


	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	fechaini = mFg.ExtraeStringDeBuffer(&parametros);
	fechafin = mFg.ExtraeStringDeBuffer(&parametros);
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	idempresa = mFg.ExtraeStringDeBuffer(&parametros);

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND bc.usuario='%s' ", usuario);
	}

	if (fechaini != " ") {
		if (mFg.StrToMySqlDate(fechafin) + 30 < mFg.StrToMySqlDate(fechaini)) {
			condicion_fecha.sprintf
				(" AND bc.fechaalta > DATE_ADD('%s', INTERVAL -6 MONTH) ",
				mFg.StrToMySqlDate(fechaini));
		}
		else {
			condicion_fecha.sprintf(" AND bc.fechaalta between '%s' and '%s' ",
				mFg.StrToMySqlDate(fechaini), mFg.StrToMySqlDate(fechafin));
		}
	}
	if (tipo != " ") {
		condicion_tipo.sprintf(" AND bc.tipo='%s' ", tipo);
	}
	if(idempresa!=" "){
		condicion_empresa.sprintf("AND suc.idempresa = %s ", idempresa);
	}

	/*** asi es como estaba
	 if(bc.tipo='M', 'Modificación', 'Alta') AS tipo,
	 < DATE_ADD(CURDATE(), INTERVAL -1 YEAR)
	 ** */
	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
	instruccion.sprintf("SELECT bc.referencia AS compra, \
	CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario, \
	bc.fechaalta, \
	bc.horaalta, \
	(CASE WHEN bc.tipo='M' THEN 'Modificación' WHEN bc.tipo='A' THEN 'Alta' WHEN bc.tipo='UA' THEN 'Alta UUID' WHEN bc.tipo='UM' THEN 'Modificación UUID' ELSE 'Desconocido' END) AS tipo, \
	bc.fechaini, \
	bc.horaini,  \
	bc.numregistrosantes, \
	bc.numregistrosdespues \
	FROM bitacoracomprasmoduuid bc \
	INNER JOIN empleados e ON e.empleado = bc.usuario \
	INNER JOIN compras c ON c.referencia = bc.referencia \
	INNER JOIN terminales t ON t.terminal = c.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
	WHERE 1 %s  %s  %s %s  \
	ORDER BY fechaalta, horaalta DESC", condicion_usuario, condicion_fecha,
		condicion_tipo, condicion_empresa);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------

// ID_EJE_REPVENTAS_KITS
void ServidorReportes::EjecutaRepVentasKits(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString campos_base, instruccion, consulta, instrucciones[1000];
	int i;
	AnsiString fecha_inicial, fecha_final, producto;
	AnsiString desglosar_clientes;
	AnsiString cliente, condicion_cliente = " ", tipo_nombre;
	AnsiString sucursal, condicion_sucursal = " ";
	AnsiString join_clientes = " ";
	AnsiString kit = "", condicion_kit = " ";
	AnsiString agrupamiento = "";
	AnsiString condicion_tipo_nombre = " ";
	AnsiString condicion_producto = " ";
	AnsiString modificado = "", condicionModificado = " ";
	AnsiString desglosado = "", condicionDesglosado = " ";

	try {
		fecha_inicial =
			mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		cliente = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_nombre = mFg.ExtraeStringDeBuffer(&parametros);
		kit = mFg.ExtraeStringDeBuffer(&parametros);
		desglosado = mFg.ExtraeStringDeBuffer(&parametros);
		modificado = mFg.ExtraeStringDeBuffer(&parametros);

		if (sucursal != " ") {
			condicion_sucursal.sprintf("and sec.sucursal='%s' ", sucursal);
		}
		if (tipo_nombre == "1") {
			condicion_tipo_nombre =
				"if(cli.tipoempre=0,concat(cli.appat,' ',cli.apmat,' ',cli.nombre),cli.rsocial)";
		}
		else {
			condicion_tipo_nombre = "cli.rsocial";
		}

		campos_base.sprintf(" %s AS nombrecliente, cli.rfc, cli.calle, v.referencia, \
					  v.foliofisic, col.nombre as nomcolonia, \
					  cli.curp, loc.nombre as nomloc, mun.nombre as nommunicipio, \
					  est.nombre as nomestado, cli.cp, ",
			condicion_tipo_nombre);
		if (cliente != " ") {
			condicion_cliente.sprintf("and v.cliente='%s' ", cliente);
		}
		if (producto != " ") {
			condicion_producto.sprintf("and a.producto='%s' ", producto);
		}
		// condicion kit
		if (kit != " ") {
			condicion_kit = " and k.kit='" + kit + "' ";
		}
		else {
			condicion_kit = " ";
		}
		// Desglosado
		if (desglosado == "1") {
			condicionDesglosado = "and vk.desglosado=1 ";
		}
		// Modificado
		if (modificado == "1") {
			condicionModificado = "and vk.modificado=1 ";
		}

		agrupamiento = " GROUP BY dvk.venta,dvk.kit";

		instruccion = "SET SESSION sql_log_bin = 0";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("set @fechainicial='%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("SELECT vk.venta,v.fechavta,cli.cliente,\
				%s AS nombrecliente, vk.kit, k.nombre,\
				SUM(dvk.precio) AS precio,vk.cantidad, SUM(dvk.precio*dvk.cantidad) AS importe,vk.desglosado,vk.modificado \
				FROM dventaskits dvk \
				INNER JOIN kits k ON k.kit=dvk.kit \
				INNER JOIN ventaskits vk ON vk.venta=dvk.venta and vk.kit=dvk.kit \
				INNER JOIN ventas v ON v.referencia=vk.venta \
				LEFT JOIN clientes cli ON cli.cliente=v.cliente \
				INNER JOIN terminales t ON t.terminal=v.terminal \
				INNER JOIN secciones sec ON sec.seccion=t.seccion \
				INNER JOIN articulos a ON a.articulo=dvk.articulo \
				WHERE v.fechavta BETWEEN @fechainicial AND @fechafinal and v.cancelado=0 \
				%s \
				%s \
				%s \
				%s \
				%s \
				%s", condicion_tipo_nombre, condicion_kit, condicion_sucursal,
			condicion_cliente, condicionDesglosado, condicionModificado,
			agrupamiento);

		instruccion = "SET SESSION sql_log_bin = 1";
		instrucciones[num_instrucciones++] = instruccion;

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ------------------------------------------------------------------------------
// ID_EJE_REPART_SIN_EXIST_PED_REMOTOS
void ServidorReportes::EjecutaRepArtSinExistPedRemoto
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString fecha_ini, fecha_fin, sucursal, embarque, pedido;
	AnsiString producto, cliente, usuario, modo_agrupar, modo_ordenar;
	AnsiString condicion_sucursal = " ", condicion_embarque = " ",
		condicion_pedido = " ";
	AnsiString condicion_producto = " ", condicion_cliente = " ";
	AnsiString condicion_usuario = " ", condicion_modo_agrupar = " ";

	AnsiString agrupar = " ", ordenar = " ";

	AnsiString campos =
		" dps.cantidad, \ dps.precio*dps.cantidad AS subtotal, \ dps.precioimp*dps.cantidad AS total, \ ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	modo_agrupar = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	modo_ordenar = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND dapse.sucursalsolicita = '%s' ",
			sucursal);
	}

	if (producto != " ") {
		condicion_producto.sprintf(" AND prod.producto = '%s' ", producto);
	}

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND dapse.usuario_remoto = '%s' ", usuario);
	}

	if (modo_agrupar == "1") {
		// campos=" SUM(dps.cantidad) AS cantidad, \ SUM(dps.precio*dps.cantidad) AS subtotal, \ SUM(dps.precioimp*dps.cantidad) AS total, \ ";
		agrupar.sprintf(" GROUP BY articulo ");
	}
	else if (modo_agrupar == "2") {
		// campos=" SUM(dps.cantidad) AS cantidad, \ SUM(dps.precio*dps.cantidad) AS subtotal, \ SUM(dps.precioimp*dps.cantidad) AS total, \ ";
		agrupar.sprintf(" GROUP BY usuario");
	}

	if (modo_ordenar == "1") {
		ordenar.sprintf(" Order BY articulo ");
	}
	else if (modo_ordenar == "2") {
		ordenar.sprintf(" order BY usuario");
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("SELECT dapse.articulo_local AS articulo,\
	prod.nombre, a.producto, 	a.present,  dapse.existencias_local,  \
	 dapse.existencias_remoto, dapse.cantidad_calculada,  dapse.cantidad_pedida,\
	CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat) AS usuario, 	dapse.fechamodi, 	dapse.horamodi , \
	concat(dapse.sucursalsolicita,' ', ss.nombre) AS suclocal, concat(dapse.sucursalremota,' ', sr.nombre) AS sucremota \
	FROM darticulospedidossinexistencia dapse \
	left JOIN empleados emp ON emp.empleado = dapse.usuario  \
	left JOIN articulos a ON a.articulo = dapse.articulo_local  \
	left JOIN productos prod ON prod.producto = a.producto  \
	left JOIN presentaciones p ON p.producto =a.producto AND p.present = a.present \
	LEFT JOIN secciones ss ON ss.sucursal =	dapse.sucursalsolicita \
	LEFT JOIN sucremotas sr ON sr.sucursal = dapse.sucursalremota  \
	WHERE dapse.fechamodi BETWEEN '%s' AND '%s' \
	%s \
	%s \
	%s \
	%s \
	%s ", fecha_ini, fecha_fin, condicion_sucursal, condicion_producto,
		condicion_usuario, agrupar, ordenar);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPBITACORAPINPADS
void ServidorReportes::EjecutaBitaConfigPinpad(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	// CONSULTA TERMINAL
	AnsiString instruccion;

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	// Obtiene todos los datos de la terminal
	instruccion.sprintf("SELECT ip, puerto, timeout, llave, negocio1, terminal1, negocio2, terminal2, puertocom, \
	cashback, contatactless, socketip, socketport, http_address, http_port, dcs_form, \
	CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS usuariomodi, fechamodi, horamodi \
	FROM bitacoraconfigpinpads \ b \
	INNER JOIN empleados e ON e.empleado = b.usuariomodi");
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPBITACORATRNXVENTAS
void ServidorReportes::EjecutaBitaTrnxVentas(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	// CONSULTA TERMINAL
	AnsiString instruccion;

	int rangoHora = 0, incluyeMensajes = 0;
	AnsiString fechaIni, fechaFin;
	AnsiString horaIni, horaFin;
	AnsiString sucursal, terminal, codigo, moperativas;

	AnsiString condicion_hora = " ", condicion_sucursal = " ",
		condicion_terminal = " ", condicion_mensajes = " ", condicion_codigo =
		" ", condicion_operativas = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	rangoHora = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	incluyeMensajes = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	codigo = mFg.ExtraeStringDeBuffer(&parametros);
	moperativas = mFg.ExtraeStringDeBuffer(&parametros);

	if (rangoHora == 1) {
		condicion_hora.sprintf(" AND hora_trn BETWEEN '%s' AND '%s' ", horaIni,
			horaFin);
	}

	if (incluyeMensajes == 0) {
		condicion_mensajes = " trn_msg_host NOT IN ( \
	'Armando trama', '','La reimpresión automática no se generó.',  \
	'Se supero el tiempo límite de respuesta, si la pinpad no responde, reiniciarla.',    \
	 'Error en la comunicación con la Pinpad intenta nuevamente o reinicia la Pinpad, si el problema persiste reportar a sistemas.',\
	 'Armando trama de Cancelacion'  	) AND ";
	}

	if (sucursal != "") {
		condicion_sucursal.sprintf(" AND sucursal = '%s' ", sucursal);
	}
	if (terminal != "") {
		condicion_terminal.sprintf(" AND terminal = '%s' ", terminal);
	}

	if (codigo != "") {
		condicion_codigo.sprintf(" AND trn_internal_respcode = '%s' ", codigo);
	}

	if (moperativas == 0) {
		// ,c.operativa  \	LEFT JOIN  codigoserrorpinpad c on b.trn_internal_respcode = c.codigorespuesta and b.trn_msg_host = c.mesajerespuesta \
		condicion_operativas = " AND c.operativa = 0 ";
	}
	else {
		condicion_operativas = " ";
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	// Obtiene todos los datos de la terminal
	instruccion.sprintf("SELECT \
	IF(dcs_form = 'T060S000', 'VENTA', IF(dcs_form='PRINT', 'REIMPRESIÓN', IF(dcs_form='T040S000', 'DEVOLUCIÓN', IF(dcs_form='T120S001', 'AJUSTE', IF(dcs_form='T120S000', 'CANCELACIÓN', IF(dcs_form='PRINT060', 'REIMP. X REF.', 'BITÁCORA')))))) AS trn_tipo, \
	trn_referencia_1, trn_msg_host, IF(trn_fe = 1, 'Firmado Electrónicamente', IF(trn_fe = '', '', 'Sin firma electrónica' )) AS tar_fe, \
	trn_amount, trn_qty_pay, trn_id, \
	trn_auth_code, trn_internal_respcode, mer_legend1, mer_legend2, \
	mer_legend3, trn_internal_mer_id, trn_internal_ter_id, trn_host_date, \
	trn_host_hour, \
	trn_cur_id1, trn_external_mer_id, \
	trn_external_ter_id, \
	IF(trn_pre_type = 1, 'Tarjeta Crédito', IF(trn_pre_type = 2, 'Tarjeta Debito', '')) AS tipo_tar, \
	IF(trn_input_mode = 1, 'Deslizada', \
	IF(trn_input_mode = 2, 'Digitada en el pinpad', IF(trn_input_mode = 7, 'Insertada o Chip', ''))) AS tar_lectura, \
	trn_relacionada, sucursal, terminal \
	FROM bitacoratransaccionesventas b \
	WHERE %s fecha_trn BETWEEN '%s' AND '%s' %s %s %s %s %s",
		condicion_mensajes, fechaIni, fechaFin, condicion_hora,
		condicion_sucursal, condicion_terminal, condicion_codigo,
		condicion_operativas);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPTRNXVENTAS
void ServidorReportes::EjecutaTrnxVentas(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	// CONSULTA TERMINAL
	AnsiString instruccion;

	AnsiString fechaIni, fechaFin, tipoTarjeta, tipoTrn, firmaElectr, tipoLect;
	AnsiString sucursal, terminal, venta, NumSeguimiento, codAuth;
	AnsiString horaIni, horaFin;

	int rangoHora = 0;

	AnsiString condicion_tipoTarjeta = " ", condicion_tipoTrn = " ";
	AnsiString condicion_firmaElectr = " ", condicion_tipoLect = " ";
	AnsiString condicion_sucursal = " ", condicion_terminal = " ";
	AnsiString condicion_venta = " ", condicion_NumSeguimiento = " ";
	AnsiString condicion_codAuth = " ", condicion_hora = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	tipoTarjeta = mFg.ExtraeStringDeBuffer(&parametros);
	tipoTrn = mFg.ExtraeStringDeBuffer(&parametros);
	firmaElectr = mFg.ExtraeStringDeBuffer(&parametros);
	tipoLect = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	venta = mFg.ExtraeStringDeBuffer(&parametros);
	NumSeguimiento = mFg.ExtraeStringDeBuffer(&parametros);
	codAuth = mFg.ExtraeStringDeBuffer(&parametros);
	rangoHora = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);

	if (tipoTarjeta != " ") {
		condicion_tipoTarjeta.sprintf(" AND dtrnv.trn_pre_type = %s ",
			tipoTarjeta);
	}

	if (tipoTrn != " ") {
		condicion_tipoTrn.sprintf(" AND dtrnv.dcs_form = '%s' ", tipoTrn);
	}

	if (firmaElectr != " ") {
		condicion_firmaElectr.sprintf(" AND dtrnv.trn_fe = %s ", firmaElectr);
	}

	if (tipoLect != " ") {
		condicion_tipoLect.sprintf(" AND dtrnv.trn_input_mode = %s ", tipoLect);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND dtrnv.sucursal = '%s' ", sucursal);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND dtrnv.terminal = '%s' ", terminal);
	}

	if (venta != " ") {
		condicion_venta.sprintf(" AND v.referencia = '%s' ", venta);
	}

	if (NumSeguimiento != " ") {
		condicion_NumSeguimiento.sprintf(" AND dtrnv.trn_id = %s ",
			NumSeguimiento);
	}

	if (codAuth != " ") {
		condicion_codAuth.sprintf(" AND dtrnv.trn_auth_code = %s ", codAuth);
	}

	if (rangoHora == 1) {
		condicion_hora.sprintf
			(" AND dtrnv.trn_host_hour BETWEEN '%s' AND '%s' ", horaIni,
		horaFin);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT * FROM ((SELECT \
	v.referencia, \
	suc.nombre, \
	dtrnv.terminal, \
	UPPER(tt.descripcion) AS trn_tipo, \
	dtrnv.trn_amount, \
	dtrnv.trn_id, \
	dtrnv.trn_auth_code, \
	IF(dtrnv.trn_pre_type = 1, 'Tarjeta Crédito', 'Tarjeta Debito') AS tipo_tar, \
	IF(dtrnv.trn_input_mode = 1, 'Deslizada', \
	IF(dtrnv.trn_input_mode = 2, 'Digitada en el pinpad', 'Insertada o Chip')) AS tar_lectura, \
	IF(dtrnv.trn_fe = 1, 'Firmado Electrónicamente', 'Sin firma electrónica') AS tar_fe, \
	dtrnv.trn_host_date, \
	dtrnv.trn_host_hour, \
	dtrnv.trn_relacionada, \
	CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat), \
	trn_referencia_1, \
	dtrnv.trn_fechaTrans \
	FROM ventas v \
	INNER JOIN dventasfpago dvfp ON dvfp.referencia = v.referencia \
	INNER JOIN dettrnxventa dtrnv ON dtrnv.trn_id = dvfp.trn_id \
	INNER JOIN sucursales suc ON suc.sucursal = dtrnv.sucursal \
	INNER JOIN empleados e ON e.empleado = dtrnv. usu_trn \
	INNER JOIN tipostransacciones tt ON tt.dcs_form = dtrnv.dcs_form \
	WHERE v.fechavta BETWEEN '%s' AND '%s' AND v.fechamodi BETWEEN '%s' AND '%s' AND v.cancelado = 0 \
	%s %s %s %s %s %s %s %s %s %s \
	ORDER BY dtrnv.trn_fechaTrans ASC \
	)UNION ALL( \
	SELECT \
	v.referencia, \
	suc.nombre, \
	dtrnv.terminal, \
	UPPER(tt.descripcion) AS trn_tipo, \
	dtrnv.trn_amount*-1, \
	dtrnv.trn_id, \
	dtrnv.trn_auth_code, \
	IF(dtrnv.trn_pre_type = 1, 'Tarjeta Crédito', 'Tarjeta Debito') AS tipo_tar, \
	IF(dtrnv.trn_input_mode = 1, 'Deslizada', IF(dtrnv.trn_input_mode = 2, 'Digitada en el pinpad', 'Insertada o Chip')) AS tar_lectura, \
	IF(dtrnv.trn_fe = 1, 'Firmado Electrónicamente', 'Sin firma electrónica') AS tar_fe, \
	dtrnv.trn_host_date, \
	dtrnv.trn_host_hour, \
	dtrnv.trn_relacionada, \
	CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat), \
	dtrnv.trn_referencia_1, \
	dtrnv.trn_fechaTrans \
	FROM ventas v \
	INNER JOIN dventasfpago dvfp ON dvfp.referencia = v.referencia \
	INNER JOIN dettrnxventa dtrnv2 ON dtrnv2.trn_id = dvfp.trn_id \
	INNER JOIN dettrnxventa dtrnv ON dtrnv.trn_relacionada = dtrnv2.trn_id \
	INNER JOIN sucursales suc ON suc.sucursal = dtrnv.sucursal \
	INNER JOIN empleados e ON e.empleado = dtrnv.usu_trn \
	INNER JOIN tipostransacciones tt ON tt.dcs_form = dtrnv.dcs_form \
	WHERE dtrnv.fecha_trn BETWEEN '%s' AND '%s' AND v.fechamodi BETWEEN '%s' AND '%s' AND v.cancelado = 1 \
	%s %s %s %s %s %s %s %s %s %s \
	ORDER BY dtrnv.trn_fechaTrans ASC )) t \
	ORDER BY t.trn_fechaTrans ASC", fechaIni, fechaFin, fechaIni, fechaFin,
		condicion_tipoTarjeta, condicion_tipoTrn, condicion_firmaElectr,
		condicion_tipoLect, condicion_sucursal, condicion_terminal,
		condicion_venta, condicion_NumSeguimiento, condicion_codAuth,
		condicion_hora,

		fechaIni, fechaFin, fechaIni, fechaFin, condicion_tipoTarjeta,
		condicion_tipoTrn, condicion_firmaElectr, condicion_tipoLect,
		condicion_sucursal, condicion_terminal, condicion_venta,
		condicion_NumSeguimiento, condicion_codAuth, condicion_hora);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT \
	UPPER(tt.descripcion) AS trn_tipo, \
	SUM(IF(tt.dcs_form = 'T060S000' || tt.dcs_form = 'T120S001', dtrnv.trn_amount, (dtrnv.trn_amount*-1))) AS total \
	FROM ventas v \
	INNER JOIN dventasfpago dvfp ON dvfp.referencia = v.referencia \
	INNER JOIN dettrnxventa dtrnv ON dtrnv.trn_id = dvfp.trn_id \
	INNER JOIN tipostransacciones tt ON tt.dcs_form = dtrnv.dcs_form \
	WHERE dtrnv.fecha_trn BETWEEN '%s' AND '%s' AND v.fechamodi BETWEEN '%s' AND '%s' AND v.cancelado = 0 \
	%s %s %s %s %s %s %s %s %s %s \
	GROUP BY dtrnv.dcs_form \
	ORDER BY trn_tipo DESC ", fechaIni, fechaFin, fechaIni, fechaFin,
		condicion_tipoTarjeta, condicion_tipoTrn, condicion_firmaElectr,
		condicion_tipoLect, condicion_sucursal, condicion_terminal,
		condicion_venta, condicion_NumSeguimiento, condicion_codAuth,
		condicion_hora);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_INFO_REIMPR_TRN
void ServidorReportes::EjecutaInfoReimpreTrn(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	// CONSULTA TERMINAL
	AnsiString instruccion;

	AnsiString numer_seguimiento, referencia_trn;
	AnsiString condicion_busqueda = " ";

	numer_seguimiento = mFg.ExtraeStringDeBuffer(&parametros);
	referencia_trn = mFg.ExtraeStringDeBuffer(&parametros);

	if (numer_seguimiento != " ") {
		condicion_busqueda.sprintf(" trn_id = '%s' ", numer_seguimiento);
	}

	if (referencia_trn != " ") {
		condicion_busqueda.sprintf(" trn_referencia_1 = '%s' ", referencia_trn);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	// Obtiene todos los datos de la terminal
	instruccion.sprintf("SELECT UPPER(tt.descripcion) AS tipoimpresion, \
    det.trn_AID AS aid, \
	det.trn_aco_id AS aco, \
	det.trn_auth_code AS auth_code, \
	lpad(det.trn_id,9,'0') AS id, \
	det.mer_legend1 AS nomnegocio, \
	det.mer_legend2 AS dirnegocio, \
	det.mer_legend3 AS ciudnegocio, \
	det.trn_external_mer_id AS negocio, \
	det.trn_external_ter_id AS termnegocio, \
	det.trn_host_date AS fecha, \
	det.trn_host_hour AS hora, \
	det.trn_amount AS monto, \
	det.trn_pro_name AS proname, \
	det.trn_fii, \
	IF(det.trn_qty_pay=1, 'COMPRA NORMAL', CONCAT(det.trn_qty_pay, ' MESES SIN INTERESES')) AS tipocompra, \
	IF(det.trn_fii!='', -1, IF(det.trn_fe=1, 1, 0)) AS tipofirma, \
	det.trn_internal_ter_id AS trnterminal \
	FROM dettrnxventa det \
	INNER JOIN tipostransacciones tt ON tt.dcs_form = det.dcs_form \
	WHERE %s ", condicion_busqueda);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCARTPORTXEMBARQUE
void ServidorReportes::EjecutaRepCartPortXEmbarque(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[1000];
	int i;
	AnsiString sucursal, embarque;

	try {

		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		embarque = mFg.ExtraeStringDeBuffer(&parametros);

		// Crea variables tamporales
		instruccion.sprintf
			("set  @Sucursal=CONVERT('%s' USING latin1), @Embarque=CONVERT('%s' USING latin1) ",
			sucursal, embarque);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SELECT t.embarque,t.pedido,t.venta,t.factura,t.cliente,t.cyndest,t.coloniadest,t.locdest,t.mundest,t.codposdest,t.peso,t.valor,t.refcp20,t.serfolcp,t.muuidcp ,t.cp20cancelada, t.tipo  FROM ( \
				(SELECT v.embarque,pv.referencia AS pedido,v.referencia AS venta,cfdv.seriefolio AS factura,COALESCE(c.rsocial,CONCAT(c.nombre,' ',c.appat,' ',c.apmat)) AS cliente, \
				CONCAT(vd.calle,' ',vd.numext,' ',vd.numint) AS cyndest ,col.nombre AS coloniadest,loc.nombre AS locdest, mun.nombre as mundest,vd.cp AS codposdest,SUM(a.peso*dv.cantidad) AS peso ,   \
				v.valor,IFNULL(MAX(cp20.cartaporte20 COLLATE LATIN1_SWEDISH_CI),'') as refcp20,ifnull(cfdcp.seriefolio,'') AS serfolcp ,ifnull(cfdcp.muuid,'') as muuidcp,ifnull(cp20.cancelada,0) AS cp20cancelada	\
				,'VENTA' AS tipo \
				FROM ventas v   \
				INNER JOIN dventas dv ON dv.referencia=v.referencia \
				INNER JOIN articulos a ON a.articulo=dv.articulo    \
				INNER JOIN terminales t ON t.terminal=v.terminal    \
				INNER JOIN secciones s ON s.seccion=t.seccion   \
				LEFT JOIN pedidosventa pv ON pv.venta=v.referencia  \
				LEFT JOIN cfd cfdv ON cfdv.referencia=v.referencia AND cfdv.tipocomprobante='VENT'  \
				LEFT JOIN clientes c ON v.cliente=c.cliente \
				LEFT JOIN ventadirent vd ON vd.referencia=v.referencia  \
				LEFT JOIN colonias col ON col.colonia=vd.colonia    \
				LEFT JOIN localidades loc ON loc.localidad=col.localidad	\
				LEFT JOIN municipios mun ON mun.municipio=loc.localidad \
				LEFT JOIN cartasporte20 cp20 ON cp20.referencia=v.referencia AND (cp20.cancelada=0 OR cp20.cancelada IS NULL) \
				LEFT JOIN cfd cfdcp ON cfdcp.referencia=cp20.cartaporte20 AND cfdcp.tipocomprobante='CAR2'  \
				WHERE v.embarque=@Embarque AND s.sucursal=@Sucursal AND s.sucursal=@Sucursal AND v.cancelado=0 \
				GROUP BY v.referencia   \
				ORDER BY v.referencia,cp20.fechamod DESC,cp20.horamod DESC)   \
			UNION   \
				(SELECT pv.embarque,pv.referencia AS pedido,'' AS venta,'' AS factura,COALESCE(c.rsocial,CONCAT(c.nombre,' ',c.appat,' ',c.apmat)) AS cliente,  \
				CONCAT(pd.calle,' ',pd.numext,' ',pd.numint) AS cyndest ,col.nombre AS coloniadest,loc.nombre AS locdest, mun.nombre as mundest,pd.cp AS codposdest,SUM(a.peso*dpv.cantidad) AS peso ,	\
				pv.valor,IFNULL(MAX(cp20.cartaporte20 COLLATE LATIN1_SWEDISH_CI),'') as refcp20,ifnull(cfdcp.seriefolio,'') AS serfolcp ,ifnull(cfdcp.muuid,'') as muuidcp,ifnull(cp20.cancelada,0) AS cp20cancelada \
				,'PEDIDO' AS tipo \
				FROM pedidosventa pv    \
				INNER JOIN dpedidosventa dpv ON dpv.referencia=pv.referencia    \
				INNER JOIN articulos a ON a.articulo=dpv.articulo   \
				INNER JOIN terminales t ON t.terminal=pv.terminal   \
				INNER JOIN secciones s ON s.seccion=t.seccion   \
				LEFT JOIN clientes c ON pv.cliente=c.cliente    \
				LEFT JOIN pedidosdirent pd ON pd.referencia=pv.referencia   \
				LEFT JOIN colonias col ON col.colonia=pd.colonia    \
				LEFT JOIN localidades loc ON loc.localidad=col.localidad    \
				LEFT JOIN municipios mun ON mun.municipio=loc.localidad \
				LEFT JOIN cartasporte20 cp20 ON cp20.pedido=pv.referencia AND (cp20.cancelada=0 OR cp20.cancelada IS NULL) \
				LEFT JOIN cfd cfdcp ON cfdcp.referencia=cp20.cartaporte20 AND cfdcp.tipocomprobante='CAR2'  \
				WHERE pv.embarque=@Embarque AND s.sucursal=@Sucursal AND pv.cancelado=0 AND pv.facturado=0 \
				GROUP BY pv.referencia  \
				ORDER BY pv.referencia,cp20.fechamod DESC,cp20.horamod DESC)  \
		) AS t ORDER BY t.venta,t.pedido");

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_CARTAPORTE20
void ServidorReportes::EjecutaRepCartaPorte2(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;

	AnsiString fechaIni, fechaFin, sucursal, terminal, status;
	AnsiString tipoStatus, cliente, proveedor, parteRel, giroNegocio, vendedor;
	AnsiString sector, localidad, usuario, chofer, via, horaIni, horaFin;
	AnsiString tipoNombre, tipoCartaP;

	int rangoHora = 0;

	AnsiString condicion_fechas = " ";
	AnsiString condicion_sucursal = " ";
	AnsiString condicion_terminal = " ";
	AnsiString condicion_status = " ";
	AnsiString condicion_tipoStatus = " ";
	AnsiString condicion_cliente = " ";
	AnsiString condicion_proveedor = " ";
	AnsiString condicion_parteRel = " ";
	AnsiString condicion_giroNegocio = " ";
	AnsiString condicion_vendedor = " ";
	AnsiString condicion_sector = " ";
	AnsiString condicion_localidad = " ";
	AnsiString condicion_usuario = " ";
	AnsiString condicion_chofer = " ";
	AnsiString condicion_via = " ";
	AnsiString condicion_rangoHora = " ";
	AnsiString condicion_tipoNombreV = " ", condicion_tipoNombreP = " ";
	AnsiString condicion_tipoCartaP = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	status = mFg.ExtraeStringDeBuffer(&parametros);
	tipoStatus = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	parteRel = mFg.ExtraeStringDeBuffer(&parametros);
	giroNegocio = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	sector = mFg.ExtraeStringDeBuffer(&parametros);
	localidad = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	chofer = mFg.ExtraeStringDeBuffer(&parametros);
	via = mFg.ExtraeStringDeBuffer(&parametros);
	rangoHora = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	tipoNombre = mFg.ExtraeStringDeBuffer(&parametros);
	tipoCartaP = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND carta20.terminal = '%s' ", terminal);
	}

	if (status != " ") {
		condicion_status.sprintf(" AND carta20.cancelada = %s ", status);
		if (status == "1") {
			if (tipoStatus == "0") {
				condicion_fechas.sprintf
					(" carta20.fechamod BETWEEN '%s' AND '%s' ", fechaIni,
					fechaFin);
			}
			else {
				condicion_fechas.sprintf
					(" carta20.fechacp BETWEEN '%s' AND '%s' ", fechaIni,
					fechaFin);
			}
		}
		else {
			condicion_fechas.sprintf(" carta20.fechacp BETWEEN '%s' AND '%s' ",
				fechaIni, fechaFin);
		}
	}

	if (cliente != " ") {
		condicion_cliente.sprintf
			(" AND (v.cliente = '%s' OR p.cliente = '%s') ", cliente, cliente);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf(" AND pd.proveedor = '%s' ", proveedor);
	}

	if (parteRel != " ") {
		condicion_parteRel.sprintf
			(" AND (clv.esparterelac = '%s' OR clp.esparterelac = '%s') ",
			parteRel, parteRel);
	}

	if (giroNegocio != " ") {
		condicion_giroNegocio.sprintf
			(" AND (clv.giro = '%s' OR clp.giro = '%s') ", giroNegocio,
			giroNegocio);
	}

	if (vendedor != " ") {
		condicion_vendedor.sprintf
			(" AND (v.vendedor = '%s' OR p.vendedor = '%s') ", vendedor,
			vendedor);
	}

	if (sector != " ") {
		condicion_sector.sprintf
			(" AND (colv.sector = '%s' OR colp.sector = '%s') ", sector,
		sector);
	}

	if (localidad != " ") {
		condicion_localidad.sprintf
			(" AND (colv.localidad = '%s' OR colp.localidad = '%s') ",
			localidad, localidad);
	}

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND carta20.usualta = '%s' ", usuario);
	}

	if (chofer != " ") {
		condicion_chofer.sprintf(" AND carta20.chofer = '%s' ", chofer);
	}

	if (via != " ") {
		condicion_via.sprintf(" AND carta20.viaembarq = '%s' ", via);
	}

	if (rangoHora == 1) {
		condicion_rangoHora.sprintf
			(" AND carta20.horacp BETWEEN '%s' AND '%s' ", horaIni, horaFin);
	}
	if (tipoNombre == "1") {
		condicion_tipoNombreV =
			"if(clv.tipoempre=0,concat(clv.appat,' ',clv.apmat,' ',clv.nombre),clv.rsocial)";
		condicion_tipoNombreP =
			"if(clp.tipoempre=0,concat(clp.appat,' ',clp.apmat,' ',clp.nombre),clp.rsocial)";
	}
	else {
		condicion_tipoNombreV = "clv.rsocial";
		condicion_tipoNombreP = "clp.rsocial";
	}

	if (tipoCartaP == "0") {
		condicion_tipoCartaP.sprintf
			(" AND (carta20.referencia IS NOT NULL OR carta20.pedido IS NOT NULL)"
			);
	}
	else if (tipoCartaP == "1") {
		condicion_tipoCartaP.sprintf
			(" AND (carta20.pedidocompra IS NOT NULL OR carta20.referenciacompra IS NOT NULL)"
			);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT \
		carta20.cartaporte20 AS referencia, \
		carta20.embarque, \
		carta20.referencia AS venta, \
		carta20.pedido AS pedido, \
		carta20.pedidocompra, \
		cfd.serie, \
		cfd.folio, \
		cfd.muuid, \
		if(carta20.pedido IS NULL, %s, %s) AS cliente, \
		carta20.fechacp, \
		carta20.horacp, \
		carta20.numtotmerc, \
		carta20.pesobruttotal, \
		carta20.viaembarq, \
		CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) AS usuario, \
		carta20.terminal \
	FROM cartasporte20 carta20 \
	INNER JOIN cfd ON cfd.referencia = carta20.cartaporte20 \
	INNER JOIN cfdxml ON cfdxml.compfiscal = cfd.compfiscal \
	INNER JOIN terminales t ON t.terminal = carta20.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN sucursales suc ON suc.sucursal = s.sucursal \
	INNER JOIN empleados e ON e.empleado = carta20.usualta \
	LEFT JOIN ventas v ON v.referencia = carta20.referencia \
	LEFT JOIN pedidos pd ON pd.referencia = carta20.pedidocompra \
	LEFT JOIN clientes clv ON clv.cliente = v.cliente \
	LEFT JOIN colonias colv ON colv.colonia = clv.colonia \
	LEFT JOIN pedidosventa p ON p.referencia = carta20.pedido \
	LEFT JOIN clientes clp ON clp.cliente = p.cliente \
	LEFT JOIN colonias colp ON colp.colonia = clp.colonia \
	WHERE %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s \
	ORDER BY carta20.cartaporte20 DESC, carta20.fechacp DESC, carta20.horacp DESC "
		, condicion_tipoNombreV, condicion_tipoNombreP, condicion_fechas,
		condicion_sucursal, condicion_terminal, condicion_status,
		condicion_tipoStatus, condicion_cliente, condicion_proveedor,
		condicion_parteRel, condicion_giroNegocio, condicion_vendedor,
		condicion_sector, condicion_localidad, condicion_usuario,
		condicion_chofer, condicion_via, condicion_rangoHora,
		condicion_tipoCartaP);
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPVTAXFACGLOB
void ServidorReportes::EjeRepVtaFacturaGlob(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString sucursal, fechaIni, fechaFin;
	AnsiString condicion_fechas = " ";
	AnsiString condicion_sucursal = " ", condicion_sucursal_vta = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND cfd.sucursal = '%s' ", sucursal);
		condicion_sucursal_vta.sprintf(" AND s.sucursal = '%s' ", sucursal);
	}else{
		condicion_sucursal.sprintf(" AND cfd.sucursal IN ( %s ) ", FormServidor->ObtieneSucursalesEmpAct());
		condicion_sucursal_vta.sprintf(" AND s.sucursal IN ( %s)  ", FormServidor->ObtieneSucursalesEmpAct());
	}

	Instruccion.sprintf("SELECT \
    cfd.referencia, \
    cfd.serie, \
    cfd.folio, \
    cfd.seriefolio, \
    cfd.tipocomprobante, \
    cfd.sucursal, \
    cfd.monto, \
    cfd.fechacancelamin, \
    (v.valor) AS totalcanc \
  FROM cfd  \
    LEFT JOIN ( \
      SELECT vta.fechamodi, SUM(vta.valor) AS valor FROM ventas vta \
      INNER JOIN terminales t ON t.terminal = vta.terminal \
      INNER JOIN secciones s ON s.seccion = t.seccion \
      WHERE vta.cancelado = 1 AND vta.fechamodi BETWEEN '%s' AND '%s' %s \
    ) v ON v.fechamodi = cfd.fechacancelamin \
  WHERE cfd.tipocomprobante = 'TICK' AND cfd.fechaaltamin BETWEEN '%s' AND '%s' %s  \
  GROUP BY cfd.referencia \
  ORDER BY cfd.compfiscal ASC", fechaIni, fechaFin, condicion_sucursal_vta,
		fechaIni, fechaFin, condicion_sucursal);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_BITA_COMPRAS
void ServidorReportes::EjeBitacoraCompras(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString referencia;

	referencia = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("SELECT                 \
						  b.referencia,         \
						  b.foliofactura,       \
						  p.razonsocial,        \
						  e.empleado,           \
						  CONCAT(e.nombre, ' ', e.appat, ' ', e.apmat) As usuario,  \
						  b.fechamodi,         \
						  b.horamodi,          \
						  b.tipo,              \
						  b.uuidantes,         \
						  b.uuiddespues,       \
						  b.fechapagoantes,    \
						  b.fechapagodespues   \
						  FROM bitacoracomprasmoduuid b   \
						  INNER JOIN proveedores p on p.proveedor = b.proveedor  \
						  LEFT JOIN empleados e on e.empleado = b.usuario OR e.empleado = b.usumodi  \
						  LEFT JOIN usuarios u ON u.empleado = b.usuario                             \
						  WHERE b.referencia = '%s'                                         \
						  ORDER BY b.fechamodi DESC , b.horamodi DESC", referencia);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_BITA_APP_RUT
void ServidorReportes::EjeBitacoraAppRutas(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString chofer, tarea, fecha_ini, fecha_fin;
	AnsiString condicion_chofer = " ", condicion_tarea = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	chofer = mFg.ExtraeStringDeBuffer(&parametros);
	tarea = mFg.ExtraeStringDeBuffer(&parametros);

	if (chofer != " ") {
		condicion_chofer.sprintf(" and cho.empleado='%s'", chofer);
	}

	if (tarea != " ") {
		condicion_tarea.sprintf(" and bi.accion='%s'", tarea);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("select bi.usuario as clave, concat(e.nombre, ' ', e.appat, ' ', e.apmat) as vendedor,\
	bi.horaalta, bi.fechaalta , bi.accion as tarea, bi.ip, bi.version_app, bi.tarea \
	from bitacoraapp bi \
	INNER JOIN empleados e ON bi.usuario=e.empleado \
	inner join choferes cho ON e.empleado=cho.empleado \
	where bi.fechaalta between '%s' and '%s' and  tipo='Rutas'  %s %s ",
		fecha_ini, fecha_fin, condicion_chofer, condicion_tarea);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_BITA_APP_INV
void ServidorReportes::EjeBitacoraAppInventarios(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString Instruccion;
	AnsiString usuario, tarea, fecha_ini, fecha_fin;
	AnsiString condicion_usuario = " ", condicion_tarea = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	tarea = mFg.ExtraeStringDeBuffer(&parametros);

	if (usuario != " ") {
		condicion_usuario.sprintf(" and usu.empleado='%s'", usuario);
	}

	if (tarea != " ") {
		condicion_tarea.sprintf(" and bi.accion='%s'", tarea);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	Instruccion.sprintf("select bi.usuario as clave, concat(e.nombre, ' ', e.appat, ' ', e.apmat) as vendedor,\
	bi.horaalta, bi.fechaalta , bi.accion as tarea, bi.ip, bi.version_app, bi.tarea \
	from bitacoraapp bi \
	INNER JOIN empleados e ON bi.usuario=e.empleado \
	inner join usuarios usu ON e.empleado=usu.empleado \
	where bi.fechaalta between '%s' and '%s' and  tipo='Inventario'  %s %s ",
		fecha_ini, fecha_fin, condicion_usuario, condicion_tarea);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCOSTOVENTAS_MIX
void ServidorReportes::EjecutaRepCostoVentasMix(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString fecha_inicial, fecha_final, sucursal, tiporeporte;
	AnsiString fabricante, clasifmaes, clasifgene, clasifespe;
	AnsiString proveedor, producto, vendedor, supervisado, excluirparterel;
	AnsiString idempresa;
	AnsiString condicion_sucursal = " ", condicion_fabricante = " ";
	AnsiString condicion_clasifmaes = " ", condicion_clasifgene = " ";
	AnsiString condicion_clasifespe = " ", condicion_proveedor = " ";
	AnsiString condicion_producto = " ", condicion_vendedor = " ";
	AnsiString condicion_supervisado = " ", condicion_excluirparterel=" ";
    AnsiString condicion_idempresa = " ";
	AnsiString left_supervisado = " ";

	AnsiString instruccion;

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L);

	fecha_inicial 	= mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_final   	= mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	tiporeporte   	= mFg.ExtraeStringDeBuffer(&parametros);
	fabricante 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	clasifmaes 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	clasifgene 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	clasifespe 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	proveedor 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	producto 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	vendedor 	  	= mFg.ExtraeStringDeBuffer(&parametros);
	supervisado   	= mFg.ExtraeStringDeBuffer(&parametros);
	excluirparterel = mFg.ExtraeStringDeBuffer(&parametros);
	idempresa 		= mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
	}

	if (fabricante != " ") {
		condicion_fabricante.sprintf(" AND fab.fabricante = '%s' ", fabricante);
	}

	if (clasifmaes != " ") {
		condicion_clasifmaes.sprintf(" AND clasif1.clasif1 = '%s' ",
		clasifmaes);
	}

	if (clasifgene != " ") {
		condicion_clasifgene.sprintf(" AND clasif2.clasif2 = '%s' ",
		clasifgene);
	}

	if (clasifespe != " ") {
		condicion_clasifespe.sprintf(" AND clasif3.clasif3 = '%s' ",
		clasifespe);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf(" AND prov.proveedor = '%s' ", proveedor);
	}

	if (producto != " ") {
		condicion_producto.sprintf(" AND prod.producto = '%s' ", producto);
	}

	if (vendedor != " ") {
		condicion_vendedor.sprintf(" AND e.empleado = '%s' ", vendedor);
	}

	if (supervisado != " ") {
		left_supervisado.sprintf(" LEFT JOIN articulossupervisados asup ON asup.producto = articulos.producto AND asup.present = articulos.present ");
		condicion_supervisado.sprintf(" AND asup.usuario = '%s' ", supervisado);
	}

	if(excluirparterel == "1"){
		condicion_excluirparterel.sprintf(" AND cli.esparterelac = 0 ");
	}

	if(idempresa != " "){
		condicion_idempresa.sprintf(" AND suc.idempresa = %s ", idempresa);
	}

	if (tiporeporte == "0" || tiporeporte == "3") {
		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "create temporary table auxventasnc \
		(sucursal VARCHAR(2), vendedor VARCHAR(10), producto varchar(8), present varchar(255), subtotventa decimal(16,4), \
		cantidad decimal(16,4), año INT(4), mes INT(2), \
		primary key(sucursal, vendedor, producto, present, año, mes)) Engine = INNODB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////Se guardan las ventas dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO auxventasnc (sucursal, vendedor, producto, present, subtotventa, cantidad, año, mes) \
		SELECT \
			t.sucursal, t.vendedor, t.producto, t.present, SUM(t.subtotventa), SUM(t.cantidad), t.año, t.mes \
		FROM \
			( \
				( \
					SELECT \
						sec.sucursal, v.vendedor, a.producto, a.present, SUM((dv.precio)*(dv.cantidad)) AS subtotventa, SUM(dv.cantidad) AS cantidad, YEAR(v.fechavta) AS año, MONTH(v.fechavta) AS mes \
					FROM \
						ventas v FORCE INDEX(fechavta) \
						INNER JOIN dventas dv ON dv.referencia=v.referencia \
						INNER JOIN articulos a ON a.articulo=dv.articulo \
						INNER JOIN terminales t ON v.terminal=t.terminal \
						INNER JOIN secciones sec ON t.seccion=sec.seccion \
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
						INNER JOIN clientes cli ON cli.cliente = v.cliente \
					WHERE \
						v.fechavta>='%s' \
						AND v.fechavta<='%s' \
						%s \
						%s \
						%s \
						AND v.cancelado=0 \
					GROUP BY YEAR(v.fechavta), MONTH(v.fechavta), sec.sucursal, v.vendedor, a.producto, a.present \
				) UNION ALL ( \
					SELECT \
						sec.sucursal, v.vendedor, a.producto, a.present, SUM(d.precio*d.cantidad*-1) AS subtotventa, SUM(dv.cantidad) AS cantidad, YEAR(n.fechanot) AS año, MONTH(n.fechanot) AS mes \
					FROM \
						notascredcli n INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
						INNER JOIN dventas dv ON dv.referencia  =n.venta AND dv.articulo=d.articulo \
						INNER JOIN articulos a ON d.articulo=a.articulo \
						INNER JOIN ventas v ON n.venta = v.referencia \
						INNER JOIN terminales t ON v.terminal=t.terminal \
						INNER JOIN secciones sec ON t.seccion=sec.seccion \
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
						INNER JOIN clientes cli ON cli.cliente = v.cliente \
					WHERE \
						n.cancelado=0 \
						%s \
						%s \
						AND n.fechanot BETWEEN '%s' AND '%s' \
						%s \
					GROUP BY YEAR(n.fechanot), MONTH(n.fechanot), sec.sucursal, v.vendedor, a.producto, a.present \
				) \
			) t GROUP BY t.año, t.mes, t.sucursal, t.vendedor, t.producto, t.present",
			fecha_inicial, fecha_final, condicion_sucursal, condicion_excluirparterel, condicion_idempresa,

			condicion_excluirparterel, condicion_sucursal, fecha_inicial, fecha_final, condicion_idempresa);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////Tabla temporal, la cual contendrá los valores de los costos
		instruccion = "create temporary table auxventascostonc \
		(sucursal VARCHAR(2), vendedor VARCHAR(10), producto VARCHAR(8), present varchar(255), multmin DECIMAL(16,4), \
		costo decimal(16,4), año INT(4), mes INT(2), \
		PRIMARY key(sucursal, vendedor, producto, present, año, mes)) Engine = INNODB";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO  auxventascostonc (sucursal, vendedor, producto, present, multmin, costo, año, mes) \
		SELECT \
			t.sucursal, t.vendedor, t.producto, t.present, SUM(t.multmin), SUM(t.costo) AS costo, t.año, t.mes \
		FROM \
			( \
				( \
					SELECT \
					sec.sucursal, v.vendedor, pccd.producto, pccd.present, SUM(pccd.cantidad*-1) AS multmin, SUM(pccd.costovta*-1) AS costo, YEAR(v.fechavta) AS año, MONTH(v.fechavta) AS mes \
					FROM ventas v \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia AND pccd.tipo = 'VE' \
					INNER JOIN terminales t ON v.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					WHERE \
					v.fechavta BETWEEN '%s' AND '%s' \
					%s \
					%s \
					%s \
					AND v.cancelado = 0 \
					GROUP BY YEAR(v.fechavta), MONTH(v.fechavta), sec.sucursal, v.vendedor, pccd.producto, pccd.present \
				) UNION ALL ( \
					SELECT \
					sec.sucursal, v.vendedor AS vendedor, pccd.producto, pccd.present, SUM(pccd.cantidad*-1) AS multmin, SUM(pccd.costovta*-1) AS costo, YEAR(nc.fechanot) AS año, MONTH(nc.fechanot) AS mes \
					FROM notascredcli nc \
					INNER JOIN precalculocostosventadet pccd ON pccd.referencia = nc.referencia AND pccd.tipo = 'DV' \
					INNER JOIN terminales t ON nc.terminal=t.terminal \
					INNER JOIN secciones sec ON t.seccion=sec.seccion \
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
					INNER JOIN ventas v ON v.referencia = nc.venta \
					INNER JOIN clientes cli ON cli.cliente = v.cliente \
					WHERE \
					nc.fechanot BETWEEN '%s' AND '%s' \
					%s \
					%s \
					%s \
					AND nc.cancelado = 0 \
					GROUP BY YEAR(nc.fechanot), MONTH(nc.fechanot), sec.sucursal, v.vendedor, pccd.producto, pccd.present \
				) \
			) t GROUP BY t.año, t.mes, t.sucursal, t.vendedor, t.producto, t.present",
			fecha_inicial, fecha_final, condicion_sucursal, condicion_excluirparterel, condicion_idempresa,

			fecha_inicial, fecha_final, condicion_sucursal, condicion_excluirparterel, condicion_idempresa);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));
	}
	if (tiporeporte == "1" || tiporeporte == "3") {
		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "CREATE TEMPORARY TABLE dnotascredprovaux ( \
		compra VARCHAR(11), \
		articulo VARCHAR(9), \
		cantidad DECIMAL(16,3), \
		costo DECIMAL(20,6), \
		costoimp DECIMAL(20,6), \
		INDEX(compra), \
		INDEX(articulo)) ENGINE=InnoDB ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "CREATE TEMPORARY TABLE auximpuestos (impuesto int(2), PRIMARY KEY(impuesto)) Engine = InnoDB ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "INSERT INTO auximpuestos (impuesto) SELECT impuesto FROM impuestos ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion = "CREATE TEMPORARY TABLE auximpuestos5 (orden int(2), impuesto int(2), tipoimpu char(10), porcentaje decimal(5,2), nombre varchar(40), PRIMARY key(impuesto), index(orden), index(tipoimpu)) Engine = InnoDB ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		instruccion.sprintf("INSERT INTO auximpuestos5 (orden, impuesto, tipoimpu, porcentaje, nombre) \
		SELECT i.impuesto AS orden, \
			   i.impuesto AS impuesto, \
			   i.tipoimpu AS tipoimpu, \
			   i.porcentaje AS porcentaje, \
			   t.nombre AS nombre \
		FROM impuestos i, \
			 tiposdeimpuestos t, \
			 auximpuestos aux \
		WHERE i.tipoimpu=t.tipoimpu \
		  AND aux.impuesto=i.impuesto");
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO dnotascredprovaux (compra, articulo, cantidad, costo, costoimp) \
		SELECT c.referencia AS compra, \
			   d.articulo, \
			   SUM(IF(n.tipo='0',d.cantidad,0)) AS cantidad, \
			   SUM(IF(n.tipo<>'0',d.costo,0)) AS costo, \
			   SUM(IF(n.tipo<>'0',d.costoimp,0)) AS costoimp \
		FROM notascredprov n \
		INNER JOIN dnotascredprov d ON n.referencia=d.referencia \
		INNER JOIN compras c ON n.compra=c.referencia \
		INNER JOIN articulos ON d.articulo=articulos.articulo \
		INNER JOIN productos prod ON articulos.producto=prod.producto \
		INNER JOIN terminales ter ON ter.terminal=c.terminal \
		INNER JOIN secciones sec ON ter.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		INNER JOIN proveedores prov ON prov.proveedor=c.proveedor \
		WHERE 1 \
		AND c.fechacom>='%s' \
		  AND c.fechacom<='%s' \
		  AND n.cancelado=0 \
		  AND c.cancelado=0 \
		  AND n.fechanot<='%s' \
		  %s \
		  %s \
		GROUP BY c.referencia, \
				 d.articulo", fecha_inicial, fecha_final, fecha_final,
			condicion_sucursal,
			condicion_idempresa);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));
	}
	if (tiporeporte == "2" || tiporeporte == "3") {
		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventasagentenc ( \
		sucursal VARCHAR(2), \
		vendedor VARCHAR(10), \
		producto VARCHAR(8), \
		present VARCHAR(255), \
		subtotventa DECIMAL(16,4), \
		cantidad DECIMAL(16,4), \
		año INT(4), mes INT(2), \
		PRIMARY KEY(sucursal, vendedor, producto, present, año, mes)) ENGINE = INNODB ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO auxventasagentenc (sucursal, vendedor, producto, present, subtotventa, cantidad, año, mes) \
		SELECT t.sucursal, \
		t.vendedor, \
		t.producto, \
		t.present, \
		SUM(t.subtotventa), \
		sum(t.cantidad), \
		t.año, \
		t.mes \
		FROM ( \
		(SELECT sec.sucursal, v.vendedor, \
		a.producto, \
		a.present, \
		SUM((dv.precio)*(dv.cantidad)) AS subtotventa, \
		sum(dv.cantidad) AS cantidad, \
		YEAR(v.fechavta) AS año, \
		MONTH(v.fechavta) AS mes \
		FROM ventas v \
		FORCE INDEX(fechavta) \
		INNER JOIN dventas dv ON dv.referencia=v.referencia \
		INNER JOIN articulos a ON a.articulo=dv.articulo \
		INNER JOIN terminales t ON v.terminal=t.terminal \
		INNER JOIN secciones sec ON t.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		INNER JOIN clientes cli ON cli.cliente = v.cliente \
		WHERE v.fechavta>='%s' \
		AND v.fechavta<='%s' \
		AND v.cancelado=0 \
		%s \
		%s \
		%s \
		GROUP BY \
			YEAR(v.fechavta), \
			MONTH(v.fechavta), \
			sec.sucursal, \
			v.vendedor, \
			a.producto, \
			a.present) \
		UNION ALL \
		(SELECT sec.sucursal, \
		v.vendedor, \
		a.producto, \
		a.present, \
		SUM(d.precio*d.cantidad*-1) AS subtotventa, \
		sum(dv.cantidad) AS cantidad, \
		YEAR(n.fechanot) AS año, \
		MONTH(n.fechanot) AS mes \
		FROM notascredcli n \
		INNER JOIN dnotascredcli d ON n.referencia=d.referencia \
		INNER JOIN dventas dv ON dv.referencia =n.venta \
		AND dv.articulo=d.articulo \
		INNER JOIN articulos a ON d.articulo=a.articulo \
		INNER JOIN ventas v ON n.venta = v.referencia \
		INNER JOIN terminales t ON v.terminal=t.terminal \
		INNER JOIN secciones sec ON t.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		INNER JOIN clientes cli ON cli.cliente = v.cliente \
		WHERE n.cancelado=0 \
		AND n.fechanot BETWEEN '%s' AND '%s' \
		%s \
		%s \
		%s \
		GROUP BY YEAR(n.fechanot), \
		MONTH(n.fechanot), \
		sec.sucursal, \
		v.vendedor, \
		a.producto, \
		a.present)) t \
		GROUP BY t.año, \
		t.mes, \
		t.sucursal, \
		t.vendedor, \
		t.producto, \
		t.present",
		fecha_inicial, fecha_final, condicion_sucursal, condicion_excluirparterel, condicion_idempresa,

		fecha_inicial, fecha_final, condicion_sucursal, condicion_excluirparterel, condicion_idempresa);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////Tabla temporal, la cual contendrá los valores de las ventas
		instruccion = "CREATE TEMPORARY TABLE auxventasagentecostonc ( \
		sucursal VARCHAR(2), \
		vendedor VARCHAR(10), \
		producto VARCHAR(8), \
		present VARCHAR(255), \
		multmin DECIMAL(16,4), \
		costo DECIMAL(16,4), \
		año INT(4), mes INT(2), \
		PRIMARY KEY(sucursal, vendedor, producto, present, año, mes)) ENGINE = INNODB ";
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));

		/////se guardan los costos dentro de la tabla temporal
		instruccion.sprintf("INSERT INTO auxventasagentecostonc (sucursal, vendedor, producto, present, multmin, costo, año, mes) \
		SELECT t.sucursal, \
		t.vendedor, \
		t.producto, \
		t.present, \
		SUM(t.multmin), \
		SUM(t.costo) AS costo, \
		t.año, t.mes \
		FROM ( \
		(SELECT sec.sucursal, \
		v.vendedor, \
		pccd.producto, \
		pccd.present, \
		SUM(pccd.cantidad*-1) AS multmin, \
		SUM(pccd.costovta*-1) AS costo, \
		YEAR(v.fechavta) AS año, MONTH(v.fechavta) AS mes \
		FROM ventas v \
		INNER JOIN precalculocostosventadet pccd ON pccd.referencia = v.referencia AND pccd.tipo = 'VE' \
		INNER JOIN terminales t ON v.terminal=t.terminal \
		INNER JOIN secciones sec ON t.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		WHERE v.fechavta BETWEEN '%s' AND '%s' \
		AND v.cancelado = 0 \
		%s \
		%s \
		GROUP BY YEAR(v.fechavta), MONTH(v.fechavta), sec.sucursal, v.vendedor, \
		pccd.producto, \
		pccd.present) \
		UNION ALL \
		(SELECT sec.sucursal, \
		v.vendedor, \
		pccd.producto, \
		pccd.present, \
		SUM(pccd.cantidad*-1) AS multmin, \
		SUM(pccd.costovta*-1) AS costo, \
        YEAR(nc.fechanot) AS año, MONTH(nc.fechanot) AS mes \
		FROM notascredcli nc \
		INNER JOIN dnotascredcli d ON nc.referencia=d.referencia \
		INNER JOIN precalculocostosventadet pccd ON pccd.referencia = nc.referencia \
		AND pccd.tipo = 'DV' \
		INNER JOIN dventas dv ON dv.referencia =nc.venta \
		AND dv.articulo=d.articulo \
		INNER JOIN articulos a ON d.articulo=a.articulo \
		INNER JOIN ventas v ON nc.venta = v.referencia \
		INNER JOIN terminales t ON nc.terminal=t.terminal \
		INNER JOIN secciones sec ON t.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		WHERE nc.fechanot BETWEEN '%s' AND '%s' \
		AND nc.cancelado = 0 \
		%s \
		%s \
		GROUP BY YEAR(nc.fechanot), MONTH(nc.fechanot), sec.sucursal, v.vendedor, pccd.producto, pccd.present)) t \
		GROUP BY t.año, t.mes, t.sucursal, t.vendedor, t.producto, t.present",
		fecha_inicial, fecha_final, condicion_sucursal, condicion_idempresa,

		fecha_inicial, fecha_final, condicion_sucursal, condicion_idempresa);
		if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str()))
			throw(Exception("Error en query EjecutaSelectSqlNulo"));
	}

	if (tiporeporte == "0") {
		instruccion.sprintf("SELECT \
		auxv.año, \
		auxv.mes, \
		auxv.sucursal, \
		'Venta' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS vendedor, \
		auxvnc.multmin AS unidad, \
		TRUNCATE(IFNULL(auxvnc.multmin/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(auxvnc.multmin,pmm.maxfactor),0) AS cantunidad, \
		IFNULL(auxvnc.multmin/pmm.maxfactor,0) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((auxv.cantidad / pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS unidad, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarmay, \
		auxv.producto, \
		prod.nombre, \
		auxv.present, \
		IFNULL(auxvnc.costo,0) AS costo, \
		auxv.subtotventa AS vsimp, \
		(auxv.subtotventa-IFNULL(auxvnc.costo,0)) AS utilidad, \
		IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0) AS porcutilidad, \
		clasif1.nombre, \
		clasif2.nombre, \
		clasif3.nombre, \
		fab.nombre, \
		prov.razonsocial \
		FROM auxventasnc auxv \
		INNER JOIN productos prod ON auxv.producto = prod.producto \
		INNER JOIN presentacionesminmax pmm ON auxv.producto = pmm.producto AND auxv.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto AND pmm.maxmult = amax.multiplo AND pmm.present = amax.present \
        INNER JOIN empleados AS e ON e.empleado=auxv.vendedor \
		LEFT JOIN auxventascostonc auxvnc ON auxv.sucursal = auxvnc.sucursal \
		AND auxv.vendedor = auxvnc.vendedor \
		AND auxv.producto = auxvnc.producto \
		AND auxv.present = auxvnc.present \
		AND auxv.año = auxvnc.año \
		AND auxv.mes = auxvnc.mes \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN articulosped aped ON aped.producto = auxv.producto AND aped.present = auxv.present AND aped.sucursal = auxv.sucursal \
		LEFT JOIN proveedores prov ON prov.proveedor = aped.proveedor \
		LEFT JOIN fabricantes fab ON fab.fabricante = prod.fabricante \
		WHERE 1 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY auxv.año, auxv.mes, auxv.vendedor, auxv.sucursal,auxv.producto, prod.nombre, auxv.present \
		ORDER BY auxv.año ASC, auxv.mes ASC, prod.nombre, auxv.present, auxv.sucursal, auxv.producto",
			condicion_fabricante,
			condicion_clasifmaes, condicion_clasifgene, condicion_clasifespe,
			condicion_proveedor, condicion_producto, condicion_vendedor);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	else if (tiporeporte == "1") {
		instruccion.sprintf("SELECT \
		YEAR(c.fechacom), \
		MONTH(c.fechacom), \
		sec.sucursal, \
		'Compras' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS comprador, \
		SUM(@unidades:=(dc.cantidad- IFNULL(dn.cantidad,0))*articulos.factor) AS unidad, \
		TRUNCATE(IFNULL(@unidades/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(@unidades,pmm.maxfactor),0) AS cantunidad, \
		IFNULL(@unidades/pmm.maxfactor,0) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((@unidades/ pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS unidad, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarrmay, \
		prod.producto, \
		prod.nombre, \
		articulos.present, \
		sum((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)-(IF (ISNULL(i5.porcentaje),0, (((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100))*(1-c.descuento/100)*i5.porcentaje/100)))) AS costo, \
		0 AS vsimp, \
		0 AS utilidad, \
		0 AS porcutilidad, \
		clasif1.nombre, \
		clasif2.nombre, \
		clasif3.nombre, \
		fab.nombre, \
		prov.razonsocial \
		FROM compras c \
		INNER JOIN dcompras AS dc ON c.referencia=dc.referencia \
		INNER JOIN articulos ON dc.articulo=articulos.articulo \
		INNER JOIN productos AS prod ON articulos.producto=prod.producto \
		INNER JOIN terminales AS ter ON ter.terminal=c.terminal \
		INNER JOIN secciones AS sec ON ter.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		INNER JOIN empleados AS e ON e.empleado=c.comprador \
		INNER JOIN presentacionesminmax pmm ON articulos.producto = pmm.producto AND articulos.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto AND pmm.maxmult = amax.multiplo AND pmm.present = amax.present \
		LEFT JOIN dnotascredprovaux dn ON dn.articulo=dc.articulo AND dn.compra=c.referencia \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN fabricantes AS fab ON fab.fabricante=prod.fabricante \
		LEFT JOIN proveedores AS prov ON c.proveedor=prov.proveedor \
		LEFT JOIN auximpuestos5 i5 ON i5.impuesto=c.impuestoret \
        %s \
		WHERE c.fechacom>='%s' \
		AND c.fechacom<='%s' \
		AND c.cancelado=0 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY YEAR(c.fechacom), \
		MONTH(c.fechacom), \
		sec.sucursal , \
		c.comprador, \
		prod.nombre, \
		articulos.present, \
		articulos.multiplo \
		ORDER BY YEAR(c.fechacom) ASC, \
		MONTH(c.fechacom) ASC, \
		prod.nombre, \
		articulos.present, \
		articulos.multiplo",
		left_supervisado, fecha_inicial, fecha_final,
		condicion_fabricante, condicion_clasifmaes,
		condicion_clasifgene, condicion_clasifespe, condicion_proveedor,
		condicion_producto, condicion_sucursal, condicion_idempresa);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	else if (tiporeporte == "2") {
		instruccion.sprintf("SELECT \
		auxv.año, \
		auxv.mes, \
		auxvnc.sucursal, \
		'Venta Agente' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS vendedor, \
		auxvnc.multmin AS unidad, \
		TRUNCATE(IFNULL(auxvnc.multmin/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(auxvnc.multmin,pmm.maxfactor),0) AS cantunidad, \
		(auxvnc.multmin/pmm.cajalogisticafactor) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((auxv.cantidad / pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS minmult, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarmay, \
		auxv.producto, \
		prod.nombre, \
		auxv.present, \
		IFNULL(auxvnc.costo,0) AS costo, \
		auxv.subtotventa AS vsimp, \
		(auxv.subtotventa- IFNULL(auxvnc.costo,0)) AS utilidad, \
		IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0) AS porcutilidad , \
		clasif1.nombre AS clasif1, \
		clasif2.nombre AS clasif2, \
		clasif3.nombre AS clasif3, \
		fab.nombre AS fab, \
		prov.razonsocial \
		FROM auxventasagentenc auxv \
		INNER JOIN productos prod ON auxv.producto = prod.producto \
		INNER JOIN presentacionesminmax pmm ON auxv.producto = pmm.producto \
		AND auxv.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto \
		AND pmm.maxmult = amax.multiplo \
		AND pmm.present = amax.present \
		INNER JOIN empleados AS e ON e.empleado=auxv.vendedor \
		LEFT JOIN auxventasagentecostonc auxvnc ON auxv.sucursal = auxvnc.sucursal \
		AND auxv.vendedor = auxvnc.vendedor \
		AND auxv.producto = auxvnc.producto \
		AND auxv.present = auxvnc.present \
		AND auxv.año = auxvnc.año \
		AND auxv.mes = auxvnc.mes \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN articulosped ap ON amax.producto = ap.producto AND amax.present = ap.present AND ap.sucursal = auxv.sucursal \
		LEFT JOIN proveedores AS prov ON prov.proveedor=ap.proveedor \
		LEFT JOIN fabricantes AS fab ON fab.fabricante=prod.fabricante \
		WHERE 1 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY \
		auxv.año, auxv.mes, auxv.vendedor, auxv.sucursal,auxv.producto, prod.nombre, auxv.present \
		ORDER BY auxv.año ASC, auxv.mes ASC, prod.nombre, auxv.present, auxv.sucursal, auxv.producto",
		condicion_fabricante, condicion_clasifmaes, condicion_clasifgene, condicion_clasifespe,
		condicion_proveedor, condicion_producto, condicion_vendedor);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	else if (tiporeporte == "3") {
		instruccion.sprintf("SELECT t.* FROM (( \
		SELECT \
		auxv.año, \
		auxv.mes, \
		auxv.sucursal, \
		'Venta' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS vendedor, \
		auxvnc.multmin AS unidad, \
		TRUNCATE(IFNULL(auxvnc.multmin/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(auxvnc.multmin,pmm.maxfactor),0) AS cantunidad, \
		IFNULL(auxvnc.multmin/pmm.maxfactor,0) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((auxv.cantidad / pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS minmult, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarmay, \
		auxv.producto, \
		prod.nombre, \
		auxv.present, \
		IFNULL(auxvnc.costo,0) AS costo, \
		auxv.subtotventa AS vsimp, \
		(auxv.subtotventa-IFNULL(auxvnc.costo,0)) AS utilidad, \
		IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0) AS porcutilidad, \
		clasif1.nombre AS clasif1, \
		clasif2.nombre AS clasif2, \
		clasif3.nombre AS clasif3, \
		fab.nombre AS fab, \
		prov.razonsocial \
		FROM auxventasnc auxv \
		INNER JOIN productos prod ON auxv. producto = prod.producto \
		INNER JOIN presentacionesminmax pmm ON auxv.producto = pmm.producto \
		AND auxv.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto \
		AND pmm.maxmult = amax.multiplo \
		AND pmm.present = amax.present \
		INNER JOIN empleados AS e ON e.empleado=auxv.vendedor \
		LEFT JOIN auxventascostonc auxvnc ON auxv.sucursal = auxvnc.sucursal \
		AND auxv.vendedor = auxvnc.vendedor \
		AND auxv.producto = auxvnc.producto \
		AND auxv.present = auxvnc.present \
		AND auxv.año = auxvnc.año \
		AND auxv.mes = auxvnc.mes \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN articulosped aped ON aped.producto = auxv.producto \
		AND aped.present = auxv.present AND aped.sucursal = auxv.sucursal \
		LEFT JOIN proveedores prov ON prov.proveedor = aped.proveedor \
		LEFT JOIN fabricantes fab ON fab.fabricante = prod.fabricante \
		WHERE 1 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY auxv.año, \
			auxv.mes, \
			auxv.vendedor, \
			auxv.sucursal, \
			auxv.producto, \
			prod.nombre, \
			auxv.present \
		ORDER BY auxv.año ASC, \
			auxv.mes ASC, \
			prod.nombre, \
			auxv.present, \
			auxv.sucursal, \
			auxv.producto \
		)UNION ALL ( \
		SELECT YEAR(c.fechacom), \
		MONTH(c.fechacom), \
		sec.sucursal, \
		'Compras' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS vendedor, \
		SUM(@unidades:=(dc.cantidad- IFNULL(dn.cantidad,0))*articulos.factor) AS unidad, \
		TRUNCATE(IFNULL(@unidades/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(@unidades,pmm.maxfactor),0) AS cantunidad, \
		IFNULL(@unidades/pmm.maxfactor,0) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((@unidades/ pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS minmult, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarrmay, \
		prod.producto, \
		prod.nombre, \
		articulos.present, \
		SUM((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100)-(IF (ISNULL(i5.porcentaje),0, (((dc.costoimp-ifnull(dn.costoimp,0))*(dc.cantidad-ifnull(dn.cantidad,0))*(1-c.descuento/100))*(1-c.descuento/100)*i5.porcentaje/100)))) AS costo, \
		0 AS vsimp, \
		0 AS utilidad, \
		0 AS porcutilidad, \
		clasif1.nombre AS clasif1, \
		clasif2.nombre AS clasif2, \
		clasif3.nombre AS clasif3, \
		fab.nombre AS fab, \
		prov.razonsocial \
		FROM compras c \
		INNER JOIN dcompras AS dc ON c. referencia=dc.referencia \
		INNER JOIN articulos ON dc.articulo=articulos.articulo \
		INNER JOIN productos AS prod ON articulos.producto=prod.producto \
		INNER JOIN terminales AS ter ON ter.terminal=c.terminal \
		INNER JOIN secciones AS sec ON ter.seccion=sec.seccion \
		INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal \
		INNER JOIN presentacionesminmax pmm ON articulos.producto = pmm.producto \
		AND articulos.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto \
		AND pmm.maxmult = amax.multiplo \
		AND pmm.present = amax.present \
		INNER JOIN empleados AS e ON e.empleado=c.comprador \
		LEFT JOIN dnotascredprovaux dn ON dn.articulo=dc.articulo \
		AND dn.compra=c.referencia \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN fabricantes AS fab ON fab.fabricante=prod.fabricante \
		LEFT JOIN proveedores AS prov ON c.proveedor=prov.proveedor \
		LEFT JOIN auximpuestos5 i5 ON i5.impuesto=c.impuestoret \
		%s \
		WHERE c.fechacom>='%s' \
		AND c. fechacom<='%s' \
		AND c.cancelado=0 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY YEAR(c.fechacom), \
			MONTH(c.fechacom), \
			c.comprador, \
			sec.sucursal , \
		prod.nombre, \
		articulos.present, \
		articulos.multiplo \
		ORDER BY YEAR(c.fechacom) ASC, \
			MONTH(c.fechacom) ASC, \
			prod.nombre, \
		articulos.present, \
		articulos.multiplo \
		)UNION ALL ( \
		SELECT \
		auxv.año, \
		auxv.mes, \
		auxv.sucursal, \
		'Venta Agente' AS tipo, \
		CONCAT(e.nombre,' ', e.appat, ' ', e.apmat) AS vendedor, \
		auxvnc.multmin AS unidad, \
		TRUNCATE(IFNULL(auxvnc.multmin/pmm.maxfactor,0),0) AS cantmayor, \
		IFNULL(MOD(auxvnc.multmin,pmm.maxfactor),0) AS cantunidad, \
		(auxvnc.multmin/pmm.cajalogisticafactor) AS CajLog, \
		pmm.cajalogisticafactor, \
		ROUND(((auxv.cantidad / pmm.cajalogisticafactor)),2) AS cajasbultos, \
		pmm.maxfactor, \
		pmm.maxmult AS maxmult, \
		pmm.minmult AS minmult, \
		amax.articulo AS clavemax, \
		amax.ean13 AS codbarmay, \
		auxv.producto, \
		prod.nombre, \
		auxv.present, \
		IFNULL(auxvnc.costo,0) AS costo, \
		auxv.subtotventa AS vsimp, \
		(auxv.subtotventa- IFNULL(auxvnc.costo,0)) AS utilidad, \
		IFNULL((((auxv.subtotventa-auxvnc.costo)*100)/auxvnc.costo),0) AS porcutilidad , \
		clasif1.nombre AS clasif1, \
		clasif2.nombre AS clasif2, \
		clasif3.nombre AS clasif3, \
		fab.nombre AS fab, \
		prov.razonsocial \
		FROM auxventasagentenc auxv \
		INNER JOIN productos prod ON auxv.producto = prod.producto \
		INNER JOIN presentacionesminmax pmm ON auxv.producto = pmm.producto \
		AND auxv.present = pmm.present \
		INNER JOIN articulos amax ON pmm.producto = amax.producto \
		AND pmm.maxmult = amax.multiplo \
		AND pmm.present = amax.present \
		INNER JOIN empleados AS e ON e.empleado=auxv.vendedor \
		LEFT JOIN auxventasagentecostonc auxvnc ON auxv.sucursal = auxvnc.sucursal \
		AND auxv.vendedor = auxvnc.vendedor \
		AND auxv.producto = auxvnc.producto \
		AND auxv.present = auxvnc.present \
		AND auxv.año = auxvnc.año \
		AND auxv.mes = auxvnc.mes \
		LEFT JOIN clasificacion1 clasif1 ON clasif1.clasif1 = prod.clasif1 \
		LEFT JOIN clasificacion2 clasif2 ON clasif2.clasif2 = prod.clasif2 \
		LEFT JOIN clasificacion3 clasif3 ON clasif3.clasif3 = prod.clasif3 \
		LEFT JOIN articulosped ap ON amax.producto = ap.producto AND amax.present = ap.present AND ap.sucursal = auxv.sucursal \
		LEFT JOIN proveedores AS prov ON prov.proveedor=ap.proveedor \
		LEFT JOIN fabricantes AS fab ON fab.fabricante=prod.fabricante \
		WHERE 1 \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		%s \
		GROUP BY auxv.año, auxv.mes, auxv.vendedor, auxv.sucursal,auxv.producto, prod.nombre, auxv.present \
		ORDER BY auxv.año ASC, auxv.mes ASC, prod.nombre, auxv.present, auxv.sucursal, auxv.producto \
		 )) t \
		ORDER BY t.año ASC, \
		t.mes ASC, \
		t.nombre, \
		t.present, \
		t.sucursal, \
		t.producto",
			condicion_fabricante, condicion_clasifmaes, condicion_clasifgene, condicion_clasifespe,
			condicion_proveedor, condicion_producto, condicion_vendedor,

			left_supervisado, fecha_inicial, fecha_final,
			condicion_fabricante, condicion_clasifmaes, condicion_clasifgene,
			condicion_clasifespe, condicion_proveedor, condicion_producto,
			condicion_sucursal, condicion_supervisado, condicion_idempresa,

			condicion_fabricante, condicion_clasifmaes, condicion_clasifgene, condicion_clasifespe,
			condicion_proveedor, condicion_producto, condicion_vendedor);
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPPOLIZAGASTO
void ServidorReportes::EjecutaRepPolizaGastos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;

	AnsiString fecha_ini;
	AnsiString fecha_fin;
	AnsiString empresa;
	AnsiString sucursal;
	AnsiString tipoComp;
	AnsiString plantilla;
	AnsiString porcuenta;
	AnsiString portipogasto;
	AnsiString condicion_empresa = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	tipoComp = mFg.ExtraeStringDeBuffer(&parametros);
	plantilla = mFg.ExtraeStringDeBuffer(&parametros);
	porcuenta = mFg.ExtraeStringDeBuffer(&parametros);
	portipogasto = mFg.ExtraeStringDeBuffer(&parametros);

	if(empresa != " "){
		condicion_empresa.sprintf(" suc.idempresa = %s AND ", empresa);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (porcuenta == "1" && portipogasto == "0") {
		instruccion.sprintf("SELECT t.* FROM (( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, p.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, p.tipogasto, \
			0 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM plantillaspoliz AS p \
		INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE %s p.sucursal='%s' AND p.tipocomprobante='%s' AND p.tipoplantilla='%s' AND p.numcuenta <> 'AUTO' AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NULL) \
		ORDER BY p.orden \
		) UNION ALL ( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, g.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, p.tipogasto, \
			1 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM gastos g \
		LEFT JOIN plantillaspoliz p ON p.sucdetalle = g.sucursal \
		LEFT JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=g.numcuenta AND c.sucursal=g.sucursal \
        LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE g.fechagas BETWEEN '%s' AND '%s' \
		AND %s p.sucursal='%s' \
		AND p.tipocomprobante='%s' \
		AND p.tipoplantilla='%s' \
		AND p.numcuenta = 'AUTO' \
		GROUP BY segmento, p.parterel,p.tipoafectacion,p.expresion, g.numcuenta, p.tipogasto \
		ORDER BY p.orden)) t ORDER BY t.orden", condicion_empresa, sucursal, tipoComp, plantilla,

			fecha_ini, fecha_fin, condicion_empresa, sucursal, tipoComp, plantilla);

	}
	else if (porcuenta == "0" && portipogasto == "1") {
		instruccion.sprintf("SELECT t.* FROM (( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, p.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, p.tipogasto, \
			0 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM plantillaspoliz AS p \
		INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE %s p.sucursal='%s' AND p.tipocomprobante='%s' AND p.tipoplantilla='%s' AND p.numcuenta <> 'AUTO' AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NULL) \
		ORDER BY p.orden \
		) UNION ALL ( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, g.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, g.tipogasto, \
			0 AS agrupaporcuenta, \
			1 AS agrupaporgasto \
		FROM gastos g \
		LEFT JOIN plantillaspoliz p ON p.sucdetalle = g.sucursal \
		LEFT JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=g.numcuenta AND c.sucursal=g.sucursal \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE g.fechagas BETWEEN '%s' AND '%s' \
		AND %s p.sucursal='%s' \
		AND p.tipocomprobante='%s' \
		AND p.tipoplantilla='%s' \
		AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NOT NULL) \
		GROUP BY segmento, p.parterel,p.tipoafectacion,p.expresion, g.tipogasto \
		ORDER BY p.orden )) t ORDER BY t.orden", condicion_empresa, sucursal, tipoComp, plantilla,

			fecha_ini, fecha_fin, condicion_empresa, sucursal, tipoComp, plantilla);

	}
	else if (porcuenta == "0" && portipogasto == "0") {
		instruccion.sprintf("SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, p.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, p.tipogasto, \
			0 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM plantillaspoliz AS p \
		INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE %s p.sucursal='%s' AND p.tipocomprobante='%s' AND p.tipoplantilla='%s' AND p.numcuenta <> 'AUTO' AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NULL) \
		ORDER BY p.orden", condicion_empresa, sucursal, tipoComp, plantilla);
	}
	else {
		instruccion.sprintf("SELECT t.* FROM (( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, p.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, p.tipogasto, \
			0 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM plantillaspoliz AS p \
		INNER JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=p.numcuenta AND c.sucursal=p.sucdetalle \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE %s p.sucursal='%s' AND p.tipocomprobante='%s' AND p.tipoplantilla='%s' AND p.numcuenta <> 'AUTO' AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NULL) \
		ORDER BY p.orden \
		) UNION ALL ( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, g.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, g.tipogasto, \
			1 AS agrupaporcuenta, \
			0 AS agrupaporgasto \
		FROM gastos g \
		LEFT JOIN plantillaspoliz p ON p.sucdetalle = g.sucursal \
		LEFT JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=g.numcuenta AND c.sucursal=g.sucursal \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE g.fechagas BETWEEN '%s' AND '%s' \
		AND %s p.sucursal='%s' \
		AND p.tipocomprobante='%s' \
		AND p.tipoplantilla='%s' \
		AND p.numcuenta = 'AUTO' \
		AND (p.tipogasto <> 'AUTO' OR p.tipogasto IS NOT NULL) \
		ORDER BY p.orden \
		) UNION ALL ( \
		SELECT \
			p.plantilla, p.orden, \
			p.tipopartida, p.numcuenta, \
			c.nombrecuenta, p.sucdetalle, \
			p.tipoafectacion, p.expresion, \
			p.sucursal, p.parametros, \
			p.tipocomprobante, p.clasif1, \
			p.clasif2, p.clasif3, \
			p.fechainivent, p.fechafinvent, \
			p.clasifcont, p.clasifcont2, \
			concat(p.acredito) as acredito, \
			p.termino, \
			p.tipoimpu, concat(p.impuesto) as impuesto, \
			concat(p.negimpuesto) as negimpuesto, \
			p.tipoimpu2, concat(p.impuesto2) as impuesto2, \
			concat(p.negimpuesto2) as negimpuesto2, \
			concat(p.parterel) as parterel, coalesce (p.segmentodefault,par.segmento )AS segmento, \
			p.formaspago, p.tiporfc, \
			ifnull(p.idnumcuenta,0) as idnumcuenta, \
			0 as total, p.agrupabanco, g.tipogasto, \
			0 AS agrupaporcuenta, \
			1 AS agrupaporgasto \
		FROM gastos g \
		LEFT JOIN plantillaspoliz p ON p.sucdetalle = g.sucursal \
		LEFT JOIN parametroscfd par ON par.sucursal=p.sucdetalle \
		LEFT JOIN cuentascont AS c ON c.numcuenta=g.numcuenta AND c.sucursal=g.sucursal \
		LEFT JOIN sucursales AS suc ON suc.sucursal = p.sucdetalle \
		WHERE g.fechagas BETWEEN '%s' AND '%s' \
		AND %s p.sucursal='%s' \
		AND p.tipocomprobante='%s' \
		AND p.tipoplantilla='%s' \
		AND p.tipogasto = 'AUTO' \
		AND p.numcuenta <> 'AUTO' \
		ORDER BY p.orden \
		)) t \
		GROUP BY t.segmento, t.parterel,t.tipoafectacion,t.expresion, t.numcuenta, t.tipogasto \
		ORDER BY t.orden", condicion_empresa, sucursal, tipoComp, plantilla,

			fecha_ini, fecha_fin, condicion_empresa, sucursal, tipoComp, plantilla,

			fecha_ini, fecha_fin, condicion_empresa, sucursal, tipoComp, plantilla);

	}
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------

// ---------------------------------------------------------------------------
// ID_EJE_REPCFD
void ServidorReportes::EjecutaRepCFD(RespuestaServidor *Respuesta, MYSQL *MySQL,
	char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString condicion_tipo_comprobante, condicion_version, condicion_pac,
		condicion_edo_timbrado, condicion_edo_cfd, condicion_motivocanc,
		condicion_sucursal, condicion_empresa = " ";
	AnsiString tipo_comprobante, version, pac, estado_timbrado, estado_cfd,
		motivocanc, sucursal, fecha_ini, fecha_fin, empresa;
	AnsiString idempresa;

	AnsiString medio_facturacion, join_cfdiweb = " ", condicion_cfdiweb = " ";

	tipo_comprobante = mFg.ExtraeStringDeBuffer(&parametros);
	version = mFg.ExtraeStringDeBuffer(&parametros);
	pac = mFg.ExtraeStringDeBuffer(&parametros);
	estado_timbrado = mFg.ExtraeStringDeBuffer(&parametros);
	estado_cfd = mFg.ExtraeStringDeBuffer(&parametros);
	motivocanc = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	medio_facturacion = mFg.ExtraeStringDeBuffer(&parametros);
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	// Medio de facturación -web

	idempresa = FormServidor->ObtieneClaveEmpresa();

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (tipo_comprobante != " ") {
		condicion_tipo_comprobante.sprintf(" AND cfd.tipocomprobante='%s' ",
			tipo_comprobante);
	}
	else {
		condicion_tipo_comprobante = " ";
	}

	if (version != " ") {
		condicion_version.sprintf(" AND cfd.version = '%s' ", version);
	}
	else {
		condicion_version = " ";
	}

	if (pac != " ") {
		condicion_pac.sprintf(" AND cfd.pactimbrador = %d ", StrToInt(pac));
	}
	else {
		condicion_pac = " ";
	}

	if (estado_timbrado == " ") {
		condicion_edo_timbrado = " ";
	}
	else if (estado_timbrado == "timbrados") {
		condicion_version = " AND cfd.version IN ('3.2','3.3','4.0') ";
		condicion_edo_timbrado = " AND length(ifnull(cfd.muuid,'')) = 36 ";
	}
	else if (estado_timbrado == "pendientes") {
		condicion_version = " AND cfd.version IN ('3.2','3.3','4.0') ";
		condicion_edo_timbrado = " AND length(ifnull(cfd.muuid,'')) <> 36 ";
	}

	if (estado_cfd == " ") {
		condicion_edo_cfd = " ";
	}
	else if (estado_cfd == "0") {
		condicion_edo_cfd = " AND cfd.estado = 1 ";
	}
	else if (estado_cfd == "1") {
		condicion_edo_cfd = " AND cfd.estado = 0 ";
	}
	else if (estado_cfd == "2") {
		condicion_edo_cfd =
			" AND cfd.estado = 0 AND cfd.tipocomprobante = 'PAGO' AND cs.sustituido = 0 ";
	}
	else if (estado_cfd == "3") {
		condicion_edo_cfd =
			" AND cfd.estado = 0 AND cfd.tipocomprobante = 'PAGO' AND cs.sustituido = 1 ";
	}

	if (motivocanc != " ") {
		condicion_motivocanc.sprintf(" AND cfd.motivocanc = '%s' ", motivocanc);
	}
	else {
		condicion_motivocanc = " ";
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND cfd.sucursal='%s' ", sucursal);
	}
	else {
		condicion_sucursal = " ";
	}

	if (medio_facturacion != " ") {
		if (medio_facturacion == "0") {
			join_cfdiweb =
				" LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia";
			condicion_cfdiweb = " AND w.factgenerada IS NULL  ";
		}
		else if (medio_facturacion == "1") {
			join_cfdiweb =
				" INNER JOIN cfdiweb w ON w.factgenerada=v.referencia ";
			// condicion_cfdiweb = " AND w.activo = 1 AND w.factgenerada IS NOT NULL  ";
		}
	}

	instruccion.sprintf
		("CREATE TEMPORARY TABLE auximpuestos( impuesto int(2), primary key(impuesto)) Engine = INNODB"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf
		("INSERT INTO auximpuestos (impuesto) SELECT impuesto FROM impuestos");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auximpuestos1 (  \
							orden int(2), impuesto int(2), tipoimpu char(10), \
							porcentaje decimal(5,2), nombre varchar(40),  \
							primary key(impuesto), index(orden), index(tipoimpu)) \
							Engine = INNODB");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auximpuestos1 (orden, impuesto, tipoimpu, porcentaje,nombre) \
									SELECT  i.impuesto AS orden, i.impuesto AS impuesto, i.tipoimpu AS tipoimpu, \
									i.porcentaje AS porcentaje, t.nombre AS nombre FROM impuestos i, \
									tiposdeimpuestos t, auximpuestos aux  \
									WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auximpuestos2 (  \
							orden int(2), impuesto int(2), tipoimpu char(10), \
							porcentaje decimal(5,2), nombre varchar(40),      \
							primary key(impuesto), index(orden), index(tipoimpu)) \
							Engine = INNODB");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auximpuestos2 (orden, impuesto, tipoimpu, porcentaje,nombre) \
									SELECT  i.impuesto AS orden, i.impuesto AS impuesto, i.tipoimpu AS tipoimpu, \
									i.porcentaje AS porcentaje, t.nombre AS nombre FROM impuestos i, \
									tiposdeimpuestos t, auximpuestos aux  \
									WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auximpuestos3 (  \
							orden int(2), impuesto int(2), tipoimpu char(10), \
							porcentaje decimal(5,2), nombre varchar(40),      \
							primary key(impuesto), index(orden), index(tipoimpu)) \
							Engine = INNODB");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auximpuestos3 (orden, impuesto, tipoimpu, porcentaje,nombre) \
									SELECT  i.impuesto AS orden, i.impuesto AS impuesto, i.tipoimpu AS tipoimpu, \
									i.porcentaje AS porcentaje, t.nombre AS nombre FROM impuestos i, \
									tiposdeimpuestos t, auximpuestos aux  \
									WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auximpuestos4 (  \
							orden int(2), impuesto int(2), tipoimpu char(10), \
							porcentaje decimal(5,2), nombre varchar(40),      \
							primary key(impuesto), index(orden), index(tipoimpu)) \
							Engine = INNODB");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auximpuestos4 (orden, impuesto, tipoimpu, porcentaje,nombre) \
									SELECT  i.impuesto AS orden, i.impuesto AS impuesto, i.tipoimpu AS tipoimpu, \
									i.porcentaje AS porcentaje, t.nombre AS nombre FROM impuestos i, \
									tiposdeimpuestos t, auximpuestos aux  \
									WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxventasdocumento (  \
						referencia char(11), totaliesps DECIMAL(16,2), totaliva DECIMAL(16,2),  \
						subtotal DECIMAL(16,2),primary key(referencia)) Engine = INNODB;"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxventasdocumento SELECT   \
						v.referencia,  \
						round(SUM(if(i1.tipoimpu='IESPS', ((dv.precio*dv.cantidad)*(i1.porcentaje/100)*df.porcentaje),0)),2) AS totaliesps,    \
						round(SUM(if(i1.tipoimpu='IVA', ((dv.precio*dv.cantidad)*(i1.porcentaje/100)*df.porcentaje), 0) + if(i2.tipoimpu='IVA', \
						((dv.precio*dv.cantidad)*(1+i1.porcentaje/100)*(i2.porcentaje/100)*df.porcentaje), 0)),2) AS totaliva, \
						round(SUM(((dv.precio*dv.cantidad)*(1-dv.porcdesc/100)*df.porcentaje)),2) AS subtotal  \
						FROM ventas v  \
						INNER JOIN dventas dv  \
						INNER JOIN articulos    \
						INNER JOIN terminales ter ON ter.terminal=v.terminal \
						INNER JOIN secciones sec ON ter.seccion=sec.seccion   \
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
						INNER JOIN dventasfpago df ON df.referencia = v.referencia \
						LEFT JOIN auximpuestos1 i1 ON i1.impuesto=dv.claveimp1 \
						LEFT JOIN auximpuestos2 i2 ON i2.impuesto=dv.claveimp2  \
						WHERE sec.sucursal='%s'  \
						AND v.cancelado=0  \
						AND v.fechavta>='%s'  \
						AND v.fechavta<='%s'   \
						AND v.referencia=dv.referencia  \
						AND dv.articulo=articulos.articulo  \
                        AND suc.idempresa = %s \
						group by v.referencia  \
						order by suc.numid, v.referencia", sucursal, fecha_ini,
		fecha_fin, idempresa);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxnotascredocumento ( referencia char(11), \
						subtotal DECIMAL(16,2), imp1 DECIMAL(16,2), imp2 DECIMAL(16,2), \
						imp3 DECIMAL(16,2), imp4 DECIMAL(16,2), impcol2 DECIMAL(16,2),  \
						impcol8 DECIMAL(16,2), impcol12 DECIMAL(16,2), impcol13 DECIMAL(16,2), \
						impcol11 DECIMAL(16,2), impcol3 DECIMAL(16,2), impcol4 DECIMAL(16,2),  \
						impcol9 DECIMAL(16,2), impcol5 DECIMAL(16,2),  impcol6 DECIMAL(16,2),  \
						impcol10 DECIMAL(16,2), totaliva DECIMAL(16,2), totaliesps DECIMAL(16,2), \
						primary key(referencia)) Engine = INNODB");

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxnotascredocumento    \
					SELECT n.referencia,SUM(@subtotal:=dn.precio*dn.cantidad) AS subtotal,  \
					SUM(@impuesto1:=if (ISNULL(i1.porcentaje),0, @subtotal *(i1.porcentaje/100))) AS imp1,  \
					SUM(@impuesto2:=if (ISNULL(i2.porcentaje),0, (@subtotal + @impuesto1) * (i2.porcentaje/100))) AS imp2,  \
					SUM(@impuesto3:=if (ISNULL(i3.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100))) AS imp3,   \
					SUM(@impuesto4:=if (ISNULL(i4.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100))) AS imp4,  \
					SUM(@impcol2:=(CASE WHEN i1.orden=2 THEN @impuesto1 WHEN i2.orden=2 THEN @impuesto2 WHEN i3.orden=2 THEN @impuesto3 WHEN i4.orden=2 THEN @impuesto4 ELSE 0 END)) AS impcol2, \
					SUM(@impcol8:=(CASE WHEN i1.orden=8 THEN @impuesto1 WHEN i2.orden=8 THEN @impuesto2 WHEN i3.orden=8 THEN @impuesto3 WHEN i4.orden=8 THEN @impuesto4 ELSE 0 END)) AS impcol8, \
					SUM(@impcol12:=(CASE WHEN i1.orden=12 THEN @impuesto1 WHEN i2.orden=12 THEN @impuesto2 WHEN i3.orden=12 THEN @impuesto3 WHEN i4.orden=12 THEN @impuesto4 ELSE 0 END)) AS impcol12, \
					SUM(@impcol13:=(CASE WHEN i1.orden=13 THEN @impuesto1 WHEN i2.orden=13 THEN @impuesto2 WHEN i3.orden=13 THEN @impuesto3 WHEN i4.orden=13 THEN @impuesto4 ELSE 0 END)) AS impcol13, \
					SUM(@impcol11:=(CASE WHEN i1.orden=11 THEN @impuesto1 WHEN i2.orden=11 THEN @impuesto2 WHEN i3.orden=11 THEN @impuesto3 WHEN i4.orden=11 THEN @impuesto4 ELSE 0 END)) AS impcol11, \
					SUM(@impcol3:=(CASE WHEN i1.orden=3 THEN @impuesto1 WHEN i2.orden=3 THEN @impuesto2 WHEN i3.orden=3 THEN @impuesto3 WHEN i4.orden=3 THEN @impuesto4 ELSE 0 END)) AS impcol3, \
					SUM(@impcol4:=(CASE WHEN i1.orden=4 THEN @impuesto1 WHEN i2.orden=4 THEN @impuesto2 WHEN i3.orden=4 THEN @impuesto3 WHEN i4.orden=4 THEN @impuesto4 ELSE 0 END)) AS impcol4, \
					SUM(@impcol9:=(CASE WHEN i1.orden=9 THEN @impuesto1 WHEN i2.orden=9 THEN @impuesto2 WHEN i3.orden=9 THEN @impuesto3 WHEN i4.orden=9 THEN @impuesto4 ELSE 0 END)) AS impcol9, \
					SUM(@impcol5:=(CASE WHEN i1.orden=5 THEN @impuesto1 WHEN i2.orden=5 THEN @impuesto2 WHEN i3.orden=5 THEN @impuesto3 WHEN i4.orden=5 THEN @impuesto4 ELSE 0 END)) AS impcol5, \
					SUM(@impcol6:=(CASE WHEN i1.orden=6 THEN @impuesto1 WHEN i2.orden=6 THEN @impuesto2 WHEN i3.orden=6 THEN @impuesto3 WHEN i4.orden=6 THEN @impuesto4 ELSE 0 END)) AS impcol6, \
					SUM(@impcol10:=(CASE WHEN i1.orden=10 THEN @impuesto1 WHEN i2.orden=10 THEN @impuesto2 WHEN i3.orden=10 THEN @impuesto3 WHEN i4.orden=10 THEN @impuesto4 ELSE 0 END)) AS impcol10,  \
					SUM(@impcol2 + @impcol8) AS totaliva,  \
					SUM(@impcol12 + @impcol13 + @impcol11 + @impcol3 + @impcol4 + @impcol9 + @impcol5 + @impcol6 + @impcol10) AS totaliesps \
					FROM notascredcli n   \
					INNER JOIN dnotascredcli dn   \
					INNER JOIN dventas dv        \
					INNER JOIN articulos        \
					INNER JOIN ventas v          \
					INNER JOIN terminales ter ON ter.terminal=v.terminal   \
					INNER JOIN secciones sec ON ter.seccion=sec.seccion    \
					INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
					LEFT JOIN auximpuestos1 i1 ON i1.impuesto=dv.claveimp1  \
					LEFT JOIN auximpuestos2 i2 ON i2.impuesto=dv.claveimp2  \
					LEFT JOIN auximpuestos3 i3 ON i3.impuesto=dv.claveimp3  \
					LEFT JOIN auximpuestos4 i4 ON i4.impuesto=dv.claveimp4  \
					LEFT JOIN (                                             \
					SELECT referencia, seriefolio AS foliocfd, muuid, vtacontab, cancvtacontab, fechaalta \
					FROM cfd   \
					WHERE tipocomprobante='NCRE') cfd ON cfd.referencia=n.referencia  \
					WHERE sec.sucursal='%s' AND n.cancelado=0 AND n.fechanot>='%s' AND  \
					n.fechanot<='%s' AND n.referencia=dn.referencia AND v.referencia=n.venta AND   \
					dn.articulo=dv.articulo AND v.referencia=dv.referencia AND dn.articulo=articulos.articulo  \
					AND suc.idempresa = %s \
					GROUP BY n.referencia  \
					ORDER BY suc.numid, n.referencia",sucursal, fecha_ini, fecha_fin, idempresa);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf
		("CREATE TEMPORARY TABLE referenciasaux (referencia CHAR(11), PRIMARY KEY (referencia)) ENGINE = INNODB;"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO referenciasaux SELECT v.referencia   \
						FROM ventas v, transxcob t WHERE t.aplicada=1 AND  \
						t.fechaapl>='%s' AND t.fechaapl<='%s' AND t.cancelada=0 AND t.tipo='PAGO' AND  \
						v.cancelado=0 AND v.fechavta>='1900-01-01' AND v.fechavta<='2099-01-01' AND  \
						t.referencia=v.referencia \ GROUP BY v.referencia",
		fecha_ini, fecha_fin);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE dnotascredcliaux (   \
						venta CHAR(11), articulo VARCHAR(9), cantidad DECIMAL(12,3), precio DECIMAL(16,6),  \
						precioimp DECIMAL(16,6), PRIMARY KEY (venta, articulo)) ENGINE = INNODB;"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO dnotascredcliaux    \
									SELECT v.referencia AS venta, d.articulo, SUM(if(n.tipo='0',d.cantidad,0)) AS cantidad,  \
									SUM(if(n.tipo<>'0',d.precio,0)) AS precio, SUM(if(n.tipo<>'0',d.precioimp,0)) AS precioimp \
									FROM notascredcli n, dnotascredcli d, ventas v, referenciasaux ra                          \
									WHERE n.venta=v.referencia AND n.cancelado=0 AND v.cancelado=0 AND                         \
									ra.referencia=v.referencia AND n.referencia=d.referencia \
									GROUP BY v.referencia, d.articulo;");

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE ventasaux (     \
						referencia CHAR(11),totaloriginal DECIMAL(16,4),totaltodo DECIMAL(16,4),  \
						total0 DECIMAL(16,4), total15 DECIMAL(16,4), total16 DECIMAL(16,4), subnograbado DECIMAL(16,4), \
						subtotal15 DECIMAL(16,4), subtotal16 DECIMAL(16,4), subgrabado DECIMAL(16,4), subtotal DECIMAL(16,4),  \
						totclasifcont DECIMAL(16,4), totaliva2 DECIMAL(16,4), totaliva8 DECIMAL(16,4), totaliesps12 DECIMAL(16,4),  \
						totaliesps13 DECIMAL(16,4), totaliesps11 DECIMAL(16,4), totaliesps3 DECIMAL(16,4), totaliesps4 DECIMAL(16,4), \
						totaliesps9 DECIMAL(16,4), totaliesps5 DECIMAL(16,4), totaliesps6 DECIMAL(16,4), totaliesps10 DECIMAL(16,4),  \
						totaliva DECIMAL(16,4), totaliesps DECIMAL(16,4), valor DECIMAL(16,4), porcentaje0 DECIMAL(16,10), porcentaje15 DECIMAL(16,10),   \
						porcentaje16 DECIMAL(16,10), porcentajesub0 DECIMAL(16,10), porcentajesub15 DECIMAL(16,10), porcentajesub16 DECIMAL(16,10), \
						porcentajesubgrabado DECIMAL(16,10), porcentajesubtotal DECIMAL(16,10), porcclasifcont DECIMAL(16,10), porcentajeiva2 DECIMAL(16,10), porcentajeiva8 DECIMAL(16,10), \
						porcentajeiesps12 DECIMAL(16,10), porcentajeiesps13 DECIMAL(16,10), porcentajeiesps11 DECIMAL(16,10), porcentajeiesps3 DECIMAL(16,10), \
						porcentajeiesps4 DECIMAL(16,10), porcentajeiesps9 DECIMAL(16,10), porcentajeiesps5 DECIMAL(16,10), porcentajeiesps6 DECIMAL(16,10), \
						porcentajeiesps10 DECIMAL(16,10), porcentajeiva DECIMAL(16,10), porcentajeiesps DECIMAL(16,10), PRIMARY KEY (referencia)) ENGINE = INNODB;"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO ventasaux (referencia,totaloriginal, totaltodo, total0, total15, total16, \
							subnograbado,subtotal15,subtotal16,subgrabado,subtotal, totclasifcont, totaliva2,  \
							totaliva8, totaliesps12, totaliesps13, totaliesps11, totaliesps3, totaliesps4,    \
							totaliesps9, totaliesps5, totaliesps6, totaliesps10, totaliva, totaliesps)        \
							SELECT v.referencia,                                                             \
							SUM((dv.precioimp)*(dv.cantidad)) AS totaloriginal,                              \
							SUM((dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0))) AS totaltodo,  \
							SUM(if((NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0) AND NOT (IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS total0,   \
							SUM(if(((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=15.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS total15,   \
							SUM(if(((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR 	(i4.tipoimpu='IVA' AND i4.porcentaje=16.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS total16,     \
							SUM(@subnograbado:=if((NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0) AND NOT (IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)), (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS subnograbado,  \
							SUM(@subtotal15:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=15.00)), (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS subtotal15,   \
							SUM(@subtotal16:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=16.00)), (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS subtotal16,   \
							SUM(@subgrabado:=@subtotal15+@subtotal16) AS subgrabado,   \
							SUM(@subtotal:=@subtotal15+@subtotal16+@subnograbado) AS subtotal, \
							0 AS totclasifcont,  \
							SUM(if(i1.impuesto=2, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=2, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva2,   \
							SUM(if(i1.impuesto=8, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=8, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva8,  \
							SUM(if(i1.impuesto=12, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=12, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps12, SUM(if(i1.impuesto=13, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=13, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps13,   \
							SUM(if(i1.impuesto=11, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=11, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps11, SUM(if(i1.impuesto=3, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=3, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps3,        \
							SUM(if(i1.impuesto=4, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=4, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps4, SUM(if(i1.impuesto=9, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=9, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps9,       \
							SUM(if(i1.impuesto=5, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=5, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps5, SUM(if(i1.impuesto=6, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=6, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps6,       \
							SUM(if(i1.impuesto=10, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=10, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps10,   \
							SUM(if(i1.tipoimpu='IVA', (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.tipoimpu='IVA', (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva,         \
							SUM(if(i1.tipoimpu='IESPS',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0)) AS totaliesps     \
							FROM 	referenciasaux ra    \
							INNER JOIN ventas v ON v.referencia = ra.referencia   \
							INNER JOIN dventas dv ON v.referencia = dv.referencia  \
							INNER JOIN terminales t ON t.terminal = v.terminal \
							INNER JOIN secciones sec ON sec.seccion = t.seccion \
                            INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
							LEFT JOIN dnotascredcliaux dn ON dn.articulo=dv.articulo AND dn.venta=v.referencia   \
							LEFT JOIN impuestos i1 ON i1.impuesto=dv.claveimp1   \
							LEFT JOIN impuestos i2 ON i2.impuesto=dv.claveimp2   \
							LEFT JOIN impuestos i3 ON i3.impuesto=dv.claveimp3  \
							LEFT JOIN impuestos i4 ON i4.impuesto=dv.claveimp4  \
							WHERE suc.idempresa = %s \
							GROUP BY v.referencia ORDER BY v.referencia", idempresa);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("UPDATE ventasaux SET   \
							valor=totaltodo, porcentaje0=total0/(totaltodo),porcentaje15=total15/(totaltodo),  \
							porcentaje16=total16/(totaltodo),porcentajesub0=subnograbado/(totaltodo),  \
							porcentajesub15=subtotal15/(totaltodo),porcentajesub16=subtotal16/(totaltodo),  \
							porcentajesubgrabado=subgrabado/(totaltodo),porcclasifcont=totclasifcont/(totaltodo),   \
							porcentajeiva2=totaliva2/(totaltodo), porcentajeiva8=totaliva8/(totaltodo),  \
							porcentajeiesps12=totaliesps12/(totaltodo), porcentajeiesps13=totaliesps13/(totaltodo),  \
							porcentajeiesps11=totaliesps11/(totaltodo), porcentajeiesps3=totaliesps3/(totaltodo),   \
							porcentajeiesps4=totaliesps4/(totaltodo), porcentajeiesps9=totaliesps9/(totaltodo),  \
							porcentajeiesps5=totaliesps5/(totaltodo), porcentajeiesps6=totaliesps6/(totaltodo), \
							porcentajeiesps10=totaliesps10/(totaltodo), porcentajeiva=totaliva/(totaltodo), porcentajeiesps=totaliesps/(totaltodo);"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxtransac (    \
						tracredito VARCHAR(11), concepto VARCHAR(1), destino VARCHAR(1), referencia VARCHAR(11),  \
						tipo VARCHAR(4), pago VARCHAR(11), valor DECIMAL(16,2), valorvta DECIMAL(16,4),          \
						fechaapl DATE, horamodi TIME, porcentaje0 DECIMAL(16,10), porcentaje15 DECIMAL(16,10),   \
						porcentaje16 DECIMAL(16,10), porcentajesub0 DECIMAL(16,10), porcentajesub15 DECIMAL(16,10),  \
						porcentajesub16 DECIMAL(16,10), porcentajesubgrabado DECIMAL(16,10), porcentajesubtotal DECIMAL(16,10),  \
						porcclasifcont DECIMAL(16,10), porcentajeiva2 DECIMAL(16,10), porcentajeiva8 DECIMAL(16,10),            \
						porcentajeiesps12 DECIMAL(16,10), porcentajeiesps13 DECIMAL(16,10), porcentajeiesps11 DECIMAL(16,10),   \
						porcentajeiesps3 DECIMAL(16,10), porcentajeiesps4 DECIMAL(16,10), porcentajeiesps9 DECIMAL(16,10),      \
						porcentajeiesps5 DECIMAL(16,10), porcentajeiesps6 DECIMAL(16,10), porcentajeiesps10 DECIMAL(16,10),    \
						porcentajeiva DECIMAL(16,10), porcentajeiesps DECIMAL(16,10), notacar VARCHAR(11), KEY (referencia),   \
						KEY (tracredito)) ENGINE = InnoDB");

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxtransac   \
						SELECT t.tracredito, t.concepto, t.destino, t.referencia, t.tipo, t.pago, t.valor,  \
								 va.totaloriginal AS valorvta, t.fechaapl, t.horamodi, va.porcentaje0,     \
								 va.porcentaje15, va.porcentaje16, va.porcentajesub0, va.porcentajesub15,  \
								 va.porcentajesub16, va.porcentajesubgrabado, va.porcentajesubtotal, va.porcclasifcont, \
								 va.porcentajeiva2, va.porcentajeiva8, va.porcentajeiesps12, va.porcentajeiesps13,  \
								 va.porcentajeiesps11, va.porcentajeiesps3, va.porcentajeiesps4,  va.porcentajeiesps9, \
								 va.porcentajeiesps5, va.porcentajeiesps6, va.porcentajeiesps10, va.porcentajeiva, \
								 va.porcentajeiesps, t.notacar \
						FROM ventasaux va, transxcob t         \
						WHERE t.aplicada=1 AND t.cancelada=0 AND t.referencia=va.referencia AND t.tipo<>'VENT'  \
						ORDER BY t.referencia, t.fechaapl, t.horamodi ");

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxtransacb LIKE auxtransac ");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxtransacb SELECT * FROM auxtransac ");
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxtransaccargo  \
						SELECT DISTINCT incar.porcentaje, t.referencia  \
						FROM ventasaux va   \
						INNER JOIN transxcob t ON t.referencia=va.referencia  \
						INNER JOIN notascarcli n ON n.referencia=t.notacar   \
						INNER JOIN impuestos incar ON incar.impuesto=n.cveimp \
						WHERE t.aplicada=1 AND t.cancelada=0 AND t.referencia=va.referencia"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxtransac2 (  \
						tracredito VARCHAR(11), concepto VARCHAR(1), destino VARCHAR(1), referencia VARCHAR(11), \
						tipo VARCHAR(4), pago VARCHAR(11), valor DECIMAL(16,2), valorvta DECIMAL(16,4),   \
						fechaapl DATE, horamodi TIME, porcentaje0 DECIMAL(16,4), porcentaje15 DECIMAL(16,10),  \
						porcentaje16 DECIMAL(16,10), porcentajesub0 DECIMAL(16,10), porcentajesub15 DECIMAL(16,10),  \
						porcentajesub16 DECIMAL(16,10), porcentajesubgrabado DECIMAL(16,10), porcentajesubtotal DECIMAL(16,10),  \
						porcclasifcont DECIMAL(16,10), porcentajeiva2 DECIMAL(16,10), porcentajeiva8 DECIMAL(16,10),   \
						porcentajeiesps12 DECIMAL(16,10), porcentajeiesps13 DECIMAL(16,10), porcentajeiesps11 DECIMAL(16,10),  \
						porcentajeiesps3 DECIMAL(16,10), porcentajeiesps4 DECIMAL(16,10), porcentajeiesps9 DECIMAL(16,10),  \
						porcentajeiesps5 DECIMAL(16,10), porcentajeiesps6 DECIMAL(16,10), porcentajeiesps10 DECIMAL(16,10),  \
						porcentajeiva DECIMAL(16,10), porcentajeiesps DECIMAL(16,10), notacar VARCHAR(11), pagado DECIMAL(16,4), \
						pagadosc DECIMAL(16,4), KEY (referencia), KEY (tracredito)) ENGINE = InnoDB;"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxtransac2 SELECT t.*,   \
						SUM(if(ADDTIME(t2.fechaapl,t2.horamodi) < ADDTIME(t.fechaapl,t.horamodi) OR (ADDTIME(t2.fechaapl,t2.horamodi) = ADDTIME(t.fechaapl,t.horamodi) AND t2.tracredito<t.tracredito), t2.valor,0)) AS pagado,  \
						SUM(if((ADDTIME(t2.fechaapl,t2.horamodi) < ADDTIME(t.fechaapl,t.horamodi) OR (ADDTIME(t2.fechaapl,t2.horamodi) = ADDTIME(t.fechaapl,t.horamodi) AND t2.tracredito<t.tracredito)) AND (t2.tipo='PAGO' OR t2.tipo='CHDE'), t2.valor,0)) AS pagadosc  \
						FROM auxtransac t, auxtransacb t2 WHERE t.referencia=t2.referencia GROUP BY t.referencia,t.tracredito"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf
		("CREATE TEMPORARY TABLE auxtransacAjuste (tracredito VARCHAR(11),pago VARCHAR(11), PRIMARY KEY (pago), KEY (tracredito)) ENGINE = INNODB"
		);
	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxtransacAjuste  \
						SELECT MIN(t.tracredito) AS tracredito1, t.pago \
						FROM auxtransac2 t WHERE t.pago IS NOT NULL GROUP BY t.pago"
		);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("CREATE TEMPORARY TABLE auxpagoclientes (  \
						referencia char(11),  \
						cargos DECIMAL(16,2),  \
						totpago DECIMAL(16,2), \
						subtotal DECIMAL(16,2), \
						totaliva DECIMAL(16,2),  \
						totaliesps DECIMAL(16,2), \
						primary key(referencia)) Engine = INNODB");

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("INSERT INTO auxpagoclientes  \
						SELECT pag.pago AS referencia, \
						@cargos:=if((t.valorvta+t.pagadosc+t.valor)<0,if((t.valorvta+t.pagadosc+t.valor)<t.valor,(t.valor), (t.valorvta+t.pagadosc+t.valor)), 0) AS cargos,  \
						@pago:= ABS(t.valor - @cargos) AS totpago,  \
						SUM(DISTINCT ABS(ROUND(@pago - (@pago*t.porcentajeiva + @pago*t.porcentajeiesps), 2))) AS subtotal, \
						SUM(DISTINCT ABS(ROUND(@pago*t.porcentajeiva,2))) AS totaliva,  \
						SUM(DISTINCT ABS(ROUND(@pago*t.porcentajeiesps,2))) AS totaliesps \
						FROM auxtransac2 t   \
						INNER JOIN ventas v   \
						INNER JOIN clientes cli \
						INNER JOIN pagoscli pag ON pag.pago=t.pago  \
						INNER JOIN terminales ter ON ter.terminal=v.terminal   \
						INNER JOIN secciones sec ON ter.seccion=sec.seccion   \
						INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal  \
						INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago  \
						LEFT JOIN auxtransaccargo n ON v.referencia=n.referencia  \
						LEFT JOIN cheqxcob chxc ON chxc.pago=pag.pago   \
						LEFT JOIN chequesclientes ch ON ch.chequecli=chxc.chequecli  \
                        LEFT JOIN cfd cfdv ON v.referencia=cfdv.referencia AND cfdv.tipocomprobante='VENT' \
						LEFT JOIN cfd cfdp ON pag.pago=cfdp.referencia AND cfdp.tipocomprobante='PAGO' AND cfdv.metodopago33='PPD' \
						WHERE sec.sucursal='%s' AND t.tipo='PAGO' AND t.referencia=v.referencia AND  \
						v.cliente=cli.cliente AND t.fechaapl>='%s' AND t.fechaapl<='%s'   \
                        AND suc.idempresa = %s \
						GROUP BY pag.pago ORDER BY suc.numid, pag.pago, t.horamodi, t.tracredito", sucursal , fecha_ini, fecha_fin, idempresa);

	if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
		instruccion.c_str()))
		throw(Exception("Error en query EjecutaSelectSqlNulo"));

	instruccion.sprintf("select cfd.folio, cfd.sucursal, cfd.monto, cfd.fechaaltamin, cfd.estado, cfd.referencia, \
					cfd.serie, cfd.ivarm, cfd.tipocomprobante, cfd.version, cfd.pactimbrador, cfd.muuid, \
					(CASE WHEN cfd.tipocomprobante='PAGO' THEN cs.sustituido WHEN cfd.tipocomprobante='VENT' THEN cs.sustituido ELSE 0 END) AS sustituido, \
					(CASE WHEN cfd.tipocomprobante='PAGO' THEN cs.fechasustitucion WHEN cfd.tipocomprobante='VENT' THEN cs.fechasustitucion ELSE 0 END) AS fechasustitucion, \
					(CASE WHEN cfd.tipocomprobante='PAGO' THEN cspor.referencia WHEN cfd.tipocomprobante='VENT' THEN csvta.referencia  ELSE 0 END) AS referenciasust,\
					(CASE WHEN cfd.tipocomprobante='PAGO' THEN cspor.muuid WHEN cfd.tipocomprobante='VENT' THEN csvta.muuid  ELSE 0 END) AS muuidsust, cfd.cfdirelacionado, cfd.motivocanc, \
					(CASE WHEN cfd.tipocomprobante = 'NCRE' THEN auxnocred.subtotal WHEN cfd.tipocomprobante = 'VENT' THEN auxved.subtotal WHEN cfd.tipocomprobante = 'PAGO' THEN auxpagocli.subtotal WHEN cfd.tipocomprobante = 'TICK' THEN (cfd.ticksubiva0 + cfd.ticksubiva0ieps + cfd.ticksubiva16 + cfd.ticksubiva16ieps) ELSE 0 END) AS subtotal, \
					(CASE WHEN cfd.tipocomprobante = 'NCRE' THEN auxnocred.totaliva WHEN cfd.tipocomprobante = 'VENT' THEN auxved.totaliva WHEN cfd.tipocomprobante = 'PAGO' THEN auxpagocli.totaliva WHEN cfd.tipocomprobante = 'TICK' THEN cfd.ivarm ELSE 0 END) AS totaliva, \
					(CASE WHEN cfd.tipocomprobante = 'NCRE' THEN auxnocred.totaliesps WHEN cfd.tipocomprobante = 'VENT' THEN auxved.totaliesps WHEN cfd.tipocomprobante = 'PAGO' THEN auxpagocli.totaliesps WHEN cfd.tipocomprobante = 'TICK' THEN (cfd.monto - (cfd.ticksubiva0 + cfd.ticksubiva0ieps + cfd.ticksubiva16 + cfd.ticksubiva16ieps) - cfd.ivarm) ELSE 0 END) AS totaliesps,  \
					 vc.mensaje AS razoncanc \
						from cfd \
						LEFT JOIN cfdsustitucion cs ON cfd.compfiscal=cs.compfiscal \
						LEFT JOIN cfd cspor ON cspor.compfiscal=cs.compfiscalsustituto \
						LEFT JOIN cfd csvta ON csvta.compfiscal=cs.compfiscalsustituto \
						LEFT JOIN ventas v ON cfd.referencia = v.referencia AND cfd.tipocomprobante = 'VENT' \
                        LEFT JOIN sucursales suc ON suc.sucursal = cfd.sucursal \
						LEFT JOIN ventascanceladas vc ON vc.referencia = v.referencia \
						LEFT JOIN auxventasdocumento auxved ON auxved.referencia = cfd.referencia AND cfd.tipocomprobante='VENT' \
						LEFT JOIN auxnotascredocumento auxnocred ON auxnocred.referencia = cfd.referencia AND cfd.tipocomprobante='NCRE' \
						LEFT JOIN auxpagoclientes auxpagocli ON auxpagocli.referencia = cfd.referencia AND cfd.tipocomprobante='PAGO' \
                        %s \
					where cfd.fechaaltamin between '%s' and '%s' %s %s %s %s %s %s %s \
						%s AND suc.idempresa = %s \
					order by cfd.fechaalta, cfd.serie, cfd.folio", join_cfdiweb,
		fecha_ini, fecha_fin, condicion_sucursal, condicion_tipo_comprobante,
		condicion_version, condicion_pac, condicion_edo_timbrado,
		condicion_edo_cfd, condicion_motivocanc, condicion_cfdiweb, idempresa);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

}

// ---------------------------------------------------------------------------
// ID_EJE_REPPREPAGO
void ServidorReportes::EjecutaRepPrepago(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, empresa, sucursal, cliente;
	AnsiString agente, banco, terminal, formadepago, estatus, detallado, tipo;
	AnsiString condicion_empresa = " ", condicion_sucursal = " ", condicion_cliente = " ";
	AnsiString condicion_agente = " ", condicion_banco = " ";
	AnsiString condicion_terminal = " ", condicion_formadepago = " ";
	AnsiString condicion_estatus = " ", condicion_tipo = " ";
	AnsiString identificador = " ", condicion_identificador = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	agente = mFg.ExtraeStringDeBuffer(&parametros);
	banco = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	formadepago = mFg.ExtraeStringDeBuffer(&parametros);
	estatus = mFg.ExtraeStringDeBuffer(&parametros);
	detallado = mFg.ExtraeStringDeBuffer(&parametros);
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	identificador = mFg.ExtraeStringDeBuffer(&parametros);

	if (empresa != " ") {
		condicion_empresa.sprintf(" AND suc.idempresa=%s ", empresa);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal='%s' ", sucursal);
	}

	if (cliente != " ") {
		condicion_cliente.sprintf(" AND cli.cliente = '%s' ", cliente);
	}

	if (agente != " ") {
		condicion_agente.sprintf(" AND e.empleado = '%s' ", agente);
	}

	if (banco != " ") {
		condicion_banco.sprintf(" AND p.banco = '%s' ", banco);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND p.terminal = '%s' ", terminal);
	}

	if (formadepago != " ") {
		condicion_formadepago.sprintf(" AND p.formapag IN(%s) ", formadepago);
	}

	if (estatus != " ") {
		condicion_estatus.sprintf(" AND p.cancelado=%s ", estatus);
	}

	if (tipo != " ") {
		condicion_tipo.sprintf(" AND p.aplicado=%s ", tipo);
	}

	if (identificador != " ") {
		condicion_identificador.sprintf(" AND p.identificador=%s ",
			identificador);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (detallado == "1") {
		instruccion.sprintf("SELECT \
		p.pago, \
		p.cliente, \
		cli.rsocial, \
		IF(p.formapag = 'E', 'Efectivo', IF(p.formapag = 'C', 'Cheque', IF(p.formapag = 'D', 'Deposito', 'Transferencia'))) AS formapago, \
		p.fecha, \
		CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS agente, \
		dp.factura, \
		dp.valor, \
		p.terminal, \
		b.nombre, \
		CONCAT(X(p.coordenadas),',',Y(p.coordenadas)), \
		p.aplicado, p.identificador \
		FROM prepagoscli p \
		INNER JOIN predpagoscli dp on dp.pago = p.pago \
		INNER JOIN clientes cli ON cli.cliente = p.cliente \
		INNER JOIN empleados e ON e.empleado = p.cobrador \
		INNER JOIN terminales t ON t.terminal = p.terminal \
		INNER JOIN secciones sec on sec.seccion = t.seccion \
		INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
		LEFT JOIN bancos b ON b.banco = p.banco \
		WHERE p.fecha BETWEEN '%s' AND '%s' %s %s %s %s %s %s %s %s %s %s \
		GROUP BY dp.pago, dp.factura \
		ORDER BY p.fecha DESC, p.hora DESC ", fechaini, fechafin, condicion_empresa,
			condicion_sucursal, condicion_cliente, condicion_agente,
			condicion_banco, condicion_terminal, condicion_formadepago,
			condicion_estatus, condicion_tipo, condicion_identificador);
	}
	else {
		instruccion.sprintf("SELECT \
		p.pago, \
		p.cliente, \
		cli.rsocial, \
		IF(p.formapag = 'E', 'Efectivo', IF(p.formapag = 'C', 'Cheque', IF(p.formapag = 'D', 'Deposito', 'Transferencia'))) AS formapago, \
		p.fecha, \
		CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS agente, \
		p.valor AS totalpago, \
		p.terminal, \
		b.nombre, \
		CONCAT(X(p.coordenadas),',',Y(p.coordenadas)), \
		p.aplicado, p.identificador, \
		canc.nombre AS motivocancel \
		FROM prepagoscli p \
		INNER JOIN clientes cli ON cli.cliente = p.cliente \
		INNER JOIN empleados e ON e.empleado = p.cobrador \
		INNER JOIN terminales t ON t.terminal = p.terminal \
		INNER JOIN secciones sec on sec.seccion = t.seccion \
        INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
		LEFT JOIN bancos b ON b.banco = p.banco \
		LEFT JOIN catalogocancelprepagos canc ON canc.id = p.motivocancela \
		WHERE p.fecha BETWEEN '%s' AND '%s' %s %s %s %s %s %s %s %s %s %s \
		ORDER BY p.fecha DESC, p.hora DESC ", fechaini, fechafin, condicion_empresa,
			condicion_sucursal, condicion_cliente, condicion_agente,
			condicion_banco, condicion_terminal, condicion_formadepago,
			condicion_estatus, condicion_tipo, condicion_identificador);
	}

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPBITAPREPAGO
void ServidorReportes::EjecutaRepBitacoraPrepago(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, empresa, sucursal;
	AnsiString condicion_empresa = " ", condicion_sucursal = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);

	if (empresa != " ") {
		condicion_empresa.sprintf(" AND suc.idempresa=%s ", empresa);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND sec.sucursal='%s' ", sucursal);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
	b.referencia, \
	b.cliente, \
	cli.rsocial, \
	b.tipo, \
	b.estatus, \
	b.valor, \
	b.fecha, \
	b.hora, \
	b.terminal, \
	CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS empleado \
	FROM bitacoraprepagos b \
	INNER JOIN clientes cli ON cli.cliente = b.cliente \
	INNER JOIN empleados e ON e.empleado = b.usuario \
	INNER JOIN terminales t ON t.terminal = b.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
    INNER JOIN sucursales suc on suc.sucursal = sec.sucursal \
	WHERE b.fecha BETWEEN '%s' AND '%s' %s %s \
	ORDER BY b.fecha DESC, b.hora DESC ", fechaini, fechafin,  condicion_empresa,
		condicion_sucursal);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_ENVIOEMAILPREPAGOS
void ServidorReportes::EjecutaEnvioCorreoPrepagos(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString email, email2, bodyMsg, idEnvio, nomPDF, nomAdj;
	AnsiString pdf64, adj64;
	BufferRespuestas* resp_envio = NULL;

	AnsiString nomremitente, emailcfd, hostsmtp, portsmtp, usersmtp, passsmtp;
	BufferRespuestas* resp_config_cfd = NULL;

	idEnvio = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT cc.pdf, cc.nombrepdf, cc.adjunto, \
		cc.nombreadjunto, cc.mensaje, cc.email, cc.email2 \
		FROM prepagoscorreos cc \
		WHERE cc.idcorreos=%s ", idEnvio);

	if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
		instruccion.c_str(), resp_envio))
		throw Exception("ERROR AL CONSULTAR!");

	for (int i = 0; i < resp_envio->ObtieneNumRegistros(); i++) {
		resp_envio->IrAlRegistroNumero(i);
		pdf64 = resp_envio->ObtieneDato("pdf");
		nomPDF = resp_envio->ObtieneDato("nombrepdf");
		adj64 = resp_envio->ObtieneDato("adjunto");
		nomAdj = resp_envio->ObtieneDato("nombreadjunto");
		bodyMsg = resp_envio->ObtieneDato("mensaje");
		email = resp_envio->ObtieneDato("email");
		email2 = resp_envio->ObtieneDato("email2");
	}

	// Obtener los streams de los adjuntos
	TMemoryStream *memStreamBMP = NULL, *memStreamPDF = NULL;

	memStreamPDF = new TMemoryStream();
	TBytes bytes_pdf64 = DecodeBase64(pdf64);
	memStreamPDF->WriteBuffer(&bytes_pdf64[0], bytes_pdf64.Length);
	memStreamPDF->Seek(0, soFromBeginning);

	memStreamBMP = new TMemoryStream();
	TBytes bytes_adj64 = DecodeBase64(adj64);
	memStreamBMP->WriteBuffer(&bytes_adj64[0], bytes_adj64.Length);
	memStreamBMP->Seek(0, soFromBeginning);

	// Se envia el CFD al correo del cliente
	TIdMessage *msg = NULL;
	TIdSMTP *smtp = NULL;
	TIdAttachmentMemory *attach_logo = NULL;
	TIdAttachmentMemory *attach_pdf = NULL;
	TIdText *idtext = NULL;
	TIdSSLIOHandlerSocketOpenSSL *IdSSLIOHandlerSocketOpenSSL1 = NULL;

#ifdef _DEBUG
	TIdLogFile *IdLogFile1 = NULL;
#endif

	try {

		try {

			// Consulta de parametroscfd
			instruccion.sprintf
				("select p.* from parametroscfd p where p.sucursal='%s'",
				FormServidor->ObtieneClaveSucursal());
			if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), resp_config_cfd))
				throw Exception("ERROR AL CONSULTAR!");
			for (int y = 0; y < resp_config_cfd->ObtieneNumRegistros(); y++) {
				emailcfd = resp_config_cfd->ObtieneDato("emailenviocfd");
				nomremitente = resp_config_cfd->ObtieneDato("nomenviocfd");
				hostsmtp = resp_config_cfd->ObtieneDato("hostsmtp");
				portsmtp = resp_config_cfd->ObtieneDato("portsmtp");
				usersmtp = resp_config_cfd->ObtieneDato("usersmtp");
				passsmtp = resp_config_cfd->ObtieneDato("passsmtp");
			}

			// Configuracion del componente TIdSMTP
			smtp = new TIdSMTP(NULL);
			smtp->MailAgent = "Indy10";
			smtp->PipeLine = false;
			smtp->UseEhlo = true;
			smtp->UseVerp = false;

			if (hostsmtp.Pos("amazon") > 0) {

				IdSSLIOHandlerSocketOpenSSL1 =
					new TIdSSLIOHandlerSocketOpenSSL(NULL);
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Method =
					Idsslopenssl::sslvSSLv23;
				IdSSLIOHandlerSocketOpenSSL1->SSLOptions->Mode =
					Idsslopenssl::sslmClient;
				smtp->IOHandler = IdSSLIOHandlerSocketOpenSSL1;
				smtp->UseTLS = utUseExplicitTLS;

			}
			else {

				smtp->UseTLS = utNoTLSSupport;

			}

			smtp->ConnectTimeout = (1000 * 30);
			smtp->ReadTimeout = (1000 * 60);

			smtp->AuthType = satDefault;
			smtp->Host = hostsmtp;
			smtp->Username = usersmtp;
			smtp->Password = passsmtp;
			smtp->Port = portsmtp.ToInt();

			// Configuracion del componente TIdMessage
			msg = new TIdMessage(NULL);
			msg->ExceptionOnBlockedAttachments = false;
			msg->NoDecode = false;
			msg->NoEncode = false;
			msg->UseNowForDate = true;

			// Configuracion del componente TIdLogFile
#ifdef _DEBUG
			IdLogFile1 = new TIdLogFile(NULL);
			IdLogFile1->Filename = ExtractFilePath(Application->ExeName) +
				"\\maillogfile.log";
			IdLogFile1->Active = true;
			IdLogFile1->LogTime = false;
			IdLogFile1->ReplaceCRLF = true;
			smtp->Intercept = IdLogFile1;
#endif

			// ENVIO DEL CFD
			msg->Clear();
			msg->MessageParts->Clear();

			msg->From->Address = emailcfd;
			msg->From->Name = nomremitente;
			msg->Sender->Address = emailcfd;
			msg->Sender->Name = nomremitente;
			msg->ReplyTo->EMailAddresses = emailcfd;
			msg->Recipients->EMailAddresses = email;
			if (email2 != "" && email2 != "@" && mFg.ValidaEmail(email2,
				false) && email2 != email)
				msg->CCList->EMailAddresses = email2;
			msg->Priority = mpNormal;
			msg->Subject = "Entrega de su recibo de pago de La Violeta";
			msg->ContentType = "multipart/mixed";
			msg->ClearBody();
			msg->IsEncoded = true;
			msg->AttachmentEncoding = "MIME";
			msg->Encoding = meMIME;
			msg->ConvertPreamble = true;
			msg->CharSet = "UTF-8";

			idtext = new TIdText(msg->MessageParts, NULL);
			idtext->ContentType = "text/html";
			idtext->ContentDescription = "multipart-1";
			idtext->CharSet = "UTF-8";
			idtext->ContentTransfer = "8bit";
			idtext->Body->Clear();
			idtext->Body->Add(UTF8String(bodyMsg));

			attach_logo = new TIdAttachmentMemory(msg->MessageParts,
				memStreamBMP);
			attach_logo->FileName = nomAdj;
			attach_logo->ContentType = "image/jpeg";
			attach_logo->ContentDisposition = "inline";
			attach_logo->ExtraHeaders->Add("Content-ID:<violeta.jpg>");

			attach_pdf = new TIdAttachmentMemory(msg->MessageParts,
				memStreamPDF);
			attach_pdf->FileName = nomPDF + ".pdf";
			attach_pdf->ContentType = "application/pdf";
			attach_pdf->ContentDisposition = "attachment";

			smtp->Connect();
			smtp->Authenticate();
			smtp->Send(msg);
			smtp->Disconnect();

			AnsiString sqlinstruccion;
			sqlinstruccion.sprintf
				("update prepagoscorreos set enviado=1, fechahoraenv='%s %s' where idcorreos='%s'",
				mFg.DateToMySqlDate(Now()), mFg.TimeToMySqlTime(Now()),
				idEnvio);
			if (!mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
				sqlinstruccion.c_str()))
				throw(Exception("Error en query EjecutaSelectSqlNulo"));

		}
		catch (Exception &e) {
			mServidorVioleta->MuestraMensajeError
				("ERROR al enviar correo: " + e.Message);
			throw Exception("ERROR AL ENVIAR CORREO!" + e.Message);
		}

	}
	__finally {
#ifdef _DEBUG
		if (IdLogFile1 != NULL) {
			IdLogFile1->Close();
			delete IdLogFile1;
		}
#endif

		if (smtp != NULL)
			delete smtp;
		if (idtext != NULL)
			delete idtext;
		if (msg != NULL)
			delete msg;

		if (IdSSLIOHandlerSocketOpenSSL1 != NULL)
			delete IdSSLIOHandlerSocketOpenSSL1;
		if (resp_envio != NULL)
			delete resp_envio;
		if (resp_config_cfd != NULL)
			delete resp_config_cfd;
		if (memStreamPDF != NULL)
			delete memStreamPDF;
		if (memStreamBMP != NULL)
			delete memStreamBMP;

	}

}

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// ID_EJE_REPERROR_TIMBRADO
void ServidorReportes::EjecutaRepErroresTimbrado(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, cliente, cod_error, desc_error,
		version, edo_timbrado, pac, pac_error, estado_cfd, tipo_comprobante, empresa;
	AnsiString condicion_sucursal = " ", condicion_cliente = " ",
		condicion_cod_error = " ", condicion_des_error = " ",
		condicion_edo_timbrado = " ", condicion_version = " ", condicion_pac =
		" ", condicion_pac_error = " ", condicion_edo_cfd = " ",
		condicion_tipo_comprobante = " ";
	AnsiString condicion_empresa = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	cliente = mFg.ExtraeStringDeBuffer(&parametros);
	cod_error = mFg.ExtraeStringDeBuffer(&parametros);
	desc_error = mFg.ExtraeStringDeBuffer(&parametros);
	version = mFg.ExtraeStringDeBuffer(&parametros);
	edo_timbrado = mFg.ExtraeStringDeBuffer(&parametros);
	pac = mFg.ExtraeStringDeBuffer(&parametros);
	pac_error = mFg.ExtraeStringDeBuffer(&parametros);
	estado_cfd = mFg.ExtraeStringDeBuffer(&parametros);
	tipo_comprobante = mFg.ExtraeStringDeBuffer(&parametros);
    empresa = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND cfd.sucursal='%s' ", sucursal);
	}
	if (cliente != " ") {
		condicion_cliente.sprintf(" AND c.cliente='%s' ", cliente);
	}

	if (cod_error != " ") {
		if (cod_error != "dif") {
			condicion_cod_error.sprintf(" AND bet.codigo_error='%s' ", cod_error);
		} else {
			condicion_cod_error.sprintf(" AND cme.codigo_error IS NULL ");
		}
	}
	if (desc_error != " ") {
		condicion_des_error.sprintf(" AND bet.desc_cod_error LIKE '%%%s%%' ",
			desc_error);
	}
	if (version != " ") {
		condicion_version.sprintf(" AND cfd.version = '%s' ", version);
	}

	if (edo_timbrado == "timbrados") {
		condicion_version = " AND cfd.version IN ('3.2','3.3','4.0') ";
		condicion_edo_timbrado = " AND length(ifnull(cfd.muuid,'')) = 36 ";
	}
	else if (edo_timbrado == "pendientes") {
		condicion_version = " AND cfd.version IN ('3.2','3.3','4.0') ";
		condicion_edo_timbrado = " AND length(ifnull(cfd.muuid,'')) <> 36 ";
	}
	if (pac != " ") {
		condicion_pac.sprintf(" AND cfd.pactimbrador = %d ", StrToInt(pac));
	}
	if (pac_error != " ") {
		condicion_pac_error.sprintf(" AND bet.pac = '%s' ", pac_error);
	}

	if (estado_cfd == "0") {
		condicion_edo_cfd = " AND cfd.estado = 1 ";
	}
	else if (estado_cfd == "1") {
		condicion_edo_cfd = " AND cfd.estado = 0 ";
	}
	else if (estado_cfd == "2") {
		condicion_edo_cfd =
			" AND cfd.estado = 0 AND cfd.tipocomprobante = 'PAGO' AND cs.sustituido = 0 ";
	}
	else if (estado_cfd == "3") {
		condicion_edo_cfd =
			" AND cfd.estado = 0 AND cfd.tipocomprobante = 'PAGO' AND cs.sustituido = 1 ";
	}

	if (tipo_comprobante != " ") {
		condicion_tipo_comprobante.sprintf(" AND cfd.tipocomprobante='%s' ",
			tipo_comprobante);
	}

    condicion_empresa.sprintf(" AND suc.idempresa = %s ", empresa);

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
	// IF(bet.pendiente_timbrar=1, 'Si', IF(bet.pendiente_timbrar=2, 'Sin resolver', 'No')) AS pendiente_timbrar
	instruccion.sprintf(" SELECT bet.fecha, bet.hora, cfd.sucursal, cfd.seriefolio,c.rsocial, \
	 bet.compfiscal, bet.codigo_error, bet.desc_cod_error, bet.pac, cfd.pactimbrador, cfd.muuid, \
	  cfd.version, cfd.estado, cfd.tipocomprobante, cfd.pactimbrador,  \
	  (CASE WHEN cfd.tipocomprobante='PAGO' THEN cs.sustituido WHEN cfd.tipocomprobante='VENT' THEN cs.sustituido ELSE 0 END) AS sustituido \
	 FROM bitacoracfditimbrado bet \
	 INNER JOIN cfd ON cfd.compfiscal = bet.compfiscal \
     INNER JOIN sucursales suc ON suc.sucursal = cfd.sucursal \
	 LEFT JOIN cfdsustitucion cs ON cfd.compfiscal=cs.compfiscal \
	 LEFT JOIN clientes c ON c.rfc = cfd.rfcreceptor AND c.rfc <> 'XAXX010101000' \
     LEFT JOIN ccfdimatrizerrores cme ON cme.codigo_error=bet.codigo_error \
	 WHERE bet.fecha BETWEEN '%s' AND '%s' %s %s %s %s %s %s %s %s %s %s %s \
	 GROUP BY bet.idbitcfditimb \
	 ORDER BY bet.fecha DESC, bet.hora DESC ", fechaini, fechafin,
		condicion_sucursal, condicion_cliente, condicion_cod_error,
		condicion_des_error, condicion_version, condicion_edo_timbrado,
		condicion_pac, condicion_edo_cfd, condicion_tipo_comprobante,
        condicion_empresa, condicion_pac_error);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// ID_CON_RESUMEN_CORTECAJA
void ServidorReportes::EjecutaRepResumenCorteCaja(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString corte;
	corte = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf(" SELECT t.descripcion, IFNULL(t.cantidad,0) AS cantidad, t.orden \
	FROM ( \
	(SELECT \
		'Retiro de Efectivo' AS descripcion, \
		SUM(m.cantretirado) AS cantidad, \
		1 AS orden \
	FROM movsefectivocaja m \
	INNER JOIN catalogomovscaja catmc ON catmc.clave = m.conceptomovs \
	WHERE m.conceptomovs IN ('RETEFE') AND m.corte = '%s' \
	GROUP BY m.conceptomovs \
	ORDER BY m.conceptomovs DESC \
	) UNION ALL ( \
	SELECT \
		'Disp Efectivo Clientes' AS descripcion, \
		SUM(m.cantretirado) AS cantidad, \
		1 AS orden \
	FROM movsefectivocaja m \
	INNER JOIN catalogomovscaja catmc ON catmc.clave = m.conceptomovs \
	WHERE m.conceptomovs IN ('REFECL') AND m.corte = '%s' \
	GROUP BY m.conceptomovs \
	ORDER BY m.conceptomovs DESC \
	) UNION ALL ( \
	SELECT \
		'Pago de servicios' AS descripcion, \
		SUM(m.cantretirado) AS cantidad, \
		1 AS orden \
	FROM movsefectivocaja m \
	INNER JOIN catalogomovscaja catmc ON catmc.clave = m.conceptomovs \
	WHERE m.conceptomovs IN ('DPGSER') AND m.corte = '%s' \
	GROUP BY m.conceptomovs \
	ORDER BY m.conceptomovs DESC \
	) UNION ALL ( \
	SELECT \
		'Cobro Pinpad' AS descripcion, \
		SUM(df.valor) AS cantidad, \
		2 AS orden \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
	WHERE v.cancelado = 0 \
	AND fp.termino = 'TARCR' \
	AND v.corte = '%s' \
	AND df.trn_id IS NOT NULL \
	GROUP BY fp.termino \
	) UNION ALL ( \
	SELECT \
		'Cobro TPV' AS descripcion, \
		SUM(df.valor) AS cantidad, \
		3 AS orden \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
	WHERE v.cancelado = 0 \
	AND fp.termino = 'TARCR' \
	AND v.corte = '%s' \
	AND df.trn_id IS NULL \
	GROUP BY fp.termino \
	) UNION ALL ( \
	SELECT \
		CONCAT(UCASE(LEFT(fp.descripcion, 1)),LCASE(SUBSTRING(fp.descripcion, 2))) AS descripcion, \
		SUM(df.valor) AS cantidad, \
		4 AS orden \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
	WHERE v.cancelado = 0 \
	AND fp.termino NOT IN('TARCR') AND fp.formapag != 'FCONEF' \
	AND v.corte = '%s' \
	GROUP BY df.formapag \
	) UNION ALL ( \
	SELECT \
		'Ventas a Crédito' AS descripcion, \
		SUM(df.valor) AS cantidad, \
		5 AS orden \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
	WHERE v.acredito = 1 \
	AND v.cancelado = 0 \
	AND v.corte = '%s' \
	AND tp.terminoreal = 1 \
	) UNION ALL ( \
	SELECT \
		'Cobranza Efectivo' AS descripcion, \
		SUM(t.valor)*-1 AS cantidad, \
		6 AS orden \
	FROM ventas v \
	INNER JOIN transxcob t ON t.referencia = v.referencia \
	INNER JOIN pagoscli p ON p.pago = t.pago \
	INNER JOIN terminales ter ON ter.terminal = p.terminal \
	INNER JOIN secciones s ON s.seccion = ter.seccion \
	WHERE p.cancelado = 0 \
	AND t.aplicada = 1 \
	AND t.cancelada = 0 \
	AND p.formapag = 'E' \
	AND v.corte = '%s' \
	) UNION ALL ( \
	SELECT \
		'Recargas de celular' AS descripcion, \
		SUM(dv.cantidad*dv.precioimp) AS cantidad, \
		8 AS orden \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN dventas dv ON dv.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN articulos a ON a.articulo = dv.articulo \
	INNER JOIN productos prod ON prod.producto = a.producto \
	WHERE prod.nombre LIKE '%%RECARGAS%%' \
	AND a.activo = 1 \
	AND v.cancelado = 0 \
	AND v.corte = '%s' \
	) UNION ALL ( \
	SELECT \
		'Cobranza Elect.' AS descripcion, \
		SUM(t.valor)*-1 AS cantidad, \
		7 AS orden \
	FROM ventas v \
	INNER JOIN transxcob t ON t.referencia = v.referencia \
	INNER JOIN pagoscli p ON p.pago = t.pago \
	WHERE p.cancelado = 0 \
	AND t.aplicada = 1 \
	AND t.cancelada = 0 \
	AND p.formapag != 'E' \
	AND v.corte = '%s' \
	)) t \
	GROUP BY t.descripcion \
	ORDER BY t.orden ",
	corte, corte, corte,
	corte, corte, corte,
	corte, corte, corte,
	corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT \
	v.referencia, \
	v.valor, \
	IF(v.ticket = 1,'Ticket','Factura') AS tipo, \
	v.fechamodi, \
	CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS nombre \
	FROM ventas v \
	INNER JOIN empleados e ON e.empleado = v.usumodi \
	WHERE v.corte = '%s' AND v.cancelado = 1 ", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ---------------------------------------------------------------------------
// ID_CON_TICKET_CORTECAJA
void ServidorReportes::EjecutaRepTicketCorteCaja(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString corte;
	corte = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT MIN(v.referencia) AS folioini, MAX(v.referencia) foliofin \
	FROM ventas v \
	WHERE v.corte = '%s'", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT CONCAT(fechaapertura,' De ',horaapertura,' - ',horacierre) AS fecha \
	FROM cortesdecaja \
	WHERE referencia = '%s' ", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT t.tipo, SUM(t.total) as total FROM (( \
	SELECT \
	'TICKET' AS tipo, \
	SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 1 AS orden \
	FROM ventas v \
	INNER JOIN dventas dv ON dv.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	WHERE v.acredito = 0 AND v.ticket = 1 AND v.cancelado = 0 \
	AND fp.formapag = 'FCONEF' \
	AND v.corte = '%s' \
	GROUP BY v.ticket \
	) UNION ALL ( \
	SELECT \
	'FACTURA' AS tipo, \
	SUM((dv.precioimp*dv.cantidad)*df.porcentaje) AS total, 2 AS orden \
	FROM ventas v \
	INNER JOIN dventas dv ON dv.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	WHERE v.acredito = 0 AND v.ticket = 0  AND v.cancelado = 0 \
	AND fp.formapag = 'FCONEF' \
	AND v.corte = '%s' \
	GROUP BY v.ticket \
	) UNION ALL ( \
	SELECT IF(m.concepto='D', CONCAT('D', '-', cm.descripcion), CONCAT('R', '-', cm.descripcion)) AS tipo, (m.cantretirado) AS total, 3 AS orden \
	FROM movsefectivocaja m \
	INNER JOIN terminales t ON t.terminal = m.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
	WHERE m.corte = '%s' \
	ORDER BY m.concepto \
	)) t \
	GROUP BY t.tipo \
	ORDER BY t.orden ASC ", corte, corte, corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT IF(m.concepto='D', CONCAT('D', '-', cm.descripcion), CONCAT('R', '-', cm.descripcion)) AS concepto, (m.cantretirado) AS cantidad \
	FROM movsefectivocaja m \
	INNER JOIN terminales t ON t.terminal = m.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs \
	WHERE m.corte = '%s' \
	ORDER BY m.concepto ", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT t.tipo, SUM(t.numoperaciones), t.total FROM (( \
	SELECT \
	'TARJETA CRED.' AS tipo, \
	COUNT(df.formapag) AS numoperaciones, \
	SUM(df.valor) AS total \
	FROM ventas v \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	WHERE v.acredito = 0 AND v.cancelado = 0 \
	AND v.corte = '%s' AND fp.formapag = 'FTARCR' \
	) UNION ALL ( \
	SELECT \
	'TARJETA DEBI.' AS tipo, \
	COUNT(df.formapag) AS numoperaciones, \
	SUM(df.valor) AS total \
	FROM ventas v \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	WHERE v.acredito = 0 AND v.cancelado = 0 \
	AND v.corte = '%s' AND fp.formapag = 'FTARDE' \
	)) t GROUP BY t.tipo ", \
 corte, corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT \
	'CREDITO' AS tipo, \
	SUM(df.valor) AS total \
	FROM ventas v \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	WHERE v.acredito = 1 AND v.cancelado = 0 \
	AND v.corte = '%s' AND fp.formapag = 'FCREDI'  ", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);

	instruccion.sprintf("SELECT \
		fp.descripcion AS tipo, \
		SUM(df.valor) AS total \
	FROM ventas v FORCE INDEX(corte) \
	INNER JOIN dventasfpago df ON df.referencia = v.referencia \
	INNER JOIN terminales t ON t.terminal = v.terminal \
	INNER JOIN secciones s ON s.seccion = t.seccion \
	INNER JOIN clientes cli ON cli.cliente = v.cliente \
	INNER JOIN formasdepago fp ON fp.formapag = df.formapag \
	INNER JOIN terminosdepago tp ON tp.termino = fp.termino \
	WHERE v.cancelado = 0 \
	AND fp.formapag = 'TRANS' \
	AND v.corte = '%s' ", corte);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_PCAD
void ServidorReportes::EjecutaRepPCAD(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	int i = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
    AnsiString fechaini = " ", fechafin = " ";

	AnsiString archivo_temp1 = " ";
	AnsiString archivo_temp2 = " ";
	AnsiString archivo_temp3 = " ";
	AnsiString archivo_temp4 = " ";
	AnsiString archivo_temp5 = " ";
	AnsiString archivo_temp6 = " ";
	AnsiString archivo_temp7 = " ";
    AnsiString archivo_temp8 = " ";


    fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));


	try{
		instruccion = "create temporary table ventasaux (\
			referencia char(11), articulo VARCHAR(9),totaloriginal decimal(16,4),\
			totaltodo decimal(16,4),total0 decimal(16,4),total15 decimal(16,4),\
			total16 decimal(16,4),subnograbado decimal(16,4),subtotal15 decimal(16,4),\
			subtotal16 decimal(16,4),subgrabado decimal(16,4),subtotal decimal(16,4),\
			totclasifcont decimal(16,4),totaliva2 decimal(16,4),totaliva8 decimal(16,4),\
			totaliesps12 decimal(16,4),totaliesps13 decimal(16,4),totaliesps11 decimal(16,4),\
			totaliesps3 decimal(16,4),totaliesps4 decimal(16,4),totaliesps9 decimal(16,4),\
			totaliesps5 decimal(16,4),totaliesps6 decimal(16,4),totaliesps10 decimal(16,4),\
			totaliva decimal(16,4),totaliesps decimal(16,4),valor decimal(16,4),\
			porcentaje0 decimal(16,10),porcentaje15 decimal(16,10),\
			porcentaje16 decimal(16,10),porcentajesub0 decimal(16,10),\
			porcentajesub15 decimal(16,10),porcentajesub16 decimal(16,10),\
			porcentajesubgrabado decimal(16,10),porcentajesubtotal decimal(16,10),\
			porcclasifcont decimal(16,10),porcentajeiva2 decimal(16,10),\
			porcentajeiva8 decimal(16,10),porcentajeiesps12 decimal(16,10),\
			porcentajeiesps13 decimal(16,10),porcentajeiesps11 decimal(16,10),\
			porcentajeiesps3 decimal(16,10),porcentajeiesps4 decimal(16,10),\
			porcentajeiesps9 decimal(16,10),porcentajeiesps5 decimal(16,10),\
			porcentajeiesps6 decimal(16,10),porcentajeiesps10 decimal(16,10),\
			porcentajeiva decimal(16,10),porcentajeiesps decimal(16,10),\
			stotaltodo decimal(16,4),PRIMARY KEY (referencia,articulo)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table referenciasaux (\
			referencia char(11), PRIMARY KEY (referencia)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select v.referencia\
			from ventas v,transxcob t,terminales ter,secciones sec,\
			sucursales suc where t.aplicada=1 and t.fechaapl>='%s'\
			and t.fechaapl<='%s' and t.cancelada=0 and t.tipo='PAGO'\
			and v.cancelado=0 and v.fechavta>='1900-01-01'\
			and v.fechavta<='2099-01-01' and t.referencia=v.referencia\
			AND v.terminal=ter.terminal and ter.seccion=sec.seccion\
			and suc.sucursal=sec.sucursal AND suc.idempresa = %s\
			group by v.referencia INTO OUTFILE '%s'",
			fechaini,fechafin, FormServidor->ObtieneClaveEmpresa(),
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table referenciasaux",archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE dnotascredcliaux (\
			venta CHAR(11), articulo VARCHAR(9), cantidad DECIMAL(12,3),\
			precio DECIMAL(16,6), precioimp DECIMAL(16,6),\
			PRIMARY KEY (venta, articulo)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select v.referencia as venta,\
			d.articulo, sum(if(n.tipo='0',d.cantidad,0)) as cantidad,\
			sum(if(n.tipo<>'0',d.precio,0)) as precio,\
			sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp \
			from notascredcli n, dnotascredcli d, ventas v,\
			referenciasaux ra where n.venta=v.referencia\
			and n.cancelado=0 and v.cancelado=0\
			and ra.referencia=v.referencia and n.referencia=d.referencia\
			group by v.referencia, d.articulo INTO OUTFILE '%s'",
			archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table dnotascredcliaux",archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE TotalNotascredCliaux ( \
			venta CHAR(11), valor DECIMAL(16,2),\
			PRIMARY KEY (venta)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT n.venta,sum(valor) FROM notascredcli n\
			INNER JOIN referenciasaux ra ON n.venta=ra.referencia\
			WHERE n.cancelado=0 GROUP BY  n.venta INTO OUTFILE '%s'",
			archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table TotalNotascredCliaux",archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT v.referencia, dv.articulo, SUM((dv.precioimp)*(dv.cantidad)) AS totaloriginal,\
			SUM((dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0))) AS totaltodo,\
			SUM(if(	(NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0) AND NOT \
			(IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)),\
			(dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS total0,\
			SUM(if(	((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR\
			(i4.tipoimpu='IVA' AND i4.porcentaje=15.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 	0)) AS total15,\
			SUM(if(	((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR \
			(i4.tipoimpu='IVA' AND i4.porcentaje=16.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 	0)) AS total16,\
			SUM(@subnograbado:=if(	(NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0)\
			AND NOT (IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)),\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),				 0)) AS subnograbado,\
			SUM(@subtotal15:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR 	(i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR\
			(i4.tipoimpu='IVA' AND i4.porcentaje=15.00)), 	(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 	0)) AS subtotal15,\
			SUM(@subtotal16:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR 	(i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR 	(i4.tipoimpu='IVA' AND\
			i4.porcentaje=16.00)), 	(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 	0)) AS subtotal16,\
			SUM(@subgrabado:=@subtotal15+@subtotal16) AS subgrabado, SUM(@subtotal:=@subtotal15+@subtotal16+@subnograbado) AS subtotal,\
			0 AS totclasifcont, SUM(if(i1.impuesto=2,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=2,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva2,\
			(if(i1.impuesto=8, (dv.precio- IFNULL(sum(dn.precio),0))*(dv.cantidad- IFNULL(sum(dn.cantidad),0))*(i1.porcentaje/100), 0) + if(i2.impuesto=8,\
			(dv.precio- IFNULL(sum(dn.precio),0))*(dv.cantidad- IFNULL(sum(dn.cantidad),0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva8,\
			SUM(if(i1.impuesto=12, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=12,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps12, SUM(if(i1.impuesto=13,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=13,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps13, SUM(if(i1.impuesto=11,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=11,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps11, SUM(if(i1.impuesto=3,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=3, (dv.\
			precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps3, SUM(if(i1.impuesto=4,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=4,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps4, SUM(if(i1.impuesto=9, \
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=9,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps9, SUM(if(i1.impuesto=5,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=5,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps5, SUM(if(i1.impuesto=6, (dv.precio- IFNULL(dn.\
			precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=6,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS\
			totaliesps6, SUM(if(i1.impuesto=10, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=10,\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps10,\
			SUM(if(i1.tipoimpu='IVA',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.tipoimpu='IVA',\
			(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva,\
			SUM(if(i1.tipoimpu='IESPS',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0)) AS totaliesps\
			FROM referenciasaux ra\
			INNER JOIN ventas v ON v.referencia = ra.referencia\
			INNER JOIN dventas dv ON v.referencia = dv.referencia \
			LEFT JOIN dnotascredcliaux dn ON dn.articulo=dv.articulo AND dn.venta=v.referencia\
			LEFT JOIN impuestos i1 ON i1.impuesto=dv.claveimp1\
			LEFT JOIN impuestos i2 ON i2.impuesto=dv.claveimp2\
			LEFT JOIN impuestos i3 ON i3.impuesto=dv.claveimp3\
			LEFT JOIN impuestos i4 ON i4.impuesto=dv.claveimp4 \
			GROUP BY v.referencia,dv.articulo\
			ORDER BY v.referencia into outfile '%s'",archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table ventasaux\
			(referencia, articulo, totaloriginal, totaltodo, total0, total15, total16,\
			subnograbado,subtotal15,subtotal16,subgrabado,subtotal, totclasifcont,\
			totaliva2, totaliva8, totaliesps12, totaliesps13, totaliesps11, totaliesps3, totaliesps4,\
			totaliesps9, totaliesps5, totaliesps6,\
			totaliesps10, totaliva, totaliesps)",archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "update ventasaux set valor=totaltodo,\
			porcentaje0=total0/(totaltodo), porcentaje15=total15/(totaltodo),\
			porcentaje16=total16/(totaltodo),\
			porcentajesub0=subnograbado/(totaltodo),\
			porcentajesub15=subtotal15/(totaltodo),\
			porcentajesub16=subtotal16/(totaltodo), \
			porcentajesubgrabado=subgrabado/(totaltodo),\
			porcentajesubtotal=subtotal/(totaltodo),\
			porcclasifcont=totclasifcont/(totaltodo),\
			porcentajeiva2=totaliva2/(totaltodo),\
			porcentajeiva8=totaliva8/(totaltodo),\
			porcentajeiesps12=totaliesps12/(totaltodo),\
			porcentajeiesps13=totaliesps13/(totaltodo),\
			porcentajeiesps11=totaliesps11/(totaltodo),\
			porcentajeiesps3=totaliesps3/(totaltodo),\
			porcentajeiesps4=totaliesps4/(totaltodo),\
			porcentajeiesps9=totaliesps9/(totaltodo),\
			porcentajeiesps5=totaliesps5/(totaltodo),\
			porcentajeiesps6=totaliesps6/(totaltodo),\
			porcentajeiesps10=totaliesps10/(totaltodo),\
			porcentajeiva=totaliva/(totaltodo),\
			porcentajeiesps=totaliesps/(totaltodo)\
			where totaltodo<>0";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "update ventasaux set \
			valor=totaltodo, porcentaje0=0, porcentaje15=0,\
			porcentaje16=0, porcentajesub0=0, porcentajesub15=0,\
			porcentajesub16=0, porcentajesubgrabado=0,\
			porcentajesubtotal=0, porcclasifcont=0,\
			porcentajeiva2=0, porcentajeiva8=0, porcentajeiesps12=0,\
			porcentajeiesps13=0, porcentajeiesps11=0, porcentajeiesps3=0,\
			porcentajeiesps4=0, porcentajeiesps9=0, porcentajeiesps5=0,\
			porcentajeiesps6=0, porcentajeiesps10=0, porcentajeiva=0,\
			porcentajeiesps=0 where totaltodo=0";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion  = "CREATE TEMPORARY TABLE auxVentasNC\
			SELECT referencia, sum(totaloriginal) AS stotaloriginal,\
			sum(totaltodo) AS stotaltodo \
			FROM ventasaux GROUP BY referencia";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "UPDATE ventasaux a\
			INNER JOIN auxVentasNC b ON a.referencia = b.referencia\
			SET a.stotaltodo = b.stotaltodo";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxtransac (\
			tracredito varchar(11) , concepto varchar(1), destino varchar(1),\
			referencia varchar(11),articulo VARCHAR(9),\
			tipo varchar(4), pago varchar(11), valor decimal(16,2),\
			valorvta decimal(16,4), fechaapl date, horamodi time,\
			porcentaje0 decimal(16,10), porcentaje15 decimal(16,10),\
			porcentaje16 decimal(16,10), porcentajesub0 decimal(16,10),\
			porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10),\
			porcentajesubgrabado decimal(16,10), porcentajesubtotal decimal(16,10),\
			porcclasifcont decimal(16,10), porcentajeiva2 decimal(16,10),\
			porcentajeiva8 decimal(16,10), porcentajeiesps12 decimal(16,10),\
			porcentajeiesps13 decimal(16,10), porcentajeiesps11 decimal(16,10),\
			porcentajeiesps3 decimal(16,10), porcentajeiesps4 decimal(16,10),\
			porcentajeiesps9 decimal(16,10), porcentajeiesps5 decimal(16,10),\
			porcentajeiesps6 decimal(16,10), porcentajeiesps10 \
			decimal(16,10), porcentajeiva decimal(16,10),\
			porcentajeiesps decimal(16,10), notacar varchar(11),\
			KEY (referencia), KEY (tracredito)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp5 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select t.tracredito, t.concepto, t.destino,\
			t.referencia, va.articulo , t.tipo, t.pago, t.valor,\
			va.totaloriginal as valorvta, t.fechaapl, t.horamodi,\
			va.porcentaje0, va.porcentaje15,\
			va.porcentaje16, va.porcentajesub0, va.porcentajesub15,\
			va.porcentajesub16, va.porcentajesubgrabado, va.porcentajesubtotal,\
			va.porcclasifcont, va.porcentajeiva2,\
			va.porcentajeiva8, va.porcentajeiesps12,\
			va.porcentajeiesps13, va.porcentajeiesps11, va.porcentajeiesps3,\
			va.porcentajeiesps4, va.porcentajeiesps9, va.porcentajeiesps5,\
			va.porcentajeiesps6, va.porcentajeiesps10,\
			va.porcentajeiva, va.porcentajeiesps, t.notacar\
			from ventasaux va, transxcob t\
			where t.aplicada=1 and t.cancelada=0 and t.referencia=va.referencia\
			and t.tipo<>'VENT' order by\
			t.referencia, t.fechaapl, t.horamodi into outfile '%s'",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxtransac",archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxtransacb like auxtransac";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "insert into auxtransacb select * from auxtransac";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "insert into auxtransacb select * from auxtransac";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auxtransaccargo\
			(porcentaje DECIMAL(5,2), referencia VARCHAR(11))Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT DISTINCT incar.porcentaje, t.referencia\
			FROM ventasaux va\
			INNER JOIN transxcob t ON t.referencia=va.referencia\
			INNER JOIN notascarcli n ON n.referencia=t.notacar\
			INNER JOIN impuestos incar ON incar.impuesto=n.cveimp\
			WHERE t.aplicada=1 AND t.cancelada=0 AND \
			t.referencia=va.referencia into outfile '%s'",archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxtransaccargo",archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxtransac2(\
			tracredito varchar(11) , concepto varchar(1), destino varchar(1),\
			referencia varchar(11),articulo VARCHAR(9), tipo\
			varchar(4), pago varchar(11), valor decimal(16,2),\
			valorvta decimal(16,4), fechaapl date, horamodi time,\
			porcentaje0 decimal(16,10), porcentaje15 decimal(16,10),\
			porcentaje16 decimal(16,10), porcentajesub0 decimal(16,10),\
			porcentajesub15 decimal(16,10), porcentajesub16 decimal(16,10),\
			porcentajesubgrabado decimal(16,10), porcentajesubtotal decimal(16,10),\
			porcclasifcont decimal(16,10), porcentajeiva2 decimal(16,10),\
			porcentajeiva8 decimal(16,10), porcentajeiesps12 decimal(16,10),\
			porcentajeiesps13 decimal(16,10), porcentajeiesps11 decimal(16,10),\
			porcentajeiesps3 decimal(16,10), porcentajeiesps4 decimal(16,10),\
			porcentajeiesps9 decimal(16,10), porcentajeiesps5 decimal(16,10),\
			porcentajeiesps6 decimal(16,10), porcentajeiesps10 decimal(16,10),\
			porcentajeiva decimal(16,10), porcentajeiesps decimal(16,10),\
			notacar varchar(11), pagado decimal(16,4), pagadosc decimal(16,4),\
			valorftotal decimal(16,2), KEY (referencia), KEY\
			(tracredito)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp7 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

        instruccion.sprintf("select t.*,\
			sum(if( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi)\
				or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)\
				and t2.tracredito<t.tracredito),  t2.valor,0  )) as pagado,\
			sum(if(( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi)\
				or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi)\
				and t2.tracredito<t.tracredito)) and (t2.tipo='PAGO' or t2.tipo='CHDE'),\
				t2.valor,0  )) as pagadosc,0 \
			from auxtransac t, auxtransacb t2 where\
			t.referencia=t2.referencia AND t.articulo=t2.articulo \
			group by t.referencia, t.articulo,t.tracredito into outfile '%s'",
			archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxtransac2",archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion  = "CREATE TEMPORARY TABLE auxtransacAjuste ( \
			tracredito VARCHAR(11), pago VARCHAR(11),\
			PRIMARY KEY (pago), KEY (tracredito)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "INSERT INTO auxtransacAjuste SELECT MIN(t.tracredito) AS tracredito1,\
			t.pago FROM  auxtransac2 t WHERE t.pago IS NOT NULL GROUP BY t.pago";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE auxresultado ( \
			foliopago VARCHAR(255), rfcreceptor VARCHAR(255),\
			factura VARCHAR(255),muuid VARCHAR(255), fechavta DATETIME,\
			fechapag DATETIME, numch VARCHAR(255), cliente VARCHAR(255),\
			rsocial VARCHAR(255), ajuste double, referencia VARCHAR(255),\
			articulo VARCHAR(255), nomproducto VARCHAR(255),\
			valorpago double, saldoantes double, saldodespues double,\
			valorNotaCred double, valorvta double, pagadosc double,\
			valor double, porcentajePago double, PagoGGG double,\
			Cargos1 double, cargos double, subcargos double, ivacargos double,\
			totpago double, proporcion0 double, proporcion15 double,\
			proporcion16 double, proporcionsub0 double, proporcionsub15 double,\
			proporcionsub16 double, proporcionsubgrabado double,\
			proporcionsubtotal double, porcclasifcont double,\
			proporcioniva2 double, proporcioniva8 double,\
			proporcioniesps12 double, proporcioniesps13 double,\
			proporcioniesps11 double, proporcioniesps3 double,\
			proporcioniesps4 double, proporcioniesps9 double,\
			proporcioniesps5 double, proporcioniesps6 double,\
			proporcioniesps10 double, proporcioniva double,\
			proporcioniesps double, seriefoliopag VARCHAR(255),\
			muuidpag VARCHAR(255), idmovbanco INT, transacc VARCHAR(255),\
			idnumcuenta INT, numerocuenta VARCHAR(255), nombrebanco VARCHAR(255),\
			fechaaplbanco DATETIME, formapago VARCHAR(255), identpago VARCHAR(255),\
			conceptomovbanco VARCHAR(255), identbanco VARCHAR(255),\
			horamodi TIME, tracredito VARCHAR(255))";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp8 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

        instruccion.sprintf("select pag.pago as foliopago,\
			cfdv.rfcreceptor , if(ifnull(v.foliofisic,'')='',\
			concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as factura,cfdv.muuid,\
			v.fechavta,ifnull(ch.fechacob,pag.fecha) as fechapag, ch.folio as numch, v.cliente,\
			cli.rsocial, IF(ta.tracredito=t.tracredito,pag.ajuste,0) AS ajuste,\
			v.referencia, t.articulo,\
			concat(prod.nombre , ' ', articulos.present)AS nomproducto,\
			@valorpago:=(bxc.valorconsiderado*-1.0) as valorpago,\
			@saldoantes:=(t.valorvta+t.pagado) as saldoantes,\
			@saldodespues:=(t.valorvta+t.pagado+@valorpago) as saldodespues,\
			nt.valor AS valorNotaCred,\
			t.valorvta,t.pagadosc,v.valor,\
			@porcentajePago:=((bxc.valorconsiderado*-1.0)/(vx.stotaltodo)) AS porcentajePago,\
			(t.valorvta*@porcentajePago*-1) AS PagoGGG,\
			(t.valorvta+t.pagadosc+@valorpago) AS Cargos1,\
			@cargos:=if((t.valorvta+t.pagadosc+@valorpago)<0, if((t.valorvta+t.pagadosc+@valorpago)<@valorpago,(@valorpago), (t.valorvta+t.pagadosc+@valorpago)), 0) as cargos,\
			@subcargos:=0 as subcargos,\
			@ivacargos:=0 as ivacargos,\
			@pago:=(vx.totaltodo*@porcentajePago*-1) as totpago,\
			(@pago*t.porcentaje0) as proporcion0,\
			(@pago*t.porcentaje15) as proporcion15,\
			(@pago*t.porcentaje16) as proporcion16,\
			(@pago*t.porcentajesub0) as proporcionsub0,\
			(@pago*t.porcentajesub15) as proporcionsub15,\
			(@pago*t.porcentajesub16) as proporcionsub16,\
			(@pago*t.porcentajesubgrabado) as proporcionsubgrabado,\
			(@pago*t.porcentajesubtotal) as proporcionsubtotal,\
			t.porcclasifcont, (@pago*t.porcentajeiva2) as proporcioniva2,\
			(@pago*t.porcentajeiva8) as proporcioniva8,\
			(@pago*t.porcentajeiesps12) as proporcioniesps12,\
			(@pago*t.porcentajeiesps13) as proporcioniesps13,\
			(@pago*t.porcentajeiesps11) as proporcioniesps11,\
			(@pago*t.porcentajeiesps3) as proporcioniesps3, (@pago*t.porcentajeiesps4) as proporcioniesps4, (@pago*t.porcentajeiesps9) as \
			proporcioniesps9, (@pago*t.porcentajeiesps5) as\
			proporcioniesps5, (@pago*t.porcentajeiesps6) as proporcioniesps6, (@pago*t.porcentajeiesps10) as proporcioniesps10, (@pago*t.porcentajeiva) as\
			proporcioniva, (@pago*t.porcentajeiesps) as proporcioniesps,\
			concat(ifnull(cfdp.serie,''),\
			ifnull(cfdp.folio,'')) as seriefoliopag, cfdp.muuid as muuidpag,\
			bm.idmovbanco,bt.transacc, bm.idnumcuenta, bcu.numerocuenta, ba.nombre AS nombrebanco, bm.fechaaplbanco,\
			pag.formapag AS formapago, if(pag.formapag='C' AND ch.chequecli IS NOT NULL, ch.folio, pag.ident) as identpago,\
			bm.conceptomov AS conceptomovbanco , bm.identificador AS identbanco,\
			t.horamodi, t.tracredito\
			FROM auxtransac2 t\
			INNER JOIN ventasaux AS vx ON vx.referencia=t.referencia AND vx.articulo=t.articulo \
			INNER JOIN ventas v ON v.referencia=t.referencia\
			INNER JOIN clientes cli ON cli.cliente=v.cliente\
			INNER JOIN pagoscli pag ON pag.pago=t.pago \
			INNER JOIN terminales ter ON ter.terminal=v.terminal\
			INNER JOIN secciones sec ON ter.seccion=sec.seccion \
			INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago \
			INNER JOIN articulos ON articulos.articulo=t.articulo\
			INNER JOIN productos prod ON articulos.producto=prod.producto\
			LEFT JOIN cheqxcob chxc ON chxc.pago=pag.pago\
			LEFT JOIN chequesclientes ch ON ch.chequecli=chxc.chequecli\
			LEFT JOIN cfd cfdv ON v.referencia=cfdv.referencia AND cfdv.tipocomprobante='VENT' AND cfdv.estado=1\
			LEFT JOIN cfd cfdp ON pag.pago=cfdp.referencia AND cfdp.tipocomprobante='PAGO' AND cfdv.metodopago33='PPD' AND cfdp.estado=1\
			left JOIN bancosxcob bxc ON bxc.tracredito=t.tracredito\
			left JOIN bancostransacc bt ON bt.transacc=bxc.transacc \
			inner JOIN bancosmov bm ON bm.idmovbanco=bt.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1\
			left JOIN bancoscuentas bcu ON bm.idnumcuenta=bcu.idnumcuenta\
			left JOIN bancos ba ON bcu.banco=ba.banco \
			LEFT JOIN TotalNotascredCliaux AS nt ON nt.venta=t.referencia\
			WHERE  pag.formapag in ('E','C','T','D') AND t.tipo='PAGO' AND\
			t.fechaapl>='%s' AND t.fechaapl<='%s' \
			AND v.fechavta>='1900-01-01' AND v.fechavta<='2099-01-01'\
			ORDER BY pag.pago, t.articulo, t.horamodi, t.tracredito, vx.referencia \
			into outfile '%s'",fechaini,fechafin, archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxresultado",archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;

		consulta = "select rsocial, rfcreceptor, fechapag, foliopago,\
			muuidpag, articulo, nomproducto, referencia, fechavta, factura, muuid,\
			sum(proporcionsub0+proporcioniesps11) as SubIva0,\
			sum(proporcionsub16+proporcioniesps-proporcioniesps11) AS SubIva16,\
			sum(proporcioniva) AS IVA, sum(totpago) AS Total, numerocuenta,\
			nombrebanco, fechaaplbanco,\
			(case when formapago='E' then 'EFECTIVO' when formapago='C' then 'CHEQUE'\
				when formapago='D' then 'DEPOSITO' when formapago='T'\
				then 'TRANSFERENCIA BANCARIA' else formapago END) as formapago,\
			identpago\
			FROM auxresultado\
			GROUP BY foliopago,referencia, articulo,idmovbanco\
			ORDER BY rsocial, foliopago,articulo,fechapag, fechavta, referencia, totpago";
		//instrucciones[num_instrucciones++] = instruccion;

        // Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L);

        if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
        }


	}__finally{

		delete buffer_sql;
		delete aux_buffer_sql;

		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
		mServidorVioleta->BorraArchivoTemp(archivo_temp2);
		mServidorVioleta->BorraArchivoTemp(archivo_temp3);
		mServidorVioleta->BorraArchivoTemp(archivo_temp4);
		mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		mServidorVioleta->BorraArchivoTemp(archivo_temp6);
		mServidorVioleta->BorraArchivoTemp(archivo_temp7);
		mServidorVioleta->BorraArchivoTemp(archivo_temp8);
	}
}

// ---------------------------------------------------------------------------
// ID_REP_NCPD
void ServidorReportes::EjecutaRepNCPD(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	int i = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	AnsiString fechaini = " ", fechafin = " ";

	AnsiString archivo_temp1 = " ";
	AnsiString archivo_temp2 = " ";
	AnsiString archivo_temp3 = " ";
	AnsiString archivo_temp4 = " ";
	AnsiString archivo_temp5 = " ";
	AnsiString archivo_temp6 = " ";
	AnsiString archivo_temp7 = " ";
	AnsiString archivo_temp8 = " ";
    AnsiString archivo_temp9 = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));

	try{

		instruccion.sprintf("SET @fechainicialPagos='%s'", fechaini);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SET @fechafinalPagos='%s'", fechafin);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table ventasaux (\
			referencia char(11),articulo VARCHAR(9),totaloriginal decimal(16,4),\
			totaltodo decimal(16,4),total0 decimal(16,4),total15 decimal(16,4),\
			total16 decimal(16,4),subnograbado decimal(16,4),\
			subtotal15 decimal(16,4),subtotal16 decimal(16,4),\
			subgrabado decimal(16,4),subtotal decimal(16,4),\
			totclasifcont decimal(16,4),totaliva2 decimal(16,4),\
			totaliva8 decimal(16,4),totaliesps12 decimal(16,4),\
			totaliesps13 decimal(16,4),totaliesps11 decimal(16,4),\
			totaliesps3 decimal(16,4),totaliesps4 decimal(16,4),\
			totaliesps9 decimal(16,4),totaliesps5 decimal(16,4),\
			totaliesps6 decimal(16,4),totaliesps10 decimal(16,4),\
			totaliva decimal(16,4),totaliesps decimal(16,4),\
			valor decimal(16,4),porcentaje0 decimal(16,10),\
			porcentaje15 decimal(16,10),porcentaje16 decimal(16,10),\
			porcentajesub0 decimal(16,10),porcentajesub15 decimal(16,10),\
			porcentajesub16 decimal(16,10),porcentajesubgrabado decimal(16,10),\
			porcentajesubtotal decimal(16,10),porcclasifcont decimal(16,10),\
			porcentajeiva2 decimal(16,10),porcentajeiva8 decimal(16,10),\
			porcentajeiesps12 decimal(16,10),porcentajeiesps13 decimal(16,10),\
			porcentajeiesps11 decimal(16,10),porcentajeiesps3 decimal(16,10),\
			porcentajeiesps4 decimal(16,10),porcentajeiesps9 decimal(16,10),\
			porcentajeiesps5 decimal(16,10),porcentajeiesps6 decimal(16,10),\
			porcentajeiesps10 decimal(16,10),porcentajeiva decimal(16,10),\
			porcentajeiesps decimal(16,10),stotaltodo decimal(16,4),\
			PRIMARY KEY (referencia,articulo)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table referenciasaux (\
			referencia char(11),PRIMARY KEY (referencia)) Engine = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select v.referencia\
			from ventas v, transxcob t, terminales ter,\
			secciones sec, sucursales suc \
			where t.aplicada=1\
			and t.fechaapl>=@fechainicialPagos\
			and t.fechaapl<=@fechafinalPagos\
			and t.cancelada=0\
			and t.tipo='PAGO'\
			and v.cancelado=0\
			and v.fechavta>='1900-01-01'\
			and v.fechavta<='2099-01-01'\
			and t.referencia=v.referencia\
			AND v.terminal=ter.terminal\
			AND ter.seccion=sec.seccion\
			AND suc.sucursal=sec.sucursal\
		    AND suc.idempresa = %s\
			group by v.referencia INTO OUTFILE '%s'",FormServidor->ObtieneClaveEmpresa(),
			archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table referenciasaux",archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE dnotascredcliaux (\
		venta CHAR(11),articulo VARCHAR(9), cantidad DECIMAL(12,3),\
		precio DECIMAL(16,6), precioimp DECIMAL(16,6),\
		PRIMARY KEY (venta, articulo)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select v.referencia as venta,\
			d.articulo,\
			sum(if(n.tipo='0',d.cantidad,0)) as cantidad,\
			sum(if(n.tipo<>'0',d.precio,0)) as precio,\
			sum(if(n.tipo<>'0',d.precioimp,0)) as precioimp\
			from notascredcli n,\
			dnotascredcli d,\
			ventas v,\
			referenciasaux ra\
			where n.venta=v.referencia\
			and n.cancelado=0\
			and v.cancelado=0\
			and ra.referencia=v.referencia\
			and n.referencia=d.referencia\
			group by v.referencia, d.articulo INTO OUTFILE '%s'",archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table dnotascredcliaux",archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE TotalNotascredCliaux\
			(venta CHAR(11), valor DECIMAL(16,2),\
			PRIMARY KEY (venta)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

        archivo_temp3 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

        instruccion.sprintf("SELECT n.venta,\
			sum(valor) FROM notascredcli n\
			INNER JOIN referenciasaux ra ON  n.venta=ra.referencia\
			WHERE n.cancelado=0 GROUP BY  n.venta INTO OUTFILE '%s'",archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table TotalNotascredCliaux",archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

        instruccion.sprintf("SELECT v.referencia,dv.articulo,\
			SUM((dv.precioimp)*(dv.cantidad)) AS totaloriginal,\
			SUM((dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0))) AS totaltodo,\
			SUM(if(	(NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0) AND NOT (IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)),(dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)), 0)) AS total0,\
			SUM(if(	((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=15.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS total15,\
			SUM(if(	((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR 	(i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=16.00)), (dv.precioimp- IFNULL(dn.precioimp,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS total16, \
			SUM(@subnograbado:=if(	(NOT (IFNULL(i1.tipoimpu,'')='IVA' AND IFNULL(i1.porcentaje,0)>0) AND NOT (IFNULL(i2.tipoimpu,'')='IVA' AND IFNULL(i2.porcentaje,0)>0) AND NOT (IFNULL(i3.tipoimpu,'')='IVA' AND IFNULL(i3.porcentaje,0)>0) AND NOT (IFNULL(i4.tipoimpu,'')='IVA' AND IFNULL(i4.porcentaje,0)>0)),(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS subnograbado,\
			SUM(@subtotal15:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=15.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=15.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=15.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=15.00)),(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS subtotal15,\
			SUM(@subtotal16:=if(((i1.tipoimpu='IVA' AND i1.porcentaje=16.00) OR (i2.tipoimpu='IVA' AND i2.porcentaje=16.00) OR (i3.tipoimpu='IVA' AND i3.porcentaje=16.00) OR (i4.tipoimpu='IVA' AND i4.porcentaje=16.00)),(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0)),0)) AS subtotal16,\
			SUM(@subgrabado:=@subtotal15+@subtotal16) AS subgrabado, SUM(@subtotal:=@subtotal15+@subtotal16+@subnograbado) AS subtotal,\
			0 AS totclasifcont,\
			SUM(if(i1.impuesto=2,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=2,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva2,\
			(if(i1.impuesto=8,(dv.precio- IFNULL(sum(dn.precio),0))*(dv.cantidad- IFNULL(sum(dn.cantidad),0))*(i1.porcentaje/100), 0) + if(i2.impuesto=8,(dv.precio- IFNULL(sum(dn.precio),0))*(dv.cantidad- IFNULL(sum(dn.cantidad),0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva8,\
			SUM(if(i1.impuesto=12,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=12,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps12,\
			SUM(if(i1.impuesto=13,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=13,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps13,\
			SUM(if(i1.impuesto=11,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=11,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps11,\
			SUM(if(i1.impuesto=3,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=3, (dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps3,\
			SUM(if(i1.impuesto=4,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=4,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps4,\
			SUM(if(i1.impuesto=9,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=9,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps9,\
			SUM(if(i1.impuesto=5,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=5,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps5,\
			SUM(if(i1.impuesto=6,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.impuesto=6,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps6,\
			SUM(if(i1.impuesto=10,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + 	if(i2.impuesto=10,(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliesps10,\
			SUM(if(i1.tipoimpu='IVA',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0) + if(i2.tipoimpu='IVA',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(1+i1.porcentaje/100)*(i2.porcentaje/100), 0)) AS totaliva,\
			SUM(if(i1.tipoimpu='IESPS',(dv.precio- IFNULL(dn.precio,0))*(dv.cantidad- IFNULL(dn.cantidad,0))*(i1.porcentaje/100), 0)) AS totaliesps\
			FROM referenciasaux ra\
			INNER JOIN ventas v ON v.referencia = ra.referencia\
			INNER JOIN dventas dv ON v.referencia = dv.referencia\
			LEFT JOIN dnotascredcliaux dn ON dn.articulo=dv.articulo AND dn.venta=v.referencia\
			LEFT JOIN impuestos i1 ON i1.impuesto=dv.claveimp1\
			LEFT JOIN impuestos i2 ON i2.impuesto=dv.claveimp2\
			LEFT JOIN impuestos i3 ON i3.impuesto=dv.claveimp3 \
			LEFT JOIN impuestos i4 ON i4.impuesto=dv.claveimp4\
			GROUP BY v.referencia,dv.articulo \
			ORDER BY v.referencia into outfile '%s'", archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table ventasaux (\
			referencia,articulo,totaloriginal,totaltodo,total0,total15,\
			total16,subnograbado,subtotal15,subtotal16,subgrabado,subtotal,\
			totclasifcont,totaliva2,totaliva8,totaliesps12,totaliesps13,\
			totaliesps11,totaliesps3,totaliesps4,totaliesps9,totaliesps5,\
			totaliesps6,totaliesps10,totaliva,totaliesps)",archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "update ventasaux set\
			valor=totaltodo,\
			porcentaje0=total0/(totaltodo),\
			porcentaje15=total15/(totaltodo),\
			porcentaje16=total16/(totaltodo),\
			porcentajesub0=subnograbado/(totaltodo),\
			porcentajesub15=subtotal15/(totaltodo),\
			porcentajesub16=subtotal16/(totaltodo),\
			porcentajesubgrabado=subgrabado/(totaltodo),\
			porcentajesubtotal=subtotal/(totaltodo),\
			porcclasifcont=totclasifcont/(totaltodo),\
			porcentajeiva2=totaliva2/(totaltodo),\
			porcentajeiva8=totaliva8/(totaltodo),\
			porcentajeiesps12=totaliesps12/(totaltodo),\
			porcentajeiesps13=totaliesps13/(totaltodo),\
			porcentajeiesps11=totaliesps11/(totaltodo),\
			porcentajeiesps3=totaliesps3/(totaltodo),\
			porcentajeiesps4=totaliesps4/(totaltodo),\
			porcentajeiesps9=totaliesps9/(totaltodo),\
			porcentajeiesps5=totaliesps5/(totaltodo),\
			porcentajeiesps6=totaliesps6/(totaltodo),\
			porcentajeiesps10=totaliesps10/(totaltodo),\
			porcentajeiva=totaliva/(totaltodo),\
			porcentajeiesps=totaliesps/(totaltodo)\
			where totaltodo<>0";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "update ventasaux set\
			valor=totaltodo, porcentaje0=0, porcentaje15=0,\
			porcentaje16=0, porcentajesub0=0, porcentajesub15=0,\
			porcentajesub16=0, porcentajesubgrabado=0, porcentajesubtotal=0,\
			porcclasifcont=0, porcentajeiva2=0, porcentajeiva8=0,\
			porcentajeiesps12=0, porcentajeiesps13=0, porcentajeiesps11=0,\
			porcentajeiesps3=0, porcentajeiesps4=0, porcentajeiesps9=0,\
			porcentajeiesps5=0, porcentajeiesps6=0, porcentajeiesps10=0,\
			porcentajeiva=0, porcentajeiesps=0 where totaltodo=0";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "CREATE TEMPORARY TABLE auxVentasNC\
			SELECT referencia, sum(totaloriginal) AS stotaloriginal,\
			sum(totaltodo) AS stotaltodo\
			FROM ventasaux GROUP BY referencia";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "UPDATE ventasaux a\
			INNER JOIN auxVentasNC b ON a.referencia = b.referencia\
			SET a.stotaltodo = b.stotaltodo";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auxtransac ( \
			tracredito varchar(11), concepto varchar(1),\
			destino varchar(1), referencia varchar(11),\
			articulo VARCHAR(9), tipo varchar(4),\
			pago varchar(11), valor decimal(16,2),\
			valorvta decimal(16,4), fechaapl date,\
			horamodi time, porcentaje0 decimal(16,10),\
			porcentaje15 decimal(16,10), porcentaje16 decimal(16,10),\
			porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10),\
			porcentajesub16 decimal(16,10), porcentajesubgrabado decimal(16,10),\
			porcentajesubtotal decimal(16,10), porcclasifcont decimal(16,10),\
			porcentajeiva2 decimal(16,10), porcentajeiva8 decimal(16,10),\
			porcentajeiesps12 decimal(16,10), porcentajeiesps13 decimal(16,10),\
			porcentajeiesps11 decimal(16,10), porcentajeiesps3 decimal(16,10),\
			porcentajeiesps4 decimal(16,10), porcentajeiesps9 decimal(16,10),\
			porcentajeiesps5 decimal(16,10), porcentajeiesps6 decimal(16,10),\
			porcentajeiesps10 decimal(16,10), porcentajeiva decimal(16,10),\
			porcentajeiesps decimal(16,10), notacar varchar(11),\
			KEY (referencia), KEY (tracredito)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp5 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select t.tracredito,t.concepto,t.destino,t.referencia,\
			va.articulo,t.tipo,t.pago,t.valor,va.totaloriginal as valorvta,\
			t.fechaapl,t.horamodi,va.porcentaje0,va.porcentaje15,\
			va.porcentaje16,va.porcentajesub0,va.porcentajesub15,\
			va.porcentajesub16,va.porcentajesubgrabado,va.porcentajesubtotal,\
			va.porcclasifcont,va.porcentajeiva2,va.porcentajeiva8,\
			va.porcentajeiesps12,va.porcentajeiesps13,va.porcentajeiesps11,\
			va.porcentajeiesps3,va.porcentajeiesps4,va.porcentajeiesps9,\
			va.porcentajeiesps5,va.porcentajeiesps6,va.porcentajeiesps10,\
			va.porcentajeiva,va.porcentajeiesps,t.notacar\
			from ventasaux va,transxcob t\
			where t.aplicada=1 and t.cancelada=0 \
			and t.referencia=va.referencia \
			and t.tipo<>'VENT'\
			order by t.referencia, t.fechaapl, t.horamodi into outfile '%s'",
			archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxtransac",archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxtransacb like auxtransac";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "insert into auxtransacb select * from auxtransac";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auxtransaccargo(\
			porcentaje DECIMAL (5,2),referencia VARCHAR (11))Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT DISTINCT incar.porcentaje,\
			t.referencia FROM ventasaux va\
			INNER JOIN transxcob t ON t.referencia=va.referencia\
			INNER JOIN notascarcli n ON n.referencia=t.notacar\
			INNER JOIN impuestos incar ON incar.impuesto=n.cveimp \
			WHERE t.aplicada=1 AND t.cancelada=0\
			AND t.referencia=va.referencia into outfile '%s'",archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table auxtransaccargo",archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auxtransac2 (\
			tracredito varchar(11), concepto varchar(1),\
			destino varchar(1), referencia varchar(11),\
			articulo VARCHAR(9), tipo varchar(4),\
			pago varchar(11), valor decimal(16,2),\
			valorvta decimal(16,4), fechaapl date,\
			horamodi time, porcentaje0 decimal(16,10),\
			porcentaje15 decimal(16,10), porcentaje16 decimal(16,10),\
			porcentajesub0 decimal(16,10), porcentajesub15 decimal(16,10),\
			porcentajesub16 decimal(16,10), porcentajesubgrabado decimal(16,10),\
			porcentajesubtotal decimal(16,10), porcclasifcont decimal(16,10),\
			porcentajeiva2 decimal(16,10), porcentajeiva8 decimal(16,10), \
			porcentajeiesps12 decimal(16,10), porcentajeiesps13 decimal(16,10),\
			porcentajeiesps11 decimal(16,10), porcentajeiesps3 decimal(16,10),\
			porcentajeiesps4 decimal(16,10), porcentajeiesps9 decimal(16,10),\
			porcentajeiesps5 decimal(16,10), porcentajeiesps6 decimal(16,10),\
			porcentajeiesps10 decimal(16,10), porcentajeiva decimal(16,10),\
			porcentajeiesps decimal(16,10), notacar varchar(11),\
			pagado decimal(16,4), pagadosc decimal(16,4),\
			valorftotal decimal(16,2), KEY (referencia),\
			KEY (tracredito)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp7 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select t.*,\
			sum(if(addtime(t2.fechaapl,t2.horamodi)<addtime(t.fechaapl,t.horamodi)or(addtime(t2.fechaapl,t2.horamodi)=addtime(t.fechaapl,t.horamodi) and t2.tracredito<t.tracredito),t2.valor,0)) as pagado,\
			sum(if(( addtime(t2.fechaapl,t2.horamodi) < addtime(t.fechaapl,t.horamodi) or (addtime(t2.fechaapl,t2.horamodi) = addtime(t.fechaapl,t.horamodi) and t2.tracredito<t.tracredito)) and (t2.tipo='PAGO' or t2.tipo='CHDE'),  t2.valor,0  )) as pagadosc,\
			0 from auxtransac t, auxtransacb t2 where t.referencia=t2.referencia\
			AND t.articulo=t2.articulo\
			group by t.referencia, t.articulo,t.tracredito into outfile '%s'",
			archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table auxtransac2",archivo_temp7);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auxtransacAjuste (\
			tracredito VARCHAR(11), pago VARCHAR(11),\
			PRIMARY KEY (pago), KEY (tracredito)) ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auxtransacAjuste\
			SELECT MIN(t.tracredito) AS tracredito1,\
			t.pago FROM  auxtransac2 t WHERE t.pago IS NOT NULL GROUP BY t.pago";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxresultado ( \
			foliopago varchar (11), \
			rfcreceptor varchar (13), \
			factura varchar (10),    \
			muuid varchar (36),      \
			fechavta DATE,   \
			fechapag DATE, \
			numch varchar (30),\
			cliente varchar (11),\
			rsocial varchar (255),\
			ajuste decimal (16,2),\
			referencia varchar (11), \
			articulo varchar (11),    \
			nomproducto varchar (255),\
			valorpago decimal (16,2), \
			saldoantes decimal (16,2), \
			saldodespues decimal (16,2),\
			valorNotaCred decimal (16,2),\
			valorvta decimal (16,2),   \
			pagadosc decimal (16,2),  \
			valor decimal (16,2),     \
			porcentajePago decimal (16,2), \
			PagoGGG decimal (16,2),      \
			Cargos1 decimal (16,2),     \
			cargos decimal (16,2),   \
			subcargos decimal (16,2), \
			ivacargos decimal (16,2), \
			totpago decimal (16,2),  \
			proporcion0 decimal (16,2), \
			proporcion15 decimal (16,2), \
			proporcion16 decimal (16,2),             \
			proporcionsub0 decimal (16,2),         \
			proporcionsub15 decimal (16,2),        \
			proporcionsub16 decimal (16,2),\
			proporcionsubgrabado decimal (16,2), \
			proporcionsubtotal decimal (16,2), \
			porcclasifcont DECIMAL (16, 2), \
			proporcioniva2 decimal (16,2),   \
			proporcioniva8 decimal (16,2),  \
			proporcioniesps12 decimal (16,2),\
			proporcioniesps13 decimal (16,2), \
			proporcioniesps11 decimal (16,2), \
			proporcioniesps3 decimal (16,2),  \
			proporcioniesps4 decimal (16,2),  \
			proporcioniesps9 decimal (16,2),  \
			proporcioniesps5 decimal (16,2),   \
			proporcioniesps6 decimal (16,2),\
			proporcioniesps10 decimal (16,2), \
			proporcioniva decimal (16,2), \
			proporcioniesps decimal (16,2),\
			seriefoliopag varchar (20),\
			muuidpag varchar (36),  \
			idmovbanco int (11),   \
			transacc int (11),     \
			idnumcuenta int (11),   \
			numerocuenta varchar(50), \
			nombrebanco varchar(60), \
			fechaaplbanco date,     \
			formapago varchar(1),  \
			identpago varchar(20), \
			conceptomovbanco varchar (1),\
			identbanco varchar(20),   \
			horamodi TIME,           \
			tracredito varchar (11))";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp8 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("select pag.pago as foliopago,\
			cfdv.rfcreceptor,\
			if(ifnull(v.foliofisic,'')='',concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as factura,\
			cfdv.muuid,\
			v.fechavta,\
			ifnull(ch.fechacob,pag.fecha) as fechapag,\
			ch.folio as numch,\
			v.cliente,\
			cli.rsocial,\
			IF(ta.tracredito=t.tracredito,pag.ajuste,0) AS ajuste,\
			v.referencia,\
			t.articulo,\
			concat(prod.nombre , ' ', articulos.present)AS nomproducto,\
			@valorpago:=(bxc.valorconsiderado*-1.0) as valorpago,\
			@saldoantes:=(t.valorvta+t.pagado) as saldoantes,\
			@saldodespues:=(t.valorvta+t.pagado+@valorpago) as saldodespues,\
			nt.valor AS valorNotaCred,\
			t.valorvta,\
			t.pagadosc,\
			v.valor,\
			@porcentajePago:=((bxc.valorconsiderado*-1.0)/(vx.stotaltodo)) AS porcentajePago,\
			(t.valorvta*@porcentajePago*-1) AS PagoGGG,\
			(t.valorvta+t.pagadosc+@valorpago) AS Cargos1,\
			@cargos:=if((t.valorvta+t.pagadosc+@valorpago)<0, if((t.valorvta+t.pagadosc+@valorpago)<@valorpago,(@valorpago), (t.valorvta+t.pagadosc+@valorpago)), 0) as cargos,\
			@subcargos:=0 as subcargos,\
			@ivacargos:=0 as ivacargos, \
			@pago:=(vx.totaltodo*@porcentajePago*-1) as totpago,\
			(@pago*t.porcentaje0) as proporcion0,\
			(@pago*t.porcentaje15) as proporcion15,\
			(@pago*t.porcentaje16) as proporcion16,\
			(@pago*t.porcentajesub0) as proporcionsub0,\
			(@pago*t.porcentajesub15) as proporcionsub15,\
			(@pago*t.porcentajesub16) as proporcionsub16,\
			(@pago*t.porcentajesubgrabado) as proporcionsubgrabado,\
			(@pago*t.porcentajesubtotal) as proporcionsubtotal,\
			t.porcclasifcont, (@pago*t.porcentajeiva2) as proporcioniva2,\
			(@pago*t.porcentajeiva8) as proporcioniva8,\
			(@pago*t.porcentajeiesps12) as proporcioniesps12,\
			(@pago*t.porcentajeiesps13) as proporcioniesps13,\
			(@pago*t.porcentajeiesps11) as proporcioniesps11,\
			(@pago*t.porcentajeiesps3) as proporcioniesps3,\
			(@pago*t.porcentajeiesps4) as proporcioniesps4,\
			(@pago*t.porcentajeiesps9) as proporcioniesps9,\
			(@pago*t.porcentajeiesps5) as proporcioniesps5,\
			(@pago*t.porcentajeiesps6) as proporcioniesps6,\
			(@pago*t.porcentajeiesps10) as proporcioniesps10,\
			(@pago*t.porcentajeiva) as proporcioniva,\
			(@pago*t.porcentajeiesps) as proporcioniesps,\
			concat(ifnull(cfdp.serie,''),ifnull(cfdp.folio,'')) as seriefoliopag,\
			cfdp.muuid as muuidpag,\
			bm.idmovbanco,\
			bt.transacc,\
			bm.idnumcuenta,\
			bcu.numerocuenta,\
			ba.nombre AS nombrebanco,\
			bm.fechaaplbanco,\
			pag.formapag AS formapago,\
			if(pag.formapag='C' AND ch.chequecli IS NOT NULL, ch.folio, pag.ident) as identpago,\
			bm.conceptomov AS conceptomovbanco,\
			bm.identificador AS identbanco,\
			t.horamodi,\
			t.tracredito \
			FROM auxtransac2 t\
			INNER JOIN ventasaux AS vx ON vx.referencia=t.referencia AND vx.articulo=t.articulo\
			INNER JOIN ventas v ON v.referencia=t.referencia\
			INNER JOIN clientes cli ON cli.cliente=v.cliente\
			INNER JOIN pagoscli pag ON pag.pago=t.pago\
			INNER JOIN terminales ter ON ter.terminal=v.terminal\
			INNER JOIN secciones sec ON ter.seccion=sec.seccion\
			INNER JOIN auxtransacAjuste ta ON ta.pago=t.pago\
			INNER JOIN articulos ON articulos.articulo=t.articulo \
			INNER JOIN productos prod ON articulos.producto=prod.producto\
			LEFT JOIN cheqxcob chxc ON chxc.pago=pag.pago\
			LEFT JOIN chequesclientes ch ON ch.chequecli=chxc.chequecli\
			LEFT JOIN cfd cfdv ON v.referencia=cfdv.referencia AND cfdv.tipocomprobante='VENT' AND cfdv.estado=1\
			LEFT JOIN cfd cfdp ON pag.pago=cfdp.referencia AND cfdp.tipocomprobante='PAGO' AND cfdv.metodopago33='PPD' AND cfdp.estado=1\
			left JOIN bancosxcob bxc ON bxc.tracredito=t.tracredito \
			left JOIN bancostransacc bt ON bt.transacc=bxc.transacc\
			inner JOIN bancosmov bm ON bm.idmovbanco=bt.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1\
			left JOIN bancoscuentas bcu ON bm.idnumcuenta=bcu.idnumcuenta\
			left JOIN bancos ba ON bcu.banco=ba.banco\
			LEFT JOIN TotalNotascredCliaux AS nt ON nt.venta=t.referencia\
			WHERE  pag.formapag in ('E','C','T','D')\
			AND t.tipo='PAGO'\
			AND t.fechaapl>=@fechainicialPagos\
			AND t.fechaapl<=@fechafinalPagos\
			AND v.fechavta>='1900-01-01'\
			AND v.fechavta<='2099-01-01'\
			ORDER BY pag.pago, t.articulo, t.horamodi, t.tracredito,\
			vx.referencia into outfile '%s'",archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion.sprintf("load data infile '%s' into table auxresultado",archivo_temp8);
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auximpuestos\
			(impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "insert into auximpuestos (impuesto)\
			select impuesto from impuestos where tipoimpu <> 'ISR'";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auximpuestos1 (\
			orden int(2), impuesto int(2), tipoimpu char(10),\
			porcentaje decimal(5,2), nombre varchar(40),\
			primary key(impuesto), index(orden),\
			index(tipoimpu)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "insert into auximpuestos1 (\
			orden,impuesto,tipoimpu,porcentaje,nombre)\
			select i.impuesto as orden, i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje,\
			t.nombre as nombre from impuestos i, tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auximpuestos2 (\
			orden int(2), impuesto int(2), tipoimpu char(10),\
			porcentaje decimal(5,2), nombre varchar(40),\
			primary key(impuesto), index(orden),\
			index(tipoimpu)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "insert into auximpuestos2(\
			orden,impuesto,	tipoimpu, porcentaje,nombre)\
			select i.impuesto as orden,\
			i.impuesto as impuesto, i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje, t.nombre as nombre\
			from impuestos i, tiposdeimpuestos t, auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auximpuestos3 (\
			orden int(2), impuesto int(2),\
			tipoimpu char(10), porcentaje decimal(5,2),\
			nombre varchar(40), primary key(impuesto),\
			index(orden), index(tipoimpu)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "insert into auximpuestos3(\
			orden,impuesto,tipoimpu,porcentaje,nombre)\
			select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i, tiposdeimpuestos t,\
			auximpuestos aux where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

        instruccion = "create temporary table auximpuestos4 (\
			orden int(2), impuesto int(2),\
			tipoimpu char(10), porcentaje decimal(5,2),\
			nombre varchar(40), primary key(impuesto),\
			index(orden), index(tipoimpu)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "insert into auximpuestos4 (\
			orden,impuesto,tipoimpu, porcentaje,nombre)\
			select i.impuesto as orden, i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu, i.porcentaje as porcentaje,\
			t.nombre as nombre from impuestos i,\
			tiposdeimpuestos t, auximpuestos aux \
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table if not exists auxresultadonotas(\
			cliente varchar (11), rsocial varchar (255), rfcreceptor varchar (13),\
			FechaNota DATE, FolioNota varchar(11), Articulo varchar(11),\
			NombreProducto varchar(255), producto varchar(8), present varchar(255),\
			multiplo varchar(10), uuidNotaCred varchar(36), FolioVenta  varchar(11),\
			FechaVenta DATE, Factura  varchar(20), uuidFactura varchar(36),\
			tipoNota varchar(1), tipodescrito varchar(50), subtotal decimal (16,6),\
			imp1 decimal (16,6), imp2 decimal (16,6), imp3 decimal (16,6),\
			imp4 decimal (16,6), iva1 decimal (16,6), iva2 decimal (16,6),\
			ivatotal decimal (16,6), iesps1 decimal (16,6), iesps2 decimal (16,6),\
			iespstotal decimal (16,6), subgrabado decimal (16,6), subnograbado decimal (16,6),\
			impcol2 decimal (16,6), impcol8 decimal (16,6), impcol12 decimal (16,6),\
			impcol13 decimal (16,6), impcol11 decimal (16,6), impcol3 decimal (16,6),\
			impcol4 decimal (16,6), impcol9 decimal (16,6), impcol5 decimal (16,6),\
			impcol6 decimal (16,6), impcol10 decimal (16,6) )ENGINE = INNODB";
		instrucciones[num_instrucciones++] = instruccion;

        archivo_temp9 =
			mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT cli.cliente,\
			cli.rsocial,\
			cfdv.rfcreceptor,\
			n.fechanot AS FechaNota,\
			n.referencia AS FolioNota,\
			articulos.articulo AS Articulo,\
			prod.nombre AS NombreProducto,\
			articulos.producto,\
			articulos.present,\
			articulos.multiplo,\
			cfdn.muuid AS uuidNotaCred,\
			v.referencia AS FolioVenta,\
			v.fechavta AS FechaVenta,\
			if(ifnull(v.foliofisic,'')='',concat(ifnull(cfdv.serie,''),ifnull(cfdv.folio,'')),v.foliofisic) as Factura,\
			cfdv.muuid AS uuidFactura,\
			n.tipo AS tipoNota,\
			if(n.tipo=0, 'DEVOLUCION', if(n.tipo=1, 'BONIFICACION', 'DESCUENTO')) AS tipodescrito,\
			SUM(@subtotal:=dn.precio*dn.cantidad) AS subtotal,\
			SUM(@impuesto1:=if (ISNULL(i1.porcentaje),0,  @subtotal *(i1.porcentaje/100))) AS imp1,\
			SUM(@impuesto2:=if (ISNULL(i2.porcentaje),0, (@subtotal + @impuesto1) * (i2.porcentaje/100))) AS imp2,\
			SUM(@impuesto3:=if (ISNULL(i3.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100))) AS imp3,\
			SUM(@impuesto4:=if (ISNULL(i4.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100))) AS imp4,\
			SUM(@iva1:=if (@impuesto1>0 AND IFNULL(i1.tipoimpu,'')='IVA', @impuesto1, 0)) AS iva1,\
			SUM(@iva2:=if (@impuesto2>0 AND IFNULL(i2.tipoimpu,'')='IVA', @impuesto2, 0)) AS iva2,\
			SUM(@iva1+@iva2) AS ivatotal,\
			SUM(@iesps1:=if (@impuesto1>0 AND IFNULL(i1.tipoimpu,'')='IESPS', @impuesto1, 0)) AS iesps1,\
			SUM(@iesps2:=if (@impuesto2>0 AND IFNULL(i2.tipoimpu,'')='IESPS', @impuesto2, 0)) AS iesps2,\
			SUM(@iesps1+@iesps2) AS iespstotal,\
			SUM(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) AS subgrabado,\
			SUM(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) AS subnograbado,\
			SUM(@impcol2:=(CASE WHEN i1.orden=2 THEN @impuesto1 WHEN i2.orden=2 THEN @impuesto2 WHEN i3.orden=2 THEN @impuesto3 WHEN i4.orden=2 THEN @impuesto4 ELSE 0 END)) AS impcol2,\
			SUM(@impcol8:=(CASE WHEN i1.orden=8 THEN @impuesto1 WHEN i2.orden=8 THEN @impuesto2 WHEN i3.orden=8 THEN @impuesto3 WHEN i4.orden=8 THEN @impuesto4 ELSE 0 END)) AS impcol8,\
			SUM(@impcol12:=(CASE WHEN i1.orden=12 THEN @impuesto1 WHEN i2.orden=12 THEN @impuesto2 WHEN i3.orden=12 THEN @impuesto3 WHEN i4.orden=12 THEN @impuesto4 ELSE 0 END)) AS impcol12,\
			SUM(@impcol13:=(CASE WHEN i1.orden=13 THEN @impuesto1 WHEN i2.orden=13 THEN @impuesto2 WHEN i3.orden=13 THEN @impuesto3 WHEN i4.orden=13 THEN @impuesto4 ELSE 0 END)) AS impcol13,\
			SUM(@impcol11:=(CASE WHEN i1.orden=11 THEN @impuesto1 WHEN i2.orden=11 THEN @impuesto2 WHEN i3.orden=11 THEN @impuesto3 WHEN i4.orden=11 THEN @impuesto4 ELSE 0 END)) AS impcol11,\
			SUM(@impcol3:=(CASE WHEN i1.orden=3 THEN @impuesto1 WHEN i2.orden=3 THEN @impuesto2 WHEN i3.orden=3 THEN @impuesto3 WHEN i4.orden=3 THEN @impuesto4 ELSE 0 END)) AS impcol3,\
			SUM(@impcol4:=(CASE WHEN i1.orden=4 THEN @impuesto1 WHEN i2.orden=4 THEN @impuesto2 WHEN i3.orden=4 THEN @impuesto3 WHEN i4.orden=4 THEN @impuesto4 ELSE 0 END)) AS impcol4,\
			SUM(@impcol9:=(CASE WHEN i1.orden=9 THEN @impuesto1 WHEN i2.orden=9 THEN @impuesto2 WHEN i3.orden=9 THEN @impuesto3 WHEN i4.orden=9 THEN @impuesto4 ELSE 0 END)) AS impcol9,\
			SUM(@impcol5:=(CASE WHEN i1.orden=5 THEN @impuesto1 WHEN i2.orden=5 THEN @impuesto2 WHEN i3.orden=5 THEN @impuesto3 WHEN i4.orden=5 THEN @impuesto4 ELSE 0 END)) AS impcol5,\
			SUM(@impcol6:=(CASE WHEN i1.orden=6 THEN @impuesto1 WHEN i2.orden=6 THEN @impuesto2 WHEN i3.orden=6 THEN @impuesto3 WHEN i4.orden=6 THEN @impuesto4 ELSE 0 END)) AS impcol6,\
			SUM(@impcol10:=(CASE WHEN i1.orden=10 THEN @impuesto1 WHEN i2.orden=10 THEN @impuesto2 WHEN i3.orden=10 THEN @impuesto3 WHEN i4.orden=10 THEN @impuesto4 ELSE 0 END)) AS impcol10\
			FROM notascredcli n\
			INNER JOIN dnotascredcli dn ON n.referencia=dn.referencia\
			INNER JOIN articulos ON dn.articulo=articulos.articulo\
			INNER JOIN productos prod ON articulos.producto=prod.producto \
			INNER JOIN ventas v ON v.referencia=n.venta\
			INNER JOIN clientes cli ON v.cliente=cli.cliente\
			INNER JOIN dventas dv ON v.referencia=dv.referencia AND dn.articulo=dv.articulo\
			INNER JOIN terminales ter ON ter.terminal=v.terminal \
			INNER JOIN secciones sec ON ter.seccion=sec.seccion \
			LEFT JOIN auximpuestos1 i1 ON i1.impuesto=dv.claveimp1\
			LEFT JOIN auximpuestos2 i2 ON i2.impuesto=dv.claveimp2\
			LEFT JOIN auximpuestos3 i3 ON i3.impuesto=dv.claveimp3\
			LEFT JOIN auximpuestos4 i4 ON i4.impuesto=dv.claveimp4\
			LEFT JOIN cfd cfdv ON v.referencia=cfdv.referencia AND cfdv.tipocomprobante='VENT' AND cfdv.estado=1\
			LEFT JOIN cfd cfdn ON n.referencia=cfdn.referencia AND cfdn.tipocomprobante='NCRE' and cfdn.estado=1\
			WHERE n.cancelado=0\
			AND n.venta IN (select referencia FROM auxresultado	GROUP BY referencia)\
			group by n.referencia, articulos.articulo into outfile '%s'",archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxresultadonotas",archivo_temp9);
		instrucciones[num_instrucciones++] = instruccion;



        consulta = "SELECT cliente, rsocial, rfcreceptor,\
			FechaNota, FolioNota, uuidNotaCred, Articulo,\
			concat(NombreProducto,' ',present) AS NombreProducto,\
			FolioVenta, FechaVenta, Factura, UuidFactura,\
			tipodescrito AS TipoNota,\
			sum(subnograbado+impcol11) AS SubIva0,\
			sum(subgrabado+iespstotal-impcol11) AS SubIva16,\
			SUM(ivatotal) AS Iva,\
			sum(subtotal)+SUM(ivatotal)+SUM(iespstotal) AS total\
			FROM auxresultadonotas\
			GROUP BY FolioNota,FolioVenta, Articulo \
			ORDER BY rsocial, FolioNota,\
					 articulo,FechaNota,\
					 FechaVenta, FolioVenta, subtotal";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
				TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L);

        if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
        }


	}__finally{
		delete buffer_sql;
		delete aux_buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_REP_VCAD
void ServidorReportes::EjecutaRepVCAD(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros)
{
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	int i = 0;
	AnsiString instruccion, consulta, instrucciones[1000];
	AnsiString fechaini = " ", fechafin = " ";

	AnsiString archivo_temp1 = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));


	try{
		instruccion.sprintf("SET @fechainicial='%s'", fechaini);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SET @fechafinal='%s'", fechafin);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auximpuestos (\
			impuesto INT(2), PRIMARY KEY(impuesto)) ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auximpuestos (impuesto) SELECT impuesto FROM impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auximpuestos1 ( \
			orden INT(2), impuesto INT(2), tipoimpu CHAR(10),\
			porcentaje DECIMAL(5,2), nombre VARCHAR(40), PRIMARY\
			KEY(impuesto), INDEX(orden), INDEX(tipoimpu)) ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auximpuestos1 ( orden,impuesto,tipoimpu,\
			porcentaje,nombre)\
			SELECT i.impuesto AS orden, i.impuesto AS impuesto,\
			i.tipoimpu AS tipoimpu, i.porcentaje AS porcentaje,\
			t.nombre AS nombre FROM impuestos i,\
			tiposdeimpuestos t, auximpuestos aux \
			WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auximpuestos2 (orden INT(2),\
			impuesto INT(2),tipoimpu CHAR(10),porcentaje DECIMAL(5,2),\
			nombre VARCHAR(40),PRIMARY KEY(impuesto),\
			INDEX(orden),INDEX(tipoimpu)) ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auximpuestos2 ( orden,impuesto,\
			tipoimpu, porcentaje, nombre)\
			SELECT i.impuesto AS orden, i.impuesto AS impuesto,\
			i.tipoimpu AS tipoimpu, i.porcentaje AS porcentaje,\
			t.nombre AS nombre FROM impuestos i,\
			tiposdeimpuestos t, auximpuestos aux \
			WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auximpuestos3 ( orden INT(2),\
			impuesto INT(2),tipoimpu CHAR(10), porcentaje DECIMAL(5,2),\
			nombre VARCHAR(40), PRIMARY KEY(impuesto),\
			INDEX(orden), INDEX(tipoimpu)) ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auximpuestos3 ( orden, impuesto,\
			tipoimpu, porcentaje, nombre)\
			 SELECT i.impuesto AS orden, i.impuesto AS impuesto,\
			 i.tipoimpu AS tipoimpu, i.porcentaje AS porcentaje,\
			 t.nombre AS nombre FROM impuestos i,\
			 tiposdeimpuestos t, auximpuestos aux\
			 WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "CREATE TEMPORARY TABLE auximpuestos4 ( orden INT(2),\
			impuesto INT(2), tipoimpu CHAR(10), porcentaje DECIMAL(5,2),\
			nombre VARCHAR(40), PRIMARY KEY(impuesto),\
			INDEX(orden), INDEX(tipoimpu)) ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "INSERT INTO auximpuestos4 ( orden,\
			impuesto, tipoimpu, porcentaje, nombre)\
			SELECT i.impuesto AS orden, i.impuesto AS impuesto,\
			i.tipoimpu AS tipoimpu, i.porcentaje AS porcentaje,\
			t.nombre AS nombre FROM impuestos i,\
			tiposdeimpuestos t, auximpuestos aux\
			WHERE i.tipoimpu=t.tipoimpu AND aux.impuesto=i.impuesto";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auxresultado (\
			nombre varchar(255), rfc varchar(13), fechavta DATE,\
			factura varchar(20), muuidVenta varchar(36), articulo varchar(9),\
			nomproducto varchar(120), ReferenciaFactura varchar(11),\
			valorconsiderado decimal (16,2), valorventa decimal (16,6),\
			descuento decimal (16,6), subtotal decimal (16,6),\
			imp1 decimal (16,6), imp2 decimal (16,6),\
			imp3 decimal (16,6), imp4 decimal (16,6), iva1 decimal (16,6),\
			iva2 decimal (16,6), iva3 decimal (16,6), subgrabado decimal (16,6),\
			subnograbado decimal (16,6), impcol2 decimal (16,6),\
			impcol8 decimal (16,6), impcol12 decimal (16,6),\
			impcol13 decimal (16,6), impcol11 decimal (16,6),\
			impcol3 decimal (16,6), impcol4 decimal (16,6),\
			impcol9 decimal (16,6), impcol5 decimal (16,6),\
			impcol6 decimal (16,6), impcol10 decimal (16,6),\
			Sub_IVA_0 decimal (16,6), Sub_IVA_16 decimal (16,6),\
			Total_IVA decimal (16,6), GranTotal decimal (16,6),\
			banco varchar (100) )ENGINE = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 =
				mServidorVioleta->ObtieneArchivoTemp(1,Respuesta->Id);

		instruccion.sprintf("SELECT \
						cli.rsocial AS Nombre,\
						if(LENGTH(cli.rfc)>10,cli.rfc,cfd2.rfcreceptor ) AS RFC,\
						v.fechavta,\
						coalesce(concat(cfd.serie,cfd.folio),\
						concat(cfd2.serie,cfd2.folio),'') AS factura,\
						coalesce(cfd.muuid,cfd2.muuid,'') AS muuidVenta,\
						dv.articulo,\
						concat(prod.nombre , ' ', articulos.present) AS nomproducto,\
						v.referencia AS ReferenciaFactura,\
						(dv.precioimp*(bdv.valorconsiderado/v.valor)*(dv.cantidad)) AS valorconsiderado,\
						v.valor AS valorventa,\
						(@descuento:=((dv.precio*(bdv.valorconsiderado/v.valor))*dv.cantidad*(dv.porcdesc/100))) AS descuento,\
						 @subtotal:=((dv.precio*(bdv.valorconsiderado/v.valor))*dv.cantidad*(1-dv.porcdesc/100)) AS subtotal,\
						(@impuesto1:=if (ISNULL(i1.porcentaje),0, @subtotal *(i1.porcentaje/100))) AS imp1,\
						(@impuesto2:=if (ISNULL(i2.porcentaje),0, (@subtotal + @impuesto1) * (i2.porcentaje/100))) AS imp2,\
						(@impuesto3:=if (ISNULL(i3.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2) * (i3.porcentaje/100))) AS imp3,\
						(@impuesto4:=if (ISNULL(i4.porcentaje),0, (@subtotal + @impuesto1 + @impuesto2 + @impuesto3) * (i4.porcentaje/100))) AS imp4,\
						(@iva1:=if (@impuesto1>0 AND IFNULL(i1.tipoimpu,'')='IVA', @impuesto1, 0)) AS iva1,\
						(@iva2:=if (@impuesto2>0 AND IFNULL(i2.tipoimpu,'')='IVA', @impuesto2, 0)) AS iva2,\
						(@iva3:=if (@impuesto3>0 AND IFNULL(i3.tipoimpu,'')='IVA', @impuesto3, 0)) AS iva3,\
						(@subgrabado:=if((@iva1+@iva2)>0, @subtotal, 0)) AS subgrabado,\
						(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal, 0)) AS subnograbado,\
						(@impcol2:=(CASE WHEN i1.orden=2 THEN @impuesto1 WHEN i2.orden=2 THEN @impuesto2 WHEN i3.orden=2 THEN @impuesto3 WHEN i4.orden=2 THEN @impuesto4 ELSE 0 END)) AS impcol2,\
						(@impcol8:=(CASE WHEN i1.orden=8 THEN @impuesto1 WHEN i2.orden=8 THEN @impuesto2 WHEN i3.orden=8 THEN @impuesto3 WHEN i4.orden=8 THEN @impuesto4 ELSE 0 END)) AS impcol8,\
						(@impcol12:=(CASE WHEN i1.orden=12 THEN @impuesto1 WHEN i2.orden=12 THEN @impuesto2 WHEN i3.orden=12 THEN @impuesto3 WHEN i4.orden=12 THEN @impuesto4 ELSE 0 END)) AS impcol12,\
						(@impcol13:=(CASE WHEN i1.orden=13 THEN @impuesto1 WHEN i2.orden=13 THEN @impuesto2 WHEN i3.orden=13 THEN @impuesto3 WHEN i4.orden=13 THEN @impuesto4 ELSE 0 END)) AS impcol13,\
						(@impcol11:=(CASE WHEN i1.orden=11 THEN @impuesto1 WHEN i2.orden=11 THEN @impuesto2 WHEN i3.orden=11 THEN @impuesto3 WHEN i4.orden=11 THEN @impuesto4 ELSE 0 END)) AS impcol11,\
						(@impcol3:=(CASE WHEN i1.orden=3 THEN @impuesto1 WHEN i2.orden=3 THEN @impuesto2 WHEN i3.orden=3 THEN @impuesto3 WHEN i4.orden=3 THEN @impuesto4 ELSE 0 END)) AS impcol3,\
						(@impcol4:=(CASE WHEN i1.orden=4 THEN @impuesto1 WHEN i2.orden=4 THEN @impuesto2 WHEN i3.orden=4 THEN @impuesto3 WHEN i4.orden=4 THEN @impuesto4 ELSE 0 END)) AS impcol4,\
						(@impcol9:=(CASE WHEN i1.orden=9 THEN @impuesto1 WHEN i2.orden=9 THEN @impuesto2 WHEN i3.orden=9 THEN @impuesto3 WHEN i4.orden=9 THEN @impuesto4 ELSE 0 END)) AS impcol9,\
						(@impcol5:=(CASE WHEN i1.orden=5 THEN @impuesto1 WHEN i2.orden=5 THEN @impuesto2 WHEN i3.orden=5 THEN @impuesto3 WHEN i4.orden=5 THEN @impuesto4 ELSE 0 END)) AS impcol5,\
						(@impcol6:=(CASE WHEN i1.orden=6 THEN @impuesto1 WHEN i2.orden=6 THEN @impuesto2 WHEN i3.orden=6 THEN @impuesto3 WHEN i4.orden=6 THEN @impuesto4 ELSE 0 END)) AS impcol6,\
						(@impcol10:=(CASE WHEN i1.orden=10 THEN @impuesto1 WHEN i2.orden=10 THEN @impuesto2 WHEN i3.orden=10 THEN @impuesto3 WHEN i4.orden=10 THEN @impuesto4 ELSE 0 END)) AS impcol10,\
						@Sub_IVA_0:=(@subnograbado+@impcol11) AS Sub_IVA_0,\
						@Sub_IVA_16:=(@subgrabado+(@impcol12 + @impcol13 + @impcol3 + @impcol4 + @impcol9 + @impcol5 + @impcol6 + @impcol10)) AS Sub_IVA_16,\
						@impcol8 AS Total_IVA,\
						(@Sub_IVA_0 + @Sub_IVA_16 + @impcol8) AS GranTotal,\
						CONCAT( bc.numerocuenta,' - ', bc.descripcion) AS banco\
						FROM ventas v\
						INNER JOIN clientes cli on cli.cliente=v.cliente \
						INNER JOIN dventas dv ON 	dv.referencia=v.referencia\
						INNER JOIN articulos ON articulos.articulo=dv.articulo\
						INNER JOIN productos prod ON articulos.producto=prod.producto\
						INNER JOIN presentaciones pre ON articulos.producto=pre.producto AND articulos.present = pre.present\
						INNER JOIN empleados e ON v.usualta=e.empleado\
						INNER JOIN terminales ter ON ter.terminal=v.terminal\
						INNER JOIN secciones sec ON ter.seccion=sec.seccion\
						INNER JOIN sucursales suc ON sec.sucursal=suc.sucursal AND suc.idempresa = %s\
						LEFT JOIN cfd ON v.referencia=cfd.referencia AND cfd.tipocomprobante='VENT' AND cfd.estado=1\
						LEFT JOIN cfd as cfd2 ON cfd2.referencia=DATE_FORMAT(v.fechavta, '%%d/%%m/%%Y') AND cfd2.estado=1 AND cfd2.sucursal=sec.sucursal AND cfd2.tipocomprobante='TICK'\
						LEFT JOIN auximpuestos1 i1 ON i1.impuesto=dv.claveimp1\
						LEFT JOIN auximpuestos2 i2 ON i2.impuesto=dv.claveimp2\
						LEFT JOIN auximpuestos3 i3 ON i3.impuesto=dv.claveimp3\
						LEFT JOIN auximpuestos4 i4 ON i4.impuesto=dv.claveimp4 \
						INNER JOIN bancosdventas bdv ON bdv.venta=v.referencia\
						INNER JOIN bancosventasdef bdef ON bdef.idbancosventas=bdv.idbancosventas AND bdef.cancelado=0\
						INNER JOIN bancosmov bm ON bm.idmovbanco=bdv.idmovbanco AND bm.cancelado=0 AND bm.aplicado=1\
						INNER join bancoscuentas bc ON bc.idnumcuenta= bm.idnumcuenta\
						WHERE v.acredito=0 AND v.cancelado=0 AND v.fechavta>=@fechainicial AND v.fechavta<= @fechafinal\
						AND bm.idmovbanco IS not NULL INTO OUTFILE '%s'",
						FormServidor->ObtieneClaveEmpresa() ,archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("load data infile '%s' into table auxresultado",archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		consulta = "SELECT nombre, rfc, fechavta, muuidventa, articulo,\
			nomproducto, ReferenciaFactura as Referencia, factura,\
			sum(Sub_IVA_0) AS SubIva0, Sum(Sub_IVA_16) AS SubIva16,\
			sum(Total_IVA) AS IVA , sum(GranTotal) AS Total,\
			banco FROM auxresultado\
			GROUP BY ReferenciaFactura, articulo, banco\
			ORDER BY fechavta,ReferenciaFactura, nomproducto";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE*4L);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}__finally{
        delete buffer_sql;
		delete aux_buffer_sql;

		mServidorVioleta->BorraArchivoTemp(archivo_temp1);
    }


}

// ---------------------------------------------------------------------------
// ID_REP_PEDIDOS_X_PROV_DOC
void ServidorReportes::EjecutaRepPedidosXProvDoc(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros)
{
	 char *buffer_sql = new char[1024 * 64];
	 char *aux_buffer_sql = buffer_sql;
	 DatosTabla datos(mServidorVioleta->Tablas);
	 int num_instrucciones = 0;
	 AnsiString instruccion,consulta,instrucciones[1000];
	 AnsiString fecha_inicial, fecha_final, acredito, proveedor, almacen,
				canceladas, fechas_canceladas, tipo_canceladas,campos_base,
				incluir_devoluciones, fecha_limite_devoluciones, empresa, sucursal,
				archivo_temp1,archivo_temp2,archivo_temp3,archivo_temp4,
				archivo_temp5, supervisado,order_by,
				respuesta_esperada, consulta_select,group_by,
				empleado_supervisor, comprador, impuesto = " ",
				condicion_acredito = " ", condicion_proveedor = " ",
				condicion_almacen = " ", condicion_canceladas = " ",
				condicion_empresa = " ", condicion_sucursal = " ",
				cad_suma_impuesto = " ", cad_val_impuesto = " ",
				campos_suma_impuestos = " ", campos_val_impuestos = " ",
				condicion_comprador = " ", campo_supervisado = " ",
				condicion_supervisado = " ", join_supervisado = " ";
	 BufferRespuestas* resp_impuestos = NULL;
	 AnsiString parte_relacionada = " ", condicion_parte_relacionada = " ",
	 clave_producto = " ", condicion_producto = " ";
	 AnsiString left_joins_recepciones = " ";

	 try{
		fecha_inicial=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_final=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);
		canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		tipo_canceladas = mFg.ExtraeStringDeBuffer(&parametros);
		acredito = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		almacen = mFg.ExtraeStringDeBuffer(&parametros);
		comprador = mFg.ExtraeStringDeBuffer(&parametros);
		empleado_supervisor = mFg.ExtraeStringDeBuffer(&parametros);
		group_by = "group by p.referencia";
		order_by = "order by p.referencia";
		respuesta_esperada = mFg.ExtraeStringDeBuffer(&parametros);
		parte_relacionada = mFg.ExtraeStringDeBuffer(&parametros);
		clave_producto = mFg.ExtraeStringDeBuffer(&parametros);

		instruccion.sprintf("SELECT i.impuesto FROM impuestos i \
			INNER JOIN tiposdeimpuestos ti ON i.tipoimpu=ti.tipoimpu \
			WHERE porcentaje>0 \
			ORDER BY ti.tipoimpu DESC, i.porcentaje");
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_impuestos);

		for (int i = 0; i < resp_impuestos->ObtieneNumRegistros(); i++) {
			resp_impuestos->IrAlRegistroNumero(i);
			impuesto = resp_impuestos->ObtieneDato("impuesto");
			cad_val_impuesto.sprintf("sum(@impcol%s:=(case when i1.orden=%s\
				then @impuesto1 when i2.orden=%s then @impuesto2\
				when i3.orden=%s then @impuesto3 when i4.orden=%s\
				then @impuesto5 when i5.orden=%s then @impuesto5 else 0 end))\
				as impcol%s", impuesto, impuesto, impuesto, impuesto, impuesto,
				impuesto, impuesto);
			campos_val_impuestos += cad_val_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1) {
				campos_val_impuestos += ", ";
			}
			cad_suma_impuesto.sprintf("@impcol%s", impuesto);
			campos_suma_impuestos += cad_suma_impuesto;
			if (i < resp_impuestos->ObtieneNumRegistros() - 1) {
				campos_suma_impuestos += "+";
			}
		}

        if (empresa != " ") {
			condicion_empresa.sprintf("suc.idempresa = %s and ", empresa);
		}

		if(sucursal != " "){
			condicion_sucursal.sprintf("sec.sucursal='%s' and", sucursal);
		}

		if (acredito != " ") {
			condicion_acredito.sprintf("p.acredito='%s' and", acredito);
		}

		if (proveedor != " ") {
			condicion_proveedor.sprintf("p.proveedor='%s' and", proveedor);
		}

		if (almacen != " ") {
			condicion_almacen.sprintf("p.almacen='%s' and", almacen);
		}

		if (canceladas != " ") {
			condicion_canceladas.sprintf("p.cancelado=%s and", canceladas);
			if (canceladas == "1") {
				if (tipo_canceladas == "0") {
					fechas_canceladas.sprintf("p.fechamodi>='%s' and\
						p.fechamodi<='%s' and", fecha_inicial, fecha_final);
					order_by = "order by p.fechamodi";
				}
				else {
					fechas_canceladas.sprintf("p.fechaalta>='%s' and\
						p.fechaalta<='%s' and", fecha_inicial, fecha_final);
					order_by = "order by p.fechaalta";
				}
			}
			else {
				fechas_canceladas.sprintf("p.fechaped>='%s' and\
					p.fechaped<='%s' and", fecha_inicial, fecha_final);
			}
		}
		else {
			fechas_canceladas.sprintf("p.fechaped>='%s' and\
				p.fechaped<='%s' and ", fecha_inicial, fecha_final);
		}

		if (comprador != " ") {
			condicion_comprador.sprintf("p.comprador='%s' and", comprador);
		}

		join_supervisado = "left join articulossupervisados arts\
			on arts.producto = art.producto\
			and arts.present = art.present\
			left join empleados emp on emp.empleado=arts.usuario ";
		campo_supervisado.sprintf(", concat(emp.nombre, ' ', emp.appat,' ',\
			emp.apmat) AS supervisado");

		if (empleado_supervisor != " ") {
			condicion_supervisado.sprintf("arts.usuario ='%s' and",
				empleado_supervisor);
		}
		else {
			condicion_supervisado = " ";
		}

		if (parte_relacionada != " ") {
			condicion_parte_relacionada.sprintf("pro.esparterelac = %s AND", parte_relacionada);
		} else {
            condicion_parte_relacionada = " ";
		}

		if (clave_producto != " ") {
			condicion_producto.sprintf("art.producto = '%s' AND", clave_producto);
		} else {
            condicion_producto = " ";
		}

		instruccion.sprintf("set @fechainicial = '%s'", fecha_inicial);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal = '%s'", fecha_final);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "create temporary table auximpuestos(\
			impuesto int(2), primary key(impuesto)) Engine = InnoDB";
		instrucciones[num_instrucciones++] = instruccion;

		instruccion = "insert into auximpuestos (impuesto)\
			select impuesto from impuestos";
		instrucciones[num_instrucciones++] = instruccion;

		/* ============================== aux 1 ============================== */
		instruccion.sprintf("create temporary table auximpuestos1(\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu))\
			Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos1\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;
		/* ============================== aux 2 ============================== */
		instruccion.sprintf("create temporary table auximpuestos2(\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos2\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;
		/* ============================== aux 3 ============================== */
		instruccion.sprintf("create temporary table auximpuestos3(\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos3\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;
		/* ============================== aux 4 ============================== */
		instruccion.sprintf("create temporary table auximpuestos4(\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos4\
			(orden,impuesto,tipoimpu,porcentaje,nombre)", archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;
		/* ============================== aux 5 ============================== */
		instruccion.sprintf("create temporary table auximpuestos5(\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu)) Engine = InnoDB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("Select i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s' INTO TABLE auximpuestos5\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;
		/* ============================= end aux ============================= */

		campos_base = "sum(@unidades:=dp.cantidad*art.factor) as unidades,\
			sum(@suma:=IF(dp.costoimp = 0, dp.costo, dp.costoimp)*dp.cantidad) as suma,\
			sum(@descuento:=dp.costo*dp.cantidad*(p.descuento/100))\
				as descuento,\
			sum(@subtotal:=dp.costo*dp.cantidad*(1-p.descuento/100))\
				as subtotal,\
			sum(@iepscuota:=dp.cantidad*dp.iepscuota) as iepscuota,\
			sum(@impuesto1:=if(isnull(i1.porcentaje),0,\
			  (@subtotal-@iepscuota) *( i1.porcentaje/100))) as imp1,\
			sum(@impuesto2:=if (isnull(i2.porcentaje),0,\
			  (@subtotal + @impuesto1) * (i2.porcentaje/100))) as imp2,\
			sum(@impuesto3:=if (isnull(i3.porcentaje),0,\
			  (@subtotal + @impuesto1 + @impuesto2)\
			  *(i3.porcentaje/100))) as imp3,\
			sum(@impuesto4:=if (isnull(i4.porcentaje),0,\
			  (@subtotal + @impuesto1 + @impuesto2 + @impuesto3)\
			  * (i4.porcentaje/100)) ) as imp4,\
			sum(@impuesto5:=IF(ISNULL(i5.porcentaje),0,\
				(@subtotal*i5.porcentaje/100))) AS imp5,\
			sum(@iva1:=if(@impuesto1>0 and ifnull(i1.tipoimpu,'')='IVA',\
				@impuesto1,0)) as iva1,\
			sum(@iva2:=if(@impuesto2>0 and ifnull(i2.tipoimpu,'')='IVA',\
				@impuesto2,0)) as iva2,\
			sum(@subgrabado:=if((@iva1+@iva2)>0,@subtotal,0))\
				as subgrabado,\
			sum(@subnograbado:=if((@iva1+@iva2)<=0, @subtotal,0))\
				as subnograbado,";


		if (respuesta_esperada == 1) {
			consulta_select = "p.referencia as ped_referencia,\
				COALESCE(cpp.ref_compras, pedxrec.ref_compras, c.referencia, '') as com_referencia,\
				sec.sucursal as sucursal,\
				COALESCE(cpp.facturas, pedxrec.facturas, c.folioprov, '') as factura,\
				c.muuid as com_uuid,\
				p.fechaped as fecha_pedido,\
				p.proveedor,\
				pro.razonsocial,\
				p.almacen,\
				pro.rfc,\
				cfdi.fechatimbrado,\
				p.comprador as comprador,";

			// para traer todas las compras de los pedidos de la recepción
			left_joins_recepciones.sprintf(" LEFT JOIN ( \
					SELECT cpp.pedido, GROUP_CONCAT(DISTINCT cpp.compra SEPARATOR ',') AS ref_compras, \
					GROUP_CONCAT(DISTINCT c.folioprov SEPARATOR ',') AS facturas \
					FROM compras c \
					INNER JOIN compraspedidosprov cpp ON c.referencia = cpp.compra \
					INNER JOIN terminales t ON t.terminal = c.terminal \
					INNER JOIN secciones sec ON sec.seccion = t.seccion \
					INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					WHERE %s 1 \
					GROUP BY cpp.pedido \
				) cpp ON cpp.pedido = p.referencia \
				LEFT JOIN ( \
					SELECT pr.pedido, GROUP_CONCAT(DISTINCT c.referencia SEPARATOR ',') AS ref_compras, \
					GROUP_CONCAT(DISTINCT c.folioprov SEPARATOR ',') AS facturas \
					FROM compras c \
					INNER JOIN comprecepcion cr ON cr.compra = c.referencia \
					INNER JOIN recepciones r ON r.recepcion = cr.recepcion \
					INNER JOIN pedrecepcion pr ON pr.recepcion = r.recepcion \
					INNER JOIN terminales t ON t.terminal = c.terminal \
					INNER JOIN secciones sec ON sec.seccion = t.seccion \
					INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
					WHERE %s 1 \
					GROUP BY pr.pedido \
				) pedxrec ON pedxrec.pedido = p.referencia ",
			condicion_empresa, condicion_empresa);
		}
		else if (respuesta_esperada == 2) {
			consulta_select = "sum(dp.cantidad) as cantidad_x_art,\
				art.articulo,\
				art.multiplo,\
				art.factor,\
				pr.nombre as nomproducto,\
				art.present,\
				art.ean13  AS codbarMay,\
				pr.producto as producto,";
			group_by = "group by pr.nombre, art.present, art.multiplo";
			order_by = "order by pr.nombre, art.present, art.multiplo";
		}

		consulta.sprintf("select\
            %s\
			%s\
			%s\
			%s\
			from pedidos p\
			inner join dpedidos dp on p.referencia=dp.referencia\
			inner join articulos art on dp.articulo=art.articulo\
			left join compras c on c.referencia=p.compra\
			inner join almacenes alm ON alm.almacen=p.almacen\
			LEFT JOIN secciones sec ON sec.seccion=alm.seccion\
			inner join sucursales suc on suc.sucursal = sec.sucursal \
			INNER JOIN proveedores pro ON p.proveedor=pro.proveedor\
			LEFT JOIN cfdicompras cfdi ON cfdi.referencia = c.referencia\
            inner join productos pr on pr.producto=art.producto\
			left join auximpuestos1 i1 on i1.impuesto=dp.claveimp1\
			left join auximpuestos2 i2 on i2.impuesto=dp.claveimp2\
			left join auximpuestos3 i3 on i3.impuesto=dp.claveimp3\
			left join auximpuestos4 i4 on i4.impuesto=dp.claveimp4\
			LEFT JOIN auximpuestos5 i5 ON i5.impuesto=p.impuestoret\
			%s \
            %s \
			where %s %s %s %s %s %s %s %s %s %s %s \
			1 \
			%s \
			%s", consulta_select, campos_base, campos_val_impuestos,
			campo_supervisado, join_supervisado,
			left_joins_recepciones, condicion_empresa,
			condicion_sucursal, condicion_acredito, condicion_proveedor,
			condicion_almacen, condicion_canceladas, fechas_canceladas,
			condicion_comprador, condicion_supervisado, condicion_parte_relacionada,
			condicion_producto, group_by, order_by);

		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);

		for (int i = 0; i < num_instrucciones; i++) {
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		}
	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_EJE_BITACORA_MOD_CLAVE_ART
void ServidorReportes::EjecutaBitacoraModClaveArt(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, articulo, producto;
	AnsiString condicion_articulo = " ", condicion_producto = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	articulo = mFg.ExtraeStringDeBuffer(&parametros);
	producto = mFg.ExtraeStringDeBuffer(&parametros);

	if (articulo != " ") {
		condicion_articulo.sprintf(" AND b.articulo='%s' ", articulo);
	}

	if (producto != " ") {
        condicion_producto.sprintf(" AND b.articulo IN (SELECT art.articulo FROM articulos art WHERE art.producto = '%s')", producto);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
	instruccion.sprintf("SELECT \
	b.articulo, \
	prod.nombre, \
	b.productoant, \
	b.productonuevo, \
	b.presentant, \
	b.presentnuevo, \
	b.multiploant, \
	b.multiplonuevo, \
	IF(b.tipo = 1, 'Producto', IF(b.tipo = 2, 'Presentación', 'Múltiplo')) AS tipo, \
	b.usumodi, \
	CONCAT(e.nombre,' ',e.appat,' ',e.appat) AS nombre, \
	b.fechamodi, \
	b.horamodi \
	FROM bitacoramodart b \
	LEFT JOIN articulos art ON art.articulo = b.articulo \
	LEFT JOIN productos prod ON art.producto = prod.producto \
	INNER JOIN empleados e ON e.empleado = b.usumodi \
	WHERE b.fechamodi BETWEEN '%s' AND '%s' \
    %s %s \
	ORDER BY b.fechamodi, b.horamodi DESC ", fechaini, fechafin,
		condicion_articulo, condicion_producto);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_BITACORA_SERVIDOR
void ServidorReportes::EjecutaRepBitacoraServidor(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	AnsiString instruccion;

	AnsiString fecha_ini, fecha_fin, accion, sucursal;
	AnsiString consulta_accion = " ";
	AnsiString condicion_sucursal = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	accion = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);

	if (accion != " ") {
		consulta_accion.sprintf("AND accion IN(%s) ", accion);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND sucursal = '%s' ", sucursal);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT id, sucursal, DATE_FORMAT(fecha,'%%d/%%m/%%Y %%H:%%i:%%s')AS fechaFormat, accion \
						FROM bitacoraservidor WHERE fecha>='%s' AND fecha<='%s' %s %s \
						ORDER BY sucursal, fecha DESC ", fecha_ini, fecha_fin,
		consulta_accion, condicion_sucursal);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_DIF_PESO
void ServidorReportes::EjecutaRepDifPeso(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT pro.producto,\
			pro.nombre,\
			pre.present,\
			art.multiplo,\
			art.factor,\
			art.articulo,\
			art.peso AS pesounidad,\
			art2.multiplo as multiplo2,\
			art2.factor as factormultiplo2,\
			art2.peso AS pesomultiplo2,\
			round(if(art.peso>0,art2.peso/(art.peso*art2.factor),0),2) AS relacionpesounidad,\
			ABS(round(if(art.peso>0,art2.peso/(art.peso*art2.factor),0),2)-1) as difrelacion\
			from productos pro\
			INNER JOIN presentaciones pre ON pro.producto=pre.producto\
			INNER JOIN articulos art ON art.producto=pro.producto AND art.present=pre.present\
			INNER JOIN (\
			SELECT art.producto, art.present, art.multiplo, art.factor, art.peso\
			from articulos art\
			WHERE art.activo=1 AND art.factor>1\
			) art2 ON art2.producto=pro.producto AND art2.present=pre.present\
			WHERE art.activo=1 AND art.factor=1\
			HAVING relacionpesounidad<.80\
			OR relacionpesounidad>1.2\
			OR (pesounidad=pesomultiplo2\
			OR pesounidad=0\
			OR pesomultiplo2=0)\
			ORDER BY difrelacion DESC");
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_DIF_VOL
void ServidorReportes::EjecutaRepDifVolumen(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *resultado_select = NULL;
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT\
	pro.producto,\
	pro.nombre,\
	pre.present,\
	art.multiplo,\
	art.factor,\
	art.articulo,\
	art.volumen AS volumenunidad,\
	art2.multiplo as multiplo2,\
	art2.factor as factormultiplo2,\
	art2.volumen AS volumenmultiplo2,\
	round(if(art.volumen>0, art2.volumen/(art.volumen*art2.factor),0), 2) AS relacionvolumenunidad,\
	ABS(round(if(art.volumen>0, art2.volumen/(art.volumen*art2.factor),0), 2)-1) as difrelacion \
	from productos pro\
	INNER JOIN presentaciones pre ON pro.producto=pre.producto\
	INNER JOIN articulos art ON art.producto=pro.producto AND art.present=pre.present\
	INNER JOIN ( \
	SELECT art.producto, art.present, art.multiplo, art.factor, art.volumen\
	from articulos art\
	WHERE art.activo=1 AND art.factor>1\
	) art2 ON art2.producto=pro.producto AND art2.present=pre.present\
	WHERE art.activo=1\
	AND art.factor=1\
	HAVING relacionvolumenunidad<.80\
	OR relacionvolumenunidad>1.2\
	OR (volumenunidad=volumenmultiplo2\
	OR volumenunidad=0\
	OR volumenmultiplo2=0)\
	ORDER BY difrelacion DESC");
	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_GRA_PROD_X_COTIZAR
void ServidorReportes::EjecutaGrabaListaProductosCotizar
	(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	BufferRespuestas* resp_articulos = NULL;
	BufferRespuestas* resp_id = NULL;
	char *buffer_sql = new char[1024 * 1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[30000];
	AnsiString Instruccion;

	AnsiString usuario, terminal, articulo;
	int num_registros;

	try {
		usuario = mFg.ExtraeStringDeBuffer(&parametros);
		terminal = mFg.ExtraeStringDeBuffer(&parametros);
		num_registros = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

		instrucciones[num_instrucciones++] = "SET AUTOCOMMIT=0";
		instrucciones[num_instrucciones++] = "START TRANSACTION";

		instruccion.sprintf("INSERT INTO prodxcotizar (usuario, fecha, hora, terminal, activo) VALUES \
		('%s', CURDATE(), CURTIME(), '%s', 1) ", usuario, terminal);
		instrucciones[num_instrucciones++] = instruccion;

		instrucciones[num_instrucciones++] = "set @id:=LAST_INSERT_ID()";

		for (int i = 1; i <= num_registros; i++) {
			articulo = mFg.ExtraeStringDeBuffer(&parametros);

			try {
				Instruccion.sprintf("SELECT prod.nombre, a.producto, a.present, a.multiplo, a.factor, \
				a.ean13, a.articulo, auni.ean13 AS codbarrauni, fab.nombre as fabricante \
				FROM articulos a \
				INNER JOIN productos prod ON prod.producto = a.producto \
				INNER JOIN articulos auni ON auni.producto = a.producto AND auni.present = a.present AND auni.factor = 1 \
				INNER JOIN fabricantes fab ON fab.fabricante = prod.fabricante \
				WHERE a.articulo = '%s'", articulo);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					Instruccion.c_str(), resp_articulos);

				if (resp_articulos->ObtieneNumRegistros() > 0) {

					instruccion.sprintf("INSERT INTO dprodxcotizar \
					(id, nombre, producto, present, multiplo, factor, codbarras, codbarrasuni, articulo, costo, observaciones, fabricante) \
					VALUES \
					(@id, '%s', '%s', '%s', '%s', %s, '%s', '%s', '%s', '0', '', '%s') ",
						resp_articulos->ObtieneDato("nombre"),
						resp_articulos->ObtieneDato("producto"),
						resp_articulos->ObtieneDato("present"),
						resp_articulos->ObtieneDato("multiplo"),
						resp_articulos->ObtieneDato("factor"),
						resp_articulos->ObtieneDato("ean13"),
						resp_articulos->ObtieneDato("codbarrauni"),
						resp_articulos->ObtieneDato("articulo"),
						resp_articulos->ObtieneDato("fabricante"));
					instrucciones[num_instrucciones++] = instruccion;
				}

			}
			__finally {
				if (resp_articulos != NULL)
					delete resp_articulos;
			}
		}

		instrucciones[num_instrucciones++] = "COMMIT";

		// Crea el buffer con todas las instrucciones SQL
		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
			aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion.sprintf("SELECT \
			dpxc.articulo, \
			REPLACE(dpxc.nombre,',','.') AS nombre, \
			REPLACE(dpxc.present,',','.') AS present, \
			dpxc.multiplo, \
			dpxc.factor, \
			dpxc.codbarras, \
			dpxc.codbarrasuni, \
			replace(dpxc.fabricante, ',' , ''), \
			'' AS costo, \
			'' AS observaciones, \
            '' as disponibilidad \
			FROM dprodxcotizar dpxc \
			WHERE dpxc.id = @id \
			ORDER BY nombre, producto, present");
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_REP_CPCA
void ServidorReportes::EjecutaRepCPCA(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	DatosTabla datos(mServidorVioleta->Tablas);
	int num_instrucciones = 0;
	AnsiString instruccion,consulta,instrucciones[1000];
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3,
			   archivo_temp4, archivo_temp5, archivo_temp6,
			   fecha_ini, fecha_fin, fecha_notas, empresa, sucursal;
	AnsiString condicion_empresa = " ", condicion_sucursal = " ";
	BufferRespuestas* resp_impuestos = NULL;

	try {

		fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fecha_notas = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
        empresa = mFg.ExtraeStringDeBuffer(&parametros);
		sucursal = mFg.ExtraeStringDeBuffer(&parametros);

		if(empresa != " ")
			condicion_empresa.sprintf(" and suc.idempresa = %s ", empresa);

		if(sucursal != " ")
          	condicion_sucursal.sprintf(" and suc.sucursal = '%s' ", sucursal);

		instruccion.sprintf("create temporary table auximpuestos\
			(impuesto int(2),\
			primary key(impuesto))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("insert into auximpuestos \
			(impuesto) select impuesto from impuestos");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table auximpuestos1 ( \
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT\
			i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE auximpuestos1\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp1);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table auximpuestos2 (\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT\
			i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE auximpuestos2\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp2);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table auximpuestos3 (\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT\
			i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE auximpuestos3\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp3);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table auximpuestos4 ( \
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto), \
			index(orden),\
			index(tipoimpu))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;
		archivo_temp4 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);
		instruccion.sprintf("SELECT\
			i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE auximpuestos4\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp4);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("create temporary table auximpuestos5 (\
			orden int(2),\
			impuesto int(2),\
			tipoimpu char(10),\
			porcentaje decimal(5,2),\
			nombre varchar(40),\
			primary key(impuesto),\
			index(orden),\
			index(tipoimpu))\
			Engine = INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp5 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("SELECT\
			i.impuesto as orden,\
			i.impuesto as impuesto,\
			i.tipoimpu as tipoimpu,\
			i.porcentaje as porcentaje,\
			t.nombre as nombre\
			from impuestos i,\
			tiposdeimpuestos t,\
			auximpuestos aux\
			where i.tipoimpu=t.tipoimpu\
			and aux.impuesto=i.impuesto\
			INTO OUTFILE '%s'", archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE auximpuestos5\
			(orden, impuesto, tipoimpu, porcentaje, nombre)", archivo_temp5);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SET @fechainicial = '%s'", fecha_ini);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinal='%s'", fecha_fin);
		instrucciones[num_instrucciones++] = instruccion;
		instruccion.sprintf("set @fechafinalnotas='%s'", fecha_notas);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("CREATE TEMPORARY TABLE  dnotascredprovaux (\
			compra varchar(11),\
			articulo varchar(9),\
			cantidad decimal(34,3),\
			costo decimal(38,6),\
			costoimp decimal(38,6),\
			INDEX(compra),INDEX(articulo))\
			ENGINE=INNODB;");
		instrucciones[num_instrucciones++] = instruccion;

		archivo_temp6 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
			Respuesta->Id);

		instruccion.sprintf("SELECT\
			c.referencia AS compra,\
			d.articulo,\
			SUM(if(n.tipo='0',d.cantidad,0)) AS cantidad,\
			SUM(if(n.tipo<>'0',d.costo,0)) AS costo,\
			SUM(if(n.tipo<>'0',d.costoimp,0)) AS costoimp\
			FROM notascredprov n\
			INNER JOIN dnotascredprov d\
			INNER JOIN compras c\
			INNER JOIN articulos\
			INNER JOIN productos prod \
			INNER JOIN terminales ter ON ter.terminal=c.terminal\
			INNER JOIN secciones sec ON ter.seccion=sec.seccion\
			WHERE c.fechacom>=@fechainicial\
			AND c.fechacom<=@fechafinal\
			AND n.compra=c.referencia\
			AND n.cancelado=0\
			AND c.cancelado=0\
			AND n.referencia=d.referencia\
			AND n.fechanot<=@fechafinalnotas\
			AND d.articulo=articulos.articulo\
			AND articulos.producto=prod.producto\
			GROUP BY c.referencia, d.articulo\
			INTO OUTFILE '%s'", archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("LOAD DATA INFILE '%s'\
			INTO TABLE dnotascredprovaux\
			(compra,articulo,cantidad,costo,costoimp)", archivo_temp6);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("CREATE TEMPORARY TABLE articulosunifaux ( \
			articulo VARCHAR(9) NULL DEFAULT NULL COLLATE 'latin1_swedish_ci',\
			articulorem VARCHAR(9) NOT NULL COLLATE 'latin1_swedish_ci',\
			PRIMARY KEY (articulo) USING BTREE,\
			INDEX articulorem (articulorem) USING BTREE)\
			COLLATE='latin1_swedish_ci' ENGINE=INNODB");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("INSERT INTO articulosunifaux\
			(articulo, articulorem)\
			SELECT au.articulo, MAX(au.articulorem) AS articulorem\
			FROM articulosunif au\
			WHERE articulo IS NOT NULL\
			GROUP BY articulo");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("SELECT\
			@sub_global:=SUM(@subtotal:= \
			(dc.costo- IFNULL(dn.costo,0))*\
			(dc.cantidad- IFNULL(dn.cantidad,0))*\
			(1-c.descuento/100)) AS subtotal\
			FROM compras c \
			INNER JOIN dcompras dc\
			INNER JOIN articulos \
			LEFT JOIN dnotascredprovaux dn ON dn.articulo=dc.articulo\
			AND dn.compra=c.referencia\
			WHERE c.fechacom>=@fechainicial\
			AND c.fechacom<=@fechafinal\
			AND c.referencia=dc.referencia\
			AND c.cancelado=0\
			AND dc.articulo=articulos.articulo");
		instrucciones[num_instrucciones++] = instruccion;

		consulta.sprintf("SELECT \
			sec.sucursal,\
			prov.proveedor,\
			prov.razonsocial AS nomproveedor,\
			amax.articulo AS articulomax,\
			amax.multiplo AS multiplomax,\
			amax.factor AS factormax,\
			amin.multiplo as multiplomin,\
			amin.factor AS factormin,\
			prod.nombre AS NombreProducto,\
			articulos.present,\
			COUNT(DISTINCT articulos.producto, articulos.present) AS skus,\
			c3.clasif3 AS clasificacion,\
			c3.nombre AS NombreClasificacion,\
			COALESCE(CONCAT(LEAST(au.articulo,au.articulorem),'-', GREATEST(au.articulo,au.articulorem)), \
				CONCAT(LEAST(au2.articulo,au2.articulorem),'-', GREATEST(au2.articulo,au2.articulorem)), \
				amax.articulo) AS idunificado, \
			SUM(@unidades:=(dc.cantidad- IFNULL(dn.cantidad,0))*articulos.factor) AS unidades, \
			SUM(@subtotal:=(dc.costo- IFNULL(dn.costo,0))*(dc.cantidad- IFNULL(dn.cantidad,0))*(1-c.descuento/100)) AS subtotal,\
			SUM((dc.costo- IFNULL(dn.costo,0))*(dc.cantidad- IFNULL(dn.cantidad,0))*(1-c.descuento/100))*100/@sub_global AS participacion,\
			@sub_global\
			FROM compras c\
			INNER JOIN dcompras dc \
			INNER JOIN articulos \
			INNER JOIN productos prod\
			INNER JOIN clasificacion1 c1 ON prod.clasif1=c1.clasif1\
			INNER JOIN clasificacion2 c2 ON prod.clasif2=c2.clasif2\
			INNER JOIN clasificacion3 c3 ON prod.clasif3=c3.clasif3\
			INNER JOIN proveedores prov\
			INNER JOIN presentacionesminmax pmm ON articulos.producto=pmm.producto AND articulos.present = pmm.present\
			INNER JOIN articulos amax ON pmm.producto=amax.producto AND pmm.present=amax.present AND pmm.maxmult=amax.multiplo\
			INNER JOIN articulos amin ON pmm.producto=amin.producto AND pmm.present=amin.present AND pmm.minmult=amin.multiplo\
			LEFT JOIN articulosunifaux au ON au.articulo=amax.articulo \
			LEFT JOIN articulosunifaux au2 ON au2.articulo=amin.articulo \
			LEFT JOIN dnotascredprovaux dn ON dn.articulo=dc.articulo AND dn.compra=c.referencia \
			LEFT join terminales ter ON ter.terminal=c.terminal \
			LEFT JOIN secciones sec ON sec.seccion=ter.seccion \
			INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal  \
			WHERE 1 %s %s \
			AND c.fechacom>=@fechainicial\
			AND c.fechacom<=@fechafinal \
			AND c.referencia=dc.referencia\
			AND c.cancelado=0 \
			AND c.proveedor=prov.proveedor \
			AND dc.articulo=articulos.articulo \
			AND articulos.producto=prod.producto\
			GROUP BY prov.proveedor, c3.clasif3, articulos.producto, articulos.present\
			ORDER BY prov.razonsocial, c3.nombre, prod.nombre, articulos.present",
			condicion_empresa, condicion_sucursal );

		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);

		for (int i = 0; i < num_instrucciones; i++) {
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);
		}

		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			instruccion = consulta;
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);

			mServidorVioleta->BorraArchivoTemp(archivo_temp1);
			mServidorVioleta->BorraArchivoTemp(archivo_temp2);
			mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			mServidorVioleta->BorraArchivoTemp(archivo_temp4);
			mServidorVioleta->BorraArchivoTemp(archivo_temp6);
			mServidorVioleta->BorraArchivoTemp(archivo_temp5);
		}

	}
	__finally {
		if (resp_impuestos != NULL)
			delete resp_impuestos;
		delete buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_REP_SALVENT
void ServidorReportes::EjecutaRepSALVENT(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT t.referencia, sum(if(t.aplicada=1, t.valor, 0))\
		AS saldoventa,vs.saldo\
		FROM ventas v\
		INNER JOIN transxcob t ON t.referencia=v.referencia\
			AND t.cancelada=0 AND t.aplicada=1\
		INNER JOIN ventasconsaldo vs ON vs.referencia=t.referencia\
		WHERE v.cancelado=0 AND v.acredito=1\
		GROUP BY t.referencia \
		HAVING saldoventa <> vs.saldo");

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_TRANSXCOB
void ServidorReportes::EjecutaRepTransXcob(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString referencia;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
	referencia = mFg.ExtraeStringDeBuffer(&parametros);

	instruccion.sprintf("SELECT referencia, tipo, aplicada, valor \
		FROM transxcob WHERE referencia = '%s'", referencia);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_RECEPCIONES
void ServidorReportes::EjecutaRepRecepciones(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{

	AnsiString instruccion;

	AnsiString fecha_ini, fecha_fin, empresa, sucursal, proveedor, recepcionista, comprador;
	AnsiString pedido, recepcion, compra;
	AnsiString condicion_sucursal=" ", condicion_proveedor=" ", condicion_recepcionista=" ", condicion_comprador=" ";
	AnsiString condicion_pedido=" ", condicion_recepcion= " ", condicion_compra=" ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	recepcionista = mFg.ExtraeStringDeBuffer(&parametros);
	comprador = mFg.ExtraeStringDeBuffer(&parametros);
	pedido = mFg.ExtraeStringDeBuffer(&parametros);
	recepcion = mFg.ExtraeStringDeBuffer(&parametros);
	compra = mFg.ExtraeStringDeBuffer(&parametros);

	if(empresa == " ") {
		empresa = FormServidor->ObtieneClaveEmpresa();
	}

	if(sucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
	}

	if(proveedor != " ") {
		condicion_proveedor.sprintf(" AND p.proveedor = '%s' ", proveedor);
	}

	if(recepcionista != " ") {
		condicion_recepcionista.sprintf(" AND rs.empleado = '%s' ", recepcionista);
	}

	if(comprador != " ") {
		condicion_comprador.sprintf(" AND c.comprador = '%s' ", comprador);
	}

	if(pedido != " ") {
		condicion_pedido.sprintf(" AND p.referencia = '%s' ", pedido);
	}

	if(recepcion != " ") {
		condicion_recepcion.sprintf(" AND r.recepcion = '%s' ", recepcion);
	}

	if(compra != " ") {
		condicion_compra.sprintf(" AND c.referencia = '%s' ", compra);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
			p.referencia AS pedido, \
			r.recepcion, \
			c.referencia AS compra, \
			prov.proveedor, \
			prov.razonsocial, \
			CASE WHEN r.recepcion IS NULL THEN 'PENDIENTE RECEPCIONAR' ELSE CASE WHEN c.referencia IS NULL THEN 'PENDIENTE FACTURAR' ELSE 'RECEPCIONADO' END END AS estatus , \
			p.fechaped, \
			p.fechaaduana, \
			r.fecharep, \
			r.horaini AS horaini, \
			r.horafin AS horafin, \
			c.fechacom, \
			c.horaalta \
		FROM pedidos p \
		INNER JOIN almacenes alma ON alma.almacen = p.almacen \
		INNER JOIN secciones sec ON sec.seccion = alma.seccion \
		INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
		INNER JOIN proveedores prov ON prov.proveedor = p.proveedor \
		LEFT JOIN compraspedidosprov cpp ON cpp.pedido = p.referencia \
		LEFT JOIN compras c ON c.referencia = cpp.compra \
		LEFT JOIN recepciones r ON r.recepcion = cpp.recepcion \
		LEFT JOIN recepcionistas rs ON rs.empleado = r.recepcionista \
		WHERE p.fechaped BETWEEN '%s' AND '%s' AND suc.idempresa = %s \
        AND p.cancelado = 0 AND c.cancelado = 0 AND r.cancelado = 0 \
        %s %s %s %s \
        %s %s %s \
		GROUP BY p.referencia, c.referencia, r.recepcion \
		ORDER BY r.recepcion DESC",
		fecha_ini, fecha_fin, empresa,
		condicion_sucursal, condicion_proveedor, condicion_recepcionista, condicion_comprador,
		condicion_pedido, condicion_recepcion, condicion_compra);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_REP_SURTIDO_ANAQUELES
void ServidorReportes::EjecutaRepSurtidoAnaqueles(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, empresa;
	AnsiString condicion_sucursal = " ", condicion_empresa = " ";

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	empresa = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND ra.sucursal = '%s' ", sucursal);
	}

	if (empresa != " ") {
        condicion_empresa.sprintf(" AND suc.idempresa = %s ", empresa);
	}

	instruccion.sprintf("SELECT \
	ra.articulo, \
	prod.nombre, \
	a.present, \
	a.multiplo, \
	ra.cantsurtir, \
	IF(TRUNCATE((ex.cantidad/a.factor),0) <= 0, 0, TRUNCATE((ex.cantidad/a.factor),0)) existencias, \
	ra.fechaalta, \
	ra.horaalta, \
	ra.sucursal, \
	ra.surtido, \
	ra.id\
	FROM resurtiranaquel ra \
	INNER JOIN articulos a ON a.articulo = ra.articulo \
	INNER JOIN productos prod ON prod.producto = a.producto \
	INNER JOIN existenciasactuales ex ON ex.producto = a.producto AND ex.present = a.present \
	INNER JOIN almacenes alm ON alm.almacen = ex.almacen \
	INNER JOIN secciones sec ON sec.seccion = alm.seccion AND sec.sucursal = ra.sucursal \
    INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
	WHERE ra.fechaalta BETWEEN '%s' AND '%s' %s %s \
    GROUP BY a.producto, a.present, ra.sucursal, ra.fechaalta, ra.horaalta \
	ORDER BY ra.fechaalta DESC, ra.horaalta DESC ", fechaini, fechafin,
		condicion_sucursal, condicion_empresa);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_EJE_REPDEV_RECEPCION
void ServidorReportes::EjecutaRepDevRecepciones(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, proveedor, pedido, recepcion;
	AnsiString condicion_sucursal = " ";
	AnsiString condicion_proveedor = " ";
	AnsiString condicion_pedido = " ";
	AnsiString condicion_recepcion = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	pedido = mFg.ExtraeStringDeBuffer(&parametros);
	recepcion = mFg.ExtraeStringDeBuffer(&parametros);

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND sec.sucursal = '%s' ", sucursal);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf(" AND rd.proveedor = '%s' ", proveedor);
	}

	if (pedido != " ") {
		condicion_pedido.sprintf(" AND pr.pedido = '%s' ", pedido);
	}

	if (recepcion != " ") {
		condicion_recepcion.sprintf(" AND rd.recepcion = '%s' ", recepcion);
	}

	instruccion.sprintf("SELECT \
	rd.devolucion, \
	rd.recepcion, \
	prov.proveedor, \
	prov.razonsocial, \
	CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS nombre, \
	drd.articulo, \
	prod.nombre, \
	a.present, \
	a.multiplo, \
	a.factor, \
	drd.cantidad, \
	drd.motivo \
	FROM recepcionesdevol rd \
	INNER JOIN drecepciondevol drd ON drd.devolucion = rd.devolucion \
	INNER JOIN proveedores prov ON prov.proveedor = rd.proveedor \
	INNER JOIN empleados e ON e.empleado = rd.usualta \
	INNER JOIN articulos a ON a.articulo = drd.articulo \
	INNER JOIN productos prod ON prod.producto = a.producto \
	INNER JOIN recepciones r ON r.recepcion = rd.recepcion \
	INNER JOIN terminales t ON t.terminal = r.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	LEFT JOIN pedrecepcion pr ON pr.recepcion = rd.recepcion \
	WHERE rd.fechaalta BETWEEN '%s' AND '%s' %s %s %s %s \
	GROUP BY drd.articulo ", fechaini, fechafin, condicion_sucursal,
		condicion_proveedor, condicion_pedido, condicion_recepcion);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(),
		Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_GRA_BITEMPLEADO
void ServidorReportes::bitacoraEmpleados(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[100];

	AnsiString empleado, nombre, appat, apmat, puesto, puestoant, depart, departant,
	jefe, jefeant, sucursal, sucursalant, activo, numempleado, nss, fechamodi,
	seccion, seccionant, solicitagasto, solicitagastoant, autorizagasto, autorizagastoant,
	rol, rolant, rfc, fechaalta, fechabaja, esSistema, usuariomodi, tarea, horamodi;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	empleado = mFg.ExtraeStringDeBuffer(&parametros);
	nombre = mFg.ExtraeStringDeBuffer(&parametros);
	appat = mFg.ExtraeStringDeBuffer(&parametros);
	apmat = mFg.ExtraeStringDeBuffer(&parametros);
	puesto = mFg.ExtraeStringDeBuffer(&parametros);
	puestoant = mFg.ExtraeStringDeBuffer(&parametros);
	depart = mFg.ExtraeStringDeBuffer(&parametros);
	departant = mFg.ExtraeStringDeBuffer(&parametros);
	jefe = mFg.ExtraeStringDeBuffer(&parametros);
	jefeant = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	sucursalant = mFg.ExtraeStringDeBuffer(&parametros);
	activo = mFg.ExtraeStringDeBuffer(&parametros);
	numempleado = mFg.ExtraeStringDeBuffer(&parametros);
	nss = mFg.ExtraeStringDeBuffer(&parametros);
	solicitagasto = mFg.ExtraeStringDeBuffer(&parametros);
	solicitagastoant = mFg.ExtraeStringDeBuffer(&parametros);
	autorizagasto = mFg.ExtraeStringDeBuffer(&parametros);
	autorizagastoant = mFg.ExtraeStringDeBuffer(&parametros);
	rfc = mFg.ExtraeStringDeBuffer(&parametros);
	fechaalta = mFg.ExtraeStringDeBuffer(&parametros);
	fechabaja = mFg.ExtraeStringDeBuffer(&parametros);
	usuariomodi = mFg.ExtraeStringDeBuffer(&parametros);
	tarea = mFg.ExtraeStringDeBuffer(&parametros);

	if(solicitagasto == "") solicitagasto = "0";
	if(solicitagastoant == "") solicitagastoant = "0";
	if(autorizagasto == "") autorizagasto = "0";
	if(autorizagastoant == "") autorizagastoant = "0";
	if(fechaalta == "") fechaalta = "0000-00-00";
	if(fechabaja == "") fechabaja = "0000-00-00";


	try {
		instruccion.sprintf("insert into bitacoraempleados \
			(empleado,nombre,appat,apmat,puesto,puestoant,depart,departant,jefe,jefeant,sucursal,sucursalant,activo, \
			numempleado,nss,fechamodi,solicitagasto,solicitagastoant, \
			autorizagasto,autorizagastoant, rfc,fechaalta,fechabaja,usuariomodi,tarea,horamodi) values \
			('%s',	  '%s',   '%s', '%s', '%s',   '%s',    '%s',   '%s', '%s',  '%s',    '%s',    '%s',      '%s', \
			'%s',      '%s', CURDATE(), '%s',           '%s', \
			'%s',         '%s',            '%s',  '%s',     '%s',     '%s',     '%s',CURTIME())",
			empleado, nombre, appat, apmat, puesto, puestoant, depart, departant,jefe, jefeant,sucursal,sucursalant,activo,
			numempleado, nss ,solicitagasto,solicitagastoant,
			autorizagasto,autorizagastoant,rfc,fechaalta,fechabaja,usuariomodi,tarea);

		if (mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL,
			instruccion.c_str())) {
				instruccion = "select 1 as modificar";
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
			}
	}
	__finally {
		delete buffer_sql;
	}

}

// ---------------------------------------------------------------------------
// ID_REP_HISEMPLEADOS
void ServidorReportes::historialEmpleados(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[100];
	AnsiString clave;

	mServidorVioleta->InicializaBuffer(Respuesta,
		TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);
	clave = mFg.ExtraeStringDeBuffer(&parametros);

	try {
		instruccion.sprintf
			("select * from bitacoraempleados where empleado = '%s'", clave);
		instrucciones[num_instrucciones++] = instruccion;

		aux_buffer_sql = mFg.AgregaStringABuffer
			(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);

		for (int i = 0; i < num_instrucciones; i++) {
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],
				aux_buffer_sql);
		}

		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
				instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	}
	__finally {
		delete buffer_sql;
	}

}
// ---------------------------------------------------------------------------
// ID_EJE_REP_SOL_NOTCRED_CLI
void ServidorReportes::EjecutaRepSolNotCredCli(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, terminal, estatus;
	AnsiString tipo, venta, referencia, cliente, vendedor;
	AnsiString estatus_tipo, aplicado, supervisado, desglosado;
	AnsiString condicion_terminal = " ", condicion_estatus = " ";
	AnsiString condicion_tipo = " ", condicion_venta = " ";
	AnsiString condicion_referencia = " ", condicion_cliente = " ";
	AnsiString condicion_vendedor = " ", condicion_autorizado = " ";
	AnsiString condicion_aplicado = " ", condicion_supervisado = " ";
	AnsiString condicion_cancelado_sol = " ", condicion_autorizado_sol = " ";

	fechaini   = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin   = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	terminal   = mFg.ExtraeStringDeBuffer(&parametros);
	estatus    = mFg.ExtraeStringDeBuffer(&parametros);
	estatus_tipo    = mFg.ExtraeStringDeBuffer(&parametros);
	tipo 	   = mFg.ExtraeStringDeBuffer(&parametros);
	venta 	   = mFg.ExtraeStringDeBuffer(&parametros);
	referencia = mFg.ExtraeStringDeBuffer(&parametros);
	cliente    = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor   = mFg.ExtraeStringDeBuffer(&parametros);
	aplicado   = mFg.ExtraeStringDeBuffer(&parametros);
	supervisado= mFg.ExtraeStringDeBuffer(&parametros);
	desglosado = mFg.ExtraeStringDeBuffer(&parametros);

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND s.terminal='%s' ", terminal);
	}

	if (estatus != " ") {
		if(estatus_tipo=="EST"){
			condicion_estatus.sprintf(" AND ds.cancelado = %s ", estatus);
			condicion_cancelado_sol.sprintf(" AND s.cancelado = %s ", estatus);
		}
		if(estatus_tipo=="AUT"){
			condicion_autorizado.sprintf(" AND ds.autorizado = %s ", estatus);
			condicion_autorizado_sol.sprintf(" AND autorizado = %s ", estatus);
			if(estatus == 0){
				condicion_cancelado_sol.sprintf(" AND s.cancelado = 0 ");
			}
		}
	}

	if (tipo != " ") {
		condicion_tipo.sprintf(" AND s.tipo = %s ", tipo);
	}

	if (venta != " ") {
		condicion_venta.sprintf(" AND v.referencia = '%s' ", venta);
	}

	if (referencia != " ") {
		condicion_referencia.sprintf(" AND s.referencia = '%s' ", referencia);
	}

	if (cliente != " ") {
		condicion_cliente.sprintf(" AND cli.cliente = '%s' ", cliente);
	}

	if (vendedor != " ") {
		condicion_vendedor.sprintf(" AND s.usuario = '%s' ", vendedor);
	}

	if (aplicado != " ") {
		condicion_aplicado.sprintf(" AND s.aplicado = %s ", aplicado);
	}

	if (supervisado != " ") {
		condicion_supervisado.sprintf(" AND arts.usuario = '%s' ", supervisado);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,  TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	if(desglosado=="1"){
		instruccion.sprintf("SELECT \
			s.referencia AS solicitud, \
			ds.articulo, \
			s.venta, \
			prod.nombre, \
			a.present, \
			CONCAT(a.multiplo,'X',a.factor) AS multiplo, \
			CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS supervisado, \
			CONCAT(emp.nombre,' ',emp.appat,' ',emp.apmat) AS vendedor, \
			cli.rsocial, \
			ds.cantidad, \
			(dv.costobase*a.factor) AS costobase, \
			dv.precioimp AS precioactual, \
			(dv.precioimp-ds.precioimp) AS preciosol, \
			ds.precioimp AS diferencia, \
			(ds.precioimp*ds.cantidad) AS desctot, \
			((ds.precioimp*ds.cantidad)/(dv.precioimp*dv.cantidad)*100) AS porcdesc, \
			ds.autorizado, \
			ds.cancelado, \
			s.aplicado, \
			s.fechasol, \
			s.horasol \
		FROM solicitudesnotascredcli s \
		INNER JOIN dsolicitudesnotascredcli ds ON ds.referencia = s.referencia \
		INNER JOIN articulos a ON a.articulo = ds.articulo \
		INNER JOIN productos prod ON prod.producto = a.producto \
		INNER JOIN presentacionescb pres ON pres.producto = a.producto AND pres.present = a.present \
		INNER JOIN empleados emp ON emp.empleado = s.usuario \
		INNER JOIN ventas v ON v.referencia = s.venta \
		INNER JOIN dventas dv ON dv.articulo = ds.articulo AND dv.referencia = v.referencia \
		INNER JOIN clientes cli ON cli.cliente = v.cliente \
		LEFT JOIN articulossupervisados arts ON arts.producto = a.producto AND arts.present = a.present \
		LEFT JOIN empleados e ON e.empleado = arts.usuario \
		LEFT JOIN ( \
			SELECT d.articulo, n.venta, \
			SUM(if(n.tipo='0',d.cantidad,0)) AS cantidad, \
			SUM(if(n.tipo<>'0',d.precio,0)) AS precio, \
			SUM(if(n.tipo<>'0',d.precioimp,0)) AS precioimp \
			FROM notascredcli n, dnotascredcli d \
			WHERE n.cancelado=0 AND n.referencia=d.referencia \
			GROUP BY n.venta, d.articulo \
		) dn ON dn.articulo = a.articulo AND s.venta = dn.venta \
		WHERE s.fechasol BETWEEN '%s' AND '%s' \
		and pres.idempresa=%s \
		%s %s %s \
		%s %s %s \
		%s %s \
		GROUP BY s.referencia, ds.articulo \
		HAVING 1 %s %s \
		ORDER BY s.referencia DESC, prod.nombre, a.present, a.multiplo ",
		fechaini, fechafin, FormServidor->ObtieneClaveEmpresa(),
		condicion_terminal, condicion_tipo, condicion_venta,
		condicion_referencia, condicion_cliente, condicion_vendedor, condicion_aplicado,
		condicion_supervisado,
		condicion_estatus, condicion_autorizado);
	} else {
		instruccion.sprintf("SELECT \
			s.referencia, \
			s.venta, \
			s.notacredito, \
			tp.tipo, \
			tp.clave, \
			IF(ifnull(v.foliofisic,'')='',concat(ifnull(cfd.serie,''),ifnull(cfd.folio,'')),v.foliofisic) AS factura, \
			IF(ifnull(nc.foliofisic,'')='',concat(ifnull(cfdnc.serie,''),ifnull(cfdnc.folio,'')),nc.foliofisic) AS facturanc, \
			CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS usuario, \
			IF(cli.tipoempre = 0, CONCAT(cli.nombre,' ',cli.appat,' ',cli.apmat), cli.rsocial) AS cliente, \
			s.fechasol, \
			s.horasol, \
			s.cancelado, \
			s.terminal, \
			SUM(ds.cantidad * ds.precioimp) AS total, \
			COUNT(ds.articulo) AS numart, \
			s.aplicado, \
			IF((d.autorizados+d.cancelados) = d.total_registros && s.cancelado = 0, 1, 0) AS autorizado, \
			tp.tipo, \
			cfd.metodopago, \
			cfd.digitos, \
			v.corte, \
			cli.cliente \
		FROM solicitudesnotascredcli s \
		INNER JOIN dsolicitudesnotascredcli ds ON ds.referencia = s.referencia \
		INNER JOIN tiposnotascredito tp ON tp.tipo = s.tipo \
		INNER JOIN empleados e ON e.empleado = s.usuario \
		INNER JOIN ventas v ON v.referencia = s.venta \
		INNER JOIN clientes cli ON cli.cliente = v.cliente \
		INNER JOIN ( \
			SELECT s.referencia, COUNT(*) AS total_registros, \
			SUM(s.autorizado) AS autorizados, SUM(s.cancelado) AS cancelados  \
			FROM dsolicitudesnotascredcli s \
			WHERE 1 %s \
			GROUP BY s.referencia \
		) d ON d.referencia = s.referencia \
		LEFT JOIN notascredcli nc ON nc.referencia = s.notacredito \
		LEFT JOIN cfd ON v.referencia=cfd.referencia AND cfd.tipocomprobante='VENT' \
		LEFT JOIN cfd cfdnc ON nc.referencia=cfdnc.referencia AND cfdnc.tipocomprobante='NCRE' \
		WHERE s.fechasol BETWEEN '%s' AND '%s' \
		%s %s %s %s \
		%s %s %s %s \
		%s \
		GROUP BY s.referencia \
		ORDER BY s.fechasol DESC, s.horasol DESC ",
		condicion_referencia,
		fechaini, fechafin,
		condicion_terminal, condicion_cancelado_sol, condicion_tipo, condicion_venta,
		condicion_referencia, condicion_cliente, condicion_vendedor, condicion_aplicado,
		condicion_autorizado_sol);
	}

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_EJE_REP_DET_SOL_NOTCRED_CLI
void ServidorReportes::EjecutaRepDetSolNotCredCli(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString referencia;
	AnsiString condicion_referencia = " ";

	referencia = mFg.ExtraeStringDeBuffer(&parametros);

	if (referencia != " ") {
		condicion_referencia.sprintf(" AND s.referencia = '%s' ", referencia);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,  TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
            s.referencia AS solicitud, \
			ds.articulo, \
			a.producto, \
			prod.nombre, \
			a.present, \
			CONCAT(a.multiplo,'X',a.factor) AS multiplo, \
            CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS supervisado, \
			ds.cantidad, \
			pres.costobase, \
			(dv.precioimp- IFNULL(dn.precioimp,0)) AS preciovtaimp, \
			ds.precioimp AS descimp, \
			(ds.cantidad*ds.precioimp) AS importe, \
			((dv.precioimp- IFNULL(dn.precioimp,0))-ds.precioimp) AS desctot, \
			ds.autorizado, \
			ds.cancelado, \
			s.aplicado \
		FROM solicitudesnotascredcli s \
		INNER JOIN dsolicitudesnotascredcli ds ON ds.referencia = s.referencia \
		INNER JOIN dventas dv ON dv.articulo = ds.articulo \
		INNER JOIN articulos a ON a.articulo = ds.articulo \
		INNER JOIN productos prod ON prod.producto = a.producto \
		INNER JOIN presentacionescb pres ON pres.producto = a.producto AND pres.present = a.present \
		LEFT JOIN articulossupervisados arts ON arts.producto = a.producto AND arts.present = a.present \
        LEFT JOIN empleados e ON e.empleado = arts.usuario \
		LEFT JOIN ( \
			SELECT d.articulo, n.venta, \
			SUM(if(n.tipo='0',d.cantidad,0)) AS cantidad, \
			SUM(if(n.tipo<>'0',d.precio,0)) AS precio, \
			SUM(if(n.tipo<>'0',d.precioimp,0)) AS precioimp \
			FROM notascredcli n, dnotascredcli d \
			WHERE n.cancelado=0 AND n.referencia=d.referencia \
			GROUP BY n.venta, d.articulo \
		) dn ON dn.articulo = a.articulo AND s.venta = dn.venta \
		WHERE 1 AND pres.idempresa=%s %s \
		GROUP BY ds.articulo \
		ORDER BY s.referencia DESC, prod.nombre, a.present, a.multiplo ",
		FormServidor->ObtieneClaveEmpresa(), condicion_referencia);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_UPD_SOL_NOTCRED_CLI
void ServidorReportes::UpdtSolNotCredCli(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[20];
	AnsiString solicitud, notacred, articulo, tipo, autho, usuario, terminal, cancelado;

	try {

		solicitud = mFg.ExtraeStringDeBuffer(&parametros);
		notacred  = mFg.ExtraeStringDeBuffer(&parametros);
		articulo  = mFg.ExtraeStringDeBuffer(&parametros);
		tipo 	  = mFg.ExtraeStringDeBuffer(&parametros);
		autho 	  = mFg.ExtraeStringDeBuffer(&parametros);
		usuario	  = mFg.ExtraeStringDeBuffer(&parametros);
		terminal  = mFg.ExtraeStringDeBuffer(&parametros);
		cancelado = mFg.ExtraeStringDeBuffer(&parametros);

		instrucciones[num_instrucciones++]="SET AUTOCOMMIT=0";
		instrucciones[num_instrucciones++]="START TRANSACTION";

		if(tipo == "ALT"){
			instruccion.sprintf("UPDATE solicitudesnotascredcli SET aplicado = 1, notacredito = '%s' \
			WHERE referencia='%s'", notacred, solicitud);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO bitacorasolicitudesnotascredcli \
			(referencia, notacredito, aplicado, usumodi, fechamod, horamod, tipo, terminal) \
			VALUES \
			('%s', '%s', 1, '%s', CURDATE(), CURTIME(), '%s', '%s')",
			solicitud, notacred, usuario, tipo, terminal);
			instrucciones[num_instrucciones++] = instruccion;
		}

		if(tipo == "CAN"){
			instruccion.sprintf("UPDATE dsolicitudesnotascredcli SET cancelado = %s, autorizado = 0 \
			WHERE referencia='%s' AND articulo = '%s'", cancelado, solicitud, articulo);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("UPDATE solicitudesnotascredcli s \
			INNER JOIN ( \
				SELECT referencia, COUNT(*) AS total_registros, SUM(cancelado) AS cancelados \
				FROM dsolicitudesnotascredcli \
				WHERE referencia = '%s' \
				GROUP BY referencia \
			) d ON d.referencia = s.referencia \
			SET s.cancelado = IF(d.cancelados = d.total_registros, 1, 0)", solicitud);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO bitacorasolicitudesnotascredcli \
			(referencia, cancelado, autorizado, articulo, usumodi, fechamod, horamod, tipo, terminal) \
			VALUES \
			('%s', %s, 0, '%s', '%s', CURDATE(), CURTIME(), '%s', '%s')",
			solicitud, cancelado, articulo, usuario, tipo, terminal);
			instrucciones[num_instrucciones++] = instruccion;
		}

		if(tipo == "AUT"){
			instruccion.sprintf("UPDATE dsolicitudesnotascredcli SET autorizado = %s \
			WHERE referencia='%s' AND articulo = '%s'", autho, solicitud, articulo);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO bitacorasolicitudesnotascredcli \
			(referencia, autorizado, articulo, usumodi, fechamod, horamod, tipo, terminal) \
			VALUES \
			('%s', %s, '%s', '%s', CURDATE(), CURTIME(), '%s', '%s')",
			solicitud, autho, articulo, usuario, tipo, terminal);
			instrucciones[num_instrucciones++] = instruccion;
		}

		instrucciones[num_instrucciones++]="COMMIT";

		aux_buffer_sql = mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i], aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
		mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL, buffer_sql);
	}
	__finally {
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
// ID_UPD_SOL_NOTCRED_CLI_MASIVA
void ServidorReportes::UpdtSolNotCredCliMasiva(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *buffer_sql = new char[1024 * 1024];
	char *aux_buffer_sql = buffer_sql;
	int i;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[10000];
	AnsiString solicitud, articulo, usuario, terminal, cancelado;
    int numarticu, autho = 0;

	try {

		numarticu = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		autho 	  = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
		usuario	  = mFg.ExtraeStringDeBuffer(&parametros);
		terminal  = mFg.ExtraeStringDeBuffer(&parametros);

		instrucciones[num_instrucciones++]="SET AUTOCOMMIT=0";
		instrucciones[num_instrucciones++]="START TRANSACTION";

		for(int i = 0; i < numarticu; i++) {
			solicitud = mFg.ExtraeStringDeBuffer(&parametros);
			articulo  = mFg.ExtraeStringDeBuffer(&parametros);

			instruccion.sprintf("UPDATE dsolicitudesnotascredcli SET autorizado = %d \
			WHERE referencia='%s' AND articulo = '%s' ",
			autho, solicitud, articulo);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("INSERT INTO bitacorasolicitudesnotascredcli \
			(referencia, autorizado, articulo, usumodi, fechamod, horamod, tipo, terminal) \
			VALUES \
			('%s', %d, '%s', '%s', CURDATE(), CURTIME(), 'AUT', '%s')",
			solicitud, autho, articulo, usuario, terminal);
			instrucciones[num_instrucciones++] = instruccion;

		}

		instrucciones[num_instrucciones++]="COMMIT";

		aux_buffer_sql = mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
		for (i = 0; i < num_instrucciones; i++)
			aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i], aux_buffer_sql);

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
		mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL, buffer_sql);
	}
	__finally {
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
// ID_EJE_REP_BITACORA_SOL_NOTCRED_CLI
void ServidorReportes::EjecutaBitacoraSolicitudesNotasCredCli(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, terminal, tipo, usuario;
	AnsiString condicion_terminal = " ", condicion_tipo = " ";
	AnsiString condicion_usuario = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	tipo 	 = mFg.ExtraeStringDeBuffer(&parametros);
	usuario  = mFg.ExtraeStringDeBuffer(&parametros);

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND bsol.terminal='%s' ", terminal);
	}

	if (tipo != " ") {
		condicion_tipo.sprintf(" AND bsol.tipo = '%s' ", tipo);
	}

	if (usuario != " ") {
		condicion_usuario.sprintf(" AND bsol.usumodi = '%s' ", usuario);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,  TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
		bsol.id, \
		bsol.referencia, \
		bsol.notacredito, \
		bsol.articulo, \
		CONCAT(prod.nombre,' ', a.present) AS nom_prod, \
		bsol.autorizado, \
		bsol.aplicado, \
		bsol.cancelado, \
		IF(bsol.tipo = 'SOL', CONCAT(e.nombre,' ',e.appat,' ',e.apmat), NULL) AS usuar_sol, \
		IF(bsol.tipo = 'ALT', CONCAT(e.nombre,' ',e.appat,' ',e.apmat), NULL) AS usuar_gen, \
		IF(bsol.tipo = 'AUT', CONCAT(e.nombre,' ',e.appat,' ',e.apmat), NULL) AS usuar_aut, \
		bsol.terminal, \
		IF(bsol.tipo = 'SOL', CONCAT(bsol.fechamod,' ',bsol.horamod), NULL) AS fecha_sol, \
		IF(bsol.tipo = 'ALT', CONCAT(bsol.fechamod,' ',bsol.horamod), NULL) AS fecha_gen, \
		IF(bsol.tipo = 'AUT', CONCAT(bsol.fechamod,' ',bsol.horamod), NULL) AS fecha_aut, \
		bsol.tipo \
	FROM bitacorasolicitudesnotascredcli bsol \
	INNER JOIN empleados e ON e.empleado = bsol.usumodi  \
	LEFT JOIN articulos a ON a.articulo = bsol.articulo \
	LEFT JOIN productos prod ON prod.producto = a.producto \
	LEFT JOIN solicitudesnotascredcli sol ON sol.referencia = bsol.referencia \
	WHERE bsol.fechamod BETWEEN '%s' AND '%s' \
	%s %s %s \
	ORDER BY bsol.referencia DESC, bsol.fechamod DESC, bsol.horamod DESC ",
	fechaini, fechafin,
	condicion_terminal, condicion_tipo, condicion_usuario);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_EJE_REP_BITACORA_VNT_TPV
void ServidorReportes::EjecutaBitacoraVentasTPV(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *resultado_select = NULL;
	AnsiString instruccion;
	AnsiString fechaini, fechafin, sucursal, terminal, condhora, hora_ini, hora_fin;
	AnsiString condicion_sucursal = " ", condicion_terminal = " ", condicion_hora = " ";

	fechaini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	condhora = mFg.ExtraeStringDeBuffer(&parametros);
	hora_ini = mFg.ExtraeStringDeBuffer(&parametros);
	hora_fin = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND sec.sucursal='%s' ", sucursal);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND btpv.terminal='%s' ", terminal);
	}

	if (condhora != "0") {
		condicion_hora.sprintf(" AND btpv.hora BETWEEN '%s' AND '%s' ", hora_ini, hora_fin);
	}

	mServidorVioleta->InicializaBuffer(Respuesta,  TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
		btpv.referencia, \
		btpv.formapag, \
		fp.descripcion, \
		btpv.valor, \
		CONCAT((btpv.porcentaje*100),'%%') AS porcentaje, \
		btpv.usuario, \
		CONCAT(e.nombre,' ',e.appat,' ',e.apmat) AS nombre, \
		btpv.terminal, \
		btpv.fecha, \
		btpv.hora \
	FROM bitacoraventasxtpv btpv \
	INNER JOIN terminales t ON t.terminal = btpv.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	INNER JOIN empleados e ON e.empleado = btpv.usuario \
	INNER JOIN formasdepago fp ON fp.formapag = btpv.formapag \
	WHERE btpv.fecha BETWEEN '%s' AND '%s' \
	%s %s %s \
	ORDER BY btpv.referencia DESC, btpv.fecha DESC, btpv.hora DESC ",
	fechaini, fechafin,
	condicion_sucursal, condicion_terminal, condicion_hora);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_EJE_REPORTE_EMPLEADOS
void ServidorReportes::EjecutaReporteEmpleados(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *resultado_select = NULL;
	AnsiString instruccion;

	AnsiString fecha_inicio, fecha_fin, puesto, departamento, almacen, empleado;
	AnsiString sucursal, localidad, colonia, roles, jefe, empresa, esSistema;
	AnsiString estatusEmp, estatusUsu;

	AnsiString condicion_puesto = " ", condicion_departamento = " ";
	AnsiString condicion_sucursal = " ", condicion_localidad = " ", condicion_colonia = " ", condicion_almacen = " ";
	AnsiString condicion_jefe = " ", condicion_roles = " ", condicion_empresa = " ";
	AnsiString condicion_esSistema = " ", condicion_empleado=" ", condicion_estatusEmp = " ";
	AnsiString condicion_estatusUsu = " ";

	fecha_inicio = mFg.ExtraeStringDeBuffer(&parametros);
	fecha_fin = mFg.ExtraeStringDeBuffer(&parametros);
	puesto = mFg.ExtraeStringDeBuffer(&parametros);
	departamento = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	localidad = mFg.ExtraeStringDeBuffer(&parametros);
	colonia = mFg.ExtraeStringDeBuffer(&parametros);
	roles = mFg.ExtraeStringDeBuffer(&parametros);
	jefe = mFg.ExtraeStringDeBuffer(&parametros);
	empleado = mFg.ExtraeStringDeBuffer(&parametros);
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	esSistema = mFg.ExtraeStringDeBuffer(&parametros);
	estatusEmp = mFg.ExtraeStringDeBuffer(&parametros);
	estatusUsu = mFg.ExtraeStringDeBuffer(&parametros);

	if (sucursal.Trim() != "") {
		condicion_sucursal.sprintf(" AND suc.nombre='%s' ", sucursal);
	}

	if (departamento.Trim() != "") {
		condicion_departamento.sprintf(" AND dep.nombre='%s' ", departamento);
	}

	if (puesto.Trim() != "") {
		condicion_puesto.sprintf(" AND pst.nombre='%s' ", puesto);
	}

	if (colonia.Trim() != "") {
		condicion_colonia.sprintf(" AND col.nombre='%s' ", colonia);
	}

	if (localidad.Trim() != "") {
		condicion_localidad.sprintf(" AND lcd.nombre='%s' ", localidad);
	}

	if (roles.Trim() != "") {
		condicion_roles.sprintf(" AND rlss.claverol IN (%s) ", roles);
	}

	if (jefe.Trim() != "") {
		condicion_jefe.sprintf(" AND emp.jefe = '%s' ", jefe);
	}

	if (empresa.Trim() != "") {
		condicion_empresa.sprintf(" AND emp.sucursal IN (SELECT sucursal FROM sucursales WHERE idempresa = %s) ", empresa);
	}

	if (empleado.Trim() != "") {
		condicion_empleado.sprintf(" AND emp.empleado = '%s' ", empleado);
	}

	if(esSistema == "1"){
		condicion_esSistema = " AND emp.esSistema = 0 ";
	} else if(esSistema == "2"){
		condicion_esSistema = " AND emp.esSistema = 1 ";
	}

	if (estatusEmp.Trim() != "") {
		condicion_estatusEmp.sprintf(" AND emp.activo = %s ", estatusEmp);
	}

	if (estatusUsu.Trim() != "") {
		condicion_estatusUsu.sprintf(" AND usr.activo = %s ", estatusUsu);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT emp.empleado AS clave_empleado, \
	CONCAT_WS(' ', emp.nombre, emp.appat, emp.apmat) AS nombre_empleado, \
	suc.nombre AS nombre_sucursal, pst.nombre AS nombre_puesto, \
	dep.nombre AS nombre_departamento, col.nombre AS nombre_colonia, \
	lcd.nombre AS nombre_localidad, emp.activo AS activo_empleado, \
	usr.activo AS activo_usuario, emp.fechaalta, emp.fechabaja, \
    tp.descripcion, tpm.descripcion, \
	IF(ISNULL(emp.imagen), 0, 1) AS imagen, \
    emp.esSistema \
	FROM empleados emp \
	LEFT JOIN clientes cli ON cli.claveempleado = emp.empleado \
	LEFT JOIN clientesemp cliemp ON cliemp.cliente = cli.cliente \
	LEFT JOIN tiposdeprecios tp ON tp.tipoprec = cliemp.tipoprecmin \
	LEFT JOIN tiposdeprecios tpm ON tpm.tipoprec = cliemp.tipoprec \
	LEFT JOIN sucursales suc ON emp.sucursal = suc.sucursal \
	LEFT JOIN departamentosrh dep ON emp.depart = dep.depart \
	LEFT JOIN puestos pst ON emp.puesto = pst.puesto \
	LEFT JOIN usuarios usr ON emp.empleado = usr.empleado \
	LEFT JOIN colonias col ON emp.colonia = col.colonia \
	LEFT JOIN localidades lcd ON col.localidad = lcd.localidad \
	LEFT JOIN rolesxpuesto rlsp ON pst.puesto = rlsp.puesto \
	LEFT JOIN rolessistema rlss ON rlsp.rol = rlss.claverol \
	WHERE emp.fechaalta BETWEEN '%s' AND '%s' AND cliemp.idempresa = %s \
	%s %s \
	%s %s %s \
	%s %s %s %s \
	%s %s %s \
	GROUP BY emp.empleado",
	fecha_inicio, fecha_fin, empresa,
	condicion_sucursal, condicion_departamento,
	condicion_puesto, condicion_colonia, condicion_localidad,
	condicion_roles, condicion_jefe, condicion_empresa, condicion_esSistema,
	condicion_empleado, condicion_estatusEmp, condicion_estatusUsu);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}

// ---------------------------------------------------------------------------
// ID_GRA_BITSUCURSAL
void ServidorReportes::GrabaBitacoraSucursal(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[100];

	AnsiString sucursal,numid,numidant,nombre,nombreant,calle,calleant,
			   colonia,coloniaant,cp,cpant,localidad,localidadant,email,
			   emailant,activa,activaant,venxvol,venxvolant,latitud,longitud,
			   ubicaciongisant,salidaotrasucursal,salidaotrasucursalant,
			   vtasecom,vtasecomant,defaultecom,defaultecomant,pickup,
			   pickupant,idempresa,idempresaant,usumod,tarea;

	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	numid = mFg.ExtraeStringDeBuffer(&parametros);
	numidant = mFg.ExtraeStringDeBuffer(&parametros);
	nombre = mFg.ExtraeStringDeBuffer(&parametros);
	nombreant = mFg.ExtraeStringDeBuffer(&parametros);
	calle = mFg.ExtraeStringDeBuffer(&parametros);
	calleant = mFg.ExtraeStringDeBuffer(&parametros);
	colonia = mFg.ExtraeStringDeBuffer(&parametros);
	coloniaant = mFg.ExtraeStringDeBuffer(&parametros);
	cp = mFg.ExtraeStringDeBuffer(&parametros);
	cpant = mFg.ExtraeStringDeBuffer(&parametros);
	localidad = mFg.ExtraeStringDeBuffer(&parametros);
	localidadant = mFg.ExtraeStringDeBuffer(&parametros);
	email = mFg.ExtraeStringDeBuffer(&parametros);
	emailant = mFg.ExtraeStringDeBuffer(&parametros);
	activa = mFg.ExtraeStringDeBuffer(&parametros);
	activaant = mFg.ExtraeStringDeBuffer(&parametros);
	venxvol = mFg.ExtraeStringDeBuffer(&parametros);
	venxvolant = mFg.ExtraeStringDeBuffer(&parametros);
	latitud = mFg.ExtraeStringDeBuffer(&parametros);
	longitud = mFg.ExtraeStringDeBuffer(&parametros);
	ubicaciongisant = mFg.ExtraeStringDeBuffer(&parametros);
	salidaotrasucursal = mFg.ExtraeStringDeBuffer(&parametros);
	salidaotrasucursalant = mFg.ExtraeStringDeBuffer(&parametros);
	vtasecom= mFg.ExtraeStringDeBuffer(&parametros);
	vtasecomant = mFg.ExtraeStringDeBuffer(&parametros);
	defaultecom = mFg.ExtraeStringDeBuffer(&parametros);
	defaultecomant = mFg.ExtraeStringDeBuffer(&parametros);
	pickup = mFg.ExtraeStringDeBuffer(&parametros);
	pickupant = mFg.ExtraeStringDeBuffer(&parametros);
	idempresa = mFg.ExtraeStringDeBuffer(&parametros);
	idempresaant = mFg.ExtraeStringDeBuffer(&parametros);
	usumod = mFg.ExtraeStringDeBuffer(&parametros);
	tarea = mFg.ExtraeStringDeBuffer(&parametros);

  	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	try {
		instruccion.sprintf("insert into bitacorasucursales VALUES(\
			'%s','%s','%s','%s','%s','%s','%s','%s',\
			'%s','%s','%s','%s','%s','%s','%s',%s,\
			%s,%s,%s,POINT(%s,%s),POINT(%s,%s),'%s',\
			'%s','%s',%s,%s,\
			%s,%s,%s,%s,%s,CURDATE(),CURTIME(),'%s','%s')",
			sucursal,numid,numidant,nombre,nombreant,calle,calleant,colonia,
			coloniaant,cp,cpant,localidad,localidadant,email,emailant,activa,
			activaant,venxvol,venxvolant,latitud,longitud,latitud,longitud,
			salidaotrasucursal,salidaotrasucursalant,vtasecom,vtasecomant,
			defaultecom,defaultecomant,pickup,pickupant,idempresa,idempresaant,usumod,tarea);

		if(mServidorVioleta->EjecutaAccionSqlNulo(Respuesta, MySQL, instruccion.c_str())){
            mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, "Select LAST_INSERT_ID() as id");
		}
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_EJE_REPCORTECOSTEXIS
void ServidorReportes::EjecutaRepCorteCostExis(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros){
	AnsiString instruccion;
	int i;
	AnsiString fecha;
	BufferRespuestas *resp_mov = NULL, *resp_prod = NULL;
	TStringList *lista_productos = new TStringList;

	BufferRespuestas *resp_bloques = NULL;
	AnsiString minimo, minimo2, maximo2;
	int x;
	AnsiString condicion_rango_productos;
	int count = 0;

	int indice_producto, indice_present, indice_clasif, indice_cantalma,
		indice_cantidad, indice_costounit, indice_almacen;
	int indice_tipo, indice_fecha, indice_referencia;

	AnsiString forzar_indice = "FORCE INDEX(PRIMARY)";

	AnsiString idEmpresa = " ";

	AnsiString clavesAlmacenes[100] = {};
	double valoresAlmacenes[100] = {};

	char *buffer_resp_mov = NULL;
	try {
		buffer_resp_mov = new char[TAM_MAX_BUFFER_COSTOS];

		fecha = mFg.ExtraeStringDeBuffer(&parametros);
		idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);

		IteradorCostos *iterador;
		bool hay_pendientes, aplicar_costo;
		int estado_iteracion;
		double costotot;
		char *aux, *respuesta;
		int *tam_respuesta, *num_filas;
		AnsiString nombre_producto, producto_anterior, present_anterior;
		double acum_cantidad, acum_cantalma;
		double acum_costo, costoprom;
		AnsiString producto_actual, present_actual, tipo_actual;
		char clasif_actual, clasif_actual_str[2];
		double cantidad_actual, cantalma_actual;
		double costounit_actual, costotot_actual;
		int num_registros;

		AnsiString dato_almacen = " ", dato_sucursal = " ";

		mServidorVioleta->MuestraMensaje("-- Inicializando buffer de  [" +
			mFg.IntToAnsiString(TAM_MAX_BUFFER_RESPUESTA_REP*2) + "] bytes",
			Respuesta->Id);
		mServidorVioleta->InicializaBuffer(Respuesta,
			TAM_MAX_BUFFER_RESPUESTA_REP*2);


		int rr_tam_respuesta;
		char *rr_aux_resultado = Respuesta->BufferResultado;
		int *rr_aux_tam = (int *)rr_aux_resultado;
		rr_aux_resultado += sizeof(int);
		// Nos saltamos la parte del tamaño del resultado.
		rr_aux_resultado = mFg.AgregaPCharABuffer("0", rr_aux_resultado);
		// No hubo error
		rr_tam_respuesta = rr_aux_resultado - Respuesta->BufferResultado;
		*rr_aux_tam = rr_tam_respuesta -sizeof(int);
		Respuesta->TamBufferResultado = rr_tam_respuesta;

		respuesta = Respuesta->BufferResultado +
			Respuesta->TamBufferResultado; // Allì vamos a poner el resultado
		aux = respuesta;
		tam_respuesta = (int *)aux;
		// Obtenemos la direccion donde se va a poner el tamaño del resultado
		aux += sizeof(int);
		num_filas = (int *)aux;
		// Obtenemos la direccion donde se va a poner el número de registros
		(*num_filas) = 0;
		aux += sizeof(int);

		// Obtiene la lista de nombres de productos
		lista_productos->Sorted = true;
		instruccion = "select producto, nombre from productos";
		if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), resp_prod, TAM_MAX_BUFFER_RESPUESTA_MIN)) {
			for (i = 0; i < resp_prod->ObtieneNumRegistros(); i++) {
				resp_prod->IrAlRegistroNumero(i);
				lista_productos->AddObject(resp_prod->ObtieneDato("producto"),
					(TObject *)(resp_prod->ObtienePunteroDato("nombre")));
			}
		}

		// **********************************************************************************************

		instruccion.sprintf("select pmm.producto, pmm.present, pmm.minimo, pmm.maximo \
			from precalculominmaxfin%s pmm \
			order by pmm.minimo", idEmpresa);
		if (!mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,instruccion.c_str(), resp_bloques))
			throw Exception("Error en select precalculominmax de ID_EJE_REPCORTECOSTEXIS");

		for (x = 0; x < resp_bloques->ObtieneNumRegistros() - 1; x++) {
			resp_mov = NULL;
			iterador = NULL;

			resp_bloques->IrAlRegistroNumero(x);
			minimo = resp_bloques->ObtieneDato("minimo");

			resp_bloques->IrAlRegistroNumero(x + 1);
			minimo2 = resp_bloques->ObtieneDato("minimo");
			maximo2 = resp_bloques->ObtieneDato("maximo");

			if (x < resp_bloques->ObtieneNumRegistros() - 2) {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<%s ",
					minimo, minimo2);
			}
			else {
				condicion_rango_productos.sprintf(" pc.id>=%s and pc.id<=%s ",
					minimo, maximo2);
			}

			try {
				// Manda el resultado a un buffer
				instruccion.sprintf("select pc.producto, pc.present, \
					pc.clasif, pc.cantidad, if(pc.tipo<>'BC', pc.cantidad, 0) as cantalma, pc.costounit, pc.almacen \
					from precalculocostos%s pc %s \
					where %s AND fecha<='%s' \
					order by id", idEmpresa,
					forzar_indice, condicion_rango_productos, fecha);

				if (mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
					instruccion.c_str(), resp_mov, buffer_resp_mov)) {
					mServidorVioleta->MuestraMensaje
						("-- Finalizó mandar resultados a buffer [" +mFg.IntToAnsiString(resp_mov->ObtieneTamRespuesta()) +"] bytes", Respuesta->Id);
					// Crea objeto iterador
					iterador = new IteradorCostos(resp_mov);

					mServidorVioleta->MuestraMensaje("-- Finalizó creación de iterador", Respuesta->Id);

					indice_producto = resp_mov->ObtieneIndiceCampo("producto");
					indice_present = resp_mov->ObtieneIndiceCampo("present");
					indice_clasif = resp_mov->ObtieneIndiceCampo("clasif");
					indice_cantalma = resp_mov->ObtieneIndiceCampo("cantalma");
					indice_cantidad = resp_mov->ObtieneIndiceCampo("cantidad");
					indice_costounit =resp_mov->ObtieneIndiceCampo("costounit");
					indice_almacen = resp_mov->ObtieneIndiceCampo("almacen");

					// producto_anterior se usa para que en cada registro saber que
					// producto era el registro anterior
					producto_anterior = "";

					// present_anterior se usa para en cada registro saber que
					// presentación era el registro anterior
					present_anterior = "";

					// acum_cantidad se usa para en cada registro saber
					// la sumatoria de la cantidad del último producto-presentación
					// en global (todos los almacenes)
					acum_cantidad = 0;

					// acum_costo se usa para en cada registro saber
					// la sumatoria del costo acumulado del último producto-presentación
					// en global (todos los almacenes)
					acum_costo = 0;

					// acum_cantalma se usa para en cada registro saber
					// la sumatoria de la cantidad de almacen especifico del último producto-presentación
					acum_cantalma = 0;

					// Costo promedio hasta el último producto-presentacion
					costoprom = 0;

					// Ciclo para calcular los costos.
					i = 0;
					do {
						hay_pendientes = iterador->IrRegistroPendiente();
						estado_iteracion = iterador->ObtieneEstadoIteracion();

						// Si i está dentro del rango válido nos posicionamos en el registro(i)
						// y obtenemos el producto y presentación de dicho registro
						if (hay_pendientes) {
							producto_actual =resp_mov->ObtienePunteroDatoEnIndice(indice_producto);
							present_actual =resp_mov->ObtienePunteroDatoEnIndice(indice_present);
						}

						dato_almacen =resp_mov->ObtienePunteroDatoEnIndice(indice_almacen);

						dato_sucursal = " ";


						// Si ya pasamos el ultimo registro o el producto-presentacion es diferente
						// entonces manda los datos acumulados al cliente.
						if ((!hay_pendientes) ||(producto_actual != producto_anterior ||present_actual != present_anterior)) {
							// Si no es el primer registro
							if (i > 0) {
								// Entonces manda los datos al cliente

								try {
									nombre_producto =(char *)lista_productos->Objects
										[lista_productos->IndexOf(producto_anterior)];
								} catch (EStringListError &e) {
									nombre_producto = producto_anterior;
								}
								aux = mFg.AgregaStringABuffer(nombre_producto, aux); // agrega nombre
								aux = mFg.AgregaStringABuffer(present_anterior, aux);// aprega presentacion
								aux = mFg.AgregaStringABuffer(producto_anterior, aux);// agrega producto

								// Si es global se manda costo global
								aux = mFg.AgregaStringABuffer(FloatToStr(acum_cantidad), aux);
								aux = mFg.AgregaStringABuffer(FloatToStr(acum_costo), aux);

								aux = mFg.AgregaStringABuffer(FloatToStr(costoprom), aux);

								AnsiString clavesAlm= "", valoresAlm="";
								for(int j = 0; j < 100; j++){
									//----Transformar claves y valores en AnsiString de ALMACENES
									if(clavesAlmacenes[j] != ""){
										if(j != 0){
											valoresAlm+=",";
											clavesAlm += ",";
										}
										clavesAlm += clavesAlmacenes[j];
										valoresAlm+= valoresAlmacenes[j];
									}
								}

								aux = mFg.AgregaStringABuffer(clavesAlm, aux);
								aux = mFg.AgregaStringABuffer(valoresAlm, aux);

								(*num_filas)++;
								count++;

							} // cierre del if de que no sea el primer registro
						} //

						if (hay_pendientes) {
							// Solo se ocupa el primer caracter de la clasificación (siempre es solo un caracter)
							clasif_actual =*(resp_mov->ObtienePunteroDatoEnIndice(indice_clasif));

							cantalma_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantalma), NULL);

							if (clasif_actual == 'A') {
								cantidad_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL);
								costounit_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_costounit), NULL);
								costotot_actual =cantidad_actual * costounit_actual;
							}
							if (clasif_actual == 'B') {
								cantidad_actual = 0;
								costounit_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_costounit), NULL);
								costotot_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL) * costounit_actual;
							}
							if (clasif_actual == 'C') {
								cantidad_actual =strtod(resp_mov->ObtienePunteroDatoEnIndice(indice_cantidad), NULL);
								costounit_actual = costoprom;
								costotot_actual =cantidad_actual * costounit_actual;
							}

							// Si es un producto-presentacion DIFERENTE al anterior
							if ((producto_actual != producto_anterior ||present_actual != present_anterior)) {

								// Asigna los datos del registro actual a las variables
								// usadas para registro anterior, esto en preparación
								// para el siguiente ciclo.
								producto_anterior = producto_actual;
								present_anterior = present_actual;

								costoprom = 0;
								acum_cantidad = 0;
								acum_costo = 0;
								acum_cantalma = 0;

								for(int j =0; j< 100; j++){
									//-----Limipiar la lista de claves y valores ALMACENES
									clavesAlmacenes[j] = "";
									valoresAlmacenes[j] = 0;
								}

								iterador->IniciaOtroProductoPresentacion();
							}

							// si alguno de los acumulados podría dar negativo entonces
							// se ignora el registro actual, pero se acumula para posterior
							// aplicación cuando haya el positivo suficiente
							if ((acum_cantidad + cantidad_actual) <0 || (acum_costo + costotot_actual) <0 || (acum_cantalma + cantalma_actual) < 0) {
								// Si se generó un negativo

								// Si se no terminaron los registros y no esta en modo
								// de  forzar pendientes entonces se marca como no aplicado
								// para que se almacene en los pendientes.
								if (iterador->ObtieneEstaTerminadaIteracionNormal()	== false &&iterador->ObtieneForzarPendientes() == false) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								} else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							} else { // Si No se generó un negativo

								// Si es iteracion normal y además
								// mov actual disminuye costo o existencias y
								// además hay pendientes de aplicar ENTONCES se les da prioridad
								// a los pendientes y el mov actual se pone como no
								// aplicado hasta el final de las lista de pendientes.
								if(estado_iteracion == 0 && (cantidad_actual <0 || costotot_actual <0 || cantalma_actual < 0)
									&& iterador->ObtieneNumRealNoAplicados() > 0) {
									// Lo marca como no aplicado lo que a su vez
									// lo agrega a pendientes
									aplicar_costo = false;
									iterador->MarcaComoNoAplicado();
								}else {
									// Aplica
									aplicar_costo = true;
									iterador->MarcaComoSiAplicado();
								}
							}

							// Totaliza tomando en cuenta el registro actual
							if(aplicar_costo) {
								acum_cantidad = acum_cantidad + cantidad_actual;
								acum_costo = acum_costo + costotot_actual;
								acum_cantalma = acum_cantalma + cantalma_actual;
								if (!mFg.EsCero(acum_cantidad))costoprom = acum_costo / acum_cantidad;
								// else costoprom=0;

								for(int j = 0; j < 100; j++){
                                    //Se guarda la cantidad actual en el registro de ALMACÉN
									if(clavesAlmacenes[j] == ""){
										clavesAlmacenes[j] = dato_almacen;
									}
									if(clavesAlmacenes[j] == dato_almacen){
										valoresAlmacenes[j] += cantidad_actual;
										break;
									}
								}
							}
						}
						i++;
					}
					while (hay_pendientes);

				}
				else
					throw Exception
						("Error en select precalculocostos%s de ID_EJE_REPCOSTOEXISTENCIAS"
						);
			}
			__finally {
				if (iterador != NULL) {
					delete iterador;
					iterador = NULL;
				}
				if (resp_mov != NULL) {
					delete resp_mov;
					resp_mov = NULL;
				}
			}
		}
		// **********************************************************************************************

		// Establece el tamaño de la respuesta.
		*tam_respuesta = (aux - respuesta);
		Respuesta->TamBufferResultado = Respuesta->TamBufferResultado +
			*tam_respuesta; // Calcula tamaño total de buffer
		Respuesta->PosBufferResultado = 0;
		// Los resultados al cliente serán a partir del inicio del buffer.
	}
	__finally {
		if (resp_mov != NULL)
			delete resp_mov;
		if (resp_prod != NULL)
			delete resp_prod;
		if (resp_bloques != NULL)
			delete resp_bloques;
		if (buffer_resp_mov != NULL)
			delete buffer_resp_mov;
		delete lista_productos;
	}
}
// ---------------------------------------------------------------------------
//ID_REP_UBIPRODPRES
void ServidorReportes::EjecutaRepUbicacionXProducto(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros){
    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	int num_instrucciones = 0;
	AnsiString instruccion, instrucciones[100];

	AnsiString empresa,sucursal,almacen;

	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	almacen = mFg.ExtraeStringDeBuffer(&parametros);

  	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	try {
		instruccion.sprintf("SELECT \
			apa.producto,pro.nombre,pre.present, \
            CONCAT(af.numfrente,' - ', ap.fondo,' - ', ap.nivel ) as niveles\
			FROM almacencalles ac \
			INNER JOIN almacenfrentes af ON af.idalmcalle=ac.idalmcalle \
			INNER JOIN almacenposiciones ap ON ap.idalmfrente=af.idalmfrente \
			INNER JOIN almacenposarticulos apa ON apa.idalmposicion=ap.idalmposicion\
			INNER JOIN productos pro ON pro.producto = apa.producto\
			INNER JOIN presentaciones pre ON pre.producto=apa.producto AND pre.present=apa.present\
			where ac.almacen = '%s' order by apa.producto, pre.present asc",almacen);

		mServidorVioleta->EjecutaSelectSql
			(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		delete buffer_sql;
	}
}
// ID_CON_BITACORAPROGRAMADOS
// ---------------------------------------------------------------------------
void ServidorReportes::ConsultarBitacoraCambiosProgramados(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros){

	char *buffer_sql=new char[1024*32];
	char *aux_buffer_sql=buffer_sql;

	AnsiString instruccion, instrucciones[100];
	int num_instrucciones = 0;

	AnsiString tipo, articulo, prod_origen, prod_destino, present_origen, present_destino,
		mult_origen, mult_destino, nombre_destino, ean13, fecha_prog, sucursalesIgnorar;

	AnsiString filtros = " ";

	try{
		tipo = mFg.ExtraeStringDeBuffer(&parametros);
		articulo = mFg.ExtraeStringDeBuffer(&parametros);
		prod_origen = mFg.ExtraeStringDeBuffer(&parametros);
		prod_destino = mFg.ExtraeStringDeBuffer(&parametros);
		present_origen = mFg.ExtraeStringDeBuffer(&parametros);
		present_destino = mFg.ExtraeStringDeBuffer(&parametros);
		mult_origen = mFg.ExtraeStringDeBuffer(&parametros);
		mult_destino = mFg.ExtraeStringDeBuffer(&parametros);
		nombre_destino = mFg.ExtraeStringDeBuffer(&parametros);
		ean13 = mFg.ExtraeStringDeBuffer(&parametros);
		fecha_prog = mFg.ExtraeStringDeBuffer(&parametros);
        sucursalesIgnorar = mFg.ExtraeStringDeBuffer(&parametros);

		instruccion.sprintf("DROP TABLE if EXISTS auxmaxbitprodpresent");
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("CREATE TEMPORARY TABLE if not exists auxmaxbitprodpresent \
		(sucursal VARCHAR (2), ultima_fecha DATETIME, correcto INT(1), mensaje VARCHAR(1000))");
		instrucciones[num_instrucciones++] = instruccion;

		if(tipo == "EA"){
			filtros = "tipo = 'EA' AND articulo = @articulo AND mult_destino = @mult_destino ";
			instruccion.sprintf("SET @articulo = '%s', @mult_destino = '%s'", articulo, mult_destino);

		} else if(tipo == "RC"){
			filtros = "tipo = 'RC' AND articulo = @articulo AND mult_destino = @mult_destino AND ean13 = @ean13";
			instruccion.sprintf("SET @articulo = '%s', @mult_destino = '%s', @ean13='%s'", articulo, mult_destino, ean13);

		} else if(tipo == "CPP"){
			filtros = "tipo = 'CPP' AND prod_origen = @prod_origen AND prod_destino = @prod_destino AND \
				present_origen = @present_origen AND present_destino = @present_destino ";
			instruccion.sprintf("SET @prod_origen = '%s', @prod_destino = '%s', @present_origen='%s', @present_destino = '%s' ",
			prod_origen, prod_destino, present_origen, present_destino );

		} else if(tipo == "MPRO"){
			filtros = "tipo = 'MPRO' AND prod_origen = @prod_origen AND prod_destino = @prod_destino";
			instruccion.sprintf("SET @prod_origen = '%s', @prod_destino = '%s'",
			prod_origen, prod_destino);

		} else if(tipo == "MPRE"){
			filtros = "tipo = 'MPRE' AND prod_origen = @prod_origen AND present_origen = @present_origen \
			AND present_destino = @present_destino";
			instruccion.sprintf("SET @prod_origen = '%s', @present_origen = '%s', @present_destino='%s'",
			prod_origen, present_origen, present_destino);

		} else if(tipo == "MMUL"){
			filtros = "tipo = 'MMUL' AND prod_origen = @prod_origen  AND present_origen = @present_origen \
			AND mult_origen = @mult_origen AND mult_destino = @mult_destino";
			instruccion.sprintf("SET @prod_origen = '%s', @present_origen = '%s', @mult_origen='%s', @mult_destino = '%s'",
			prod_origen, present_origen, mult_origen, mult_destino);
		}
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("INSERT INTO auxmaxbitprodpresent \
			SELECT bi.sucursal, MAX(bi.fecha_apli) AS fecha_apli, -1, 'No hay registro en esta sucursal' \
			FROM bitprodpresent bi \
			WHERE %s \
			GROUP BY bi.sucursal", filtros);
		instrucciones[num_instrucciones++] = instruccion;

		instruccion.sprintf("UPDATE auxmaxbitprodpresent aux \
			INNER JOIN bitprodpresent bi ON aux.sucursal = bi.sucursal AND aux.ultima_fecha = bi.fecha_apli \
			SET aux.correcto = bi.correcto, aux.mensaje = bi.mensaje \
			WHERE %s ", filtros);
		instrucciones[num_instrucciones++] = instruccion;


		instruccion.sprintf("SELECT suc.nombre, aux.ultima_fecha, IFNULL(aux.correcto,-1) AS correcto, \
			ifnull(aux.mensaje, 'No hay registro en esta sucursal') as mensaje\
			FROM sucursales suc \
			LEFT JOIN auxmaxbitprodpresent aux ON aux.sucursal = suc.sucursal \
			WHERE suc.sucursal NOT IN (%s) \
			order BY suc.idempresa, suc.nombre", sucursalesIgnorar);

		try {
			aux_buffer_sql=mFg.AgregaStringABuffer(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (int i=0; i<num_instrucciones; i++)
				aux_buffer_sql=mFg.AgregaStringABuffer(instrucciones[i], aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
			if(mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL, buffer_sql)){
				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
			}

		} __finally {

		}

	}__finally{
		if(buffer_sql != NULL) delete buffer_sql;
	}
}
 // ---------------------------------------------------------------------------
//ID_REP_OBJVENDEDORES_VENT
void ServidorReportes::EjecutaRepObjetivosAgentesVent(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion;

	AnsiString year,vendedor,year2;

	year = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	year2 = mFg.ExtraeStringDeBuffer(&parametros);


  	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	try {
		instruccion.sprintf("SELECT\
			MONTH(v.fechavta) AS mes,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS actual,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS anterior,\
			(CASE \
			   WHEN MONTH(v.fechavta) = 1 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '01')\
			   WHEN MONTH(v.fechavta) = 2 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '02')\
			   WHEN MONTH(v.fechavta) = 3 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '03')\
			   WHEN MONTH(v.fechavta) = 4 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '04')\
			   WHEN MONTH(v.fechavta) = 5 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '05')\
			   WHEN MONTH(v.fechavta) = 6 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '06')\
			   WHEN MONTH(v.fechavta) = 7 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '07')\
			   WHEN MONTH(v.fechavta) = 8 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '08')\
			   WHEN MONTH(v.fechavta) = 9 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '09')\
			   WHEN MONTH(v.fechavta) = 10 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '10')\
			   WHEN MONTH(v.fechavta) = 11 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '11')\
			   WHEN MONTH(v.fechavta) = 12 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '12')\
			   ELSE 0\
		   END) AS objetivo\
			FROM ventas v\
			WHERE v.vendedor = '%s'\
			AND v.fechavta BETWEEN '%s-01-01' AND '%s-12-31'\
			and v.cancelado = 0 GROUP BY MONTH(v.fechavta)",year,year2,vendedor,year2,year);

		mServidorVioleta->EjecutaSelectSql
			(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
//ID_REP_OBJVENDEDORES_CLI
void ServidorReportes::EjecutaRepObjetivosAgentesCli(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion;

	AnsiString year,vendedor,year2,mes;
    AnsiString condicion_mes = " ";

	year = mFg.ExtraeStringDeBuffer(&parametros);
	vendedor = mFg.ExtraeStringDeBuffer(&parametros);
	year2 = mFg.ExtraeStringDeBuffer(&parametros);
	mes = mFg.ExtraeStringDeBuffer(&parametros);

	if(mes != " "){
        condicion_mes.sprintf(" AND MONTH(v.fechavta) = %s ",mes);
    }

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	try {
		instruccion.sprintf("SELECT cli.rsocial AS cliente,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS actual,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS anterior,\
			(CASE\
			   WHEN MONTH(v.fechavta) = 1 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '01')\
			   WHEN MONTH(v.fechavta) = 2 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '02')\
			   WHEN MONTH(v.fechavta) = 3 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '03')\
			   WHEN MONTH(v.fechavta) = 4 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '04')\
			   WHEN MONTH(v.fechavta) = 5 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '05')\
			   WHEN MONTH(v.fechavta) = 6 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '06')\
			   WHEN MONTH(v.fechavta) = 7 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '07')\
			   WHEN MONTH(v.fechavta) = 8 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '08')\
			   WHEN MONTH(v.fechavta) = 9 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '09')\
			   WHEN MONTH(v.fechavta) = 10 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '10')\
			   WHEN MONTH(v.fechavta) = 11 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '11')\
			   WHEN MONTH(v.fechavta) = 12 THEN (SELECT objetivovts FROM objetivosvendedores WHERE mes = '12')\
			   ELSE 0 \
			END) AS objetivo \
            FROM ventas v\
			INNER JOIN clientes cli ON cli.cliente=v.cliente\
			WHERE v.vendedor = '%s' %s\
			AND v.fechavta BETWEEN '%s-01-01' AND '%s-12-31'\
			and v.cancelado = 0 GROUP BY v.cliente order by cli.rsocial",year,year2,vendedor,
			condicion_mes,year2,year);

		mServidorVioleta->EjecutaSelectSql
			(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
//ID_REP_OBJSUCURSALES_VENT
void ServidorReportes::EjecutaRepObjetivosSucursalesVent(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;
	AnsiString instruccion;

	AnsiString year,sucursal,year2;

	year = mFg.ExtraeStringDeBuffer(&parametros);
	year2 = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);


  	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	try {
		instruccion.sprintf("SELECT\
			MONTH(v.fechavta) AS mes,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS actual,\
			SUM(CASE WHEN YEAR(v.fechavta) = %s THEN valor ELSE 0 END) AS anterior,\
            (CASE\
			   WHEN MONTH(v.fechavta) = 1 THEN objetivovts_01\
			   WHEN MONTH(v.fechavta) = 2 THEN objetivovts_02\
			   WHEN MONTH(v.fechavta) = 3 THEN objetivovts_03\
			   WHEN MONTH(v.fechavta) = 4 THEN objetivovts_04\
			   WHEN MONTH(v.fechavta) = 5 THEN objetivovts_05\
			   WHEN MONTH(v.fechavta) = 6 THEN objetivovts_06\
			   WHEN MONTH(v.fechavta) = 7 THEN objetivovts_07\
			   WHEN MONTH(v.fechavta) = 8 THEN objetivovts_08\
			   WHEN MONTH(v.fechavta) = 9 THEN objetivovts_09\
			   WHEN MONTH(v.fechavta) = 10 THEN objetivovts_10\
			   WHEN MONTH(v.fechavta) = 11 THEN objetivovts_11\
			   WHEN MONTH(v.fechavta) = 12 THEN objetivovts_12\
			   ELSE 0 \
			END) AS objetivo \
			FROM ventas v \
			INNER JOIN terminales ter ON ter.terminal=v.terminal\
			INNER JOIN secciones sec ON sec.seccion=ter.seccion \
			INNER JOIN sucursales suc ON suc.sucursal=sec.sucursal\
			INNER JOIN objetivossucursales os ON os.sucursal=suc.sucursal AND os.sucursal = '%s'\
			where v.fechavta BETWEEN '%s-01-01' AND '%s-12-31' \
			and v.cancelado = 0\
			AND v.vendedor = 'TIEN'\
			GROUP BY MONTH(v.fechavta)",year,year2,sucursal,year2,year);

		mServidorVioleta->EjecutaSelectSql
			(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
	}
	__finally {
		delete buffer_sql;
	}
}

// ---------------------------------------------------------------------------
// ID_REP_REG_COMP
void ServidorReportes::RepRegistrosCompras(RespuestaServidor *Respuesta,
	MYSQL *MySQL, char *parametros) {

	char *resultado_select = NULL;
	AnsiString Instruccion;
	AnsiString fechaInicio, fechaFin, idEmpresa, idSucursal, tipo;
	AnsiString condicion_empresa = " ", condicion_sucursal = " ";

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	fechaInicio = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);
	idSucursal = mFg.ExtraeStringDeBuffer(&parametros);
	tipo = mFg.ExtraeStringDeBuffer(&parametros);

	if(idEmpresa != " ") {
		condicion_empresa.sprintf(" AND suc.idempresa = %s  ", idEmpresa);
	}

	if(idSucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal = '%s'  ", idSucursal);
	}

	if(tipo == "CO"){
           	Instruccion.sprintf("SELECT ped.referencia, c.fechacom, c.referencia, c.folioprov, p.razonsocial,  \
						FORMAT(c.valor,2) AS valor, 		c.anticipo,                                \
						concat(ec.nombre, ' ', ec.appat, ' ', ec.apmat) AS comprador, a.nombre,        \
						concat(em.nombre, ' ', em.appat, ' ', em.apmat) AS usuario, c.cancelado AS estado \
						FROM compras c                                                                  \
						INNER JOIN almacenes a ON c.almacen=a.almacen                                   \
						INNER JOIN empleados ec ON c.comprador=ec.empleado                              \
						INNER JOIN empleados em ON c.usumodi=em.empleado                                \
						INNER JOIN proveedores p ON c.proveedor=p.proveedor                            \
						LEFT JOIN pedidos ped ON ped.compra = c.referencia                              \
						INNER JOIN secciones sec ON sec.seccion = a.seccion                             \
						INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal                       \
						WHERE c.fechacom BETWEEN '%s' AND '%s' %s %s									   \
						ORDER BY c.fechacom, c.referencia",
						fechaInicio, fechaFin, condicion_empresa, condicion_sucursal);
	}else{
         Instruccion.sprintf("SELECT n.fechanot, n.referencia, c.referencia as compra,  \
							n.folioprov, p.razonsocial, n.valor,                       \
							concat(em.nombre, ' ', em.appat, ' ', em.apmat) as usuario, \
							if (n.cancelado=1, 'CANC','') as estado,                    \
							if(n.tipo=0, 'Devolucion', if(n.tipo=1, 'Bonificacion', 'Descuento')) as tipo \
							FROM notascredprov n                                        \
							INNER JOIN compras c ON n.compra = c.referencia             \
							INNER JOIN empleados em ON em.empleado = n.usumodi          \
							INNER JOIN proveedores p ON p.proveedor = c.proveedor       \
							INNER JOIN almacenes a ON a.almacen = c.almacen             \
							INNER JOIN secciones sec ON sec.seccion = a.seccion         \
							INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal    \
							WHERE n.fechanot BETWEEN '%s' AND '%s' %s %s					\
							ORDER BY n.fechanot, n.referencia",
						fechaInicio, fechaFin, condicion_empresa, condicion_sucursal);

    }

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, Instruccion.c_str(), Respuesta->TamBufferResultado);

}

// ---------------------------------------------------------------------------
// ID_REP_FLUJO_EFECTIVO
void ServidorReportes::EjecutaRepFlujoEfectivo(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;

	AnsiString fecha, empresa, sucursal, considerar_fact_web;
	AnsiString condicion_sucursal = " ",condicion_empresa = " ";
	AnsiString condicion_fact_web_venta = " ",
	condicion_fact_web_nota = " ";

	try {
		fecha=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa=mFg.ExtraeStringDeBuffer(&parametros);
		sucursal=mFg.ExtraeStringDeBuffer(&parametros);
		considerar_fact_web=mFg.ExtraeStringDeBuffer(&parametros);

		if(empresa != " "){
			condicion_empresa.sprintf(" and s.idempresa=%s ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf(" AND s.sucursal='%s' ", sucursal);
		}
		if(considerar_fact_web == "1"){
			condicion_fact_web_venta = " AND w.factgenerada IS NULL ";
			condicion_fact_web_nota = " AND wn.factgenerada IS NULL ";

		}

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

		instruccion.sprintf("  \
			SELECT * FROM(     \
			( \
			SELECT s.sucursal, s.nombre,'Ventas de contado' AS tipo, CONCAT(  \
			UCASE(LEFT(fp.descripcion, 1)), LCASE(SUBSTRING(fp.descripcion, 2))) AS descripcion,  \
			fp.formapag, SUM(df.valor) AS totventas , SUM(IFNULL(nc.valor, 0)) AS totnotas,  \
			SUM(df.valor) - SUM(IFNULL(nc.valor, 0)) AS total, 1 AS orden, 'vtas_contado' as id_concepto  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN terminales ter ON ter.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = ter.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia   \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia  \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta  \
			WHERE v.cancelado = 0  AND fp.termino = 'CONEF' \
			AND v.fechavta ='%s' %s %s %s %s \
			AND v.acredito = 0  \
			AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			GROUP BY s.sucursal, fp.formapag  \
			) UNION ALL (   \
			SELECT s.sucursal, s.nombre, 'Ventas de tarjeta de credito' AS tipo,'Cobro Pinpad' AS descripcion, fp.formapag,  \
			SUM(df.valor) AS totventas, SUM(IFNULL(nc.valor,0)) AS totnotas,  \
			SUM(df.valor)-SUM(IFNULL(nc.valor,0)) AS total, 2 AS orden, 'vtas_cred_pinpad' as id_concepto  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id   \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			INNER JOIN terminales t ON t.terminal = v.terminal   \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia  \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta     \
			WHERE v.cancelado = 0 AND fp.termino = 'TARCR' AND df.trn_id IS NOT NULL AND  \
			v.fechavta ='%s' %s %s %s %s  \
			AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			GROUP BY s.sucursal,fp.termino   \
			) UNION ALL (  \
			SELECT s.sucursal, s.nombre, 'Ventas de tarjeta de credito' AS tipo,'Cobro TPV' AS descripcion, fp.formapag,   \
			SUM(df.valor) AS totact, SUM(IFNULL(nc.valor,0)) AS totnotas,  \
			SUM(df.valor)-SUM(IFNULL(nc.valor,0)) AS total, 3 AS orden, 'vtas_cred_tpv' as id_concepto   \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia  \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia   \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta   \
			WHERE v.cancelado = 0 AND fp.termino = 'TARCR' AND df.trn_id IS NULL AND  \
			v.fechavta ='%s' %s %s %s  %s   \
			AND wn.factgenerada IS NULL AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			GROUP BY s.sucursal, fp.termino  \
			) UNION ALL (   \
			SELECT s.sucursal, s.nombre, 'Cobranza efectivo' AS tipo, p.formapag AS descripcion, p.formapag, 0 AS tot, 0 AS totnotas \
			,SUM(IFNULL(txc.valor,0))*-1 AS total, 4 AS orden, 'cobranza_efe' as id_concepto  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN transxcob txc ON txc.referencia = v.referencia   \
			INNER JOIN pagoscli p ON p.pago = txc.pago  \
			INNER JOIN terminales ter ON ter.terminal = v.terminal   \
			INNER JOIN secciones sec ON sec.seccion = ter.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			WHERE v.cancelado=0 AND p.cancelado=0 AND txc.aplicada=1 AND txc.cancelada=0   \
			AND txc.fechaalta ='%s' %s %s %s   \
			GROUP BY s.sucursal, p.formapag   \
			) UNION ALL (  \
			SELECT s.sucursal, s.nombre, 'Mov. efectivo' AS tipo, IF(m.concepto='D', CONCAT('D','-', cm.descripcion),   \
			CONCAT('R','-', cm.descripcion)) AS descripcion, \
			 m.conceptomovs AS concepto, SUM(m.cantretirado) AS totalmov,  \
			  0 AS totalnotas, SUM(m.cantretirado) as total, 5 AS orden, 'mov_efectivo' as id_concepto   \
			FROM movsefectivocaja m  \
			INNER JOIN terminales t ON t.terminal = m.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs  \
			WHERE m.fecharetiro ='%s' %s %s  \
			AND (cm.clave = 'REFECL' OR cm.clave = 'DPGSER')   \
			GROUP BY s.sucursal, m.conceptomovs  \
			) UNION ALL (  \
			SELECT s.sucursal, s.nombre, 'Cobros de servicio' AS tipo, prod.nombre AS descripcion, 'RECEL' AS formapag,   \
			SUM(dv.cantidad*dv.precioimp) AS totalventas, SUM(IFNULL(nc.valor,0)) AS totalnotas,  \
			SUM(dv.cantidad*dv.precioimp)-SUM(IFNULL(nc.valor,0)) AS total, 6 AS orden, 'cobro_servicio' as id_concepto  \
			FROM ventas v FORCE INDEX(fechavta)   \
			INNER JOIN dventas dv ON dv.referencia = v.referencia  \
			INNER JOIN terminales t ON t.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN articulos a ON a.articulo = dv.articulo   \
			INNER JOIN productos prod ON prod.producto = a.producto \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia     \
			LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia   \
			WHERE prod.nombre LIKE '%%RECARGAS%%' AND a.activo = 1 AND v.cancelado = 0   \
			 AND v.fechavta='%s' %s %s %s   \
			 AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			 GROUP BY s.sucursal  \
			 ) UNION ALL (  \
			SELECT s.sucursal, s.nombre, 'Notas de credito' AS tipo, fp.termino AS descripcion, fp.termino AS formapag,  \
			0 AS totalventas, 0 AS totalnotas,  \
			SUM((dn.cantidad*dn.precioimp)*df.porcentaje) AS total, 7 AS orden, 'ntas_credito' as id_concepto  \
			FROM notascredcli n  \
			INNER JOIN dnotascredcli dn ON dn.referencia = n.referencia  \
			INNER JOIN ventas v ON v.referencia = n.venta  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN terminales t ON t.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN clientes cli ON cli.cliente = v.cliente  \
			INNER JOIN formasdepago fp ON df.formapag = fp.formapag   \
			LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket=n.venta   \
			WHERE v.fechavta='%s' %s %s %s %s AND v.cancelado = 0  \
			AND (fp.termino='CONEF' OR fp.termino='TARCR') \
			AND n.cancelado = 0   \
			GROUP BY s.sucursal, fp.termino  \
			)) flujo_ventas   \
			ORDER BY sucursal, orden ",
			fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota,
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota,
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota,
			 fecha,condicion_empresa, condicion_sucursal, condicion_fact_web_venta,
			 fecha,condicion_empresa, condicion_sucursal,
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta,
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota);

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL,
			instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {}
}


// ---------------------------------------------------------------------------
// ID_DET_FLUJO_EFECTIVO
void ServidorReportes::EjecutaDetFlujoEfectivo(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;

	AnsiString codigo_operacion,fecha, empresa, sucursal, considerar_fact_web, detalle_operacion ;
	AnsiString condicion_sucursal = " ",condicion_empresa = " ";
	AnsiString condicion_fact_web_venta = " ",
	condicion_fact_web_nota = " ";

	try {
		codigo_operacion=mFg.ExtraeStringDeBuffer(&parametros);
		fecha=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		empresa=mFg.ExtraeStringDeBuffer(&parametros);
		sucursal=mFg.ExtraeStringDeBuffer(&parametros);
		considerar_fact_web=mFg.ExtraeStringDeBuffer(&parametros);
		detalle_operacion=mFg.ExtraeStringDeBuffer(&parametros);

		if(empresa != " "){
			condicion_empresa.sprintf(" and s.idempresa=%s ", empresa);
		}
		if (sucursal != " ") {
			condicion_sucursal.sprintf(" AND s.sucursal='%s' ", sucursal);
		}
		if(considerar_fact_web == "1"){
			condicion_fact_web_venta = " AND w.factgenerada IS NULL ";
			condicion_fact_web_nota = " AND wn.factgenerada IS NULL ";

		}

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

		if(codigo_operacion == "vtas_contado"){
			AnsiString condicion_forma_pago = " ";

			if(detalle_operacion.Trim() != "")
				condicion_forma_pago.sprintf(" AND fp.formapag='%s' ", detalle_operacion);

			instruccion.sprintf("  \
			SELECT s.sucursal, v.referencia,'Ventas de contado' AS tipo, CONCAT(  \
			UCASE(LEFT(fp.descripcion, 1)), LCASE(SUBSTRING(fp.descripcion, 2))) AS descripcion,  \
			fp.formapag, IFNULL(df.valor, 0) AS valor_venta , IFNULL(nc.valor, 0) AS valor_nota,  \
			IFNULL(df.valor, 0) - IFNULL(nc.valor, 0) AS total \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN terminales ter ON ter.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = ter.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia   \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia  \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta  \
			WHERE v.cancelado = 0  AND fp.termino = 'CONEF' \
			AND v.fechavta ='%s' %s %s %s %s %s \
			AND v.acredito = 0  \
			AND (nc.referencia IS NULL OR nc.cancelado = 0) \
			ORDER BY fp.formapag ",
			 fecha, condicion_empresa, condicion_sucursal,
			 condicion_fact_web_venta, condicion_fact_web_nota,
			 condicion_forma_pago);

		} else if(codigo_operacion == "vtas_cred_pinpad"){
			instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, v.referencia, 'Ventas de tarjeta de credito' AS tipo, \
			'Cobro Pinpad' AS descripcion, fp.formapag, IFNULL(df.valor, 0) AS valor_venta, \
			IFNULL(nc.valor,0) AS valor_nota, IFNULL(df.valor, 0) - IFNULL(nc.valor,0) AS total  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN dettrnxventa dt ON dt.trn_id = df.trn_id   \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			INNER JOIN terminales t ON t.terminal = v.terminal   \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia  \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta     \
			WHERE v.cancelado = 0 AND fp.termino = 'TARCR' AND df.trn_id IS NOT NULL AND  \
			v.fechavta ='%s' %s %s %s %s  \
			AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			ORDER BY fp.formapag ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota);

		} else if(codigo_operacion == "vtas_cred_tpv"){
			instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, v.referencia, 'Ventas de tarjeta de credito' AS tipo,'Cobro TPV' AS descripcion, \
			 fp.formapag, IFNULL(df.valor,0) AS valor_venta, IFNULL(nc.valor,0) AS valor_nota,  \
			IFNULL(df.valor,0)-IFNULL(nc.valor,0) AS total  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia  \
			INNER JOIN formasdepago fp ON fp.formapag = df.formapag  \
			INNER JOIN terminales t ON t.terminal = v.terminal \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia   \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket = nc.venta   \
			WHERE v.cancelado = 0 AND fp.termino = 'TARCR' AND df.trn_id IS NULL AND  \
			v.fechavta ='%s' %s %s %s  %s   \
			AND wn.factgenerada IS NULL AND (nc.referencia IS NULL OR nc.cancelado = 0)  \
			ORDER BY fp.formapag ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota);

		}else if(codigo_operacion == "cobranza_efe"){
			AnsiString condicion_forma_pago = " ";

			if(detalle_operacion.Trim() != "")
				condicion_forma_pago.sprintf(" AND p.formapag='%s' ", detalle_operacion);

			instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, v.referencia, 'Cobranza efectivo' AS tipo, '' AS descripcion, \
			p.formapag, 0 AS valor_venta, 0 AS valor_nota \
			,IFNULL(txc.valor,0)*-1 AS total  \
			FROM ventas v FORCE INDEX(fechavta)  \
			INNER JOIN transxcob txc ON txc.referencia = v.referencia   \
			INNER JOIN pagoscli p ON p.pago = txc.pago  \
			INNER JOIN terminales ter ON ter.terminal = v.terminal   \
			INNER JOIN secciones sec ON sec.seccion = ter.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN cfdiweb w ON w.factgenerada = v.referencia   \
			WHERE v.cancelado=0 AND p.cancelado=0 AND txc.aplicada=1 AND txc.cancelada=0   \
			AND txc.fechaalta ='%s' %s %s %s %s   \
			ORDER BY p.formapag ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_forma_pago);

		}else if(codigo_operacion == "mov_efectivo"){
			AnsiString condicion_forma_pago = " ";

			if(detalle_operacion.Trim() != "")
				condicion_forma_pago.sprintf(" AND m.conceptomovs='%s' ", detalle_operacion);

			instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, '' as referencia, 'Mov. efectivo' AS tipo, m.conceptomovs as formapag,\
			IF(m.concepto='D', CONCAT('D','-', cm.descripcion),CONCAT('R','-', cm.descripcion)) AS descripcion, \
			 m.conceptomovs AS formapag, 0 AS valor_venta,  \
			  0 AS valor_nota, IFNULL(m.cantretirado,0) as total \
			FROM movsefectivocaja m  \
			INNER JOIN terminales t ON t.terminal = m.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			LEFT JOIN catalogomovscaja cm ON cm.clave = m.conceptomovs  \
			WHERE m.fecharetiro ='%s' %s %s %s  \
			AND (cm.clave = 'REFECL' OR cm.clave = 'DPGSER') ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_forma_pago);

		}else if(codigo_operacion == "cobro_servicio"){

            instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, v.referencia, 'Cobros de servicio' AS tipo, prod.nombre AS descripcion, \
			 'RECEL' AS formapag,   \
			IFNULL(dv.cantidad*dv.precioimp,0) AS valor_venta, IFNULL(nc.valor,0) AS valor_nota,  \
			IFNULL(dv.cantidad*dv.precioimp,0)-IFNULL(nc.valor,0) AS total   \
			FROM ventas v FORCE INDEX(fechavta)   \
			INNER JOIN dventas dv ON dv.referencia = v.referencia  \
			INNER JOIN terminales t ON t.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion   \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN articulos a ON a.articulo = dv.articulo   \
			INNER JOIN productos prod ON prod.producto = a.producto \
			LEFT JOIN notascredcli nc ON nc.venta = v.referencia     \
			LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia   \
			WHERE prod.nombre LIKE '%%RECARGAS%%' AND a.activo = 1 AND v.cancelado = 0   \
			 AND v.fechavta='%s' %s %s %s   \
			 AND (nc.referencia IS NULL OR nc.cancelado = 0)  ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta);

		}else if(codigo_operacion == "ntas_credito"){

            instruccion.sprintf("  \
			SELECT s.sucursal, s.nombre, v.referencia, n.referencia AS ref_nota, 'Notas de credito' AS tipo,\
			 fp.termino AS descripcion, \
			fp.termino AS formapag, 0 AS valor_venta, IFNULL((dn.cantidad*dn.precioimp)*df.porcentaje, 0) AS valor_nota,  \
			IFNULL((dn.cantidad*dn.precioimp)*df.porcentaje, 0) AS total  \
			FROM notascredcli n  \
			INNER JOIN dnotascredcli dn ON dn.referencia = n.referencia  \
			INNER JOIN ventas v ON v.referencia = n.venta  \
			INNER JOIN dventasfpago df ON df.referencia = v.referencia   \
			INNER JOIN terminales t ON t.terminal = v.terminal  \
			INNER JOIN secciones sec ON sec.seccion = t.seccion  \
			INNER JOIN sucursales s ON s.sucursal = sec.sucursal \
			INNER JOIN clientes cli ON cli.cliente = v.cliente  \
			INNER JOIN formasdepago fp ON df.formapag = fp.formapag   \
			LEFT JOIN cfdiweb w ON w.factgenerada=v.referencia   \
			LEFT JOIN cfdiweb wn ON wn.refticket=n.venta   \
			WHERE v.fechavta='%s' %s %s %s %s AND v.cancelado = 0  \
			AND (fp.termino='CONEF' OR fp.termino='TARCR') \
			AND n.cancelado = 0   \
			ORDER BY fp.termino ",
			 fecha, condicion_empresa, condicion_sucursal, condicion_fact_web_venta, condicion_fact_web_nota);

		}

		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);

	}
	__finally {}
}
// ---------------------------------------------------------------------------

// ---------------------------------------------------------------------------
// ID_REP_SOL_TICK_SOP
void ServidorReportes::EjecutaRepSolicitudTicketsSoporte(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	AnsiString instruccion;

	AnsiString fechaini, fechafin, empresa, sucursal, terminal, departamento, usuariosol, estatus, referencia, jefatura;
	AnsiString condicion_empresa=" ";
	AnsiString condicion_sucursal=" ";
	AnsiString condicion_terminal=" ";
	AnsiString condicion_departamento=" ";
	AnsiString condicion_usuariosol=" ";
	AnsiString condicion_estatus=" ";
	AnsiString condicion_referencia=" ";
	AnsiString condicion_jefatura=" ";

	fechaini=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa=mFg.ExtraeStringDeBuffer(&parametros);
	sucursal=mFg.ExtraeStringDeBuffer(&parametros);
	terminal=mFg.ExtraeStringDeBuffer(&parametros);
	departamento=mFg.ExtraeStringDeBuffer(&parametros);
	usuariosol=mFg.ExtraeStringDeBuffer(&parametros);
	estatus=mFg.ExtraeStringDeBuffer(&parametros);
	referencia=mFg.ExtraeStringDeBuffer(&parametros);
	jefatura=mFg.ExtraeStringDeBuffer(&parametros);

	if(empresa != " "){
		condicion_empresa.sprintf(" AND suc.idempresa=%s ", empresa);
	}

	if(sucursal != " "){
		condicion_sucursal.sprintf(" AND suc.sucursal='%s' ", sucursal);
	}

	if(terminal != " "){
		condicion_terminal.sprintf(" AND s.terminal='%s' ", terminal);
	}

	if(departamento != " "){
		condicion_departamento.sprintf(" AND s.departamento IN(%s) ", departamento);
	}

	if(usuariosol != " "){
		condicion_usuariosol.sprintf(" AND s.ususolicita='%s' ", usuariosol);
	}

	if(estatus != " "){
		if(estatus == "SOL") {
			condicion_estatus.sprintf(" AND s.solucionado=1");
		} else if(estatus == "VAL") {
			condicion_estatus.sprintf(" AND s.validado=1");
		} else if(estatus == "PSO") {
			condicion_estatus.sprintf(" AND s.solucionado=0");
		} else if(estatus == "PVA") {
			condicion_estatus.sprintf(" AND s.validado=0");
		} else if(estatus == "CAN") {
			condicion_estatus.sprintf(" AND s.cancelado=1");
		}
	}

	if(referencia != " "){
		condicion_referencia.sprintf(" AND s.referencia='%s'",referencia);
	}

	if(jefatura != " "){
		condicion_jefatura.sprintf(" AND s.idJefatura='%s'",jefatura);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	instruccion.sprintf("SELECT \
		s.referencia, \
		IFNULL(s.areasolicita, cot.nombre) AS areasolicita, \
		IF(ds.departamento = 'RHH', CONCAT(catrh.clave,' - ',srh.nombreEmpleado),LEFT(sm.descripproblema, 80)) AS descripcion, \
		p.nombre AS puestosolicita, \
		catrh.nombre AS tipoBaja, \
		CONCAT(e1.nombre,' ',e1.appat,' ',e1.apmat) AS ususolicita, \
		CONCAT(e2.nombre,' ',e2.appat,' ',e2.apmat) AS usuvalida, \
		CONCAT(e3.nombre,' ',e3.appat,' ',e3.apmat) AS responsable, \
		s.terminal, \
		s.fechasol, \
		s.fechapromesa, \
		s.fechaini, \
		s.fechasolucion, \
		s.fechavalidado, \
		s.solucionado, \
		s.validado, \
		ds.nombre, \
		ds.departamento, \
        s.cancelado \
	FROM solicitudtickets s \
	INNER JOIN terminales t ON t.terminal = s.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
	INNER JOIN departamentossoporte ds ON ds.departamento = s.departamento \
	LEFT JOIN catalogojefaturasordenestrabajo cot ON cot.clave = s.idJefatura \
	LEFT JOIN empleados e1 ON e1.empleado = s.ususolicita \
	LEFT JOIN empleados e2 ON e2.empleado = s.usuvalida \
	LEFT JOIN empleados e3 ON e3.empleado = s.responsable \
	LEFT JOIN solicitudticketsmensajes sm ON sm.referencia = s.referencia \
	LEFT JOIN solicitudticketsrh srh ON srh.referencia = s.referencia \
	LEFT JOIN puestos p ON p.puesto = srh.puestosoli \
	LEFT JOIN catalogobajasrh catrh ON catrh.clave = srh.tipoBaja \
	WHERE s.fechasol BETWEEN '%s' AND '%s' \
	%s %s %s %s %s %s %s %s \
	ORDER BY suc.sucursal ASC, s.referencia DESC",
	fechaini,fechafin,
	condicion_empresa,
	condicion_sucursal,
	condicion_terminal,
	condicion_departamento,
	condicion_usuariosol,
	condicion_estatus,
	condicion_referencia,
	condicion_jefatura);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_BIT_SOL_TICK_SOP
void ServidorReportes::EjecutaBitSolicitudTicketsSoporte(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
    AnsiString instruccion;

	AnsiString fechaini, fechafin, empresa, sucursal, terminal, departamento, usuariosol, estatus, ordenar, referencia, jefatura;
	AnsiString condicion_empresa=" ";
	AnsiString condicion_sucursal=" ";
	AnsiString condicion_terminal=" ";
	AnsiString condicion_departamento=" ";
	AnsiString condicion_usuariosol=" ";
	AnsiString condicion_estatus=" ";
	AnsiString ordenamiento="ORDER BY s.referencia ASC";
	AnsiString condicion_referencia=" ";
	AnsiString condicion_jefatura=" ";

	fechaini=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechafin=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa=mFg.ExtraeStringDeBuffer(&parametros);
	sucursal=mFg.ExtraeStringDeBuffer(&parametros);
	terminal=mFg.ExtraeStringDeBuffer(&parametros);
	departamento=mFg.ExtraeStringDeBuffer(&parametros);
	usuariosol=mFg.ExtraeStringDeBuffer(&parametros);
	estatus=mFg.ExtraeStringDeBuffer(&parametros);
	ordenar=mFg.ExtraeStringDeBuffer(&parametros);
	referencia=mFg.ExtraeStringDeBuffer(&parametros);
	jefatura=mFg.ExtraeStringDeBuffer(&parametros);

	if(empresa != " "){
		condicion_empresa.sprintf(" AND suc.idempresa=%s ", empresa);
	}

	if(sucursal != " "){
		condicion_sucursal.sprintf(" AND suc.sucursal='%s' ", sucursal);
	}

	if(terminal != " "){
		condicion_terminal.sprintf(" AND s.terminal='%s' ", terminal);
	}

	if(departamento != " "){
		condicion_departamento.sprintf(" AND s.departamento='%s' ", departamento);
	}

	if(usuariosol != " "){
		condicion_usuariosol.sprintf(" AND s.ususolicita='%s' ", usuariosol);
	}

	if(estatus != " "){
		if(estatus == "SOL") {
			condicion_estatus.sprintf(" AND s.solucionado=1");
		} else if(estatus == "VAL") {
			condicion_estatus.sprintf(" AND s.validado=1");
		} else if(estatus == "PSO") {
			condicion_estatus.sprintf(" AND s.solucionado=0");
		} else if(estatus == "PVA") {
			condicion_estatus.sprintf(" AND s.validado=0");
		}
	}

	if(ordenar != " "){
		if(ordenar == "REF") {
			ordenamiento = "ORDER BY s.referencia ASC";
		} else if(ordenar == "FMD") {
			ordenamiento = "ORDER BY s.fechamodi DESC, s.horamodi DESC";
		}
	}

	if(referencia != " "){
		condicion_referencia.sprintf(" AND s.referencia='%s'",referencia);
	}

	if(jefatura != " "){
		condicion_jefatura.sprintf(" AND s.idJefatura='%s'",jefatura);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

	instruccion.sprintf("SELECT \
		s.referencia, \
		IFNULL(s.areasolicita, cot.nombre) AS areasolicita, \
        LEFT(sm.descripproblema, 80) AS descripcion, \
		CONCAT(e1.nombre,' ',e1.appat,' ',e1.apmat) AS ususolicita, \
		CONCAT(e2.nombre,' ',e2.appat,' ',e2.apmat) AS usuvalida, \
		CONCAT(e3.nombre,' ',e3.appat,' ',e3.apmat) AS responsable, \
		CONCAT(e4.nombre,' ',e4.appat,' ',e4.apmat) AS usumodi, \
		s.terminal, \
		s.fechasol, \
		s.fechapromesa, \
		s.fechaini, \
		s.fechasolucion, \
		s.fechavalidado, \
		s.solucionado, \
		s.validado, \
		s.departamento, \
		ds.nombre, \
		IF(s.tipo = 'A', 'ALTA', 'MODIFICACIÓN') AS tipo \
	FROM solicitudticketsbitacora s \
	INNER JOIN terminales t ON t.terminal = s.terminal \
	INNER JOIN secciones sec ON sec.seccion = t.seccion \
	INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
	INNER JOIN departamentossoporte ds ON ds.departamento = s.departamento \
	LEFT JOIN catalogojefaturasordenestrabajo cot ON cot.clave = s.idJefatura \
	LEFT JOIN empleados e1 ON e1.empleado = s.ususolicita \
	LEFT JOIN empleados e2 ON e2.empleado = s.usuvalida \
	LEFT JOIN empleados e3 ON e3.empleado = s.responsable \
	LEFT JOIN empleados e4 ON e4.empleado = s.usumodi \
    LEFT JOIN solicitudticketsmensajes sm ON sm.referencia = s.referencia \
	WHERE s.fechasol BETWEEN '%s' AND '%s' \
	%s %s %s %s %s %s %s %s \
	%s",
	fechaini,fechafin,
	condicion_empresa, condicion_sucursal, condicion_terminal, condicion_departamento, condicion_usuariosol, condicion_estatus,
	condicion_referencia, condicion_jefatura,
	ordenamiento);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
//ID_EJE_REP_SURTIDO_AUD
void ServidorReportes::EjecutaRepSurtidoAud(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
    char *buffer_sql = new char[1024 * 64];
	char *aux_buffer_sql = buffer_sql;

	int num_instrucciones = 0;
	AnsiString instruccion,consulta,instrucciones[1000];
	AnsiString archivo_temp1, archivo_temp2, archivo_temp3;
	AnsiString fechaini, fechafin, surtido, embarque, surtidor, agrupado;
	AnsiString condicion_surtido=" ", condicion_embarque=" ",
	condicion_surtidor=" ";

	try{

		fechaini=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		fechafin=mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
		surtido = mFg.ExtraeStringDeBuffer(&parametros);
		embarque = mFg.ExtraeStringDeBuffer(&parametros);
		surtidor = mFg.ExtraeStringDeBuffer(&parametros);
		agrupado = mFg.ExtraeStringDeBuffer(&parametros);


		if(surtido != " ")
			condicion_surtido.sprintf(" AND s.surtido='%s' ", surtido);

		if(embarque != " ")
			condicion_embarque.sprintf(" AND s.embarque='%s' ", embarque);

		if(surtidor != " ")
			condicion_surtidor.sprintf(" AND e.surtidor='%s' ", surtidor);


		if(agrupado == "1"){

			instruccion.sprintf("create temporary table aux_pedido_cantidades( \
				 surtido VARCHAR(11) NOT NULL, \
				 cantidad DECIMAL(12,3) DEFAULT NULL, \
				CONSTRAINT pk_ped_can PRIMARY KEY USING BTREE (surtido) \
				) \
				Engine = INNODB");
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp1 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			instruccion.sprintf("SELECT s.surtido, IFNULL(SUM(dpv.cantidad * pa.factor / pmmped.maxfactor),0) AS cajas_pedidas \
				FROM surtidopedidos s \
				LEFT JOIN embarques e ON e.embarque = s.embarque \
				LEFT JOIN pedidosventa pv ON pv.embarque = e.embarque \
				LEFT JOIN dpedidosventa dpv ON dpv.referencia = pv.referencia \
				LEFT JOIN articulos pa ON pa.articulo = dpv.articulo \
				LEFT JOIN presentacionesminmax pmmped ON pmmped.producto = pa.producto AND pmmped.present = pa.present \
				WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s \
				GROUP BY s.surtido \
				INTO OUTFILE '%s'",
				fechaini, fechafin, condicion_embarque, condicion_surtido, condicion_surtidor,
				archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("LOAD DATA INFILE '%s'\
				INTO TABLE aux_pedido_cantidades \
				(surtido, cantidad)", archivo_temp1);
			instrucciones[num_instrucciones++] = instruccion;

			// ---------------------------

			instruccion.sprintf("create temporary table aux_surtido_cantidades( \
				 surtido VARCHAR(11) NOT NULL, \
				 cantidad DECIMAL(12,3) DEFAULT NULL, \
				CONSTRAINT pk_sur_can PRIMARY KEY USING BTREE (surtido) \
				) \
				Engine = INNODB");
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp2 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			instruccion.sprintf("SELECT s.surtido, IFNULL(SUM(ds.cantidad * sa.factor / pmms.maxfactor),0) AS cajas_surtidas \
				FROM surtidopedidos s \
				LEFT JOIN embarques e ON e.embarque = s.embarque \
				LEFT JOIN dsurtidopedidos ds ON ds.surtido = s.surtido \
				LEFT JOIN articulos sa ON sa.articulo = ds.articulo \
				LEFT JOIN presentacionesminmax pmms ON pmms.producto = sa.producto AND pmms.present = sa.present  \
				WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s \
				GROUP BY s.surtido \
				INTO OUTFILE '%s'",
				fechaini, fechafin, condicion_embarque, condicion_surtido, condicion_surtidor,
				archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("LOAD DATA INFILE '%s'\
				INTO TABLE aux_surtido_cantidades \
				(surtido, cantidad)", archivo_temp2);
			instrucciones[num_instrucciones++] = instruccion;

			// ---------------------------

			instruccion.sprintf("create temporary table aux_ventas_cantidades( \
				 surtido VARCHAR(11) NOT NULL, \
				 cantidad DECIMAL(12,3) DEFAULT NULL, \
				CONSTRAINT pk_ven_can PRIMARY KEY USING BTREE (surtido) \
				) \
				Engine = INNODB");
			instrucciones[num_instrucciones++] = instruccion;

			archivo_temp3 = mServidorVioleta->ObtieneArchivoTemp(num_instrucciones,
				Respuesta->Id);

			instruccion.sprintf("SELECT s.surtido, IFNULL(SUM(dv.cantidad * a.factor / pmmv.maxfactor),0) AS cajas_factura \
				FROM surtidopedidos s \
				LEFT JOIN embarques e ON e.embarque = s.embarque     \
				LEFT JOIN pedidosventa pv ON pv.embarque = e.embarque \
				LEFT JOIN ventas v ON v.referencia = pv.venta          \
				LEFT JOIN dventas dv ON dv.referencia = v.referencia    \
				LEFT JOIN articulos a ON a.articulo = dv.articulo        \
				LEFT JOIN presentacionesminmax pmmv ON pmmv.producto = a.producto AND pmmv.present = a.present  \
                WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s \
				GROUP BY s.surtido \
				INTO OUTFILE '%s'",
				fechaini, fechafin, condicion_embarque, condicion_surtido, condicion_surtidor, archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			instruccion.sprintf("LOAD DATA INFILE '%s'\
				INTO TABLE aux_ventas_cantidades \
				(surtido, cantidad)", archivo_temp3);
			instrucciones[num_instrucciones++] = instruccion;

			// ---------------------------
			// Crea el buffer con todas las instrucciones SQL
			aux_buffer_sql = mFg.AgregaStringABuffer
				(mFg.IntToAnsiString(num_instrucciones), aux_buffer_sql);
			for (int i = 0; i < num_instrucciones; i++)
				aux_buffer_sql = mFg.AgregaStringABuffer(instrucciones[i],aux_buffer_sql);

			mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);

			if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
				buffer_sql)) {

				instruccion.sprintf("SELECT e.embarque, e.surtidor, CONCAT(em.nombre,' ',em.appat,' ',em.apmat) AS nombre_surtidor, \
					e.etapa, e.fechainicarga, e.horainicarga, \
					e.fechafincarga, e.horafincarga, s.fechasurt, s.horaini, s.horafin, \
					s.surtido, pc.cantidad AS cantidad_pedido, sc.cantidad AS cantidad_surtido, vc.cantidad AS cantidad_factura, \
					0 as reemplazado \
					FROM surtidopedidos s \
					INNER JOIN embarques e ON e.embarque = s.embarque \
					LEFT JOIN aux_pedido_cantidades pc ON pc.surtido = s.surtido \
					LEFT JOIN aux_surtido_cantidades sc ON sc.surtido = s.surtido \
					LEFT JOIN aux_ventas_cantidades vc ON vc.surtido = s.surtido \
					LEFT JOIN empleados em ON em.empleado = e.surtidor \
					WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s ",
					fechaini, fechafin,
					condicion_embarque, condicion_surtido, condicion_surtidor);

				mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);

				mServidorVioleta->BorraArchivoTemp(archivo_temp1);
				mServidorVioleta->BorraArchivoTemp(archivo_temp2);
				mServidorVioleta->BorraArchivoTemp(archivo_temp3);
			}

		}else{
			mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);


			instruccion.sprintf("SELECT e.surtidor, CONCAT(em.nombre,' ',em.appat,' ',em.apmat) AS nombre_surtidor, \
				e.etapa, e.fechainicarga, e.horainicarga, e.fechafincarga, e.horafincarga, s.fechasurt, \
				s.horaini, s.horafin, s.surtido,e.embarque, \
				dp.articulo, pped.producto, pped.nombre, aped.present, \
				aped.multiplo, SUM(dp.cantidad) AS cantidad_pedido, dsp.cantidad AS cantidad_surtido,  \
				SUM(IFNULL(dv.cantidad, 0)) AS cantidad_factura,  \
				SUM(dp.cantidad) - dsp.cantidad AS faltantes,  \
				IF(dsp.reemplazado>0,1,0) AS reemplazado  \
				FROM surtidopedidos s  \
				INNER JOIN embarques e ON e.embarque = s.embarque  \
				INNER JOIN pedidosventa pv ON pv.embarque = e.embarque  \
				INNER JOIN dpedidosventa dp ON dp.referencia = pv.referencia \
				INNER JOIN articulos aped ON aped.articulo = dp.articulo \
				INNER JOIN productos pped ON pped.producto = aped.producto \
				LEFT JOIN ventas v ON v.referencia = pv.venta \
				LEFT JOIN dventas dv ON dv.referencia = v.referencia AND dv.articulo = aped.articulo \
				LEFT JOIN ( \
					SELECT dsp.surtido, dsp.articulo, SUM(dsp.cantidad) AS cantidad, \
					SUM(dsp.reemplazado) AS reemplazado, dsp.division \
					FROM surtidopedidos s \
					INNER JOIN dsurtidopedidos dsp ON dsp.surtido = s.surtido \
					INNER JOIN embarques e ON e.embarque = s.embarque \
					WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s \
					GROUP BY s.surtido, dsp.articulo \
				) dsp ON dsp.articulo = dp.articulo AND dsp.surtido = s.surtido \
				LEFT JOIN empleados em ON em.empleado = e.surtidor \
				WHERE s.fechasurt BETWEEN '%s' AND '%s' %s %s %s \
				GROUP BY s.surtido, dp.articulo ",
				    fechaini, fechafin, condicion_embarque, condicion_surtido, condicion_surtidor,
					fechaini, fechafin, condicion_embarque, condicion_surtido, condicion_surtidor);

			mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
		}

	} __finally{
		delete buffer_sql;
	}

}
// ---------------------------------------------------------------------------
//ID_EJE_REPCLASIFPRODS
void ServidorReportes::EjecutaReporteClasifProdSuc(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	char *buffer_sql = new char[1024 * 64 * 10];
	char *aux_buffer_sql = buffer_sql;
	AnsiString clasif1, clasif2, clasif3;
	AnsiString marca, fabricante, segmento;
	AnsiString producto, listaTags, proveedor, supervisor, idEmpresa;
	AnsiString condicion_empresa = " ";
	AnsiString condicion_clasif1 = " ", condicion_clasif2 = " " , condicion_clasif3 = " ", condicion_marca = " ";
	AnsiString join_tags = " ", condicion_tags = " ", condicion_fabricante = " ", condicion_segmento = " ", join_segmento = " ";
	AnsiString condicion_prov = " ", join_proveedor = " ", condicion_supervisor = " ", join_supervisor = " ";
	AnsiString instruccion, condicion_producto = " ";

	try{
		clasif1 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif2 = mFg.ExtraeStringDeBuffer(&parametros);
		clasif3 = mFg.ExtraeStringDeBuffer(&parametros);
		marca = mFg.ExtraeStringDeBuffer(&parametros);
		producto = mFg.ExtraeStringDeBuffer(&parametros);
		fabricante = mFg.ExtraeStringDeBuffer(&parametros);
		segmento = mFg.ExtraeStringDeBuffer(&parametros);
		listaTags = mFg.ExtraeStringDeBuffer(&parametros);
		proveedor = mFg.ExtraeStringDeBuffer(&parametros);
		supervisor = mFg.ExtraeStringDeBuffer(&parametros);
		idEmpresa = mFg.ExtraeStringDeBuffer(&parametros);

        if(idEmpresa != " "){
			condicion_empresa.sprintf("AND suc.idempresa = %s ", idEmpresa);
		}

		if (clasif1 != " ") {
			condicion_clasif1.sprintf(" AND prod.clasif1='%s' ", clasif1);
		}

		if (clasif2 != " ") {
			condicion_clasif2.sprintf(" AND prod.clasif2='%s' ", clasif2);
		}

		if (clasif3 != " ") {
			condicion_clasif3.sprintf(" AND prod.clasif3='%s' ", clasif3);
		}

		if (marca != " ") {
			condicion_marca.sprintf(" AND prod.marca='%s' ", marca);
		}

		if (listaTags != " ") {
			join_tags.sprintf(" INNER JOIN articulostagsasignados artt ON artt.producto=art.producto AND artt.present=art.present ");
			condicion_tags.sprintf
				(" AND artt.idarticulotag in (%s) ", listaTags);
		}

		if (fabricante != " ") {
			condicion_fabricante.sprintf(" AND prod.fabricante='%s' ", fabricante);
		}

		if (segmento != " ") {
			condicion_segmento.sprintf("AND presentcb.segmento='%s' ", segmento);
			join_segmento =
				" INNER JOIN presentacionescb presentcb ON presentcb.producto=art.producto AND presentcb.present=art.present ";
		}

		if (proveedor!= " ") {
			condicion_prov.sprintf(" AND pps.proveedor = '%s' ", proveedor);
			join_proveedor = " INNER JOIN pedidoautomatico_presentaciones_sucursal pps ON pps.producto=art.producto AND pps.present=art.present ";
		}

		if (supervisor != " ") {
			condicion_supervisor.sprintf(" AND asp.usuario = '%s' ", supervisor);
			join_supervisor= " INNER JOIN articulossupervisados asp ON asp.producto=art.producto AND asp.present=art.present ";
		}

		if (producto != " ") {
			condicion_producto.sprintf(" AND prod.producto='%s' ", producto);
		}else{
            condicion_producto = " ";
		}

		mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP);
		if (mServidorVioleta->EjecutaBufferAccionesSql(Respuesta, MySQL,
			buffer_sql)) {
		instruccion.sprintf("SELECT IFNULL(cs.sucursal, suc.sucursal) AS sucursal, \
				prod.nombre AS nomproducto, art.producto, \
				art.present, pmm.maxmult, pmm.minmult, \
				MAX(art.factor) AS maxfactor, MIN(art.factor) AS minfactor, IFNULL (cs.clasificacion_compuesta, 'N/A') AS clasif \
			FROM articulos art \
			INNER JOIN sucursales suc \
			LEFT JOIN clasificacion_articulos_sucursal cs ON art.producto = cs.producto AND art.present = cs.present AND suc.sucursal=cs.sucursal \
			LEFT JOIN productos prod ON art.producto =  prod.producto \
			LEFT JOIN presentacionesminmax pmm ON art.producto = pmm.producto AND art.present = pmm.present \
			%s \
			%s \
			%s \
			%s \
			WHERE art.activo = 1 %s %s %s %s %s %s %s %s %s %s %s \
			GROUP BY suc.sucursal, prod.producto, art.present \
			ORDER BY prod.nombre, prod.producto, art.present, sucursal ", join_segmento, join_tags, join_supervisor, join_proveedor,
				condicion_producto, condicion_empresa,
				condicion_clasif1, condicion_clasif2, condicion_clasif3, condicion_marca, condicion_tags,
				condicion_fabricante, condicion_segmento, condicion_prov, condicion_supervisor );
        }
		mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);

	}__finally{
		delete buffer_sql;
	}
}
// ---------------------------------------------------------------------------
// ID_REP_RECEPCIONES_DETALLE_X_ESTATUS
void ServidorReportes::ConsultaRepRecepcionesxEstatus(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	AnsiString instruccion;
	AnsiString fecha_ini, fecha_fin, empresa, sucursal, proveedor;
	AnsiString recepcionista, comprador, pedido, recepcion, compra;
	AnsiString condicion_sucursal = " ", condicion_proveedor = " ";
	AnsiString condicion_recepcionista = " ", condicion_comprador = " ";
	AnsiString condicion_pedido = " ", condicion_recepcion = " ";
	AnsiString condicion_compra = " ", condicion_estatus = " ";
    int estatus;

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	recepcionista = mFg.ExtraeStringDeBuffer(&parametros);
	comprador = mFg.ExtraeStringDeBuffer(&parametros);
	pedido = mFg.ExtraeStringDeBuffer(&parametros);
	recepcion = mFg.ExtraeStringDeBuffer(&parametros);
	compra = mFg.ExtraeStringDeBuffer(&parametros);
	estatus = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));

	if (empresa == " ") {
		empresa = FormServidor->ObtieneClaveEmpresa();
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND suc.sucursal = '%s' ", sucursal);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf(" AND r.proveedor = '%s' ", proveedor);
	}

	if (recepcionista != " ") {
		condicion_recepcionista.sprintf(" AND r.usualta = '%s' ", recepcionista);
	}

	if (comprador != " ") {
		condicion_comprador.sprintf(" AND c.comprador = '%s' ", comprador);
	}

	if (pedido != " ") {
		condicion_pedido.sprintf(" AND p.referencia = '%s' ", pedido);
	}

	if (recepcion != " ") {
		condicion_recepcion.sprintf(" AND r.recepcion = '%s' ", recepcion);
	}

	if (compra != " ") {
		condicion_compra.sprintf(" AND c.referencia = '%s' ", compra);
	}

	if (estatus != 0) {
		condicion_estatus.sprintf(" AND p.estatus = %d ", estatus);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
		p.proveedor, \
		prov.razonsocial, \
		r.fecharep, \
		r.horaini, \
		CONCAT(empa.nombre,' ',empa.appat,' ',empa.apmat) AS usualta, \
		r.fechamodi, \
		r.horafin, \
		CONCAT(empf.nombre,' ',empf.appat,' ',empf.apmat) AS usumod, \
		suc.sucursal AS sucursal, \
		c.referencia, \
		c.folioprov, \
		p.referencia, \
		IF(p.estatus = 1, 'Pendientes', IF(p.estatus = 2, 'En proceso', IF(p.estatus = 3, 'Finalizado', 'Incompleto'))) \
	FROM pedidos p \
	INNER JOIN pedrecepcion pr ON pr.pedido = p.referencia \
	INNER JOIN recepciones r ON r.recepcion = pr.recepcion \
	INNER JOIN terminales ter ON ter.terminal = r.terminal \
	INNER JOIN secciones sec ON sec.seccion = ter.seccion \
	INNER JOIN sucursales suc ON suc.sucursal = sec.sucursal \
	INNER JOIN proveedores prov ON prov.proveedor = r.proveedor \
	INNER JOIN empleados empa ON empa.empleado = r.usualta \
	INNER JOIN empleados empf ON empf.empleado = r.usumod \
	LEFT JOIN comprecepcion cr ON cr.recepcion = r.recepcion \
	LEFT JOIN compras c ON c.referencia = cr.compra \
	WHERE r.fecharep BETWEEN '%s' AND '%s' \
	AND suc.idempresa = %s \
	%s %s %s \
	%s %s %s \
	%s %s \
	GROUP BY p.referencia, r.recepcion, c.referencia \
	ORDER BY r.fecharep DESC, r.horaini DESC",
	fecha_ini, fecha_fin, empresa,
	condicion_sucursal, condicion_proveedor, condicion_recepcionista,
	condicion_comprador, condicion_pedido, condicion_recepcion,
	condicion_compra, condicion_estatus);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_EJE_REPTRNXPINPAD
void ServidorReportes::EjecutaTrnPinpad(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaIni, fechaFin, tipoTarjeta, tipoTrn, firma, tipoLect, sucursal, terminal, venta, refFin, refCom, tnx,
		horaIni, horaFin;

	AnsiString condicion_tipoTarjeta = " ", condicion_tipoTrn = " ", condicion_firma = " ", condicion_tipoLect = " ",
	condicion_sucursal = " ", condicion_terminal = " ", condicion_venta = " ", condicion_refFin= " ",
	condicion_refCom = " ", condicion_tnx = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
    horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	tipoTarjeta = mFg.ExtraeStringDeBuffer(&parametros);
	tipoTrn = mFg.ExtraeStringDeBuffer(&parametros);
	firma = mFg.ExtraeStringDeBuffer(&parametros);
	tipoLect = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	venta = mFg.ExtraeStringDeBuffer(&parametros);
	refFin = mFg.ExtraeStringDeBuffer(&parametros);
	refCom = mFg.ExtraeStringDeBuffer(&parametros);
	tnx = mFg.ExtraeStringDeBuffer(&parametros);

	if (tipoTarjeta != " ") {
		condicion_tipoTarjeta.sprintf(" AND op.productoTarjeta = '%s' ", tipoTarjeta);
	}

	if (tipoTrn != " ") {
		condicion_tipoTrn.sprintf(" AND op.nombreTransaccion = '%s' ", tipoTrn);
	}

	if (firma != " ") {
		condicion_firma.sprintf(" AND op.firma = '%s' ", firma);
	}

	if (tipoLect != " ") {
		condicion_tipoLect.sprintf(" AND op.modoLectura = '%s' ", tipoLect);
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND op.sucursal = '%s' ", sucursal);
	}

	if (terminal != " ") {
		condicion_terminal.sprintf(" AND op.terminalsist = '%s' ", terminal);
	}

	if (venta != " ") {
		condicion_venta.sprintf(" AND v.referencia = '%s' ", venta);
	}

	if (refFin != " ") {
		condicion_refFin.sprintf(" AND op.referenciaFin = %s ", refFin);
	}

	if (refCom != " ") {
		condicion_refCom.sprintf(" AND op.referencia = '%s' ", refCom);
	}

	if (tnx != " ") {
		condicion_tnx.sprintf(" AND op.secuenciaTransaccion = '%s' ", tnx);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT v.referencia AS ref_venta, suc.nombre, op.terminalsist AS terminal, op.terminal AS term_pinpad, \
	op.nombreTransaccion, op.importe, op.cash, op.puntos AS cant_pagada_con_puntos, op.referenciaFin AS referencia_fin, \
	op.referencia AS referencia_com, \
	IF(op.productoTarjeta = 'c', 'Tarjeta de Crédito', IF(op.productoTarjeta = 'd', 'Tarjeta de Débito', op.productoTarjeta)) AS tipo_tarjeta, \
	IF(op.modoLectura = '05', 'Tarjeta insertada (chip)', IF(op.modoLectura = '07', 'Contactless', \
	IF(op.modoLectura = '90','Tarjeta deslizada (banda)', IF(op.modoLectura = '01', 'Tarjeta digitada', op.modoLectura)))) AS modo_lectura, \
	op.firma, \
	CONCAT( SUBSTRING(op.fechaHora,1,4),'-',SUBSTRING(op.fechaHora,5,2),'-',SUBSTRING(op.fechaHora,7,2) ) AS fecha_trn, \
	CONCAT( SUBSTRING(op.fechaHora,9,2),':',SUBSTRING(op.fechaHora,11,2),':',SUBSTRING(op.fechaHora,13,2) ) AS hora_trn, \
	op.fecha AS fecha_sist, op.hora AS hora_sist, \
	CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat) AS operador \
	FROM operaceptbbva op \
	LEFT JOIN dventasfpago dvp ON dvp.referencia_fin = op.referenciaFin \
	LEFT JOIN ventas v ON v.referencia = dvp.referencia \
	INNER JOIN sucursales suc ON op.sucursal = suc.sucursal \
	INNER JOIN empleados emp ON op.operador = emp.empleadoidcorto \
	WHERE op.fecha BETWEEN '%s' AND '%s' AND op.hora BETWEEN '%s' AND '%s' \
	%s %s %s %s %s %s %s %s %s %s", fechaIni, fechaFin, horaIni, horaFin,
		condicion_tipoTarjeta, condicion_tipoTrn, condicion_firma,
		condicion_tipoLect, condicion_sucursal, condicion_terminal,
		condicion_venta, condicion_refFin, condicion_refCom, condicion_tnx);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);


	instruccion.sprintf("SELECT UPPER(op.codigoOperacion) AS tipo_transac, \
	SUM(IF(op.nombreTransaccion = 'VENTA', op.importe, (op.importe*-1))) AS total, \
	SUM(op.cash) AS cash, SUM(op.puntos) AS puntos \
	FROM operaceptbbva op \
	LEFT JOIN dventasfpago dvp ON dvp.referencia_fin = op.referenciaFin \
	LEFT JOIN ventas v ON v.referencia = dvp.referencia \
	WHERE op.fecha BETWEEN '%s' AND '%s' AND op.hora BETWEEN '%s' AND '%s' \
    %s %s %s %s %s %s %s %s %s %s \
	GROUP BY op.codigoOperacion", fechaIni, fechaFin, horaIni, horaFin,
		condicion_tipoTarjeta, condicion_tipoTrn, condicion_firma,
		condicion_tipoLect, condicion_sucursal, condicion_terminal,
		condicion_venta, condicion_refFin, condicion_refCom, condicion_tnx);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
// ID_BITA_RECEPCIONES_CAPTURA_PROD
void ServidorReportes::ConsultaBitaRecepCapturaProductos(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	AnsiString instruccion;
	AnsiString fecha_ini, fecha_fin, empresa, sucursal, proveedor;
	AnsiString recepcionista, pedido;
	AnsiString condicion_sucursal = " ", condicion_proveedor = " ";
	AnsiString condicion_recepcionista = " ", condicion_pedido = " ";

	fecha_ini = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fecha_fin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	proveedor = mFg.ExtraeStringDeBuffer(&parametros);
	recepcionista = mFg.ExtraeStringDeBuffer(&parametros);
	pedido = mFg.ExtraeStringDeBuffer(&parametros);

	if (empresa == " ") {
		empresa = FormServidor->ObtieneClaveEmpresa();
	}

	if (sucursal != " ") {
		condicion_sucursal.sprintf(" AND b.sucursal = '%s' ", sucursal);
	}

	if (proveedor != " ") {
		condicion_proveedor.sprintf(" AND r.proveedor = '%s' ", proveedor);
	}

	if (recepcionista != " ") {
		condicion_recepcionista.sprintf(" AND b.usualta = '%s' ", recepcionista);
	}

	if (pedido != " ") {
		condicion_pedido.sprintf(" AND pr.pedido = '%s' ", pedido);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA_REP_GRANDE);

	instruccion.sprintf("SELECT \
		b.fechcap, \
        b.horacap, \
		b.recepcion, \
		GROUP_CONCAT(DISTINCT(pr.pedido)) AS pedido, \
		CONCAT(emp.nombre,' ',emp.appat,' ',emp.apmat) AS usuario, \
		b.sucursal, \
		prod.nombre AS nomProd, \
		a.present AS present, \
		a.articulo AS articulo, \
		IF(b.tipo = 0, 'ESCANER', 'MANUAL') AS tipoCaptura \
	FROM bitacorarecepmovproductos b \
	INNER JOIN articulos a ON a.producto = b.producto AND a.present = b.present AND a.multiplo = b.multiplo \
	INNER JOIN productos prod ON prod.producto = a.producto \
	INNER JOIN sucursales suc ON suc.sucursal = b.sucursal \
	INNER JOIN empleados emp ON emp.empleado = b.usuario \
	INNER JOIN recepciones r ON r.recepcion = b.recepcion \
	INNER JOIN pedrecepcion pr ON pr.recepcion = r.recepcion \
	WHERE b.fechcap BETWEEN '%s' AND '%s' \
	AND suc.idempresa = %s \
	%s %s %s \
    %s \
	GROUP BY a.articulo, b.recepcion \
	ORDER BY b.fechcap DESC, b.horacap DESC",
	fecha_ini, fecha_fin, empresa,
	condicion_sucursal, condicion_proveedor, condicion_recepcionista,
	condicion_pedido);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
//ID_EJE_REPBITACORATRNXPINPAD
void ServidorReportes::EjecutaBitacoraTrnPinpad(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
	AnsiString instruccion;
	AnsiString fechaIni = " ", fechaFin = " ", horaIni = " ", horaFin = " ", sucursal = " ", terminal = " ", cod_resp = " ";
	AnsiString condicion_sucursal = " ", condicion_terminal = " ", condicion_cod_resp = " ";
	AnsiString mensaje_excep = "%Error%com.eglobal.totalpos.sdk.exception.%";

    fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	cod_resp = mFg.ExtraeStringDeBuffer(&parametros);

	if(sucursal != " ") {
		condicion_sucursal.sprintf(" AND dvo.sucursal = '%s' ", sucursal);
	}

	if(terminal != " ") {
		condicion_terminal.sprintf(" AND dvo.terminalsist = '%s' ", terminal);
	}

	if(cod_resp != " ") {
		condicion_cod_resp.sprintf(" AND dvo.codigoRespuesta = '%s' ", cod_resp);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT v.referencia, suc.nombre, dvo.terminalsist as terminal, dvo.terminal AS term_pinpad, \
	dvo.codigoOperacion, \
	IF(dvo.mensaje LIKE '%s', CONCAT ('Excepcion en TotalPos SDK. ', TRIM(SUBSTRING_INDEX(dvo.mensaje, ':', -1)) ), IF( dvo.mensaje = '', 'Genera petición', dvo.mensaje)) AS mensaje_ley, \
	dvo.codigoRespuesta, dvo.importe, dvo.cash, dvo.puntos AS cant_pagada_con_puntos, \
	dvo.referenciaFin AS ref_fin, dvo.referencia AS ref_com, \
	IF(dvo.productoTarjeta = 'c', 'Tarjeta de Crédito', IF(dvo.productoTarjeta = 'd', 'Tarjeta de Débito', dvo.productoTarjeta)) AS tipo_tarjeta, \
	IF(dvo.modoLectura = '05', 'Tarjeta insertada (chip)', IF(dvo.modoLectura = '07', 'Contactless', IF(dvo.modoLectura = '90','Tarjeta deslizada (banda)', IF(dvo.modoLectura = '01', 'Tarjeta digitada', dvo.modoLectura)))) AS modo_lectura \
	, dvo.firma, \
	CONCAT( SUBSTRING(dvo.fechaHora,1,4),'-',SUBSTRING(dvo.fechaHora,5,2),'-',SUBSTRING(dvo.fechaHora,7,2) ) AS fecha_trn, \
	CONCAT( SUBSTRING(dvo.fechaHora,9,2),':',SUBSTRING(dvo.fechaHora,11,2),':',SUBSTRING(dvo.fechaHora,13,2) ) AS hora_trn, \
	dvo.fecha, dvo.hora, CONCAT(emp.nombre, ' ', emp.appat, ' ', emp.apmat) AS operador \
	FROM detoperbbva  dvo \
	LEFT JOIN dventasfpago dvp ON dvo.referenciaFin = dvp.referencia_fin \
	LEFT JOIN ventas v ON dvp.referencia = v.referencia \
	INNER JOIN sucursales suc ON dvo.sucursal = suc.sucursal \
	LEFT JOIN empleados emp ON dvo.operador = emp.empleadoidcorto \
	WHERE dvo.fecha BETWEEN '%s' AND '%s' AND dvo.hora BETWEEN '%s' AND '%s' \
	%s %s %s ", mensaje_excep, fechaIni, fechaFin, horaIni, horaFin,
	condicion_sucursal, condicion_terminal, condicion_cod_resp);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
//ID_EJE_CONCENTRNXPINPAD
void ServidorReportes::EjecutaConcentrTrnPinpad(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros) {
    AnsiString instruccion;
	AnsiString fechaIni = " ", fechaFin = " ", horaIni = " ", horaFin = " ", sucursal = " ", terminal = " ", cod_resp = " ";
	AnsiString condicion_sucursal = " ", condicion_terminal = " ", condicion_cod_resp = " ";
	AnsiString mensaje_excep = "%Error%com.eglobal.totalpos.sdk.exception.%";

    fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	horaIni = mFg.ExtraeStringDeBuffer(&parametros);
	horaFin = mFg.ExtraeStringDeBuffer(&parametros);
	sucursal = mFg.ExtraeStringDeBuffer(&parametros);
	terminal = mFg.ExtraeStringDeBuffer(&parametros);
	cod_resp = mFg.ExtraeStringDeBuffer(&parametros);

	if(sucursal != " ") {
		condicion_sucursal.sprintf(" AND dvo.sucursal = '%s' ", sucursal);
	}

	if(terminal != " ") {
		condicion_terminal.sprintf(" AND dvo.terminalsist = '%s' ", terminal);
	}

	if(cod_resp != " ") {
		condicion_cod_resp.sprintf(" AND dvo.codigoRespuesta = '%s' ", cod_resp);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);
	instruccion.sprintf("SELECT IF(dvo.codigoRespuesta IS NULL, 'TPE', dvo.codigoRespuesta) AS codigo, \
	IF(dvo.mensaje LIKE '%s',CONCAT ('Excepcion en TotalPos SDK. ', TRIM(SUBSTRING_INDEX(dvo.mensaje, ':', -1)) ), dvo.mensaje) AS mensaje_ley, \
	COUNT(dvo.mensaje) AS numresp, \
	CAST(100/( \
	SELECT COUNT(*) \
	FROM detoperbbva dvo \
	WHERE dvo.mensaje <> '' \
	AND dvo.fecha BETWEEN '%s' AND '%s' AND dvo.hora BETWEEN '%s' AND '%s' \
	%s %s %s ) \
	* COUNT(dvo.mensaje) AS DECIMAL(16,2)) AS porcentaje \
	FROM detoperbbva dvo \
	WHERE mensaje <> '' AND fecha BETWEEN '%s' AND '%s' AND dvo.hora BETWEEN '%s' AND '%s' \
	%s %s %s \
	GROUP BY mensaje_ley \
	ORDER BY numresp DESC, mensaje ASC ", mensaje_excep, fechaIni, fechaFin, horaIni, horaFin,
	condicion_sucursal, condicion_terminal, condicion_cod_resp,
	fechaIni, fechaFin, horaIni, horaFin,
	condicion_sucursal, condicion_terminal, condicion_cod_resp);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);

}
// ---------------------------------------------------------------------------
//ID_REP_BITA_SURTIDO_CAPTURA_PRODUCTOS
void ServidorReportes::EjecutaBitacoraSurtidoCapturaProductos(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	AnsiString instruccion;
	AnsiString fechaIni, fechaFin, embarque,  producto, almacen;
	int todasdivision = 0, division = 0;
	AnsiString condicion_producto = " ";
	AnsiString condicion_embarque = " ", condicion_division = " ";
	AnsiString condicion_almacen = " ";

	fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	embarque = mFg.ExtraeStringDeBuffer(&parametros);
	division = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	todasdivision = StrToInt(mFg.ExtraeStringDeBuffer(&parametros));
	producto = mFg.ExtraeStringDeBuffer(&parametros);
	almacen = mFg.ExtraeStringDeBuffer(&parametros);

	if(embarque != " ") {
		condicion_embarque.sprintf(" AND sp.embarque = '%s' ", embarque);
	}

	if(todasdivision == 0){
		if(division != 0)
			condicion_division.sprintf(" AND b.division = %d ", division);
	}

	if(producto != " ") {
		condicion_producto.sprintf(" AND a.producto = '%s' ", producto);
	}

	if(almacen != " ") {
		condicion_almacen.sprintf(" AND b.almacen = '%s' ", almacen);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);

	instruccion.sprintf("SELECT \
		b.fechcap, \
		b.horacap, \
		sp.embarque, \
		dsp.pedido, \
		b.almacen, \
		b.division, \
		prod.nombre AS nomproducto, \
		a.present, \
		CONCAT(a.multiplo,'X',a.factor) AS multiplo, \
		b.cantidad, \
		CASE WHEN b.tipo = 'ALT' THEN 'ALTA' ELSE CASE WHEN b.tipo = 'MOD' THEN 'MODIFICACIÓN' ELSE CASE WHEN b.tipo = 'REEM' THEN 'REEMPLAZO' ELSE CASE WHEN b.tipo = 'REEL' THEN 'REEMPLAZO ELIMINADO' ELSE 'REEMPLAZO MODIFICADO' END END END END AS tipo \
	FROM bitacorasurtmovproductos b \
	INNER JOIN articulos a ON a.articulo = b.articulo \
	INNER JOIN productos prod ON a.producto = prod.producto \
	INNER JOIN surtidopedidos sp ON sp.surtido = b.surtido \
	INNER JOIN dsurtidopedidos dsp ON dsp.surtido = sp.surtido AND dsp.articulo = b.articulo \
		AND dsp.almacen = b.almacen AND dsp.division = b.division \
	WHERE b.fechcap BETWEEN '%s' AND '%s' \
    %s %s %s %s \
	ORDER BY b.fechcap DESC, b.horacap DESC ",
	fechaIni, fechaFin,
	condicion_embarque, condicion_division, condicion_producto, condicion_almacen);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
//ID_REP_BIT_CONFIGPRECIOS_ARTICULOS
void ServidorReportes::EjecutaBitacoraConfiguracionPreciosArticulos(RespuestaServidor *Respuesta, MYSQL *MySQL, char *parametros)
{
	AnsiString instruccion;
	AnsiString fechaIni = " ", fechaFin = " ", empresa, usuario, tipo, modulo;
	AnsiString condicion_empresa = " ", condicion_usuario = " ";
	AnsiString condicion_tipo = " ", condicion_modulo = " ";

    fechaIni = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	fechaFin = mFg.StrToMySqlDate(mFg.ExtraeStringDeBuffer(&parametros));
	empresa = mFg.ExtraeStringDeBuffer(&parametros);
	usuario = mFg.ExtraeStringDeBuffer(&parametros);
	tipo = mFg.ExtraeStringDeBuffer(&parametros);
	modulo = mFg.ExtraeStringDeBuffer(&parametros);

	if(empresa != " ") {
		condicion_empresa.sprintf(" AND b.idempresa = %s ", empresa);
	}

	if(usuario != " ") {
		condicion_usuario.sprintf(" AND b.usuario = '%s' ", usuario);
	}

	if(tipo != " ") {
		condicion_tipo.sprintf(" AND b.tipo = '%s' ", tipo);
	}

	if(modulo != " ") {
		condicion_modulo.sprintf(" AND b.modulo = '%s' ", modulo);
	}

	mServidorVioleta->InicializaBuffer(Respuesta, TAM_MAX_BUFFER_RESPUESTA);
	instruccion.sprintf("SELECT \
		b.articulo, \
		prod.nombre, \
		a.producto, \
		a.present, \
		a.multiplo, \
		CONCAT(emp.nombre,' ',emp.appat,' ',emp.apmat) AS usuario, \
		b.fecha, \
		b.hora, \
		IF(b.tipo = 0, 'PROGRAMADO', 'ACTUALIZADO') AS tipo, \
		b.modulo \
	FROM bitacoraconfiguracionprecios b \
		INNER JOIN articulos a ON a.articulo = b.articulo \
		INNER JOIN productos prod ON prod.producto = a.producto \
		INNER JOIN empleados emp ON emp.empleado = b.usuario \
	WHERE b.fecha BETWEEN '%s' AND '%s' \
		%s \
		%s \
		%s \
		%s \
	ORDER BY b.fecha DESC, b.hora DESC ",
	fechaIni, fechaFin,
	condicion_empresa,
	condicion_usuario,
	condicion_tipo,
	condicion_modulo);

	mServidorVioleta->EjecutaSelectSql(Respuesta, MySQL, instruccion.c_str(), Respuesta->TamBufferResultado);
}
// ---------------------------------------------------------------------------
